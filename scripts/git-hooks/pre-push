#!/usr/bin/env bash
set -euo pipefail

# Run from repo root
cd "$(git rev-parse --show-toplevel)"

# Source bash profile to get PATH (Windows Git Bash)
if [ -f ~/.bash_profile ]; then
    source ~/.bash_profile
elif [ -f ~/.bashrc ]; then
    source ~/.bashrc
elif [ -f ~/.profile ]; then
    source ~/.profile
fi

# Try to find herd or php
HERD_BIN="$HOME/.config/herd/bin"
HERD_CMD="$HERD_BIN/herd.bat"
PHP_CMD=""

# Check for herd.bat (Windows)
if [ -f "$HERD_CMD" ]; then
    PHP_CMD="\"$HERD_CMD\" php"
# Check for herd executable (Unix/Mac)
elif [ -f "$HERD_BIN/herd" ] && [ -x "$HERD_BIN/herd" ]; then
    PHP_CMD="$HERD_BIN/herd php"
# Check if herd is in PATH
elif command -v herd &> /dev/null; then
    PHP_CMD="herd php"
# Check if php is in PATH
elif command -v php &> /dev/null; then
    PHP_CMD="php"
else
    echo "Error: Neither 'herd' nor 'php' found"
    echo "Please ensure Herd is installed at $HERD_BIN"
    exit 1
fi

echo "Running pre-push checks..."

echo "1/3 Generating Laravel action classes..."
$PHP_CMD artisan wayfinder:generate

echo "2/3 Running npm tests..."
npm run test

echo "3/3 Running PHP tests..."
$PHP_CMD artisan test

echo "All pre-push checks passed!"
exit 0

