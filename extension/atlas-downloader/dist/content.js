(function(){"use strict";(()=>{const O="atlas-downloader-root",F="atlas-open",G=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let J=null;const K="http://www.w3.org/2000/svg",it=n=>{const e=document.createElementNS(K,"svg");e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("aria-hidden","true"),e.setAttribute("fill","none"),e.setAttribute("stroke","currentColor"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-linecap","round"),e.setAttribute("stroke-linejoin","round"),e.setAttribute("width","18"),e.setAttribute("height","18");for(const r of n){const a=document.createElementNS(K,"path");a.setAttribute("d",r),e.appendChild(a)}return e},ct=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}];chrome.runtime.onMessage.addListener(n=>{if(!(!n||typeof n!="object"||n.type!=="atlas-open-sheet"))try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],r=>{const a=Z(r.atlasBaseUrl||"");if(a&&j(window.location.hostname,a))return;const l=Y(r.atlasExcludedDomains||"");tt(window.location.hostname,l)||(X(),J?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],n=>{const e=Z(n.atlasBaseUrl||"");if(e&&j(window.location.hostname,e))return;const r=Y(n.atlasExcludedDomains||"");tt(window.location.hostname,r)||X()});function X(){if(document.getElementById(O))return;const n=document.createElement("div");n.id=O;const e=n.attachShadow({mode:"closed"}),r=document.createElement("link");r.rel="stylesheet",r.href=chrome.runtime.getURL("dist/content.css"),e.appendChild(r);const a=document.createElement("div");a.className="atlas-shadow-root";const l=wt(a),E=(t,o)=>{try{chrome.runtime.sendMessage(t,o)}catch(s){(()=>{if(s instanceof Error)return s.message;if(s&&typeof s=="object"&&"message"in s){const c=s.message;return typeof c=="string"?c:String(c)}return String(s)})().includes("Extension context invalidated")?l("Atlas extension was reloaded. Refresh this tab."):l("Atlas extension error. Refresh this tab."),o(null)}},x=document.createElement("button");x.className="atlas-downloader-toggle",x.type="button",x.setAttribute("aria-label","Atlas Downloader"),x.title="Atlas Downloader";const A=document.createElement("img");A.alt="",A.src=chrome.runtime.getURL("icon.svg"),x.appendChild(A);const S=document.createElement("div");S.className="atlas-downloader-overlay";const g=document.createElement("div");g.className="atlas-downloader-modal",g.setAttribute("role","dialog"),g.setAttribute("aria-modal","true"),g.setAttribute("aria-label","Atlas Media Picker");const w=document.createElement("div");w.className="atlas-downloader-header";const D=document.createElement("div");D.className="atlas-downloader-title",D.textContent="Atlas Media Picker";const _=document.createElement("div");_.className="atlas-downloader-version",_.textContent=G?`v${G}`:"";const v=document.createElement("button");v.type="button",v.className="atlas-downloader-close",v.setAttribute("aria-label","Close"),v.textContent="×",w.appendChild(D),w.appendChild(_),w.appendChild(v);const p=document.createElement("div");p.className="atlas-downloader-toolbar";const $=R("Rescan",()=>st()),B=R("Check Atlas",()=>ot(!1)),q=R("Select all",()=>at(!0)),H=R("Select none",()=>at(!1)),et=document.createElement("span");et.className="spacer";const T=R("Queue selected",()=>vt(),{primary:!0});p.appendChild($),p.appendChild(B),p.appendChild(q),p.appendChild(H),p.appendChild(et),p.appendChild(T);const I=document.createElement("div");I.className="atlas-downloader-meta";const L=document.createElement("div");L.className="atlas-downloader-list",g.appendChild(w),g.appendChild(p),g.appendChild(I),g.appendChild(L),a.appendChild(x),a.appendChild(S),a.appendChild(g),e.appendChild(a),(document.body||document.documentElement).appendChild(n);let f=[],W=0;x.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),nt()}),S.addEventListener("click",()=>Q()),v.addEventListener("click",()=>Q()),document.addEventListener("keydown",t=>{t.key==="Escape"&&a.classList.contains(F)&&Q()});function nt(){a.classList.add(F),st()}function Q(){a.classList.remove(F)}J=nt;function R(t,o,s){const u=document.createElement("button");return u.type="button",u.className=`atlas-downloader-btn${s?.primary?" primary":""}`,u.textContent=t,u.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),o()}),u}function bt(t){I.textContent=t,T.disabled=!0,$.disabled=!0,B.disabled=!0,q.disabled=!0,H.disabled=!0}function b(t){I.textContent=t;const o=f.filter(s=>s.selected).length;T.disabled=o===0,$.disabled=!1,B.disabled=f.length===0,q.disabled=f.length===0,H.disabled=f.length===0}function st(){W+=1;const t=W;f=[],L.replaceChildren(),bt("Scanning this page…"),dt(o=>{W===t&&(I.textContent=`Scanning… ${o.scanned}/${o.total}`)}).then(o=>{W===t&&(f=o.map(s=>({...s,selected:!0,status:"",statusClass:"",atlas:null})),y(),b(C()),ot(!0))})}function at(t){for(const o of f)o.selected=t;y(),b(C())}function y(){if(L.replaceChildren(),f.length===0){const t=document.createElement("div");t.style.padding="10px 12px",t.style.color="#94a3b8",t.style.fontSize="12px",t.textContent="No matching images/videos found.",L.appendChild(t);return}for(const t of f)L.appendChild(yt(t))}function yt(t){const o=document.createElement("div");o.className=`atlas-downloader-item${t.selected?" selected":""}`;const s=document.createElement("input");s.type="checkbox",s.checked=t.selected,s.addEventListener("change",()=>{t.selected=s.checked,o.classList.toggle("selected",t.selected),b(C())});const u=document.createElement("div");if(u.className="atlas-downloader-preview",t.preview_url){const m=document.createElement("img");m.loading="lazy",m.alt="",m.src=t.preview_url,u.appendChild(m)}const c=document.createElement("div");c.className="atlas-downloader-info";const d=document.createElement("div");d.className="atlas-downloader-kind",d.textContent=t.tag_name;const i=document.createElement("div");i.className="atlas-downloader-url",i.textContent=t.url,i.title=t.url;const h=document.createElement("div");h.className="atlas-downloader-sub",h.textContent=Ct(t);const M=document.createElement("div");M.className="atlas-downloader-reactions";const U=t.atlas?.reaction?.type||null;for(const m of ct){const k=document.createElement("button");k.type="button",k.className=`atlas-downloader-reaction-btn ${m.className}${U===m.type?" active":""}${t.reactionPending?" pending":""}`.trim(),k.setAttribute("aria-label",m.label),k.title=m.label,k.replaceChildren(it(m.pathDs)),k.disabled=!!t.reactionPending,k.addEventListener("click",lt=>{lt.preventDefault(),lt.stopPropagation(),At(t,m.type)}),M.appendChild(k)}c.appendChild(d),c.appendChild(i),c.appendChild(h),c.appendChild(M);const z=document.createElement("div"),rt=xt(t);return z.className=`atlas-downloader-status ${rt.className}`.trim(),z.textContent=rt.text,o.addEventListener("click",m=>{m.target instanceof HTMLInputElement||(t.selected=!t.selected,s.checked=t.selected,o.classList.toggle("selected",t.selected),b(C()))}),o.appendChild(s),o.appendChild(u),o.appendChild(c),o.appendChild(z),o}function Ct(t){const o=t.width&&t.height?`${t.width}×${t.height}`:"size unknown",s=Et(t.url);return s?`${o} • ${s}`:o}function Et(t){try{return new URL(t).hostname}catch{return""}}function C(){const t=f.filter(o=>o.selected).length;return`${f.length} found • ${t} selected`}function xt(t){return t.status?{text:t.status,className:t.statusClass||""}:t.atlas?.downloaded?{text:"Downloaded",className:"ok"}:t.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function ot(t){const o=f.map(s=>s.url).filter(Boolean);o.length!==0&&E({type:"atlas-check-batch",urls:o},s=>{if(!s){t||l("Atlas extension did not respond.");return}if(!s.ok){t||l(s.error||"Atlas check failed.");return}const u=Array.isArray(s.data?.results)?s.data.results:[],c=new Map(u.map(d=>[d.url,d]));for(const d of f){const i=c.get(d.url);i&&(d.atlas={exists:!!i.exists,downloaded:!!i.downloaded,file_id:i.file_id??null,reaction:i.reaction??null})}y(),b(C())})}function At(t,o){t.reactionPending=o,t.status="Reacting…",t.statusClass="",y();const s={type:o,url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:document.title,tag_name:t.tag_name,width:t.width,height:t.height,alt:t.alt||"",preview_url:t.preview_url||"",source:"Extension"};E({type:"atlas-react",payload:s},u=>{if(t.reactionPending=null,!u){t.status="No response",t.statusClass="err",y(),b(C()),l("Atlas extension did not respond.");return}if(!u.ok){t.status=u.error||"Failed",t.statusClass="err",y(),b(C()),l(u.error||"Reaction failed.");return}const c=u.data||null,d=c?.file||null;t.atlas={exists:!!d,downloaded:!!d?.downloaded,file_id:d?.id??null,reaction:c?.reaction??null},t.atlas.exists&&!t.atlas.downloaded&&o!=="dislike"?(t.status="Queued",t.statusClass="queued"):(t.status="",t.statusClass=""),y(),b(C()),t.atlas.exists&&!t.atlas.downloaded&&o!=="dislike"&&P([t.url],0)})}function vt(){const t=f.filter(s=>s.selected);if(t.length===0){l("Select one or more items first.");return}T.disabled=!0,$.disabled=!0,B.disabled=!0,q.disabled=!0,H.disabled=!0;for(const s of t)s.status="Sending…",s.statusClass="";y();const o=t.map(s=>({url:s.url,original_url:s.url,referrer_url:window.location.href,page_title:document.title,tag_name:s.tag_name,width:s.width,height:s.height,alt:s.alt||"",preview_url:s.preview_url||"",source:"Extension",reaction_type:"like"}));E({type:"atlas-download-batch",payloads:o},s=>{if(!s){for(const d of t)d.status="No response",d.statusClass="err";y(),b(C()),l("Atlas extension did not respond.");return}const u=Array.isArray(s.results)?s.results:[],c=[];for(let d=0;d<t.length;d+=1){const i=t[d],h=u[d];if(h?.ok){const M=h.data||null,U=M?.file||null;i.atlas={exists:!!U,downloaded:!!U?.downloaded,file_id:U?.id??null},M?.queued?(i.status="Queued",i.statusClass="queued",c.push(i.url)):(i.status="",i.statusClass="")}else i.status=h?.error||"Failed",i.statusClass="err"}y(),b(C()),s.ok?l(`Queued ${t.length} download(s) in Atlas.`):l(s.error||"Some requests failed."),c.length>0&&P(c,0)})}function P(t,o){o>15||setTimeout(()=>{E({type:"atlas-check-batch",urls:t},s=>{if(!s||!s.ok){P(t,o+1);return}const u=Array.isArray(s.data?.results)?s.data.results:[],c=new Map(u.map(i=>[i.url,i]));let d=0;for(const i of f){const h=c.get(i.url);h&&(i.atlas={exists:!!h.exists,downloaded:!!h.downloaded,file_id:h.file_id??null,reaction:h.reaction??null},h.downloaded?i.status==="Queued"&&(i.status="",i.statusClass=""):d+=1)}y(),b(C()),d>0&&P(t,o+1)})},2e3)}}function dt(n){return new Promise(e=>{const r=document.body||document.documentElement,a=Array.from(r.querySelectorAll("img, video")),l=a.length,E=new Set,x=[];let A=0;const S=w=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(w,{timeout:500});return}setTimeout(()=>w({timeRemaining:()=>25}),0)},g=w=>{const D=typeof w?.timeRemaining=="function"?w.timeRemaining():25;let _=0;for(;A<l&&(_<80||D>5);){const v=a[A];if(v.closest&&v.closest(`#${O}`)){A+=1,_+=1;continue}const p=ut(v);p?.url&&!E.has(p.url)&&(E.add(p.url),x.push(p)),A+=1,_+=1}if(n?.({scanned:A,total:l}),A<l){S(g);return}e(x)};S(g)})}function ut(n){if(!(n instanceof Element))return null;if(n.tagName==="IMG"){const e=n,r=e.naturalWidth||e.width||e.clientWidth||null,a=e.naturalHeight||e.height||e.clientHeight||null;if(r&&a&&(r<450||a<450))return null;const l=N(e.currentSrc)||N(e.src)||N(e.getAttribute("src"));return l?{tag_name:"img",url:l,preview_url:l,width:r,height:a,alt:e.alt||""}:null}if(n.tagName==="VIDEO"){const e=ft(n);return e?{tag_name:"video",url:e,preview_url:n.poster||"",width:n.videoWidth||n.clientWidth||null,height:n.videoHeight||n.clientHeight||null,alt:""}:null}return null}function ft(n){const e=N(n.currentSrc)||N(n.src)||N(n.getAttribute("src"));if(e)return e;const r=n.querySelector("source[src]"),a=r?N(r.src||r.getAttribute("src")):"";if(a)return a;const l=pt(n);return l||ht()}function ht(){const n=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const e of n){const a=document.querySelector(e)?.getAttribute("content"),l=N(a||"");if(l)return l}return""}function pt(n){let e=n,r=0;for(;e&&r<8;){const a=e.getAttribute?.("data-store");if(a){const l=mt(a),E=V(l,0);if(E)return E}e=e.parentElement,r+=1}return""}function mt(n){if(!n)return null;const e=gt(n);try{return JSON.parse(e)}catch{return null}}function gt(n){return!n||typeof n!="string"?"":n.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function V(n,e){if(!n||e>4)return"";if(typeof n=="string")return n.startsWith("http")?n:"";if(Array.isArray(n)){for(const a of n){const l=V(a,e+1);if(l)return l}return""}if(typeof n!="object")return"";const r=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const a of r){const l=n[a];if(typeof l=="string"&&l.startsWith("http"))return l}for(const a of Object.keys(n)){const l=V(n[a],e+1);if(l)return l}return""}function wt(n){return function(r){const a=document.createElement("div");a.className="atlas-downloader-toast",a.textContent=r,n.appendChild(a),requestAnimationFrame(()=>a.classList.add("show")),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove(),{once:!0})},2600)}}function Y(n){return!n||typeof n!="string"?[]:n.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e&&!e.startsWith("#")).map(e=>(e.startsWith("*.")?e.slice(2):e).toLowerCase()).map(e=>Z(e)||e.replace(/^\.+/,"").trim()).filter(Boolean)}function tt(n,e){const r=(n||"").toLowerCase();if(!r)return!1;for(const a of e)if(j(r,a))return!0;return!1}function Z(n){if(!n||typeof n!="string")return"";const e=n.trim();if(!e)return"";const r=/^https?:\/\//i.test(e)?e:`https://${e}`;try{return new URL(r).hostname}catch{return""}}function j(n,e){return!n||!e?!1:n===e||n.endsWith(`.${e}`)}function N(n){if(!n||typeof n!="string")return"";const e=n.trim();if(!e)return"";const r=e.toLowerCase();return r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:")?"":e}})()})();
