(function(){"use strict";const je=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function Ve(r){const g=(r||"").trim().toLowerCase();if(!g)return"";const s=g.split(".").filter(Boolean);if(s.length<=2)return g;const k=s.slice(-2).join("."),T=s.slice(-3).join(".");return je.has(k)&&s.length>=3?T:k}function ze(r){const g=(r||"").trim();if(!g)return"";try{const s=new URL(g).hostname;return Ve(s)}catch{return""}}function Ze(r,g){if(!r||typeof r!="string")return"";const s=r.trim();if(!s)return"";const k=s.toLowerCase();if(k.startsWith("blob:")||k.startsWith("data:")||k.startsWith("chrome-extension:")||k.startsWith("moz-extension:")||k.startsWith("safari-extension:"))return"";try{const T=new URL(s,g);return T.protocol!=="http:"&&T.protocol!=="https:"?"":T.toString()}catch{return""}}function Ye(r){return/\.(gif|webp)(\?|#|$)/i.test(r||"")}function Ge(r){let g=r,s=0;for(;g&&s<8;){const k=g.getAttribute?.("role");if(k==="dialog"||k==="alertdialog"||g.getAttribute?.("aria-modal")==="true")return!0;const W=(g.getAttribute?.("class")||"").toLowerCase(),ee=(g.getAttribute?.("id")||"").toLowerCase(),te=`${W} ${ee}`.trim();if(te&&/(modal|lightbox|overlay|dialog)/.test(te))return!0;g=g.parentElement,s+=1}return!1}function Je(r,g){return!!(Ye(g)||Ge(r))}function j(r){return Ze(r,window.location.href)}function Le(r){const g=j(r.currentSrc)||j(r.src)||j(r.getAttribute("src")||"");if(g)return g;const s=r.querySelector("source[src]"),k=s?j(s.src||s.getAttribute("src")||""):"";if(k)return k;const T=tt(r);return T||et()}function ge(r,g){if(!(r instanceof Element))return null;if(r.tagName==="IMG"){const s=r,k=s.naturalWidth||s.width||s.clientWidth||null,T=s.naturalHeight||s.height||s.clientHeight||null,W=(s.currentSrc||s.src||s.getAttribute("src")||"").trim(),ee=j(W);if(!Je(s,ee||W)&&k&&T&&(k<g||T<g))return null;if(!ee){const te=j(document.referrer)||j(window.location.href)||"";return!te||!W.toLowerCase().startsWith("blob:")&&!W.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:te,original_url:te,referrer_url:window.location.href,preview_url:"",width:k,height:T,alt:s.alt||""}}return{tag_name:"img",url:ee,original_url:ee,referrer_url:window.location.href,preview_url:ee,width:k,height:T,alt:s.alt||""}}if(r.tagName==="VIDEO"){const s=r,k=Le(s);if(!k){const T=(s.currentSrc||s.src||"").trim().toLowerCase();if(T.startsWith("blob:")||T.startsWith("data:")){const W=window.location.href;return{tag_name:"video",url:W,original_url:`${W}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,referrer_url:W,preview_url:s.poster||"",width:s.videoWidth||s.clientWidth||null,height:s.videoHeight||s.clientHeight||null,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:k,original_url:k,referrer_url:window.location.href,preview_url:s.poster||"",width:s.videoWidth||s.clientWidth||null,height:s.videoHeight||s.clientHeight||null,alt:""}}return null}function Ce(){const r=(window.location.href||"").trim();if(!r)return null;const g=r.toLowerCase(),s=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(g),k=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!s&&!k)return null;if(g.startsWith("http://")||g.startsWith("https://"))return{tag_name:g.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:r,original_url:r,referrer_url:r,preview_url:r,width:null,height:null,alt:""};if(g.startsWith("blob:")||g.startsWith("data:")){const T=j(document.referrer)||"";return T?{tag_name:"img",url:T,original_url:T,referrer_url:r,preview_url:"",width:null,height:null,alt:""}:null}return null}function Se(r){const g=new Set,s=r instanceof HTMLImageElement?j(r.currentSrc)||j(r.src)||"":r instanceof HTMLVideoElement?Le(r)||"":r instanceof HTMLAnchorElement&&j(r.href)||"";s&&g.add(s);const k=r.closest("a[href]")?.getAttribute("href")??"",T=j(k);T&&g.add(T);const W=j(window.location.href);return W&&g.add(W),[...g]}function et(){const r=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const g of r){const k=document.querySelector(g)?.getAttribute("content")||"",T=j(k);if(T)return T}return""}function tt(r){let g=r,s=0;for(;g&&s<8;){const k=g.getAttribute?.("data-store");if(k){const T=nt(k),W=ve(T,0);if(W)return W}g=g.parentElement,s+=1}return""}function nt(r){if(!r)return null;const g=at(r);try{return JSON.parse(g)}catch{return null}}function at(r){return!r||typeof r!="string"?"":r.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function ve(r,g){if(!r||g>4)return"";if(typeof r=="string")return r.startsWith("http")?r:"";if(Array.isArray(r)){for(const s of r){const k=ve(s,g+1);if(k)return k}return""}if(typeof r=="object")for(const s of Object.keys(r)){const k=r[s],T=ve(k,g+1);if(T)return T}return""}(()=>{const s="atlas-downloader-root",k="atlas-open",T=(()=>{try{return window.top===window.self}catch{return!1}})(),W=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let ee=null;const te=3e4,z=new Map,xe="http://www.w3.org/2000/svg",we=t=>{const n=document.createElementNS(xe,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const f of t){const d=document.createElementNS(xe,"path");d.setAttribute("d",f),d.setAttribute("fill","none"),d.setAttribute("stroke","currentColor"),d.setAttribute("stroke-width","2"),d.setAttribute("stroke-linecap","round"),d.setAttribute("stroke-linejoin","round"),n.appendChild(d)}return n},be=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],F={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Me="atlas-downloader-page-markers";function Z(t,n){const f=typeof t=="string"?t:"";return f.length<=n?f:f.slice(0,n)}function oe(t){return ze(t)||"Extension"}function Ee(t){const n=z.get(t);return n?Date.now()-n.ts>te?(z.delete(t),null):n:null}function ye(t,n,f){if(!n){f(null);return}const d=Ee(n);if(d){f(d);return}t({type:"atlas-check-batch",urls:[n]},i=>{if(!i||!i.ok){f(null);return}const b=Array.isArray(i.data?.results)?i.data.results:[],L=b.find(B=>B?.url===n)??b[0]??null;if(!L){f(null);return}const c={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,reactionType:L.reaction?.type?String(L.reaction.type):null,ts:Date.now()};z.set(n,c),f(c)})}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&T)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],f=>{const d=Ae(f.atlasBaseUrl||"");if(d&&_e(window.location.hostname,d))return;const i=Re(f.atlasExcludedDomains||"");$e(window.location.hostname,i)||(De(),ee?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const n=Ae(t.atlasBaseUrl||"");if(n&&_e(window.location.hostname,n))return;const f=Re(t.atlasExcludedDomains||"");$e(window.location.hostname,f)||(T?De():lt())});function lt(){if(document.getElementById(s))return;const t=document.createElement("div");t.id=s;const n=t.attachShadow({mode:"closed"}),f=document.createElement("link");f.rel="stylesheet",f.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(f);const d=document.createElement("div");d.className="atlas-shadow-root";const i=Ne(d),b=Be(d),L=(c,B)=>{try{chrome.runtime.sendMessage(c,B)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const _=l.message;return typeof _=="string"?_:String(_)}return String(l)})().includes("Extension context invalidated")?i("Atlas extension was reloaded. Refresh this tab.","danger"):i("Atlas extension error. Refresh this tab.","danger"),B(null)}};n.appendChild(d),(document.body||document.documentElement).appendChild(t),Pe({showToast:i,sendMessageSafe:L,isSheetOpen:()=>!1,chooseDialog:b}),Ie({root:d,showToast:i,sendMessageSafe:L,isSheetOpen:()=>!1,chooseDialog:b})}function De(){if(document.getElementById(s))return;const t=document.createElement("div");t.id=s;const n=t.attachShadow({mode:"closed"}),f=document.createElement("link");f.rel="stylesheet",f.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(f);const d=document.createElement("div");d.className="atlas-shadow-root";const i=Ne(d),b=(e,u)=>{try{chrome.runtime.sendMessage(e,u)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const m=a.message;return typeof m=="string"?m:String(m)}return String(a)})().includes("Extension context invalidated")?i("Atlas extension was reloaded. Refresh this tab.","danger"):i("Atlas extension error. Refresh this tab.","danger"),u(null)}},L=document.createElement("button");L.className="atlas-downloader-toggle",L.type="button",L.setAttribute("aria-label","Atlas Downloader"),L.title="Atlas Downloader";const c=document.createElement("img");c.alt="",c.src=chrome.runtime.getURL("icon.svg"),L.appendChild(c);const B=document.createElement("div");B.className="atlas-downloader-overlay";const l=document.createElement("div");l.className="atlas-downloader-modal",l.setAttribute("role","dialog"),l.setAttribute("aria-modal","true"),l.setAttribute("aria-label","Atlas Media Picker");const w=document.createElement("div");w.className="atlas-downloader-header";const _=document.createElement("div");_.className="atlas-downloader-title",_.textContent="Atlas Media Picker";const R=document.createElement("div");R.className="atlas-downloader-version",R.textContent=W?`v${W}`:"";const D=document.createElement("button");D.type="button",D.className="atlas-downloader-close",D.setAttribute("aria-label","Close"),D.textContent="x",w.appendChild(_),w.appendChild(R),w.appendChild(D);const S=document.createElement("div");S.className="atlas-downloader-toolbar";const $=fe("Rescan",()=>We()),N=fe("Check Atlas",()=>Qe(!1));let H=!1,P=null;const q=fe("Debug: off",()=>{H=!H,q.textContent=H?"Debug: on":"Debug: off",H?!P&&h.length>0&&(P={url:h[0].url,reactionType:"like"}):P=null,X(),Q(K())}),V=fe("Select all",()=>Oe(!0)),Y=fe("Select none",()=>Oe(!1)),re=document.createElement("span");re.className="spacer";const me=fe("Queue selected",()=>mt(),{primary:!0});S.appendChild($),S.appendChild(N),S.appendChild(q),S.appendChild(V),S.appendChild(Y),S.appendChild(re),S.appendChild(me);const o=document.createElement("div");o.className="atlas-downloader-meta";const E=document.createElement("div");E.className="atlas-downloader-list",l.appendChild(w),l.appendChild(S),l.appendChild(o),l.appendChild(E),d.appendChild(L),d.appendChild(B),d.appendChild(l),n.appendChild(d),(document.body||document.documentElement).appendChild(t);const x=Be(d);let h=[],C=0,O=null,ne=null;const pe=!0;let ae=!1;L.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),de()}),B.addEventListener("click",()=>se()),D.addEventListener("click",()=>se()),document.addEventListener("keydown",e=>{const u=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&u==="a"){e.preventDefault(),d.classList.contains(k)||de();return}if(e.key==="Escape"&&d.classList.contains(k)){se();return}if(!d.classList.contains(k))return;const a=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!a)return;const p=h.find(m=>m.selected)??h[0]??null;p&&(e.preventDefault(),Te(p,a,{closeOnSuccess:!0}))});function de(){d.classList.add(k),We()}function se(){d.classList.remove(k)}ee=de,Pe({showToast:i,sendMessageSafe:b,isSheetOpen:()=>d.classList.contains(k),chooseDialog:x,setHintShown:e=>{ae=e},getHintShown:()=>ae,enabled:pe}),Ie({root:d,showToast:i,sendMessageSafe:b,isSheetOpen:()=>d.classList.contains(k),chooseDialog:x});const ce=(e=300)=>{ne!==null&&window.clearTimeout(ne),ne=window.setTimeout(()=>{ne=null,gt()},e)};new MutationObserver(()=>{le(h),ce(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>ce(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&ce(120)},!0),ce(120);function fe(e,u,a){const p=document.createElement("button");return p.type="button",p.className=`atlas-downloader-btn${a?.primary?" primary":""}`,p.textContent=e,p.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),u()}),p}function st(e){o.textContent=e,me.disabled=!0,$.disabled=!0,N.disabled=!0,q.disabled=!0,V.disabled=!0,Y.disabled=!0}function Q(e){o.textContent=e;const u=h.filter(p=>p.selected).length,a=O!==null;me.disabled=u===0||a,$.disabled=a,N.disabled=h.length===0||a,q.disabled=h.length===0,V.disabled=h.length===0||a,Y.disabled=h.length===0||a}function We(){C+=1;const e=C;h=[],H&&(P=null),E.replaceChildren(),st("Scanning this page…"),ot(u=>{C===e&&(o.textContent=`Scanning… ${u.scanned}/${u.total}`)}).then(u=>{C===e&&(h=u.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),H&&!P&&h.length>0&&(P={url:h[0].url,reactionType:"like"}),X(),Q(K()),Qe(!0))})}function Oe(e){for(const u of h)u.selected=e;X(),Q(K())}function X(){if(E.replaceChildren(),h.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",E.appendChild(e);return}for(const e of h)E.appendChild(it(e))}function it(e){const u=document.createElement("div");u.className=`atlas-downloader-item${e.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=e.selected,a.addEventListener("change",()=>{e.selected=a.checked,u.classList.toggle("selected",e.selected),Q(K())});const p=document.createElement("div");if(p.className="atlas-downloader-preview",e.preview_url){const M=document.createElement("img");M.loading="lazy",M.alt="",M.src=e.preview_url,p.appendChild(M)}const m=document.createElement("div");m.className="atlas-downloader-info";const v=document.createElement("div");v.className="atlas-downloader-kind",v.textContent=e.tag_name;const A=document.createElement("div");A.className="atlas-downloader-url",A.textContent=e.url,A.title=e.url;const y=document.createElement("div");y.className="atlas-downloader-sub",y.textContent=ct(e);const U=document.createElement("div");U.className="atlas-downloader-reactions";const I=e.atlas?.reaction?.type||null,ue=O!==null;for(const M of be){const G=document.createElement("button");G.type="button",G.className=`atlas-downloader-reaction-btn ${M.className}${I===M.type?" active":""}${e.reactionPending===M.type?" pending":""}${e.reactionQueued===M.type?" queued":""}`.trim(),G.setAttribute("aria-label",M.label),G.title=M.label,G.replaceChildren(we(M.pathDs)),G.disabled=ue,G.addEventListener("click",Ke=>{Ke.preventDefault(),Ke.stopPropagation(),H&&(P={url:e.url,reactionType:M.type},X()),Te(e,M.type)}),U.appendChild(G)}const J=document.createElement("button");if(J.type="button",J.className=`atlas-downloader-reaction-btn ${F.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===F.type?" pending":""}${e.reactionQueued===F.type?" queued":""}`.trim(),J.setAttribute("aria-label",F.label),J.title=F.label,J.replaceChildren(we(F.pathDs)),J.disabled=ue,J.addEventListener("click",M=>{M.preventDefault(),M.stopPropagation(),Te(e,"dislike",{blacklist:!0})}),U.appendChild(J),e.atlas?.downloaded){const M=document.createElement("button");M.type="button",M.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),M.setAttribute("aria-label","Delete download"),M.title="Delete download",M.replaceChildren(we(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),M.disabled=ue,M.addEventListener("click",G=>{G.preventDefault(),G.stopPropagation(),ht(e)}),U.appendChild(M)}m.appendChild(v),m.appendChild(A),m.appendChild(y),m.appendChild(U),H&&P?.url===e.url&&m.appendChild(dt(e,P.reactionType));const ie=document.createElement("div"),Xe=ft(e);return ie.className=`atlas-downloader-status ${Xe.className}`.trim(),ie.textContent=Xe.text,u.addEventListener("click",M=>{M.target instanceof HTMLInputElement||(H&&(P={url:e.url,reactionType:P?.reactionType??"like"}),e.selected=!e.selected,a.checked=e.selected,u.classList.toggle("selected",e.selected),Q(K()))}),u.appendChild(a),u.appendChild(p),u.appendChild(m),u.appendChild(ie),u}function qe(e,u){return{type:u,url:e.url,original_url:e.original_url||e.url,referrer_url:e.referrer_url||window.location.href,page_title:Z(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:Z(e.alt||"",500),preview_url:e.preview_url||"",source:oe(e.url),...e.download_via?{download_via:e.download_via}:{}}}function Fe(e){return{url:e.url,original_url:e.original_url||e.url,referrer_url:e.referrer_url||window.location.href,page_title:Z(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:Z(e.alt||"",500),preview_url:e.preview_url||"",source:oe(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function dt(e,u){const a=document.createElement("details");a.className="atlas-downloader-debug",a.open=!0;const p=document.createElement("summary");p.textContent="Debug payload",a.appendChild(p);const m=document.createElement("pre");return m.textContent=JSON.stringify({react:qe(e,u),download:Fe(e)},null,2),a.appendChild(m),a}function ct(e){const u=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",a=ut(e.url);return a?`${u} • ${a}`:u}function ut(e){try{return new URL(e).hostname}catch{return""}}function K(){const e=h.filter(u=>u.selected).length;return`${h.length} found • ${e} selected`}function ft(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Qe(e){const u=h.map(a=>a.url).filter(Boolean);u.length!==0&&b({type:"atlas-check-batch",urls:u},a=>{if(!a){e||i("Atlas extension did not respond.","danger");return}if(!a.ok){e||i(a.error||"Atlas check failed.","danger");return}const p=Array.isArray(a.data?.results)?a.data.results:[],m=new Map(p.map(y=>[y.url,y]));let v=0,A=0;for(const y of h){const U=m.get(y.url);U&&(y.atlas={exists:!!U.exists,downloaded:!!U.downloaded,blacklisted:!!U.blacklisted,file_id:U.file_id??null,reaction:U.reaction??null},y.atlas.exists&&!y.atlas.downloaded&&y.atlas.reaction?.type&&y.atlas.reaction.type!=="dislike"?y.reactionQueued=y.atlas.reaction.type:y.reactionQueued=null,U.exists&&(v+=1),U.downloaded&&(A+=1))}X(),Q(K()),le(h),e||i(`Atlas check: ${A}/${v} downloaded.`)})}function Te(e,u,a={}){const p=(v={})=>{e.reactionPending=a.blacklist?F.type:u,e.status="Reacting…",e.statusClass="",O=e.url,X(),Q(K());const A={...qe(e,u),...v,...a.blacklist?{blacklist:!0}:{}};b({type:"atlas-react",payload:A},y=>{if(e.reactionPending=null,O=null,!y){e.status="No response",e.statusClass="err",X(),Q(K()),i("Atlas extension did not respond.","danger");return}if(!y.ok){e.status=y.error||"Failed",e.statusClass="err",X(),Q(K()),i(y.error||"Reaction failed.","danger");return}const U=y.data||null,I=U?.file||null;e.atlas={exists:!!I,downloaded:!!I?.downloaded,blacklisted:!!I?.blacklisted_at,file_id:I?.id??null,reaction:U?.reaction??null},z.set(e.url,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&u!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=a.blacklist?F.type:u):(e.status="",e.statusClass="",e.reactionQueued=null),X(),Q(K()),le(h),a.closeOnSuccess&&se(),e.atlas.exists&&!e.atlas.downloaded&&u!=="dislike"&&ke([e.url],0)})},m=!!e.atlas?.reaction?.type;if(u!=="dislike"&&e.atlas?.downloaded&&m){x({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(v=>{p(v==="confirm"?{force_download:!0}:{})});return}if(u==="dislike"&&e.atlas?.downloaded){x({title:a.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(v=>{if(v==="alternate"){i("Cancelled.");return}p(v==="confirm"?{clear_download:!0}:{})});return}p()}function ht(e){x({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(u=>{u==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",O=e.url,X(),Q(K()),b({type:"atlas-delete-download",payload:{url:e.url,original_url:e.original_url||e.url,tag_name:e.tag_name,download_via:e.download_via||null}},a=>{if(e.reactionPending=null,O=null,!a||!a.ok){e.status=a?.error||"Failed",e.statusClass="err",X(),Q(K()),i(a?.error||"Delete failed.","danger");return}const p=a.data?.file||null;e.atlas={exists:!!p,downloaded:!!p?.downloaded,blacklisted:!!p?.blacklisted_at,file_id:p?.id??null,reaction:e.atlas?.reaction??null},e.status="",e.statusClass="",X(),Q(K()),le(h),i("Download deleted.")}))})}function mt(){const e=h.filter(p=>p.selected);if(e.length===0){i("Select one or more items first.");return}if(e.some(p=>!!p.atlas?.downloaded)){x({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(p=>{if(p==="alternate"){i("Cancelled.");return}a(p==="confirm")});return}a(!1);function a(p){me.disabled=!0,$.disabled=!0,N.disabled=!0,V.disabled=!0,Y.disabled=!0;for(const v of e)v.status="Sending…",v.statusClass="";X();const m=e.map(v=>{const A=Fe(v);return p&&(A.force_download=!0),A});b({type:"atlas-download-batch",payloads:m},v=>{if(!v){for(const U of e)U.status="No response",U.statusClass="err";X(),Q(K()),i("Atlas extension did not respond.","danger");return}const A=Array.isArray(v.results)?v.results:[],y=[];for(let U=0;U<e.length;U+=1){const I=e[U],ue=A[U];if(ue?.ok){const J=ue.data||null,ie=J?.file||null;I.atlas={exists:!!ie,downloaded:!!ie?.downloaded,blacklisted:!!ie?.blacklisted_at,file_id:ie?.id??null,reaction:I.atlas?.reaction??null},J?.queued?(I.status="Queued",I.statusClass="queued",I.atlas?.reaction?.type&&I.atlas.reaction.type!=="dislike"&&(I.reactionQueued=I.atlas.reaction.type),y.push(I.url)):(I.status="",I.statusClass="",I.reactionQueued=null)}else I.status=ue?.error||"Failed",I.statusClass="err"}X(),Q(K()),le(h),v.ok?i(`Queued ${e.length} download(s) in Atlas.`):i(v.error||"Some requests failed.","danger"),y.length>0&&ke(y,0)})}}function ke(e,u){u>15||setTimeout(()=>{b({type:"atlas-check-batch",urls:e},a=>{if(!a||!a.ok){ke(e,u+1);return}const p=Array.isArray(a.data?.results)?a.data.results:[],m=new Map(p.map(A=>[A.url,A]));let v=0;for(const A of h){const y=m.get(A.url);y&&(A.atlas={exists:!!y.exists,downloaded:!!y.downloaded,blacklisted:!!y.blacklisted,file_id:y.file_id??null,reaction:y.reaction??null},y?.url&&z.set(String(y.url),{exists:!!y.exists,downloaded:!!y.downloaded,blacklisted:!!y.blacklisted,reactionType:y.reaction?.type?String(y.reaction.type):null,ts:Date.now()}),A.atlas.exists&&!A.atlas.downloaded&&A.atlas.reaction?.type&&A.atlas.reaction.type!=="dislike"?A.reactionQueued=A.atlas.reaction.type:A.reactionQueued=null,y.downloaded?A.status==="Queued"&&(A.status="",A.statusClass=""):v+=1)}X(),Q(K()),le(h),v>0&&ke(e,u+1)})},2e3)}function le(e=h){rt();const u=document.querySelectorAll('[data-atlas-marked="1"]');for(const m of u)m.removeAttribute("data-atlas-marked"),m.removeAttribute("data-atlas-state"),m.removeAttribute("data-atlas-reaction");const a=new Map;for(const[m,v]of z.entries()){if(Date.now()-v.ts>te){z.delete(m);continue}a.set(m,{exists:!!v.exists,downloaded:!!v.downloaded,blacklisted:!!v.blacklisted,reactionType:v.reactionType?String(v.reactionType):null}),a.set(he(m),{exists:!!v.exists,downloaded:!!v.downloaded,blacklisted:!!v.blacklisted,reactionType:v.reactionType?String(v.reactionType):null})}for(const m of e){if(!m?.url||!m?.atlas)continue;const v=m.atlas?.reaction?.type?String(m.atlas.reaction.type):null,A={exists:!!m.atlas.exists,downloaded:!!m.atlas.downloaded,blacklisted:!!m.atlas.blacklisted,reactionType:v};a.set(m.url,A),a.set(he(m.url),A)}if(a.size===0)return;const p=document.querySelectorAll("img, video, a[href]");for(const m of p){const v=Se(m);if(v.length===0)continue;const A=v.map(y=>a.get(y)||a.get(he(y))).find(y=>!!y)??null;A&&(m.setAttribute("data-atlas-marked","1"),A.blacklisted?m.setAttribute("data-atlas-state","blacklisted"):A.reactionType?m.setAttribute("data-atlas-state","reacted"):A.exists&&m.setAttribute("data-atlas-state","exists"),A.reactionType&&m.setAttribute("data-atlas-reaction",A.reactionType))}}function pt(){const e=new Set,u=document.querySelectorAll("img, video, a[href]");for(const p of u)for(const m of Se(p))e.add(m),e.add(he(m));const a=Ce();return a?.url&&(e.add(a.url),e.add(he(a.url))),[...e].filter(Boolean)}function gt(){const e=pt();if(e.length===0){le(h);return}b({type:"atlas-check-batch",urls:e},u=>{if(!u?.ok){le(h);return}const a=Array.isArray(u.data?.results)?u.data.results:[];for(const p of a)p?.url&&z.set(String(p.url),{exists:!!p.exists,downloaded:!!p.downloaded,blacklisted:!!p.blacklisted,reactionType:p.reaction?.type?String(p.reaction.type):null,ts:Date.now()});le(h)})}}function ot(t){return new Promise(n=>{const f=document.body||document.documentElement,d=Array.from(f.querySelectorAll("img, video")),i=d.length,b=new Set,L=[];let c=0;const B=w=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(w,{timeout:500});return}setTimeout(()=>w({timeRemaining:()=>25}),0)},l=w=>{const _=typeof w?.timeRemaining=="function"?w.timeRemaining():25;let R=0;for(;c<i&&(R<80||_>5);){const S=d[c];if(S.closest&&S.closest(`#${s}`)){c+=1,R+=1;continue}const $=ge(S,450);$?.url&&!b.has($.url)&&(b.add($.url),L.push($)),c+=1,R+=1}if(t?.({scanned:c,total:i}),c<i){B(l);return}const D=Ce();D&&!b.has(D.url)&&(b.add(D.url),L.push(D)),n(L)};B(l)})}function Ne(t){return function(f,d="info"){const i=document.createElement("div");i.className=`atlas-downloader-toast${d==="danger"?" danger":""}`,i.textContent=f,t.appendChild(i),requestAnimationFrame(()=>i.classList.add("show")),setTimeout(()=>{i.classList.remove("show"),i.addEventListener("transitionend",()=>i.remove(),{once:!0})},2600)}}function Be(t){return n=>new Promise(f=>{const d=document.createElement("div");d.className="atlas-downloader-dialog-backdrop";const i=document.createElement("div");i.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),i.setAttribute("role","dialog"),i.setAttribute("aria-modal","true"),i.setAttribute("aria-label",n.title);const b=document.createElement("h3");b.className="atlas-downloader-dialog-title",b.textContent=n.title;const L=document.createElement("p");L.className="atlas-downloader-dialog-message",L.textContent=n.message;const c=document.createElement("div");c.className="atlas-downloader-dialog-actions";const B=_=>{d.remove(),f(_)};if(n.alternateLabel){const _=document.createElement("button");_.type="button",_.className="atlas-downloader-dialog-btn secondary",_.textContent=n.alternateLabel,_.addEventListener("click",()=>B("alternate")),c.appendChild(_)}const l=document.createElement("button");l.type="button",l.className="atlas-downloader-dialog-btn",l.textContent=n.cancelLabel||"Cancel",l.addEventListener("click",()=>B("cancel")),c.appendChild(l);const w=document.createElement("button");w.type="button",w.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),w.textContent=n.confirmLabel,w.addEventListener("click",()=>B("confirm")),c.appendChild(w),i.appendChild(b),i.appendChild(L),i.appendChild(c),d.appendChild(i),t.appendChild(d),requestAnimationFrame(()=>{w.focus()})})}function rt(){if(document.getElementById(Me))return;const t=document.createElement("style");t.id=Me,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function he(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function Re(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>Ae(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function $e(t,n){const f=(t||"").toLowerCase();if(!f)return!1;for(const d of n)if(_e(f,d))return!0;return!1}function Ae(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const f=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(f).hostname}catch{return""}}function _e(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}function Pe(t){const n=t.enabled??!0,f=t.getHintShown??(()=>!1),d=t.setHintShown??(()=>{}),i=()=>{f()||(d(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},b=(c,B,l)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:c,pending:B,reactionType:l}}))},L=c=>(typeof c.composedPath=="function"?c.composedPath():[]).some(l=>l instanceof HTMLElement&&l.id===s);document.addEventListener("click",c=>{!n||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||L(c)||!((c.target instanceof Element?c.target:null)?.closest?.("img, video")??null)||(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())},!0),document.addEventListener("mousedown",c=>{if(!n||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||L(c))return;const l=(c.target instanceof Element?c.target:null)?.closest?.("img, video")??null;if(!l)return;const w=c.button===0?"like":c.button===1?"love":null;if(!w)return;i(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const _=ge(l,450);if(!_){if(l instanceof HTMLVideoElement){const D=(l.currentSrc||l.src||"").trim().toLowerCase();if(D.startsWith("blob:")||D.startsWith("data:")){const S=window.location.href,$=`${S}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,N={type:w,url:S,original_url:$,referrer_url:S,page_title:Z(document.title,500),tag_name:"video",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",preview_url:l.poster||"",source:oe(S),download_via:"yt-dlp"};ye(t.sendMessageSafe,N.url,H=>{if(H?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(P=>{b(l,!0,w),P==="confirm"&&(N.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:N},q=>{if(!q||!q.ok){b(l,!1,null),t.showToast(q?.error||"Reaction failed.","danger");return}const V=q.data||null,Y=V?.file||null,re=V?.reaction?.type?String(V.reaction.type):w;z.set(N.url,{exists:!!Y,downloaded:!!Y?.downloaded,blacklisted:!!Y?.blacklisted_at,reactionType:re,ts:Date.now()}),b(l,!1,re),t.showToast(`Reacted (${w}). Resolving video in Atlas…`)})});return}b(l,!0,w),t.sendMessageSafe({type:"atlas-react",payload:N},P=>{if(!P||!P.ok){b(l,!1,null),t.showToast(P?.error||"Reaction failed.","danger");return}const q=P.data||null,V=q?.file||null,Y=q?.reaction?.type?String(q.reaction.type):w;z.set(N.url,{exists:!!V,downloaded:!!V?.downloaded,blacklisted:!!V?.blacklisted_at,reactionType:Y,ts:Date.now()}),b(l,!1,Y),t.showToast(`Reacted (${w}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const R={type:w,url:_.url,original_url:_.url,referrer_url:window.location.href,page_title:Z(document.title,500),tag_name:_.tag_name,width:_.width,height:_.height,alt:Z(_.alt||"",500),preview_url:_.preview_url||"",source:oe(_.url)};ye(t.sendMessageSafe,R.url,D=>{if(D?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(S=>{b(l,!0,w),S==="confirm"&&(R.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:R},$=>{if(!$||!$.ok){b(l,!1,null),t.showToast($?.error||"Reaction failed.","danger");return}const N=$.data||null,H=N?.file||null,P=N?.reaction?.type?String(N.reaction.type):w;z.set(R.url,{exists:!!H,downloaded:!!H?.downloaded,blacklisted:!!H?.blacklisted_at,reactionType:P,ts:Date.now()}),b(l,!1,P),t.showToast(`Reacted (${w}). Queued download in Atlas.`)})});return}b(l,!0,w),t.sendMessageSafe({type:"atlas-react",payload:R},S=>{if(!S||!S.ok){b(l,!1,null),t.showToast(S?.error||"Reaction failed.","danger");return}const $=S.data||null,N=$?.file||null,H=$?.reaction?.type?String($.reaction.type):w;z.set(R.url,{exists:!!N,downloaded:!!N?.downloaded,blacklisted:!!N?.blacklisted_at,reactionType:H,ts:Date.now()}),b(l,!1,H),t.showToast(`Reacted (${w}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",c=>{if(!n||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||L(c))return;const l=(c.target instanceof Element?c.target:null)?.closest?.("img, video")??null;if(!l)return;i(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const w=ge(l,450);if(!w){if(l instanceof HTMLVideoElement){const R=(l.currentSrc||l.src||"").trim().toLowerCase();if(R.startsWith("blob:")||R.startsWith("data:")){const D=window.location.href,S=`${D}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,$={type:"dislike",url:D,original_url:S,referrer_url:D,page_title:Z(document.title,500),tag_name:"video",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",preview_url:l.poster||"",source:oe(D),download_via:"yt-dlp"};b(l,!0,"dislike"),t.sendMessageSafe({type:"atlas-react",payload:$},N=>{if(!N||!N.ok){b(l,!1,null),t.showToast(N?.error||"Reaction failed.","danger");return}b(l,!1,"dislike"),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const _={type:"dislike",url:w.url,original_url:w.url,referrer_url:window.location.href,page_title:Z(document.title,500),tag_name:w.tag_name,width:w.width,height:w.height,alt:Z(w.alt||"",500),preview_url:w.preview_url||"",source:oe(w.url)};b(l,!0,"dislike"),t.sendMessageSafe({type:"atlas-react",payload:_},R=>{if(!R||!R.ok){b(l,!1,null),t.showToast(R?.error||"Reaction failed.","danger");return}b(l,!1,"dislike"),t.showToast("Disliked.")})},!0)}function Ue(t,n,f){return t<n?n:t>f?f:t}function He(t,n){const f=ge(t,450);if(f)return{type:n,url:f.url,original_url:f.url,referrer_url:window.location.href,page_title:Z(document.title,500),tag_name:f.tag_name,width:f.width,height:f.height,alt:Z(f.alt||"",500),preview_url:f.preview_url||"",source:oe(f.url)};if(t instanceof HTMLVideoElement){const d=(t.currentSrc||t.src||"").trim().toLowerCase();if(d.startsWith("blob:")||d.startsWith("data:")){const i=window.location.href,b=`${i}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`;return{type:n,url:i,original_url:b,referrer_url:i,page_title:Z(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:oe(i),download_via:"yt-dlp"}}}return null}function Ie(t){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");let f=null,d=null,i=null,b=!1,L=-1,c=-1,B=null;const l=new Map,w=(o,E=null)=>{b=o;for(const[x,h]of l.entries())h.disabled=o,h.classList.toggle("pending",o&&E===x)},_=o=>{for(const E of[...be,F]){const x=l.get(E.type);if(!x)continue;const h=E.type===F.type?o==="dislike":o===E.type;x.classList.toggle("active",h)}},R=(o,E)=>{const x=o&&E===!1&&o!=="dislike"?o:null;for(const h of[...be,F]){const C=l.get(h.type);if(!C)continue;const O=h.type===F.type?x==="dislike":x===h.type;C.classList.toggle("queued",O)}},D=()=>{i&&(window.clearTimeout(i),i=null)},S=()=>{b||(f=null,d=null,n.classList.remove("open"),n.style.left="",n.style.top="",_(null))},$=()=>{D(),i=window.setTimeout(()=>{n.matches(":hover")||S()},140)},N=o=>{o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation?.()};for(const o of[...be,F]){const E=document.createElement("button");E.type="button",E.className=`atlas-downloader-reaction-btn ${o.className}`.trim(),E.setAttribute("aria-label",o.label),E.title=o.label,E.replaceChildren(we(o.pathDs)),l.set(o.type,E),E.addEventListener("pointerdown",N,!0),E.addEventListener("mousedown",N,!0),E.addEventListener("click",x=>{if(N(x),b)return;if(!f){t.showToast("No media selected.");return}const h=o.type===F.type?"dislike":o.type,C=He(f,h);if(!C){t.showToast("No valid media URL found.");return}const O=C.url||"",ne=(pe=!1)=>{pe?C.force_download=!0:"force_download"in C&&delete C.force_download,w(!0,o.type),t.sendMessageSafe({type:"atlas-react",payload:{...C,...o.type===F.type?{blacklist:!0}:{}}},ae=>{if(w(!1,null),!ae||!ae.ok){t.showToast(ae?.error||"Reaction failed.","danger");return}const de=ae.data||null,se=de?.file||null,ce=de?.reaction?.type?String(de.reaction.type):o.type===F.type?"dislike":o.type;if(O&&z.set(O,{exists:!!se,downloaded:!!se?.downloaded,blacklisted:!!se?.blacklisted_at,reactionType:ce,ts:Date.now()}),_(ce),C.download_via==="yt-dlp"){t.showToast(`Reacted (${o.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${o.label}). Queued download in Atlas.`)})};ye(t.sendMessageSafe,O,pe=>{if(h!=="dislike"&&pe?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(ae=>{ne(ae==="confirm")});return}ne(!1)})}),n.appendChild(E)}t.root.appendChild(n);const H=o=>(typeof o.composedPath=="function"?o.composedPath():[]).some(x=>x instanceof HTMLElement&&x.id===s),P=()=>{if(!f)return;const o=f.getBoundingClientRect();if(!Number.isFinite(o.left)||o.width<=0||o.height<=0){S();return}const E=Ue(o.top+8,8,window.innerHeight-8),x=Ue(o.right-8,8,window.innerWidth-8);n.style.top=`${E}px`,n.style.left=`${x}px`},q=o=>{if(t.isSheetOpen()){S();return}const E=He(o,"like");if(!E){S();return}if(f=o,d=E.url||null,n.classList.add("open"),P(),_(null),R(null,null),d){const x=Ee(d);if(x)_(x.reactionType),R(x.reactionType,x.downloaded);else{const h=d;ye(t.sendMessageSafe,h,C=>{C&&d===h&&(_(C.reactionType),R(C.reactionType,C.downloaded))})}}},V=o=>o?o==="blacklist"?"blacklist":o:null,Y=()=>{if(L<0||c<0||t.isSheetOpen())return;const E=(document.elementsFromPoint?.(L,c)??[]).find(C=>C instanceof Element&&C.closest?.("img, video")),h=(E instanceof Element?E.closest?.("img, video")??null:null)??(()=>{const C=document.elementFromPoint?.(L,c);return C instanceof Element?C.closest?.("img, video")??null:null})();h&&(h.closest?.(`#${s}`)||(D(),q(h)))},re=(o=80)=>{B!==null&&window.clearTimeout(B),B=window.setTimeout(()=>{B=null,Y()},o)};document.addEventListener("pointerover",o=>{if(t.isSheetOpen()||!(o.target instanceof Element)||H(o))return;const E=o.target.closest?.("img, video")??null,h=(document.elementsFromPoint?.(o.clientX,o.clientY)??[]).find(O=>O instanceof Element&&O.closest?.("img, video"))??null,C=E||(h instanceof Element?h.closest?.("img, video")??null:null);C&&(D(),q(C))},!0),window.addEventListener("atlas-shortcut-reaction-state",o=>{const E=o,x=E.detail?.media;if(!(x instanceof Element))return;D(),q(x);const h=!!E.detail?.pending,C=V(E.detail?.reactionType??null);if(h){w(!0,C);return}if(w(!1,null),C){const O=C==="blacklist"?"dislike":C;_(O);const ne=d?Ee(d):null;R(O,ne?.downloaded??null)}},!0),document.addEventListener("pointermove",o=>{L=o.clientX,c=o.clientY},!0),document.addEventListener("pointerout",o=>{!f||t.isSheetOpen()||!(o.target instanceof Element)||H(o)||!(o.target.closest?.("img, video")??null)||$()},!0),n.addEventListener("pointerenter",D,!0),n.addEventListener("pointerleave",$,!0),window.addEventListener("scroll",P,!0),window.addEventListener("resize",P),window.addEventListener("blur",S),window.addEventListener("focus",()=>re(40),!0),new MutationObserver(()=>{re(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
