(function(){"use strict";const je=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function Ve(de){const ee=(de||"").trim().toLowerCase();if(!ee)return"";const U=ee.split(".").filter(Boolean);if(U.length<=2)return ee;const Q=U.slice(-2).join("."),ce=U.slice(-3).join(".");return je.has(Q)&&U.length>=3?ce:Q}function ze(de){const ee=(de||"").trim();if(!ee)return"";try{const U=new URL(ee).hostname;return Ve(U)}catch{return""}}(()=>{const U="atlas-downloader-root",Q="atlas-open",ce=(()=>{try{return window.top===window.self}catch{return!1}})(),Ae=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let Ee=null;const Te=3e4,X=new Map,Le="http://www.w3.org/2000/svg",ue=t=>{const a=document.createElementNS(Le,"svg");a.setAttribute("viewBox","0 0 24 24"),a.setAttribute("aria-hidden","true"),a.setAttribute("fill","none"),a.setAttribute("stroke-width","2"),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round"),a.setAttribute("width","18"),a.setAttribute("height","18");for(const l of t){const o=document.createElementNS(Le,"path");o.setAttribute("d",l),o.setAttribute("fill","none"),o.setAttribute("stroke","currentColor"),o.setAttribute("stroke-width","2"),o.setAttribute("stroke-linecap","round"),o.setAttribute("stroke-linejoin","round"),a.appendChild(o)}return a},we=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],K={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Ce="atlas-downloader-page-markers";function q(t,a){const l=typeof t=="string"?t:"";return l.length<=a?l:l.slice(0,a)}function J(t){return ze(t)||"Extension"}function Se(t){const a=X.get(t);return a?Date.now()-a.ts>Te?(X.delete(t),null):a:null}function fe(t,a,l){if(!a){l(null);return}const o=Se(a);if(o){l(o);return}t({type:"atlas-check-batch",urls:[a]},n=>{if(!n||!n.ok){l(null);return}const p=Array.isArray(n.data?.results)?n.data.results:[],s=p.find(h=>h?.url===a)??p[0]??null;if(!s){l(null);return}const A={exists:!!s.exists,downloaded:!!s.downloaded,blacklisted:!!s.blacklisted,reactionType:s.reaction?.type?String(s.reaction.type):null,ts:Date.now()};X.set(a,A),l(A)})}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&ce)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],l=>{const o=ve(l.atlasBaseUrl||"");if(o&&ke(window.location.hostname,o))return;const n=Be(l.atlasExcludedDomains||"");Re(window.location.hostname,n)||(xe(),Ee?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const a=ve(t.atlasBaseUrl||"");if(a&&ke(window.location.hostname,a))return;const l=Be(t.atlasExcludedDomains||"");Re(window.location.hostname,l)||(ce?xe():Qe())});function Qe(){if(document.getElementById(U))return;const t=document.createElement("div");t.id=U;const a=t.attachShadow({mode:"closed"}),l=document.createElement("link");l.rel="stylesheet",l.href=chrome.runtime.getURL("dist/content.css"),a.appendChild(l);const o=document.createElement("div");o.className="atlas-shadow-root";const n=De(o),p=Ne(o),s=(A,h)=>{try{chrome.runtime.sendMessage(A,h)}catch(f){(()=>{if(f instanceof Error)return f.message;if(f&&typeof f=="object"&&"message"in f){const g=f.message;return typeof g=="string"?g:String(g)}return String(f)})().includes("Extension context invalidated")?n("Atlas extension was reloaded. Refresh this tab.","danger"):n("Atlas extension error. Refresh this tab.","danger"),h(null)}};a.appendChild(o),(document.body||document.documentElement).appendChild(t),$e({showToast:n,sendMessageSafe:s,isSheetOpen:()=>!1,chooseDialog:p}),Ue({root:o,showToast:n,sendMessageSafe:s,isSheetOpen:()=>!1,chooseDialog:p})}function xe(){if(document.getElementById(U))return;const t=document.createElement("div");t.id=U;const a=t.attachShadow({mode:"closed"}),l=document.createElement("link");l.rel="stylesheet",l.href=chrome.runtime.getURL("dist/content.css"),a.appendChild(l);const o=document.createElement("div");o.className="atlas-shadow-root";const n=De(o),p=(e,d)=>{try{chrome.runtime.sendMessage(e,d)}catch(r){(()=>{if(r instanceof Error)return r.message;if(r&&typeof r=="object"&&"message"in r){const i=r.message;return typeof i=="string"?i:String(i)}return String(r)})().includes("Extension context invalidated")?n("Atlas extension was reloaded. Refresh this tab.","danger"):n("Atlas extension error. Refresh this tab.","danger"),d(null)}},s=document.createElement("button");s.className="atlas-downloader-toggle",s.type="button",s.setAttribute("aria-label","Atlas Downloader"),s.title="Atlas Downloader";const A=document.createElement("img");A.alt="",A.src=chrome.runtime.getURL("icon.svg"),s.appendChild(A);const h=document.createElement("div");h.className="atlas-downloader-overlay";const f=document.createElement("div");f.className="atlas-downloader-modal",f.setAttribute("role","dialog"),f.setAttribute("aria-modal","true"),f.setAttribute("aria-label","Atlas Media Picker");const b=document.createElement("div");b.className="atlas-downloader-header";const g=document.createElement("div");g.className="atlas-downloader-title",g.textContent="Atlas Media Picker";const x=document.createElement("div");x.className="atlas-downloader-version",x.textContent=Ae?`v${Ae}`:"";const _=document.createElement("button");_.type="button",_.className="atlas-downloader-close",_.setAttribute("aria-label","Close"),_.textContent="x",b.appendChild(g),b.appendChild(x),b.appendChild(_);const E=document.createElement("div");E.className="atlas-downloader-toolbar";const k=re("Rescan",()=>We()),W=re("Check Atlas",()=>Fe(!1));let M=!1,S=null;const I=re("Debug: off",()=>{M=!M,I.textContent=M?"Debug: on":"Debug: off",M?!S&&w.length>0&&(S={url:w[0].url,reactionType:"like"}):S=null,$(),R(P())}),F=re("Select all",()=>Oe(!0)),te=re("Select none",()=>Oe(!1)),u=document.createElement("span");u.className="spacer";const y=re("Queue selected",()=>dt(),{primary:!0});E.appendChild(k),E.appendChild(W),E.appendChild(I),E.appendChild(F),E.appendChild(te),E.appendChild(u),E.appendChild(y);const D=document.createElement("div");D.className="atlas-downloader-meta";const N=document.createElement("div");N.className="atlas-downloader-list",f.appendChild(b),f.appendChild(E),f.appendChild(D),f.appendChild(N),o.appendChild(s),o.appendChild(h),o.appendChild(f),a.appendChild(o),(document.body||document.documentElement).appendChild(t);const B=Ne(o);let w=[],ae=0,Z=null,V=null;const ie=!0;let le=!1;s.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),oe()}),h.addEventListener("click",()=>me()),_.addEventListener("click",()=>me()),document.addEventListener("keydown",e=>{const d=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&d==="a"){e.preventDefault(),o.classList.contains(Q)||oe();return}if(e.key==="Escape"&&o.classList.contains(Q)){me();return}if(!o.classList.contains(Q))return;const r=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!r)return;const c=w.find(i=>i.selected)??w[0]??null;c&&(e.preventDefault(),_e(c,r,{closeOnSuccess:!0}))});function oe(){o.classList.add(Q),We()}function me(){o.classList.remove(Q)}Ee=oe,$e({showToast:n,sendMessageSafe:p,isSheetOpen:()=>o.classList.contains(Q),chooseDialog:B,setHintShown:e=>{le=e},getHintShown:()=>le,enabled:ie}),Ue({root:o,showToast:n,sendMessageSafe:p,isSheetOpen:()=>o.classList.contains(Q),chooseDialog:B});const pe=(e=300)=>{V!==null&&window.clearTimeout(V),V=window.setTimeout(()=>{V=null,ut()},e)};new MutationObserver(()=>{G(w),pe(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>pe(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&pe(120)},!0),pe(120);function re(e,d,r){const c=document.createElement("button");return c.type="button",c.className=`atlas-downloader-btn${r?.primary?" primary":""}`,c.textContent=e,c.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),d()}),c}function at(e){D.textContent=e,y.disabled=!0,k.disabled=!0,W.disabled=!0,I.disabled=!0,F.disabled=!0,te.disabled=!0}function R(e){D.textContent=e;const d=w.filter(c=>c.selected).length,r=Z!==null;y.disabled=d===0||r,k.disabled=r,W.disabled=w.length===0||r,I.disabled=w.length===0,F.disabled=w.length===0||r,te.disabled=w.length===0||r}function We(){ae+=1;const e=ae;w=[],M&&(S=null),N.replaceChildren(),at("Scanning this page…"),Ze(d=>{ae===e&&(D.textContent=`Scanning… ${d.scanned}/${d.total}`)}).then(d=>{ae===e&&(w=d.map(r=>({...r,selected:!0,status:"",statusClass:"",atlas:null})),M&&!S&&w.length>0&&(S={url:w[0].url,reactionType:"like"}),$(),R(P()),Fe(!0))})}function Oe(e){for(const d of w)d.selected=e;$(),R(P())}function $(){if(N.replaceChildren(),w.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",N.appendChild(e);return}for(const e of w)N.appendChild(nt(e))}function nt(e){const d=document.createElement("div");d.className=`atlas-downloader-item${e.selected?" selected":""}`;const r=document.createElement("input");r.type="checkbox",r.checked=e.selected,r.addEventListener("change",()=>{e.selected=r.checked,d.classList.toggle("selected",e.selected),R(P())});const c=document.createElement("div");if(c.className="atlas-downloader-preview",e.preview_url){const L=document.createElement("img");L.loading="lazy",L.alt="",L.src=e.preview_url,c.appendChild(L)}const i=document.createElement("div");i.className="atlas-downloader-info";const m=document.createElement("div");m.className="atlas-downloader-kind",m.textContent=e.tag_name;const v=document.createElement("div");v.className="atlas-downloader-url",v.textContent=e.url,v.title=e.url;const T=document.createElement("div");T.className="atlas-downloader-sub",T.textContent=ot(e);const C=document.createElement("div");C.className="atlas-downloader-reactions";const H=e.atlas?.reaction?.type||null,ne=Z!==null;for(const L of we){const j=document.createElement("button");j.type="button",j.className=`atlas-downloader-reaction-btn ${L.className}${H===L.type?" active":""}${e.reactionPending===L.type?" pending":""}`.trim(),j.setAttribute("aria-label",L.label),j.title=L.label,j.replaceChildren(ue(L.pathDs)),j.disabled=ne,j.addEventListener("click",Ke=>{Ke.preventDefault(),Ke.stopPropagation(),M&&(S={url:e.url,reactionType:L.type},$()),_e(e,L.type)}),C.appendChild(j)}const z=document.createElement("button");if(z.type="button",z.className=`atlas-downloader-reaction-btn ${K.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===K.type?" pending":""}`.trim(),z.setAttribute("aria-label",K.label),z.title=K.label,z.replaceChildren(ue(K.pathDs)),z.disabled=ne,z.addEventListener("click",L=>{L.preventDefault(),L.stopPropagation(),_e(e,"dislike",{blacklist:!0})}),C.appendChild(z),e.atlas?.downloaded){const L=document.createElement("button");L.type="button",L.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),L.setAttribute("aria-label","Delete download"),L.title="Delete download",L.replaceChildren(ue(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),L.disabled=ne,L.addEventListener("click",j=>{j.preventDefault(),j.stopPropagation(),it(e)}),C.appendChild(L)}i.appendChild(m),i.appendChild(v),i.appendChild(T),i.appendChild(C),M&&S?.url===e.url&&i.appendChild(lt(e,S.reactionType));const Y=document.createElement("div"),Xe=st(e);return Y.className=`atlas-downloader-status ${Xe.className}`.trim(),Y.textContent=Xe.text,d.addEventListener("click",L=>{L.target instanceof HTMLInputElement||(M&&(S={url:e.url,reactionType:S?.reactionType??"like"}),e.selected=!e.selected,r.checked=e.selected,d.classList.toggle("selected",e.selected),R(P()))}),d.appendChild(r),d.appendChild(c),d.appendChild(i),d.appendChild(Y),d}function Ie(e,d){return{type:d,url:e.url,original_url:e.original_url||e.url,referrer_url:e.referrer_url||window.location.href,page_title:q(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:q(e.alt||"",500),preview_url:e.preview_url||"",source:J(e.url),...e.download_via?{download_via:e.download_via}:{}}}function qe(e){return{url:e.url,original_url:e.original_url||e.url,referrer_url:e.referrer_url||window.location.href,page_title:q(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:q(e.alt||"",500),preview_url:e.preview_url||"",source:J(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function lt(e,d){const r=document.createElement("details");r.className="atlas-downloader-debug",r.open=!0;const c=document.createElement("summary");c.textContent="Debug payload",r.appendChild(c);const i=document.createElement("pre");return i.textContent=JSON.stringify({react:Ie(e,d),download:qe(e)},null,2),r.appendChild(i),r}function ot(e){const d=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",r=rt(e.url);return r?`${d} • ${r}`:d}function rt(e){try{return new URL(e).hostname}catch{return""}}function P(){const e=w.filter(d=>d.selected).length;return`${w.length} found • ${e} selected`}function st(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Fe(e){const d=w.map(r=>r.url).filter(Boolean);d.length!==0&&p({type:"atlas-check-batch",urls:d},r=>{if(!r){e||n("Atlas extension did not respond.","danger");return}if(!r.ok){e||n(r.error||"Atlas check failed.","danger");return}const c=Array.isArray(r.data?.results)?r.data.results:[],i=new Map(c.map(T=>[T.url,T]));let m=0,v=0;for(const T of w){const C=i.get(T.url);C&&(T.atlas={exists:!!C.exists,downloaded:!!C.downloaded,blacklisted:!!C.blacklisted,file_id:C.file_id??null,reaction:C.reaction??null},C.exists&&(m+=1),C.downloaded&&(v+=1))}$(),R(P()),G(w),e||n(`Atlas check: ${v}/${m} downloaded.`)})}function _e(e,d,r={}){const c=(m={})=>{e.reactionPending=r.blacklist?K.type:d,e.status="Reacting…",e.statusClass="",Z=e.url,$(),R(P());const v={...Ie(e,d),...m,...r.blacklist?{blacklist:!0}:{}};p({type:"atlas-react",payload:v},T=>{if(e.reactionPending=null,Z=null,!T){e.status="No response",e.statusClass="err",$(),R(P()),n("Atlas extension did not respond.","danger");return}if(!T.ok){e.status=T.error||"Failed",e.statusClass="err",$(),R(P()),n(T.error||"Reaction failed.","danger");return}const C=T.data||null,H=C?.file||null;e.atlas={exists:!!H,downloaded:!!H?.downloaded,blacklisted:!!H?.blacklisted_at,file_id:H?.id??null,reaction:C?.reaction??null},X.set(e.url,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&d!=="dislike"?(e.status="Queued",e.statusClass="queued"):(e.status="",e.statusClass=""),$(),R(P()),G(w),r.closeOnSuccess&&me(),e.atlas.exists&&!e.atlas.downloaded&&d!=="dislike"&&ge([e.url],0)})},i=!!e.atlas?.reaction?.type;if(d!=="dislike"&&e.atlas?.downloaded&&i){B({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(m=>{c(m==="confirm"?{force_download:!0}:{})});return}if(d==="dislike"&&e.atlas?.downloaded){B({title:r.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(m=>{if(m==="alternate"){n("Cancelled.");return}c(m==="confirm"?{clear_download:!0}:{})});return}c()}function it(e){B({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(d=>{d==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",Z=e.url,$(),R(P()),p({type:"atlas-delete-download",payload:{url:e.url,original_url:e.original_url||e.url,tag_name:e.tag_name,download_via:e.download_via||null}},r=>{if(e.reactionPending=null,Z=null,!r||!r.ok){e.status=r?.error||"Failed",e.statusClass="err",$(),R(P()),n(r?.error||"Delete failed.","danger");return}const c=r.data?.file||null;e.atlas={exists:!!c,downloaded:!!c?.downloaded,blacklisted:!!c?.blacklisted_at,file_id:c?.id??null,reaction:e.atlas?.reaction??null},e.status="",e.statusClass="",$(),R(P()),G(w),n("Download deleted.")}))})}function dt(){const e=w.filter(c=>c.selected);if(e.length===0){n("Select one or more items first.");return}if(e.some(c=>!!c.atlas?.downloaded)){B({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(c=>{if(c==="alternate"){n("Cancelled.");return}r(c==="confirm")});return}r(!1);function r(c){y.disabled=!0,k.disabled=!0,W.disabled=!0,F.disabled=!0,te.disabled=!0;for(const m of e)m.status="Sending…",m.statusClass="";$();const i=e.map(m=>{const v=qe(m);return c&&(v.force_download=!0),v});p({type:"atlas-download-batch",payloads:i},m=>{if(!m){for(const C of e)C.status="No response",C.statusClass="err";$(),R(P()),n("Atlas extension did not respond.","danger");return}const v=Array.isArray(m.results)?m.results:[],T=[];for(let C=0;C<e.length;C+=1){const H=e[C],ne=v[C];if(ne?.ok){const z=ne.data||null,Y=z?.file||null;H.atlas={exists:!!Y,downloaded:!!Y?.downloaded,blacklisted:!!Y?.blacklisted_at,file_id:Y?.id??null,reaction:H.atlas?.reaction??null},z?.queued?(H.status="Queued",H.statusClass="queued",T.push(H.url)):(H.status="",H.statusClass="")}else H.status=ne?.error||"Failed",H.statusClass="err"}$(),R(P()),G(w),m.ok?n(`Queued ${e.length} download(s) in Atlas.`):n(m.error||"Some requests failed.","danger"),T.length>0&&ge(T,0)})}}function ge(e,d){d>15||setTimeout(()=>{p({type:"atlas-check-batch",urls:e},r=>{if(!r||!r.ok){ge(e,d+1);return}const c=Array.isArray(r.data?.results)?r.data.results:[],i=new Map(c.map(v=>[v.url,v]));let m=0;for(const v of w){const T=i.get(v.url);T&&(v.atlas={exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,file_id:T.file_id??null,reaction:T.reaction??null},T.downloaded?v.status==="Queued"&&(v.status="",v.statusClass=""):m+=1)}$(),R(P()),G(w),m>0&&ge(e,d+1)})},2e3)}function G(e=w){tt();const d=document.querySelectorAll('[data-atlas-marked="1"]');for(const i of d)i.removeAttribute("data-atlas-marked"),i.removeAttribute("data-atlas-state"),i.removeAttribute("data-atlas-reaction");const r=new Map;for(const[i,m]of X.entries()){if(Date.now()-m.ts>Te){X.delete(i);continue}r.set(i,{exists:!!m.exists,downloaded:!!m.downloaded,blacklisted:!!m.blacklisted,reactionType:m.reactionType?String(m.reactionType):null}),r.set(se(i),{exists:!!m.exists,downloaded:!!m.downloaded,blacklisted:!!m.blacklisted,reactionType:m.reactionType?String(m.reactionType):null})}for(const i of e){if(!i?.url||!i?.atlas)continue;const m=i.atlas?.reaction?.type?String(i.atlas.reaction.type):null,v={exists:!!i.atlas.exists,downloaded:!!i.atlas.downloaded,blacklisted:!!i.atlas.blacklisted,reactionType:m};r.set(i.url,v),r.set(se(i.url),v)}if(r.size===0)return;const c=document.querySelectorAll("img, video, a[href]");for(const i of c){const m=i instanceof HTMLImageElement?O(i.currentSrc)||O(i.src)||"":i instanceof HTMLVideoElement?be(i)||"":i instanceof HTMLAnchorElement&&O(i.href)||"";if(!m)continue;const v=r.get(m)||r.get(se(m));v&&(i.setAttribute("data-atlas-marked","1"),v.downloaded?i.setAttribute("data-atlas-state","downloaded"):v.blacklisted?i.setAttribute("data-atlas-state","blacklisted"):v.reactionType?i.setAttribute("data-atlas-state","reacted"):v.exists&&i.setAttribute("data-atlas-state","exists"),v.reactionType&&i.setAttribute("data-atlas-reaction",v.reactionType))}}function ct(){const e=new Set,d=document.querySelectorAll("img, video, a[href]");for(const c of d){const i=c instanceof HTMLImageElement?O(c.currentSrc)||O(c.src)||"":c instanceof HTMLVideoElement?be(c)||"":c instanceof HTMLAnchorElement&&O(c.href)||"";i&&(e.add(i),e.add(se(i)))}const r=Me();return r?.url&&(e.add(r.url),e.add(se(r.url))),[...e].filter(Boolean)}function ut(){const e=ct();if(e.length===0){G(w);return}p({type:"atlas-check-batch",urls:e},d=>{if(!d?.ok){G(w);return}const r=Array.isArray(d.data?.results)?d.data.results:[];for(const c of r)c?.url&&X.set(String(c.url),{exists:!!c.exists,downloaded:!!c.downloaded,blacklisted:!!c.blacklisted,reactionType:c.reaction?.type?String(c.reaction.type):null,ts:Date.now()});G(w)})}}function Ze(t){return new Promise(a=>{const l=document.body||document.documentElement,o=Array.from(l.querySelectorAll("img, video")),n=o.length,p=new Set,s=[];let A=0;const h=b=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(b,{timeout:500});return}setTimeout(()=>b({timeRemaining:()=>25}),0)},f=b=>{const g=typeof b?.timeRemaining=="function"?b.timeRemaining():25;let x=0;for(;A<n&&(x<80||g>5);){const E=o[A];if(E.closest&&E.closest(`#${U}`)){A+=1,x+=1;continue}const k=he(E);k?.url&&!p.has(k.url)&&(p.add(k.url),s.push(k)),A+=1,x+=1}if(t?.({scanned:A,total:n}),A<n){h(f);return}const _=Me();_&&!p.has(_.url)&&(p.add(_.url),s.push(_)),a(s)};h(f)})}function he(t){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,l=a.naturalWidth||a.width||a.clientWidth||null,o=a.naturalHeight||a.height||a.clientHeight||null;if(l&&o&&(l<450||o<450))return null;const n=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),p=O(n);if(!p){const s=O(document.referrer)||"";return!s||!n.toLowerCase().startsWith("blob:")&&!n.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:s,original_url:s,referrer_url:n,preview_url:"",width:l,height:o,alt:a.alt||""}}return{tag_name:"img",url:p,original_url:p,referrer_url:window.location.href,preview_url:p,width:l,height:o,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=be(t);if(!a){const l=t,o=(l.currentSrc||l.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const n=window.location.href;return{tag_name:"video",url:n,original_url:`${n}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,referrer_url:n,preview_url:l.poster||"",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:a,original_url:a,referrer_url:window.location.href,preview_url:t.poster||"",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:""}}return null}function Me(){const t=(window.location.href||"").trim();if(!t)return null;const a=t.toLowerCase(),l=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(a),o=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!l&&!o)return null;if(a.startsWith("http://")||a.startsWith("https://"))return{tag_name:a.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,original_url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(a.startsWith("blob:")||a.startsWith("data:")){const n=O(document.referrer)||"";return n?{tag_name:"img",url:n,original_url:n,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function be(t){const a=O(t.currentSrc)||O(t.src)||O(t.getAttribute("src"));if(a)return a;const l=t.querySelector("source[src]"),o=l?O(l.src||l.getAttribute("src")):"";if(o)return o;const n=Je(t);return n||Ge()}function Ge(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const a of t){const o=document.querySelector(a)?.getAttribute("content"),n=O(o||"");if(n)return n}return""}function Je(t){let a=t,l=0;for(;a&&l<8;){const o=a.getAttribute?.("data-store");if(o){const n=Ye(o),p=ye(n,0);if(p)return p}a=a.parentElement,l+=1}return""}function Ye(t){if(!t)return null;const a=et(t);try{return JSON.parse(a)}catch{return null}}function et(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function ye(t,a){if(!t||a>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const o of t){const n=ye(o,a+1);if(n)return n}return""}if(typeof t!="object")return"";const l=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const o of l){const n=t[o];if(typeof n=="string"&&n.startsWith("http"))return n}for(const o of Object.keys(t)){const n=ye(t[o],a+1);if(n)return n}return""}function De(t){return function(l,o="info"){const n=document.createElement("div");n.className=`atlas-downloader-toast${o==="danger"?" danger":""}`,n.textContent=l,t.appendChild(n),requestAnimationFrame(()=>n.classList.add("show")),setTimeout(()=>{n.classList.remove("show"),n.addEventListener("transitionend",()=>n.remove(),{once:!0})},2600)}}function Ne(t){return a=>new Promise(l=>{const o=document.createElement("div");o.className="atlas-downloader-dialog-backdrop";const n=document.createElement("div");n.className=`atlas-downloader-dialog${a.danger?" danger":""}`.trim(),n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true"),n.setAttribute("aria-label",a.title);const p=document.createElement("h3");p.className="atlas-downloader-dialog-title",p.textContent=a.title;const s=document.createElement("p");s.className="atlas-downloader-dialog-message",s.textContent=a.message;const A=document.createElement("div");A.className="atlas-downloader-dialog-actions";const h=g=>{o.remove(),l(g)};if(a.alternateLabel){const g=document.createElement("button");g.type="button",g.className="atlas-downloader-dialog-btn secondary",g.textContent=a.alternateLabel,g.addEventListener("click",()=>h("alternate")),A.appendChild(g)}const f=document.createElement("button");f.type="button",f.className="atlas-downloader-dialog-btn",f.textContent=a.cancelLabel||"Cancel",f.addEventListener("click",()=>h("cancel")),A.appendChild(f);const b=document.createElement("button");b.type="button",b.className=`atlas-downloader-dialog-btn primary${a.danger?" danger":""}`.trim(),b.textContent=a.confirmLabel,b.addEventListener("click",()=>h("confirm")),A.appendChild(b),n.appendChild(p),n.appendChild(s),n.appendChild(A),o.appendChild(n),t.appendChild(o),requestAnimationFrame(()=>{b.focus()})})}function tt(){if(document.getElementById(Ce))return;const t=document.createElement("style");t.id=Ce,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function se(t){const a=t.indexOf("#");return a===-1?t:t.slice(0,a)}function Be(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(a=>a.trim()).filter(a=>a&&!a.startsWith("#")).map(a=>(a.startsWith("*.")?a.slice(2):a).toLowerCase()).map(a=>ve(a)||a.replace(/^\.+/,"").trim()).filter(Boolean)}function Re(t,a){const l=(t||"").toLowerCase();if(!l)return!1;for(const o of a)if(ke(l,o))return!0;return!1}function ve(t){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const l=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(l).hostname}catch{return""}}function ke(t,a){return!t||!a?!1:t===a||t.endsWith(`.${a}`)}function O(t){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const l=a.toLowerCase();return l.startsWith("blob:")||l.startsWith("data:")||l.startsWith("chrome-extension:")||l.startsWith("moz-extension:")||l.startsWith("safari-extension:")?"":a}function $e(t){const a=t.enabled??!0,l=t.getHintShown??(()=>!1),o=t.setHintShown??(()=>{}),n=()=>{l()||(o(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},p=s=>(typeof s.composedPath=="function"?s.composedPath():[]).some(h=>h instanceof HTMLElement&&h.id===U);document.addEventListener("click",s=>{!a||!(s instanceof MouseEvent)||!s.altKey||t.isSheetOpen()||p(s)||!((s.target instanceof Element?s.target:null)?.closest?.("img, video")??null)||(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation())},!0),document.addEventListener("mousedown",s=>{if(!a||!(s instanceof MouseEvent)||!s.altKey||t.isSheetOpen()||p(s))return;const h=(s.target instanceof Element?s.target:null)?.closest?.("img, video")??null;if(!h)return;const f=s.button===0?"like":s.button===1?"love":null;if(!f)return;n(),s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation();const b=he(h);if(!b){if(h instanceof HTMLVideoElement){const x=(h.currentSrc||h.src||"").trim().toLowerCase();if(x.startsWith("blob:")||x.startsWith("data:")){const _=window.location.href,E=`${_}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,k={type:f,url:_,original_url:E,referrer_url:_,page_title:q(document.title,500),tag_name:"video",width:h.videoWidth||h.clientWidth||null,height:h.videoHeight||h.clientHeight||null,alt:"",preview_url:h.poster||"",source:J(_),download_via:"yt-dlp"};fe(t.sendMessageSafe,k.url,W=>{if(W?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(M=>{M==="confirm"&&(k.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:k},S=>{if(!S||!S.ok){t.showToast(S?.error||"Reaction failed.","danger");return}const I=S.data||null,F=I?.file||null,te=I?.reaction?.type?String(I.reaction.type):f;X.set(k.url,{exists:!!F,downloaded:!!F?.downloaded,blacklisted:!!F?.blacklisted_at,reactionType:te,ts:Date.now()}),t.showToast(`Reacted (${f}). Resolving video in Atlas…`)})});return}t.sendMessageSafe({type:"atlas-react",payload:k},M=>{if(!M||!M.ok){t.showToast(M?.error||"Reaction failed.","danger");return}const S=M.data||null,I=S?.file||null,F=S?.reaction?.type?String(S.reaction.type):f;X.set(k.url,{exists:!!I,downloaded:!!I?.downloaded,blacklisted:!!I?.blacklisted_at,reactionType:F,ts:Date.now()}),t.showToast(`Reacted (${f}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const g={type:f,url:b.url,original_url:b.url,referrer_url:window.location.href,page_title:q(document.title,500),tag_name:b.tag_name,width:b.width,height:b.height,alt:q(b.alt||"",500),preview_url:b.preview_url||"",source:J(b.url)};fe(t.sendMessageSafe,g.url,x=>{if(x?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(_=>{_==="confirm"&&(g.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:g},E=>{if(!E||!E.ok){t.showToast(E?.error||"Reaction failed.","danger");return}const k=E.data||null,W=k?.file||null,M=k?.reaction?.type?String(k.reaction.type):f;X.set(g.url,{exists:!!W,downloaded:!!W?.downloaded,blacklisted:!!W?.blacklisted_at,reactionType:M,ts:Date.now()}),t.showToast(`Reacted (${f}). Queued download in Atlas.`)})});return}t.sendMessageSafe({type:"atlas-react",payload:g},_=>{if(!_||!_.ok){t.showToast(_?.error||"Reaction failed.","danger");return}const E=_.data||null,k=E?.file||null,W=E?.reaction?.type?String(E.reaction.type):f;X.set(g.url,{exists:!!k,downloaded:!!k?.downloaded,blacklisted:!!k?.blacklisted_at,reactionType:W,ts:Date.now()}),t.showToast(`Reacted (${f}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",s=>{if(!a||!(s instanceof MouseEvent)||!s.altKey||t.isSheetOpen()||p(s))return;const h=(s.target instanceof Element?s.target:null)?.closest?.("img, video")??null;if(!h)return;n(),s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation();const f=he(h);if(!f){if(h instanceof HTMLVideoElement){const g=(h.currentSrc||h.src||"").trim().toLowerCase();if(g.startsWith("blob:")||g.startsWith("data:")){const x=window.location.href,_=`${x}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,E={type:"dislike",url:x,original_url:_,referrer_url:x,page_title:q(document.title,500),tag_name:"video",width:h.videoWidth||h.clientWidth||null,height:h.videoHeight||h.clientHeight||null,alt:"",preview_url:h.poster||"",source:J(x),download_via:"yt-dlp"};t.sendMessageSafe({type:"atlas-react",payload:E},k=>{if(!k||!k.ok){t.showToast(k?.error||"Reaction failed.","danger");return}t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const b={type:"dislike",url:f.url,original_url:f.url,referrer_url:window.location.href,page_title:q(document.title,500),tag_name:f.tag_name,width:f.width,height:f.height,alt:q(f.alt||"",500),preview_url:f.preview_url||"",source:J(f.url)};t.sendMessageSafe({type:"atlas-react",payload:b},g=>{if(!g||!g.ok){t.showToast(g?.error||"Reaction failed.","danger");return}t.showToast("Disliked.")})},!0)}function Pe(t,a,l){return t<a?a:t>l?l:t}function He(t,a){const l=he(t);if(l)return{type:a,url:l.url,original_url:l.url,referrer_url:window.location.href,page_title:q(document.title,500),tag_name:l.tag_name,width:l.width,height:l.height,alt:q(l.alt||"",500),preview_url:l.preview_url||"",source:J(l.url)};if(t instanceof HTMLVideoElement){const o=(t.currentSrc||t.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const n=window.location.href,p=`${n}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`;return{type:a,url:n,original_url:p,referrer_url:n,page_title:q(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:J(n),download_via:"yt-dlp"}}}return null}function Ue(t){const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");let l=null,o=null,n=null,p=!1,s=-1,A=-1,h=null;const f=new Map,b=(u,y=null)=>{p=u;for(const[D,N]of f.entries())N.disabled=u,N.classList.toggle("pending",u&&y===D)},g=u=>{for(const y of[...we,K]){const D=f.get(y.type);if(!D)continue;const N=y.type===K.type?u==="dislike":u===y.type;D.classList.toggle("active",N)}},x=()=>{n&&(window.clearTimeout(n),n=null)},_=()=>{p||(l=null,o=null,a.classList.remove("open"),a.style.left="",a.style.top="",g(null))},E=()=>{x(),n=window.setTimeout(()=>{a.matches(":hover")||_()},140)},k=u=>{u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation?.()};for(const u of[...we,K]){const y=document.createElement("button");y.type="button",y.className=`atlas-downloader-reaction-btn ${u.className}`.trim(),y.setAttribute("aria-label",u.label),y.title=u.label,y.replaceChildren(ue(u.pathDs)),f.set(u.type,y),y.addEventListener("pointerdown",k,!0),y.addEventListener("mousedown",k,!0),y.addEventListener("click",D=>{if(k(D),p)return;if(!l){t.showToast("No media selected.");return}const N=u.type===K.type?"dislike":u.type,B=He(l,N);if(!B){t.showToast("No valid media URL found.");return}const w=B.url||"",ae=(Z=!1)=>{Z?B.force_download=!0:"force_download"in B&&delete B.force_download,b(!0,u.type),t.sendMessageSafe({type:"atlas-react",payload:{...B,...u.type===K.type?{blacklist:!0}:{}}},V=>{if(b(!1,null),!V||!V.ok){t.showToast(V?.error||"Reaction failed.","danger");return}const ie=V.data||null,le=ie?.file||null,oe=ie?.reaction?.type?String(ie.reaction.type):u.type===K.type?"dislike":u.type;if(w&&X.set(w,{exists:!!le,downloaded:!!le?.downloaded,blacklisted:!!le?.blacklisted_at,reactionType:oe,ts:Date.now()}),g(oe),B.download_via==="yt-dlp"){t.showToast(`Reacted (${u.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${u.label}). Queued download in Atlas.`)})};fe(t.sendMessageSafe,w,Z=>{if(N!=="dislike"&&Z?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(V=>{ae(V==="confirm")});return}ae(!1)})}),a.appendChild(y)}t.root.appendChild(a);const W=u=>(typeof u.composedPath=="function"?u.composedPath():[]).some(D=>D instanceof HTMLElement&&D.id===U),M=()=>{if(!l)return;const u=l.getBoundingClientRect();if(!Number.isFinite(u.left)||u.width<=0||u.height<=0){_();return}const y=Pe(u.top+8,8,window.innerHeight-8),D=Pe(u.right-8,8,window.innerWidth-8);a.style.top=`${y}px`,a.style.left=`${D}px`},S=u=>{if(t.isSheetOpen()){_();return}const y=He(u,"like");if(!y){_();return}if(l=u,o=y.url||null,a.classList.add("open"),M(),g(null),o){const D=Se(o);if(D)g(D.reactionType);else{const N=o;fe(t.sendMessageSafe,N,B=>{B&&o===N&&g(B.reactionType)})}}},I=()=>{if(s<0||A<0||t.isSheetOpen())return;const u=document.elementFromPoint(s,A);if(!(u instanceof Element)||u.closest?.(`#${U}`))return;const y=u.closest?.("img, video")??null;y&&(x(),S(y))},F=(u=80)=>{h!==null&&window.clearTimeout(h),h=window.setTimeout(()=>{h=null,I()},u)};document.addEventListener("pointerover",u=>{if(t.isSheetOpen()||!(u.target instanceof Element)||W(u))return;const y=u.target.closest?.("img, video")??null;y&&(x(),S(y))},!0),document.addEventListener("pointermove",u=>{s=u.clientX,A=u.clientY},!0),document.addEventListener("pointerout",u=>{!l||t.isSheetOpen()||!(u.target instanceof Element)||W(u)||!(u.target.closest?.("img, video")??null)||E()},!0),a.addEventListener("pointerenter",x,!0),a.addEventListener("pointerleave",E,!0),window.addEventListener("scroll",M,!0),window.addEventListener("resize",M),window.addEventListener("blur",_),window.addEventListener("focus",()=>F(40),!0),new MutationObserver(()=>{F(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
