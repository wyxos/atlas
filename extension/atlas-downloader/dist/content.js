(function(){"use strict";const mt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function ht(t){const n=(t||"").trim().toLowerCase();if(!n)return"";const a=n.split(".").filter(Boolean);if(a.length<=2)return n;const r=a.slice(-2).join("."),s=a.slice(-3).join(".");return mt.has(r)&&a.length>=3?s:r}function pt(t){const n=(t||"").trim();if(!n)return"";try{const a=new URL(n).hostname;return ht(a)}catch{return""}}function gt(t,n){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const r=a.toLowerCase();if(r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:"))return"";try{const s=new URL(a,n);return s.protocol!=="http:"&&s.protocol!=="https:"?"":s.toString()}catch{return""}}const wt=Fe(["host:st.deviantart.net","url:*wixmp.com*/crop/w_92,h_92*","url:*wixmp.com*/crop/w_150,h_150*","url:*wixmp.com*/fit/w_150,h_150*"].join(`
`));let Be=[];function ae(t){return gt(t,window.location.href)}function Ue(t){Be=Fe(t)}function Ie(t){const n=ae(t.currentSrc)||ae(t.src)||ae(t.getAttribute("src")||"");if(n)return n;const a=t.querySelector("source[src]"),r=a?ae(a.src||a.getAttribute("src")||""):"";if(r)return r;const s=kt(t);return s||yt()}function be(t,n){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,r=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),s=ae(r);if(s&&xe(s))return null;const{width:S,height:E}=_t(a,s||r),$=S??ge(a.clientWidth),p=E??ge(a.clientHeight);if($&&$<n||p&&p<n)return null;if(!s){const x=ae(document.referrer)||ae(window.location.href)||"";return!x||!r.toLowerCase().startsWith("blob:")&&!r.toLowerCase().startsWith("data:")||xe(x)?null:{tag_name:"img",url:x,referrer_url:window.location.href,preview_url:"",width:S,height:E,alt:a.alt||""}}return{tag_name:"img",url:s,referrer_url:window.location.href,preview_url:s,width:S,height:E,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=t,r=a.videoWidth||a.clientWidth||null,s=a.videoHeight||a.clientHeight||null;if(r&&s&&(r<n||s<n))return null;const S=Ie(a);if(S&&xe(S))return null;if(!S){const E=(a.currentSrc||a.src||"").trim().toLowerCase();if(E.startsWith("blob:")||E.startsWith("data:")){const $=window.location.href;return{tag_name:"video",url:$,referrer_url:$,preview_url:a.poster||"",width:r,height:s,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:S,referrer_url:window.location.href,preview_url:a.poster||"",width:r,height:s,alt:""}}return null}function Pe(){const t=(window.location.href||"").trim();if(!t)return null;const n=t.toLowerCase(),a=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(n),r=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!a&&!r)return null;if(n.startsWith("http://")||n.startsWith("https://"))return{tag_name:n.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(n.startsWith("blob:")||n.startsWith("data:")){const s=ae(document.referrer)||"";return s?{tag_name:"img",url:s,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function $e(t){const n=new Set,a=ae(window.location.href),r=t instanceof HTMLImageElement?ae(t.currentSrc)||ae(t.src)||"":t instanceof HTMLVideoElement?Ie(t)||"":t instanceof HTMLAnchorElement&&He(t.getAttribute("href")||"")||"";r&&n.add(r);const s=t.closest("a[href]")?.getAttribute("href")??"",S=He(s);return S&&n.add(S),a&&bt(t)&&n.add(a),[...n]}function He(t){const n=(t||"").trim();return!n||n.startsWith("#")||n.toLowerCase().startsWith("javascript:")?"":ae(n)}function bt(t){if(t instanceof HTMLImageElement){const n=(t.currentSrc||t.src||t.getAttribute("src")||"").trim().toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")}if(t instanceof HTMLVideoElement){const n=(t.currentSrc||t.src||"").trim().toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")}return!1}function yt(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const n of t){const r=document.querySelector(n)?.getAttribute("content")||"",s=ae(r);if(s)return s}return""}function kt(t){let n=t,a=0;for(;n&&a<8;){const r=n.getAttribute?.("data-store");if(r){const s=vt(r),S=Ce(s,0);if(S)return S}n=n.parentElement,a+=1}return""}function vt(t){if(!t)return null;const n=Et(t);try{return JSON.parse(n)}catch{return null}}function Et(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Ce(t,n){if(!t||n>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const a of t){const r=Ce(a,n+1);if(r)return r}return""}if(typeof t=="object")for(const a of Object.keys(t)){const r=t[a],s=Ce(r,n+1);if(s)return s}return""}function _t(t,n){const a=ge(t.naturalWidth),r=ge(t.naturalHeight),s=At(n),S=Oe(t.getAttribute("width")),E=Oe(t.getAttribute("height"));return{width:qe(a,s.width,S),height:qe(r,s.height,E)}}function At(t){const n=(t||"").trim();if(!n)return{width:null,height:null};const a=We(n,[/(?:^|[/,?&_=-])w_(\d{2,5})(?=$|[/,?&_=-])/i]),r=We(n,[/(?:^|[/,?&_=-])h_(\d{2,5})(?=$|[/,?&_=-])/i]);let s=a;const S=r,E=n.match(/-(\d{2,5})w-(\d)x(?=$|[./?&_-])/i);if(E){const $=parseInt(E[1],10),p=parseInt(E[2],10),x=ge($*p);x&&(!s||x>s)&&(s=x)}return{width:s??null,height:S??null}}function We(t,n){for(const a of n){const r=t.match(a);if(!r||!r[1])continue;const s=ge(parseInt(r[1],10));if(s)return s}return null}function Oe(t){if(!t)return null;const n=t.trim();if(!n)return null;const a=n.match(/^\d+/)?.[0]??"";return a?ge(parseInt(a,10)):null}function ge(t){if(typeof t!="number"||!Number.isFinite(t))return null;const n=Math.round(t);return n>0?n:null}function xe(t){const n=(t||"").trim().toLowerCase();if(!n)return!1;const a=[...wt,...Be],r=St(n);for(const s of a){if(s.kind==="host"){if(Lt(r,s.host))return!0;continue}if(s.kind==="urlPattern"){if(s.regex.test(n))return!0;continue}if(n.includes(s.needle))return!0}return!1}function St(t){try{return new URL(t).hostname.toLowerCase()}catch{return""}}function Lt(t,n){const a=(t||"").trim().toLowerCase(),r=(n||"").trim().toLowerCase();return!a||!r?!1:a===r||a.endsWith(`.${r}`)}function Fe(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n!==""&&!n.startsWith("#")).map(n=>Ct(n)).filter(n=>n!==null)}function Ct(t){const n=t.trim();if(!n)return null;const a=n.toLowerCase();if(a.startsWith("host:")){const s=Qe(n.slice(5));return s?{kind:"host",host:s}:null}if(a.startsWith("url:"))return je(n.slice(4));const r=Qe(n);return r?{kind:"host",host:r}:je(n)}function je(t){const n=t.trim().toLowerCase();if(!n)return null;if(!n.includes("*"))return{kind:"urlContains",needle:n};const a=xt(n);try{return{kind:"urlPattern",regex:new RegExp(a,"i")}}catch{return null}}function xt(t){return t.split("*").map(n=>Tt(n)).join(".*")}function Tt(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Qe(t){const n=(t||"").trim();if(!n)return"";const a=n.startsWith("*.")?n.slice(2):n,r=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(r).hostname.toLowerCase()}catch{return""}}function qe(...t){let n=null;for(const a of t)a&&(n===null||a>n)&&(n=a);return n}const ze="http://www.w3.org/2000/svg",ve=t=>{const n=document.createElementNS(ze,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const a of t){const r=document.createElementNS(ze,"path");r.setAttribute("d",a),r.setAttribute("fill","none"),r.setAttribute("stroke","currentColor"),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round"),n.appendChild(r)}return n},Ee=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],Y={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]};function Ke(t,n){const a=t.enabled??!0,r=t.getHintShown??(()=>!1),s=t.setHintShown??(()=>{}),S=()=>{r()||(s(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},E=(p,x,f,b=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:p,pending:x,reactionType:f,url:b}}))},$=p=>(typeof p.composedPath=="function"?p.composedPath():[]).some(f=>f instanceof HTMLElement&&f.id===n.rootId);document.addEventListener("click",p=>{!a||!(p instanceof MouseEvent)||!p.altKey||t.isSheetOpen()||$(p)||!((p.target instanceof Element?p.target:null)?.closest?.("img, video")??null)||(p.preventDefault(),p.stopPropagation(),p.stopImmediatePropagation())},!0),document.addEventListener("mousedown",p=>{if(!a||!(p instanceof MouseEvent)||!p.altKey||t.isSheetOpen()||$(p))return;const f=(p.target instanceof Element?p.target:null)?.closest?.("img, video")??null;if(!f)return;const b=p.button===0?"like":p.button===1?"love":null;if(!b)return;S(),p.preventDefault(),p.stopPropagation(),p.stopImmediatePropagation();const U=be(f,n.minSize);if(!U){if(f instanceof HTMLVideoElement){const ce=(f.currentSrc||f.src||"").trim().toLowerCase();if(ce.startsWith("blob:")||ce.startsWith("data:")){const W=window.location.href,M={type:b,url:W,referrer_url:W,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:"video",width:f.videoWidth||f.clientWidth||null,height:f.videoHeight||f.clientHeight||null,alt:"",preview_url:f.poster||"",source:n.sourceFromMediaUrl(W),download_via:"yt-dlp"};n.fetchAtlasStatus(t.sendMessageSafe,M.url,M.referrer_url||null,_=>{if(_?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(y=>{if(y==="alternate"){t.showToast("Cancelled.");return}E(f,!0,b,M.url),y==="confirm"&&(M.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:M},C=>{if(!C||!C.ok){E(f,!1,null,M.url),t.showToast(C?.error||"Reaction failed.","danger");return}const k=C.data||null,g=k?.file||null,P=k?.reaction?.type?String(k.reaction.type):b;n.atlasStatusCache.set(M.url,{exists:!!g,downloaded:!!g?.downloaded,blacklisted:!!g?.blacklisted_at,reactionType:P,ts:Date.now()}),E(f,!1,P,M.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}E(f,!0,b,M.url),t.sendMessageSafe({type:"atlas-react",payload:M},y=>{if(!y||!y.ok){E(f,!1,null,M.url),t.showToast(y?.error||"Reaction failed.","danger");return}const C=y.data||null,k=C?.file||null,g=C?.reaction?.type?String(C.reaction.type):b;n.atlasStatusCache.set(M.url,{exists:!!k,downloaded:!!k?.downloaded,blacklisted:!!k?.blacklisted_at,reactionType:g,ts:Date.now()}),E(f,!1,g,M.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const D={type:b,url:U.url,referrer_url:U.referrer_url||window.location.href,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:U.tag_name,width:U.width,height:U.height,alt:n.limitString(U.alt||"",n.maxMetadataLen),preview_url:U.preview_url||"",source:n.sourceFromMediaUrl(U.url)};n.fetchAtlasStatus(t.sendMessageSafe,D.url,D.referrer_url||null,ce=>{if(ce?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(W=>{if(W==="alternate"){t.showToast("Cancelled.");return}E(f,!0,b,D.url),W==="confirm"&&(D.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:D},M=>{if(!M||!M.ok){E(f,!1,null,D.url),t.showToast(M?.error||"Reaction failed.","danger");return}const _=M.data||null,y=_?.file||null,C=_?.reaction?.type?String(_.reaction.type):b;n.atlasStatusCache.set(D.url,{exists:!!y,downloaded:!!y?.downloaded,blacklisted:!!y?.blacklisted_at,reactionType:C,ts:Date.now()}),E(f,!1,C,D.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})});return}E(f,!0,b,D.url),t.sendMessageSafe({type:"atlas-react",payload:D},W=>{if(!W||!W.ok){E(f,!1,null,D.url),t.showToast(W?.error||"Reaction failed.","danger");return}const M=W.data||null,_=M?.file||null,y=M?.reaction?.type?String(M.reaction.type):b;n.atlasStatusCache.set(D.url,{exists:!!_,downloaded:!!_?.downloaded,blacklisted:!!_?.blacklisted_at,reactionType:y,ts:Date.now()}),E(f,!1,y,D.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",p=>{if(!a||!(p instanceof MouseEvent)||!p.altKey||t.isSheetOpen()||$(p))return;const f=(p.target instanceof Element?p.target:null)?.closest?.("img, video")??null;if(!f)return;S(),p.preventDefault(),p.stopPropagation(),p.stopImmediatePropagation();const b=be(f,n.minSize);if(!b){if(f instanceof HTMLVideoElement){const D=(f.currentSrc||f.src||"").trim().toLowerCase();if(D.startsWith("blob:")||D.startsWith("data:")){const ce=window.location.href,W={type:"dislike",url:ce,referrer_url:ce,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:"video",width:f.videoWidth||f.clientWidth||null,height:f.videoHeight||f.clientHeight||null,alt:"",preview_url:f.poster||"",source:n.sourceFromMediaUrl(ce),download_via:"yt-dlp"};E(f,!0,"dislike",W.url),t.sendMessageSafe({type:"atlas-react",payload:W},M=>{if(!M||!M.ok){E(f,!1,null,W.url),t.showToast(M?.error||"Reaction failed.","danger");return}E(f,!1,"dislike",W.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const U={type:"dislike",url:b.url,referrer_url:b.referrer_url||window.location.href,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:b.tag_name,width:b.width,height:b.height,alt:n.limitString(b.alt||"",n.maxMetadataLen),preview_url:b.preview_url||"",source:n.sourceFromMediaUrl(b.url)};E(f,!0,"dislike",U.url),t.sendMessageSafe({type:"atlas-react",payload:U},D=>{if(!D||!D.ok){E(f,!1,null,U.url),t.showToast(D?.error||"Reaction failed.","danger");return}E(f,!1,"dislike",U.url),t.showToast("Disliked.")})},!0)}function Ve(t,n,a){return t<n?n:t>a?a:t}function Xe(t,n,a){const r=be(t,a.minSize);if(r)return{type:n,url:r.url,referrer_url:r.referrer_url||window.location.href,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:r.tag_name,width:r.width,height:r.height,alt:a.limitString(r.alt||"",a.maxMetadataLen),preview_url:r.preview_url||"",source:a.sourceFromMediaUrl(r.url)};if(t instanceof HTMLVideoElement){const s=(t.currentSrc||t.src||"").trim().toLowerCase();if(s.startsWith("blob:")||s.startsWith("data:")){const S=window.location.href;return{type:n,url:S,referrer_url:S,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:a.sourceFromMediaUrl(S),download_via:"yt-dlp"}}}return null}function Ze(t,n){const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");const r=document.createElement("span");r.className="atlas-downloader-media-resolution",r.hidden=!0,a.appendChild(r);let s=null,S=null,E=null,$=!1,p=null,x=null,f=-1,b=-1,U=null;const D=new Map,ce=(i,h)=>{const L=typeof i=="number"&&Number.isFinite(i)&&i>0?Math.round(i):null,F=typeof h=="number"&&Number.isFinite(h)&&h>0?Math.round(h):null;return!L||!F?"":`${L}x${F}`},W=(i,h)=>{const L=ce(i,h);if(!L){r.textContent="",r.hidden=!0;return}r.textContent=L,r.hidden=!1},M=()=>{const i=$||p!==null;for(const[h,L]of D.entries())L.disabled=i,L.classList.toggle("pending",$&&x===h)},_=(i,h=null)=>{$=i,x=i?h:null,M()},y=i=>{for(const h of[...Ee,Y]){const L=D.get(h.type);if(!L)continue;const F=h.type===Y.type?i==="dislike":i===h.type;L.classList.toggle("active",F)}},C=(i,h)=>{p=i&&h===!1&&i!=="dislike"?i:null;for(const L of[...Ee,Y]){const F=D.get(L.type);if(!F)continue;const I=L.type===Y.type?p==="dislike":p===L.type;F.classList.toggle("queued",I)}M()},k=(i,h,L)=>{s&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:s,pending:i,reactionType:h,url:L}}))},g=()=>{E&&(window.clearTimeout(E),E=null)},P=()=>{$||(s=null,S=null,a.classList.remove("open"),a.style.left="",a.style.top="",W(null,null),y(null))},O=()=>{g(),E=window.setTimeout(()=>{a.matches(":hover")||P()},140)},z=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of[...Ee,Y]){const h=document.createElement("button");h.type="button",h.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),h.setAttribute("aria-label",i.label),h.title=i.label,h.replaceChildren(ve(i.pathDs)),D.set(i.type,h),h.addEventListener("pointerdown",z,!0),h.addEventListener("mousedown",z,!0),h.addEventListener("click",L=>{if(z(L),$)return;if(!s){t.showToast("No media selected.");return}const F=i.type===Y.type?"dislike":i.type,I=Xe(s,F,n);if(!I){t.showToast("No valid media URL found.");return}const H=I.url||"",Z=(ne=!1)=>{ne?I.force_download=!0:"force_download"in I&&delete I.force_download,k(!0,i.type,H||null),_(!0,i.type),t.sendMessageSafe({type:"atlas-react",payload:{...I,...i.type===Y.type?{blacklist:!0}:{}}},A=>{if(_(!1,null),!A||!A.ok){k(!1,null,H||null),t.showToast(A?.error||"Reaction failed.","danger");return}const le=A.data||null,te=le?.file||null,se=le?.reaction?.type?String(le.reaction.type):i.type===Y.type?"dislike":i.type;if(H&&n.atlasStatusCache.set(H,{exists:!!te,downloaded:!!te?.downloaded,blacklisted:!!te?.blacklisted_at,reactionType:se,ts:Date.now()}),y(se),C(se,!!te?.downloaded),k(!1,se,H||null),I.download_via==="yt-dlp"){t.showToast(`Reacted (${i.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${i.label}). Queued download in Atlas.`)})};n.fetchAtlasStatus(t.sendMessageSafe,H,I.referrer_url||null,ne=>{if(F!=="dislike"&&ne?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(A=>{if(A==="alternate"){t.showToast("Cancelled.");return}Z(A==="confirm")});return}Z(!1)})}),a.appendChild(h)}t.root.appendChild(a);const re=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(L=>L instanceof HTMLElement&&L.id===n.rootId),N=()=>{if(!s)return;const i=s.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){P();return}const h=Ve(i.top+8,8,window.innerHeight-8),L=Ve(i.right-8,8,window.innerWidth-8);a.style.top=`${h}px`,a.style.left=`${L}px`},K=(i,h)=>{const L=H=>{if(H.matches("img, video"))return H;const Z=H.closest?.("img, video");if(Z instanceof Element)return Z;const ne=H.querySelectorAll?.("img, video");if(!ne||ne.length===0)return null;for(const A of ne){const le=A.getBoundingClientRect();if(i>=le.left&&i<=le.right&&h>=le.top&&h<=le.bottom)return A}return null},F=document.elementsFromPoint?.(i,h)??[];for(const H of F){if(!(H instanceof Element)||H.closest?.(`#${n.rootId}`))continue;const Z=L(H);if(Z)return Z}const I=document.elementFromPoint?.(i,h);return I instanceof Element&&!I.closest?.(`#${n.rootId}`)?L(I):null},Q=i=>{if(t.isSheetOpen()){P();return}const h=Xe(i,"like",n);if(!h){P();return}if(s=i,S=h.url||null,W(h.width,h.height),a.classList.add("open"),N(),y(null),C(null,null),S){const L=n.getCachedAtlasStatus(S);if(L)y(L.reactionType),C(L.reactionType,L.downloaded);else{const F=S;n.fetchAtlasStatus(t.sendMessageSafe,F,window.location.href,I=>{I&&S===F&&(y(I.reactionType),C(I.reactionType,I.downloaded))})}}},he=i=>i?i==="blacklist"?"blacklist":i:null,oe=()=>{if(f<0||b<0||t.isSheetOpen())return;const i=K(f,b);i&&(i.closest?.(`#${n.rootId}`)||(g(),Q(i)))},ee=(i=80)=>{U!==null&&window.clearTimeout(U),U=window.setTimeout(()=>{U=null,oe()},i)};document.addEventListener("pointerover",i=>{if(t.isSheetOpen()||!(i.target instanceof Element)||re(i))return;const h=K(i.clientX,i.clientY);h&&(g(),Q(h))},!0),window.addEventListener("atlas-shortcut-reaction-state",i=>{const h=i,L=h.detail?.media;if(!(L instanceof Element))return;g(),Q(L);const F=!!h.detail?.pending,I=he(h.detail?.reactionType??null);if(F){_(!0,I);return}if(_(!1,null),I){const H=I==="blacklist"?"dislike":I;y(H);const Z=S?n.getCachedAtlasStatus(S):null;C(H,Z?.downloaded??null)}},!0),document.addEventListener("pointermove",i=>{f=i.clientX,b=i.clientY},!0),document.addEventListener("pointerout",i=>{!s||t.isSheetOpen()||!(i.target instanceof Element)||re(i)||!(i.target.closest?.("img, video")??null)||O()},!0),a.addEventListener("pointerenter",g,!0),a.addEventListener("pointerleave",O,!0),window.addEventListener("scroll",N,!0),window.addEventListener("resize",N),window.addEventListener("blur",P),window.addEventListener("focus",()=>ee(40),!0),new MutationObserver(()=>{ee(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}function j(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function Je(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>Te(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Ye(t,n){const a=(t||"").toLowerCase();if(!a)return!1;for(const r of n)if(Me(a,r))return!0;return!1}function Te(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const a=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(a).hostname}catch{return""}}function Me(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}const Ge="atlas-downloader-page-markers";function et(t){return function(a,r="info"){const s=document.createElement("div");s.className=`atlas-downloader-toast${r==="danger"?" danger":""}`,s.textContent=a,t.appendChild(s),requestAnimationFrame(()=>s.classList.add("show")),setTimeout(()=>{s.classList.remove("show"),s.addEventListener("transitionend",()=>s.remove(),{once:!0})},2600)}}function tt(t){return n=>new Promise(a=>{const r=document.createElement("div");r.className="atlas-downloader-dialog-backdrop";const s=document.createElement("div");s.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),s.setAttribute("role","dialog"),s.setAttribute("aria-modal","true"),s.setAttribute("aria-label",n.title);const S=document.createElement("h3");S.className="atlas-downloader-dialog-title",S.textContent=n.title;const E=document.createElement("p");E.className="atlas-downloader-dialog-message",E.textContent=n.message;const $=document.createElement("div");$.className="atlas-downloader-dialog-actions";const p=b=>{r.remove(),a(b)};if(n.alternateLabel){const b=document.createElement("button");b.type="button",b.className="atlas-downloader-dialog-btn secondary",b.textContent=n.alternateLabel,b.addEventListener("click",()=>p("alternate")),$.appendChild(b)}const x=document.createElement("button");x.type="button",x.className="atlas-downloader-dialog-btn",x.textContent=n.cancelLabel||"Cancel",x.addEventListener("click",()=>p("cancel")),$.appendChild(x);const f=document.createElement("button");f.type="button",f.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),f.textContent=n.confirmLabel,f.addEventListener("click",()=>p("confirm")),$.appendChild(f),s.appendChild(S),s.appendChild(E),s.appendChild($),r.appendChild(s),t.appendChild(r),requestAnimationFrame(()=>{f.focus()})})}function Mt(){if(document.getElementById(Ge))return;const t=document.createElement("style");t.id=Ge,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 4px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 4px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 4px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 4px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 4px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: -4px !important;
}
`,(document.head||document.documentElement).appendChild(t)}(()=>{const a="atlas-downloader-root",r="atlas-open",s=(()=>{try{return window.top===window.self}catch{return!1}})(),S=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let E=null,$=null;const p=3e4,x=new Map;function f(_,y){const C=typeof _=="string"?_:"";return C.length<=y?C:C.slice(0,y)}function b(_){return pt(_)||"Extension"}function U(_){const y=x.get(_);return y?Date.now()-y.ts>p?(x.delete(_),null):y:null}function D(_,y,C,k){const g=j((y||"").trim());if(!g){k(null);return}const P=U(g);if(P){k(P);return}_({type:"atlas-check-batch",urls:[g]},O=>{if(!O||!O.ok){k(null);return}const z=Array.isArray(O.data?.results)?O.data.results:[],N=new Map(z.filter(Q=>typeof Q?.url=="string"&&Q.url.trim()!=="").map(Q=>[j(String(Q.url)),Q])).get(g)??null;if(!N){k(null);return}const K={exists:!!N.exists,downloaded:!!N.downloaded,blacklisted:!!N.blacklisted,reactionType:N.reaction?.type?String(N.reaction.type):null,ts:Date.now()};x.set(g,K),k(K)})}chrome.runtime.onMessage.addListener(_=>{if(!_||typeof _!="object")return;const y=_;if(y.type==="atlas-download-event"){$?.(y.payload);return}if(y.type==="atlas-open-sheet"&&s)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],C=>{Ue(C.atlasMediaNoiseFilters||"");const k=Te(C.atlasBaseUrl||"");if(k&&Me(window.location.hostname,k))return;const g=Je(C.atlasExcludedDomains||"");Ye(window.location.hostname,g)||(W(),E?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],_=>{Ue(_.atlasMediaNoiseFilters||"");const y=Te(_.atlasBaseUrl||"");if(y&&Me(window.location.hostname,y))return;const C=Je(_.atlasExcludedDomains||"");Ye(window.location.hostname,C)||(s?W():ce())});function ce(){if(document.getElementById(a))return;const _=document.createElement("div");_.id=a;const y=_.attachShadow({mode:"closed"}),C=document.createElement("link");C.rel="stylesheet",C.href=chrome.runtime.getURL("dist/content.css"),y.appendChild(C);const k=document.createElement("div");k.className="atlas-shadow-root";const g=et(k),P=tt(k),O=(z,re)=>{try{chrome.runtime.sendMessage(z,re)}catch(N){(()=>{if(N instanceof Error)return N.message;if(N&&typeof N=="object"&&"message"in N){const Q=N.message;return typeof Q=="string"?Q:String(Q)}return String(N)})().includes("Extension context invalidated")?g("Atlas extension was reloaded. Refresh this tab.","danger"):g("Atlas extension error. Refresh this tab.","danger"),re(null)}};y.appendChild(k),(document.body||document.documentElement).appendChild(_),Ke({showToast:g,sendMessageSafe:O,isSheetOpen:()=>!1,chooseDialog:P},{rootId:a,minSize:200,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:b,fetchAtlasStatus:D,atlasStatusCache:x,getCachedAtlasStatus:U}),Ze({root:k,showToast:g,sendMessageSafe:O,isSheetOpen:()=>!1,chooseDialog:P},{rootId:a,minSize:200,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:b,fetchAtlasStatus:D,atlasStatusCache:x,getCachedAtlasStatus:U})}function W(){if(document.getElementById(a))return;const _=document.createElement("div");_.id=a;const y=_.attachShadow({mode:"closed"}),C=document.createElement("link");C.rel="stylesheet",C.href=chrome.runtime.getURL("dist/content.css"),y.appendChild(C);const k=document.createElement("div");k.className="atlas-shadow-root";const g=et(k),P=(e,l)=>{try{chrome.runtime.sendMessage(e,l)}catch(o){(()=>{if(o instanceof Error)return o.message;if(o&&typeof o=="object"&&"message"in o){const u=o.message;return typeof u=="string"?u:String(u)}return String(o)})().includes("Extension context invalidated")?g("Atlas extension was reloaded. Refresh this tab.","danger"):g("Atlas extension error. Refresh this tab.","danger"),l(null)}},O=document.createElement("button");O.className="atlas-downloader-toggle",O.type="button",O.setAttribute("aria-label","Atlas Downloader"),O.title="Atlas Downloader";const z=document.createElement("img");z.alt="",z.src=chrome.runtime.getURL("icon.svg"),O.appendChild(z);const re=document.createElement("div");re.className="atlas-downloader-overlay";const N=document.createElement("div");N.className="atlas-downloader-modal",N.setAttribute("role","dialog"),N.setAttribute("aria-modal","true"),N.setAttribute("aria-label","Atlas Media Picker");const K=document.createElement("div");K.className="atlas-downloader-header";const Q=document.createElement("div");Q.className="atlas-downloader-title",Q.textContent="Atlas Media Picker";const he=document.createElement("div");he.className="atlas-downloader-version",he.textContent=S?`v${S}`:"";const oe=document.createElement("button");oe.type="button",oe.className="atlas-downloader-close",oe.setAttribute("aria-label","Close"),oe.textContent="x",K.appendChild(Q),K.appendChild(he),K.appendChild(oe);const ee=document.createElement("div");ee.className="atlas-downloader-toolbar";const fe=ke("Rescan",()=>at()),i=ke("Check Atlas",()=>ct(!1)),h=ke("Select all",()=>rt(!0)),L=ke("Select none",()=>rt(!1)),F=document.createElement("span");F.className="spacer";const I=ke("Queue selected",()=>Ot(),{primary:!0});ee.appendChild(fe),ee.appendChild(i),ee.appendChild(h),ee.appendChild(L),ee.appendChild(F),ee.appendChild(I);const H=document.createElement("div");H.className="atlas-downloader-meta";const Z=document.createElement("div");Z.className="atlas-downloader-list",N.appendChild(K),N.appendChild(ee),N.appendChild(H),N.appendChild(Z),k.appendChild(O),k.appendChild(re),k.appendChild(N),y.appendChild(k),(document.body||document.documentElement).appendChild(_);const ne=tt(k);let A=[],le=0,te=null,se=null,we=null,_e=null;const pe=new Set,Ne=new Map,Nt=!0;let nt=!1;$=e=>{if(!e||typeof e!="object")return;const l=e,o=Number.isFinite(Number(l.transferId))?Number(l.transferId):null,d=typeof l.status=="string"?l.status:"",u=!!l.downloaded||d==="completed"||typeof l.finished_at=="string",m=!!l.failed||d==="failed"||d==="canceled"||typeof l.failed_at=="string",w=new Set,c=typeof l.original=="string"?j(l.original.trim()):"",v=typeof l.referrer_url=="string"?j(l.referrer_url.trim()):"";c&&w.add(c),v&&w.add(v);const T=o?Ne.get(o)??"":"";if(T&&w.add(T),w.size===0)return;const q=c||T||v||"";o&&q&&!u&&!m&&Ne.set(o,q);let G=!1;for(const R of w){const de=U(R);x.set(R,{exists:!0,downloaded:u,blacklisted:de?!!de.blacklisted:!1,reactionType:de?.reactionType??null,ts:Date.now()})}for(const R of A){const de=ie(R)||j(String(R.url||""));!de||!w.has(de)||!pe.has(de)&&R.status!=="Queued"||(R.atlas={exists:!0,downloaded:u,blacklisted:R.atlas?.blacklisted??!1,file_id:R.atlas?.file_id??null,reaction:R.atlas?.reaction??null},u?(R.status="",R.statusClass="",R.reactionQueued=null,pe.delete(de)):m?(R.status="Failed",R.statusClass="err",R.reactionQueued=null,pe.delete(de)):(R.status="Queued",R.statusClass="queued"),G=!0)}o&&(u||m)&&Ne.delete(o),G&&(J(),V(X()),me(A))},O.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),De()}),re.addEventListener("click",()=>ye()),oe.addEventListener("click",()=>ye()),document.addEventListener("keydown",e=>{const l=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&l==="a"){e.preventDefault(),De();return}if(e.key==="Escape"&&k.classList.contains(r)){ye();return}if(!k.classList.contains(r))return;const o=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!o)return;const d=A.find(u=>u.selected)??A[0]??null;d&&(e.preventDefault(),Re(d,o,{closeOnSuccess:!0}))});function Dt(){k.classList.add(r),at()}function De(){if(k.classList.contains(r)){ye();return}Dt()}function ye(){k.classList.remove(r)}E=De,Ke({showToast:g,sendMessageSafe:P,isSheetOpen:()=>k.classList.contains(r),chooseDialog:ne,setHintShown:e=>{nt=e},getHintShown:()=>nt,enabled:Nt},{rootId:a,minSize:200,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:b,fetchAtlasStatus:D,atlasStatusCache:x,getCachedAtlasStatus:U}),Ze({root:k,showToast:g,sendMessageSafe:P,isSheetOpen:()=>k.classList.contains(r),chooseDialog:ne},{rootId:a,minSize:200,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:b,fetchAtlasStatus:D,atlasStatusCache:x,getCachedAtlasStatus:U}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const l=e,o=!!l.detail?.pending,d=l.detail?.reactionType?String(l.detail.reactionType):null,m=(typeof l.detail?.url=="string"?l.detail.url:"")||l.detail?.media&&be(l.detail.media,200)?.url||"",w=m?j(m):"";if(o){te=w||"__external-reaction__",se=d||se||"like";for(const c of A)w&&(ie(c)||j(String(c.url||"")))!==w||(c.reactionPending=d||c.reactionPending||"like");J(),V(X());return}te=null,se=null;for(const c of A){if(w&&(ie(c)||j(String(c.url||"")))!==w)continue;c.reactionPending&&(c.reactionPending=null);const v=(w?U(w):null)??U(ie(c))??U(j(String(c.url||"")));v?c.atlas={exists:!!v.exists,downloaded:!!v.downloaded,blacklisted:!!v.blacklisted,file_id:c.atlas?.file_id??null,reaction:v.reactionType?{type:v.reactionType}:c.atlas?.reaction??null}:d&&(c.atlas={exists:c.atlas?.exists??!0,downloaded:c.atlas?.downloaded??!1,blacklisted:c.atlas?.blacklisted??!1,file_id:c.atlas?.file_id??null,reaction:{type:d}}),c.atlas?.exists&&!c.atlas?.downloaded&&c.atlas?.reaction?.type&&c.atlas.reaction.type!=="dislike"?c.reactionQueued=c.atlas.reaction.type:c.reactionQueued=null}J(),V(X()),me(A)},!0);const Ae=(e=300)=>{_e!==null&&window.clearTimeout(_e),_e=window.setTimeout(()=>{_e=null,jt()},e)};new MutationObserver(()=>{me(A),Ae(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>Ae(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&Ae(120)},!0),Ae(120);function ke(e,l,o){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${o?.primary?" primary":""}`,d.textContent=e,d.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),l()}),d}function Rt(e){H.textContent=e,I.disabled=!0,fe.disabled=!0,i.disabled=!0,h.disabled=!0,L.disabled=!0}function V(e){H.textContent=e;const l=A.filter(d=>d.selected).length,o=A.some(d=>!!d.reactionPending)||te!==null;I.disabled=l===0||o,fe.disabled=o,i.disabled=A.length===0||o,h.disabled=A.length===0||o,L.disabled=A.length===0||o}function at(){le+=1;const e=le;A=[],we=null,Z.replaceChildren(),Rt("Scanning this page…"),M(l=>{le===e&&(H.textContent=`Scanning… ${l.scanned}/${l.total}`)}).then(l=>{le===e&&(A=l.map(o=>({...o,selected:!0,status:"",statusClass:"",atlas:null,reactionPending:te&&te!=="__external-reaction__"&&(ie(o)||j(String(o.url||"")))===te?se||"like":null,reactionQueued:null})),J(),V(X()),ct(!0))})}function rt(e){for(const l of A)l.selected=e;J(),V(X())}function J(){if(Z.replaceChildren(),A.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",Z.appendChild(e);return}for(const e of A)Z.appendChild(Bt(e))}function Bt(e){const l=document.createElement("div");l.className=`atlas-downloader-item${e.selected?" selected":""}`;const o=document.createElement("input");o.type="checkbox",o.checked=e.selected,o.addEventListener("change",()=>{e.selected=o.checked,l.classList.toggle("selected",e.selected),V(X())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",e.preview_url){const B=document.createElement("img");B.loading="lazy",B.alt="",B.src=e.preview_url,d.appendChild(B)}const u=document.createElement("div");u.className="atlas-downloader-info";const m=document.createElement("div");m.className="atlas-downloader-kind",m.textContent=e.tag_name;const w=document.createElement("div");w.className="atlas-downloader-url",w.textContent=e.url,w.title=e.url;const c=document.createElement("div");c.className="atlas-downloader-sub",c.textContent=Pt(e);const v=document.createElement("div");v.className="atlas-downloader-reactions";const T=e.atlas?.reaction?.type||null,q=!!e.reactionPending||!!e.reactionQueued;for(const B of Ee){const ue=document.createElement("button");ue.type="button",ue.className=`atlas-downloader-reaction-btn ${B.className}${T===B.type?" active":""}${e.reactionPending===B.type?" pending":""}${e.reactionQueued===B.type?" queued":""}`.trim(),ue.setAttribute("aria-label",B.label),ue.title=B.label,ue.replaceChildren(ve(B.pathDs)),ue.disabled=q,ue.addEventListener("click",ft=>{ft.preventDefault(),ft.stopPropagation(),Re(e,B.type)}),v.appendChild(ue)}const G=document.createElement("button");if(G.type="button",G.className=`atlas-downloader-reaction-btn ${Y.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===Y.type?" pending":""}${e.reactionQueued===Y.type?" queued":""}`.trim(),G.setAttribute("aria-label",Y.label),G.title=Y.label,G.replaceChildren(ve(Y.pathDs)),G.disabled=q,G.addEventListener("click",B=>{B.preventDefault(),B.stopPropagation(),Re(e,"dislike",{blacklist:!0})}),v.appendChild(G),e.atlas?.downloaded){const B=document.createElement("button");B.type="button",B.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),B.setAttribute("aria-label","Delete download"),B.title="Delete download",B.replaceChildren(ve(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),B.disabled=q,B.addEventListener("click",ue=>{ue.preventDefault(),ue.stopPropagation(),Wt(e)}),v.appendChild(B)}const R=document.createElement("button");R.type="button",R.className=`atlas-downloader-debug-toggle${we===e.url?" active":""}`,R.textContent=we===e.url?"Hide debug":"Debug",R.addEventListener("click",B=>{B.preventDefault(),B.stopPropagation(),we=we===e.url?null:e.url,J(),V(X())}),v.appendChild(R),u.appendChild(m),u.appendChild(w),u.appendChild(c),u.appendChild(v),we===e.url&&u.appendChild(Ut(e));const de=document.createElement("div"),ut=Ht(e);return de.className=`atlas-downloader-status ${ut.className}`.trim(),de.textContent=ut.text,l.addEventListener("click",B=>{B.target instanceof HTMLInputElement||(e.selected=!e.selected,o.checked=e.selected,l.classList.toggle("selected",e.selected),V(X()))}),l.appendChild(o),l.appendChild(d),l.appendChild(u),l.appendChild(de),l}function ot(e,l){return{type:l,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:f(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:f(e.alt||"",500),preview_url:e.preview_url||"",source:b(e.url),...e.download_via?{download_via:e.download_via}:{}}}function lt(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:f(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:f(e.alt||"",500),preview_url:e.preview_url||"",source:b(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function Ut(e){const l=document.createElement("details");l.className="atlas-downloader-debug",l.open=!0;const o=document.createElement("summary");o.textContent="Debug payload",l.appendChild(o);const d={react:ot(e,e.atlas?.reaction?.type||"like"),download:lt(e)};return l.appendChild(It(d)),l}function It(e,l=0){const o=document.createElement("div");o.className="atlas-downloader-json-tree";const d=Se(e);if(!it(d)){const m=document.createElement("div");return m.className="atlas-downloader-json-line",m.textContent=dt(d),o.appendChild(m),o}const u=Array.isArray(d)?d.map((m,w)=>[String(w),m]):Object.entries(d);for(const[m,w]of u)o.appendChild(st(m,w,l));return o}function st(e,l,o){const d=Se(l),u=document.createElement("div");if(u.className="atlas-downloader-json-line",u.style.paddingLeft=`${o*12}px`,!it(d))return u.innerHTML=`<span class="atlas-downloader-json-key">${Le(e)}</span>: <span class="atlas-downloader-json-value">${Le(dt(d))}</span>`,u;const m=document.createElement("details");m.className="atlas-downloader-json-node",m.open=o===0;const w=document.createElement("summary");w.style.paddingLeft=`${o*12}px`;const c=Array.isArray(d)?`[${d.length}]`:`{${Object.keys(d).length}}`;w.innerHTML=`<span class="atlas-downloader-json-key">${Le(e)}</span>: <span class="atlas-downloader-json-preview">${Le(c)}</span>`,m.appendChild(w);const v=Array.isArray(d)?d.map((T,q)=>[String(q),T]):Object.entries(d);for(const[T,q]of v)m.appendChild(st(T,q,o+1));return m}function Se(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(o=>Se(o));if(!e||typeof e!="object")return null;const l={};for(const[o,d]of Object.entries(e))l[o]=Se(d);return l}function it(e){return Array.isArray(e)||e&&typeof e=="object"}function dt(e){return JSON.stringify(e)}function Le(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Pt(e){const l=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",o=$t(e.url);return o?`${l} • ${o}`:l}function $t(e){try{return new URL(e).hostname}catch{return""}}function X(){const e=A.filter(l=>l.selected).length;return`${A.length} found • ${e} selected`}function ie(e){const l=(e?.url||e?.referrer_url||"").trim();return l?j(l):""}function Ht(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function ct(e){const l=[...new Set(A.map(o=>ie(o)).filter(Boolean))];l.length!==0&&P({type:"atlas-check-batch",urls:l},o=>{if(!o){e||g("Atlas extension did not respond.","danger");return}if(!o.ok){e||g(o.error||"Atlas check failed.","danger");return}const d=Array.isArray(o.data?.results)?o.data.results:[],u=new Map(d.filter(c=>typeof c?.url=="string"&&c.url.trim()!=="").map(c=>[j(String(c.url)),c]));let m=0,w=0;for(const c of A){const v=ie(c),T=u.get(v);T&&(c.atlas={exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,file_id:T.file_id??null,reaction:T.reaction??null},c.atlas.exists&&!c.atlas.downloaded&&c.atlas.reaction?.type&&c.atlas.reaction.type!=="dislike"?(c.reactionQueued=c.atlas.reaction.type,pe.add(v)):(c.reactionQueued=null,pe.delete(v)),x.set(v,{exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,reactionType:T.reaction?.type?String(T.reaction.type):null,ts:Date.now()}),T.exists&&(m+=1),T.downloaded&&(w+=1))}J(),V(X()),me(A),e||g(`Atlas check: ${w}/${m} downloaded.`)})}function Re(e,l,o={}){const d=(m={})=>{e.reactionPending=o.blacklist?Y.type:l,e.status="Reacting…",e.statusClass="",te=ie(e)||e.url,se=e.reactionPending,J(),V(X());const w={...ot(e,l),...m,...o.blacklist?{blacklist:!0}:{}};P({type:"atlas-react",payload:w},c=>{if(e.reactionPending=null,te=null,se=null,!c){e.status="No response",e.statusClass="err",J(),V(X()),g("Atlas extension did not respond.","danger");return}if(!c.ok){e.status=c.error||"Failed",e.statusClass="err",J(),V(X()),g(c.error||"Reaction failed.","danger");return}const v=c.data||null,T=v?.file||null;e.atlas={exists:!!T,downloaded:!!T?.downloaded,blacklisted:!!T?.blacklisted_at,file_id:T?.id??null,reaction:v?.reaction??null};const q=ie(e)||e.url;x.set(q,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&l!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=o.blacklist?Y.type:l,q&&pe.add(q)):(e.status="",e.statusClass="",e.reactionQueued=null,q&&pe.delete(q)),J(),V(X()),me(A),o.closeOnSuccess&&ye()})},u=!!e.atlas?.reaction?.type;if(l!=="dislike"&&e.atlas?.downloaded&&u){ne({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(m=>{if(m==="alternate"){g("Cancelled.");return}d(m==="confirm"?{force_download:!0}:{})});return}if(l==="dislike"&&e.atlas?.downloaded){ne({title:o.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(m=>{if(m==="alternate"){g("Cancelled.");return}d(m==="confirm"?{clear_download:!0}:{})});return}d()}function Wt(e){ne({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(l=>{l==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",te=ie(e)||e.url,se=e.reactionPending,J(),V(X()),P({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},o=>{if(e.reactionPending=null,te=null,se=null,!o||!o.ok){e.status=o?.error||"Failed",e.statusClass="err",J(),V(X()),g(o?.error||"Delete failed.","danger");return}const d=o.data?.file||null;e.atlas={exists:!!d,downloaded:!!d?.downloaded,blacklisted:!!d?.blacklisted_at,file_id:d?.id??null,reaction:null},e.reactionQueued=null;const u=ie(e)||e.url;x.set(u,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",J(),V(X()),me(A),g("Download deleted.")}))})}function Ot(){const e=A.filter(d=>d.selected);if(e.length===0){g("Select one or more items first.");return}if(e.some(d=>!!d.atlas?.downloaded)){ne({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(d=>{if(d==="alternate"){g("Cancelled.");return}o(d==="confirm")});return}o(!1);function o(d){I.disabled=!0,fe.disabled=!0,i.disabled=!0,h.disabled=!0,L.disabled=!0;for(const m of e)m.status="Sending…",m.statusClass="";J();const u=e.map(m=>{const w=lt(m);return d&&(w.force_download=!0),w});P({type:"atlas-download-batch",payloads:u},m=>{if(!m){for(const c of e)c.status="No response",c.statusClass="err";J(),V(X()),g("Atlas extension did not respond.","danger");return}const w=Array.isArray(m.results)?m.results:[];for(let c=0;c<e.length;c+=1){const v=e[c],T=w[c];if(T?.ok){const q=T.data||null,G=q?.file||null;if(v.atlas={exists:!!G,downloaded:!!G?.downloaded,blacklisted:!!G?.blacklisted_at,file_id:G?.id??null,reaction:v.atlas?.reaction??null},q?.queued){v.status="Queued",v.statusClass="queued",v.atlas?.reaction?.type&&v.atlas.reaction.type!=="dislike"&&(v.reactionQueued=v.atlas.reaction.type);const R=ie(v)||j(String(v.url||""));R&&pe.add(R)}else{v.status="",v.statusClass="",v.reactionQueued=null;const R=ie(v)||j(String(v.url||""));R&&pe.delete(R)}}else v.status=T?.error||"Failed",v.statusClass="err"}J(),V(X()),me(A),m.ok?g(`Queued ${e.length} download(s) in Atlas.`):g(m.error||"Some requests failed.","danger")})}}function me(e=A){Mt();const l=document.querySelectorAll('[data-atlas-marked="1"]');for(const u of l)u.removeAttribute("data-atlas-marked"),u.removeAttribute("data-atlas-state"),u.removeAttribute("data-atlas-reaction");const o=new Map;for(const[u,m]of x.entries()){if(Date.now()-m.ts>p){x.delete(u);continue}o.set(u,{exists:!!m.exists,downloaded:!!m.downloaded,blacklisted:!!m.blacklisted,reactionType:m.reactionType?String(m.reactionType):null}),o.set(j(u),{exists:!!m.exists,downloaded:!!m.downloaded,blacklisted:!!m.blacklisted,reactionType:m.reactionType?String(m.reactionType):null})}for(const u of e){if(!u?.url||!u?.atlas)continue;const m=u.atlas?.reaction?.type?String(u.atlas.reaction.type):null,w={exists:!!u.atlas.exists,downloaded:!!u.atlas.downloaded,blacklisted:!!u.atlas.blacklisted,reactionType:m};o.set(u.url,w),o.set(j(u.url),w)}if(o.size===0)return;const d=document.querySelectorAll("img, video, a[href]");for(const u of d){const m=$e(u);if(m.length===0)continue;const w=m.map(c=>o.get(c)||o.get(j(c))).find(c=>!!(c&&(c.exists||c.downloaded||c.blacklisted||c.reactionType)))??null;w&&(u.setAttribute("data-atlas-marked","1"),w.blacklisted?u.setAttribute("data-atlas-state","blacklisted"):w.reactionType?u.setAttribute("data-atlas-state","reacted"):w.downloaded?u.setAttribute("data-atlas-state","downloaded"):w.exists&&u.setAttribute("data-atlas-state","exists"),w.reactionType&&u.setAttribute("data-atlas-reaction",w.reactionType))}}function Ft(){const e=new Set,l=document.querySelectorAll("img, video, a[href]");for(const d of l)for(const u of $e(d))e.add(u),e.add(j(u));const o=Pe();return o?.url&&(e.add(o.url),e.add(j(o.url))),[...e].filter(Boolean)}function jt(){const e=Ft();if(e.length===0){me(A);return}P({type:"atlas-check-batch",urls:e},l=>{if(!l?.ok){me(A);return}const o=Array.isArray(l.data?.results)?l.data.results:[];for(const d of o)d?.url&&x.set(String(d.url),{exists:!!d.exists,downloaded:!!d.downloaded,blacklisted:!!d.blacklisted,reactionType:d.reaction?.type?String(d.reaction.type):null,ts:Date.now()});me(A)})}}function M(_){return new Promise(y=>{const C=document.body||document.documentElement,k=Array.from(C.querySelectorAll("img, video")),g=k.length,P=new Set,O=[];let z=0;const re=K=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(K,{timeout:500});return}setTimeout(()=>K({timeRemaining:()=>25}),0)},N=K=>{const Q=typeof K?.timeRemaining=="function"?K.timeRemaining():25;let he=0;for(;z<g&&(he<80||Q>5);){const ee=k[z];if(ee.closest&&ee.closest(`#${a}`)){z+=1,he+=1;continue}const fe=be(ee,200);fe?.url&&!P.has(fe.url)&&(P.add(fe.url),O.push(fe)),z+=1,he+=1}if(_?.({scanned:z,total:g}),z<g){re(N);return}const oe=Pe();oe&&!P.has(oe.url)&&(P.add(oe.url),O.push(oe)),y(O)};re(N)})}})()})();
