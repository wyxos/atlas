(function(){"use strict";const Ct=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function vt(W){const H=(W||"").trim().toLowerCase();if(!H)return"";const k=H.split(".").filter(Boolean);if(k.length<=2)return H;const I=k.slice(-2).join("."),q=k.slice(-3).join(".");return Ct.has(I)&&k.length>=3?q:I}function _t(W){const H=(W||"").trim();if(!H)return"";try{const k=new URL(H).hostname;return vt(k)}catch{return""}}(()=>{const k="atlas-downloader-root",I="atlas-open",q=(()=>{try{return window.top===window.self}catch{return!1}})(),rt=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let st=null;const ot="http://www.w3.org/2000/svg",kt=e=>{const n=document.createElementNS(ot,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18"),n.setAttribute("style","color: #e2e8f0; stroke: currentColor; fill: none;");for(const s of e){const a=document.createElementNS(ot,"path");a.setAttribute("d",s),a.setAttribute("fill","none"),a.setAttribute("stroke","currentColor"),a.setAttribute("stroke-width","2"),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round"),n.appendChild(a)}return n},St=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}];function R(e,n){const s=typeof e=="string"?e:"";return s.length<=n?s:s.slice(0,n)}function j(e){return _t(e)||"Extension"}chrome.runtime.onMessage.addListener(e=>{if(!(!e||typeof e!="object"||e.type!=="atlas-open-sheet")&&q)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],s=>{const a=tt(s.atlasBaseUrl||"");if(a&&et(window.location.hostname,a))return;const o=ct(s.atlasExcludedDomains||"");dt(window.location.hostname,o)||(lt(),st?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],e=>{const n=tt(e.atlasBaseUrl||"");if(n&&et(window.location.hostname,n))return;const s=ct(e.atlasExcludedDomains||"");dt(window.location.hostname,s)||(q?lt():Nt())});function Nt(){if(document.getElementById(k))return;const e=document.createElement("div");e.id=k;const n=e.attachShadow({mode:"closed"}),s=document.createElement("link");s.rel="stylesheet",s.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(s);const a=document.createElement("div");a.className="atlas-shadow-root";const o=it(a),y=(i,b)=>{try{chrome.runtime.sendMessage(i,b)}catch(c){(()=>{if(c instanceof Error)return c.message;if(c&&typeof c=="object"&&"message"in c){const f=c.message;return typeof f=="string"?f:String(f)}return String(c)})().includes("Extension context invalidated")?o("Atlas extension was reloaded. Refresh this tab."):o("Atlas extension error. Refresh this tab."),b(null)}};n.appendChild(a),(document.body||document.documentElement).appendChild(e),ut({showToast:o,sendMessageSafe:y,isSheetOpen:()=>!1})}function lt(){if(document.getElementById(k))return;const e=document.createElement("div");e.id=k;const n=e.attachShadow({mode:"closed"}),s=document.createElement("link");s.rel="stylesheet",s.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(s);const a=document.createElement("div");a.className="atlas-shadow-root";const o=it(a),y=(t,l)=>{try{chrome.runtime.sendMessage(t,l)}catch(r){(()=>{if(r instanceof Error)return r.message;if(r&&typeof r=="object"&&"message"in r){const d=r.message;return typeof d=="string"?d:String(d)}return String(r)})().includes("Extension context invalidated")?o("Atlas extension was reloaded. Refresh this tab."):o("Atlas extension error. Refresh this tab."),l(null)}},i=document.createElement("button");i.className="atlas-downloader-toggle",i.type="button",i.setAttribute("aria-label","Atlas Downloader"),i.title="Atlas Downloader";const b=document.createElement("img");b.alt="",b.src=chrome.runtime.getURL("icon.svg"),i.appendChild(b);const c=document.createElement("div");c.className="atlas-downloader-overlay";const u=document.createElement("div");u.className="atlas-downloader-modal",u.setAttribute("role","dialog"),u.setAttribute("aria-modal","true"),u.setAttribute("aria-label","Atlas Media Picker");const f=document.createElement("div");f.className="atlas-downloader-header";const E=document.createElement("div");E.className="atlas-downloader-title",E.textContent="Atlas Media Picker";const A=document.createElement("div");A.className="atlas-downloader-version",A.textContent=rt?`v${rt}`:"";const T=document.createElement("button");T.type="button",T.className="atlas-downloader-close",T.setAttribute("aria-label","Close"),T.textContent="x",f.appendChild(E),f.appendChild(A),f.appendChild(T);const C=document.createElement("div");C.className="atlas-downloader-toolbar";const V=$("Rescan",()=>pt()),X=$("Check Atlas",()=>bt(!1));let M=!1,L=null;const F=$("Debug: off",()=>{M=!M,F.textContent=M?"Debug: on":"Debug: off",M?!L&&g.length>0&&(L={url:g[0].url,reactionType:"like"}):L=null,S(),N(x())}),z=$("Select all",()=>gt(!0)),Z=$("Select none",()=>gt(!1)),ft=document.createElement("span");ft.className="spacer";const Q=$("Queue selected",()=>qt(),{primary:!0});C.appendChild(V),C.appendChild(X),C.appendChild(F),C.appendChild(z),C.appendChild(Z),C.appendChild(ft),C.appendChild(Q);const B=document.createElement("div");B.className="atlas-downloader-meta";const P=document.createElement("div");P.className="atlas-downloader-list",u.appendChild(f),u.appendChild(C),u.appendChild(B),u.appendChild(P),a.appendChild(i),a.appendChild(c),a.appendChild(u),n.appendChild(a),(document.body||document.documentElement).appendChild(e);let g=[],K=0;const Ut=!0;let ht=!1;i.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),mt()}),c.addEventListener("click",()=>nt()),T.addEventListener("click",()=>nt()),document.addEventListener("keydown",t=>{t.key==="Escape"&&a.classList.contains(I)&&nt()});function mt(){a.classList.add(I),pt()}function nt(){a.classList.remove(I)}st=mt,ut({showToast:o,sendMessageSafe:y,isSheetOpen:()=>a.classList.contains(I),setHintShown:t=>{ht=t},getHintShown:()=>ht,enabled:Ut});function $(t,l,r){const h=document.createElement("button");return h.type="button",h.className=`atlas-downloader-btn${r?.primary?" primary":""}`,h.textContent=t,h.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),l()}),h}function Ht(t){B.textContent=t,Q.disabled=!0,V.disabled=!0,X.disabled=!0,F.disabled=!0,z.disabled=!0,Z.disabled=!0}function N(t){B.textContent=t;const l=g.filter(r=>r.selected).length;Q.disabled=l===0,V.disabled=!1,X.disabled=g.length===0,F.disabled=g.length===0,z.disabled=g.length===0,Z.disabled=g.length===0}function pt(){K+=1;const t=K;g=[],M&&(L=null),P.replaceChildren(),Ht("Scanning this page…"),xt(l=>{K===t&&(B.textContent=`Scanning… ${l.scanned}/${l.total}`)}).then(l=>{K===t&&(g=l.map(r=>({...r,selected:!0,status:"",statusClass:"",atlas:null})),M&&!L&&g.length>0&&(L={url:g[0].url,reactionType:"like"}),S(),N(x()),bt(!0))})}function gt(t){for(const l of g)l.selected=t;S(),N(x())}function S(){if(P.replaceChildren(),g.length===0){const t=document.createElement("div");t.style.padding="10px 12px",t.style.color="#94a3b8",t.style.fontSize="12px",t.textContent="No matching images/videos found.",P.appendChild(t);return}for(const t of g)P.appendChild(It(t))}function It(t){const l=document.createElement("div");l.className=`atlas-downloader-item${t.selected?" selected":""}`;const r=document.createElement("input");r.type="checkbox",r.checked=t.selected,r.addEventListener("change",()=>{t.selected=r.checked,l.classList.toggle("selected",t.selected),N(x())});const h=document.createElement("div");if(h.className="atlas-downloader-preview",t.preview_url){const _=document.createElement("img");_.loading="lazy",_.alt="",_.src=t.preview_url,h.appendChild(_)}const d=document.createElement("div");d.className="atlas-downloader-info";const p=document.createElement("div");p.className="atlas-downloader-kind",p.textContent=t.tag_name;const m=document.createElement("div");m.className="atlas-downloader-url",m.textContent=t.url,m.title=t.url;const w=document.createElement("div");w.className="atlas-downloader-sub",w.textContent=$t(t);const v=document.createElement("div");v.className="atlas-downloader-reactions";const O=t.atlas?.reaction?.type||null;for(const _ of St){const D=document.createElement("button");D.type="button",D.className=`atlas-downloader-reaction-btn ${_.className}${O===_.type?" active":""}${t.reactionPending?" pending":""}`.trim(),D.setAttribute("aria-label",_.label),D.title=_.label,D.replaceChildren(kt(_.pathDs)),D.disabled=!!t.reactionPending,D.addEventListener("click",At=>{At.preventDefault(),At.stopPropagation(),M&&(L={url:t.url,reactionType:_.type},S()),Wt(t,_.type)}),v.appendChild(D)}d.appendChild(p),d.appendChild(m),d.appendChild(w),d.appendChild(v),M&&L?.url===t.url&&d.appendChild(Pt(t,L.reactionType));const at=document.createElement("div"),Et=Ot(t);return at.className=`atlas-downloader-status ${Et.className}`.trim(),at.textContent=Et.text,l.addEventListener("click",_=>{_.target instanceof HTMLInputElement||(M&&(L={url:t.url,reactionType:L?.reactionType??"like"}),t.selected=!t.selected,r.checked=t.selected,l.classList.toggle("selected",t.selected),N(x()))}),l.appendChild(r),l.appendChild(h),l.appendChild(d),l.appendChild(at),l}function wt(t,l){return{type:l,url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:R(document.title,500),tag_name:t.tag_name,width:t.width,height:t.height,alt:R(t.alt||"",500),preview_url:t.preview_url||"",source:j(t.url)}}function yt(t){return{url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:R(document.title,500),tag_name:t.tag_name,width:t.width,height:t.height,alt:R(t.alt||"",500),preview_url:t.preview_url||"",source:j(t.url),reaction_type:"like"}}function Pt(t,l){const r=document.createElement("details");r.className="atlas-downloader-debug",r.open=!0;const h=document.createElement("summary");h.textContent="Debug payload",r.appendChild(h);const d=document.createElement("pre");return d.textContent=JSON.stringify({react:wt(t,l),download:yt(t)},null,2),r.appendChild(d),r}function $t(t){const l=t.width&&t.height?`${t.width}×${t.height}`:"size unknown",r=Bt(t.url);return r?`${l} • ${r}`:l}function Bt(t){try{return new URL(t).hostname}catch{return""}}function x(){const t=g.filter(l=>l.selected).length;return`${g.length} found • ${t} selected`}function Ot(t){return t.status?{text:t.status,className:t.statusClass||""}:t.atlas?.downloaded?{text:"Downloaded",className:"ok"}:t.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function bt(t){const l=g.map(r=>r.url).filter(Boolean);l.length!==0&&y({type:"atlas-check-batch",urls:l},r=>{if(!r){t||o("Atlas extension did not respond.");return}if(!r.ok){t||o(r.error||"Atlas check failed.");return}const h=Array.isArray(r.data?.results)?r.data.results:[],d=new Map(h.map(w=>[w.url,w]));let p=0,m=0;for(const w of g){const v=d.get(w.url);v&&(w.atlas={exists:!!v.exists,downloaded:!!v.downloaded,file_id:v.file_id??null,reaction:v.reaction??null},v.exists&&(p+=1),v.downloaded&&(m+=1))}S(),N(x()),t||o(`Atlas check: ${m}/${p} downloaded.`)})}function Wt(t,l){t.reactionPending=l,t.status="Reacting…",t.statusClass="",S();const r=wt(t,l);y({type:"atlas-react",payload:r},h=>{if(t.reactionPending=null,!h){t.status="No response",t.statusClass="err",S(),N(x()),o("Atlas extension did not respond.");return}if(!h.ok){t.status=h.error||"Failed",t.statusClass="err",S(),N(x()),o(h.error||"Reaction failed.");return}const d=h.data||null,p=d?.file||null;t.atlas={exists:!!p,downloaded:!!p?.downloaded,file_id:p?.id??null,reaction:d?.reaction??null},t.atlas.exists&&!t.atlas.downloaded&&l!=="dislike"?(t.status="Queued",t.statusClass="queued"):(t.status="",t.statusClass=""),S(),N(x()),t.atlas.exists&&!t.atlas.downloaded&&l!=="dislike"&&J([t.url],0)})}function qt(){const t=g.filter(r=>r.selected);if(t.length===0){o("Select one or more items first.");return}Q.disabled=!0,V.disabled=!0,X.disabled=!0,z.disabled=!0,Z.disabled=!0;for(const r of t)r.status="Sending…",r.statusClass="";S();const l=t.map(r=>yt(r));y({type:"atlas-download-batch",payloads:l},r=>{if(!r){for(const p of t)p.status="No response",p.statusClass="err";S(),N(x()),o("Atlas extension did not respond.");return}const h=Array.isArray(r.results)?r.results:[],d=[];for(let p=0;p<t.length;p+=1){const m=t[p],w=h[p];if(w?.ok){const v=w.data||null,O=v?.file||null;m.atlas={exists:!!O,downloaded:!!O?.downloaded,file_id:O?.id??null},v?.queued?(m.status="Queued",m.statusClass="queued",d.push(m.url)):(m.status="",m.statusClass="")}else m.status=w?.error||"Failed",m.statusClass="err"}S(),N(x()),r.ok?o(`Queued ${t.length} download(s) in Atlas.`):o(r.error||"Some requests failed."),d.length>0&&J(d,0)})}function J(t,l){l>15||setTimeout(()=>{y({type:"atlas-check-batch",urls:t},r=>{if(!r||!r.ok){J(t,l+1);return}const h=Array.isArray(r.data?.results)?r.data.results:[],d=new Map(h.map(m=>[m.url,m]));let p=0;for(const m of g){const w=d.get(m.url);w&&(m.atlas={exists:!!w.exists,downloaded:!!w.downloaded,file_id:w.file_id??null,reaction:w.reaction??null},w.downloaded?m.status==="Queued"&&(m.status="",m.statusClass=""):p+=1)}S(),N(x()),p>0&&J(t,l+1)})},2e3)}}function xt(e){return new Promise(n=>{const s=document.body||document.documentElement,a=Array.from(s.querySelectorAll("img, video")),o=a.length,y=new Set,i=[];let b=0;const c=f=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(f,{timeout:500});return}setTimeout(()=>f({timeRemaining:()=>25}),0)},u=f=>{const E=typeof f?.timeRemaining=="function"?f.timeRemaining():25;let A=0;for(;b<o&&(A<80||E>5);){const T=a[b];if(T.closest&&T.closest(`#${k}`)){b+=1,A+=1;continue}const C=G(T);C?.url&&!y.has(C.url)&&(y.add(C.url),i.push(C)),b+=1,A+=1}if(e?.({scanned:b,total:o}),b<o){c(u);return}n(i)};c(u)})}function G(e){if(!(e instanceof Element))return null;if(e.tagName==="IMG"){const n=e,s=n.naturalWidth||n.width||n.clientWidth||null,a=n.naturalHeight||n.height||n.clientHeight||null;if(s&&a&&(s<450||a<450))return null;const o=U(n.currentSrc)||U(n.src)||U(n.getAttribute("src"));return o?{tag_name:"img",url:o,preview_url:o,width:s,height:a,alt:n.alt||""}:null}if(e.tagName==="VIDEO"){const n=Lt(e);return n?{tag_name:"video",url:n,preview_url:e.poster||"",width:e.videoWidth||e.clientWidth||null,height:e.videoHeight||e.clientHeight||null,alt:""}:null}return null}function Lt(e){const n=U(e.currentSrc)||U(e.src)||U(e.getAttribute("src"));if(n)return n;const s=e.querySelector("source[src]"),a=s?U(s.src||s.getAttribute("src")):"";if(a)return a;const o=Mt(e);return o||Tt()}function Tt(){const e=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const n of e){const a=document.querySelector(n)?.getAttribute("content"),o=U(a||"");if(o)return o}return""}function Mt(e){let n=e,s=0;for(;n&&s<8;){const a=n.getAttribute?.("data-store");if(a){const o=Dt(a),y=Y(o,0);if(y)return y}n=n.parentElement,s+=1}return""}function Dt(e){if(!e)return null;const n=Rt(e);try{return JSON.parse(n)}catch{return null}}function Rt(e){return!e||typeof e!="string"?"":e.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Y(e,n){if(!e||n>4)return"";if(typeof e=="string")return e.startsWith("http")?e:"";if(Array.isArray(e)){for(const a of e){const o=Y(a,n+1);if(o)return o}return""}if(typeof e!="object")return"";const s=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const a of s){const o=e[a];if(typeof o=="string"&&o.startsWith("http"))return o}for(const a of Object.keys(e)){const o=Y(e[a],n+1);if(o)return o}return""}function it(e){return function(s){const a=document.createElement("div");a.className="atlas-downloader-toast",a.textContent=s,e.appendChild(a),requestAnimationFrame(()=>a.classList.add("show")),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove(),{once:!0})},2600)}}function ct(e){return!e||typeof e!="string"?[]:e.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>tt(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function dt(e,n){const s=(e||"").toLowerCase();if(!s)return!1;for(const a of n)if(et(s,a))return!0;return!1}function tt(e){if(!e||typeof e!="string")return"";const n=e.trim();if(!n)return"";const s=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(s).hostname}catch{return""}}function et(e,n){return!e||!n?!1:e===n||e.endsWith(`.${n}`)}function U(e){if(!e||typeof e!="string")return"";const n=e.trim();if(!n)return"";const s=n.toLowerCase();return s.startsWith("blob:")||s.startsWith("data:")||s.startsWith("chrome-extension:")||s.startsWith("moz-extension:")||s.startsWith("safari-extension:")?"":n}function ut(e){const n=e.enabled??!0,s=e.getHintShown??(()=>!1),a=e.setHintShown??(()=>{}),o=()=>{s()||(a(!0),e.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},y=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(c=>c instanceof HTMLElement&&c.id===k);document.addEventListener("click",i=>{!n||!(i instanceof MouseEvent)||!i.altKey||e.isSheetOpen()||y(i)||!((i.target instanceof Element?i.target:null)?.closest?.("img, video")??null)||(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation())},!0),document.addEventListener("mousedown",i=>{if(!n||!(i instanceof MouseEvent)||!i.altKey||e.isSheetOpen()||y(i))return;const c=(i.target instanceof Element?i.target:null)?.closest?.("img, video")??null;if(!c)return;const u=i.button===0?"like":i.button===1?"love":null;if(!u)return;o(),i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();const f=G(c);if(!f){if(c instanceof HTMLVideoElement){const A=(c.currentSrc||c.src||"").trim().toLowerCase();A.startsWith("blob:")||A.startsWith("data:")?e.showToast("Streaming video (blob). No direct URL to download."):e.showToast("No direct video URL found.")}else e.showToast("No valid media URL found.");return}const E={type:u,url:f.url,original_url:f.url,referrer_url:window.location.href,page_title:R(document.title,500),tag_name:f.tag_name,width:f.width,height:f.height,alt:R(f.alt||"",500),preview_url:f.preview_url||"",source:j(f.url)};e.sendMessageSafe({type:"atlas-react",payload:E},A=>{if(!A||!A.ok){e.showToast(A?.error||"Reaction failed.");return}e.showToast(`Reacted (${u}). Queued download in Atlas.`)})},!0),document.addEventListener("contextmenu",i=>{if(!n||!(i instanceof MouseEvent)||!i.altKey||e.isSheetOpen()||y(i))return;const c=(i.target instanceof Element?i.target:null)?.closest?.("img, video")??null;if(!c)return;o(),i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();const u=G(c);if(!u){if(c instanceof HTMLVideoElement){const E=(c.currentSrc||c.src||"").trim().toLowerCase();E.startsWith("blob:")||E.startsWith("data:")?e.showToast("Streaming video (blob). No direct URL to download."):e.showToast("No direct video URL found.")}else e.showToast("No valid media URL found.");return}const f={type:"dislike",url:u.url,original_url:u.url,referrer_url:window.location.href,page_title:R(document.title,500),tag_name:u.tag_name,width:u.width,height:u.height,alt:R(u.alt||"",500),preview_url:u.preview_url||"",source:j(u.url)};e.sendMessageSafe({type:"atlas-react",payload:f},E=>{if(!E||!E.ok){e.showToast(E?.error||"Reaction failed.");return}e.showToast("Disliked.")})},!0)}})()})();
