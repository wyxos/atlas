(function(){"use strict";const yt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function kt(t){const e=(t||"").trim().toLowerCase();if(!e)return"";const a=e.split(".").filter(Boolean);if(a.length<=2)return e;const r=a.slice(-2).join("."),o=a.slice(-3).join(".");return yt.has(r)&&a.length>=3?o:r}function vt(t){const e=(t||"").trim();if(!e)return"";try{const a=new URL(e).hostname;return kt(a)}catch{return""}}function Et(t,e){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const r=a.toLowerCase();if(r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:"))return"";try{const o=new URL(a,e);return o.protocol!=="http:"&&o.protocol!=="https:"?"":o.toString()}catch{return""}}function Ee(t){let e=t,a=0;for(;e&&a<24;){const r=e.getAttribute?.("role");if(r==="dialog"||r==="alertdialog"||e.getAttribute?.("aria-modal")==="true")return!0;const h=(e.getAttribute?.("class")||"").toLowerCase(),d=(e.getAttribute?.("id")||"").toLowerCase(),b=`${h} ${d}`.trim();if(b&&/(modal|lightbox|overlay|dialog)/.test(b))return!0;const S=window.getComputedStyle(e);if((S.position==="fixed"||S.position==="sticky")&&At(e))return!0;e=e.parentElement,a+=1}return!1}function At(t){const e=t.getBoundingClientRect();if(e.width>0&&e.height>0){const a=Math.max(window.innerWidth*.4,320),r=Math.max(window.innerHeight*.4,240);return e.width>=a&&e.height>=r}if(t instanceof HTMLElement){const a=t.style,r=a.inset==="0"||a.inset==="0px"||(a.top==="0"||a.top==="0px")&&(a.left==="0"||a.left==="0px")&&(a.right==="0"||a.right==="0px")&&(a.bottom==="0"||a.bottom==="0px"),o=/^(100vw|100%)$/i.test(a.width||"")||/^(100vh|100%)$/i.test(a.height||"");return r||o}return!1}const Lt=Qe(["host:st.deviantart.net","url:*wixmp.com*/crop/w_92,h_92*","url:*wixmp.com*/crop/w_150,h_150*","url:*wixmp.com*/fit/w_150,h_150*"].join(`
`));let Pe=[];function oe(t){return Et(t,window.location.href)}function He(t){Pe=Qe(t)}function Ue(t){const e=oe(t.currentSrc)||oe(t.src)||oe(t.getAttribute("src")||"");if(e)return e;const a=t.querySelector("source[src]"),r=a?oe(a.src||a.getAttribute("src")||""):"";if(r)return r;const o=Ct(t);return o||_t()}function ye(t,e){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,r=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),o=oe(r);if(o&&Te(o))return null;const{width:h,height:d}=Tt(a,o||r),b=h??he(a.clientWidth),S=d??he(a.clientHeight);if(b&&b<e||S&&S<e)return null;if(!o){const c=oe(document.referrer)||oe(window.location.href)||"";return!c||!r.toLowerCase().startsWith("blob:")&&!r.toLowerCase().startsWith("data:")||Te(c)?null:{tag_name:"img",url:c,referrer_url:window.location.href,preview_url:"",width:h,height:d,alt:a.alt||""}}return{tag_name:"img",url:o,referrer_url:window.location.href,preview_url:o,width:h,height:d,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=t,r=a.videoWidth||a.clientWidth||null,o=a.videoHeight||a.clientHeight||null;if(r&&o&&(r<e||o<e))return null;const h=Ue(a);if(h&&Te(h))return null;if(!h){const d=(a.currentSrc||a.src||"").trim().toLowerCase();if(d.startsWith("blob:")||d.startsWith("data:")){const b=window.location.href;return{tag_name:"video",url:b,referrer_url:b,preview_url:a.poster||"",width:r,height:o,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:h,referrer_url:window.location.href,preview_url:a.poster||"",width:r,height:o,alt:""}}return null}function $e(){const t=(window.location.href||"").trim();if(!t)return null;const e=t.toLowerCase(),a=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(e),r=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!a&&!r)return null;if(e.startsWith("http://")||e.startsWith("https://"))return{tag_name:e.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(e.startsWith("blob:")||e.startsWith("data:")){const o=oe(document.referrer)||"";return o?{tag_name:"img",url:o,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function We(t){const e=new Set,a=oe(window.location.href),r=t instanceof HTMLImageElement?oe(t.currentSrc)||oe(t.src)||"":t instanceof HTMLVideoElement?Ue(t)||"":t instanceof HTMLAnchorElement&&Oe(t.getAttribute("href")||"")||"";r&&e.add(r);const o=t.closest("a[href]")?.getAttribute("href")??"",h=Oe(o);return h&&e.add(h),a&&St(t)&&e.add(a),[...e]}function Oe(t){const e=(t||"").trim();return!e||e.startsWith("#")||e.toLowerCase().startsWith("javascript:")?"":oe(e)}function St(t){if(t instanceof HTMLImageElement){const e=(t.currentSrc||t.src||t.getAttribute("src")||"").trim().toLowerCase();return e.startsWith("blob:")||e.startsWith("data:")}if(t instanceof HTMLVideoElement){const e=(t.currentSrc||t.src||"").trim().toLowerCase();return e.startsWith("blob:")||e.startsWith("data:")}return!1}function _t(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const e of t){const r=document.querySelector(e)?.getAttribute("content")||"",o=oe(r);if(o)return o}return""}function Ct(t){let e=t,a=0;for(;e&&a<8;){const r=e.getAttribute?.("data-store");if(r){const o=xt(r),h=Me(o,0);if(h)return h}e=e.parentElement,a+=1}return""}function xt(t){if(!t)return null;const e=Mt(t);try{return JSON.parse(e)}catch{return null}}function Mt(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Me(t,e){if(!t||e>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const a of t){const r=Me(a,e+1);if(r)return r}return""}if(typeof t=="object")for(const a of Object.keys(t)){const r=t[a],o=Me(r,e+1);if(o)return o}return""}function Tt(t,e){const a=he(t.naturalWidth),r=he(t.naturalHeight),o=he(t.clientWidth),h=he(t.clientHeight),d=Nt(e),b=je(t.getAttribute("width")),S=je(t.getAttribute("height"));return{width:qe(a,o,d.width,b),height:qe(r,h,d.height,S)}}function Nt(t){const e=(t||"").trim();if(!e)return{width:null,height:null};const a=Fe(e,[/(?:^|[/,?&_=-])w_(\d{2,5})(?=$|[/,?&_=-])/i]),r=Fe(e,[/(?:^|[/,?&_=-])h_(\d{2,5})(?=$|[/,?&_=-])/i]);let o=a;const h=r,d=e.match(/-(\d{2,5})w-(\d)x(?=$|[./?&_-])/i);if(d){const b=parseInt(d[1],10),S=parseInt(d[2],10),c=he(b*S);c&&(!o||c>o)&&(o=c)}return{width:o??null,height:h??null}}function Fe(t,e){for(const a of e){const r=t.match(a);if(!r||!r[1])continue;const o=he(parseInt(r[1],10));if(o)return o}return null}function je(t){if(!t)return null;const e=t.trim();if(!e)return null;const a=e.match(/^\d+/)?.[0]??"";return a?he(parseInt(a,10)):null}function qe(t,e,a,r){return t||e||a||r}function he(t){if(typeof t!="number"||!Number.isFinite(t))return null;const e=Math.round(t);return e>0?e:null}function Te(t){const e=(t||"").trim().toLowerCase();if(!e)return!1;const a=[...Lt,...Pe],r=Dt(e);for(const o of a){if(o.kind==="host"){if(Bt(r,o.host))return!0;continue}if(o.kind==="urlPattern"){if(o.regex.test(e))return!0;continue}if(e.includes(o.needle))return!0}return!1}function Dt(t){try{return new URL(t).hostname.toLowerCase()}catch{return""}}function Bt(t,e){const a=(t||"").trim().toLowerCase(),r=(e||"").trim().toLowerCase();return!a||!r?!1:a===r||a.endsWith(`.${r}`)}function Qe(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e!==""&&!e.startsWith("#")).map(e=>Rt(e)).filter(e=>e!==null)}function Rt(t){const e=t.trim();if(!e)return null;const a=e.toLowerCase();if(a.startsWith("host:")){const o=Ve(e.slice(5));return o?{kind:"host",host:o}:null}if(a.startsWith("url:"))return ze(e.slice(4));const r=Ve(e);return r?{kind:"host",host:r}:ze(e)}function ze(t){const e=t.trim().toLowerCase();if(!e)return null;if(!e.includes("*"))return{kind:"urlContains",needle:e};const a=It(e);try{return{kind:"urlPattern",regex:new RegExp(a,"i")}}catch{return null}}function It(t){return t.split("*").map(e=>Pt(e)).join(".*")}function Pt(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ve(t){const e=(t||"").trim();if(!e)return"";const a=e.startsWith("*.")?e.slice(2):e,r=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(r).hostname.toLowerCase()}catch{return""}}const Ke="http://www.w3.org/2000/svg",Ae=t=>{const e=document.createElementNS(Ke,"svg");e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("aria-hidden","true"),e.setAttribute("fill","none"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-linecap","round"),e.setAttribute("stroke-linejoin","round"),e.setAttribute("width","18"),e.setAttribute("height","18");for(const a of t){const r=document.createElementNS(Ke,"path");r.setAttribute("d",a),r.setAttribute("fill","none"),r.setAttribute("stroke","currentColor"),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round"),e.appendChild(r)}return e},Le=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],Y={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Xe="atlas-location-change";function Se(t,e){return!!t.closest?.(`#${e}`)}function Ht(t,e,a){const r=t.querySelectorAll?.("img, video");if(!r||r.length===0)return null;let o=null;for(const h of r){const d=h.getBoundingClientRect();if(d.width<=0||d.height<=0||e<d.left||e>d.right||a<d.top||a>d.bottom)continue;const b=d.width*d.height;(!o||b>o.area)&&(o={media:h,area:b})}return o}function Ze(t,e){return t?t.inModal!==e.inModal?e.inModal?e:t:e.area!==t.area?e.area>t.area?e:t:e.stackIndex<t.stackIndex?e:t:e}function Je(t,e,a){const o=(document.elementsFromPoint?.(t,e)??[]).filter(d=>d instanceof Element);if(o.length===0){const d=document.elementFromPoint?.(t,e);d instanceof Element&&o.push(d)}let h=null;for(const[d,b]of o.entries())if(!Se(b,a)&&b.matches("img, video")){const S=b.getBoundingClientRect();h=Ze(h,{media:b,area:Math.max(S.width*S.height,1),stackIndex:d,inModal:Ee(b)})}for(const[d,b]of o.entries()){if(Se(b,a))continue;const S=Ht(b,t,e);S&&(h=Ze(h,{media:S.media,area:S.area,stackIndex:d,inModal:Ee(S.media)}))}return h?h.media:null}function Ye(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return 0;const a=Math.max(e.left,0),r=Math.max(e.top,0),o=Math.min(e.right,window.innerWidth),h=Math.min(e.bottom,window.innerHeight),d=o-a,b=h-r;return d<=0||b<=0?0:d*b}function Ut(t,e){const a=Array.from(document.querySelectorAll("img, video")).filter(b=>!Se(b,e));if(a.length===0)return null;const r=t?Ye(t):0,o=t?Ee(t):!1;let h=null,d=null;for(const b of a){const S=Ye(b);S<=0||((!d||S>d.area)&&(d={media:b,area:S}),Ee(b)&&(!h||S>h.area)&&(h={media:b,area:S}))}return h&&h.media!==t&&(!o||h.area>r*1.1)?h.media:d&&d.media!==t&&d.area>r*1.6?d.media:null}function Ge(t,e){const a=t.enabled??!0,r=t.getHintShown??(()=>!1),o=t.setHintShown??(()=>{}),h=()=>{r()||(o(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},d=(c,p,y,N=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:c,pending:p,reactionType:y,url:N}}))},b=c=>(typeof c.composedPath=="function"?c.composedPath():[]).some(y=>y instanceof HTMLElement&&y.id===e.rootId),S=c=>{const y=(c.target instanceof Element?c.target:null)?.closest?.("img, video")??null;if(y instanceof Element&&!Se(y,e.rootId))return y;const N=Je(c.clientX,c.clientY,e.rootId);return N||null};document.addEventListener("click",c=>{!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||b(c)||!S(c)||(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())},!0),document.addEventListener("mousedown",c=>{if(!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||b(c))return;const p=S(c);if(!p)return;const y=c.button===0?"like":c.button===1?"love":null;if(!y)return;h(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const N=ye(p,e.minSize);if(!N){if(p instanceof HTMLVideoElement){const le=(p.currentSrc||p.src||"").trim().toLowerCase();if(le.startsWith("blob:")||le.startsWith("data:")){const U=window.location.href,B={type:y,url:U,referrer_url:U,page_title:e.limitString(document.title,e.maxMetadataLen),tag_name:"video",width:p.videoWidth||p.clientWidth||null,height:p.videoHeight||p.clientHeight||null,alt:"",preview_url:p.poster||"",source:e.sourceFromMediaUrl(U),download_via:"yt-dlp"};e.fetchAtlasStatus(t.sendMessageSafe,B.url,B.referrer_url||null,C=>{if(C?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(_=>{if(_==="alternate"){t.showToast("Cancelled.");return}d(p,!0,y,B.url),_==="confirm"&&(B.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:B},x=>{if(!x||!x.ok){d(p,!1,null,B.url),t.showToast(x?.error||"Reaction failed.","danger");return}const v=x.data||null,E=v?.file||null,H=v?.reaction?.type?String(v.reaction.type):y;e.atlasStatusCache.set(B.url,{exists:!!E,downloaded:!!E?.downloaded,blacklisted:!!E?.blacklisted_at,reactionType:H,ts:Date.now()}),d(p,!1,H,B.url),t.showToast(`Reacted (${y}). Resolving video in Atlas…`)})});return}d(p,!0,y,B.url),t.sendMessageSafe({type:"atlas-react",payload:B},_=>{if(!_||!_.ok){d(p,!1,null,B.url),t.showToast(_?.error||"Reaction failed.","danger");return}const x=_.data||null,v=x?.file||null,E=x?.reaction?.type?String(x.reaction.type):y;e.atlasStatusCache.set(B.url,{exists:!!v,downloaded:!!v?.downloaded,blacklisted:!!v?.blacklisted_at,reactionType:E,ts:Date.now()}),d(p,!1,E,B.url),t.showToast(`Reacted (${y}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const P={type:y,url:N.url,referrer_url:N.referrer_url||window.location.href,page_title:e.limitString(document.title,e.maxMetadataLen),tag_name:N.tag_name,width:N.width,height:N.height,alt:e.limitString(N.alt||"",e.maxMetadataLen),preview_url:N.preview_url||"",source:e.sourceFromMediaUrl(N.url)};e.fetchAtlasStatus(t.sendMessageSafe,P.url,P.referrer_url||null,le=>{if(le?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(U=>{if(U==="alternate"){t.showToast("Cancelled.");return}d(p,!0,y,P.url),U==="confirm"&&(P.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:P},B=>{if(!B||!B.ok){d(p,!1,null,P.url),t.showToast(B?.error||"Reaction failed.","danger");return}const C=B.data||null,_=C?.file||null,x=C?.reaction?.type?String(C.reaction.type):y;e.atlasStatusCache.set(P.url,{exists:!!_,downloaded:!!_?.downloaded,blacklisted:!!_?.blacklisted_at,reactionType:x,ts:Date.now()}),d(p,!1,x,P.url),t.showToast(`Reacted (${y}). Queued download in Atlas.`)})});return}d(p,!0,y,P.url),t.sendMessageSafe({type:"atlas-react",payload:P},U=>{if(!U||!U.ok){d(p,!1,null,P.url),t.showToast(U?.error||"Reaction failed.","danger");return}const B=U.data||null,C=B?.file||null,_=B?.reaction?.type?String(B.reaction.type):y;e.atlasStatusCache.set(P.url,{exists:!!C,downloaded:!!C?.downloaded,blacklisted:!!C?.blacklisted_at,reactionType:_,ts:Date.now()}),d(p,!1,_,P.url),t.showToast(`Reacted (${y}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",c=>{if(!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||b(c))return;const p=S(c);if(!p)return;h(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const y=ye(p,e.minSize);if(!y){if(p instanceof HTMLVideoElement){const P=(p.currentSrc||p.src||"").trim().toLowerCase();if(P.startsWith("blob:")||P.startsWith("data:")){const le=window.location.href,U={type:"dislike",url:le,referrer_url:le,page_title:e.limitString(document.title,e.maxMetadataLen),tag_name:"video",width:p.videoWidth||p.clientWidth||null,height:p.videoHeight||p.clientHeight||null,alt:"",preview_url:p.poster||"",source:e.sourceFromMediaUrl(le),download_via:"yt-dlp"};d(p,!0,"dislike",U.url),t.sendMessageSafe({type:"atlas-react",payload:U},B=>{if(!B||!B.ok){d(p,!1,null,U.url),t.showToast(B?.error||"Reaction failed.","danger");return}d(p,!1,"dislike",U.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const N={type:"dislike",url:y.url,referrer_url:y.referrer_url||window.location.href,page_title:e.limitString(document.title,e.maxMetadataLen),tag_name:y.tag_name,width:y.width,height:y.height,alt:e.limitString(y.alt||"",e.maxMetadataLen),preview_url:y.preview_url||"",source:e.sourceFromMediaUrl(y.url)};d(p,!0,"dislike",N.url),t.sendMessageSafe({type:"atlas-react",payload:N},P=>{if(!P||!P.ok){d(p,!1,null,N.url),t.showToast(P?.error||"Reaction failed.","danger");return}d(p,!1,"dislike",N.url),t.showToast("Disliked.")})},!0),document.addEventListener("auxclick",c=>{!a||!(c instanceof MouseEvent)||!c.altKey||c.button!==1||t.isSheetOpen()||b(c)||!S(c)||(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())},!0)}function et(t,e,a){return t<e?e:t>a?a:t}function $t(){const t=window;if(t.__atlasLocationObserverInstalled)return;t.__atlasLocationObserverInstalled=!0;const e=()=>{window.dispatchEvent(new Event(Xe))},a=r=>{const o=history[r].bind(history);history[r]=((...h)=>{const d=o(...h);return e(),d})};a("pushState"),a("replaceState"),window.addEventListener("popstate",e,!0),window.addEventListener("hashchange",e,!0)}function tt(t,e,a){const r=ye(t,a.minSize);if(r)return{type:e,url:r.url,referrer_url:r.referrer_url||window.location.href,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:r.tag_name,width:r.width,height:r.height,alt:a.limitString(r.alt||"",a.maxMetadataLen),preview_url:r.preview_url||"",source:a.sourceFromMediaUrl(r.url)};if(t instanceof HTMLVideoElement){const o=(t.currentSrc||t.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const h=window.location.href;return{type:e,url:h,referrer_url:h,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:a.sourceFromMediaUrl(h),download_via:"yt-dlp"}}}return null}function nt(t,e){$t();const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");const r=document.createElement("span");r.className="atlas-downloader-media-resolution",r.hidden=!0,a.appendChild(r);let o=null,h=null,d=null,b=null,S=!1,c=null,p=null,y=-1,N=-1,P=null,le=window.location.href;const U=new Map,B=(s,g)=>{const M=typeof s=="number"&&Number.isFinite(s)&&s>0?Math.round(s):null,W=typeof g=="number"&&Number.isFinite(g)&&g>0?Math.round(g):null;return!M||!W?"":`${M}x${W}`},C=(s,g)=>{const M=B(s,g);if(!M){r.textContent="",r.hidden=!0;return}r.textContent=M,r.hidden=!1},_=()=>{const s=S||c!==null;for(const[g,M]of U.entries())M.disabled=s,M.classList.toggle("pending",S&&p===g)},x=(s,g=null)=>{S=s,p=s?g:null,_()},v=s=>{for(const g of[...Le,Y]){const M=U.get(g.type);if(!M)continue;const W=g.type===Y.type?s==="dislike":s===g.type;M.classList.toggle("active",W)}},E=(s,g)=>{c=s&&g===!1&&s!=="dislike"?s:null;for(const M of[...Le,Y]){const W=U.get(M.type);if(!W)continue;const k=M.type===Y.type?c==="dislike":c===M.type;W.classList.toggle("queued",k)}_()},H=(s,g,M)=>{o&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:o,pending:s,reactionType:g,url:M}}))},$=()=>{S&&(H(!1,null,h||null),x(!1,null))},j=()=>{const s=window.location.href;s!==le&&(le=s,$(),T(!0))},X=()=>{d!==null&&(window.cancelAnimationFrame(d),d=null),b!==null&&(window.cancelAnimationFrame(b),b=null)},T=s=>{S&&!(s===!0)||(o=null,h=null,a.classList.remove("open"),a.style.left="",a.style.top="",C(null,null),v(null))},z=()=>{X(),d=window.requestAnimationFrame(()=>{d=null,b=window.requestAnimationFrame(()=>{b=null,!a.matches(":hover")&&(o instanceof Element&&o.matches(":hover")||T())})})},q=s=>{s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation?.()};for(const s of[...Le,Y]){const g=document.createElement("button");g.type="button",g.className=`atlas-downloader-reaction-btn ${s.className}`.trim(),g.setAttribute("aria-label",s.label),g.title=s.label,g.replaceChildren(Ae(s.pathDs)),U.set(s.type,g),g.addEventListener("pointerdown",q,!0),g.addEventListener("mousedown",q,!0),g.addEventListener("click",M=>{if(q(M),S)return;if(!o){t.showToast("No media selected.");return}const W=s.type===Y.type?"dislike":s.type,k=tt(o,W,e);if(!k){t.showToast("No valid media URL found.");return}const Z=k.url||"",O=(de=!1)=>{de?k.force_download=!0:"force_download"in k&&delete k.force_download,H(!0,s.type,Z||null),x(!0,s.type),t.sendMessageSafe({type:"atlas-react",payload:{...k,...s.type===Y.type?{blacklist:!0}:{}}},ae=>{if(x(!1,null),!ae||!ae.ok){H(!1,null,Z||null),t.showToast(ae?.error||"Reaction failed.","danger");return}const pe=ae.data||null,re=pe?.file||null,we=pe?.reaction?.type?String(pe.reaction.type):s.type===Y.type?"dislike":s.type;if(Z&&e.atlasStatusCache.set(Z,{exists:!!re,downloaded:!!re?.downloaded,blacklisted:!!re?.blacklisted_at,reactionType:we,ts:Date.now()}),v(we),E(we,!!re?.downloaded),H(!1,we,Z||null),k.download_via==="yt-dlp"){t.showToast(`Reacted (${s.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${s.label}). Queued download in Atlas.`)})};e.fetchAtlasStatus(t.sendMessageSafe,Z,k.referrer_url||null,de=>{if(W!=="dislike"&&de?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(ae=>{if(ae==="alternate"){t.showToast("Cancelled.");return}O(ae==="confirm")});return}O(!1)})}),a.appendChild(g)}t.root.appendChild(a);const ue=s=>(typeof s.composedPath=="function"?s.composedPath():[]).some(M=>M instanceof HTMLElement&&M.id===e.rootId),ee=()=>{if(!o)return;const s=o.getBoundingClientRect();if(!Number.isFinite(s.left)||s.width<=0||s.height<=0){$(),T(!0);return}const g=et(s.top+8,8,window.innerHeight-8),M=et(s.right-8,8,window.innerWidth-8);a.style.top=`${g}px`,a.style.left=`${M}px`},te=(s,g)=>Je(s,g,e.rootId),ne=s=>{if(t.isSheetOpen()){T();return}j();const g=tt(s,"like",e);if(!g){T();return}const M=g.url||null;if((o&&o!==s||h&&M&&h!==M)&&$(),o=s,h=M,C(g.width,g.height),a.classList.add("open"),ee(),v(null),E(null,null),h){const k=e.getCachedAtlasStatus(h);if(k)v(k.reactionType),E(k.reactionType,k.downloaded);else{const Z=h;e.fetchAtlasStatus(t.sendMessageSafe,Z,window.location.href,O=>{O&&h===Z&&(v(O.reactionType),E(O.reactionType,O.downloaded))})}}},ge=s=>s?s==="blacklist"?"blacklist":s:null,be=()=>{if(t.isSheetOpen())return;if(y>=0&&N>=0){const g=te(y,N);if(g&&!g.closest?.(`#${e.rootId}`)){X(),ne(g);return}}const s=Ut(o,e.rootId);s&&(X(),ne(s))},me=()=>{P===null&&(P=window.requestAnimationFrame(()=>{P=null,be()}))};document.addEventListener("pointerover",s=>{if(t.isSheetOpen()||!(s.target instanceof Element)||ue(s))return;const g=te(s.clientX,s.clientY);g&&(X(),ne(g))},!0),window.addEventListener("atlas-shortcut-reaction-state",s=>{const g=s,M=g.detail?.media;if(!(M instanceof Element))return;X(),ne(M);const W=!!g.detail?.pending,k=ge(g.detail?.reactionType??null);if(W){x(!0,k);return}if(x(!1,null),k){const Z=k==="blacklist"?"dislike":k;v(Z);const O=h?e.getCachedAtlasStatus(h):null;E(Z,O?.downloaded??null)}},!0),document.addEventListener("pointermove",s=>{j(),y=s.clientX,N=s.clientY},!0),document.addEventListener("click",s=>{s instanceof MouseEvent&&(t.isSheetOpen()||ue(s)||me())},!0),document.addEventListener("pointerout",s=>{!o||t.isSheetOpen()||!(s.target instanceof Element)||ue(s)||!(s.target.closest?.("img, video")??null)||z()},!0),a.addEventListener("pointerenter",X,!0),a.addEventListener("pointerleave",z,!0),window.addEventListener("scroll",ee,!0),window.addEventListener("resize",ee),window.addEventListener(Xe,j,!0),window.addEventListener("blur",T),window.addEventListener("focus",me,!0),new MutationObserver(()=>{j(),me()}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}function F(t){const e=t.indexOf("#");return e===-1?t:t.slice(0,e)}function at(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e&&!e.startsWith("#")).map(e=>(e.startsWith("*.")?e.slice(2):e).toLowerCase()).map(e=>Ne(e)||e.replace(/^\.+/,"").trim()).filter(Boolean)}function rt(t,e){const a=(t||"").toLowerCase();if(!a)return!1;for(const r of e)if(De(a,r))return!0;return!1}function Ne(t){if(!t||typeof t!="string")return"";const e=t.trim();if(!e)return"";const a=/^https?:\/\//i.test(e)?e:`https://${e}`;try{return new URL(a).hostname}catch{return""}}function De(t,e){return!t||!e?!1:t===e||t.endsWith(`.${e}`)}const ot="atlas-downloader-page-markers";function lt(t){return function(a,r="info"){const o=document.createElement("div");o.className=`atlas-downloader-toast${r==="danger"?" danger":""}`,o.textContent=a,t.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove(),{once:!0})},2600)}}function it(t){return e=>new Promise(a=>{const r=document.createElement("div");r.className="atlas-downloader-dialog-backdrop";const o=document.createElement("div");o.className=`atlas-downloader-dialog${e.danger?" danger":""}`.trim(),o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.setAttribute("aria-label",e.title);const h=document.createElement("h3");h.className="atlas-downloader-dialog-title",h.textContent=e.title;const d=document.createElement("p");d.className="atlas-downloader-dialog-message",d.textContent=e.message;const b=document.createElement("div");b.className="atlas-downloader-dialog-actions";const S=y=>{r.remove(),a(y)};if(e.alternateLabel){const y=document.createElement("button");y.type="button",y.className="atlas-downloader-dialog-btn secondary",y.textContent=e.alternateLabel,y.addEventListener("click",()=>S("alternate")),b.appendChild(y)}const c=document.createElement("button");c.type="button",c.className="atlas-downloader-dialog-btn",c.textContent=e.cancelLabel||"Cancel",c.addEventListener("click",()=>S("cancel")),b.appendChild(c);const p=document.createElement("button");p.type="button",p.className=`atlas-downloader-dialog-btn primary${e.danger?" danger":""}`.trim(),p.textContent=e.confirmLabel,p.addEventListener("click",()=>S("confirm")),b.appendChild(p),o.appendChild(h),o.appendChild(d),o.appendChild(b),r.appendChild(o),t.appendChild(r),requestAnimationFrame(()=>{p.focus()})})}function Wt(){if(document.getElementById(ot))return;const t=document.createElement("style");t.id=ot,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 4px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 4px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 4px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 4px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 4px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: -4px !important;
}
`,(document.head||document.documentElement).appendChild(t)}(()=>{const a="atlas-downloader-root",r="atlas-open",o=(()=>{try{return window.top===window.self}catch{return!1}})(),h=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let d=null,b=null;const S=3e4,c=new Map;function p(C,_){const x=typeof C=="string"?C:"";return x.length<=_?x:x.slice(0,_)}function y(C){return vt(C)||"Extension"}function N(C){const _=c.get(C);return _?Date.now()-_.ts>S?(c.delete(C),null):_:null}function P(C,_,x,v){const E=F((_||"").trim());if(!E){v(null);return}const H=N(E);if(H){v(H);return}C({type:"atlas-check-batch",urls:[E]},$=>{if(!$||!$.ok){v(null);return}const j=Array.isArray($.data?.results)?$.data.results:[],T=new Map(j.filter(q=>typeof q?.url=="string"&&q.url.trim()!=="").map(q=>[F(String(q.url)),q])).get(E)??null;if(!T){v(null);return}const z={exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,reactionType:T.reaction?.type?String(T.reaction.type):null,ts:Date.now()};c.set(E,z),v(z)})}chrome.runtime.onMessage.addListener(C=>{if(!C||typeof C!="object")return;const _=C;if(_.type==="atlas-download-event"){b?.(_.payload);return}if(_.type==="atlas-open-sheet"&&o)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],x=>{He(x.atlasMediaNoiseFilters||"");const v=Ne(x.atlasBaseUrl||"");if(v&&De(window.location.hostname,v))return;const E=at(x.atlasExcludedDomains||"");rt(window.location.hostname,E)||(U(),d?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],C=>{He(C.atlasMediaNoiseFilters||"");const _=Ne(C.atlasBaseUrl||"");if(_&&De(window.location.hostname,_))return;const x=at(C.atlasExcludedDomains||"");rt(window.location.hostname,x)||(o?U():le())});function le(){if(document.getElementById(a))return;const C=document.createElement("div");C.id=a;const _=C.attachShadow({mode:"closed"}),x=document.createElement("link");x.rel="stylesheet",x.href=chrome.runtime.getURL("dist/content.css"),_.appendChild(x);const v=document.createElement("div");v.className="atlas-shadow-root";const E=lt(v),H=it(v),$=(j,X)=>{try{chrome.runtime.sendMessage(j,X)}catch(T){(()=>{if(T instanceof Error)return T.message;if(T&&typeof T=="object"&&"message"in T){const q=T.message;return typeof q=="string"?q:String(q)}return String(T)})().includes("Extension context invalidated")?E("Atlas extension was reloaded. Refresh this tab.","danger"):E("Atlas extension error. Refresh this tab.","danger"),X(null)}};_.appendChild(v),(document.body||document.documentElement).appendChild(C),Ge({showToast:E,sendMessageSafe:$,isSheetOpen:()=>!1,chooseDialog:H},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:y,fetchAtlasStatus:P,atlasStatusCache:c,getCachedAtlasStatus:N}),nt({root:v,showToast:E,sendMessageSafe:$,isSheetOpen:()=>!1,chooseDialog:H},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:y,fetchAtlasStatus:P,atlasStatusCache:c,getCachedAtlasStatus:N})}function U(){if(document.getElementById(a))return;const C=document.createElement("div");C.id=a;const _=C.attachShadow({mode:"closed"}),x=document.createElement("link");x.rel="stylesheet",x.href=chrome.runtime.getURL("dist/content.css"),_.appendChild(x);const v=document.createElement("div");v.className="atlas-shadow-root";const E=lt(v),H=(n,i)=>{try{chrome.runtime.sendMessage(n,i)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const m=l.message;return typeof m=="string"?m:String(m)}return String(l)})().includes("Extension context invalidated")?E("Atlas extension was reloaded. Refresh this tab.","danger"):E("Atlas extension error. Refresh this tab.","danger"),i(null)}},$=document.createElement("button");$.className="atlas-downloader-toggle",$.type="button",$.setAttribute("aria-label","Atlas Downloader"),$.title="Atlas Downloader";const j=document.createElement("img");j.alt="",j.src=chrome.runtime.getURL("icon.svg"),$.appendChild(j);const X=document.createElement("div");X.className="atlas-downloader-overlay";const T=document.createElement("div");T.className="atlas-downloader-modal",T.setAttribute("role","dialog"),T.setAttribute("aria-modal","true"),T.setAttribute("aria-label","Atlas Media Picker");const z=document.createElement("div");z.className="atlas-downloader-header";const q=document.createElement("div");q.className="atlas-downloader-title",q.textContent="Atlas Media Picker";const ue=document.createElement("div");ue.className="atlas-downloader-version",ue.textContent=h?`v${h}`:"";const ee=document.createElement("button");ee.type="button",ee.className="atlas-downloader-close",ee.setAttribute("aria-label","Close"),ee.textContent="x",z.appendChild(q),z.appendChild(ue),z.appendChild(ee);const te=document.createElement("div");te.className="atlas-downloader-toolbar";const ne=ve("Rescan",()=>dt()),ge=ve("Check Atlas",()=>wt(!1)),be=ve("Select all",()=>ct(!0)),me=ve("Select none",()=>ct(!1)),Be=document.createElement("span");Be.className="spacer";const s=ve("Queue selected",()=>Jt(),{primary:!0});te.appendChild(ne),te.appendChild(ge),te.appendChild(be),te.appendChild(me),te.appendChild(Be),te.appendChild(s);const g=document.createElement("div");g.className="atlas-downloader-meta";const M=document.createElement("div");M.className="atlas-downloader-list",T.appendChild(z),T.appendChild(te),T.appendChild(g),T.appendChild(M),v.appendChild($),v.appendChild(X),v.appendChild(T),_.appendChild(v),(document.body||document.documentElement).appendChild(C);const W=it(v);let k=[],Z=0,O=null,de=null,ae=null,pe=null;const re=new Set,we=new Map,Ot=!0;let st=!1;b=n=>{if(!n||typeof n!="object")return;const i=n,l=Number.isFinite(Number(i.transferId))?Number(i.transferId):null,u=typeof i.status=="string"?i.status:"",m=!!i.downloaded||u==="completed"||typeof i.finished_at=="string",w=!!i.failed||u==="failed"||u==="canceled"||typeof i.failed_at=="string",A=new Set,f=typeof i.original=="string"?F(i.original.trim()):"",L=typeof i.referrer_url=="string"?F(i.referrer_url.trim()):"";f&&A.add(f),L&&A.add(L);const D=l?we.get(l)??"":"";if(D&&A.add(D),A.size===0)return;const Q=f||D||L||"";l&&Q&&!m&&!w&&we.set(l,Q);let G=!1;for(const R of A){const se=N(R);c.set(R,{exists:!0,downloaded:m,blacklisted:se?!!se.blacklisted:!1,reactionType:se?.reactionType??null,ts:Date.now()})}for(const R of k){const se=ie(R)||F(String(R.url||""));!se||!A.has(se)||!re.has(se)&&R.status!=="Queued"||(R.atlas={exists:!0,downloaded:m,blacklisted:R.atlas?.blacklisted??!1,file_id:R.atlas?.file_id??null,reaction:R.atlas?.reaction??null},m?(R.status="",R.statusClass="",R.reactionQueued=null,re.delete(se)):w?(R.status="Failed",R.statusClass="err",R.reactionQueued=null,re.delete(se)):(R.status="Queued",R.statusClass="queued"),G=!0)}l&&(m||w)&&we.delete(l),G&&(J(),V(K()),fe(k))},$.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),Re()}),X.addEventListener("click",()=>ke()),ee.addEventListener("click",()=>ke()),document.addEventListener("keydown",n=>{const i=n.key.toLowerCase();if(n.altKey&&n.shiftKey&&i==="a"){n.preventDefault(),Re();return}if(n.key==="Escape"&&v.classList.contains(r)){ke();return}if(!v.classList.contains(r))return;const l=n.key==="1"?"love":n.key==="2"?"like":n.key==="3"?"funny":null;if(!l)return;const u=k.find(m=>m.selected)??k[0]??null;u&&(n.preventDefault(),Ie(u,l,{closeOnSuccess:!0}))});function Ft(){v.classList.add(r),dt()}function Re(){if(v.classList.contains(r)){ke();return}Ft()}function ke(){v.classList.remove(r)}d=Re,Ge({showToast:E,sendMessageSafe:H,isSheetOpen:()=>v.classList.contains(r),chooseDialog:W,setHintShown:n=>{st=n},getHintShown:()=>st,enabled:Ot},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:y,fetchAtlasStatus:P,atlasStatusCache:c,getCachedAtlasStatus:N}),nt({root:v,showToast:E,sendMessageSafe:H,isSheetOpen:()=>v.classList.contains(r),chooseDialog:W},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:y,fetchAtlasStatus:P,atlasStatusCache:c,getCachedAtlasStatus:N}),window.addEventListener("atlas-shortcut-reaction-state",n=>{const i=n,l=!!i.detail?.pending,u=i.detail?.reactionType?String(i.detail.reactionType):null,w=(typeof i.detail?.url=="string"?i.detail.url:"")||i.detail?.media&&ye(i.detail.media,200)?.url||"",A=w?F(w):"";if(l){O=A||"__external-reaction__",de=u||de||"like";for(const f of k)A&&(ie(f)||F(String(f.url||"")))!==A||(f.reactionPending=u||f.reactionPending||"like");J(),V(K());return}O=null,de=null;for(const f of k){if(A&&(ie(f)||F(String(f.url||"")))!==A)continue;f.reactionPending&&(f.reactionPending=null);const L=(A?N(A):null)??N(ie(f))??N(F(String(f.url||"")));L?f.atlas={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,file_id:f.atlas?.file_id??null,reaction:L.reactionType?{type:L.reactionType}:f.atlas?.reaction??null}:u&&(f.atlas={exists:f.atlas?.exists??!0,downloaded:f.atlas?.downloaded??!1,blacklisted:f.atlas?.blacklisted??!1,file_id:f.atlas?.file_id??null,reaction:{type:u}}),f.atlas?.exists&&!f.atlas?.downloaded&&f.atlas?.reaction?.type&&f.atlas.reaction.type!=="dislike"?f.reactionQueued=f.atlas.reaction.type:f.reactionQueued=null}J(),V(K()),fe(k)},!0);const _e=(n=300)=>{pe!==null&&window.clearTimeout(pe),pe=window.setTimeout(()=>{pe=null,Gt()},n)};new MutationObserver(()=>{fe(k),_e(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>_e(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&_e(120)},!0),_e(120);function ve(n,i,l){const u=document.createElement("button");return u.type="button",u.className=`atlas-downloader-btn${l?.primary?" primary":""}`,u.textContent=n,u.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),i()}),u}function jt(n){g.textContent=n,s.disabled=!0,ne.disabled=!0,ge.disabled=!0,be.disabled=!0,me.disabled=!0}function V(n){g.textContent=n;const i=k.filter(u=>u.selected).length,l=k.some(u=>!!u.reactionPending)||O!==null;s.disabled=i===0||l,ne.disabled=l,ge.disabled=k.length===0||l,be.disabled=k.length===0||l,me.disabled=k.length===0||l}function dt(){Z+=1;const n=Z;k=[],ae=null,M.replaceChildren(),jt("Scanning this page…"),B(i=>{Z===n&&(g.textContent=`Scanning… ${i.scanned}/${i.total}`)}).then(i=>{Z===n&&(k=i.map(l=>({...l,selected:!0,status:"",statusClass:"",atlas:null,reactionPending:O&&O!=="__external-reaction__"&&(ie(l)||F(String(l.url||"")))===O?de||"like":null,reactionQueued:null})),J(),V(K()),wt(!0))})}function ct(n){for(const i of k)i.selected=n;J(),V(K())}function J(){if(M.replaceChildren(),k.length===0){const n=document.createElement("div");n.style.padding="10px 12px",n.style.color="#94a3b8",n.style.fontSize="12px",n.textContent="No matching images/videos found.",M.appendChild(n);return}for(const n of k)M.appendChild(qt(n))}function qt(n){const i=document.createElement("div");i.className=`atlas-downloader-item${n.selected?" selected":""}`;const l=document.createElement("input");l.type="checkbox",l.checked=n.selected,l.addEventListener("change",()=>{n.selected=l.checked,i.classList.toggle("selected",n.selected),V(K())});const u=document.createElement("div");if(u.className="atlas-downloader-preview",n.preview_url){const I=document.createElement("img");I.loading="lazy",I.alt="",I.src=n.preview_url,u.appendChild(I)}const m=document.createElement("div");m.className="atlas-downloader-info";const w=document.createElement("div");w.className="atlas-downloader-kind",w.textContent=n.tag_name;const A=document.createElement("div");A.className="atlas-downloader-url",A.textContent=n.url,A.title=n.url;const f=document.createElement("div");f.className="atlas-downloader-sub",f.textContent=Vt(n);const L=document.createElement("div");L.className="atlas-downloader-reactions";const D=n.atlas?.reaction?.type||null,Q=!!n.reactionPending||!!n.reactionQueued;for(const I of Le){const ce=document.createElement("button");ce.type="button",ce.className=`atlas-downloader-reaction-btn ${I.className}${D===I.type?" active":""}${n.reactionPending===I.type?" pending":""}${n.reactionQueued===I.type?" queued":""}`.trim(),ce.setAttribute("aria-label",I.label),ce.title=I.label,ce.replaceChildren(Ae(I.pathDs)),ce.disabled=Q,ce.addEventListener("click",bt=>{bt.preventDefault(),bt.stopPropagation(),Ie(n,I.type)}),L.appendChild(ce)}const G=document.createElement("button");if(G.type="button",G.className=`atlas-downloader-reaction-btn ${Y.className}${n.atlas?.blacklisted?" active":""}${n.reactionPending===Y.type?" pending":""}${n.reactionQueued===Y.type?" queued":""}`.trim(),G.setAttribute("aria-label",Y.label),G.title=Y.label,G.replaceChildren(Ae(Y.pathDs)),G.disabled=Q,G.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation(),Ie(n,"dislike",{blacklist:!0})}),L.appendChild(G),n.atlas?.downloaded){const I=document.createElement("button");I.type="button",I.className=`atlas-downloader-reaction-btn delete${n.reactionPending==="delete-download"?" pending":""}`.trim(),I.setAttribute("aria-label","Delete download"),I.title="Delete download",I.replaceChildren(Ae(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),I.disabled=Q,I.addEventListener("click",ce=>{ce.preventDefault(),ce.stopPropagation(),Zt(n)}),L.appendChild(I)}const R=document.createElement("button");R.type="button",R.className=`atlas-downloader-debug-toggle${ae===n.url?" active":""}`,R.textContent=ae===n.url?"Hide debug":"Debug",R.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation(),ae=ae===n.url?null:n.url,J(),V(K())}),L.appendChild(R),m.appendChild(w),m.appendChild(A),m.appendChild(f),m.appendChild(L),ae===n.url&&m.appendChild(Qt(n));const se=document.createElement("div"),gt=Xt(n);return se.className=`atlas-downloader-status ${gt.className}`.trim(),se.textContent=gt.text,i.addEventListener("click",I=>{I.target instanceof HTMLInputElement||(n.selected=!n.selected,l.checked=n.selected,i.classList.toggle("selected",n.selected),V(K()))}),i.appendChild(l),i.appendChild(u),i.appendChild(m),i.appendChild(se),i}function ut(n,i){return{type:i,url:n.url,referrer_url:n.referrer_url||window.location.href,page_title:p(document.title,500),tag_name:n.tag_name,width:n.width,height:n.height,alt:p(n.alt||"",500),preview_url:n.preview_url||"",source:y(n.url),...n.download_via?{download_via:n.download_via}:{}}}function ft(n){return{url:n.url,referrer_url:n.referrer_url||window.location.href,page_title:p(document.title,500),tag_name:n.tag_name,width:n.width,height:n.height,alt:p(n.alt||"",500),preview_url:n.preview_url||"",source:y(n.url),...n.download_via?{download_via:n.download_via}:{},reaction_type:"like"}}function Qt(n){const i=document.createElement("details");i.className="atlas-downloader-debug",i.open=!0;const l=document.createElement("summary");l.textContent="Debug payload",i.appendChild(l);const u={react:ut(n,n.atlas?.reaction?.type||"like"),download:ft(n)};return i.appendChild(zt(u)),i}function zt(n,i=0){const l=document.createElement("div");l.className="atlas-downloader-json-tree";const u=Ce(n);if(!mt(u)){const w=document.createElement("div");return w.className="atlas-downloader-json-line",w.textContent=pt(u),l.appendChild(w),l}const m=Array.isArray(u)?u.map((w,A)=>[String(A),w]):Object.entries(u);for(const[w,A]of m)l.appendChild(ht(w,A,i));return l}function ht(n,i,l){const u=Ce(i),m=document.createElement("div");if(m.className="atlas-downloader-json-line",m.style.paddingLeft=`${l*12}px`,!mt(u))return m.innerHTML=`<span class="atlas-downloader-json-key">${xe(n)}</span>: <span class="atlas-downloader-json-value">${xe(pt(u))}</span>`,m;const w=document.createElement("details");w.className="atlas-downloader-json-node",w.open=l===0;const A=document.createElement("summary");A.style.paddingLeft=`${l*12}px`;const f=Array.isArray(u)?`[${u.length}]`:`{${Object.keys(u).length}}`;A.innerHTML=`<span class="atlas-downloader-json-key">${xe(n)}</span>: <span class="atlas-downloader-json-preview">${xe(f)}</span>`,w.appendChild(A);const L=Array.isArray(u)?u.map((D,Q)=>[String(Q),D]):Object.entries(u);for(const[D,Q]of L)w.appendChild(ht(D,Q,l+1));return w}function Ce(n){if(n===void 0)return null;if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return n;if(Array.isArray(n))return n.map(l=>Ce(l));if(!n||typeof n!="object")return null;const i={};for(const[l,u]of Object.entries(n))i[l]=Ce(u);return i}function mt(n){return Array.isArray(n)||n&&typeof n=="object"}function pt(n){return JSON.stringify(n)}function xe(n){return String(n).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Vt(n){const i=n.width&&n.height?`${n.width}×${n.height}`:"size unknown",l=Kt(n.url);return l?`${i} • ${l}`:i}function Kt(n){try{return new URL(n).hostname}catch{return""}}function K(){const n=k.filter(i=>i.selected).length;return`${k.length} found • ${n} selected`}function ie(n){const i=(n?.url||n?.referrer_url||"").trim();return i?F(i):""}function Xt(n){return n.status?{text:n.status,className:n.statusClass||""}:n.atlas?.downloaded?{text:"Downloaded",className:"ok"}:n.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:n.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function wt(n){const i=[...new Set(k.map(l=>ie(l)).filter(Boolean))];i.length!==0&&H({type:"atlas-check-batch",urls:i},l=>{if(!l){n||E("Atlas extension did not respond.","danger");return}if(!l.ok){n||E(l.error||"Atlas check failed.","danger");return}const u=Array.isArray(l.data?.results)?l.data.results:[],m=new Map(u.filter(f=>typeof f?.url=="string"&&f.url.trim()!=="").map(f=>[F(String(f.url)),f]));let w=0,A=0;for(const f of k){const L=ie(f),D=m.get(L);D&&(f.atlas={exists:!!D.exists,downloaded:!!D.downloaded,blacklisted:!!D.blacklisted,file_id:D.file_id??null,reaction:D.reaction??null},f.atlas.exists&&!f.atlas.downloaded&&f.atlas.reaction?.type&&f.atlas.reaction.type!=="dislike"?(f.reactionQueued=f.atlas.reaction.type,re.add(L)):(f.reactionQueued=null,re.delete(L)),c.set(L,{exists:!!D.exists,downloaded:!!D.downloaded,blacklisted:!!D.blacklisted,reactionType:D.reaction?.type?String(D.reaction.type):null,ts:Date.now()}),D.exists&&(w+=1),D.downloaded&&(A+=1))}J(),V(K()),fe(k),n||E(`Atlas check: ${A}/${w} downloaded.`)})}function Ie(n,i,l={}){const u=(w={})=>{n.reactionPending=l.blacklist?Y.type:i,n.status="Reacting…",n.statusClass="",O=ie(n)||n.url,de=n.reactionPending,J(),V(K());const A={...ut(n,i),...w,...l.blacklist?{blacklist:!0}:{}};H({type:"atlas-react",payload:A},f=>{if(n.reactionPending=null,O=null,de=null,!f){n.status="No response",n.statusClass="err",J(),V(K()),E("Atlas extension did not respond.","danger");return}if(!f.ok){n.status=f.error||"Failed",n.statusClass="err",J(),V(K()),E(f.error||"Reaction failed.","danger");return}const L=f.data||null,D=L?.file||null;n.atlas={exists:!!D,downloaded:!!D?.downloaded,blacklisted:!!D?.blacklisted_at,file_id:D?.id??null,reaction:L?.reaction??null};const Q=ie(n)||n.url;c.set(Q,{exists:n.atlas.exists,downloaded:n.atlas.downloaded,blacklisted:n.atlas.blacklisted,reactionType:n.atlas.reaction?.type?String(n.atlas.reaction.type):null,ts:Date.now()}),n.atlas.exists&&!n.atlas.downloaded&&i!=="dislike"?(n.status="Queued",n.statusClass="queued",n.reactionQueued=l.blacklist?Y.type:i,Q&&re.add(Q)):(n.status="",n.statusClass="",n.reactionQueued=null,Q&&re.delete(Q)),J(),V(K()),fe(k),l.closeOnSuccess&&ke()})},m=!!n.atlas?.reaction?.type;if(i!=="dislike"&&n.atlas?.downloaded&&m){W({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(w=>{if(w==="alternate"){E("Cancelled.");return}u(w==="confirm"?{force_download:!0}:{})});return}if(i==="dislike"&&n.atlas?.downloaded){W({title:l.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(w=>{if(w==="alternate"){E("Cancelled.");return}u(w==="confirm"?{clear_download:!0}:{})});return}u()}function Zt(n){W({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(i=>{i==="confirm"&&(n.reactionPending="delete-download",n.status="Deleting…",n.statusClass="",O=ie(n)||n.url,de=n.reactionPending,J(),V(K()),H({type:"atlas-delete-download",payload:{url:n.url,tag_name:n.tag_name,download_via:n.download_via||null}},l=>{if(n.reactionPending=null,O=null,de=null,!l||!l.ok){n.status=l?.error||"Failed",n.statusClass="err",J(),V(K()),E(l?.error||"Delete failed.","danger");return}const u=l.data?.file||null;n.atlas={exists:!!u,downloaded:!!u?.downloaded,blacklisted:!!u?.blacklisted_at,file_id:u?.id??null,reaction:null},n.reactionQueued=null;const m=ie(n)||n.url;c.set(m,{exists:n.atlas.exists,downloaded:n.atlas.downloaded,blacklisted:n.atlas.blacklisted,reactionType:null,ts:Date.now()}),n.status="",n.statusClass="",J(),V(K()),fe(k),E("Download deleted.")}))})}function Jt(){const n=k.filter(u=>u.selected);if(n.length===0){E("Select one or more items first.");return}if(n.some(u=>!!u.atlas?.downloaded)){W({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(u=>{if(u==="alternate"){E("Cancelled.");return}l(u==="confirm")});return}l(!1);function l(u){s.disabled=!0,ne.disabled=!0,ge.disabled=!0,be.disabled=!0,me.disabled=!0;for(const w of n)w.status="Sending…",w.statusClass="";J();const m=n.map(w=>{const A=ft(w);return u&&(A.force_download=!0),A});H({type:"atlas-download-batch",payloads:m},w=>{if(!w){for(const f of n)f.status="No response",f.statusClass="err";J(),V(K()),E("Atlas extension did not respond.","danger");return}const A=Array.isArray(w.results)?w.results:[];for(let f=0;f<n.length;f+=1){const L=n[f],D=A[f];if(D?.ok){const Q=D.data||null,G=Q?.file||null;if(L.atlas={exists:!!G,downloaded:!!G?.downloaded,blacklisted:!!G?.blacklisted_at,file_id:G?.id??null,reaction:L.atlas?.reaction??null},Q?.queued){L.status="Queued",L.statusClass="queued",L.atlas?.reaction?.type&&L.atlas.reaction.type!=="dislike"&&(L.reactionQueued=L.atlas.reaction.type);const R=ie(L)||F(String(L.url||""));R&&re.add(R)}else{L.status="",L.statusClass="",L.reactionQueued=null;const R=ie(L)||F(String(L.url||""));R&&re.delete(R)}}else L.status=D?.error||"Failed",L.statusClass="err"}J(),V(K()),fe(k),w.ok?E(`Queued ${n.length} download(s) in Atlas.`):E(w.error||"Some requests failed.","danger")})}}function fe(n=k){Wt();const i=document.querySelectorAll('[data-atlas-marked="1"]');for(const m of i)m.removeAttribute("data-atlas-marked"),m.removeAttribute("data-atlas-state"),m.removeAttribute("data-atlas-reaction");const l=new Map;for(const[m,w]of c.entries()){if(Date.now()-w.ts>S){c.delete(m);continue}l.set(m,{exists:!!w.exists,downloaded:!!w.downloaded,blacklisted:!!w.blacklisted,reactionType:w.reactionType?String(w.reactionType):null}),l.set(F(m),{exists:!!w.exists,downloaded:!!w.downloaded,blacklisted:!!w.blacklisted,reactionType:w.reactionType?String(w.reactionType):null})}for(const m of n){if(!m?.url||!m?.atlas)continue;const w=m.atlas?.reaction?.type?String(m.atlas.reaction.type):null,A={exists:!!m.atlas.exists,downloaded:!!m.atlas.downloaded,blacklisted:!!m.atlas.blacklisted,reactionType:w};l.set(m.url,A),l.set(F(m.url),A)}if(l.size===0)return;const u=document.querySelectorAll("img, video, a[href]");for(const m of u){const w=We(m);if(w.length===0)continue;const A=w.map(f=>l.get(f)||l.get(F(f))).find(f=>!!(f&&(f.exists||f.downloaded||f.blacklisted||f.reactionType)))??null;A&&(m.setAttribute("data-atlas-marked","1"),A.blacklisted?m.setAttribute("data-atlas-state","blacklisted"):A.reactionType?m.setAttribute("data-atlas-state","reacted"):A.downloaded?m.setAttribute("data-atlas-state","downloaded"):A.exists&&m.setAttribute("data-atlas-state","exists"),A.reactionType&&m.setAttribute("data-atlas-reaction",A.reactionType))}}function Yt(){const n=new Set,i=document.querySelectorAll("img, video, a[href]");for(const u of i)for(const m of We(u))n.add(m),n.add(F(m));const l=$e();return l?.url&&(n.add(l.url),n.add(F(l.url))),[...n].filter(Boolean)}function Gt(){const n=Yt();if(n.length===0){fe(k);return}H({type:"atlas-check-batch",urls:n},i=>{if(!i?.ok){fe(k);return}const l=Array.isArray(i.data?.results)?i.data.results:[];for(const u of l)u?.url&&c.set(String(u.url),{exists:!!u.exists,downloaded:!!u.downloaded,blacklisted:!!u.blacklisted,reactionType:u.reaction?.type?String(u.reaction.type):null,ts:Date.now()});fe(k)})}}function B(C){return new Promise(_=>{const x=document.body||document.documentElement,v=Array.from(x.querySelectorAll("img, video")),E=v.length,H=new Set,$=[];let j=0;const X=z=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(z,{timeout:500});return}setTimeout(()=>z({timeRemaining:()=>25}),0)},T=z=>{const q=typeof z?.timeRemaining=="function"?z.timeRemaining():25;let ue=0;for(;j<E&&(ue<80||q>5);){const te=v[j];if(te.closest&&te.closest(`#${a}`)){j+=1,ue+=1;continue}const ne=ye(te,200);ne?.url&&!H.has(ne.url)&&(H.add(ne.url),$.push(ne)),j+=1,ue+=1}if(C?.({scanned:j,total:E}),j<E){X(T);return}const ee=$e();ee&&!H.has(ee.url)&&(H.add(ee.url),$.push(ee)),_($)};X(T)})}})()})();
