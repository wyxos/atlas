(function(){"use strict";const Ne=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function xe(K){const q=(K||"").trim().toLowerCase();if(!q)return"";const L=q.split(".").filter(Boolean);if(L.length<=2)return q;const B=L.slice(-2).join("."),J=L.slice(-3).join(".");return Ne.has(B)&&L.length>=3?J:B}function De(K){const q=(K||"").trim();if(!q)return"";try{const L=new URL(q).hostname;return xe(L)}catch{return""}}(()=>{const L="atlas-downloader-root",B="atlas-open",J=(()=>{try{return window.top===window.self}catch{return!1}})(),ie=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let de=null;const Re=3e4,F=new Map,ce="http://www.w3.org/2000/svg",ue=e=>{const n=document.createElementNS(ce,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const a of e){const o=document.createElementNS(ce,"path");o.setAttribute("d",a),o.setAttribute("fill","none"),o.setAttribute("stroke","currentColor"),o.setAttribute("stroke-width","2"),o.setAttribute("stroke-linecap","round"),o.setAttribute("stroke-linejoin","round"),n.appendChild(o)}return n},ae=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}];function x(e,n){const a=typeof e=="string"?e:"";return a.length<=n?a:a.slice(0,n)}function O(e){return De(e)||"Extension"}function fe(e){const n=F.get(e);return n?Date.now()-n.ts>Re?(F.delete(e),null):n:null}function G(e,n,a){if(!n){a(null);return}const o=fe(n);if(o){a(o);return}e({type:"atlas-check-batch",urls:[n]},r=>{if(!r||!r.ok){a(null);return}const w=Array.isArray(r.data?.results)?r.data.results:[],l=w.find(d=>d?.url===n)??w[0]??null;if(!l){a(null);return}const A={exists:!!l.exists,downloaded:!!l.downloaded,reactionType:l.reaction?.type?String(l.reaction.type):null,ts:Date.now()};F.set(n,A),a(A)})}chrome.runtime.onMessage.addListener(e=>{if(!(!e||typeof e!="object"||e.type!=="atlas-open-sheet")&&J)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],a=>{const o=re(a.atlasBaseUrl||"");if(o&&se(window.location.hostname,o))return;const r=pe(a.atlasExcludedDomains||"");we(window.location.hostname,r)||(he(),de?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],e=>{const n=re(e.atlasBaseUrl||"");if(n&&se(window.location.hostname,n))return;const a=pe(e.atlasExcludedDomains||"");we(window.location.hostname,a)||(J?he():He())});function He(){if(document.getElementById(L))return;const e=document.createElement("div");e.id=L;const n=e.attachShadow({mode:"closed"}),a=document.createElement("link");a.rel="stylesheet",a.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(a);const o=document.createElement("div");o.className="atlas-shadow-root";const r=me(o),w=(l,A)=>{try{chrome.runtime.sendMessage(l,A)}catch(d){(()=>{if(d instanceof Error)return d.message;if(d&&typeof d=="object"&&"message"in d){const m=d.message;return typeof m=="string"?m:String(m)}return String(d)})().includes("Extension context invalidated")?r("Atlas extension was reloaded. Refresh this tab."):r("Atlas extension error. Refresh this tab."),A(null)}};n.appendChild(o),(document.body||document.documentElement).appendChild(e),ge({showToast:r,sendMessageSafe:w,isSheetOpen:()=>!1}),be({root:o,showToast:r,sendMessageSafe:w,isSheetOpen:()=>!1})}function he(){if(document.getElementById(L))return;const e=document.createElement("div");e.id=L;const n=e.attachShadow({mode:"closed"}),a=document.createElement("link");a.rel="stylesheet",a.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(a);const o=document.createElement("div");o.className="atlas-shadow-root";const r=me(o),w=(t,i)=>{try{chrome.runtime.sendMessage(t,i)}catch(c){(()=>{if(c instanceof Error)return c.message;if(c&&typeof c=="object"&&"message"in c){const p=c.message;return typeof p=="string"?p:String(p)}return String(c)})().includes("Extension context invalidated")?r("Atlas extension was reloaded. Refresh this tab."):r("Atlas extension error. Refresh this tab."),i(null)}},l=document.createElement("button");l.className="atlas-downloader-toggle",l.type="button",l.setAttribute("aria-label","Atlas Downloader"),l.title="Atlas Downloader";const A=document.createElement("img");A.alt="",A.src=chrome.runtime.getURL("icon.svg"),l.appendChild(A);const d=document.createElement("div");d.className="atlas-downloader-overlay";const h=document.createElement("div");h.className="atlas-downloader-modal",h.setAttribute("role","dialog"),h.setAttribute("aria-modal","true"),h.setAttribute("aria-label","Atlas Media Picker");const m=document.createElement("div");m.className="atlas-downloader-header";const C=document.createElement("div");C.className="atlas-downloader-title",C.textContent="Atlas Media Picker";const _=document.createElement("div");_.className="atlas-downloader-version",_.textContent=ie?`v${ie}`:"";const g=document.createElement("button");g.type="button",g.className="atlas-downloader-close",g.setAttribute("aria-label","Close"),g.textContent="x",m.appendChild(C),m.appendChild(_),m.appendChild(g);const s=document.createElement("div");s.className="atlas-downloader-toolbar";const u=z("Rescan",()=>_e()),T=z("Check Atlas",()=>ke(!1));let b=!1,v=null;const $=z("Debug: off",()=>{b=!b,$.textContent=b?"Debug: on":"Debug: off",b?!v&&S.length>0&&(v={url:S[0].url,reactionType:"like"}):v=null,D(),H(U())}),R=z("Select all",()=>Te(!0)),I=z("Select none",()=>Te(!1)),Q=document.createElement("span");Q.className="spacer";const X=z("Queue selected",()=>Ze(),{primary:!0});s.appendChild(u),s.appendChild(T),s.appendChild($),s.appendChild(R),s.appendChild(I),s.appendChild(Q),s.appendChild(X);const Z=document.createElement("div");Z.className="atlas-downloader-meta";const V=document.createElement("div");V.className="atlas-downloader-list",h.appendChild(m),h.appendChild(s),h.appendChild(Z),h.appendChild(V),o.appendChild(l),o.appendChild(d),o.appendChild(h),n.appendChild(o),(document.body||document.documentElement).appendChild(e);let S=[],ee=0;const Ie=!0;let Ee=!1;l.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),ve()}),d.addEventListener("click",()=>le()),g.addEventListener("click",()=>le()),document.addEventListener("keydown",t=>{t.key==="Escape"&&o.classList.contains(B)&&le()});function ve(){o.classList.add(B),_e()}function le(){o.classList.remove(B)}de=ve,ge({showToast:r,sendMessageSafe:w,isSheetOpen:()=>o.classList.contains(B),setHintShown:t=>{Ee=t},getHintShown:()=>Ee,enabled:Ie}),be({root:o,showToast:r,sendMessageSafe:w,isSheetOpen:()=>o.classList.contains(B)});function z(t,i,c){const f=document.createElement("button");return f.type="button",f.className=`atlas-downloader-btn${c?.primary?" primary":""}`,f.textContent=t,f.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),i()}),f}function qe(t){Z.textContent=t,X.disabled=!0,u.disabled=!0,T.disabled=!0,$.disabled=!0,R.disabled=!0,I.disabled=!0}function H(t){Z.textContent=t;const i=S.filter(c=>c.selected).length;X.disabled=i===0,u.disabled=!1,T.disabled=S.length===0,$.disabled=S.length===0,R.disabled=S.length===0,I.disabled=S.length===0}function _e(){ee+=1;const t=ee;S=[],b&&(v=null),V.replaceChildren(),qe("Scanning this page…"),Ue(i=>{ee===t&&(Z.textContent=`Scanning… ${i.scanned}/${i.total}`)}).then(i=>{ee===t&&(S=i.map(c=>({...c,selected:!0,status:"",statusClass:"",atlas:null})),b&&!v&&S.length>0&&(v={url:S[0].url,reactionType:"like"}),D(),H(U()),ke(!0))})}function Te(t){for(const i of S)i.selected=t;D(),H(U())}function D(){if(V.replaceChildren(),S.length===0){const t=document.createElement("div");t.style.padding="10px 12px",t.style.color="#94a3b8",t.style.fontSize="12px",t.textContent="No matching images/videos found.",V.appendChild(t);return}for(const t of S)V.appendChild(Xe(t))}function Xe(t){const i=document.createElement("div");i.className=`atlas-downloader-item${t.selected?" selected":""}`;const c=document.createElement("input");c.type="checkbox",c.checked=t.selected,c.addEventListener("change",()=>{t.selected=c.checked,i.classList.toggle("selected",t.selected),H(U())});const f=document.createElement("div");if(f.className="atlas-downloader-preview",t.preview_url){const N=document.createElement("img");N.loading="lazy",N.alt="",N.src=t.preview_url,f.appendChild(N)}const p=document.createElement("div");p.className="atlas-downloader-info";const k=document.createElement("div");k.className="atlas-downloader-kind",k.textContent=t.tag_name;const E=document.createElement("div");E.className="atlas-downloader-url",E.textContent=t.url,E.title=t.url;const y=document.createElement("div");y.className="atlas-downloader-sub",y.textContent=Fe(t);const M=document.createElement("div");M.className="atlas-downloader-reactions";const ne=t.atlas?.reaction?.type||null;for(const N of ae){const P=document.createElement("button");P.type="button",P.className=`atlas-downloader-reaction-btn ${N.className}${ne===N.type?" active":""}${t.reactionPending?" pending":""}`.trim(),P.setAttribute("aria-label",N.label),P.title=N.label,P.replaceChildren(ue(N.pathDs)),P.disabled=!!t.reactionPending,P.addEventListener("click",Le=>{Le.preventDefault(),Le.stopPropagation(),b&&(v={url:t.url,reactionType:N.type},D()),Qe(t,N.type)}),M.appendChild(P)}p.appendChild(k),p.appendChild(E),p.appendChild(y),p.appendChild(M),b&&v?.url===t.url&&p.appendChild(je(t,v.reactionType));const j=document.createElement("div"),Me=ze(t);return j.className=`atlas-downloader-status ${Me.className}`.trim(),j.textContent=Me.text,i.addEventListener("click",N=>{N.target instanceof HTMLInputElement||(b&&(v={url:t.url,reactionType:v?.reactionType??"like"}),t.selected=!t.selected,c.checked=t.selected,i.classList.toggle("selected",t.selected),H(U()))}),i.appendChild(c),i.appendChild(f),i.appendChild(p),i.appendChild(j),i}function Ce(t,i){return{type:i,url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:x(document.title,500),tag_name:t.tag_name,width:t.width,height:t.height,alt:x(t.alt||"",500),preview_url:t.preview_url||"",source:O(t.url)}}function Se(t){return{url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:x(document.title,500),tag_name:t.tag_name,width:t.width,height:t.height,alt:x(t.alt||"",500),preview_url:t.preview_url||"",source:O(t.url),reaction_type:"like"}}function je(t,i){const c=document.createElement("details");c.className="atlas-downloader-debug",c.open=!0;const f=document.createElement("summary");f.textContent="Debug payload",c.appendChild(f);const p=document.createElement("pre");return p.textContent=JSON.stringify({react:Ce(t,i),download:Se(t)},null,2),c.appendChild(p),c}function Fe(t){const i=t.width&&t.height?`${t.width}×${t.height}`:"size unknown",c=Ve(t.url);return c?`${i} • ${c}`:i}function Ve(t){try{return new URL(t).hostname}catch{return""}}function U(){const t=S.filter(i=>i.selected).length;return`${S.length} found • ${t} selected`}function ze(t){return t.status?{text:t.status,className:t.statusClass||""}:t.atlas?.downloaded?{text:"Downloaded",className:"ok"}:t.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function ke(t){const i=S.map(c=>c.url).filter(Boolean);i.length!==0&&w({type:"atlas-check-batch",urls:i},c=>{if(!c){t||r("Atlas extension did not respond.");return}if(!c.ok){t||r(c.error||"Atlas check failed.");return}const f=Array.isArray(c.data?.results)?c.data.results:[],p=new Map(f.map(y=>[y.url,y]));let k=0,E=0;for(const y of S){const M=p.get(y.url);M&&(y.atlas={exists:!!M.exists,downloaded:!!M.downloaded,file_id:M.file_id??null,reaction:M.reaction??null},M.exists&&(k+=1),M.downloaded&&(E+=1))}D(),H(U()),t||r(`Atlas check: ${E}/${k} downloaded.`)})}function Qe(t,i){if(i!=="dislike"&&t.atlas?.downloaded&&!window.confirm("This file is already downloaded in Atlas. Re-download it?")){r("Cancelled.");return}t.reactionPending=i,t.status="Reacting…",t.statusClass="",D();const c=Ce(t,i);i!=="dislike"&&t.atlas?.downloaded&&(c.force_download=!0),w({type:"atlas-react",payload:c},f=>{if(t.reactionPending=null,!f){t.status="No response",t.statusClass="err",D(),H(U()),r("Atlas extension did not respond.");return}if(!f.ok){t.status=f.error||"Failed",t.statusClass="err",D(),H(U()),r(f.error||"Reaction failed.");return}const p=f.data||null,k=p?.file||null;t.atlas={exists:!!k,downloaded:!!k?.downloaded,file_id:k?.id??null,reaction:p?.reaction??null},t.atlas.exists&&!t.atlas.downloaded&&i!=="dislike"?(t.status="Queued",t.statusClass="queued"):(t.status="",t.statusClass=""),D(),H(U()),t.atlas.exists&&!t.atlas.downloaded&&i!=="dislike"&&te([t.url],0)})}function Ze(){const t=S.filter(f=>f.selected);if(t.length===0){r("Select one or more items first.");return}const i=t.some(f=>!!f.atlas?.downloaded);if(i&&!window.confirm("One or more selected files are already downloaded in Atlas. Re-download them?")){r("Cancelled.");return}X.disabled=!0,u.disabled=!0,T.disabled=!0,R.disabled=!0,I.disabled=!0;for(const f of t)f.status="Sending…",f.statusClass="";D();const c=t.map(f=>{const p=Se(f);return i&&(p.force_download=!0),p});w({type:"atlas-download-batch",payloads:c},f=>{if(!f){for(const E of t)E.status="No response",E.statusClass="err";D(),H(U()),r("Atlas extension did not respond.");return}const p=Array.isArray(f.results)?f.results:[],k=[];for(let E=0;E<t.length;E+=1){const y=t[E],M=p[E];if(M?.ok){const ne=M.data||null,j=ne?.file||null;y.atlas={exists:!!j,downloaded:!!j?.downloaded,file_id:j?.id??null},ne?.queued?(y.status="Queued",y.statusClass="queued",k.push(y.url)):(y.status="",y.statusClass="")}else y.status=M?.error||"Failed",y.statusClass="err"}D(),H(U()),f.ok?r(`Queued ${t.length} download(s) in Atlas.`):r(f.error||"Some requests failed."),k.length>0&&te(k,0)})}function te(t,i){i>15||setTimeout(()=>{w({type:"atlas-check-batch",urls:t},c=>{if(!c||!c.ok){te(t,i+1);return}const f=Array.isArray(c.data?.results)?c.data.results:[],p=new Map(f.map(E=>[E.url,E]));let k=0;for(const E of S){const y=p.get(E.url);y&&(E.atlas={exists:!!y.exists,downloaded:!!y.downloaded,file_id:y.file_id??null,reaction:y.reaction??null},y.downloaded?E.status==="Queued"&&(E.status="",E.statusClass=""):k+=1)}D(),H(U()),k>0&&te(t,i+1)})},2e3)}}function Ue(e){return new Promise(n=>{const a=document.body||document.documentElement,o=Array.from(a.querySelectorAll("img, video")),r=o.length,w=new Set,l=[];let A=0;const d=m=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(m,{timeout:500});return}setTimeout(()=>m({timeRemaining:()=>25}),0)},h=m=>{const C=typeof m?.timeRemaining=="function"?m.timeRemaining():25;let _=0;for(;A<r&&(_<80||C>5);){const g=o[A];if(g.closest&&g.closest(`#${L}`)){A+=1,_+=1;continue}const s=Y(g);s?.url&&!w.has(s.url)&&(w.add(s.url),l.push(s)),A+=1,_+=1}if(e?.({scanned:A,total:r}),A<r){d(h);return}n(l)};d(h)})}function Y(e){if(!(e instanceof Element))return null;if(e.tagName==="IMG"){const n=e,a=n.naturalWidth||n.width||n.clientWidth||null,o=n.naturalHeight||n.height||n.clientHeight||null;if(a&&o&&(a<450||o<450))return null;const r=W(n.currentSrc)||W(n.src)||W(n.getAttribute("src"));return r?{tag_name:"img",url:r,preview_url:r,width:a,height:o,alt:n.alt||""}:null}if(e.tagName==="VIDEO"){const n=$e(e);return n?{tag_name:"video",url:n,preview_url:e.poster||"",width:e.videoWidth||e.clientWidth||null,height:e.videoHeight||e.clientHeight||null,alt:""}:null}return null}function $e(e){const n=W(e.currentSrc)||W(e.src)||W(e.getAttribute("src"));if(n)return n;const a=e.querySelector("source[src]"),o=a?W(a.src||a.getAttribute("src")):"";if(o)return o;const r=Be(e);return r||Pe()}function Pe(){const e=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const n of e){const o=document.querySelector(n)?.getAttribute("content"),r=W(o||"");if(r)return r}return""}function Be(e){let n=e,a=0;for(;n&&a<8;){const o=n.getAttribute?.("data-store");if(o){const r=Oe(o),w=oe(r,0);if(w)return w}n=n.parentElement,a+=1}return""}function Oe(e){if(!e)return null;const n=We(e);try{return JSON.parse(n)}catch{return null}}function We(e){return!e||typeof e!="string"?"":e.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function oe(e,n){if(!e||n>4)return"";if(typeof e=="string")return e.startsWith("http")?e:"";if(Array.isArray(e)){for(const o of e){const r=oe(o,n+1);if(r)return r}return""}if(typeof e!="object")return"";const a=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const o of a){const r=e[o];if(typeof r=="string"&&r.startsWith("http"))return r}for(const o of Object.keys(e)){const r=oe(e[o],n+1);if(r)return r}return""}function me(e){return function(a){const o=document.createElement("div");o.className="atlas-downloader-toast",o.textContent=a,e.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove(),{once:!0})},2600)}}function pe(e){return!e||typeof e!="string"?[]:e.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>re(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function we(e,n){const a=(e||"").toLowerCase();if(!a)return!1;for(const o of n)if(se(a,o))return!0;return!1}function re(e){if(!e||typeof e!="string")return"";const n=e.trim();if(!n)return"";const a=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(a).hostname}catch{return""}}function se(e,n){return!e||!n?!1:e===n||e.endsWith(`.${n}`)}function W(e){if(!e||typeof e!="string")return"";const n=e.trim();if(!n)return"";const a=n.toLowerCase();return a.startsWith("blob:")||a.startsWith("data:")||a.startsWith("chrome-extension:")||a.startsWith("moz-extension:")||a.startsWith("safari-extension:")?"":n}function ge(e){const n=e.enabled??!0,a=e.getHintShown??(()=>!1),o=e.setHintShown??(()=>{}),r=()=>{a()||(o(!0),e.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},w=l=>(typeof l.composedPath=="function"?l.composedPath():[]).some(d=>d instanceof HTMLElement&&d.id===L);document.addEventListener("click",l=>{!n||!(l instanceof MouseEvent)||!l.altKey||e.isSheetOpen()||w(l)||!((l.target instanceof Element?l.target:null)?.closest?.("img, video")??null)||(l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation())},!0),document.addEventListener("mousedown",l=>{if(!n||!(l instanceof MouseEvent)||!l.altKey||e.isSheetOpen()||w(l))return;const d=(l.target instanceof Element?l.target:null)?.closest?.("img, video")??null;if(!d)return;const h=l.button===0?"like":l.button===1?"love":null;if(!h)return;r(),l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation();const m=Y(d);if(!m){if(d instanceof HTMLVideoElement){const _=(d.currentSrc||d.src||"").trim().toLowerCase();if(_.startsWith("blob:")||_.startsWith("data:")){const g=window.location.href,s=`${g}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,u={type:h,url:g,original_url:s,referrer_url:g,page_title:x(document.title,500),tag_name:"video",width:d.videoWidth||d.clientWidth||null,height:d.videoHeight||d.clientHeight||null,alt:"",preview_url:d.poster||"",source:O(g),download_via:"yt-dlp"};G(e.sendMessageSafe,u.url,T=>{if(T?.downloaded){if(!window.confirm("This file is already downloaded in Atlas. Re-download it?")){e.showToast("Cancelled.");return}u.force_download=!0}e.sendMessageSafe({type:"atlas-react",payload:u},b=>{if(!b||!b.ok){e.showToast(b?.error||"Reaction failed.");return}const v=b.data||null,$=v?.file||null,R=v?.reaction?.type?String(v.reaction.type):h;F.set(u.url,{exists:!!$,downloaded:!!$?.downloaded,reactionType:R,ts:Date.now()}),e.showToast(`Reacted (${h}). Resolving video in Atlas…`)})});return}e.showToast("No direct video URL found.");return}e.showToast("No valid media URL found.");return}const C={type:h,url:m.url,original_url:m.url,referrer_url:window.location.href,page_title:x(document.title,500),tag_name:m.tag_name,width:m.width,height:m.height,alt:x(m.alt||"",500),preview_url:m.preview_url||"",source:O(m.url)};G(e.sendMessageSafe,C.url,_=>{if(_?.downloaded){if(!window.confirm("This file is already downloaded in Atlas. Re-download it?")){e.showToast("Cancelled.");return}C.force_download=!0}e.sendMessageSafe({type:"atlas-react",payload:C},g=>{if(!g||!g.ok){e.showToast(g?.error||"Reaction failed.");return}const s=g.data||null,u=s?.file||null,T=s?.reaction?.type?String(s.reaction.type):h;F.set(C.url,{exists:!!u,downloaded:!!u?.downloaded,reactionType:T,ts:Date.now()}),e.showToast(`Reacted (${h}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",l=>{if(!n||!(l instanceof MouseEvent)||!l.altKey||e.isSheetOpen()||w(l))return;const d=(l.target instanceof Element?l.target:null)?.closest?.("img, video")??null;if(!d)return;r(),l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation();const h=Y(d);if(!h){if(d instanceof HTMLVideoElement){const C=(d.currentSrc||d.src||"").trim().toLowerCase();if(C.startsWith("blob:")||C.startsWith("data:")){const _=window.location.href,g=`${_}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,s={type:"dislike",url:_,original_url:g,referrer_url:_,page_title:x(document.title,500),tag_name:"video",width:d.videoWidth||d.clientWidth||null,height:d.videoHeight||d.clientHeight||null,alt:"",preview_url:d.poster||"",source:O(_),download_via:"yt-dlp"};e.sendMessageSafe({type:"atlas-react",payload:s},u=>{if(!u||!u.ok){e.showToast(u?.error||"Reaction failed.");return}e.showToast("Disliked.")});return}e.showToast("No direct video URL found.");return}e.showToast("No valid media URL found.");return}const m={type:"dislike",url:h.url,original_url:h.url,referrer_url:window.location.href,page_title:x(document.title,500),tag_name:h.tag_name,width:h.width,height:h.height,alt:x(h.alt||"",500),preview_url:h.preview_url||"",source:O(h.url)};e.sendMessageSafe({type:"atlas-react",payload:m},C=>{if(!C||!C.ok){e.showToast(C?.error||"Reaction failed.");return}e.showToast("Disliked.")})},!0)}function ye(e,n,a){return e<n?n:e>a?a:e}function Ae(e,n){const a=Y(e);if(a)return{type:n,url:a.url,original_url:a.url,referrer_url:window.location.href,page_title:x(document.title,500),tag_name:a.tag_name,width:a.width,height:a.height,alt:x(a.alt||"",500),preview_url:a.preview_url||"",source:O(a.url)};if(e instanceof HTMLVideoElement){const o=(e.currentSrc||e.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const r=window.location.href,w=`${r}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`;return{type:n,url:r,original_url:w,referrer_url:r,page_title:x(document.title,500),tag_name:"video",width:e.videoWidth||e.clientWidth||null,height:e.videoHeight||e.clientHeight||null,alt:"",preview_url:e.poster||"",source:O(r),download_via:"yt-dlp"}}}return null}function be(e){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");let a=null,o=null,r=null;const w=new Map,l=s=>{for(const u of ae){const T=w.get(u.type);T&&T.classList.toggle("active",s===u.type)}},A=()=>{r&&(window.clearTimeout(r),r=null)},d=()=>{a=null,o=null,n.classList.remove("open"),n.style.left="",n.style.top="",l(null)},h=()=>{A(),r=window.setTimeout(()=>{n.matches(":hover")||d()},140)},m=s=>{s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation?.()};for(const s of ae){const u=document.createElement("button");u.type="button",u.className=`atlas-downloader-reaction-btn ${s.className}`.trim(),u.setAttribute("aria-label",s.label),u.title=s.label,u.replaceChildren(ue(s.pathDs)),w.set(s.type,u),u.addEventListener("pointerdown",m,!0),u.addEventListener("mousedown",m,!0),u.addEventListener("click",T=>{if(m(T),!a){e.showToast("No media selected.");return}const b=Ae(a,s.type);if(!b){e.showToast("No valid media URL found.");return}const v=b.url||"";G(e.sendMessageSafe,v,$=>{if(s.type!=="dislike"&&$?.downloaded){if(!window.confirm("This file is already downloaded in Atlas. Re-download it?")){e.showToast("Cancelled.");return}b.force_download=!0}e.sendMessageSafe({type:"atlas-react",payload:b},R=>{if(!R||!R.ok){e.showToast(R?.error||"Reaction failed.");return}const I=R.data||null,Q=I?.file||null,X=I?.reaction?.type?String(I.reaction.type):s.type;if(v&&F.set(v,{exists:!!Q,downloaded:!!Q?.downloaded,reactionType:X,ts:Date.now()}),l(X),b.download_via==="yt-dlp"){e.showToast(`Reacted (${s.type}). Resolving video in Atlas…`);return}e.showToast(`Reacted (${s.type}). Queued download in Atlas.`)})})}),n.appendChild(u)}e.root.appendChild(n);const C=s=>(typeof s.composedPath=="function"?s.composedPath():[]).some(T=>T instanceof HTMLElement&&T.id===L),_=()=>{if(!a)return;const s=a.getBoundingClientRect();if(!Number.isFinite(s.left)||s.width<=0||s.height<=0){d();return}const u=ye(s.top+8,8,window.innerHeight-8),T=ye(s.right-8,8,window.innerWidth-8);n.style.top=`${u}px`,n.style.left=`${T}px`},g=s=>{if(e.isSheetOpen()){d();return}const u=Ae(s,"like");if(!u){d();return}if(a=s,o=u.url||null,n.classList.add("open"),_(),l(null),o){const T=fe(o);if(T)l(T.reactionType);else{const b=o;G(e.sendMessageSafe,b,v=>{v&&o===b&&l(v.reactionType)})}}};document.addEventListener("pointerover",s=>{if(e.isSheetOpen()||!(s.target instanceof Element)||C(s))return;const u=s.target.closest?.("img, video")??null;u&&(A(),g(u))},!0),document.addEventListener("pointerout",s=>{!a||e.isSheetOpen()||!(s.target instanceof Element)||C(s)||!(s.target.closest?.("img, video")??null)||h()},!0),n.addEventListener("pointerenter",A,!0),n.addEventListener("pointerleave",h,!0),window.addEventListener("scroll",_,!0),window.addEventListener("resize",_),window.addEventListener("blur",d)}})()})();
