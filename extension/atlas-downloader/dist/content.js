(function(){"use strict";const tt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function nt(l){const d=(l||"").trim().toLowerCase();if(!d)return"";const o=d.split(".").filter(Boolean);if(o.length<=2)return d;const y=o.slice(-2).join("."),E=o.slice(-3).join(".");return tt.has(y)&&o.length>=3?E:y}function at(l){const d=(l||"").trim();if(!d)return"";try{const o=new URL(d).hostname;return nt(o)}catch{return""}}function ot(l,d){if(!l||typeof l!="string")return"";const o=l.trim();if(!o)return"";const y=o.toLowerCase();if(y.startsWith("blob:")||y.startsWith("data:")||y.startsWith("chrome-extension:")||y.startsWith("moz-extension:")||y.startsWith("safari-extension:"))return"";try{const E=new URL(o,d);return E.protocol!=="http:"&&E.protocol!=="https:"?"":E.toString()}catch{return""}}function lt(l){return/\.(gif|webp)(\?|#|$)/i.test(l||"")}function rt(l){let d=l,o=0;for(;d&&o<24;){const y=d.getAttribute?.("role");if(y==="dialog"||y==="alertdialog"||d.getAttribute?.("aria-modal")==="true")return!0;const j=(d.getAttribute?.("class")||"").toLowerCase(),se=(d.getAttribute?.("id")||"").toLowerCase(),ue=`${j} ${se}`.trim();if(ue&&/(modal|lightbox|overlay|dialog)/.test(ue))return!0;const Q=window.getComputedStyle(d);if((Q.position==="fixed"||Q.position==="sticky")&&it(d))return!0;d=d.parentElement,o+=1}return!1}function st(l,d){return!!(lt(d)||rt(l))}function it(l){const d=l.getBoundingClientRect();if(d.width>0&&d.height>0){const o=Math.max(window.innerWidth*.4,320),y=Math.max(window.innerHeight*.4,240);return d.width>=o&&d.height>=y}if(l instanceof HTMLElement){const o=l.style,y=o.inset==="0"||o.inset==="0px"||(o.top==="0"||o.top==="0px")&&(o.left==="0"||o.left==="0px")&&(o.right==="0"||o.right==="0px")&&(o.bottom==="0"||o.bottom==="0px"),E=/^(100vw|100%)$/i.test(o.width||"")||/^(100vh|100%)$/i.test(o.height||"");return y||E}return!1}function Y(l){return ot(l,window.location.href)}function Ne(l){const d=Y(l.currentSrc)||Y(l.src)||Y(l.getAttribute("src")||"");if(d)return d;const o=l.querySelector("source[src]"),y=o?Y(o.src||o.getAttribute("src")||""):"";if(y)return y;const E=ut(l);return E||ct()}function be(l,d){if(!(l instanceof Element))return null;if(l.tagName==="IMG"){const o=l,y=o.naturalWidth||o.width||o.clientWidth||null,E=o.naturalHeight||o.height||o.clientHeight||null,j=(o.currentSrc||o.src||o.getAttribute("src")||"").trim(),se=Y(j);if(!st(o,se||j)&&y&&E&&(y<d||E<d))return null;if(!se){const ue=Y(document.referrer)||Y(window.location.href)||"";return!ue||!j.toLowerCase().startsWith("blob:")&&!j.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:ue,referrer_url:window.location.href,preview_url:"",width:y,height:E,alt:o.alt||""}}return{tag_name:"img",url:se,referrer_url:window.location.href,preview_url:se,width:y,height:E,alt:o.alt||""}}if(l.tagName==="VIDEO"){const o=l,y=Ne(o);if(!y){const E=(o.currentSrc||o.src||"").trim().toLowerCase();if(E.startsWith("blob:")||E.startsWith("data:")){const j=window.location.href;return{tag_name:"video",url:j,referrer_url:j,preview_url:o.poster||"",width:o.videoWidth||o.clientWidth||null,height:o.videoHeight||o.clientHeight||null,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:y,referrer_url:window.location.href,preview_url:o.poster||"",width:o.videoWidth||o.clientWidth||null,height:o.videoHeight||o.clientHeight||null,alt:""}}return null}function De(){const l=(window.location.href||"").trim();if(!l)return null;const d=l.toLowerCase(),o=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(d),y=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!o&&!y)return null;if(d.startsWith("http://")||d.startsWith("https://"))return{tag_name:d.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:l,referrer_url:l,preview_url:l,width:null,height:null,alt:""};if(d.startsWith("blob:")||d.startsWith("data:")){const E=Y(document.referrer)||"";return E?{tag_name:"img",url:E,referrer_url:l,preview_url:"",width:null,height:null,alt:""}:null}return null}function Be(l){const d=new Set,o=Y(window.location.href),y=l instanceof HTMLImageElement?Y(l.currentSrc)||Y(l.src)||"":l instanceof HTMLVideoElement?Ne(l)||"":l instanceof HTMLAnchorElement&&Re(l.getAttribute("href")||"")||"";y&&d.add(y);const E=l.closest("a[href]")?.getAttribute("href")??"",j=Re(E);return j&&d.add(j),o&&dt(l)&&d.add(o),[...d]}function Re(l){const d=(l||"").trim();return!d||d.startsWith("#")||d.toLowerCase().startsWith("javascript:")?"":Y(d)}function dt(l){if(l instanceof HTMLImageElement){const d=(l.currentSrc||l.src||l.getAttribute("src")||"").trim().toLowerCase();return d.startsWith("blob:")||d.startsWith("data:")}if(l instanceof HTMLVideoElement){const d=(l.currentSrc||l.src||"").trim().toLowerCase();return d.startsWith("blob:")||d.startsWith("data:")}return!1}function ct(){const l=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const d of l){const y=document.querySelector(d)?.getAttribute("content")||"",E=Y(y);if(E)return E}return""}function ut(l){let d=l,o=0;for(;d&&o<8;){const y=d.getAttribute?.("data-store");if(y){const E=ft(y),j=Le(E,0);if(j)return j}d=d.parentElement,o+=1}return""}function ft(l){if(!l)return null;const d=pt(l);try{return JSON.parse(d)}catch{return null}}function pt(l){return!l||typeof l!="string"?"":l.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Le(l,d){if(!l||d>4)return"";if(typeof l=="string")return l.startsWith("http")?l:"";if(Array.isArray(l)){for(const o of l){const y=Le(o,d+1);if(y)return y}return""}if(typeof l=="object")for(const o of Object.keys(l)){const y=l[o],E=Le(y,d+1);if(E)return E}return""}(()=>{const o="atlas-downloader-root",y="atlas-open",E=(()=>{try{return window.top===window.self}catch{return!1}})(),j=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let se=null;const ue=3e4,Q=new Map,He="http://www.w3.org/2000/svg",ye=t=>{const n=document.createElementNS(He,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const h of t){const f=document.createElementNS(He,"path");f.setAttribute("d",h),f.setAttribute("fill","none"),f.setAttribute("stroke","currentColor"),f.setAttribute("stroke-width","2"),f.setAttribute("stroke-linecap","round"),f.setAttribute("stroke-linejoin","round"),n.appendChild(f)}return n},ke=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],q={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},$e="atlas-downloader-page-markers";function G(t,n){const h=typeof t=="string"?t:"";return h.length<=n?h:h.slice(0,n)}function fe(t){return at(t)||"Extension"}function Ce(t){const n=Q.get(t);return n?Date.now()-n.ts>ue?(Q.delete(t),null):n:null}function Ae(t,n,h){if(!n){h(null);return}const f=Ce(n);if(f){h(f);return}t({type:"atlas-check-batch",urls:[n]},u=>{if(!u||!u.ok){h(null);return}const A=Array.isArray(u.data?.results)?u.data.results:[],L=A.find(B=>B?.url===n)??A[0]??null;if(!L){h(null);return}const m={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,reactionType:L.reaction?.type?String(L.reaction.type):null,ts:Date.now()};Q.set(n,m),h(m)})}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&E)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],h=>{const f=Te(h.atlasBaseUrl||"");if(f&&Se(window.location.hostname,f))return;const u=Ie(h.atlasExcludedDomains||"");Oe(window.location.hostname,u)||(Pe(),se?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const n=Te(t.atlasBaseUrl||"");if(n&&Se(window.location.hostname,n))return;const h=Ie(t.atlasExcludedDomains||"");Oe(window.location.hostname,h)||(E?Pe():ht())});function ht(){if(document.getElementById(o))return;const t=document.createElement("div");t.id=o;const n=t.attachShadow({mode:"closed"}),h=document.createElement("link");h.rel="stylesheet",h.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(h);const f=document.createElement("div");f.className="atlas-shadow-root";const u=Ue(f),A=We(f),L=(m,B)=>{try{chrome.runtime.sendMessage(m,B)}catch(r){(()=>{if(r instanceof Error)return r.message;if(r&&typeof r=="object"&&"message"in r){const C=r.message;return typeof C=="string"?C:String(C)}return String(r)})().includes("Extension context invalidated")?u("Atlas extension was reloaded. Refresh this tab.","danger"):u("Atlas extension error. Refresh this tab.","danger"),B(null)}};n.appendChild(f),(document.body||document.documentElement).appendChild(t),je({showToast:u,sendMessageSafe:L,isSheetOpen:()=>!1,chooseDialog:A}),Fe({root:f,showToast:u,sendMessageSafe:L,isSheetOpen:()=>!1,chooseDialog:A})}function Pe(){if(document.getElementById(o))return;const t=document.createElement("div");t.id=o;const n=t.attachShadow({mode:"closed"}),h=document.createElement("link");h.rel="stylesheet",h.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(h);const f=document.createElement("div");f.className="atlas-shadow-root";const u=Ue(f),A=(e,i)=>{try{chrome.runtime.sendMessage(e,i)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const p=a.message;return typeof p=="string"?p:String(p)}return String(a)})().includes("Extension context invalidated")?u("Atlas extension was reloaded. Refresh this tab.","danger"):u("Atlas extension error. Refresh this tab.","danger"),i(null)}},L=document.createElement("button");L.className="atlas-downloader-toggle",L.type="button",L.setAttribute("aria-label","Atlas Downloader"),L.title="Atlas Downloader";const m=document.createElement("img");m.alt="",m.src=chrome.runtime.getURL("icon.svg"),L.appendChild(m);const B=document.createElement("div");B.className="atlas-downloader-overlay";const r=document.createElement("div");r.className="atlas-downloader-modal",r.setAttribute("role","dialog"),r.setAttribute("aria-modal","true"),r.setAttribute("aria-label","Atlas Media Picker");const b=document.createElement("div");b.className="atlas-downloader-header";const C=document.createElement("div");C.className="atlas-downloader-title",C.textContent="Atlas Media Picker";const $=document.createElement("div");$.className="atlas-downloader-version",$.textContent=j?`v${j}`:"";const R=document.createElement("button");R.type="button",R.className="atlas-downloader-close",R.setAttribute("aria-label","Close"),R.textContent="x",b.appendChild(C),b.appendChild($),b.appendChild(R);const T=document.createElement("div");T.className="atlas-downloader-toolbar";const _=X("Rescan",()=>ge()),I=X("Check Atlas",()=>Ye(!1)),P=X("Select all",()=>Ve(!0)),O=X("Select none",()=>Ve(!1)),Z=document.createElement("span");Z.className="spacer";const J=X("Queue selected",()=>_t(),{primary:!0});T.appendChild(_),T.appendChild(I),T.appendChild(P),T.appendChild(O),T.appendChild(Z),T.appendChild(J);const ee=document.createElement("div");ee.className="atlas-downloader-meta";const ie=document.createElement("div");ie.className="atlas-downloader-list",r.appendChild(b),r.appendChild(T),r.appendChild(ee),r.appendChild(ie),f.appendChild(L),f.appendChild(B),f.appendChild(r),n.appendChild(f),(document.body||document.documentElement).appendChild(t);const oe=We(f);let M=[],me=0,de=null,he=null,s=null;const v=!0;let S=!1;L.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),D()}),B.addEventListener("click",()=>U()),R.addEventListener("click",()=>U()),document.addEventListener("keydown",e=>{const i=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&i==="a"){e.preventDefault(),D();return}if(e.key==="Escape"&&f.classList.contains(y)){U();return}if(!f.classList.contains(y))return;const a=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!a)return;const c=M.find(p=>p.selected)??M[0]??null;c&&(e.preventDefault(),xe(c,a,{closeOnSuccess:!0}))});function F(){f.classList.add(y),ge()}function D(){if(f.classList.contains(y)){U();return}F()}function U(){f.classList.remove(y)}se=D,je({showToast:u,sendMessageSafe:A,isSheetOpen:()=>f.classList.contains(y),chooseDialog:oe,setHintShown:e=>{S=e},getHintShown:()=>S,enabled:v}),Fe({root:f,showToast:u,sendMessageSafe:A,isSheetOpen:()=>f.classList.contains(y),chooseDialog:oe});const K=(e=300)=>{s!==null&&window.clearTimeout(s),s=window.setTimeout(()=>{s=null,Ct()},e)};new MutationObserver(()=>{ce(M),K(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>K(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&K(120)},!0),K(120);function X(e,i,a){const c=document.createElement("button");return c.type="button",c.className=`atlas-downloader-btn${a?.primary?" primary":""}`,c.textContent=e,c.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),i()}),c}function le(e){ee.textContent=e,J.disabled=!0,_.disabled=!0,I.disabled=!0,P.disabled=!0,O.disabled=!0}function W(e){ee.textContent=e;const i=M.filter(c=>c.selected).length,a=de!==null;J.disabled=i===0||a,_.disabled=a,I.disabled=M.length===0||a,P.disabled=M.length===0||a,O.disabled=M.length===0||a}function ge(){me+=1;const e=me;M=[],he=null,ie.replaceChildren(),le("Scanning this page…"),mt(i=>{me===e&&(ee.textContent=`Scanning… ${i.scanned}/${i.total}`)}).then(i=>{me===e&&(M=i.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),z(),W(V()),Ye(!0))})}function Ve(e){for(const i of M)i.selected=e;z(),W(V())}function z(){if(ie.replaceChildren(),M.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",ie.appendChild(e);return}for(const e of M)ie.appendChild(wt(e))}function wt(e){const i=document.createElement("div");i.className=`atlas-downloader-item${e.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=e.selected,a.addEventListener("change",()=>{e.selected=a.checked,i.classList.toggle("selected",e.selected),W(V())});const c=document.createElement("div");if(c.className="atlas-downloader-preview",e.preview_url){const x=document.createElement("img");x.loading="lazy",x.alt="",x.src=e.preview_url,c.appendChild(x)}const p=document.createElement("div");p.className="atlas-downloader-info";const g=document.createElement("div");g.className="atlas-downloader-kind",g.textContent=e.tag_name;const k=document.createElement("div");k.className="atlas-downloader-url",k.textContent=e.url,k.title=e.url;const w=document.createElement("div");w.className="atlas-downloader-sub",w.textContent=kt(e);const N=document.createElement("div");N.className="atlas-downloader-reactions";const H=e.atlas?.reaction?.type||null,ne=de!==null||!!e.reactionQueued;for(const x of ke){const te=document.createElement("button");te.type="button",te.className=`atlas-downloader-reaction-btn ${x.className}${H===x.type?" active":""}${e.reactionPending===x.type?" pending":""}${e.reactionQueued===x.type?" queued":""}`.trim(),te.setAttribute("aria-label",x.label),te.title=x.label,te.replaceChildren(ye(x.pathDs)),te.disabled=ne,te.addEventListener("click",et=>{et.preventDefault(),et.stopPropagation(),xe(e,x.type)}),N.appendChild(te)}const ae=document.createElement("button");if(ae.type="button",ae.className=`atlas-downloader-reaction-btn ${q.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===q.type?" pending":""}${e.reactionQueued===q.type?" queued":""}`.trim(),ae.setAttribute("aria-label",q.label),ae.title=q.label,ae.replaceChildren(ye(q.pathDs)),ae.disabled=ne,ae.addEventListener("click",x=>{x.preventDefault(),x.stopPropagation(),xe(e,"dislike",{blacklist:!0})}),N.appendChild(ae),e.atlas?.downloaded){const x=document.createElement("button");x.type="button",x.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),x.setAttribute("aria-label","Delete download"),x.title="Delete download",x.replaceChildren(ye(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),x.disabled=ne,x.addEventListener("click",te=>{te.preventDefault(),te.stopPropagation(),Et(e)}),N.appendChild(x)}const re=document.createElement("button");re.type="button",re.className=`atlas-downloader-debug-toggle${he===e.url?" active":""}`,re.textContent=he===e.url?"Hide debug":"Debug",re.addEventListener("click",x=>{x.preventDefault(),x.stopPropagation(),he=he===e.url?null:e.url,z(),W(V())}),N.appendChild(re),p.appendChild(g),p.appendChild(k),p.appendChild(w),p.appendChild(N),he===e.url&&p.appendChild(bt(e));const Me=document.createElement("div"),Ge=vt(e);return Me.className=`atlas-downloader-status ${Ge.className}`.trim(),Me.textContent=Ge.text,i.addEventListener("click",x=>{x.target instanceof HTMLInputElement||(e.selected=!e.selected,a.checked=e.selected,i.classList.toggle("selected",e.selected),W(V()))}),i.appendChild(a),i.appendChild(c),i.appendChild(p),i.appendChild(Me),i}function Ke(e,i){return{type:i,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:G(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:G(e.alt||"",500),preview_url:e.preview_url||"",source:fe(e.url),...e.download_via?{download_via:e.download_via}:{}}}function Xe(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:G(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:G(e.alt||"",500),preview_url:e.preview_url||"",source:fe(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function bt(e){const i=document.createElement("details");i.className="atlas-downloader-debug",i.open=!0;const a=document.createElement("summary");a.textContent="Debug payload",i.appendChild(a);const c={react:Ke(e,e.atlas?.reaction?.type||"like"),download:Xe(e)};return i.appendChild(yt(c)),i}function yt(e,i=0){const a=document.createElement("div");a.className="atlas-downloader-json-tree";const c=ve(e);if(!Ze(c)){const g=document.createElement("div");return g.className="atlas-downloader-json-line",g.textContent=Je(c),a.appendChild(g),a}const p=Array.isArray(c)?c.map((g,k)=>[String(k),g]):Object.entries(c);for(const[g,k]of p)a.appendChild(ze(g,k,i));return a}function ze(e,i,a){const c=ve(i),p=document.createElement("div");if(p.className="atlas-downloader-json-line",p.style.paddingLeft=`${a*12}px`,!Ze(c))return p.innerHTML=`<span class="atlas-downloader-json-key">${Ee(e)}</span>: <span class="atlas-downloader-json-value">${Ee(Je(c))}</span>`,p;const g=document.createElement("details");g.className="atlas-downloader-json-node",g.open=a===0;const k=document.createElement("summary");k.style.paddingLeft=`${a*12}px`;const w=Array.isArray(c)?`[${c.length}]`:`{${Object.keys(c).length}}`;k.innerHTML=`<span class="atlas-downloader-json-key">${Ee(e)}</span>: <span class="atlas-downloader-json-preview">${Ee(w)}</span>`,g.appendChild(k);const N=Array.isArray(c)?c.map((H,ne)=>[String(ne),H]):Object.entries(c);for(const[H,ne]of N)g.appendChild(ze(H,ne,a+1));return g}function ve(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(a=>ve(a));if(!e||typeof e!="object")return null;const i={};for(const[a,c]of Object.entries(e))i[a]=ve(c);return i}function Ze(e){return Array.isArray(e)||e&&typeof e=="object"}function Je(e){return JSON.stringify(e)}function Ee(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function kt(e){const i=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",a=At(e.url);return a?`${i} • ${a}`:i}function At(e){try{return new URL(e).hostname}catch{return""}}function V(){const e=M.filter(i=>i.selected).length;return`${M.length} found • ${e} selected`}function vt(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Ye(e){const i=M.map(a=>a.url).filter(Boolean);i.length!==0&&A({type:"atlas-check-batch",urls:i},a=>{if(!a){e||u("Atlas extension did not respond.","danger");return}if(!a.ok){e||u(a.error||"Atlas check failed.","danger");return}const c=Array.isArray(a.data?.results)?a.data.results:[],p=new Map(c.map(w=>[w.url,w]));let g=0,k=0;for(const w of M){const N=p.get(w.url);N&&(w.atlas={exists:!!N.exists,downloaded:!!N.downloaded,blacklisted:!!N.blacklisted,file_id:N.file_id??null,reaction:N.reaction??null},w.atlas.exists&&!w.atlas.downloaded&&w.atlas.reaction?.type&&w.atlas.reaction.type!=="dislike"?w.reactionQueued=w.atlas.reaction.type:w.reactionQueued=null,N.exists&&(g+=1),N.downloaded&&(k+=1))}z(),W(V()),ce(M),e||u(`Atlas check: ${k}/${g} downloaded.`)})}function xe(e,i,a={}){const c=(g={})=>{e.reactionPending=a.blacklist?q.type:i,e.status="Reacting…",e.statusClass="",de=e.url,z(),W(V());const k={...Ke(e,i),...g,...a.blacklist?{blacklist:!0}:{}};A({type:"atlas-react",payload:k},w=>{if(e.reactionPending=null,de=null,!w){e.status="No response",e.statusClass="err",z(),W(V()),u("Atlas extension did not respond.","danger");return}if(!w.ok){e.status=w.error||"Failed",e.statusClass="err",z(),W(V()),u(w.error||"Reaction failed.","danger");return}const N=w.data||null,H=N?.file||null;e.atlas={exists:!!H,downloaded:!!H?.downloaded,blacklisted:!!H?.blacklisted_at,file_id:H?.id??null,reaction:N?.reaction??null},Q.set(e.url,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&i!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=a.blacklist?q.type:i):(e.status="",e.statusClass="",e.reactionQueued=null),z(),W(V()),ce(M),a.closeOnSuccess&&U(),e.atlas.exists&&!e.atlas.downloaded&&i!=="dislike"&&_e([e.url],0)})},p=!!e.atlas?.reaction?.type;if(i!=="dislike"&&e.atlas?.downloaded&&p){oe({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(g=>{c(g==="confirm"?{force_download:!0}:{})});return}if(i==="dislike"&&e.atlas?.downloaded){oe({title:a.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(g=>{if(g==="alternate"){u("Cancelled.");return}c(g==="confirm"?{clear_download:!0}:{})});return}c()}function Et(e){oe({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(i=>{i==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",de=e.url,z(),W(V()),A({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},a=>{if(e.reactionPending=null,de=null,!a||!a.ok){e.status=a?.error||"Failed",e.statusClass="err",z(),W(V()),u(a?.error||"Delete failed.","danger");return}const c=a.data?.file||null;e.atlas={exists:!!c,downloaded:!!c?.downloaded,blacklisted:!!c?.blacklisted_at,file_id:c?.id??null,reaction:null},e.reactionQueued=null,Q.set(e.url,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",z(),W(V()),ce(M),u("Download deleted.")}))})}function _t(){const e=M.filter(c=>c.selected);if(e.length===0){u("Select one or more items first.");return}if(e.some(c=>!!c.atlas?.downloaded)){oe({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(c=>{if(c==="alternate"){u("Cancelled.");return}a(c==="confirm")});return}a(!1);function a(c){J.disabled=!0,_.disabled=!0,I.disabled=!0,P.disabled=!0,O.disabled=!0;for(const g of e)g.status="Sending…",g.statusClass="";z();const p=e.map(g=>{const k=Xe(g);return c&&(k.force_download=!0),k});A({type:"atlas-download-batch",payloads:p},g=>{if(!g){for(const N of e)N.status="No response",N.statusClass="err";z(),W(V()),u("Atlas extension did not respond.","danger");return}const k=Array.isArray(g.results)?g.results:[],w=[];for(let N=0;N<e.length;N+=1){const H=e[N],ne=k[N];if(ne?.ok){const ae=ne.data||null,re=ae?.file||null;H.atlas={exists:!!re,downloaded:!!re?.downloaded,blacklisted:!!re?.blacklisted_at,file_id:re?.id??null,reaction:H.atlas?.reaction??null},ae?.queued?(H.status="Queued",H.statusClass="queued",H.atlas?.reaction?.type&&H.atlas.reaction.type!=="dislike"&&(H.reactionQueued=H.atlas.reaction.type),w.push(H.url)):(H.status="",H.statusClass="",H.reactionQueued=null)}else H.status=ne?.error||"Failed",H.statusClass="err"}z(),W(V()),ce(M),g.ok?u(`Queued ${e.length} download(s) in Atlas.`):u(g.error||"Some requests failed.","danger"),w.length>0&&_e(w,0)})}}function _e(e,i){i>15||setTimeout(()=>{A({type:"atlas-check-batch",urls:e},a=>{if(!a||!a.ok){_e(e,i+1);return}const c=Array.isArray(a.data?.results)?a.data.results:[],p=new Map(c.map(k=>[k.url,k]));let g=0;for(const k of M){const w=p.get(k.url);w&&(k.atlas={exists:!!w.exists,downloaded:!!w.downloaded,blacklisted:!!w.blacklisted,file_id:w.file_id??null,reaction:w.reaction??null},w?.url&&Q.set(String(w.url),{exists:!!w.exists,downloaded:!!w.downloaded,blacklisted:!!w.blacklisted,reactionType:w.reaction?.type?String(w.reaction.type):null,ts:Date.now()}),k.atlas.exists&&!k.atlas.downloaded&&k.atlas.reaction?.type&&k.atlas.reaction.type!=="dislike"?k.reactionQueued=k.atlas.reaction.type:k.reactionQueued=null,w.downloaded?k.status==="Queued"&&(k.status="",k.statusClass=""):g+=1)}z(),W(V()),ce(M),g>0&&_e(e,i+1)})},2e3)}function ce(e=M){gt();const i=document.querySelectorAll('[data-atlas-marked="1"]');for(const p of i)p.removeAttribute("data-atlas-marked"),p.removeAttribute("data-atlas-state"),p.removeAttribute("data-atlas-reaction");const a=new Map;for(const[p,g]of Q.entries()){if(Date.now()-g.ts>ue){Q.delete(p);continue}a.set(p,{exists:!!g.exists,downloaded:!!g.downloaded,blacklisted:!!g.blacklisted,reactionType:g.reactionType?String(g.reactionType):null}),a.set(we(p),{exists:!!g.exists,downloaded:!!g.downloaded,blacklisted:!!g.blacklisted,reactionType:g.reactionType?String(g.reactionType):null})}for(const p of e){if(!p?.url||!p?.atlas)continue;const g=p.atlas?.reaction?.type?String(p.atlas.reaction.type):null,k={exists:!!p.atlas.exists,downloaded:!!p.atlas.downloaded,blacklisted:!!p.atlas.blacklisted,reactionType:g};a.set(p.url,k),a.set(we(p.url),k)}if(a.size===0)return;const c=document.querySelectorAll("img, video, a[href]");for(const p of c){const g=Be(p);if(g.length===0)continue;const k=g.map(w=>a.get(w)||a.get(we(w))).find(w=>!!(w&&(w.exists||w.downloaded||w.blacklisted||w.reactionType)))??null;k&&(p.setAttribute("data-atlas-marked","1"),k.blacklisted?p.setAttribute("data-atlas-state","blacklisted"):k.downloaded?p.setAttribute("data-atlas-state","downloaded"):k.reactionType?p.setAttribute("data-atlas-state","reacted"):k.exists&&p.setAttribute("data-atlas-state","exists"),k.reactionType&&p.setAttribute("data-atlas-reaction",k.reactionType))}}function Lt(){const e=new Set,i=document.querySelectorAll("img, video, a[href]");for(const c of i)for(const p of Be(c))e.add(p),e.add(we(p));const a=De();return a?.url&&(e.add(a.url),e.add(we(a.url))),[...e].filter(Boolean)}function Ct(){const e=Lt();if(e.length===0){ce(M);return}A({type:"atlas-check-batch",urls:e},i=>{if(!i?.ok){ce(M);return}const a=Array.isArray(i.data?.results)?i.data.results:[];for(const c of a)c?.url&&Q.set(String(c.url),{exists:!!c.exists,downloaded:!!c.downloaded,blacklisted:!!c.blacklisted,reactionType:c.reaction?.type?String(c.reaction.type):null,ts:Date.now()});ce(M)})}}function mt(t){return new Promise(n=>{const h=document.body||document.documentElement,f=Array.from(h.querySelectorAll("img, video")),u=f.length,A=new Set,L=[];let m=0;const B=b=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(b,{timeout:500});return}setTimeout(()=>b({timeRemaining:()=>25}),0)},r=b=>{const C=typeof b?.timeRemaining=="function"?b.timeRemaining():25;let $=0;for(;m<u&&($<80||C>5);){const T=f[m];if(T.closest&&T.closest(`#${o}`)){m+=1,$+=1;continue}const _=be(T,450);_?.url&&!A.has(_.url)&&(A.add(_.url),L.push(_)),m+=1,$+=1}if(t?.({scanned:m,total:u}),m<u){B(r);return}const R=De();R&&!A.has(R.url)&&(A.add(R.url),L.push(R)),n(L)};B(r)})}function Ue(t){return function(h,f="info"){const u=document.createElement("div");u.className=`atlas-downloader-toast${f==="danger"?" danger":""}`,u.textContent=h,t.appendChild(u),requestAnimationFrame(()=>u.classList.add("show")),setTimeout(()=>{u.classList.remove("show"),u.addEventListener("transitionend",()=>u.remove(),{once:!0})},2600)}}function We(t){return n=>new Promise(h=>{const f=document.createElement("div");f.className="atlas-downloader-dialog-backdrop";const u=document.createElement("div");u.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),u.setAttribute("role","dialog"),u.setAttribute("aria-modal","true"),u.setAttribute("aria-label",n.title);const A=document.createElement("h3");A.className="atlas-downloader-dialog-title",A.textContent=n.title;const L=document.createElement("p");L.className="atlas-downloader-dialog-message",L.textContent=n.message;const m=document.createElement("div");m.className="atlas-downloader-dialog-actions";const B=C=>{f.remove(),h(C)};if(n.alternateLabel){const C=document.createElement("button");C.type="button",C.className="atlas-downloader-dialog-btn secondary",C.textContent=n.alternateLabel,C.addEventListener("click",()=>B("alternate")),m.appendChild(C)}const r=document.createElement("button");r.type="button",r.className="atlas-downloader-dialog-btn",r.textContent=n.cancelLabel||"Cancel",r.addEventListener("click",()=>B("cancel")),m.appendChild(r);const b=document.createElement("button");b.type="button",b.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),b.textContent=n.confirmLabel,b.addEventListener("click",()=>B("confirm")),m.appendChild(b),u.appendChild(A),u.appendChild(L),u.appendChild(m),f.appendChild(u),t.appendChild(f),requestAnimationFrame(()=>{b.focus()})})}function gt(){if(document.getElementById($e))return;const t=document.createElement("style");t.id=$e,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function we(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function Ie(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>Te(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Oe(t,n){const h=(t||"").toLowerCase();if(!h)return!1;for(const f of n)if(Se(h,f))return!0;return!1}function Te(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const h=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(h).hostname}catch{return""}}function Se(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}function je(t){const n=t.enabled??!0,h=t.getHintShown??(()=>!1),f=t.setHintShown??(()=>{}),u=()=>{h()||(f(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},A=(m,B,r)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:m,pending:B,reactionType:r}}))},L=m=>(typeof m.composedPath=="function"?m.composedPath():[]).some(r=>r instanceof HTMLElement&&r.id===o);document.addEventListener("click",m=>{!n||!(m instanceof MouseEvent)||!m.altKey||t.isSheetOpen()||L(m)||!((m.target instanceof Element?m.target:null)?.closest?.("img, video")??null)||(m.preventDefault(),m.stopPropagation(),m.stopImmediatePropagation())},!0),document.addEventListener("mousedown",m=>{if(!n||!(m instanceof MouseEvent)||!m.altKey||t.isSheetOpen()||L(m))return;const r=(m.target instanceof Element?m.target:null)?.closest?.("img, video")??null;if(!r)return;const b=m.button===0?"like":m.button===1?"love":null;if(!b)return;u(),m.preventDefault(),m.stopPropagation(),m.stopImmediatePropagation();const C=be(r,450);if(!C){if(r instanceof HTMLVideoElement){const R=(r.currentSrc||r.src||"").trim().toLowerCase();if(R.startsWith("blob:")||R.startsWith("data:")){const T=window.location.href,_={type:b,url:T,referrer_url:T,page_title:G(document.title,500),tag_name:"video",width:r.videoWidth||r.clientWidth||null,height:r.videoHeight||r.clientHeight||null,alt:"",preview_url:r.poster||"",source:fe(T),download_via:"yt-dlp"};Ae(t.sendMessageSafe,_.url,I=>{if(I?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(P=>{A(r,!0,b),P==="confirm"&&(_.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:_},O=>{if(!O||!O.ok){A(r,!1,null),t.showToast(O?.error||"Reaction failed.","danger");return}const Z=O.data||null,J=Z?.file||null,ee=Z?.reaction?.type?String(Z.reaction.type):b;Q.set(_.url,{exists:!!J,downloaded:!!J?.downloaded,blacklisted:!!J?.blacklisted_at,reactionType:ee,ts:Date.now()}),A(r,!1,ee),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}A(r,!0,b),t.sendMessageSafe({type:"atlas-react",payload:_},P=>{if(!P||!P.ok){A(r,!1,null),t.showToast(P?.error||"Reaction failed.","danger");return}const O=P.data||null,Z=O?.file||null,J=O?.reaction?.type?String(O.reaction.type):b;Q.set(_.url,{exists:!!Z,downloaded:!!Z?.downloaded,blacklisted:!!Z?.blacklisted_at,reactionType:J,ts:Date.now()}),A(r,!1,J),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const $={type:b,url:C.url,referrer_url:C.referrer_url||window.location.href,page_title:G(document.title,500),tag_name:C.tag_name,width:C.width,height:C.height,alt:G(C.alt||"",500),preview_url:C.preview_url||"",source:fe(C.url)};Ae(t.sendMessageSafe,$.url,R=>{if(R?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(T=>{A(r,!0,b),T==="confirm"&&($.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:$},_=>{if(!_||!_.ok){A(r,!1,null),t.showToast(_?.error||"Reaction failed.","danger");return}const I=_.data||null,P=I?.file||null,O=I?.reaction?.type?String(I.reaction.type):b;Q.set($.url,{exists:!!P,downloaded:!!P?.downloaded,blacklisted:!!P?.blacklisted_at,reactionType:O,ts:Date.now()}),A(r,!1,O),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})});return}A(r,!0,b),t.sendMessageSafe({type:"atlas-react",payload:$},T=>{if(!T||!T.ok){A(r,!1,null),t.showToast(T?.error||"Reaction failed.","danger");return}const _=T.data||null,I=_?.file||null,P=_?.reaction?.type?String(_.reaction.type):b;Q.set($.url,{exists:!!I,downloaded:!!I?.downloaded,blacklisted:!!I?.blacklisted_at,reactionType:P,ts:Date.now()}),A(r,!1,P),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",m=>{if(!n||!(m instanceof MouseEvent)||!m.altKey||t.isSheetOpen()||L(m))return;const r=(m.target instanceof Element?m.target:null)?.closest?.("img, video")??null;if(!r)return;u(),m.preventDefault(),m.stopPropagation(),m.stopImmediatePropagation();const b=be(r,450);if(!b){if(r instanceof HTMLVideoElement){const $=(r.currentSrc||r.src||"").trim().toLowerCase();if($.startsWith("blob:")||$.startsWith("data:")){const R=window.location.href,T={type:"dislike",url:R,referrer_url:R,page_title:G(document.title,500),tag_name:"video",width:r.videoWidth||r.clientWidth||null,height:r.videoHeight||r.clientHeight||null,alt:"",preview_url:r.poster||"",source:fe(R),download_via:"yt-dlp"};A(r,!0,"dislike"),t.sendMessageSafe({type:"atlas-react",payload:T},_=>{if(!_||!_.ok){A(r,!1,null),t.showToast(_?.error||"Reaction failed.","danger");return}A(r,!1,"dislike"),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const C={type:"dislike",url:b.url,referrer_url:b.referrer_url||window.location.href,page_title:G(document.title,500),tag_name:b.tag_name,width:b.width,height:b.height,alt:G(b.alt||"",500),preview_url:b.preview_url||"",source:fe(b.url)};A(r,!0,"dislike"),t.sendMessageSafe({type:"atlas-react",payload:C},$=>{if(!$||!$.ok){A(r,!1,null),t.showToast($?.error||"Reaction failed.","danger");return}A(r,!1,"dislike"),t.showToast("Disliked.")})},!0)}function Qe(t,n,h){return t<n?n:t>h?h:t}function qe(t,n){const h=be(t,450);if(h)return{type:n,url:h.url,referrer_url:h.referrer_url||window.location.href,page_title:G(document.title,500),tag_name:h.tag_name,width:h.width,height:h.height,alt:G(h.alt||"",500),preview_url:h.preview_url||"",source:fe(h.url)};if(t instanceof HTMLVideoElement){const f=(t.currentSrc||t.src||"").trim().toLowerCase();if(f.startsWith("blob:")||f.startsWith("data:")){const u=window.location.href;return{type:n,url:u,referrer_url:u,page_title:G(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:fe(u),download_via:"yt-dlp"}}}return null}function Fe(t){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");let h=null,f=null,u=null,A=!1,L=null,m=null,B=-1,r=-1,b=null;const C=new Map,$=()=>{const s=A||L!==null;for(const[v,S]of C.entries())S.disabled=s,S.classList.toggle("pending",A&&m===v)},R=(s,v=null)=>{A=s,m=s?v:null,$()},T=s=>{for(const v of[...ke,q]){const S=C.get(v.type);if(!S)continue;const F=v.type===q.type?s==="dislike":s===v.type;S.classList.toggle("active",F)}},_=(s,v)=>{L=s&&v===!1&&s!=="dislike"?s:null;for(const S of[...ke,q]){const F=C.get(S.type);if(!F)continue;const D=S.type===q.type?L==="dislike":L===S.type;F.classList.toggle("queued",D)}$()},I=()=>{u&&(window.clearTimeout(u),u=null)},P=()=>{A||(h=null,f=null,n.classList.remove("open"),n.style.left="",n.style.top="",T(null))},O=()=>{I(),u=window.setTimeout(()=>{n.matches(":hover")||P()},140)},Z=s=>{s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation?.()};for(const s of[...ke,q]){const v=document.createElement("button");v.type="button",v.className=`atlas-downloader-reaction-btn ${s.className}`.trim(),v.setAttribute("aria-label",s.label),v.title=s.label,v.replaceChildren(ye(s.pathDs)),C.set(s.type,v),v.addEventListener("pointerdown",Z,!0),v.addEventListener("mousedown",Z,!0),v.addEventListener("click",S=>{if(Z(S),A)return;if(!h){t.showToast("No media selected.");return}const F=s.type===q.type?"dislike":s.type,D=qe(h,F);if(!D){t.showToast("No valid media URL found.");return}const U=D.url||"",K=(pe=!1)=>{pe?D.force_download=!0:"force_download"in D&&delete D.force_download,R(!0,s.type),t.sendMessageSafe({type:"atlas-react",payload:{...D,...s.type===q.type?{blacklist:!0}:{}}},X=>{if(R(!1,null),!X||!X.ok){t.showToast(X?.error||"Reaction failed.","danger");return}const le=X.data||null,W=le?.file||null,ge=le?.reaction?.type?String(le.reaction.type):s.type===q.type?"dislike":s.type;if(U&&Q.set(U,{exists:!!W,downloaded:!!W?.downloaded,blacklisted:!!W?.blacklisted_at,reactionType:ge,ts:Date.now()}),T(ge),_(ge,!!W?.downloaded),D.download_via==="yt-dlp"){t.showToast(`Reacted (${s.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${s.label}). Queued download in Atlas.`)})};Ae(t.sendMessageSafe,U,pe=>{if(F!=="dislike"&&pe?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(X=>{K(X==="confirm")});return}K(!1)})}),n.appendChild(v)}t.root.appendChild(n);const J=s=>(typeof s.composedPath=="function"?s.composedPath():[]).some(S=>S instanceof HTMLElement&&S.id===o),ee=()=>{if(!h)return;const s=h.getBoundingClientRect();if(!Number.isFinite(s.left)||s.width<=0||s.height<=0){P();return}const v=Qe(s.top+8,8,window.innerHeight-8),S=Qe(s.right-8,8,window.innerWidth-8);n.style.top=`${v}px`,n.style.left=`${S}px`},ie=(s,v)=>{const S=U=>{if(U.matches("img, video"))return U;const K=U.closest?.("img, video");if(K instanceof Element)return K;const pe=U.querySelectorAll?.("img, video");if(!pe||pe.length===0)return null;for(const X of pe){const le=X.getBoundingClientRect();if(s>=le.left&&s<=le.right&&v>=le.top&&v<=le.bottom)return X}return null},F=document.elementsFromPoint?.(s,v)??[];for(const U of F){if(!(U instanceof Element)||U.closest?.(`#${o}`))continue;const K=S(U);if(K)return K}const D=document.elementFromPoint?.(s,v);return D instanceof Element&&!D.closest?.(`#${o}`)?S(D):null},oe=s=>{if(t.isSheetOpen()){P();return}const v=qe(s,"like");if(!v){P();return}if(h=s,f=v.url||null,n.classList.add("open"),ee(),T(null),_(null,null),f){const S=Ce(f);if(S)T(S.reactionType),_(S.reactionType,S.downloaded);else{const F=f;Ae(t.sendMessageSafe,F,D=>{D&&f===F&&(T(D.reactionType),_(D.reactionType,D.downloaded))})}}},M=s=>s?s==="blacklist"?"blacklist":s:null,me=()=>{if(B<0||r<0||t.isSheetOpen())return;const s=ie(B,r);s&&(s.closest?.(`#${o}`)||(I(),oe(s)))},de=(s=80)=>{b!==null&&window.clearTimeout(b),b=window.setTimeout(()=>{b=null,me()},s)};document.addEventListener("pointerover",s=>{if(t.isSheetOpen()||!(s.target instanceof Element)||J(s))return;const v=ie(s.clientX,s.clientY);v&&(I(),oe(v))},!0),window.addEventListener("atlas-shortcut-reaction-state",s=>{const v=s,S=v.detail?.media;if(!(S instanceof Element))return;I(),oe(S);const F=!!v.detail?.pending,D=M(v.detail?.reactionType??null);if(F){R(!0,D);return}if(R(!1,null),D){const U=D==="blacklist"?"dislike":D;T(U);const K=f?Ce(f):null;_(U,K?.downloaded??null)}},!0),document.addEventListener("pointermove",s=>{B=s.clientX,r=s.clientY},!0),document.addEventListener("pointerout",s=>{!h||t.isSheetOpen()||!(s.target instanceof Element)||J(s)||!(s.target.closest?.("img, video")??null)||O()},!0),n.addEventListener("pointerenter",I,!0),n.addEventListener("pointerleave",O,!0),window.addEventListener("scroll",ee,!0),window.addEventListener("resize",ee),window.addEventListener("blur",P),window.addEventListener("focus",()=>de(40),!0),new MutationObserver(()=>{de(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
