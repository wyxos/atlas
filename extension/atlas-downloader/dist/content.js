(function(){"use strict";(()=>{const V="atlas-downloader-root",Z="atlas-open",X=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let Y=null;const tt="http://www.w3.org/2000/svg",ht=n=>{const e=document.createElementNS(tt,"svg");e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("aria-hidden","true"),e.setAttribute("fill","none"),e.setAttribute("stroke","currentColor"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-linecap","round"),e.setAttribute("stroke-linejoin","round"),e.setAttribute("width","18"),e.setAttribute("height","18");for(const r of n){const o=document.createElementNS(tt,"path");o.setAttribute("d",r),e.appendChild(o)}return e},pt=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}];chrome.runtime.onMessage.addListener(n=>{if(!(!n||typeof n!="object"||n.type!=="atlas-open-sheet"))try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],r=>{const o=Q(r.atlasBaseUrl||"");if(o&&z(window.location.hostname,o))return;const l=nt(r.atlasExcludedDomains||"");at(window.location.hostname,l)||(et(),Y?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],n=>{const e=Q(n.atlasBaseUrl||"");if(e&&z(window.location.hostname,e))return;const r=nt(n.atlasExcludedDomains||"");at(window.location.hostname,r)||et()});function et(){if(document.getElementById(V))return;const n=document.createElement("div");n.id=V;const e=n.attachShadow({mode:"closed"}),r=document.createElement("link");r.rel="stylesheet",r.href=chrome.runtime.getURL("dist/content.css"),e.appendChild(r);const o=document.createElement("div");o.className="atlas-shadow-root";const l=xt(o),E=(t,s)=>{try{chrome.runtime.sendMessage(t,s)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const d=a.message;return typeof d=="string"?d:String(d)}return String(a)})().includes("Extension context invalidated")?l("Atlas extension was reloaded. Refresh this tab."):l("Atlas extension error. Refresh this tab."),s(null)}},x=document.createElement("button");x.className="atlas-downloader-toggle",x.type="button",x.setAttribute("aria-label","Atlas Downloader"),x.title="Atlas Downloader";const A=document.createElement("img");A.alt="",A.src=chrome.runtime.getURL("icon.svg"),x.appendChild(A);const S=document.createElement("div");S.className="atlas-downloader-overlay";const w=document.createElement("div");w.className="atlas-downloader-modal",w.setAttribute("role","dialog"),w.setAttribute("aria-modal","true"),w.setAttribute("aria-label","Atlas Media Picker");const C=document.createElement("div");C.className="atlas-downloader-header";const R=document.createElement("div");R.className="atlas-downloader-title",R.textContent="Atlas Media Picker";const _=document.createElement("div");_.className="atlas-downloader-version",_.textContent=X?`v${X}`:"";const v=document.createElement("button");v.type="button",v.className="atlas-downloader-close",v.setAttribute("aria-label","Close"),v.textContent="×",C.appendChild(R),C.appendChild(_),C.appendChild(v);const h=document.createElement("div");h.className="atlas-downloader-toolbar";const $=M("Rescan",()=>rt()),q=M("Check Atlas",()=>dt(!1));let L=!1,H=null;const J=M("Debug",()=>{L=!L,L||(H=null),m(),b(y())}),P=M("Select all",()=>lt(!0)),T=M("Select none",()=>lt(!1)),st=document.createElement("span");st.className="spacer";const W=M("Queue selected",()=>Dt(),{primary:!0});h.appendChild($),h.appendChild(q),h.appendChild(J),h.appendChild(P),h.appendChild(T),h.appendChild(st),h.appendChild(W);const U=document.createElement("div");U.className="atlas-downloader-meta";const D=document.createElement("div");D.className="atlas-downloader-list",w.appendChild(C),w.appendChild(h),w.appendChild(U),w.appendChild(D),o.appendChild(x),o.appendChild(S),o.appendChild(w),e.appendChild(o),(document.body||document.documentElement).appendChild(n);let f=[],O=0;x.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),ot()}),S.addEventListener("click",()=>G()),v.addEventListener("click",()=>G()),document.addEventListener("keydown",t=>{t.key==="Escape"&&o.classList.contains(Z)&&G()});function ot(){o.classList.add(Z),rt()}function G(){o.classList.remove(Z)}Y=ot;function M(t,s,a){const c=document.createElement("button");return c.type="button",c.className=`atlas-downloader-btn${a?.primary?" primary":""}`,c.textContent=t,c.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),s()}),c}function At(t){U.textContent=t,W.disabled=!0,$.disabled=!0,q.disabled=!0,J.disabled=!0,P.disabled=!0,T.disabled=!0}function b(t){U.textContent=t;const s=f.filter(a=>a.selected).length;W.disabled=s===0,$.disabled=!1,q.disabled=f.length===0,J.disabled=f.length===0,P.disabled=f.length===0,T.disabled=f.length===0}function rt(){O+=1;const t=O;f=[],D.replaceChildren(),At("Scanning this page…"),mt(s=>{O===t&&(U.textContent=`Scanning… ${s.scanned}/${s.total}`)}).then(s=>{O===t&&(f=s.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),m(),b(y()),dt(!0))})}function lt(t){for(const s of f)s.selected=t;m(),b(y())}function m(){if(D.replaceChildren(),f.length===0){const t=document.createElement("div");t.style.padding="10px 12px",t.style.color="#94a3b8",t.style.fontSize="12px",t.textContent="No matching images/videos found.",D.appendChild(t);return}for(const t of f)D.appendChild(vt(t))}function vt(t){const s=document.createElement("div");s.className=`atlas-downloader-item${t.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=t.selected,a.addEventListener("change",()=>{t.selected=a.checked,s.classList.toggle("selected",t.selected),b(y())});const c=document.createElement("div");if(c.className="atlas-downloader-preview",t.preview_url){const g=document.createElement("img");g.loading="lazy",g.alt="",g.src=t.preview_url,c.appendChild(g)}const d=document.createElement("div");d.className="atlas-downloader-info";const u=document.createElement("div");u.className="atlas-downloader-kind",u.textContent=t.tag_name;const i=document.createElement("div");i.className="atlas-downloader-url",i.textContent=t.url,i.title=t.url;const p=document.createElement("div");p.className="atlas-downloader-sub",p.textContent=kt(t);const I=document.createElement("div");I.className="atlas-downloader-reactions";const B=t.atlas?.reaction?.type||null;for(const g of pt){const N=document.createElement("button");N.type="button",N.className=`atlas-downloader-reaction-btn ${g.className}${B===g.type?" active":""}${t.reactionPending?" pending":""}`.trim(),N.setAttribute("aria-label",g.label),N.title=g.label,N.replaceChildren(ht(g.pathDs)),N.disabled=!!t.reactionPending,N.addEventListener("click",ft=>{ft.preventDefault(),ft.stopPropagation(),L&&(H=t.url,m()),Lt(t,g.type)}),I.appendChild(N)}d.appendChild(u),d.appendChild(i),d.appendChild(p),d.appendChild(I),L&&H===t.url&&d.appendChild(Nt(t));const K=document.createElement("div"),ut=St(t);return K.className=`atlas-downloader-status ${ut.className}`.trim(),K.textContent=ut.text,s.addEventListener("click",g=>{g.target instanceof HTMLInputElement||(L&&(H=t.url),t.selected=!t.selected,a.checked=t.selected,s.classList.toggle("selected",t.selected),b(y()))}),s.appendChild(a),s.appendChild(c),s.appendChild(d),s.appendChild(K),s}function it(t,s){return{type:s,url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:document.title,tag_name:t.tag_name,width:t.width,height:t.height,alt:t.alt||"",preview_url:t.preview_url||"",source:"Extension"}}function ct(t){return{url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:document.title,tag_name:t.tag_name,width:t.width,height:t.height,alt:t.alt||"",preview_url:t.preview_url||"",source:"Extension",reaction_type:"like"}}function Nt(t){const s=document.createElement("details");s.className="atlas-downloader-debug",s.open=!0;const a=document.createElement("summary");a.textContent="Debug payload",s.appendChild(a);const c=document.createElement("pre");return c.textContent=JSON.stringify({react:it(t,"like"),download:ct(t)},null,2),s.appendChild(c),s}function kt(t){const s=t.width&&t.height?`${t.width}×${t.height}`:"size unknown",a=_t(t.url);return a?`${s} • ${a}`:s}function _t(t){try{return new URL(t).hostname}catch{return""}}function y(){const t=f.filter(s=>s.selected).length;return`${f.length} found • ${t} selected`}function St(t){return t.status?{text:t.status,className:t.statusClass||""}:t.atlas?.downloaded?{text:"Downloaded",className:"ok"}:t.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function dt(t){const s=f.map(a=>a.url).filter(Boolean);s.length!==0&&E({type:"atlas-check-batch",urls:s},a=>{if(!a){t||l("Atlas extension did not respond.");return}if(!a.ok){t||l(a.error||"Atlas check failed.");return}const c=Array.isArray(a.data?.results)?a.data.results:[],d=new Map(c.map(u=>[u.url,u]));for(const u of f){const i=d.get(u.url);i&&(u.atlas={exists:!!i.exists,downloaded:!!i.downloaded,file_id:i.file_id??null,reaction:i.reaction??null})}m(),b(y())})}function Lt(t,s){t.reactionPending=s,t.status="Reacting…",t.statusClass="",m();const a=it(t,s);E({type:"atlas-react",payload:a},c=>{if(t.reactionPending=null,!c){t.status="No response",t.statusClass="err",m(),b(y()),l("Atlas extension did not respond.");return}if(!c.ok){t.status=c.error||"Failed",t.statusClass="err",m(),b(y()),l(c.error||"Reaction failed.");return}const d=c.data||null,u=d?.file||null;t.atlas={exists:!!u,downloaded:!!u?.downloaded,file_id:u?.id??null,reaction:d?.reaction??null},t.atlas.exists&&!t.atlas.downloaded&&s!=="dislike"?(t.status="Queued",t.statusClass="queued"):(t.status="",t.statusClass=""),m(),b(y()),t.atlas.exists&&!t.atlas.downloaded&&s!=="dislike"&&F([t.url],0)})}function Dt(){const t=f.filter(a=>a.selected);if(t.length===0){l("Select one or more items first.");return}W.disabled=!0,$.disabled=!0,q.disabled=!0,P.disabled=!0,T.disabled=!0;for(const a of t)a.status="Sending…",a.statusClass="";m();const s=t.map(a=>ct(a));E({type:"atlas-download-batch",payloads:s},a=>{if(!a){for(const u of t)u.status="No response",u.statusClass="err";m(),b(y()),l("Atlas extension did not respond.");return}const c=Array.isArray(a.results)?a.results:[],d=[];for(let u=0;u<t.length;u+=1){const i=t[u],p=c[u];if(p?.ok){const I=p.data||null,B=I?.file||null;i.atlas={exists:!!B,downloaded:!!B?.downloaded,file_id:B?.id??null},I?.queued?(i.status="Queued",i.statusClass="queued",d.push(i.url)):(i.status="",i.statusClass="")}else i.status=p?.error||"Failed",i.statusClass="err"}m(),b(y()),a.ok?l(`Queued ${t.length} download(s) in Atlas.`):l(a.error||"Some requests failed."),d.length>0&&F(d,0)})}function F(t,s){s>15||setTimeout(()=>{E({type:"atlas-check-batch",urls:t},a=>{if(!a||!a.ok){F(t,s+1);return}const c=Array.isArray(a.data?.results)?a.data.results:[],d=new Map(c.map(i=>[i.url,i]));let u=0;for(const i of f){const p=d.get(i.url);p&&(i.atlas={exists:!!p.exists,downloaded:!!p.downloaded,file_id:p.file_id??null,reaction:p.reaction??null},p.downloaded?i.status==="Queued"&&(i.status="",i.statusClass=""):u+=1)}m(),b(y()),u>0&&F(t,s+1)})},2e3)}}function mt(n){return new Promise(e=>{const r=document.body||document.documentElement,o=Array.from(r.querySelectorAll("img, video")),l=o.length,E=new Set,x=[];let A=0;const S=C=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(C,{timeout:500});return}setTimeout(()=>C({timeRemaining:()=>25}),0)},w=C=>{const R=typeof C?.timeRemaining=="function"?C.timeRemaining():25;let _=0;for(;A<l&&(_<80||R>5);){const v=o[A];if(v.closest&&v.closest(`#${V}`)){A+=1,_+=1;continue}const h=gt(v);h?.url&&!E.has(h.url)&&(E.add(h.url),x.push(h)),A+=1,_+=1}if(n?.({scanned:A,total:l}),A<l){S(w);return}e(x)};S(w)})}function gt(n){if(!(n instanceof Element))return null;if(n.tagName==="IMG"){const e=n,r=e.naturalWidth||e.width||e.clientWidth||null,o=e.naturalHeight||e.height||e.clientHeight||null;if(r&&o&&(r<450||o<450))return null;const l=k(e.currentSrc)||k(e.src)||k(e.getAttribute("src"));return l?{tag_name:"img",url:l,preview_url:l,width:r,height:o,alt:e.alt||""}:null}if(n.tagName==="VIDEO"){const e=wt(n);return e?{tag_name:"video",url:e,preview_url:n.poster||"",width:n.videoWidth||n.clientWidth||null,height:n.videoHeight||n.clientHeight||null,alt:""}:null}return null}function wt(n){const e=k(n.currentSrc)||k(n.src)||k(n.getAttribute("src"));if(e)return e;const r=n.querySelector("source[src]"),o=r?k(r.src||r.getAttribute("src")):"";if(o)return o;const l=yt(n);return l||bt()}function bt(){const n=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const e of n){const o=document.querySelector(e)?.getAttribute("content"),l=k(o||"");if(l)return l}return""}function yt(n){let e=n,r=0;for(;e&&r<8;){const o=e.getAttribute?.("data-store");if(o){const l=Ct(o),E=j(l,0);if(E)return E}e=e.parentElement,r+=1}return""}function Ct(n){if(!n)return null;const e=Et(n);try{return JSON.parse(e)}catch{return null}}function Et(n){return!n||typeof n!="string"?"":n.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function j(n,e){if(!n||e>4)return"";if(typeof n=="string")return n.startsWith("http")?n:"";if(Array.isArray(n)){for(const o of n){const l=j(o,e+1);if(l)return l}return""}if(typeof n!="object")return"";const r=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const o of r){const l=n[o];if(typeof l=="string"&&l.startsWith("http"))return l}for(const o of Object.keys(n)){const l=j(n[o],e+1);if(l)return l}return""}function xt(n){return function(r){const o=document.createElement("div");o.className="atlas-downloader-toast",o.textContent=r,n.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove(),{once:!0})},2600)}}function nt(n){return!n||typeof n!="string"?[]:n.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e&&!e.startsWith("#")).map(e=>(e.startsWith("*.")?e.slice(2):e).toLowerCase()).map(e=>Q(e)||e.replace(/^\.+/,"").trim()).filter(Boolean)}function at(n,e){const r=(n||"").toLowerCase();if(!r)return!1;for(const o of e)if(z(r,o))return!0;return!1}function Q(n){if(!n||typeof n!="string")return"";const e=n.trim();if(!e)return"";const r=/^https?:\/\//i.test(e)?e:`https://${e}`;try{return new URL(r).hostname}catch{return""}}function z(n,e){return!n||!e?!1:n===e||n.endsWith(`.${e}`)}function k(n){if(!n||typeof n!="string")return"";const e=n.trim();if(!e)return"";const r=e.toLowerCase();return r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:")?"":e}})()})();
