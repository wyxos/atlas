(function(){"use strict";const nt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function at(s){const u=(s||"").trim().toLowerCase();if(!u)return"";const o=u.split(".").filter(Boolean);if(o.length<=2)return u;const k=o.slice(-2).join("."),T=o.slice(-3).join(".");return nt.has(k)&&o.length>=3?T:k}function ot(s){const u=(s||"").trim();if(!u)return"";try{const o=new URL(u).hostname;return at(o)}catch{return""}}function lt(s,u){if(!s||typeof s!="string")return"";const o=s.trim();if(!o)return"";const k=o.toLowerCase();if(k.startsWith("blob:")||k.startsWith("data:")||k.startsWith("chrome-extension:")||k.startsWith("moz-extension:")||k.startsWith("safari-extension:"))return"";try{const T=new URL(o,u);return T.protocol!=="http:"&&T.protocol!=="https:"?"":T.toString()}catch{return""}}function rt(s){return/\.(gif|webp)(\?|#|$)/i.test(s||"")}function st(s){let u=s,o=0;for(;u&&o<24;){const k=u.getAttribute?.("role");if(k==="dialog"||k==="alertdialog"||u.getAttribute?.("aria-modal")==="true")return!0;const O=(u.getAttribute?.("class")||"").toLowerCase(),de=(u.getAttribute?.("id")||"").toLowerCase(),me=`${O} ${de}`.trim();if(me&&/(modal|lightbox|overlay|dialog)/.test(me))return!0;const j=window.getComputedStyle(u);if((j.position==="fixed"||j.position==="sticky")&&dt(u))return!0;u=u.parentElement,o+=1}return!1}function it(s,u){return!!(rt(u)||st(s))}function dt(s){const u=s.getBoundingClientRect();if(u.width>0&&u.height>0){const o=Math.max(window.innerWidth*.4,320),k=Math.max(window.innerHeight*.4,240);return u.width>=o&&u.height>=k}if(s instanceof HTMLElement){const o=s.style,k=o.inset==="0"||o.inset==="0px"||(o.top==="0"||o.top==="0px")&&(o.left==="0"||o.left==="0px")&&(o.right==="0"||o.right==="0px")&&(o.bottom==="0"||o.bottom==="0px"),T=/^(100vw|100%)$/i.test(o.width||"")||/^(100vh|100%)$/i.test(o.height||"");return k||T}return!1}function J(s){return lt(s,window.location.href)}function Be(s){const u=J(s.currentSrc)||J(s.src)||J(s.getAttribute("src")||"");if(u)return u;const o=s.querySelector("source[src]"),k=o?J(o.src||o.getAttribute("src")||""):"";if(k)return k;const T=ft(s);return T||ut()}function ke(s,u){if(!(s instanceof Element))return null;if(s.tagName==="IMG"){const o=s,k=o.naturalWidth||o.width||o.clientWidth||null,T=o.naturalHeight||o.height||o.clientHeight||null,O=(o.currentSrc||o.src||o.getAttribute("src")||"").trim(),de=J(O);if(!it(o,de||O)&&k&&T&&(k<u||T<u))return null;if(!de){const me=J(document.referrer)||J(window.location.href)||"";return!me||!O.toLowerCase().startsWith("blob:")&&!O.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:me,referrer_url:window.location.href,preview_url:"",width:k,height:T,alt:o.alt||""}}return{tag_name:"img",url:de,referrer_url:window.location.href,preview_url:de,width:k,height:T,alt:o.alt||""}}if(s.tagName==="VIDEO"){const o=s,k=Be(o);if(!k){const T=(o.currentSrc||o.src||"").trim().toLowerCase();if(T.startsWith("blob:")||T.startsWith("data:")){const O=window.location.href;return{tag_name:"video",url:O,referrer_url:O,preview_url:o.poster||"",width:o.videoWidth||o.clientWidth||null,height:o.videoHeight||o.clientHeight||null,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:k,referrer_url:window.location.href,preview_url:o.poster||"",width:o.videoWidth||o.clientWidth||null,height:o.videoHeight||o.clientHeight||null,alt:""}}return null}function Re(){const s=(window.location.href||"").trim();if(!s)return null;const u=s.toLowerCase(),o=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(u),k=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!o&&!k)return null;if(u.startsWith("http://")||u.startsWith("https://"))return{tag_name:u.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:s,referrer_url:s,preview_url:s,width:null,height:null,alt:""};if(u.startsWith("blob:")||u.startsWith("data:")){const T=J(document.referrer)||"";return T?{tag_name:"img",url:T,referrer_url:s,preview_url:"",width:null,height:null,alt:""}:null}return null}function Pe(s){const u=new Set,o=J(window.location.href),k=s instanceof HTMLImageElement?J(s.currentSrc)||J(s.src)||"":s instanceof HTMLVideoElement?Be(s)||"":s instanceof HTMLAnchorElement&&He(s.getAttribute("href")||"")||"";k&&u.add(k);const T=s.closest("a[href]")?.getAttribute("href")??"",O=He(T);return O&&u.add(O),o&&ct(s)&&u.add(o),[...u]}function He(s){const u=(s||"").trim();return!u||u.startsWith("#")||u.toLowerCase().startsWith("javascript:")?"":J(u)}function ct(s){if(s instanceof HTMLImageElement){const u=(s.currentSrc||s.src||s.getAttribute("src")||"").trim().toLowerCase();return u.startsWith("blob:")||u.startsWith("data:")}if(s instanceof HTMLVideoElement){const u=(s.currentSrc||s.src||"").trim().toLowerCase();return u.startsWith("blob:")||u.startsWith("data:")}return!1}function ut(){const s=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const u of s){const k=document.querySelector(u)?.getAttribute("content")||"",T=J(k);if(T)return T}return""}function ft(s){let u=s,o=0;for(;u&&o<8;){const k=u.getAttribute?.("data-store");if(k){const T=pt(k),O=Ce(T,0);if(O)return O}u=u.parentElement,o+=1}return""}function pt(s){if(!s)return null;const u=mt(s);try{return JSON.parse(u)}catch{return null}}function mt(s){return!s||typeof s!="string"?"":s.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Ce(s,u){if(!s||u>4)return"";if(typeof s=="string")return s.startsWith("http")?s:"";if(Array.isArray(s)){for(const o of s){const k=Ce(o,u+1);if(k)return k}return""}if(typeof s=="object")for(const o of Object.keys(s)){const k=s[o],T=Ce(k,u+1);if(T)return T}return""}(()=>{const o="atlas-downloader-root",k="atlas-open",T=(()=>{try{return window.top===window.self}catch{return!1}})(),O=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let de=null;const me=3e4,j=new Map,Ue="http://www.w3.org/2000/svg",ve=t=>{const n=document.createElementNS(Ue,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const y of t){const f=document.createElementNS(Ue,"path");f.setAttribute("d",y),f.setAttribute("fill","none"),f.setAttribute("stroke","currentColor"),f.setAttribute("stroke-width","2"),f.setAttribute("stroke-linecap","round"),f.setAttribute("stroke-linejoin","round"),n.appendChild(f)}return n},Ee=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],K={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},$e="atlas-downloader-page-markers";function Y(t,n){const y=typeof t=="string"?t:"";return y.length<=n?y:y.slice(0,n)}function he(t){return ot(t)||"Extension"}function ye(t){const n=j.get(t);return n?Date.now()-n.ts>me?(j.delete(t),null):n:null}function _e(t,n,y,f){const p=X((n||"").trim());if(!p){f(null);return}const A=ye(p);if(A){f(A);return}t({type:"atlas-check-batch",urls:[p]},M=>{if(!M||!M.ok){f(null);return}const w=Array.isArray(M.data?.results)?M.data.results:[],l=new Map(w.filter(E=>typeof E?.url=="string"&&E.url.trim()!=="").map(E=>[X(String(E.url)),E])).get(p)??null;if(!l){f(null);return}const b={exists:!!l.exists,downloaded:!!l.downloaded,blacklisted:!!l.blacklisted,reactionType:l.reaction?.type?String(l.reaction.type):null,ts:Date.now()};j.set(p,b),f(b)})}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&T)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],y=>{const f=xe(y.atlasBaseUrl||"");if(f&&Me(window.location.hostname,f))return;const p=je(y.atlasExcludedDomains||"");Qe(window.location.hostname,p)||(We(),de?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const n=xe(t.atlasBaseUrl||"");if(n&&Me(window.location.hostname,n))return;const y=je(t.atlasExcludedDomains||"");Qe(window.location.hostname,y)||(T?We():ht())});function ht(){if(document.getElementById(o))return;const t=document.createElement("div");t.id=o;const n=t.attachShadow({mode:"closed"}),y=document.createElement("link");y.rel="stylesheet",y.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(y);const f=document.createElement("div");f.className="atlas-shadow-root";const p=Ie(f),A=Oe(f),M=(w,U)=>{try{chrome.runtime.sendMessage(w,U)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const E=l.message;return typeof E=="string"?E:String(E)}return String(l)})().includes("Extension context invalidated")?p("Atlas extension was reloaded. Refresh this tab.","danger"):p("Atlas extension error. Refresh this tab.","danger"),U(null)}};n.appendChild(f),(document.body||document.documentElement).appendChild(t),qe({showToast:p,sendMessageSafe:M,isSheetOpen:()=>!1,chooseDialog:A}),Ke({root:f,showToast:p,sendMessageSafe:M,isSheetOpen:()=>!1,chooseDialog:A})}function We(){if(document.getElementById(o))return;const t=document.createElement("div");t.id=o;const n=t.attachShadow({mode:"closed"}),y=document.createElement("link");y.rel="stylesheet",y.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(y);const f=document.createElement("div");f.className="atlas-shadow-root";const p=Ie(f),A=(e,r)=>{try{chrome.runtime.sendMessage(e,r)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const m=a.message;return typeof m=="string"?m:String(m)}return String(a)})().includes("Extension context invalidated")?p("Atlas extension was reloaded. Refresh this tab.","danger"):p("Atlas extension error. Refresh this tab.","danger"),r(null)}},M=document.createElement("button");M.className="atlas-downloader-toggle",M.type="button",M.setAttribute("aria-label","Atlas Downloader"),M.title="Atlas Downloader";const w=document.createElement("img");w.alt="",w.src=chrome.runtime.getURL("icon.svg"),M.appendChild(w);const U=document.createElement("div");U.className="atlas-downloader-overlay";const l=document.createElement("div");l.className="atlas-downloader-modal",l.setAttribute("role","dialog"),l.setAttribute("aria-modal","true"),l.setAttribute("aria-label","Atlas Media Picker");const b=document.createElement("div");b.className="atlas-downloader-header";const E=document.createElement("div");E.className="atlas-downloader-title",E.textContent="Atlas Media Picker";const N=document.createElement("div");N.className="atlas-downloader-version",N.textContent=O?`v${O}`:"";const H=document.createElement("button");H.type="button",H.className="atlas-downloader-close",H.setAttribute("aria-label","Close"),H.textContent="x",b.appendChild(E),b.appendChild(N),b.appendChild(H);const C=document.createElement("div");C.className="atlas-downloader-toolbar";const _=ee("Rescan",()=>ge()),Q=ee("Check Atlas",()=>Ge(!1)),$=ee("Select all",()=>we(!0)),I=ee("Select none",()=>we(!1)),G=document.createElement("span");G.className="spacer";const z=ee("Queue selected",()=>Lt(),{primary:!0});C.appendChild(_),C.appendChild(Q),C.appendChild($),C.appendChild(I),C.appendChild(G),C.appendChild(z);const ne=document.createElement("div");ne.className="atlas-downloader-meta";const re=document.createElement("div");re.className="atlas-downloader-list",l.appendChild(b),l.appendChild(C),l.appendChild(ne),l.appendChild(re),f.appendChild(M),f.appendChild(U),f.appendChild(l),n.appendChild(f),(document.body||document.documentElement).appendChild(t);const ce=Oe(f);let x=[],be=0,ue=null,fe=null,Ae=null;const i=!0;let v=!1;M.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),q()}),U.addEventListener("click",()=>B()),H.addEventListener("click",()=>B()),document.addEventListener("keydown",e=>{const r=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&r==="a"){e.preventDefault(),q();return}if(e.key==="Escape"&&f.classList.contains(k)){B();return}if(!f.classList.contains(k))return;const a=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!a)return;const d=x.find(m=>m.selected)??x[0]??null;d&&(e.preventDefault(),Ne(d,a,{closeOnSuccess:!0}))});function D(){f.classList.add(k),ge()}function q(){if(f.classList.contains(k)){B();return}D()}function B(){f.classList.remove(k)}de=q,qe({showToast:p,sendMessageSafe:A,isSheetOpen:()=>f.classList.contains(k),chooseDialog:ce,setHintShown:e=>{v=e},getHintShown:()=>v,enabled:i}),Ke({root:f,showToast:p,sendMessageSafe:A,isSheetOpen:()=>f.classList.contains(k),chooseDialog:ce}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const r=e,a=!!r.detail?.pending,d=r.detail?.reactionType?String(r.detail.reactionType):null,h=(typeof r.detail?.url=="string"?r.detail.url:"")||r.detail?.media&&ke(r.detail.media,450)?.url||"",g=h?X(h):"";if(a){ue=g||"__external-reaction__";for(const c of x)g&&X(String(c.url||""))!==g||(c.reactionPending=d||c.reactionPending||"like");V(),P(F());return}ue=null;for(const c of x){if(g&&X(String(c.url||""))!==g)continue;c.reactionPending&&(c.reactionPending=null);const L=(g?ye(g):null)??ye(pe(c))??ye(X(String(c.url||"")));L?c.atlas={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,file_id:c.atlas?.file_id??null,reaction:L.reactionType?{type:L.reactionType}:c.atlas?.reaction??null}:d&&(c.atlas={exists:c.atlas?.exists??!0,downloaded:c.atlas?.downloaded??!1,blacklisted:c.atlas?.blacklisted??!1,file_id:c.atlas?.file_id??null,reaction:{type:d}}),c.atlas?.exists&&!c.atlas?.downloaded&&c.atlas?.reaction?.type&&c.atlas.reaction.type!=="dislike"?c.reactionQueued=c.atlas.reaction.type:c.reactionQueued=null}V(),P(F()),se(x)},!0);const W=(e=300)=>{Ae!==null&&window.clearTimeout(Ae),Ae=window.setTimeout(()=>{Ae=null,Tt()},e)};new MutationObserver(()=>{se(x),W(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>W(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&W(120)},!0),W(120);function ee(e,r,a){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${a?.primary?" primary":""}`,d.textContent=e,d.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),r()}),d}function oe(e){ne.textContent=e,z.disabled=!0,_.disabled=!0,Q.disabled=!0,$.disabled=!0,I.disabled=!0}function P(e){ne.textContent=e;const r=x.filter(d=>d.selected).length,a=x.some(d=>!!d.reactionPending)||ue==="__external-reaction__";z.disabled=r===0||a,_.disabled=a,Q.disabled=x.length===0||a,$.disabled=x.length===0||a,I.disabled=x.length===0||a}function ge(){be+=1;const e=be;x=[],fe=null,re.replaceChildren(),oe("Scanning this page…"),gt(r=>{be===e&&(ne.textContent=`Scanning… ${r.scanned}/${r.total}`)}).then(r=>{be===e&&(x=r.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),V(),P(F()),Ge(!0))})}function we(e){for(const r of x)r.selected=e;V(),P(F())}function V(){if(re.replaceChildren(),x.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",re.appendChild(e);return}for(const e of x)re.appendChild(yt(e))}function yt(e){const r=document.createElement("div");r.className=`atlas-downloader-item${e.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=e.selected,a.addEventListener("change",()=>{e.selected=a.checked,r.classList.toggle("selected",e.selected),P(F())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",e.preview_url){const R=document.createElement("img");R.loading="lazy",R.alt="",R.src=e.preview_url,d.appendChild(R)}const m=document.createElement("div");m.className="atlas-downloader-info";const h=document.createElement("div");h.className="atlas-downloader-kind",h.textContent=e.tag_name;const g=document.createElement("div");g.className="atlas-downloader-url",g.textContent=e.url,g.title=e.url;const c=document.createElement("div");c.className="atlas-downloader-sub",c.textContent=At(e);const L=document.createElement("div");L.className="atlas-downloader-reactions";const S=e.atlas?.reaction?.type||null,Z=!!e.reactionPending||!!e.reactionQueued;for(const R of Ee){const te=document.createElement("button");te.type="button",te.className=`atlas-downloader-reaction-btn ${R.className}${S===R.type?" active":""}${e.reactionPending===R.type?" pending":""}${e.reactionQueued===R.type?" queued":""}`.trim(),te.setAttribute("aria-label",R.label),te.title=R.label,te.replaceChildren(ve(R.pathDs)),te.disabled=Z,te.addEventListener("click",tt=>{tt.preventDefault(),tt.stopPropagation(),Ne(e,R.type)}),L.appendChild(te)}const le=document.createElement("button");if(le.type="button",le.className=`atlas-downloader-reaction-btn ${K.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===K.type?" pending":""}${e.reactionQueued===K.type?" queued":""}`.trim(),le.setAttribute("aria-label",K.label),le.title=K.label,le.replaceChildren(ve(K.pathDs)),le.disabled=Z,le.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),Ne(e,"dislike",{blacklist:!0})}),L.appendChild(le),e.atlas?.downloaded){const R=document.createElement("button");R.type="button",R.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),R.setAttribute("aria-label","Delete download"),R.title="Delete download",R.replaceChildren(ve(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),R.disabled=Z,R.addEventListener("click",te=>{te.preventDefault(),te.stopPropagation(),_t(e)}),L.appendChild(R)}const ie=document.createElement("button");ie.type="button",ie.className=`atlas-downloader-debug-toggle${fe===e.url?" active":""}`,ie.textContent=fe===e.url?"Hide debug":"Debug",ie.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),fe=fe===e.url?null:e.url,V(),P(F())}),L.appendChild(ie),m.appendChild(h),m.appendChild(g),m.appendChild(c),m.appendChild(L),fe===e.url&&m.appendChild(bt(e));const De=document.createElement("div"),et=Et(e);return De.className=`atlas-downloader-status ${et.className}`.trim(),De.textContent=et.text,r.addEventListener("click",R=>{R.target instanceof HTMLInputElement||(e.selected=!e.selected,a.checked=e.selected,r.classList.toggle("selected",e.selected),P(F()))}),r.appendChild(a),r.appendChild(d),r.appendChild(m),r.appendChild(De),r}function Xe(e,r){return{type:r,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:Y(e.alt||"",500),preview_url:e.preview_url||"",source:he(e.url),...e.download_via?{download_via:e.download_via}:{}}}function ze(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:Y(e.alt||"",500),preview_url:e.preview_url||"",source:he(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function bt(e){const r=document.createElement("details");r.className="atlas-downloader-debug",r.open=!0;const a=document.createElement("summary");a.textContent="Debug payload",r.appendChild(a);const d={react:Xe(e,e.atlas?.reaction?.type||"like"),download:ze(e)};return r.appendChild(kt(d)),r}function kt(e,r=0){const a=document.createElement("div");a.className="atlas-downloader-json-tree";const d=Le(e);if(!Je(d)){const h=document.createElement("div");return h.className="atlas-downloader-json-line",h.textContent=Ye(d),a.appendChild(h),a}const m=Array.isArray(d)?d.map((h,g)=>[String(g),h]):Object.entries(d);for(const[h,g]of m)a.appendChild(Ze(h,g,r));return a}function Ze(e,r,a){const d=Le(r),m=document.createElement("div");if(m.className="atlas-downloader-json-line",m.style.paddingLeft=`${a*12}px`,!Je(d))return m.innerHTML=`<span class="atlas-downloader-json-key">${Se(e)}</span>: <span class="atlas-downloader-json-value">${Se(Ye(d))}</span>`,m;const h=document.createElement("details");h.className="atlas-downloader-json-node",h.open=a===0;const g=document.createElement("summary");g.style.paddingLeft=`${a*12}px`;const c=Array.isArray(d)?`[${d.length}]`:`{${Object.keys(d).length}}`;g.innerHTML=`<span class="atlas-downloader-json-key">${Se(e)}</span>: <span class="atlas-downloader-json-preview">${Se(c)}</span>`,h.appendChild(g);const L=Array.isArray(d)?d.map((S,Z)=>[String(Z),S]):Object.entries(d);for(const[S,Z]of L)h.appendChild(Ze(S,Z,a+1));return h}function Le(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(a=>Le(a));if(!e||typeof e!="object")return null;const r={};for(const[a,d]of Object.entries(e))r[a]=Le(d);return r}function Je(e){return Array.isArray(e)||e&&typeof e=="object"}function Ye(e){return JSON.stringify(e)}function Se(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function At(e){const r=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",a=vt(e.url);return a?`${r} • ${a}`:r}function vt(e){try{return new URL(e).hostname}catch{return""}}function F(){const e=x.filter(r=>r.selected).length;return`${x.length} found • ${e} selected`}function pe(e){const r=(e?.url||e?.referrer_url||"").trim();return r?X(r):""}function Et(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Ge(e){const r=[...new Set(x.map(a=>pe(a)).filter(Boolean))];r.length!==0&&A({type:"atlas-check-batch",urls:r},a=>{if(!a){e||p("Atlas extension did not respond.","danger");return}if(!a.ok){e||p(a.error||"Atlas check failed.","danger");return}const d=Array.isArray(a.data?.results)?a.data.results:[],m=new Map(d.filter(c=>typeof c?.url=="string"&&c.url.trim()!=="").map(c=>[X(String(c.url)),c]));let h=0,g=0;for(const c of x){const L=pe(c),S=m.get(L);S&&(c.atlas={exists:!!S.exists,downloaded:!!S.downloaded,blacklisted:!!S.blacklisted,file_id:S.file_id??null,reaction:S.reaction??null},c.atlas.exists&&!c.atlas.downloaded&&c.atlas.reaction?.type&&c.atlas.reaction.type!=="dislike"?c.reactionQueued=c.atlas.reaction.type:c.reactionQueued=null,j.set(L,{exists:!!S.exists,downloaded:!!S.downloaded,blacklisted:!!S.blacklisted,reactionType:S.reaction?.type?String(S.reaction.type):null,ts:Date.now()}),S.exists&&(h+=1),S.downloaded&&(g+=1))}V(),P(F()),se(x),e||p(`Atlas check: ${g}/${h} downloaded.`)})}function Ne(e,r,a={}){const d=(h={})=>{e.reactionPending=a.blacklist?K.type:r,e.status="Reacting…",e.statusClass="",ue=pe(e)||e.url,V(),P(F());const g={...Xe(e,r),...h,...a.blacklist?{blacklist:!0}:{}};A({type:"atlas-react",payload:g},c=>{if(e.reactionPending=null,ue=null,!c){e.status="No response",e.statusClass="err",V(),P(F()),p("Atlas extension did not respond.","danger");return}if(!c.ok){e.status=c.error||"Failed",e.statusClass="err",V(),P(F()),p(c.error||"Reaction failed.","danger");return}const L=c.data||null,S=L?.file||null;e.atlas={exists:!!S,downloaded:!!S?.downloaded,blacklisted:!!S?.blacklisted_at,file_id:S?.id??null,reaction:L?.reaction??null};const Z=pe(e)||e.url;j.set(Z,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&r!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=a.blacklist?K.type:r):(e.status="",e.statusClass="",e.reactionQueued=null),V(),P(F()),se(x),a.closeOnSuccess&&B(),e.atlas.exists&&!e.atlas.downloaded&&r!=="dislike"&&Te([Z],0)})},m=!!e.atlas?.reaction?.type;if(r!=="dislike"&&e.atlas?.downloaded&&m){ce({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(h=>{d(h==="confirm"?{force_download:!0}:{})});return}if(r==="dislike"&&e.atlas?.downloaded){ce({title:a.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(h=>{if(h==="alternate"){p("Cancelled.");return}d(h==="confirm"?{clear_download:!0}:{})});return}d()}function _t(e){ce({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(r=>{r==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",ue=pe(e)||e.url,V(),P(F()),A({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},a=>{if(e.reactionPending=null,ue=null,!a||!a.ok){e.status=a?.error||"Failed",e.statusClass="err",V(),P(F()),p(a?.error||"Delete failed.","danger");return}const d=a.data?.file||null;e.atlas={exists:!!d,downloaded:!!d?.downloaded,blacklisted:!!d?.blacklisted_at,file_id:d?.id??null,reaction:null},e.reactionQueued=null;const m=pe(e)||e.url;j.set(m,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",V(),P(F()),se(x),p("Download deleted.")}))})}function Lt(){const e=x.filter(d=>d.selected);if(e.length===0){p("Select one or more items first.");return}if(e.some(d=>!!d.atlas?.downloaded)){ce({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(d=>{if(d==="alternate"){p("Cancelled.");return}a(d==="confirm")});return}a(!1);function a(d){z.disabled=!0,_.disabled=!0,Q.disabled=!0,$.disabled=!0,I.disabled=!0;for(const h of e)h.status="Sending…",h.statusClass="";V();const m=e.map(h=>{const g=ze(h);return d&&(g.force_download=!0),g});A({type:"atlas-download-batch",payloads:m},h=>{if(!h){for(const L of e)L.status="No response",L.statusClass="err";V(),P(F()),p("Atlas extension did not respond.","danger");return}const g=Array.isArray(h.results)?h.results:[],c=[];for(let L=0;L<e.length;L+=1){const S=e[L],Z=g[L];if(Z?.ok){const le=Z.data||null,ie=le?.file||null;S.atlas={exists:!!ie,downloaded:!!ie?.downloaded,blacklisted:!!ie?.blacklisted_at,file_id:ie?.id??null,reaction:S.atlas?.reaction??null},le?.queued?(S.status="Queued",S.statusClass="queued",S.atlas?.reaction?.type&&S.atlas.reaction.type!=="dislike"&&(S.reactionQueued=S.atlas.reaction.type),c.push(pe(S)||S.url)):(S.status="",S.statusClass="",S.reactionQueued=null)}else S.status=Z?.error||"Failed",S.statusClass="err"}V(),P(F()),se(x),h.ok?p(`Queued ${e.length} download(s) in Atlas.`):p(h.error||"Some requests failed.","danger"),c.length>0&&Te(c,0)})}}function Te(e,r){r>15||setTimeout(()=>{A({type:"atlas-check-batch",urls:e},a=>{if(!a||!a.ok){Te(e,r+1);return}const d=Array.isArray(a.data?.results)?a.data.results:[],m=new Map(d.filter(g=>typeof g?.url=="string"&&g.url.trim()!=="").map(g=>[X(String(g.url)),g]));let h=0;for(const g of x){const c=pe(g)||g.url,L=m.get(X(c));L&&(g.atlas={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,file_id:L.file_id??null,reaction:L.reaction??null},c&&j.set(X(c),{exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,reactionType:L.reaction?.type?String(L.reaction.type):null,ts:Date.now()}),g.atlas.exists&&!g.atlas.downloaded&&g.atlas.reaction?.type&&g.atlas.reaction.type!=="dislike"?g.reactionQueued=g.atlas.reaction.type:g.reactionQueued=null,L.downloaded?g.status==="Queued"&&(g.status="",g.statusClass=""):h+=1)}V(),P(F()),se(x),h>0&&Te(e,r+1)})},2e3)}function se(e=x){wt();const r=document.querySelectorAll('[data-atlas-marked="1"]');for(const m of r)m.removeAttribute("data-atlas-marked"),m.removeAttribute("data-atlas-state"),m.removeAttribute("data-atlas-reaction");const a=new Map;for(const[m,h]of j.entries()){if(Date.now()-h.ts>me){j.delete(m);continue}a.set(m,{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null}),a.set(X(m),{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null})}for(const m of e){if(!m?.url||!m?.atlas)continue;const h=m.atlas?.reaction?.type?String(m.atlas.reaction.type):null,g={exists:!!m.atlas.exists,downloaded:!!m.atlas.downloaded,blacklisted:!!m.atlas.blacklisted,reactionType:h};a.set(m.url,g),a.set(X(m.url),g)}if(a.size===0)return;const d=document.querySelectorAll("img, video, a[href]");for(const m of d){const h=Pe(m);if(h.length===0)continue;const g=h.map(c=>a.get(c)||a.get(X(c))).find(c=>!!(c&&(c.exists||c.downloaded||c.blacklisted||c.reactionType)))??null;g&&(m.setAttribute("data-atlas-marked","1"),g.blacklisted?m.setAttribute("data-atlas-state","blacklisted"):g.reactionType?m.setAttribute("data-atlas-state","reacted"):g.downloaded?m.setAttribute("data-atlas-state","downloaded"):g.exists&&m.setAttribute("data-atlas-state","exists"),g.reactionType&&m.setAttribute("data-atlas-reaction",g.reactionType))}}function St(){const e=new Set,r=document.querySelectorAll("img, video, a[href]");for(const d of r)for(const m of Pe(d))e.add(m),e.add(X(m));const a=Re();return a?.url&&(e.add(a.url),e.add(X(a.url))),[...e].filter(Boolean)}function Tt(){const e=St();if(e.length===0){se(x);return}A({type:"atlas-check-batch",urls:e},r=>{if(!r?.ok){se(x);return}const a=Array.isArray(r.data?.results)?r.data.results:[];for(const d of a)d?.url&&j.set(String(d.url),{exists:!!d.exists,downloaded:!!d.downloaded,blacklisted:!!d.blacklisted,reactionType:d.reaction?.type?String(d.reaction.type):null,ts:Date.now()});se(x)})}}function gt(t){return new Promise(n=>{const y=document.body||document.documentElement,f=Array.from(y.querySelectorAll("img, video")),p=f.length,A=new Set,M=[];let w=0;const U=b=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(b,{timeout:500});return}setTimeout(()=>b({timeRemaining:()=>25}),0)},l=b=>{const E=typeof b?.timeRemaining=="function"?b.timeRemaining():25;let N=0;for(;w<p&&(N<80||E>5);){const C=f[w];if(C.closest&&C.closest(`#${o}`)){w+=1,N+=1;continue}const _=ke(C,450);_?.url&&!A.has(_.url)&&(A.add(_.url),M.push(_)),w+=1,N+=1}if(t?.({scanned:w,total:p}),w<p){U(l);return}const H=Re();H&&!A.has(H.url)&&(A.add(H.url),M.push(H)),n(M)};U(l)})}function Ie(t){return function(y,f="info"){const p=document.createElement("div");p.className=`atlas-downloader-toast${f==="danger"?" danger":""}`,p.textContent=y,t.appendChild(p),requestAnimationFrame(()=>p.classList.add("show")),setTimeout(()=>{p.classList.remove("show"),p.addEventListener("transitionend",()=>p.remove(),{once:!0})},2600)}}function Oe(t){return n=>new Promise(y=>{const f=document.createElement("div");f.className="atlas-downloader-dialog-backdrop";const p=document.createElement("div");p.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),p.setAttribute("role","dialog"),p.setAttribute("aria-modal","true"),p.setAttribute("aria-label",n.title);const A=document.createElement("h3");A.className="atlas-downloader-dialog-title",A.textContent=n.title;const M=document.createElement("p");M.className="atlas-downloader-dialog-message",M.textContent=n.message;const w=document.createElement("div");w.className="atlas-downloader-dialog-actions";const U=E=>{f.remove(),y(E)};if(n.alternateLabel){const E=document.createElement("button");E.type="button",E.className="atlas-downloader-dialog-btn secondary",E.textContent=n.alternateLabel,E.addEventListener("click",()=>U("alternate")),w.appendChild(E)}const l=document.createElement("button");l.type="button",l.className="atlas-downloader-dialog-btn",l.textContent=n.cancelLabel||"Cancel",l.addEventListener("click",()=>U("cancel")),w.appendChild(l);const b=document.createElement("button");b.type="button",b.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),b.textContent=n.confirmLabel,b.addEventListener("click",()=>U("confirm")),w.appendChild(b),p.appendChild(A),p.appendChild(M),p.appendChild(w),f.appendChild(p),t.appendChild(f),requestAnimationFrame(()=>{b.focus()})})}function wt(){if(document.getElementById($e))return;const t=document.createElement("style");t.id=$e,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function X(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function je(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>xe(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Qe(t,n){const y=(t||"").toLowerCase();if(!y)return!1;for(const f of n)if(Me(y,f))return!0;return!1}function xe(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const y=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(y).hostname}catch{return""}}function Me(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}function qe(t){const n=t.enabled??!0,y=t.getHintShown??(()=>!1),f=t.setHintShown??(()=>{}),p=()=>{y()||(f(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},A=(w,U,l,b=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:w,pending:U,reactionType:l,url:b}}))},M=w=>(typeof w.composedPath=="function"?w.composedPath():[]).some(l=>l instanceof HTMLElement&&l.id===o);document.addEventListener("click",w=>{!n||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||M(w)||!((w.target instanceof Element?w.target:null)?.closest?.("img, video")??null)||(w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation())},!0),document.addEventListener("mousedown",w=>{if(!n||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||M(w))return;const l=(w.target instanceof Element?w.target:null)?.closest?.("img, video")??null;if(!l)return;const b=w.button===0?"like":w.button===1?"love":null;if(!b)return;p(),w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation();const E=ke(l,450);if(!E){if(l instanceof HTMLVideoElement){const H=(l.currentSrc||l.src||"").trim().toLowerCase();if(H.startsWith("blob:")||H.startsWith("data:")){const C=window.location.href,_={type:b,url:C,referrer_url:C,page_title:Y(document.title,500),tag_name:"video",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",preview_url:l.poster||"",source:he(C),download_via:"yt-dlp"};_e(t.sendMessageSafe,_.url,_.referrer_url||null,Q=>{if(Q?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then($=>{A(l,!0,b,_.url),$==="confirm"&&(_.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:_},I=>{if(!I||!I.ok){A(l,!1,null,_.url),t.showToast(I?.error||"Reaction failed.","danger");return}const G=I.data||null,z=G?.file||null,ne=G?.reaction?.type?String(G.reaction.type):b;j.set(_.url,{exists:!!z,downloaded:!!z?.downloaded,blacklisted:!!z?.blacklisted_at,reactionType:ne,ts:Date.now()}),A(l,!1,ne,_.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}A(l,!0,b,_.url),t.sendMessageSafe({type:"atlas-react",payload:_},$=>{if(!$||!$.ok){A(l,!1,null,_.url),t.showToast($?.error||"Reaction failed.","danger");return}const I=$.data||null,G=I?.file||null,z=I?.reaction?.type?String(I.reaction.type):b;j.set(_.url,{exists:!!G,downloaded:!!G?.downloaded,blacklisted:!!G?.blacklisted_at,reactionType:z,ts:Date.now()}),A(l,!1,z,_.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const N={type:b,url:E.url,referrer_url:E.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:E.tag_name,width:E.width,height:E.height,alt:Y(E.alt||"",500),preview_url:E.preview_url||"",source:he(E.url)};_e(t.sendMessageSafe,N.url,N.referrer_url||null,H=>{if(H?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(C=>{A(l,!0,b,N.url),C==="confirm"&&(N.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:N},_=>{if(!_||!_.ok){A(l,!1,null,N.url),t.showToast(_?.error||"Reaction failed.","danger");return}const Q=_.data||null,$=Q?.file||null,I=Q?.reaction?.type?String(Q.reaction.type):b;j.set(N.url,{exists:!!$,downloaded:!!$?.downloaded,blacklisted:!!$?.blacklisted_at,reactionType:I,ts:Date.now()}),A(l,!1,I,N.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})});return}A(l,!0,b,N.url),t.sendMessageSafe({type:"atlas-react",payload:N},C=>{if(!C||!C.ok){A(l,!1,null,N.url),t.showToast(C?.error||"Reaction failed.","danger");return}const _=C.data||null,Q=_?.file||null,$=_?.reaction?.type?String(_.reaction.type):b;j.set(N.url,{exists:!!Q,downloaded:!!Q?.downloaded,blacklisted:!!Q?.blacklisted_at,reactionType:$,ts:Date.now()}),A(l,!1,$,N.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",w=>{if(!n||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||M(w))return;const l=(w.target instanceof Element?w.target:null)?.closest?.("img, video")??null;if(!l)return;p(),w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation();const b=ke(l,450);if(!b){if(l instanceof HTMLVideoElement){const N=(l.currentSrc||l.src||"").trim().toLowerCase();if(N.startsWith("blob:")||N.startsWith("data:")){const H=window.location.href,C={type:"dislike",url:H,referrer_url:H,page_title:Y(document.title,500),tag_name:"video",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",preview_url:l.poster||"",source:he(H),download_via:"yt-dlp"};A(l,!0,"dislike",C.url),t.sendMessageSafe({type:"atlas-react",payload:C},_=>{if(!_||!_.ok){A(l,!1,null,C.url),t.showToast(_?.error||"Reaction failed.","danger");return}A(l,!1,"dislike",C.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const E={type:"dislike",url:b.url,referrer_url:b.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:b.tag_name,width:b.width,height:b.height,alt:Y(b.alt||"",500),preview_url:b.preview_url||"",source:he(b.url)};A(l,!0,"dislike",E.url),t.sendMessageSafe({type:"atlas-react",payload:E},N=>{if(!N||!N.ok){A(l,!1,null,E.url),t.showToast(N?.error||"Reaction failed.","danger");return}A(l,!1,"dislike",E.url),t.showToast("Disliked.")})},!0)}function Fe(t,n,y){return t<n?n:t>y?y:t}function Ve(t,n){const y=ke(t,450);if(y)return{type:n,url:y.url,referrer_url:y.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:y.tag_name,width:y.width,height:y.height,alt:Y(y.alt||"",500),preview_url:y.preview_url||"",source:he(y.url)};if(t instanceof HTMLVideoElement){const f=(t.currentSrc||t.src||"").trim().toLowerCase();if(f.startsWith("blob:")||f.startsWith("data:")){const p=window.location.href;return{type:n,url:p,referrer_url:p,page_title:Y(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:he(p),download_via:"yt-dlp"}}}return null}function Ke(t){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");let y=null,f=null,p=null,A=!1,M=null,w=null,U=-1,l=-1,b=null;const E=new Map,N=()=>{const i=A||M!==null;for(const[v,D]of E.entries())D.disabled=i,D.classList.toggle("pending",A&&w===v)},H=(i,v=null)=>{A=i,w=i?v:null,N()},C=i=>{for(const v of[...Ee,K]){const D=E.get(v.type);if(!D)continue;const q=v.type===K.type?i==="dislike":i===v.type;D.classList.toggle("active",q)}},_=(i,v)=>{M=i&&v===!1&&i!=="dislike"?i:null;for(const D of[...Ee,K]){const q=E.get(D.type);if(!q)continue;const B=D.type===K.type?M==="dislike":M===D.type;q.classList.toggle("queued",B)}N()},Q=(i,v,D)=>{y&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:y,pending:i,reactionType:v,url:D}}))},$=()=>{p&&(window.clearTimeout(p),p=null)},I=()=>{A||(y=null,f=null,n.classList.remove("open"),n.style.left="",n.style.top="",C(null))},G=()=>{$(),p=window.setTimeout(()=>{n.matches(":hover")||I()},140)},z=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of[...Ee,K]){const v=document.createElement("button");v.type="button",v.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),v.setAttribute("aria-label",i.label),v.title=i.label,v.replaceChildren(ve(i.pathDs)),E.set(i.type,v),v.addEventListener("pointerdown",z,!0),v.addEventListener("mousedown",z,!0),v.addEventListener("click",D=>{if(z(D),A)return;if(!y){t.showToast("No media selected.");return}const q=i.type===K.type?"dislike":i.type,B=Ve(y,q);if(!B){t.showToast("No valid media URL found.");return}const W=B.url||"",ae=(ee=!1)=>{ee?B.force_download=!0:"force_download"in B&&delete B.force_download,Q(!0,i.type,W||null),H(!0,i.type),t.sendMessageSafe({type:"atlas-react",payload:{...B,...i.type===K.type?{blacklist:!0}:{}}},oe=>{if(H(!1,null),!oe||!oe.ok){Q(!1,null,W||null),t.showToast(oe?.error||"Reaction failed.","danger");return}const P=oe.data||null,ge=P?.file||null,we=P?.reaction?.type?String(P.reaction.type):i.type===K.type?"dislike":i.type;if(W&&j.set(W,{exists:!!ge,downloaded:!!ge?.downloaded,blacklisted:!!ge?.blacklisted_at,reactionType:we,ts:Date.now()}),C(we),_(we,!!ge?.downloaded),Q(!1,we,W||null),B.download_via==="yt-dlp"){t.showToast(`Reacted (${i.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${i.label}). Queued download in Atlas.`)})};_e(t.sendMessageSafe,W,B.referrer_url||null,ee=>{if(q!=="dislike"&&ee?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(oe=>{ae(oe==="confirm")});return}ae(!1)})}),n.appendChild(v)}t.root.appendChild(n);const ne=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(D=>D instanceof HTMLElement&&D.id===o),re=()=>{if(!y)return;const i=y.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){I();return}const v=Fe(i.top+8,8,window.innerHeight-8),D=Fe(i.right-8,8,window.innerWidth-8);n.style.top=`${v}px`,n.style.left=`${D}px`},ce=(i,v)=>{const D=W=>{if(W.matches("img, video"))return W;const ae=W.closest?.("img, video");if(ae instanceof Element)return ae;const ee=W.querySelectorAll?.("img, video");if(!ee||ee.length===0)return null;for(const oe of ee){const P=oe.getBoundingClientRect();if(i>=P.left&&i<=P.right&&v>=P.top&&v<=P.bottom)return oe}return null},q=document.elementsFromPoint?.(i,v)??[];for(const W of q){if(!(W instanceof Element)||W.closest?.(`#${o}`))continue;const ae=D(W);if(ae)return ae}const B=document.elementFromPoint?.(i,v);return B instanceof Element&&!B.closest?.(`#${o}`)?D(B):null},x=i=>{if(t.isSheetOpen()){I();return}const v=Ve(i,"like");if(!v){I();return}if(y=i,f=v.url||null,n.classList.add("open"),re(),C(null),_(null,null),f){const D=ye(f);if(D)C(D.reactionType),_(D.reactionType,D.downloaded);else{const q=f;_e(t.sendMessageSafe,q,window.location.href,B=>{B&&f===q&&(C(B.reactionType),_(B.reactionType,B.downloaded))})}}},be=i=>i?i==="blacklist"?"blacklist":i:null,ue=()=>{if(U<0||l<0||t.isSheetOpen())return;const i=ce(U,l);i&&(i.closest?.(`#${o}`)||($(),x(i)))},fe=(i=80)=>{b!==null&&window.clearTimeout(b),b=window.setTimeout(()=>{b=null,ue()},i)};document.addEventListener("pointerover",i=>{if(t.isSheetOpen()||!(i.target instanceof Element)||ne(i))return;const v=ce(i.clientX,i.clientY);v&&($(),x(v))},!0),window.addEventListener("atlas-shortcut-reaction-state",i=>{const v=i,D=v.detail?.media;if(!(D instanceof Element))return;$(),x(D);const q=!!v.detail?.pending,B=be(v.detail?.reactionType??null);if(q){H(!0,B);return}if(H(!1,null),B){const W=B==="blacklist"?"dislike":B;C(W);const ae=f?ye(f):null;_(W,ae?.downloaded??null)}},!0),document.addEventListener("pointermove",i=>{U=i.clientX,l=i.clientY},!0),document.addEventListener("pointerout",i=>{!y||t.isSheetOpen()||!(i.target instanceof Element)||ne(i)||!(i.target.closest?.("img, video")??null)||G()},!0),n.addEventListener("pointerenter",$,!0),n.addEventListener("pointerleave",G,!0),window.addEventListener("scroll",re,!0),window.addEventListener("resize",re),window.addEventListener("blur",I),window.addEventListener("focus",()=>fe(40),!0),new MutationObserver(()=>{fe(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
