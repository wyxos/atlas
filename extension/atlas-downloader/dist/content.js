(function(){"use strict";const Oe=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function qe(ne){const G=(ne||"").trim().toLowerCase();if(!G)return"";const $=G.split(".").filter(Boolean);if($.length<=2)return G;const F=$.slice(-2).join("."),le=$.slice(-3).join(".");return Oe.has(F)&&$.length>=3?le:F}function Ke(ne){const G=(ne||"").trim();if(!G)return"";try{const $=new URL(G).hostname;return qe($)}catch{return""}}(()=>{const $="atlas-downloader-root",F="atlas-open",le=(()=>{try{return window.top===window.self}catch{return!1}})(),we=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let be=null;const Xe=3e4,V=new Map,ye="http://www.w3.org/2000/svg",oe=t=>{const a=document.createElementNS(ye,"svg");a.setAttribute("viewBox","0 0 24 24"),a.setAttribute("aria-hidden","true"),a.setAttribute("fill","none"),a.setAttribute("stroke-width","2"),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round"),a.setAttribute("width","18"),a.setAttribute("height","18");for(const n of t){const l=document.createElementNS(ye,"path");l.setAttribute("d",n),l.setAttribute("fill","none"),l.setAttribute("stroke","currentColor"),l.setAttribute("stroke-width","2"),l.setAttribute("stroke-linecap","round"),l.setAttribute("stroke-linejoin","round"),a.appendChild(l)}return a},ue=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],U={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},_e="atlas-downloader-page-markers";function H(t,a){const n=typeof t=="string"?t:"";return n.length<=a?n:n.slice(0,a)}function z(t){return Ke(t)||"Extension"}function ke(t){const a=V.get(t);return a?Date.now()-a.ts>Xe?(V.delete(t),null):a:null}function re(t,a,n){if(!a){n(null);return}const l=ke(a);if(l){n(l);return}t({type:"atlas-check-batch",urls:[a]},o=>{if(!o||!o.ok){n(null);return}const m=Array.isArray(o.data?.results)?o.data.results:[],i=m.find(h=>h?.url===a)??m[0]??null;if(!i){n(null);return}const k={exists:!!i.exists,downloaded:!!i.downloaded,blacklisted:!!i.blacklisted,reactionType:i.reaction?.type?String(i.reaction.type):null,ts:Date.now()};V.set(a,k),n(k)})}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&le)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],n=>{const l=he(n.atlasBaseUrl||"");if(l&&pe(window.location.hostname,l))return;const o=Le(n.atlasExcludedDomains||"");xe(window.location.hostname,o)||(ve(),be?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const a=he(t.atlasBaseUrl||"");if(a&&pe(window.location.hostname,a))return;const n=Le(t.atlasExcludedDomains||"");xe(window.location.hostname,n)||(le?ve():je())});function je(){if(document.getElementById($))return;const t=document.createElement("div");t.id=$;const a=t.attachShadow({mode:"closed"}),n=document.createElement("link");n.rel="stylesheet",n.href=chrome.runtime.getURL("dist/content.css"),a.appendChild(n);const l=document.createElement("div");l.className="atlas-shadow-root";const o=Ee(l),m=Ce(l),i=(k,h)=>{try{chrome.runtime.sendMessage(k,h)}catch(f){(()=>{if(f instanceof Error)return f.message;if(f&&typeof f=="object"&&"message"in f){const w=f.message;return typeof w=="string"?w:String(w)}return String(f)})().includes("Extension context invalidated")?o("Atlas extension was reloaded. Refresh this tab."):o("Atlas extension error. Refresh this tab."),h(null)}};a.appendChild(l),(document.body||document.documentElement).appendChild(t),Se({showToast:o,sendMessageSafe:i,isSheetOpen:()=>!1,chooseDialog:m}),Ne({root:l,showToast:o,sendMessageSafe:i,isSheetOpen:()=>!1,chooseDialog:m})}function ve(){if(document.getElementById($))return;const t=document.createElement("div");t.id=$;const a=t.attachShadow({mode:"closed"}),n=document.createElement("link");n.rel="stylesheet",n.href=chrome.runtime.getURL("dist/content.css"),a.appendChild(n);const l=document.createElement("div");l.className="atlas-shadow-root";const o=Ee(l),m=(e,c)=>{try{chrome.runtime.sendMessage(e,c)}catch(s){(()=>{if(s instanceof Error)return s.message;if(s&&typeof s=="object"&&"message"in s){const d=s.message;return typeof d=="string"?d:String(d)}return String(s)})().includes("Extension context invalidated")?o("Atlas extension was reloaded. Refresh this tab."):o("Atlas extension error. Refresh this tab."),c(null)}},i=document.createElement("button");i.className="atlas-downloader-toggle",i.type="button",i.setAttribute("aria-label","Atlas Downloader"),i.title="Atlas Downloader";const k=document.createElement("img");k.alt="",k.src=chrome.runtime.getURL("icon.svg"),i.appendChild(k);const h=document.createElement("div");h.className="atlas-downloader-overlay";const f=document.createElement("div");f.className="atlas-downloader-modal",f.setAttribute("role","dialog"),f.setAttribute("aria-modal","true"),f.setAttribute("aria-label","Atlas Media Picker");const g=document.createElement("div");g.className="atlas-downloader-header";const w=document.createElement("div");w.className="atlas-downloader-title",w.textContent="Atlas Media Picker";const S=document.createElement("div");S.className="atlas-downloader-version",S.textContent=we?`v${we}`:"";const v=document.createElement("button");v.type="button",v.className="atlas-downloader-close",v.setAttribute("aria-label","Close"),v.textContent="x",g.appendChild(w),g.appendChild(S),g.appendChild(v);const r=document.createElement("div");r.className="atlas-downloader-toolbar";const u=te("Rescan",()=>Be()),T=te("Check Atlas",()=>Ue(!1));let x=!1,_=null;const M=te("Debug: off",()=>{x=!x,M.textContent=x?"Debug: on":"Debug: off",x?!_&&A.length>0&&(_={url:A[0].url,reactionType:"like"}):_=null,N(),D(R())}),W=te("Select all",()=>$e(!0)),P=te("Select none",()=>$e(!1)),X=document.createElement("span");X.className="spacer";const I=te("Queue selected",()=>st(),{primary:!0});r.appendChild(u),r.appendChild(T),r.appendChild(M),r.appendChild(W),r.appendChild(P),r.appendChild(X),r.appendChild(I);const O=document.createElement("div");O.className="atlas-downloader-meta";const Q=document.createElement("div");Q.className="atlas-downloader-list",f.appendChild(g),f.appendChild(r),f.appendChild(O),f.appendChild(Q),l.appendChild(i),l.appendChild(h),l.appendChild(f),a.appendChild(l),(document.body||document.documentElement).appendChild(t);const Y=Ce(l);let A=[],ie=0,ee=null;const Ye=!0;let Re=!1;i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),me()}),h.addEventListener("click",()=>de()),v.addEventListener("click",()=>de()),document.addEventListener("keydown",e=>{const c=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&c==="a"){e.preventDefault(),l.classList.contains(F)||me();return}if(e.key==="Escape"&&l.classList.contains(F)){de();return}if(!l.classList.contains(F))return;const s=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!s)return;const p=A.find(d=>d.selected)??A[0]??null;p&&(e.preventDefault(),ge(p,s,{closeOnSuccess:!0}))});function me(){l.classList.add(F),Be()}function de(){l.classList.remove(F)}be=me,Se({showToast:o,sendMessageSafe:m,isSheetOpen:()=>l.classList.contains(F),chooseDialog:Y,setHintShown:e=>{Re=e},getHintShown:()=>Re,enabled:Ye}),Ne({root:l,showToast:o,sendMessageSafe:m,isSheetOpen:()=>l.classList.contains(F),chooseDialog:Y});function te(e,c,s){const p=document.createElement("button");return p.type="button",p.className=`atlas-downloader-btn${s?.primary?" primary":""}`,p.textContent=e,p.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),c()}),p}function et(e){O.textContent=e,I.disabled=!0,u.disabled=!0,T.disabled=!0,M.disabled=!0,W.disabled=!0,P.disabled=!0}function D(e){O.textContent=e;const c=A.filter(p=>p.selected).length,s=ee!==null;I.disabled=c===0||s,u.disabled=s,T.disabled=A.length===0||s,M.disabled=A.length===0,W.disabled=A.length===0||s,P.disabled=A.length===0||s}function Be(){ie+=1;const e=ie;A=[],x&&(_=null),Q.replaceChildren(),et("Scanning this page…"),Fe(c=>{ie===e&&(O.textContent=`Scanning… ${c.scanned}/${c.total}`)}).then(c=>{ie===e&&(A=c.map(s=>({...s,selected:!0,status:"",statusClass:"",atlas:null})),x&&!_&&A.length>0&&(_={url:A[0].url,reactionType:"like"}),N(),D(R()),Ue(!0))})}function $e(e){for(const c of A)c.selected=e;N(),D(R())}function N(){if(Q.replaceChildren(),A.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",Q.appendChild(e);return}for(const e of A)Q.appendChild(tt(e))}function tt(e){const c=document.createElement("div");c.className=`atlas-downloader-item${e.selected?" selected":""}`;const s=document.createElement("input");s.type="checkbox",s.checked=e.selected,s.addEventListener("change",()=>{e.selected=s.checked,c.classList.toggle("selected",e.selected),D(R())});const p=document.createElement("div");if(p.className="atlas-downloader-preview",e.preview_url){const C=document.createElement("img");C.loading="lazy",C.alt="",C.src=e.preview_url,p.appendChild(C)}const d=document.createElement("div");d.className="atlas-downloader-info";const y=document.createElement("div");y.className="atlas-downloader-kind",y.textContent=e.tag_name;const b=document.createElement("div");b.className="atlas-downloader-url",b.textContent=e.url,b.title=e.url;const E=document.createElement("div");E.className="atlas-downloader-sub",E.textContent=nt(e);const L=document.createElement("div");L.className="atlas-downloader-reactions";const B=e.atlas?.reaction?.type||null,J=ee!==null;for(const C of ue){const q=document.createElement("button");q.type="button",q.className=`atlas-downloader-reaction-btn ${C.className}${B===C.type?" active":""}${e.reactionPending===C.type?" pending":""}`.trim(),q.setAttribute("aria-label",C.label),q.title=C.label,q.replaceChildren(oe(C.pathDs)),q.disabled=J,q.addEventListener("click",Ie=>{Ie.preventDefault(),Ie.stopPropagation(),x&&(_={url:e.url,reactionType:C.type},N()),ge(e,C.type)}),L.appendChild(q)}const j=document.createElement("button");if(j.type="button",j.className=`atlas-downloader-reaction-btn ${U.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===U.type?" pending":""}`.trim(),j.setAttribute("aria-label",U.label),j.title=U.label,j.replaceChildren(oe(U.pathDs)),j.disabled=J,j.addEventListener("click",C=>{C.preventDefault(),C.stopPropagation(),ge(e,"dislike",{blacklist:!0})}),L.appendChild(j),e.atlas?.downloaded){const C=document.createElement("button");C.type="button",C.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),C.setAttribute("aria-label","Delete download"),C.title="Delete download",C.replaceChildren(oe(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),C.disabled=J,C.addEventListener("click",q=>{q.preventDefault(),q.stopPropagation(),rt(e)}),L.appendChild(C)}d.appendChild(y),d.appendChild(b),d.appendChild(E),d.appendChild(L),x&&_?.url===e.url&&d.appendChild(at(e,_.reactionType));const Z=document.createElement("div"),We=ot(e);return Z.className=`atlas-downloader-status ${We.className}`.trim(),Z.textContent=We.text,c.addEventListener("click",C=>{C.target instanceof HTMLInputElement||(x&&(_={url:e.url,reactionType:_?.reactionType??"like"}),e.selected=!e.selected,s.checked=e.selected,c.classList.toggle("selected",e.selected),D(R()))}),c.appendChild(s),c.appendChild(p),c.appendChild(d),c.appendChild(Z),c}function He(e,c){return{type:c,url:e.url,original_url:e.original_url||e.url,referrer_url:e.referrer_url||window.location.href,page_title:H(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:H(e.alt||"",500),preview_url:e.preview_url||"",source:z(e.url),...e.download_via?{download_via:e.download_via}:{}}}function Pe(e){return{url:e.url,original_url:e.original_url||e.url,referrer_url:e.referrer_url||window.location.href,page_title:H(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:H(e.alt||"",500),preview_url:e.preview_url||"",source:z(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function at(e,c){const s=document.createElement("details");s.className="atlas-downloader-debug",s.open=!0;const p=document.createElement("summary");p.textContent="Debug payload",s.appendChild(p);const d=document.createElement("pre");return d.textContent=JSON.stringify({react:He(e,c),download:Pe(e)},null,2),s.appendChild(d),s}function nt(e){const c=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",s=lt(e.url);return s?`${c} • ${s}`:c}function lt(e){try{return new URL(e).hostname}catch{return""}}function R(){const e=A.filter(c=>c.selected).length;return`${A.length} found • ${e} selected`}function ot(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Ue(e){const c=A.map(s=>s.url).filter(Boolean);c.length!==0&&m({type:"atlas-check-batch",urls:c},s=>{if(!s){e||o("Atlas extension did not respond.");return}if(!s.ok){e||o(s.error||"Atlas check failed.");return}const p=Array.isArray(s.data?.results)?s.data.results:[],d=new Map(p.map(E=>[E.url,E]));let y=0,b=0;for(const E of A){const L=d.get(E.url);L&&(E.atlas={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,file_id:L.file_id??null,reaction:L.reaction??null},L.exists&&(y+=1),L.downloaded&&(b+=1))}N(),D(R()),ae(A),e||o(`Atlas check: ${b}/${y} downloaded.`)})}function ge(e,c,s={}){const p=(y={})=>{e.reactionPending=s.blacklist?U.type:c,e.status="Reacting…",e.statusClass="",ee=e.url,N(),D(R());const b={...He(e,c),...y,...s.blacklist?{blacklist:!0}:{}};m({type:"atlas-react",payload:b},E=>{if(e.reactionPending=null,ee=null,!E){e.status="No response",e.statusClass="err",N(),D(R()),o("Atlas extension did not respond.");return}if(!E.ok){e.status=E.error||"Failed",e.statusClass="err",N(),D(R()),o(E.error||"Reaction failed.");return}const L=E.data||null,B=L?.file||null;e.atlas={exists:!!B,downloaded:!!B?.downloaded,blacklisted:!!B?.blacklisted_at,file_id:B?.id??null,reaction:L?.reaction??null},V.set(e.url,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&c!=="dislike"?(e.status="Queued",e.statusClass="queued"):(e.status="",e.statusClass=""),N(),D(R()),ae(A),s.closeOnSuccess&&de(),e.atlas.exists&&!e.atlas.downloaded&&c!=="dislike"&&ce([e.url],0)})},d=!!e.atlas?.reaction?.type;if(c!=="dislike"&&e.atlas?.downloaded&&d){Y({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(y=>{p(y==="confirm"?{force_download:!0}:{})});return}if(c==="dislike"&&e.atlas?.downloaded){Y({title:s.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(y=>{if(y==="alternate"){o("Cancelled.");return}p(y==="confirm"?{clear_download:!0}:{})});return}p()}function rt(e){Y({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(c=>{c==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",ee=e.url,N(),D(R()),m({type:"atlas-delete-download",payload:{url:e.url,original_url:e.original_url||e.url,tag_name:e.tag_name,download_via:e.download_via||null}},s=>{if(e.reactionPending=null,ee=null,!s||!s.ok){e.status=s?.error||"Failed",e.statusClass="err",N(),D(R()),o(s?.error||"Delete failed.");return}const p=s.data?.file||null;e.atlas={exists:!!p,downloaded:!!p?.downloaded,blacklisted:!!p?.blacklisted_at,file_id:p?.id??null,reaction:e.atlas?.reaction??null},e.status="",e.statusClass="",N(),D(R()),ae(A),o("Download deleted.")}))})}function st(){const e=A.filter(p=>p.selected);if(e.length===0){o("Select one or more items first.");return}if(e.some(p=>!!p.atlas?.downloaded)){Y({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(p=>{if(p==="alternate"){o("Cancelled.");return}s(p==="confirm")});return}s(!1);function s(p){I.disabled=!0,u.disabled=!0,T.disabled=!0,W.disabled=!0,P.disabled=!0;for(const y of e)y.status="Sending…",y.statusClass="";N();const d=e.map(y=>{const b=Pe(y);return p&&(b.force_download=!0),b});m({type:"atlas-download-batch",payloads:d},y=>{if(!y){for(const L of e)L.status="No response",L.statusClass="err";N(),D(R()),o("Atlas extension did not respond.");return}const b=Array.isArray(y.results)?y.results:[],E=[];for(let L=0;L<e.length;L+=1){const B=e[L],J=b[L];if(J?.ok){const j=J.data||null,Z=j?.file||null;B.atlas={exists:!!Z,downloaded:!!Z?.downloaded,blacklisted:!!Z?.blacklisted_at,file_id:Z?.id??null,reaction:B.atlas?.reaction??null},j?.queued?(B.status="Queued",B.statusClass="queued",E.push(B.url)):(B.status="",B.statusClass="")}else B.status=J?.error||"Failed",B.statusClass="err"}N(),D(R()),ae(A),y.ok?o(`Queued ${e.length} download(s) in Atlas.`):o(y.error||"Some requests failed."),E.length>0&&ce(E,0)})}}function ce(e,c){c>15||setTimeout(()=>{m({type:"atlas-check-batch",urls:e},s=>{if(!s||!s.ok){ce(e,c+1);return}const p=Array.isArray(s.data?.results)?s.data.results:[],d=new Map(p.map(b=>[b.url,b]));let y=0;for(const b of A){const E=d.get(b.url);E&&(b.atlas={exists:!!E.exists,downloaded:!!E.downloaded,blacklisted:!!E.blacklisted,file_id:E.file_id??null,reaction:E.reaction??null},E.downloaded?b.status==="Queued"&&(b.status="",b.statusClass=""):y+=1)}N(),D(R()),ae(A),y>0&&ce(e,c+1)})},2e3)}function ae(e){Je();const c=document.querySelectorAll('[data-atlas-marked="1"]');for(const d of c)d.removeAttribute("data-atlas-marked"),d.removeAttribute("data-atlas-state"),d.removeAttribute("data-atlas-reaction");const s=new Map;for(const d of e){if(!d?.url||!d?.atlas)continue;const y=d.atlas?.reaction?.type?String(d.atlas.reaction.type):null,b={exists:!!d.atlas.exists,downloaded:!!d.atlas.downloaded,blacklisted:!!d.atlas.blacklisted,reactionType:y};s.set(d.url,b),s.set(Te(d.url),b)}if(s.size===0)return;const p=document.querySelectorAll("img, video, a[href]");for(const d of p){const y=d instanceof HTMLImageElement?K(d.currentSrc)||K(d.src)||"":d instanceof HTMLVideoElement?Ae(d)||"":d instanceof HTMLAnchorElement&&K(d.href)||"";if(!y)continue;const b=s.get(y)||s.get(Te(y));b&&(d.setAttribute("data-atlas-marked","1"),b.downloaded?d.setAttribute("data-atlas-state","downloaded"):b.blacklisted?d.setAttribute("data-atlas-state","blacklisted"):b.reactionType?d.setAttribute("data-atlas-state","reacted"):b.exists&&d.setAttribute("data-atlas-state","exists"),b.reactionType&&d.setAttribute("data-atlas-reaction",b.reactionType))}}}function Fe(t){return new Promise(a=>{const n=document.body||document.documentElement,l=Array.from(n.querySelectorAll("img, video")),o=l.length,m=new Set,i=[];let k=0;const h=g=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(g,{timeout:500});return}setTimeout(()=>g({timeRemaining:()=>25}),0)},f=g=>{const w=typeof g?.timeRemaining=="function"?g.timeRemaining():25;let S=0;for(;k<o&&(S<80||w>5);){const r=l[k];if(r.closest&&r.closest(`#${$}`)){k+=1,S+=1;continue}const u=se(r);u?.url&&!m.has(u.url)&&(m.add(u.url),i.push(u)),k+=1,S+=1}if(t?.({scanned:k,total:o}),k<o){h(f);return}const v=Ve();v&&!m.has(v.url)&&(m.add(v.url),i.push(v)),a(i)};h(f)})}function se(t){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,n=a.naturalWidth||a.width||a.clientWidth||null,l=a.naturalHeight||a.height||a.clientHeight||null;if(n&&l&&(n<450||l<450))return null;const o=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),m=K(o);if(!m){const i=K(document.referrer)||"";return!i||!o.toLowerCase().startsWith("blob:")&&!o.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:i,original_url:i,referrer_url:o,preview_url:"",width:n,height:l,alt:a.alt||""}}return{tag_name:"img",url:m,original_url:m,referrer_url:window.location.href,preview_url:m,width:n,height:l,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=Ae(t);if(!a){const n=t,l=(n.currentSrc||n.src||"").trim().toLowerCase();if(l.startsWith("blob:")||l.startsWith("data:")){const o=window.location.href;return{tag_name:"video",url:o,original_url:`${o}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,referrer_url:o,preview_url:n.poster||"",width:n.videoWidth||n.clientWidth||null,height:n.videoHeight||n.clientHeight||null,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:a,original_url:a,referrer_url:window.location.href,preview_url:t.poster||"",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:""}}return null}function Ve(){const t=(window.location.href||"").trim();if(!t)return null;const a=t.toLowerCase(),n=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(a),l=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!n&&!l)return null;if(a.startsWith("http://")||a.startsWith("https://"))return{tag_name:a.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,original_url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(a.startsWith("blob:")||a.startsWith("data:")){const o=K(document.referrer)||"";return o?{tag_name:"img",url:o,original_url:o,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function Ae(t){const a=K(t.currentSrc)||K(t.src)||K(t.getAttribute("src"));if(a)return a;const n=t.querySelector("source[src]"),l=n?K(n.src||n.getAttribute("src")):"";if(l)return l;const o=ze(t);return o||Qe()}function Qe(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const a of t){const l=document.querySelector(a)?.getAttribute("content"),o=K(l||"");if(o)return o}return""}function ze(t){let a=t,n=0;for(;a&&n<8;){const l=a.getAttribute?.("data-store");if(l){const o=Ze(l),m=fe(o,0);if(m)return m}a=a.parentElement,n+=1}return""}function Ze(t){if(!t)return null;const a=Ge(t);try{return JSON.parse(a)}catch{return null}}function Ge(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function fe(t,a){if(!t||a>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const l of t){const o=fe(l,a+1);if(o)return o}return""}if(typeof t!="object")return"";const n=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const l of n){const o=t[l];if(typeof o=="string"&&o.startsWith("http"))return o}for(const l of Object.keys(t)){const o=fe(t[l],a+1);if(o)return o}return""}function Ee(t){return function(n){const l=document.createElement("div");l.className="atlas-downloader-toast",l.textContent=n,t.appendChild(l),requestAnimationFrame(()=>l.classList.add("show")),setTimeout(()=>{l.classList.remove("show"),l.addEventListener("transitionend",()=>l.remove(),{once:!0})},2600)}}function Ce(t){return a=>new Promise(n=>{const l=document.createElement("div");l.className="atlas-downloader-dialog-backdrop";const o=document.createElement("div");o.className=`atlas-downloader-dialog${a.danger?" danger":""}`.trim(),o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.setAttribute("aria-label",a.title);const m=document.createElement("h3");m.className="atlas-downloader-dialog-title",m.textContent=a.title;const i=document.createElement("p");i.className="atlas-downloader-dialog-message",i.textContent=a.message;const k=document.createElement("div");k.className="atlas-downloader-dialog-actions";const h=w=>{l.remove(),n(w)};if(a.alternateLabel){const w=document.createElement("button");w.type="button",w.className="atlas-downloader-dialog-btn secondary",w.textContent=a.alternateLabel,w.addEventListener("click",()=>h("alternate")),k.appendChild(w)}const f=document.createElement("button");f.type="button",f.className="atlas-downloader-dialog-btn",f.textContent=a.cancelLabel||"Cancel",f.addEventListener("click",()=>h("cancel")),k.appendChild(f);const g=document.createElement("button");g.type="button",g.className=`atlas-downloader-dialog-btn primary${a.danger?" danger":""}`.trim(),g.textContent=a.confirmLabel,g.addEventListener("click",()=>h("confirm")),k.appendChild(g),o.appendChild(m),o.appendChild(i),o.appendChild(k),l.appendChild(o),t.appendChild(l),requestAnimationFrame(()=>{g.focus()})})}function Je(){if(document.getElementById(_e))return;const t=document.createElement("style");t.id=_e,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function Te(t){const a=t.indexOf("#");return a===-1?t:t.slice(0,a)}function Le(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(a=>a.trim()).filter(a=>a&&!a.startsWith("#")).map(a=>(a.startsWith("*.")?a.slice(2):a).toLowerCase()).map(a=>he(a)||a.replace(/^\.+/,"").trim()).filter(Boolean)}function xe(t,a){const n=(t||"").toLowerCase();if(!n)return!1;for(const l of a)if(pe(n,l))return!0;return!1}function he(t){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const n=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(n).hostname}catch{return""}}function pe(t,a){return!t||!a?!1:t===a||t.endsWith(`.${a}`)}function K(t){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const n=a.toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")||n.startsWith("chrome-extension:")||n.startsWith("moz-extension:")||n.startsWith("safari-extension:")?"":a}function Se(t){const a=t.enabled??!0,n=t.getHintShown??(()=>!1),l=t.setHintShown??(()=>{}),o=()=>{n()||(l(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},m=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(h=>h instanceof HTMLElement&&h.id===$);document.addEventListener("click",i=>{!a||!(i instanceof MouseEvent)||!i.altKey||t.isSheetOpen()||m(i)||!((i.target instanceof Element?i.target:null)?.closest?.("img, video")??null)||(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation())},!0),document.addEventListener("mousedown",i=>{if(!a||!(i instanceof MouseEvent)||!i.altKey||t.isSheetOpen()||m(i))return;const h=(i.target instanceof Element?i.target:null)?.closest?.("img, video")??null;if(!h)return;const f=i.button===0?"like":i.button===1?"love":null;if(!f)return;o(),i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();const g=se(h);if(!g){if(h instanceof HTMLVideoElement){const S=(h.currentSrc||h.src||"").trim().toLowerCase();if(S.startsWith("blob:")||S.startsWith("data:")){const v=window.location.href,r=`${v}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,u={type:f,url:v,original_url:r,referrer_url:v,page_title:H(document.title,500),tag_name:"video",width:h.videoWidth||h.clientWidth||null,height:h.videoHeight||h.clientHeight||null,alt:"",preview_url:h.poster||"",source:z(v),download_via:"yt-dlp"};re(t.sendMessageSafe,u.url,T=>{if(T?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(x=>{x==="confirm"&&(u.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:u},_=>{if(!_||!_.ok){t.showToast(_?.error||"Reaction failed.");return}const M=_.data||null,W=M?.file||null,P=M?.reaction?.type?String(M.reaction.type):f;V.set(u.url,{exists:!!W,downloaded:!!W?.downloaded,blacklisted:!!W?.blacklisted_at,reactionType:P,ts:Date.now()}),t.showToast(`Reacted (${f}). Resolving video in Atlas…`)})});return}t.sendMessageSafe({type:"atlas-react",payload:u},x=>{if(!x||!x.ok){t.showToast(x?.error||"Reaction failed.");return}const _=x.data||null,M=_?.file||null,W=_?.reaction?.type?String(_.reaction.type):f;V.set(u.url,{exists:!!M,downloaded:!!M?.downloaded,blacklisted:!!M?.blacklisted_at,reactionType:W,ts:Date.now()}),t.showToast(`Reacted (${f}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const w={type:f,url:g.url,original_url:g.url,referrer_url:window.location.href,page_title:H(document.title,500),tag_name:g.tag_name,width:g.width,height:g.height,alt:H(g.alt||"",500),preview_url:g.preview_url||"",source:z(g.url)};re(t.sendMessageSafe,w.url,S=>{if(S?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(v=>{v==="confirm"&&(w.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:w},r=>{if(!r||!r.ok){t.showToast(r?.error||"Reaction failed.");return}const u=r.data||null,T=u?.file||null,x=u?.reaction?.type?String(u.reaction.type):f;V.set(w.url,{exists:!!T,downloaded:!!T?.downloaded,blacklisted:!!T?.blacklisted_at,reactionType:x,ts:Date.now()}),t.showToast(`Reacted (${f}). Queued download in Atlas.`)})});return}t.sendMessageSafe({type:"atlas-react",payload:w},v=>{if(!v||!v.ok){t.showToast(v?.error||"Reaction failed.");return}const r=v.data||null,u=r?.file||null,T=r?.reaction?.type?String(r.reaction.type):f;V.set(w.url,{exists:!!u,downloaded:!!u?.downloaded,blacklisted:!!u?.blacklisted_at,reactionType:T,ts:Date.now()}),t.showToast(`Reacted (${f}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",i=>{if(!a||!(i instanceof MouseEvent)||!i.altKey||t.isSheetOpen()||m(i))return;const h=(i.target instanceof Element?i.target:null)?.closest?.("img, video")??null;if(!h)return;o(),i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();const f=se(h);if(!f){if(h instanceof HTMLVideoElement){const w=(h.currentSrc||h.src||"").trim().toLowerCase();if(w.startsWith("blob:")||w.startsWith("data:")){const S=window.location.href,v=`${S}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,r={type:"dislike",url:S,original_url:v,referrer_url:S,page_title:H(document.title,500),tag_name:"video",width:h.videoWidth||h.clientWidth||null,height:h.videoHeight||h.clientHeight||null,alt:"",preview_url:h.poster||"",source:z(S),download_via:"yt-dlp"};t.sendMessageSafe({type:"atlas-react",payload:r},u=>{if(!u||!u.ok){t.showToast(u?.error||"Reaction failed.");return}t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const g={type:"dislike",url:f.url,original_url:f.url,referrer_url:window.location.href,page_title:H(document.title,500),tag_name:f.tag_name,width:f.width,height:f.height,alt:H(f.alt||"",500),preview_url:f.preview_url||"",source:z(f.url)};t.sendMessageSafe({type:"atlas-react",payload:g},w=>{if(!w||!w.ok){t.showToast(w?.error||"Reaction failed.");return}t.showToast("Disliked.")})},!0)}function Me(t,a,n){return t<a?a:t>n?n:t}function De(t,a){const n=se(t);if(n)return{type:a,url:n.url,original_url:n.url,referrer_url:window.location.href,page_title:H(document.title,500),tag_name:n.tag_name,width:n.width,height:n.height,alt:H(n.alt||"",500),preview_url:n.preview_url||"",source:z(n.url)};if(t instanceof HTMLVideoElement){const l=(t.currentSrc||t.src||"").trim().toLowerCase();if(l.startsWith("blob:")||l.startsWith("data:")){const o=window.location.href,m=`${o}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`;return{type:a,url:o,original_url:m,referrer_url:o,page_title:H(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:z(o),download_via:"yt-dlp"}}}return null}function Ne(t){const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");let n=null,l=null,o=null;const m=new Map,i=r=>{for(const u of ue){const T=m.get(u.type);T&&T.classList.toggle("active",r===u.type)}},k=()=>{o&&(window.clearTimeout(o),o=null)},h=()=>{n=null,l=null,a.classList.remove("open"),a.style.left="",a.style.top="",i(null)},f=()=>{k(),o=window.setTimeout(()=>{a.matches(":hover")||h()},140)},g=r=>{r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation?.()};for(const r of[...ue,U]){const u=document.createElement("button");u.type="button",u.className=`atlas-downloader-reaction-btn ${r.className}`.trim(),u.setAttribute("aria-label",r.label),u.title=r.label,u.replaceChildren(oe(r.pathDs)),m.set(r.type,u),u.addEventListener("pointerdown",g,!0),u.addEventListener("mousedown",g,!0),u.addEventListener("click",T=>{if(g(T),!n){t.showToast("No media selected.");return}const x=r.type===U.type?"dislike":r.type,_=De(n,x);if(!_){t.showToast("No valid media URL found.");return}const M=_.url||"";re(t.sendMessageSafe,M,W=>{if(x!=="dislike"&&W?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(P=>{P==="confirm"&&(_.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:{..._,...r.type===U.type?{blacklist:!0}:{}}},X=>{if(!X||!X.ok){t.showToast(X?.error||"Reaction failed.");return}const I=X.data||null,O=I?.file||null,Q=I?.reaction?.type?String(I.reaction.type):r.type===U.type?"dislike":r.type;if(M&&V.set(M,{exists:!!O,downloaded:!!O?.downloaded,blacklisted:!!O?.blacklisted_at,reactionType:Q,ts:Date.now()}),i(Q),_.download_via==="yt-dlp"){t.showToast(`Reacted (${r.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${r.label}). Queued download in Atlas.`)})});return}t.sendMessageSafe({type:"atlas-react",payload:{..._,...r.type===U.type?{blacklist:!0}:{}}},P=>{if(!P||!P.ok){t.showToast(P?.error||"Reaction failed.");return}const X=P.data||null,I=X?.file||null,O=X?.reaction?.type?String(X.reaction.type):r.type===U.type?"dislike":r.type;if(M&&V.set(M,{exists:!!I,downloaded:!!I?.downloaded,blacklisted:!!I?.blacklisted_at,reactionType:O,ts:Date.now()}),i(O),_.download_via==="yt-dlp"){t.showToast(`Reacted (${r.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${r.label}). Queued download in Atlas.`)})})}),a.appendChild(u)}t.root.appendChild(a);const w=r=>(typeof r.composedPath=="function"?r.composedPath():[]).some(T=>T instanceof HTMLElement&&T.id===$),S=()=>{if(!n)return;const r=n.getBoundingClientRect();if(!Number.isFinite(r.left)||r.width<=0||r.height<=0){h();return}const u=Me(r.top+8,8,window.innerHeight-8),T=Me(r.right-8,8,window.innerWidth-8);a.style.top=`${u}px`,a.style.left=`${T}px`},v=r=>{if(t.isSheetOpen()){h();return}const u=De(r,"like");if(!u){h();return}if(n=r,l=u.url||null,a.classList.add("open"),S(),i(null),l){const T=ke(l);if(T)i(T.reactionType);else{const x=l;re(t.sendMessageSafe,x,_=>{_&&l===x&&i(_.reactionType)})}}};document.addEventListener("pointerover",r=>{if(t.isSheetOpen()||!(r.target instanceof Element)||w(r))return;const u=r.target.closest?.("img, video")??null;u&&(k(),v(u))},!0),document.addEventListener("pointerout",r=>{!n||t.isSheetOpen()||!(r.target instanceof Element)||w(r)||!(r.target.closest?.("img, video")??null)||f()},!0),a.addEventListener("pointerenter",k,!0),a.addEventListener("pointerleave",f,!0),window.addEventListener("scroll",S,!0),window.addEventListener("resize",S),window.addEventListener("blur",h)}})()})();
