(function(){"use strict";const ot=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function lt(s){const u=(s||"").trim().toLowerCase();if(!u)return"";const i=u.split(".").filter(Boolean);if(i.length<=2)return u;const b=i.slice(-2).join("."),C=i.slice(-3).join(".");return ot.has(b)&&i.length>=3?C:b}function rt(s){const u=(s||"").trim();if(!u)return"";try{const i=new URL(u).hostname;return lt(i)}catch{return""}}function st(s,u){if(!s||typeof s!="string")return"";const i=s.trim();if(!i)return"";const b=i.toLowerCase();if(b.startsWith("blob:")||b.startsWith("data:")||b.startsWith("chrome-extension:")||b.startsWith("moz-extension:")||b.startsWith("safari-extension:"))return"";try{const C=new URL(i,u);return C.protocol!=="http:"&&C.protocol!=="https:"?"":C.toString()}catch{return""}}function it(s){return/\.(gif|webp)(\?|#|$)/i.test(s||"")}function dt(s){let u=s,i=0;for(;u&&i<24;){const b=u.getAttribute?.("role");if(b==="dialog"||b==="alertdialog"||u.getAttribute?.("aria-modal")==="true")return!0;const Q=(u.getAttribute?.("class")||"").toLowerCase(),le=(u.getAttribute?.("id")||"").toLowerCase(),ie=`${Q} ${le}`.trim();if(ie&&/(modal|lightbox|overlay|dialog)/.test(ie))return!0;const ve=window.getComputedStyle(u);if((ve.position==="fixed"||ve.position==="sticky")&&ut(u))return!0;u=u.parentElement,i+=1}return!1}function ct(s,u){return!!(it(u)||dt(s))}function ut(s){const u=s.getBoundingClientRect();if(u.width>0&&u.height>0){const i=Math.max(window.innerWidth*.4,320),b=Math.max(window.innerHeight*.4,240);return u.width>=i&&u.height>=b}if(s instanceof HTMLElement){const i=s.style,b=i.inset==="0"||i.inset==="0px"||(i.top==="0"||i.top==="0px")&&(i.left==="0"||i.left==="0px")&&(i.right==="0"||i.right==="0px")&&(i.bottom==="0"||i.bottom==="0px"),C=/^(100vw|100%)$/i.test(i.width||"")||/^(100vh|100%)$/i.test(i.height||"");return b||C}return!1}function te(s){return st(s,window.location.href)}function Be(s){const u=te(s.currentSrc)||te(s.src)||te(s.getAttribute("src")||"");if(u)return u;const i=s.querySelector("source[src]"),b=i?te(i.src||i.getAttribute("src")||""):"";if(b)return b;const C=mt(s);return C||pt()}function Ae(s,u){if(!(s instanceof Element))return null;if(s.tagName==="IMG"){const i=s,b=i.naturalWidth||i.width||i.clientWidth||null,C=i.naturalHeight||i.height||i.clientHeight||null,Q=(i.currentSrc||i.src||i.getAttribute("src")||"").trim(),le=te(Q);if(!ct(i,le||Q)&&b&&C&&(b<u||C<u))return null;if(!le){const ie=te(document.referrer)||te(window.location.href)||"";return!ie||!Q.toLowerCase().startsWith("blob:")&&!Q.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:ie,referrer_url:window.location.href,preview_url:"",width:b,height:C,alt:i.alt||""}}return{tag_name:"img",url:le,referrer_url:window.location.href,preview_url:le,width:b,height:C,alt:i.alt||""}}if(s.tagName==="VIDEO"){const i=s,b=i.videoWidth||i.clientWidth||null,C=i.videoHeight||i.clientHeight||null;if(b&&C&&(b<u||C<u))return null;const Q=Be(i);if(!Q){const le=(i.currentSrc||i.src||"").trim().toLowerCase();if(le.startsWith("blob:")||le.startsWith("data:")){const ie=window.location.href;return{tag_name:"video",url:ie,referrer_url:ie,preview_url:i.poster||"",width:b,height:C,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:Q,referrer_url:window.location.href,preview_url:i.poster||"",width:b,height:C,alt:""}}return null}function Re(){const s=(window.location.href||"").trim();if(!s)return null;const u=s.toLowerCase(),i=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(u),b=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!i&&!b)return null;if(u.startsWith("http://")||u.startsWith("https://"))return{tag_name:u.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:s,referrer_url:s,preview_url:s,width:null,height:null,alt:""};if(u.startsWith("blob:")||u.startsWith("data:")){const C=te(document.referrer)||"";return C?{tag_name:"img",url:C,referrer_url:s,preview_url:"",width:null,height:null,alt:""}:null}return null}function Pe(s){const u=new Set,i=te(window.location.href),b=s instanceof HTMLImageElement?te(s.currentSrc)||te(s.src)||"":s instanceof HTMLVideoElement?Be(s)||"":s instanceof HTMLAnchorElement&&$e(s.getAttribute("href")||"")||"";b&&u.add(b);const C=s.closest("a[href]")?.getAttribute("href")??"",Q=$e(C);return Q&&u.add(Q),i&&ft(s)&&u.add(i),[...u]}function $e(s){const u=(s||"").trim();return!u||u.startsWith("#")||u.toLowerCase().startsWith("javascript:")?"":te(u)}function ft(s){if(s instanceof HTMLImageElement){const u=(s.currentSrc||s.src||s.getAttribute("src")||"").trim().toLowerCase();return u.startsWith("blob:")||u.startsWith("data:")}if(s instanceof HTMLVideoElement){const u=(s.currentSrc||s.src||"").trim().toLowerCase();return u.startsWith("blob:")||u.startsWith("data:")}return!1}function pt(){const s=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const u of s){const b=document.querySelector(u)?.getAttribute("content")||"",C=te(b);if(C)return C}return""}function mt(s){let u=s,i=0;for(;u&&i<8;){const b=u.getAttribute?.("data-store");if(b){const C=ht(b),Q=xe(C,0);if(Q)return Q}u=u.parentElement,i+=1}return""}function ht(s){if(!s)return null;const u=gt(s);try{return JSON.parse(u)}catch{return null}}function gt(s){return!s||typeof s!="string"?"":s.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function xe(s,u){if(!s||u>4)return"";if(typeof s=="string")return s.startsWith("http")?s:"";if(Array.isArray(s)){for(const i of s){const b=xe(i,u+1);if(b)return b}return""}if(typeof s=="object")for(const i of Object.keys(s)){const b=s[i],C=xe(b,u+1);if(C)return C}return""}(()=>{const i="atlas-downloader-root",b="atlas-open",C=(()=>{try{return window.top===window.self}catch{return!1}})(),Q=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let le=null,ie=null;const ve=3e4,Y=new Map,Ue="http://www.w3.org/2000/svg",_e=t=>{const n=document.createElementNS(Ue,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const w of t){const p=document.createElementNS(Ue,"path");p.setAttribute("d",w),p.setAttribute("fill","none"),p.setAttribute("stroke","currentColor"),p.setAttribute("stroke-width","2"),p.setAttribute("stroke-linecap","round"),p.setAttribute("stroke-linejoin","round"),n.appendChild(p)}return n},Le=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],z={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},He="atlas-downloader-page-markers";function ne(t,n){const w=typeof t=="string"?t:"";return w.length<=n?w:w.slice(0,n)}function we(t){return rt(t)||"Extension"}function ye(t){const n=Y.get(t);return n?Date.now()-n.ts>ve?(Y.delete(t),null):n:null}function Ce(t,n,w,p){const m=q((n||"").trim());if(!m){p(null);return}const A=ye(m);if(A){p(A);return}t({type:"atlas-check-batch",urls:[m]},x=>{if(!x||!x.ok){p(null);return}const g=Array.isArray(x.data?.results)?x.data.results:[],l=new Map(g.filter(_=>typeof _?.url=="string"&&_.url.trim()!=="").map(_=>[q(String(_.url)),_])).get(m)??null;if(!l){p(null);return}const y={exists:!!l.exists,downloaded:!!l.downloaded,blacklisted:!!l.blacklisted,reactionType:l.reaction?.type?String(l.reaction.type):null,ts:Date.now()};Y.set(m,y),p(y)})}chrome.runtime.onMessage.addListener(t=>{if(!t||typeof t!="object")return;const n=t;if(n.type==="atlas-download-event"){ie?.(n.payload);return}if(n.type==="atlas-open-sheet"&&C)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],w=>{const p=Me(w.atlasBaseUrl||"");if(p&&Ne(window.location.hostname,p))return;const m=je(w.atlasExcludedDomains||"");Qe(window.location.hostname,m)||(Ie(),le?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const n=Me(t.atlasBaseUrl||"");if(n&&Ne(window.location.hostname,n))return;const w=je(t.atlasExcludedDomains||"");Qe(window.location.hostname,w)||(C?Ie():wt())});function wt(){if(document.getElementById(i))return;const t=document.createElement("div");t.id=i;const n=t.attachShadow({mode:"closed"}),w=document.createElement("link");w.rel="stylesheet",w.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(w);const p=document.createElement("div");p.className="atlas-shadow-root";const m=We(p),A=Oe(p),x=(g,U)=>{try{chrome.runtime.sendMessage(g,U)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const _=l.message;return typeof _=="string"?_:String(_)}return String(l)})().includes("Extension context invalidated")?m("Atlas extension was reloaded. Refresh this tab.","danger"):m("Atlas extension error. Refresh this tab.","danger"),U(null)}};n.appendChild(p),(document.body||document.documentElement).appendChild(t),qe({showToast:m,sendMessageSafe:x,isSheetOpen:()=>!1,chooseDialog:A}),Ke({root:p,showToast:m,sendMessageSafe:x,isSheetOpen:()=>!1,chooseDialog:A})}function Ie(){if(document.getElementById(i))return;const t=document.createElement("div");t.id=i;const n=t.attachShadow({mode:"closed"}),w=document.createElement("link");w.rel="stylesheet",w.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(w);const p=document.createElement("div");p.className="atlas-shadow-root";const m=We(p),A=(e,o)=>{try{chrome.runtime.sendMessage(e,o)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const f=a.message;return typeof f=="string"?f:String(f)}return String(a)})().includes("Extension context invalidated")?m("Atlas extension was reloaded. Refresh this tab.","danger"):m("Atlas extension error. Refresh this tab.","danger"),o(null)}},x=document.createElement("button");x.className="atlas-downloader-toggle",x.type="button",x.setAttribute("aria-label","Atlas Downloader"),x.title="Atlas Downloader";const g=document.createElement("img");g.alt="",g.src=chrome.runtime.getURL("icon.svg"),x.appendChild(g);const U=document.createElement("div");U.className="atlas-downloader-overlay";const l=document.createElement("div");l.className="atlas-downloader-modal",l.setAttribute("role","dialog"),l.setAttribute("aria-modal","true"),l.setAttribute("aria-label","Atlas Media Picker");const y=document.createElement("div");y.className="atlas-downloader-header";const _=document.createElement("div");_.className="atlas-downloader-title",_.textContent="Atlas Media Picker";const N=document.createElement("div");N.className="atlas-downloader-version",N.textContent=Q?`v${Q}`:"";const $=document.createElement("button");$.type="button",$.className="atlas-downloader-close",$.setAttribute("aria-label","Close"),$.textContent="x",y.appendChild(_),y.appendChild(N),y.appendChild($);const S=document.createElement("div");S.className="atlas-downloader-toolbar";const L=ee("Rescan",()=>Xe()),F=ee("Check Atlas",()=>tt(!1)),H=ee("Select all",()=>ze(!0)),W=ee("Select none",()=>ze(!1)),ae=document.createElement("span");ae.className="spacer";const G=ee("Queue selected",()=>St(),{primary:!0});S.appendChild(L),S.appendChild(F),S.appendChild(H),S.appendChild(W),S.appendChild(ae),S.appendChild(G);const de=document.createElement("div");de.className="atlas-downloader-meta";const ce=document.createElement("div");ce.className="atlas-downloader-list",l.appendChild(y),l.appendChild(S),l.appendChild(de),l.appendChild(ce),p.appendChild(x),p.appendChild(U),p.appendChild(l),n.appendChild(p),(document.body||document.documentElement).appendChild(t);const me=Oe(p);let T=[],be=0,he=null,ge=null,Ee=null;const r=new Set,v=new Map,D=!0;let K=!1;ie=e=>{if(!e||typeof e!="object")return;const o=e,a=Number.isFinite(Number(o.transferId))?Number(o.transferId):null,d=typeof o.status=="string"?o.status:"",f=!!o.downloaded||d==="completed"||typeof o.finished_at=="string",h=!!o.failed||d==="failed"||d==="canceled"||typeof o.failed_at=="string",k=new Set,c=typeof o.original=="string"?q(o.original.trim()):"",E=typeof o.referrer_url=="string"?q(o.referrer_url.trim()):"";c&&k.add(c),E&&k.add(E);const M=a?v.get(a)??"":"";if(M&&k.add(M),k.size===0)return;const j=c||M||E||"";a&&j&&!f&&!h&&v.set(a,j);let J=!1;for(const B of k){const oe=ye(B);Y.set(B,{exists:!0,downloaded:f,blacklisted:oe?!!oe.blacklisted:!1,reactionType:oe?.reactionType??null,ts:Date.now()})}for(const B of T){const oe=fe(B)||q(String(B.url||""));!oe||!k.has(oe)||!r.has(oe)&&B.status!=="Queued"||(B.atlas={exists:!0,downloaded:f,blacklisted:B.atlas?.blacklisted??!1,file_id:B.atlas?.file_id??null,reaction:B.atlas?.reaction??null},f?(B.status="",B.statusClass="",B.reactionQueued=null,r.delete(oe)):h?(B.status="Failed",B.statusClass="err",B.reactionQueued=null,r.delete(oe)):(B.status="Queued",B.statusClass="queued"),J=!0)}a&&(f||h)&&v.delete(a),J&&(X(),I(V()),pe(T))},x.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),O()}),U.addEventListener("click",()=>Z()),$.addEventListener("click",()=>Z()),document.addEventListener("keydown",e=>{const o=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&o==="a"){e.preventDefault(),O();return}if(e.key==="Escape"&&p.classList.contains(b)){Z();return}if(!p.classList.contains(b))return;const a=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!a)return;const d=T.find(f=>f.selected)??T[0]??null;d&&(e.preventDefault(),De(d,a,{closeOnSuccess:!0}))});function P(){p.classList.add(b),Xe()}function O(){if(p.classList.contains(b)){Z();return}P()}function Z(){p.classList.remove(b)}le=O,qe({showToast:m,sendMessageSafe:A,isSheetOpen:()=>p.classList.contains(b),chooseDialog:me,setHintShown:e=>{K=e},getHintShown:()=>K,enabled:D}),Ke({root:p,showToast:m,sendMessageSafe:A,isSheetOpen:()=>p.classList.contains(b),chooseDialog:me}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const o=e,a=!!o.detail?.pending,d=o.detail?.reactionType?String(o.detail.reactionType):null,h=(typeof o.detail?.url=="string"?o.detail.url:"")||o.detail?.media&&Ae(o.detail.media,400)?.url||"",k=h?q(h):"";if(a){he=k||"__external-reaction__";for(const c of T)k&&q(String(c.url||""))!==k||(c.reactionPending=d||c.reactionPending||"like");X(),I(V());return}he=null;for(const c of T){if(k&&q(String(c.url||""))!==k)continue;c.reactionPending&&(c.reactionPending=null);const E=(k?ye(k):null)??ye(fe(c))??ye(q(String(c.url||"")));E?c.atlas={exists:!!E.exists,downloaded:!!E.downloaded,blacklisted:!!E.blacklisted,file_id:c.atlas?.file_id??null,reaction:E.reactionType?{type:E.reactionType}:c.atlas?.reaction??null}:d&&(c.atlas={exists:c.atlas?.exists??!0,downloaded:c.atlas?.downloaded??!1,blacklisted:c.atlas?.blacklisted??!1,file_id:c.atlas?.file_id??null,reaction:{type:d}}),c.atlas?.exists&&!c.atlas?.downloaded&&c.atlas?.reaction?.type&&c.atlas.reaction.type!=="dislike"?c.reactionQueued=c.atlas.reaction.type:c.reactionQueued=null}X(),I(V()),pe(T)},!0);const re=(e=300)=>{Ee!==null&&window.clearTimeout(Ee),Ee=window.setTimeout(()=>{Ee=null,xt()},e)};new MutationObserver(()=>{pe(T),re(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>re(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&re(120)},!0),re(120);function ee(e,o,a){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${a?.primary?" primary":""}`,d.textContent=e,d.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),o()}),d}function ke(e){de.textContent=e,G.disabled=!0,L.disabled=!0,F.disabled=!0,H.disabled=!0,W.disabled=!0}function I(e){de.textContent=e;const o=T.filter(d=>d.selected).length,a=T.some(d=>!!d.reactionPending)||he==="__external-reaction__";G.disabled=o===0||a,L.disabled=a,F.disabled=T.length===0||a,H.disabled=T.length===0||a,W.disabled=T.length===0||a}function Xe(){be+=1;const e=be;T=[],ge=null,ce.replaceChildren(),ke("Scanning this page…"),yt(o=>{be===e&&(de.textContent=`Scanning… ${o.scanned}/${o.total}`)}).then(o=>{be===e&&(T=o.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),X(),I(V()),tt(!0))})}function ze(e){for(const o of T)o.selected=e;X(),I(V())}function X(){if(ce.replaceChildren(),T.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",ce.appendChild(e);return}for(const e of T)ce.appendChild(kt(e))}function kt(e){const o=document.createElement("div");o.className=`atlas-downloader-item${e.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=e.selected,a.addEventListener("change",()=>{e.selected=a.checked,o.classList.toggle("selected",e.selected),I(V())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",e.preview_url){const R=document.createElement("img");R.loading="lazy",R.alt="",R.src=e.preview_url,d.appendChild(R)}const f=document.createElement("div");f.className="atlas-downloader-info";const h=document.createElement("div");h.className="atlas-downloader-kind",h.textContent=e.tag_name;const k=document.createElement("div");k.className="atlas-downloader-url",k.textContent=e.url,k.title=e.url;const c=document.createElement("div");c.className="atlas-downloader-sub",c.textContent=Et(e);const E=document.createElement("div");E.className="atlas-downloader-reactions";const M=e.atlas?.reaction?.type||null,j=!!e.reactionPending||!!e.reactionQueued;for(const R of Le){const se=document.createElement("button");se.type="button",se.className=`atlas-downloader-reaction-btn ${R.className}${M===R.type?" active":""}${e.reactionPending===R.type?" pending":""}${e.reactionQueued===R.type?" queued":""}`.trim(),se.setAttribute("aria-label",R.label),se.title=R.label,se.replaceChildren(_e(R.pathDs)),se.disabled=j,se.addEventListener("click",at=>{at.preventDefault(),at.stopPropagation(),De(e,R.type)}),E.appendChild(se)}const J=document.createElement("button");if(J.type="button",J.className=`atlas-downloader-reaction-btn ${z.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===z.type?" pending":""}${e.reactionQueued===z.type?" queued":""}`.trim(),J.setAttribute("aria-label",z.label),J.title=z.label,J.replaceChildren(_e(z.pathDs)),J.disabled=j,J.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),De(e,"dislike",{blacklist:!0})}),E.appendChild(J),e.atlas?.downloaded){const R=document.createElement("button");R.type="button",R.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),R.setAttribute("aria-label","Delete download"),R.title="Delete download",R.replaceChildren(_e(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),R.disabled=j,R.addEventListener("click",se=>{se.preventDefault(),se.stopPropagation(),Ct(e)}),E.appendChild(R)}const B=document.createElement("button");B.type="button",B.className=`atlas-downloader-debug-toggle${ge===e.url?" active":""}`,B.textContent=ge===e.url?"Hide debug":"Debug",B.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),ge=ge===e.url?null:e.url,X(),I(V())}),E.appendChild(B),f.appendChild(h),f.appendChild(k),f.appendChild(c),f.appendChild(E),ge===e.url&&f.appendChild(At(e));const oe=document.createElement("div"),nt=Lt(e);return oe.className=`atlas-downloader-status ${nt.className}`.trim(),oe.textContent=nt.text,o.addEventListener("click",R=>{R.target instanceof HTMLInputElement||(e.selected=!e.selected,a.checked=e.selected,o.classList.toggle("selected",e.selected),I(V()))}),o.appendChild(a),o.appendChild(d),o.appendChild(f),o.appendChild(oe),o}function Ze(e,o){return{type:o,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:ne(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:ne(e.alt||"",500),preview_url:e.preview_url||"",source:we(e.url),...e.download_via?{download_via:e.download_via}:{}}}function Je(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:ne(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:ne(e.alt||"",500),preview_url:e.preview_url||"",source:we(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function At(e){const o=document.createElement("details");o.className="atlas-downloader-debug",o.open=!0;const a=document.createElement("summary");a.textContent="Debug payload",o.appendChild(a);const d={react:Ze(e,e.atlas?.reaction?.type||"like"),download:Je(e)};return o.appendChild(vt(d)),o}function vt(e,o=0){const a=document.createElement("div");a.className="atlas-downloader-json-tree";const d=Se(e);if(!Ge(d)){const h=document.createElement("div");return h.className="atlas-downloader-json-line",h.textContent=et(d),a.appendChild(h),a}const f=Array.isArray(d)?d.map((h,k)=>[String(k),h]):Object.entries(d);for(const[h,k]of f)a.appendChild(Ye(h,k,o));return a}function Ye(e,o,a){const d=Se(o),f=document.createElement("div");if(f.className="atlas-downloader-json-line",f.style.paddingLeft=`${a*12}px`,!Ge(d))return f.innerHTML=`<span class="atlas-downloader-json-key">${Te(e)}</span>: <span class="atlas-downloader-json-value">${Te(et(d))}</span>`,f;const h=document.createElement("details");h.className="atlas-downloader-json-node",h.open=a===0;const k=document.createElement("summary");k.style.paddingLeft=`${a*12}px`;const c=Array.isArray(d)?`[${d.length}]`:`{${Object.keys(d).length}}`;k.innerHTML=`<span class="atlas-downloader-json-key">${Te(e)}</span>: <span class="atlas-downloader-json-preview">${Te(c)}</span>`,h.appendChild(k);const E=Array.isArray(d)?d.map((M,j)=>[String(j),M]):Object.entries(d);for(const[M,j]of E)h.appendChild(Ye(M,j,a+1));return h}function Se(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(a=>Se(a));if(!e||typeof e!="object")return null;const o={};for(const[a,d]of Object.entries(e))o[a]=Se(d);return o}function Ge(e){return Array.isArray(e)||e&&typeof e=="object"}function et(e){return JSON.stringify(e)}function Te(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Et(e){const o=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",a=_t(e.url);return a?`${o} • ${a}`:o}function _t(e){try{return new URL(e).hostname}catch{return""}}function V(){const e=T.filter(o=>o.selected).length;return`${T.length} found • ${e} selected`}function fe(e){const o=(e?.url||e?.referrer_url||"").trim();return o?q(o):""}function Lt(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function tt(e){const o=[...new Set(T.map(a=>fe(a)).filter(Boolean))];o.length!==0&&A({type:"atlas-check-batch",urls:o},a=>{if(!a){e||m("Atlas extension did not respond.","danger");return}if(!a.ok){e||m(a.error||"Atlas check failed.","danger");return}const d=Array.isArray(a.data?.results)?a.data.results:[],f=new Map(d.filter(c=>typeof c?.url=="string"&&c.url.trim()!=="").map(c=>[q(String(c.url)),c]));let h=0,k=0;for(const c of T){const E=fe(c),M=f.get(E);M&&(c.atlas={exists:!!M.exists,downloaded:!!M.downloaded,blacklisted:!!M.blacklisted,file_id:M.file_id??null,reaction:M.reaction??null},c.atlas.exists&&!c.atlas.downloaded&&c.atlas.reaction?.type&&c.atlas.reaction.type!=="dislike"?(c.reactionQueued=c.atlas.reaction.type,r.add(E)):(c.reactionQueued=null,r.delete(E)),Y.set(E,{exists:!!M.exists,downloaded:!!M.downloaded,blacklisted:!!M.blacklisted,reactionType:M.reaction?.type?String(M.reaction.type):null,ts:Date.now()}),M.exists&&(h+=1),M.downloaded&&(k+=1))}X(),I(V()),pe(T),e||m(`Atlas check: ${k}/${h} downloaded.`)})}function De(e,o,a={}){const d=(h={})=>{e.reactionPending=a.blacklist?z.type:o,e.status="Reacting…",e.statusClass="",he=fe(e)||e.url,X(),I(V());const k={...Ze(e,o),...h,...a.blacklist?{blacklist:!0}:{}};A({type:"atlas-react",payload:k},c=>{if(e.reactionPending=null,he=null,!c){e.status="No response",e.statusClass="err",X(),I(V()),m("Atlas extension did not respond.","danger");return}if(!c.ok){e.status=c.error||"Failed",e.statusClass="err",X(),I(V()),m(c.error||"Reaction failed.","danger");return}const E=c.data||null,M=E?.file||null;e.atlas={exists:!!M,downloaded:!!M?.downloaded,blacklisted:!!M?.blacklisted_at,file_id:M?.id??null,reaction:E?.reaction??null};const j=fe(e)||e.url;Y.set(j,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&o!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=a.blacklist?z.type:o,j&&r.add(j)):(e.status="",e.statusClass="",e.reactionQueued=null,j&&r.delete(j)),X(),I(V()),pe(T),a.closeOnSuccess&&Z()})},f=!!e.atlas?.reaction?.type;if(o!=="dislike"&&e.atlas?.downloaded&&f){me({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(h=>{d(h==="confirm"?{force_download:!0}:{})});return}if(o==="dislike"&&e.atlas?.downloaded){me({title:a.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(h=>{if(h==="alternate"){m("Cancelled.");return}d(h==="confirm"?{clear_download:!0}:{})});return}d()}function Ct(e){me({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(o=>{o==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",he=fe(e)||e.url,X(),I(V()),A({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},a=>{if(e.reactionPending=null,he=null,!a||!a.ok){e.status=a?.error||"Failed",e.statusClass="err",X(),I(V()),m(a?.error||"Delete failed.","danger");return}const d=a.data?.file||null;e.atlas={exists:!!d,downloaded:!!d?.downloaded,blacklisted:!!d?.blacklisted_at,file_id:d?.id??null,reaction:null},e.reactionQueued=null;const f=fe(e)||e.url;Y.set(f,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",X(),I(V()),pe(T),m("Download deleted.")}))})}function St(){const e=T.filter(d=>d.selected);if(e.length===0){m("Select one or more items first.");return}if(e.some(d=>!!d.atlas?.downloaded)){me({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(d=>{if(d==="alternate"){m("Cancelled.");return}a(d==="confirm")});return}a(!1);function a(d){G.disabled=!0,L.disabled=!0,F.disabled=!0,H.disabled=!0,W.disabled=!0;for(const h of e)h.status="Sending…",h.statusClass="";X();const f=e.map(h=>{const k=Je(h);return d&&(k.force_download=!0),k});A({type:"atlas-download-batch",payloads:f},h=>{if(!h){for(const c of e)c.status="No response",c.statusClass="err";X(),I(V()),m("Atlas extension did not respond.","danger");return}const k=Array.isArray(h.results)?h.results:[];for(let c=0;c<e.length;c+=1){const E=e[c],M=k[c];if(M?.ok){const j=M.data||null,J=j?.file||null;if(E.atlas={exists:!!J,downloaded:!!J?.downloaded,blacklisted:!!J?.blacklisted_at,file_id:J?.id??null,reaction:E.atlas?.reaction??null},j?.queued){E.status="Queued",E.statusClass="queued",E.atlas?.reaction?.type&&E.atlas.reaction.type!=="dislike"&&(E.reactionQueued=E.atlas.reaction.type);const B=fe(E)||q(String(E.url||""));B&&r.add(B)}else{E.status="",E.statusClass="",E.reactionQueued=null;const B=fe(E)||q(String(E.url||""));B&&r.delete(B)}}else E.status=M?.error||"Failed",E.statusClass="err"}X(),I(V()),pe(T),h.ok?m(`Queued ${e.length} download(s) in Atlas.`):m(h.error||"Some requests failed.","danger")})}}function pe(e=T){bt();const o=document.querySelectorAll('[data-atlas-marked="1"]');for(const f of o)f.removeAttribute("data-atlas-marked"),f.removeAttribute("data-atlas-state"),f.removeAttribute("data-atlas-reaction");const a=new Map;for(const[f,h]of Y.entries()){if(Date.now()-h.ts>ve){Y.delete(f);continue}a.set(f,{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null}),a.set(q(f),{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null})}for(const f of e){if(!f?.url||!f?.atlas)continue;const h=f.atlas?.reaction?.type?String(f.atlas.reaction.type):null,k={exists:!!f.atlas.exists,downloaded:!!f.atlas.downloaded,blacklisted:!!f.atlas.blacklisted,reactionType:h};a.set(f.url,k),a.set(q(f.url),k)}if(a.size===0)return;const d=document.querySelectorAll("img, video, a[href]");for(const f of d){const h=Pe(f);if(h.length===0)continue;const k=h.map(c=>a.get(c)||a.get(q(c))).find(c=>!!(c&&(c.exists||c.downloaded||c.blacklisted||c.reactionType)))??null;k&&(f.setAttribute("data-atlas-marked","1"),k.blacklisted?f.setAttribute("data-atlas-state","blacklisted"):k.reactionType?f.setAttribute("data-atlas-state","reacted"):k.downloaded?f.setAttribute("data-atlas-state","downloaded"):k.exists&&f.setAttribute("data-atlas-state","exists"),k.reactionType&&f.setAttribute("data-atlas-reaction",k.reactionType))}}function Tt(){const e=new Set,o=document.querySelectorAll("img, video, a[href]");for(const d of o)for(const f of Pe(d))e.add(f),e.add(q(f));const a=Re();return a?.url&&(e.add(a.url),e.add(q(a.url))),[...e].filter(Boolean)}function xt(){const e=Tt();if(e.length===0){pe(T);return}A({type:"atlas-check-batch",urls:e},o=>{if(!o?.ok){pe(T);return}const a=Array.isArray(o.data?.results)?o.data.results:[];for(const d of a)d?.url&&Y.set(String(d.url),{exists:!!d.exists,downloaded:!!d.downloaded,blacklisted:!!d.blacklisted,reactionType:d.reaction?.type?String(d.reaction.type):null,ts:Date.now()});pe(T)})}}function yt(t){return new Promise(n=>{const w=document.body||document.documentElement,p=Array.from(w.querySelectorAll("img, video")),m=p.length,A=new Set,x=[];let g=0;const U=y=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(y,{timeout:500});return}setTimeout(()=>y({timeRemaining:()=>25}),0)},l=y=>{const _=typeof y?.timeRemaining=="function"?y.timeRemaining():25;let N=0;for(;g<m&&(N<80||_>5);){const S=p[g];if(S.closest&&S.closest(`#${i}`)){g+=1,N+=1;continue}const L=Ae(S,400);L?.url&&!A.has(L.url)&&(A.add(L.url),x.push(L)),g+=1,N+=1}if(t?.({scanned:g,total:m}),g<m){U(l);return}const $=Re();$&&!A.has($.url)&&(A.add($.url),x.push($)),n(x)};U(l)})}function We(t){return function(w,p="info"){const m=document.createElement("div");m.className=`atlas-downloader-toast${p==="danger"?" danger":""}`,m.textContent=w,t.appendChild(m),requestAnimationFrame(()=>m.classList.add("show")),setTimeout(()=>{m.classList.remove("show"),m.addEventListener("transitionend",()=>m.remove(),{once:!0})},2600)}}function Oe(t){return n=>new Promise(w=>{const p=document.createElement("div");p.className="atlas-downloader-dialog-backdrop";const m=document.createElement("div");m.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),m.setAttribute("role","dialog"),m.setAttribute("aria-modal","true"),m.setAttribute("aria-label",n.title);const A=document.createElement("h3");A.className="atlas-downloader-dialog-title",A.textContent=n.title;const x=document.createElement("p");x.className="atlas-downloader-dialog-message",x.textContent=n.message;const g=document.createElement("div");g.className="atlas-downloader-dialog-actions";const U=_=>{p.remove(),w(_)};if(n.alternateLabel){const _=document.createElement("button");_.type="button",_.className="atlas-downloader-dialog-btn secondary",_.textContent=n.alternateLabel,_.addEventListener("click",()=>U("alternate")),g.appendChild(_)}const l=document.createElement("button");l.type="button",l.className="atlas-downloader-dialog-btn",l.textContent=n.cancelLabel||"Cancel",l.addEventListener("click",()=>U("cancel")),g.appendChild(l);const y=document.createElement("button");y.type="button",y.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),y.textContent=n.confirmLabel,y.addEventListener("click",()=>U("confirm")),g.appendChild(y),m.appendChild(A),m.appendChild(x),m.appendChild(g),p.appendChild(m),t.appendChild(p),requestAnimationFrame(()=>{y.focus()})})}function bt(){if(document.getElementById(He))return;const t=document.createElement("style");t.id=He,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function q(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function je(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>Me(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Qe(t,n){const w=(t||"").toLowerCase();if(!w)return!1;for(const p of n)if(Ne(w,p))return!0;return!1}function Me(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const w=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(w).hostname}catch{return""}}function Ne(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}function qe(t){const n=t.enabled??!0,w=t.getHintShown??(()=>!1),p=t.setHintShown??(()=>{}),m=()=>{w()||(p(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},A=(g,U,l,y=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:g,pending:U,reactionType:l,url:y}}))},x=g=>(typeof g.composedPath=="function"?g.composedPath():[]).some(l=>l instanceof HTMLElement&&l.id===i);document.addEventListener("click",g=>{!n||!(g instanceof MouseEvent)||!g.altKey||t.isSheetOpen()||x(g)||!((g.target instanceof Element?g.target:null)?.closest?.("img, video")??null)||(g.preventDefault(),g.stopPropagation(),g.stopImmediatePropagation())},!0),document.addEventListener("mousedown",g=>{if(!n||!(g instanceof MouseEvent)||!g.altKey||t.isSheetOpen()||x(g))return;const l=(g.target instanceof Element?g.target:null)?.closest?.("img, video")??null;if(!l)return;const y=g.button===0?"like":g.button===1?"love":null;if(!y)return;m(),g.preventDefault(),g.stopPropagation(),g.stopImmediatePropagation();const _=Ae(l,400);if(!_){if(l instanceof HTMLVideoElement){const $=(l.currentSrc||l.src||"").trim().toLowerCase();if($.startsWith("blob:")||$.startsWith("data:")){const S=window.location.href,L={type:y,url:S,referrer_url:S,page_title:ne(document.title,500),tag_name:"video",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",preview_url:l.poster||"",source:we(S),download_via:"yt-dlp"};Ce(t.sendMessageSafe,L.url,L.referrer_url||null,F=>{if(F?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(H=>{A(l,!0,y,L.url),H==="confirm"&&(L.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:L},W=>{if(!W||!W.ok){A(l,!1,null,L.url),t.showToast(W?.error||"Reaction failed.","danger");return}const ae=W.data||null,G=ae?.file||null,de=ae?.reaction?.type?String(ae.reaction.type):y;Y.set(L.url,{exists:!!G,downloaded:!!G?.downloaded,blacklisted:!!G?.blacklisted_at,reactionType:de,ts:Date.now()}),A(l,!1,de,L.url),t.showToast(`Reacted (${y}). Resolving video in Atlas…`)})});return}A(l,!0,y,L.url),t.sendMessageSafe({type:"atlas-react",payload:L},H=>{if(!H||!H.ok){A(l,!1,null,L.url),t.showToast(H?.error||"Reaction failed.","danger");return}const W=H.data||null,ae=W?.file||null,G=W?.reaction?.type?String(W.reaction.type):y;Y.set(L.url,{exists:!!ae,downloaded:!!ae?.downloaded,blacklisted:!!ae?.blacklisted_at,reactionType:G,ts:Date.now()}),A(l,!1,G,L.url),t.showToast(`Reacted (${y}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const N={type:y,url:_.url,referrer_url:_.referrer_url||window.location.href,page_title:ne(document.title,500),tag_name:_.tag_name,width:_.width,height:_.height,alt:ne(_.alt||"",500),preview_url:_.preview_url||"",source:we(_.url)};Ce(t.sendMessageSafe,N.url,N.referrer_url||null,$=>{if($?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(S=>{A(l,!0,y,N.url),S==="confirm"&&(N.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:N},L=>{if(!L||!L.ok){A(l,!1,null,N.url),t.showToast(L?.error||"Reaction failed.","danger");return}const F=L.data||null,H=F?.file||null,W=F?.reaction?.type?String(F.reaction.type):y;Y.set(N.url,{exists:!!H,downloaded:!!H?.downloaded,blacklisted:!!H?.blacklisted_at,reactionType:W,ts:Date.now()}),A(l,!1,W,N.url),t.showToast(`Reacted (${y}). Queued download in Atlas.`)})});return}A(l,!0,y,N.url),t.sendMessageSafe({type:"atlas-react",payload:N},S=>{if(!S||!S.ok){A(l,!1,null,N.url),t.showToast(S?.error||"Reaction failed.","danger");return}const L=S.data||null,F=L?.file||null,H=L?.reaction?.type?String(L.reaction.type):y;Y.set(N.url,{exists:!!F,downloaded:!!F?.downloaded,blacklisted:!!F?.blacklisted_at,reactionType:H,ts:Date.now()}),A(l,!1,H,N.url),t.showToast(`Reacted (${y}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",g=>{if(!n||!(g instanceof MouseEvent)||!g.altKey||t.isSheetOpen()||x(g))return;const l=(g.target instanceof Element?g.target:null)?.closest?.("img, video")??null;if(!l)return;m(),g.preventDefault(),g.stopPropagation(),g.stopImmediatePropagation();const y=Ae(l,400);if(!y){if(l instanceof HTMLVideoElement){const N=(l.currentSrc||l.src||"").trim().toLowerCase();if(N.startsWith("blob:")||N.startsWith("data:")){const $=window.location.href,S={type:"dislike",url:$,referrer_url:$,page_title:ne(document.title,500),tag_name:"video",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",preview_url:l.poster||"",source:we($),download_via:"yt-dlp"};A(l,!0,"dislike",S.url),t.sendMessageSafe({type:"atlas-react",payload:S},L=>{if(!L||!L.ok){A(l,!1,null,S.url),t.showToast(L?.error||"Reaction failed.","danger");return}A(l,!1,"dislike",S.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const _={type:"dislike",url:y.url,referrer_url:y.referrer_url||window.location.href,page_title:ne(document.title,500),tag_name:y.tag_name,width:y.width,height:y.height,alt:ne(y.alt||"",500),preview_url:y.preview_url||"",source:we(y.url)};A(l,!0,"dislike",_.url),t.sendMessageSafe({type:"atlas-react",payload:_},N=>{if(!N||!N.ok){A(l,!1,null,_.url),t.showToast(N?.error||"Reaction failed.","danger");return}A(l,!1,"dislike",_.url),t.showToast("Disliked.")})},!0)}function Fe(t,n,w){return t<n?n:t>w?w:t}function Ve(t,n){const w=Ae(t,400);if(w)return{type:n,url:w.url,referrer_url:w.referrer_url||window.location.href,page_title:ne(document.title,500),tag_name:w.tag_name,width:w.width,height:w.height,alt:ne(w.alt||"",500),preview_url:w.preview_url||"",source:we(w.url)};if(t instanceof HTMLVideoElement){const p=(t.currentSrc||t.src||"").trim().toLowerCase();if(p.startsWith("blob:")||p.startsWith("data:")){const m=window.location.href;return{type:n,url:m,referrer_url:m,page_title:ne(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:we(m),download_via:"yt-dlp"}}}return null}function Ke(t){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");let w=null,p=null,m=null,A=!1,x=null,g=null,U=-1,l=-1,y=null;const _=new Map,N=()=>{const r=A||x!==null;for(const[v,D]of _.entries())D.disabled=r,D.classList.toggle("pending",A&&g===v)},$=(r,v=null)=>{A=r,g=r?v:null,N()},S=r=>{for(const v of[...Le,z]){const D=_.get(v.type);if(!D)continue;const K=v.type===z.type?r==="dislike":r===v.type;D.classList.toggle("active",K)}},L=(r,v)=>{x=r&&v===!1&&r!=="dislike"?r:null;for(const D of[...Le,z]){const K=_.get(D.type);if(!K)continue;const P=D.type===z.type?x==="dislike":x===D.type;K.classList.toggle("queued",P)}N()},F=(r,v,D)=>{w&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:w,pending:r,reactionType:v,url:D}}))},H=()=>{m&&(window.clearTimeout(m),m=null)},W=()=>{A||(w=null,p=null,n.classList.remove("open"),n.style.left="",n.style.top="",S(null))},ae=()=>{H(),m=window.setTimeout(()=>{n.matches(":hover")||W()},140)},G=r=>{r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation?.()};for(const r of[...Le,z]){const v=document.createElement("button");v.type="button",v.className=`atlas-downloader-reaction-btn ${r.className}`.trim(),v.setAttribute("aria-label",r.label),v.title=r.label,v.replaceChildren(_e(r.pathDs)),_.set(r.type,v),v.addEventListener("pointerdown",G,!0),v.addEventListener("mousedown",G,!0),v.addEventListener("click",D=>{if(G(D),A)return;if(!w){t.showToast("No media selected.");return}const K=r.type===z.type?"dislike":r.type,P=Ve(w,K);if(!P){t.showToast("No valid media URL found.");return}const O=P.url||"",Z=(re=!1)=>{re?P.force_download=!0:"force_download"in P&&delete P.force_download,F(!0,r.type,O||null),$(!0,r.type),t.sendMessageSafe({type:"atlas-react",payload:{...P,...r.type===z.type?{blacklist:!0}:{}}},ue=>{if($(!1,null),!ue||!ue.ok){F(!1,null,O||null),t.showToast(ue?.error||"Reaction failed.","danger");return}const ee=ue.data||null,ke=ee?.file||null,I=ee?.reaction?.type?String(ee.reaction.type):r.type===z.type?"dislike":r.type;if(O&&Y.set(O,{exists:!!ke,downloaded:!!ke?.downloaded,blacklisted:!!ke?.blacklisted_at,reactionType:I,ts:Date.now()}),S(I),L(I,!!ke?.downloaded),F(!1,I,O||null),P.download_via==="yt-dlp"){t.showToast(`Reacted (${r.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${r.label}). Queued download in Atlas.`)})};Ce(t.sendMessageSafe,O,P.referrer_url||null,re=>{if(K!=="dislike"&&re?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(ue=>{Z(ue==="confirm")});return}Z(!1)})}),n.appendChild(v)}t.root.appendChild(n);const de=r=>(typeof r.composedPath=="function"?r.composedPath():[]).some(D=>D instanceof HTMLElement&&D.id===i),ce=()=>{if(!w)return;const r=w.getBoundingClientRect();if(!Number.isFinite(r.left)||r.width<=0||r.height<=0){W();return}const v=Fe(r.top+8,8,window.innerHeight-8),D=Fe(r.right-8,8,window.innerWidth-8);n.style.top=`${v}px`,n.style.left=`${D}px`},me=(r,v)=>{const D=O=>{if(O.matches("img, video"))return O;const Z=O.closest?.("img, video");if(Z instanceof Element)return Z;const re=O.querySelectorAll?.("img, video");if(!re||re.length===0)return null;for(const ue of re){const ee=ue.getBoundingClientRect();if(r>=ee.left&&r<=ee.right&&v>=ee.top&&v<=ee.bottom)return ue}return null},K=document.elementsFromPoint?.(r,v)??[];for(const O of K){if(!(O instanceof Element)||O.closest?.(`#${i}`))continue;const Z=D(O);if(Z)return Z}const P=document.elementFromPoint?.(r,v);return P instanceof Element&&!P.closest?.(`#${i}`)?D(P):null},T=r=>{if(t.isSheetOpen()){W();return}const v=Ve(r,"like");if(!v){W();return}if(w=r,p=v.url||null,n.classList.add("open"),ce(),S(null),L(null,null),p){const D=ye(p);if(D)S(D.reactionType),L(D.reactionType,D.downloaded);else{const K=p;Ce(t.sendMessageSafe,K,window.location.href,P=>{P&&p===K&&(S(P.reactionType),L(P.reactionType,P.downloaded))})}}},be=r=>r?r==="blacklist"?"blacklist":r:null,he=()=>{if(U<0||l<0||t.isSheetOpen())return;const r=me(U,l);r&&(r.closest?.(`#${i}`)||(H(),T(r)))},ge=(r=80)=>{y!==null&&window.clearTimeout(y),y=window.setTimeout(()=>{y=null,he()},r)};document.addEventListener("pointerover",r=>{if(t.isSheetOpen()||!(r.target instanceof Element)||de(r))return;const v=me(r.clientX,r.clientY);v&&(H(),T(v))},!0),window.addEventListener("atlas-shortcut-reaction-state",r=>{const v=r,D=v.detail?.media;if(!(D instanceof Element))return;H(),T(D);const K=!!v.detail?.pending,P=be(v.detail?.reactionType??null);if(K){$(!0,P);return}if($(!1,null),P){const O=P==="blacklist"?"dislike":P;S(O);const Z=p?ye(p):null;L(O,Z?.downloaded??null)}},!0),document.addEventListener("pointermove",r=>{U=r.clientX,l=r.clientY},!0),document.addEventListener("pointerout",r=>{!w||t.isSheetOpen()||!(r.target instanceof Element)||de(r)||!(r.target.closest?.("img, video")??null)||ae()},!0),n.addEventListener("pointerenter",H,!0),n.addEventListener("pointerleave",ae,!0),window.addEventListener("scroll",ce,!0),window.addEventListener("resize",ce),window.addEventListener("blur",W),window.addEventListener("focus",()=>ge(40),!0),new MutationObserver(()=>{ge(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
