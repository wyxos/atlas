(function(){"use strict";const nt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function at(r){const u=(r||"").trim().toLowerCase();if(!u)return"";const o=u.split(".").filter(Boolean);if(o.length<=2)return u;const A=o.slice(-2).join("."),T=o.slice(-3).join(".");return nt.has(A)&&o.length>=3?T:A}function ot(r){const u=(r||"").trim();if(!u)return"";try{const o=new URL(u).hostname;return at(o)}catch{return""}}function lt(r,u){if(!r||typeof r!="string")return"";const o=r.trim();if(!o)return"";const A=o.toLowerCase();if(A.startsWith("blob:")||A.startsWith("data:")||A.startsWith("chrome-extension:")||A.startsWith("moz-extension:")||A.startsWith("safari-extension:"))return"";try{const T=new URL(o,u);return T.protocol!=="http:"&&T.protocol!=="https:"?"":T.toString()}catch{return""}}function rt(r){return/\.(gif|webp)(\?|#|$)/i.test(r||"")}function st(r){let u=r,o=0;for(;u&&o<24;){const A=u.getAttribute?.("role");if(A==="dialog"||A==="alertdialog"||u.getAttribute?.("aria-modal")==="true")return!0;const O=(u.getAttribute?.("class")||"").toLowerCase(),ce=(u.getAttribute?.("id")||"").toLowerCase(),me=`${O} ${ce}`.trim();if(me&&/(modal|lightbox|overlay|dialog)/.test(me))return!0;const j=window.getComputedStyle(u);if((j.position==="fixed"||j.position==="sticky")&&dt(u))return!0;u=u.parentElement,o+=1}return!1}function it(r,u){return!!(rt(u)||st(r))}function dt(r){const u=r.getBoundingClientRect();if(u.width>0&&u.height>0){const o=Math.max(window.innerWidth*.4,320),A=Math.max(window.innerHeight*.4,240);return u.width>=o&&u.height>=A}if(r instanceof HTMLElement){const o=r.style,A=o.inset==="0"||o.inset==="0px"||(o.top==="0"||o.top==="0px")&&(o.left==="0"||o.left==="0px")&&(o.right==="0"||o.right==="0px")&&(o.bottom==="0"||o.bottom==="0px"),T=/^(100vw|100%)$/i.test(o.width||"")||/^(100vh|100%)$/i.test(o.height||"");return A||T}return!1}function J(r){return lt(r,window.location.href)}function Be(r){const u=J(r.currentSrc)||J(r.src)||J(r.getAttribute("src")||"");if(u)return u;const o=r.querySelector("source[src]"),A=o?J(o.src||o.getAttribute("src")||""):"";if(A)return A;const T=ft(r);return T||ut()}function ke(r,u){if(!(r instanceof Element))return null;if(r.tagName==="IMG"){const o=r,A=o.naturalWidth||o.width||o.clientWidth||null,T=o.naturalHeight||o.height||o.clientHeight||null,O=(o.currentSrc||o.src||o.getAttribute("src")||"").trim(),ce=J(O);if(!it(o,ce||O)&&A&&T&&(A<u||T<u))return null;if(!ce){const me=J(document.referrer)||J(window.location.href)||"";return!me||!O.toLowerCase().startsWith("blob:")&&!O.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:me,referrer_url:window.location.href,preview_url:"",width:A,height:T,alt:o.alt||""}}return{tag_name:"img",url:ce,referrer_url:window.location.href,preview_url:ce,width:A,height:T,alt:o.alt||""}}if(r.tagName==="VIDEO"){const o=r,A=Be(o);if(!A){const T=(o.currentSrc||o.src||"").trim().toLowerCase();if(T.startsWith("blob:")||T.startsWith("data:")){const O=window.location.href;return{tag_name:"video",url:O,referrer_url:O,preview_url:o.poster||"",width:o.videoWidth||o.clientWidth||null,height:o.videoHeight||o.clientHeight||null,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:A,referrer_url:window.location.href,preview_url:o.poster||"",width:o.videoWidth||o.clientWidth||null,height:o.videoHeight||o.clientHeight||null,alt:""}}return null}function Re(){const r=(window.location.href||"").trim();if(!r)return null;const u=r.toLowerCase(),o=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(u),A=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!o&&!A)return null;if(u.startsWith("http://")||u.startsWith("https://"))return{tag_name:u.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:r,referrer_url:r,preview_url:r,width:null,height:null,alt:""};if(u.startsWith("blob:")||u.startsWith("data:")){const T=J(document.referrer)||"";return T?{tag_name:"img",url:T,referrer_url:r,preview_url:"",width:null,height:null,alt:""}:null}return null}function Pe(r){const u=new Set,o=J(window.location.href),A=r instanceof HTMLImageElement?J(r.currentSrc)||J(r.src)||"":r instanceof HTMLVideoElement?Be(r)||"":r instanceof HTMLAnchorElement&&He(r.getAttribute("href")||"")||"";A&&u.add(A);const T=r.closest("a[href]")?.getAttribute("href")??"",O=He(T);return O&&u.add(O),o&&ct(r)&&u.add(o),[...u]}function He(r){const u=(r||"").trim();return!u||u.startsWith("#")||u.toLowerCase().startsWith("javascript:")?"":J(u)}function ct(r){if(r instanceof HTMLImageElement){const u=(r.currentSrc||r.src||r.getAttribute("src")||"").trim().toLowerCase();return u.startsWith("blob:")||u.startsWith("data:")}if(r instanceof HTMLVideoElement){const u=(r.currentSrc||r.src||"").trim().toLowerCase();return u.startsWith("blob:")||u.startsWith("data:")}return!1}function ut(){const r=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const u of r){const A=document.querySelector(u)?.getAttribute("content")||"",T=J(A);if(T)return T}return""}function ft(r){let u=r,o=0;for(;u&&o<8;){const A=u.getAttribute?.("data-store");if(A){const T=pt(A),O=Ce(T,0);if(O)return O}u=u.parentElement,o+=1}return""}function pt(r){if(!r)return null;const u=mt(r);try{return JSON.parse(u)}catch{return null}}function mt(r){return!r||typeof r!="string"?"":r.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Ce(r,u){if(!r||u>4)return"";if(typeof r=="string")return r.startsWith("http")?r:"";if(Array.isArray(r)){for(const o of r){const A=Ce(o,u+1);if(A)return A}return""}if(typeof r=="object")for(const o of Object.keys(r)){const A=r[o],T=Ce(A,u+1);if(T)return T}return""}(()=>{const o="atlas-downloader-root",A="atlas-open",T=(()=>{try{return window.top===window.self}catch{return!1}})(),O=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let ce=null;const me=3e4,j=new Map,$e="http://www.w3.org/2000/svg",ve=t=>{const n=document.createElementNS($e,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const y of t){const f=document.createElementNS($e,"path");f.setAttribute("d",y),f.setAttribute("fill","none"),f.setAttribute("stroke","currentColor"),f.setAttribute("stroke-width","2"),f.setAttribute("stroke-linecap","round"),f.setAttribute("stroke-linejoin","round"),n.appendChild(f)}return n},Ee=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],X={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Ue="atlas-downloader-page-markers";function Y(t,n){const y=typeof t=="string"?t:"";return y.length<=n?y:y.slice(0,n)}function he(t){return ot(t)||"Extension"}function ye(t){const n=j.get(t);return n?Date.now()-n.ts>me?(j.delete(t),null):n:null}function _e(t,n,y,f){const m=[...new Set([n,y||""].map(k=>Q((k||"").trim())).filter(Boolean))];if(m.length===0){f(null);return}for(const k of m){const M=ye(k);if(M){f(M);return}}t({type:"atlas-check-batch",urls:m},k=>{if(!k||!k.ok){f(null);return}const M=Array.isArray(k.data?.results)?k.data.results:[],b=new Map(M.filter(w=>typeof w?.url=="string"&&w.url.trim()!=="").map(w=>[Q(String(w.url)),w])),B=b.get(Q(n))??b.get(Q(y||""))??M[0]??null;if(!B){f(null);return}const s={exists:!!B.exists,downloaded:!!B.downloaded,blacklisted:!!B.blacklisted,reactionType:B.reaction?.type?String(B.reaction.type):null,ts:Date.now()};for(const w of m)j.set(w,s);f(s)})}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&T)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],y=>{const f=xe(y.atlasBaseUrl||"");if(f&&Me(window.location.hostname,f))return;const m=je(y.atlasExcludedDomains||"");Qe(window.location.hostname,m)||(We(),ce?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const n=xe(t.atlasBaseUrl||"");if(n&&Me(window.location.hostname,n))return;const y=je(t.atlasExcludedDomains||"");Qe(window.location.hostname,y)||(T?We():ht())});function ht(){if(document.getElementById(o))return;const t=document.createElement("div");t.id=o;const n=t.attachShadow({mode:"closed"}),y=document.createElement("link");y.rel="stylesheet",y.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(y);const f=document.createElement("div");f.className="atlas-shadow-root";const m=Ie(f),k=Oe(f),M=(b,B)=>{try{chrome.runtime.sendMessage(b,B)}catch(s){(()=>{if(s instanceof Error)return s.message;if(s&&typeof s=="object"&&"message"in s){const S=s.message;return typeof S=="string"?S:String(S)}return String(s)})().includes("Extension context invalidated")?m("Atlas extension was reloaded. Refresh this tab.","danger"):m("Atlas extension error. Refresh this tab.","danger"),B(null)}};n.appendChild(f),(document.body||document.documentElement).appendChild(t),qe({showToast:m,sendMessageSafe:M,isSheetOpen:()=>!1,chooseDialog:k}),Ke({root:f,showToast:m,sendMessageSafe:M,isSheetOpen:()=>!1,chooseDialog:k})}function We(){if(document.getElementById(o))return;const t=document.createElement("div");t.id=o;const n=t.attachShadow({mode:"closed"}),y=document.createElement("link");y.rel="stylesheet",y.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(y);const f=document.createElement("div");f.className="atlas-shadow-root";const m=Ie(f),k=(e,l)=>{try{chrome.runtime.sendMessage(e,l)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const p=a.message;return typeof p=="string"?p:String(p)}return String(a)})().includes("Extension context invalidated")?m("Atlas extension was reloaded. Refresh this tab.","danger"):m("Atlas extension error. Refresh this tab.","danger"),l(null)}},M=document.createElement("button");M.className="atlas-downloader-toggle",M.type="button",M.setAttribute("aria-label","Atlas Downloader"),M.title="Atlas Downloader";const b=document.createElement("img");b.alt="",b.src=chrome.runtime.getURL("icon.svg"),M.appendChild(b);const B=document.createElement("div");B.className="atlas-downloader-overlay";const s=document.createElement("div");s.className="atlas-downloader-modal",s.setAttribute("role","dialog"),s.setAttribute("aria-modal","true"),s.setAttribute("aria-label","Atlas Media Picker");const w=document.createElement("div");w.className="atlas-downloader-header";const S=document.createElement("div");S.className="atlas-downloader-title",S.textContent="Atlas Media Picker";const N=document.createElement("div");N.className="atlas-downloader-version",N.textContent=O?`v${O}`:"";const $=document.createElement("button");$.type="button",$.className="atlas-downloader-close",$.setAttribute("aria-label","Close"),$.textContent="x",w.appendChild(S),w.appendChild(N),w.appendChild($);const C=document.createElement("div");C.className="atlas-downloader-toolbar";const E=ee("Rescan",()=>ge()),q=ee("Check Atlas",()=>Ge(!1)),U=ee("Select all",()=>we(!0)),I=ee("Select none",()=>we(!1)),G=document.createElement("span");G.className="spacer";const z=ee("Queue selected",()=>Lt(),{primary:!0});C.appendChild(E),C.appendChild(q),C.appendChild(U),C.appendChild(I),C.appendChild(G),C.appendChild(z);const ne=document.createElement("div");ne.className="atlas-downloader-meta";const re=document.createElement("div");re.className="atlas-downloader-list",s.appendChild(w),s.appendChild(C),s.appendChild(ne),s.appendChild(re),f.appendChild(M),f.appendChild(B),f.appendChild(s),n.appendChild(f),(document.body||document.documentElement).appendChild(t);const ue=Oe(f);let x=[],be=0,se=null,fe=null,Ae=null;const i=!0;let v=!1;M.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),F()}),B.addEventListener("click",()=>R()),$.addEventListener("click",()=>R()),document.addEventListener("keydown",e=>{const l=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&l==="a"){e.preventDefault(),F();return}if(e.key==="Escape"&&f.classList.contains(A)){R();return}if(!f.classList.contains(A))return;const a=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!a)return;const d=x.find(p=>p.selected)??x[0]??null;d&&(e.preventDefault(),Ne(d,a,{closeOnSuccess:!0}))});function D(){f.classList.add(A),ge()}function F(){if(f.classList.contains(A)){R();return}D()}function R(){f.classList.remove(A)}ce=F,qe({showToast:m,sendMessageSafe:k,isSheetOpen:()=>f.classList.contains(A),chooseDialog:ue,setHintShown:e=>{v=e},getHintShown:()=>v,enabled:i}),Ke({root:f,showToast:m,sendMessageSafe:k,isSheetOpen:()=>f.classList.contains(A),chooseDialog:ue}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const l=e,a=!!l.detail?.pending,d=l.detail?.reactionType?String(l.detail.reactionType):null,h=(typeof l.detail?.url=="string"?l.detail.url:"")||l.detail?.media&&ke(l.detail.media,450)?.url||"",g=h?Q(h):"";if(a){se=g||"__external-reaction__";for(const c of x)g&&Q(String(c.url||""))!==g||(c.reactionPending=d||c.reactionPending||"like");K(),H(V());return}se=null;for(const c of x){if(g&&Q(String(c.url||""))!==g)continue;c.reactionPending&&(c.reactionPending=null);const _=(g?ye(g):null)??ye(pe(c))??ye(Q(String(c.url||"")));_?c.atlas={exists:!!_.exists,downloaded:!!_.downloaded,blacklisted:!!_.blacklisted,file_id:c.atlas?.file_id??null,reaction:_.reactionType?{type:_.reactionType}:c.atlas?.reaction??null}:d&&(c.atlas={exists:c.atlas?.exists??!0,downloaded:c.atlas?.downloaded??!1,blacklisted:c.atlas?.blacklisted??!1,file_id:c.atlas?.file_id??null,reaction:{type:d}}),c.atlas?.exists&&!c.atlas?.downloaded&&c.atlas?.reaction?.type&&c.atlas.reaction.type!=="dislike"?c.reactionQueued=c.atlas.reaction.type:c.reactionQueued=null}K(),H(V()),ie(x)},!0);const W=(e=300)=>{Ae!==null&&window.clearTimeout(Ae),Ae=window.setTimeout(()=>{Ae=null,Tt()},e)};new MutationObserver(()=>{ie(x),W(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>W(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&W(120)},!0),W(120);function ee(e,l,a){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${a?.primary?" primary":""}`,d.textContent=e,d.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),l()}),d}function oe(e){ne.textContent=e,z.disabled=!0,E.disabled=!0,q.disabled=!0,U.disabled=!0,I.disabled=!0}function H(e){ne.textContent=e;const l=x.filter(d=>d.selected).length,a=se!==null;z.disabled=l===0||a,E.disabled=a,q.disabled=x.length===0||a,U.disabled=x.length===0||a,I.disabled=x.length===0||a}function ge(){be+=1;const e=be;x=[],fe=null,re.replaceChildren(),oe("Scanning this page…"),gt(l=>{be===e&&(ne.textContent=`Scanning… ${l.scanned}/${l.total}`)}).then(l=>{be===e&&(x=l.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),K(),H(V()),Ge(!0))})}function we(e){for(const l of x)l.selected=e;K(),H(V())}function K(){if(re.replaceChildren(),x.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",re.appendChild(e);return}for(const e of x)re.appendChild(yt(e))}function yt(e){const l=document.createElement("div");l.className=`atlas-downloader-item${e.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=e.selected,a.addEventListener("change",()=>{e.selected=a.checked,l.classList.toggle("selected",e.selected),H(V())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",e.preview_url){const P=document.createElement("img");P.loading="lazy",P.alt="",P.src=e.preview_url,d.appendChild(P)}const p=document.createElement("div");p.className="atlas-downloader-info";const h=document.createElement("div");h.className="atlas-downloader-kind",h.textContent=e.tag_name;const g=document.createElement("div");g.className="atlas-downloader-url",g.textContent=e.url,g.title=e.url;const c=document.createElement("div");c.className="atlas-downloader-sub",c.textContent=At(e);const _=document.createElement("div");_.className="atlas-downloader-reactions";const L=e.atlas?.reaction?.type||null,Z=se!==null||!!e.reactionQueued;for(const P of Ee){const te=document.createElement("button");te.type="button",te.className=`atlas-downloader-reaction-btn ${P.className}${L===P.type?" active":""}${e.reactionPending===P.type?" pending":""}${e.reactionQueued===P.type?" queued":""}`.trim(),te.setAttribute("aria-label",P.label),te.title=P.label,te.replaceChildren(ve(P.pathDs)),te.disabled=Z,te.addEventListener("click",tt=>{tt.preventDefault(),tt.stopPropagation(),Ne(e,P.type)}),_.appendChild(te)}const le=document.createElement("button");if(le.type="button",le.className=`atlas-downloader-reaction-btn ${X.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===X.type?" pending":""}${e.reactionQueued===X.type?" queued":""}`.trim(),le.setAttribute("aria-label",X.label),le.title=X.label,le.replaceChildren(ve(X.pathDs)),le.disabled=Z,le.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),Ne(e,"dislike",{blacklist:!0})}),_.appendChild(le),e.atlas?.downloaded){const P=document.createElement("button");P.type="button",P.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),P.setAttribute("aria-label","Delete download"),P.title="Delete download",P.replaceChildren(ve(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),P.disabled=Z,P.addEventListener("click",te=>{te.preventDefault(),te.stopPropagation(),_t(e)}),_.appendChild(P)}const de=document.createElement("button");de.type="button",de.className=`atlas-downloader-debug-toggle${fe===e.url?" active":""}`,de.textContent=fe===e.url?"Hide debug":"Debug",de.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),fe=fe===e.url?null:e.url,K(),H(V())}),_.appendChild(de),p.appendChild(h),p.appendChild(g),p.appendChild(c),p.appendChild(_),fe===e.url&&p.appendChild(bt(e));const De=document.createElement("div"),et=Et(e);return De.className=`atlas-downloader-status ${et.className}`.trim(),De.textContent=et.text,l.addEventListener("click",P=>{P.target instanceof HTMLInputElement||(e.selected=!e.selected,a.checked=e.selected,l.classList.toggle("selected",e.selected),H(V()))}),l.appendChild(a),l.appendChild(d),l.appendChild(p),l.appendChild(De),l}function Xe(e,l){return{type:l,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:Y(e.alt||"",500),preview_url:e.preview_url||"",source:he(e.url),...e.download_via?{download_via:e.download_via}:{}}}function ze(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:Y(e.alt||"",500),preview_url:e.preview_url||"",source:he(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function bt(e){const l=document.createElement("details");l.className="atlas-downloader-debug",l.open=!0;const a=document.createElement("summary");a.textContent="Debug payload",l.appendChild(a);const d={react:Xe(e,e.atlas?.reaction?.type||"like"),download:ze(e)};return l.appendChild(kt(d)),l}function kt(e,l=0){const a=document.createElement("div");a.className="atlas-downloader-json-tree";const d=Le(e);if(!Je(d)){const h=document.createElement("div");return h.className="atlas-downloader-json-line",h.textContent=Ye(d),a.appendChild(h),a}const p=Array.isArray(d)?d.map((h,g)=>[String(g),h]):Object.entries(d);for(const[h,g]of p)a.appendChild(Ze(h,g,l));return a}function Ze(e,l,a){const d=Le(l),p=document.createElement("div");if(p.className="atlas-downloader-json-line",p.style.paddingLeft=`${a*12}px`,!Je(d))return p.innerHTML=`<span class="atlas-downloader-json-key">${Se(e)}</span>: <span class="atlas-downloader-json-value">${Se(Ye(d))}</span>`,p;const h=document.createElement("details");h.className="atlas-downloader-json-node",h.open=a===0;const g=document.createElement("summary");g.style.paddingLeft=`${a*12}px`;const c=Array.isArray(d)?`[${d.length}]`:`{${Object.keys(d).length}}`;g.innerHTML=`<span class="atlas-downloader-json-key">${Se(e)}</span>: <span class="atlas-downloader-json-preview">${Se(c)}</span>`,h.appendChild(g);const _=Array.isArray(d)?d.map((L,Z)=>[String(Z),L]):Object.entries(d);for(const[L,Z]of _)h.appendChild(Ze(L,Z,a+1));return h}function Le(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(a=>Le(a));if(!e||typeof e!="object")return null;const l={};for(const[a,d]of Object.entries(e))l[a]=Le(d);return l}function Je(e){return Array.isArray(e)||e&&typeof e=="object"}function Ye(e){return JSON.stringify(e)}function Se(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function At(e){const l=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",a=vt(e.url);return a?`${l} • ${a}`:l}function vt(e){try{return new URL(e).hostname}catch{return""}}function V(){const e=x.filter(l=>l.selected).length;return`${x.length} found • ${e} selected`}function pe(e){const l=(e?.referrer_url||e?.url||"").trim();return l?Q(l):""}function Et(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Ge(e){const l=[...new Set(x.map(a=>pe(a)).filter(Boolean))];l.length!==0&&k({type:"atlas-check-batch",urls:l},a=>{if(!a){e||m("Atlas extension did not respond.","danger");return}if(!a.ok){e||m(a.error||"Atlas check failed.","danger");return}const d=Array.isArray(a.data?.results)?a.data.results:[],p=new Map(d.filter(c=>typeof c?.url=="string"&&c.url.trim()!=="").map(c=>[Q(String(c.url)),c]));let h=0,g=0;for(const c of x){const _=pe(c),L=p.get(_);L&&(c.atlas={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,file_id:L.file_id??null,reaction:L.reaction??null},c.atlas.exists&&!c.atlas.downloaded&&c.atlas.reaction?.type&&c.atlas.reaction.type!=="dislike"?c.reactionQueued=c.atlas.reaction.type:c.reactionQueued=null,j.set(_,{exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,reactionType:L.reaction?.type?String(L.reaction.type):null,ts:Date.now()}),L.exists&&(h+=1),L.downloaded&&(g+=1))}K(),H(V()),ie(x),e||m(`Atlas check: ${g}/${h} downloaded.`)})}function Ne(e,l,a={}){const d=(h={})=>{e.reactionPending=a.blacklist?X.type:l,e.status="Reacting…",e.statusClass="",se=pe(e)||e.url,K(),H(V());const g={...Xe(e,l),...h,...a.blacklist?{blacklist:!0}:{}};k({type:"atlas-react",payload:g},c=>{if(e.reactionPending=null,se=null,!c){e.status="No response",e.statusClass="err",K(),H(V()),m("Atlas extension did not respond.","danger");return}if(!c.ok){e.status=c.error||"Failed",e.statusClass="err",K(),H(V()),m(c.error||"Reaction failed.","danger");return}const _=c.data||null,L=_?.file||null;e.atlas={exists:!!L,downloaded:!!L?.downloaded,blacklisted:!!L?.blacklisted_at,file_id:L?.id??null,reaction:_?.reaction??null};const Z=pe(e)||e.url;j.set(Z,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&l!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=a.blacklist?X.type:l):(e.status="",e.statusClass="",e.reactionQueued=null),K(),H(V()),ie(x),a.closeOnSuccess&&R(),e.atlas.exists&&!e.atlas.downloaded&&l!=="dislike"&&Te([Z],0)})},p=!!e.atlas?.reaction?.type;if(l!=="dislike"&&e.atlas?.downloaded&&p){ue({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(h=>{d(h==="confirm"?{force_download:!0}:{})});return}if(l==="dislike"&&e.atlas?.downloaded){ue({title:a.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(h=>{if(h==="alternate"){m("Cancelled.");return}d(h==="confirm"?{clear_download:!0}:{})});return}d()}function _t(e){ue({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(l=>{l==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",se=pe(e)||e.url,K(),H(V()),k({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},a=>{if(e.reactionPending=null,se=null,!a||!a.ok){e.status=a?.error||"Failed",e.statusClass="err",K(),H(V()),m(a?.error||"Delete failed.","danger");return}const d=a.data?.file||null;e.atlas={exists:!!d,downloaded:!!d?.downloaded,blacklisted:!!d?.blacklisted_at,file_id:d?.id??null,reaction:null},e.reactionQueued=null;const p=pe(e)||e.url;j.set(p,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",K(),H(V()),ie(x),m("Download deleted.")}))})}function Lt(){const e=x.filter(d=>d.selected);if(e.length===0){m("Select one or more items first.");return}if(e.some(d=>!!d.atlas?.downloaded)){ue({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(d=>{if(d==="alternate"){m("Cancelled.");return}a(d==="confirm")});return}a(!1);function a(d){z.disabled=!0,E.disabled=!0,q.disabled=!0,U.disabled=!0,I.disabled=!0;for(const h of e)h.status="Sending…",h.statusClass="";K();const p=e.map(h=>{const g=ze(h);return d&&(g.force_download=!0),g});k({type:"atlas-download-batch",payloads:p},h=>{if(!h){for(const _ of e)_.status="No response",_.statusClass="err";K(),H(V()),m("Atlas extension did not respond.","danger");return}const g=Array.isArray(h.results)?h.results:[],c=[];for(let _=0;_<e.length;_+=1){const L=e[_],Z=g[_];if(Z?.ok){const le=Z.data||null,de=le?.file||null;L.atlas={exists:!!de,downloaded:!!de?.downloaded,blacklisted:!!de?.blacklisted_at,file_id:de?.id??null,reaction:L.atlas?.reaction??null},le?.queued?(L.status="Queued",L.statusClass="queued",L.atlas?.reaction?.type&&L.atlas.reaction.type!=="dislike"&&(L.reactionQueued=L.atlas.reaction.type),c.push(pe(L)||L.url)):(L.status="",L.statusClass="",L.reactionQueued=null)}else L.status=Z?.error||"Failed",L.statusClass="err"}K(),H(V()),ie(x),h.ok?m(`Queued ${e.length} download(s) in Atlas.`):m(h.error||"Some requests failed.","danger"),c.length>0&&Te(c,0)})}}function Te(e,l){l>15||setTimeout(()=>{k({type:"atlas-check-batch",urls:e},a=>{if(!a||!a.ok){Te(e,l+1);return}const d=Array.isArray(a.data?.results)?a.data.results:[],p=new Map(d.filter(g=>typeof g?.url=="string"&&g.url.trim()!=="").map(g=>[Q(String(g.url)),g]));let h=0;for(const g of x){const c=pe(g)||g.url,_=p.get(Q(c));_&&(g.atlas={exists:!!_.exists,downloaded:!!_.downloaded,blacklisted:!!_.blacklisted,file_id:_.file_id??null,reaction:_.reaction??null},c&&j.set(Q(c),{exists:!!_.exists,downloaded:!!_.downloaded,blacklisted:!!_.blacklisted,reactionType:_.reaction?.type?String(_.reaction.type):null,ts:Date.now()}),g.atlas.exists&&!g.atlas.downloaded&&g.atlas.reaction?.type&&g.atlas.reaction.type!=="dislike"?g.reactionQueued=g.atlas.reaction.type:g.reactionQueued=null,_.downloaded?g.status==="Queued"&&(g.status="",g.statusClass=""):h+=1)}K(),H(V()),ie(x),h>0&&Te(e,l+1)})},2e3)}function ie(e=x){wt();const l=document.querySelectorAll('[data-atlas-marked="1"]');for(const p of l)p.removeAttribute("data-atlas-marked"),p.removeAttribute("data-atlas-state"),p.removeAttribute("data-atlas-reaction");const a=new Map;for(const[p,h]of j.entries()){if(Date.now()-h.ts>me){j.delete(p);continue}a.set(p,{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null}),a.set(Q(p),{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null})}for(const p of e){if(!p?.url||!p?.atlas)continue;const h=p.atlas?.reaction?.type?String(p.atlas.reaction.type):null,g={exists:!!p.atlas.exists,downloaded:!!p.atlas.downloaded,blacklisted:!!p.atlas.blacklisted,reactionType:h};a.set(p.url,g),a.set(Q(p.url),g)}if(a.size===0)return;const d=document.querySelectorAll("img, video, a[href]");for(const p of d){const h=Pe(p);if(h.length===0)continue;const g=h.map(c=>a.get(c)||a.get(Q(c))).find(c=>!!(c&&(c.exists||c.downloaded||c.blacklisted||c.reactionType)))??null;g&&(p.setAttribute("data-atlas-marked","1"),g.blacklisted?p.setAttribute("data-atlas-state","blacklisted"):g.downloaded?p.setAttribute("data-atlas-state","downloaded"):g.reactionType?p.setAttribute("data-atlas-state","reacted"):g.exists&&p.setAttribute("data-atlas-state","exists"),g.reactionType&&p.setAttribute("data-atlas-reaction",g.reactionType))}}function St(){const e=new Set,l=document.querySelectorAll("img, video, a[href]");for(const d of l)for(const p of Pe(d))e.add(p),e.add(Q(p));const a=Re();return a?.url&&(e.add(a.url),e.add(Q(a.url))),[...e].filter(Boolean)}function Tt(){const e=St();if(e.length===0){ie(x);return}k({type:"atlas-check-batch",urls:e},l=>{if(!l?.ok){ie(x);return}const a=Array.isArray(l.data?.results)?l.data.results:[];for(const d of a)d?.url&&j.set(String(d.url),{exists:!!d.exists,downloaded:!!d.downloaded,blacklisted:!!d.blacklisted,reactionType:d.reaction?.type?String(d.reaction.type):null,ts:Date.now()});ie(x)})}}function gt(t){return new Promise(n=>{const y=document.body||document.documentElement,f=Array.from(y.querySelectorAll("img, video")),m=f.length,k=new Set,M=[];let b=0;const B=w=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(w,{timeout:500});return}setTimeout(()=>w({timeRemaining:()=>25}),0)},s=w=>{const S=typeof w?.timeRemaining=="function"?w.timeRemaining():25;let N=0;for(;b<m&&(N<80||S>5);){const C=f[b];if(C.closest&&C.closest(`#${o}`)){b+=1,N+=1;continue}const E=ke(C,450);E?.url&&!k.has(E.url)&&(k.add(E.url),M.push(E)),b+=1,N+=1}if(t?.({scanned:b,total:m}),b<m){B(s);return}const $=Re();$&&!k.has($.url)&&(k.add($.url),M.push($)),n(M)};B(s)})}function Ie(t){return function(y,f="info"){const m=document.createElement("div");m.className=`atlas-downloader-toast${f==="danger"?" danger":""}`,m.textContent=y,t.appendChild(m),requestAnimationFrame(()=>m.classList.add("show")),setTimeout(()=>{m.classList.remove("show"),m.addEventListener("transitionend",()=>m.remove(),{once:!0})},2600)}}function Oe(t){return n=>new Promise(y=>{const f=document.createElement("div");f.className="atlas-downloader-dialog-backdrop";const m=document.createElement("div");m.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),m.setAttribute("role","dialog"),m.setAttribute("aria-modal","true"),m.setAttribute("aria-label",n.title);const k=document.createElement("h3");k.className="atlas-downloader-dialog-title",k.textContent=n.title;const M=document.createElement("p");M.className="atlas-downloader-dialog-message",M.textContent=n.message;const b=document.createElement("div");b.className="atlas-downloader-dialog-actions";const B=S=>{f.remove(),y(S)};if(n.alternateLabel){const S=document.createElement("button");S.type="button",S.className="atlas-downloader-dialog-btn secondary",S.textContent=n.alternateLabel,S.addEventListener("click",()=>B("alternate")),b.appendChild(S)}const s=document.createElement("button");s.type="button",s.className="atlas-downloader-dialog-btn",s.textContent=n.cancelLabel||"Cancel",s.addEventListener("click",()=>B("cancel")),b.appendChild(s);const w=document.createElement("button");w.type="button",w.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),w.textContent=n.confirmLabel,w.addEventListener("click",()=>B("confirm")),b.appendChild(w),m.appendChild(k),m.appendChild(M),m.appendChild(b),f.appendChild(m),t.appendChild(f),requestAnimationFrame(()=>{w.focus()})})}function wt(){if(document.getElementById(Ue))return;const t=document.createElement("style");t.id=Ue,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function Q(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function je(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>xe(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Qe(t,n){const y=(t||"").toLowerCase();if(!y)return!1;for(const f of n)if(Me(y,f))return!0;return!1}function xe(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const y=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(y).hostname}catch{return""}}function Me(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}function qe(t){const n=t.enabled??!0,y=t.getHintShown??(()=>!1),f=t.setHintShown??(()=>{}),m=()=>{y()||(f(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},k=(b,B,s,w=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:b,pending:B,reactionType:s,url:w}}))},M=b=>(typeof b.composedPath=="function"?b.composedPath():[]).some(s=>s instanceof HTMLElement&&s.id===o);document.addEventListener("click",b=>{!n||!(b instanceof MouseEvent)||!b.altKey||t.isSheetOpen()||M(b)||!((b.target instanceof Element?b.target:null)?.closest?.("img, video")??null)||(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())},!0),document.addEventListener("mousedown",b=>{if(!n||!(b instanceof MouseEvent)||!b.altKey||t.isSheetOpen()||M(b))return;const s=(b.target instanceof Element?b.target:null)?.closest?.("img, video")??null;if(!s)return;const w=b.button===0?"like":b.button===1?"love":null;if(!w)return;m(),b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation();const S=ke(s,450);if(!S){if(s instanceof HTMLVideoElement){const $=(s.currentSrc||s.src||"").trim().toLowerCase();if($.startsWith("blob:")||$.startsWith("data:")){const C=window.location.href,E={type:w,url:C,referrer_url:C,page_title:Y(document.title,500),tag_name:"video",width:s.videoWidth||s.clientWidth||null,height:s.videoHeight||s.clientHeight||null,alt:"",preview_url:s.poster||"",source:he(C),download_via:"yt-dlp"};_e(t.sendMessageSafe,E.url,E.referrer_url||null,q=>{if(q?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(U=>{k(s,!0,w,E.url),U==="confirm"&&(E.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:E},I=>{if(!I||!I.ok){k(s,!1,null,E.url),t.showToast(I?.error||"Reaction failed.","danger");return}const G=I.data||null,z=G?.file||null,ne=G?.reaction?.type?String(G.reaction.type):w;j.set(E.url,{exists:!!z,downloaded:!!z?.downloaded,blacklisted:!!z?.blacklisted_at,reactionType:ne,ts:Date.now()}),k(s,!1,ne,E.url),t.showToast(`Reacted (${w}). Resolving video in Atlas…`)})});return}k(s,!0,w,E.url),t.sendMessageSafe({type:"atlas-react",payload:E},U=>{if(!U||!U.ok){k(s,!1,null,E.url),t.showToast(U?.error||"Reaction failed.","danger");return}const I=U.data||null,G=I?.file||null,z=I?.reaction?.type?String(I.reaction.type):w;j.set(E.url,{exists:!!G,downloaded:!!G?.downloaded,blacklisted:!!G?.blacklisted_at,reactionType:z,ts:Date.now()}),k(s,!1,z,E.url),t.showToast(`Reacted (${w}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const N={type:w,url:S.url,referrer_url:S.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:S.tag_name,width:S.width,height:S.height,alt:Y(S.alt||"",500),preview_url:S.preview_url||"",source:he(S.url)};_e(t.sendMessageSafe,N.url,N.referrer_url||null,$=>{if($?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(C=>{k(s,!0,w,N.url),C==="confirm"&&(N.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:N},E=>{if(!E||!E.ok){k(s,!1,null,N.url),t.showToast(E?.error||"Reaction failed.","danger");return}const q=E.data||null,U=q?.file||null,I=q?.reaction?.type?String(q.reaction.type):w;j.set(N.url,{exists:!!U,downloaded:!!U?.downloaded,blacklisted:!!U?.blacklisted_at,reactionType:I,ts:Date.now()}),k(s,!1,I,N.url),t.showToast(`Reacted (${w}). Queued download in Atlas.`)})});return}k(s,!0,w,N.url),t.sendMessageSafe({type:"atlas-react",payload:N},C=>{if(!C||!C.ok){k(s,!1,null,N.url),t.showToast(C?.error||"Reaction failed.","danger");return}const E=C.data||null,q=E?.file||null,U=E?.reaction?.type?String(E.reaction.type):w;j.set(N.url,{exists:!!q,downloaded:!!q?.downloaded,blacklisted:!!q?.blacklisted_at,reactionType:U,ts:Date.now()}),k(s,!1,U,N.url),t.showToast(`Reacted (${w}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",b=>{if(!n||!(b instanceof MouseEvent)||!b.altKey||t.isSheetOpen()||M(b))return;const s=(b.target instanceof Element?b.target:null)?.closest?.("img, video")??null;if(!s)return;m(),b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation();const w=ke(s,450);if(!w){if(s instanceof HTMLVideoElement){const N=(s.currentSrc||s.src||"").trim().toLowerCase();if(N.startsWith("blob:")||N.startsWith("data:")){const $=window.location.href,C={type:"dislike",url:$,referrer_url:$,page_title:Y(document.title,500),tag_name:"video",width:s.videoWidth||s.clientWidth||null,height:s.videoHeight||s.clientHeight||null,alt:"",preview_url:s.poster||"",source:he($),download_via:"yt-dlp"};k(s,!0,"dislike",C.url),t.sendMessageSafe({type:"atlas-react",payload:C},E=>{if(!E||!E.ok){k(s,!1,null,C.url),t.showToast(E?.error||"Reaction failed.","danger");return}k(s,!1,"dislike",C.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const S={type:"dislike",url:w.url,referrer_url:w.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:w.tag_name,width:w.width,height:w.height,alt:Y(w.alt||"",500),preview_url:w.preview_url||"",source:he(w.url)};k(s,!0,"dislike",S.url),t.sendMessageSafe({type:"atlas-react",payload:S},N=>{if(!N||!N.ok){k(s,!1,null,S.url),t.showToast(N?.error||"Reaction failed.","danger");return}k(s,!1,"dislike",S.url),t.showToast("Disliked.")})},!0)}function Fe(t,n,y){return t<n?n:t>y?y:t}function Ve(t,n){const y=ke(t,450);if(y)return{type:n,url:y.url,referrer_url:y.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:y.tag_name,width:y.width,height:y.height,alt:Y(y.alt||"",500),preview_url:y.preview_url||"",source:he(y.url)};if(t instanceof HTMLVideoElement){const f=(t.currentSrc||t.src||"").trim().toLowerCase();if(f.startsWith("blob:")||f.startsWith("data:")){const m=window.location.href;return{type:n,url:m,referrer_url:m,page_title:Y(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:he(m),download_via:"yt-dlp"}}}return null}function Ke(t){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");let y=null,f=null,m=null,k=!1,M=null,b=null,B=-1,s=-1,w=null;const S=new Map,N=()=>{const i=k||M!==null;for(const[v,D]of S.entries())D.disabled=i,D.classList.toggle("pending",k&&b===v)},$=(i,v=null)=>{k=i,b=i?v:null,N()},C=i=>{for(const v of[...Ee,X]){const D=S.get(v.type);if(!D)continue;const F=v.type===X.type?i==="dislike":i===v.type;D.classList.toggle("active",F)}},E=(i,v)=>{M=i&&v===!1&&i!=="dislike"?i:null;for(const D of[...Ee,X]){const F=S.get(D.type);if(!F)continue;const R=D.type===X.type?M==="dislike":M===D.type;F.classList.toggle("queued",R)}N()},q=(i,v,D)=>{y&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:y,pending:i,reactionType:v,url:D}}))},U=()=>{m&&(window.clearTimeout(m),m=null)},I=()=>{k||(y=null,f=null,n.classList.remove("open"),n.style.left="",n.style.top="",C(null))},G=()=>{U(),m=window.setTimeout(()=>{n.matches(":hover")||I()},140)},z=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of[...Ee,X]){const v=document.createElement("button");v.type="button",v.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),v.setAttribute("aria-label",i.label),v.title=i.label,v.replaceChildren(ve(i.pathDs)),S.set(i.type,v),v.addEventListener("pointerdown",z,!0),v.addEventListener("mousedown",z,!0),v.addEventListener("click",D=>{if(z(D),k)return;if(!y){t.showToast("No media selected.");return}const F=i.type===X.type?"dislike":i.type,R=Ve(y,F);if(!R){t.showToast("No valid media URL found.");return}const W=R.url||"",ae=(ee=!1)=>{ee?R.force_download=!0:"force_download"in R&&delete R.force_download,q(!0,i.type,W||null),$(!0,i.type),t.sendMessageSafe({type:"atlas-react",payload:{...R,...i.type===X.type?{blacklist:!0}:{}}},oe=>{if($(!1,null),!oe||!oe.ok){q(!1,null,W||null),t.showToast(oe?.error||"Reaction failed.","danger");return}const H=oe.data||null,ge=H?.file||null,we=H?.reaction?.type?String(H.reaction.type):i.type===X.type?"dislike":i.type;if(W&&j.set(W,{exists:!!ge,downloaded:!!ge?.downloaded,blacklisted:!!ge?.blacklisted_at,reactionType:we,ts:Date.now()}),C(we),E(we,!!ge?.downloaded),q(!1,we,W||null),R.download_via==="yt-dlp"){t.showToast(`Reacted (${i.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${i.label}). Queued download in Atlas.`)})};_e(t.sendMessageSafe,W,R.referrer_url||null,ee=>{if(F!=="dislike"&&ee?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(oe=>{ae(oe==="confirm")});return}ae(!1)})}),n.appendChild(v)}t.root.appendChild(n);const ne=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(D=>D instanceof HTMLElement&&D.id===o),re=()=>{if(!y)return;const i=y.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){I();return}const v=Fe(i.top+8,8,window.innerHeight-8),D=Fe(i.right-8,8,window.innerWidth-8);n.style.top=`${v}px`,n.style.left=`${D}px`},ue=(i,v)=>{const D=W=>{if(W.matches("img, video"))return W;const ae=W.closest?.("img, video");if(ae instanceof Element)return ae;const ee=W.querySelectorAll?.("img, video");if(!ee||ee.length===0)return null;for(const oe of ee){const H=oe.getBoundingClientRect();if(i>=H.left&&i<=H.right&&v>=H.top&&v<=H.bottom)return oe}return null},F=document.elementsFromPoint?.(i,v)??[];for(const W of F){if(!(W instanceof Element)||W.closest?.(`#${o}`))continue;const ae=D(W);if(ae)return ae}const R=document.elementFromPoint?.(i,v);return R instanceof Element&&!R.closest?.(`#${o}`)?D(R):null},x=i=>{if(t.isSheetOpen()){I();return}const v=Ve(i,"like");if(!v){I();return}if(y=i,f=v.url||null,n.classList.add("open"),re(),C(null),E(null,null),f){const D=ye(f);if(D)C(D.reactionType),E(D.reactionType,D.downloaded);else{const F=f;_e(t.sendMessageSafe,F,window.location.href,R=>{R&&f===F&&(C(R.reactionType),E(R.reactionType,R.downloaded))})}}},be=i=>i?i==="blacklist"?"blacklist":i:null,se=()=>{if(B<0||s<0||t.isSheetOpen())return;const i=ue(B,s);i&&(i.closest?.(`#${o}`)||(U(),x(i)))},fe=(i=80)=>{w!==null&&window.clearTimeout(w),w=window.setTimeout(()=>{w=null,se()},i)};document.addEventListener("pointerover",i=>{if(t.isSheetOpen()||!(i.target instanceof Element)||ne(i))return;const v=ue(i.clientX,i.clientY);v&&(U(),x(v))},!0),window.addEventListener("atlas-shortcut-reaction-state",i=>{const v=i,D=v.detail?.media;if(!(D instanceof Element))return;U(),x(D);const F=!!v.detail?.pending,R=be(v.detail?.reactionType??null);if(F){$(!0,R);return}if($(!1,null),R){const W=R==="blacklist"?"dislike":R;C(W);const ae=f?ye(f):null;E(W,ae?.downloaded??null)}},!0),document.addEventListener("pointermove",i=>{B=i.clientX,s=i.clientY},!0),document.addEventListener("pointerout",i=>{!y||t.isSheetOpen()||!(i.target instanceof Element)||ne(i)||!(i.target.closest?.("img, video")??null)||G()},!0),n.addEventListener("pointerenter",U,!0),n.addEventListener("pointerleave",G,!0),window.addEventListener("scroll",re,!0),window.addEventListener("resize",re),window.addEventListener("blur",I),window.addEventListener("focus",()=>fe(40),!0),new MutationObserver(()=>{fe(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
