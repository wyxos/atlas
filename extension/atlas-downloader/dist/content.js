(function(){"use strict";const nt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function at(r){const c=(r||"").trim().toLowerCase();if(!c)return"";const s=c.split(".").filter(Boolean);if(s.length<=2)return c;const k=s.slice(-2).join("."),C=s.slice(-3).join(".");return nt.has(k)&&s.length>=3?C:k}function ot(r){const c=(r||"").trim();if(!c)return"";try{const s=new URL(c).hostname;return at(s)}catch{return""}}function lt(r,c){if(!r||typeof r!="string")return"";const s=r.trim();if(!s)return"";const k=s.toLowerCase();if(k.startsWith("blob:")||k.startsWith("data:")||k.startsWith("chrome-extension:")||k.startsWith("moz-extension:")||k.startsWith("safari-extension:"))return"";try{const C=new URL(s,c);return C.protocol!=="http:"&&C.protocol!=="https:"?"":C.toString()}catch{return""}}function rt(r){return/\.(gif|webp)(\?|#|$)/i.test(r||"")}function st(r){let c=r,s=0;for(;c&&s<24;){const k=c.getAttribute?.("role");if(k==="dialog"||k==="alertdialog"||c.getAttribute?.("aria-modal")==="true")return!0;const O=(c.getAttribute?.("class")||"").toLowerCase(),te=(c.getAttribute?.("id")||"").toLowerCase(),ae=`${O} ${te}`.trim();if(ae&&/(modal|lightbox|overlay|dialog)/.test(ae))return!0;const j=window.getComputedStyle(c);if((j.position==="fixed"||j.position==="sticky")&&dt(c))return!0;c=c.parentElement,s+=1}return!1}function it(r,c){return!!(rt(c)||st(r))}function dt(r){const c=r.getBoundingClientRect();if(c.width>0&&c.height>0){const s=Math.max(window.innerWidth*.4,320),k=Math.max(window.innerHeight*.4,240);return c.width>=s&&c.height>=k}if(r instanceof HTMLElement){const s=r.style,k=s.inset==="0"||s.inset==="0px"||(s.top==="0"||s.top==="0px")&&(s.left==="0"||s.left==="0px")&&(s.right==="0"||s.right==="0px")&&(s.bottom==="0"||s.bottom==="0px"),C=/^(100vw|100%)$/i.test(s.width||"")||/^(100vh|100%)$/i.test(s.height||"");return k||C}return!1}function J(r){return lt(r,window.location.href)}function Be(r){const c=J(r.currentSrc)||J(r.src)||J(r.getAttribute("src")||"");if(c)return c;const s=r.querySelector("source[src]"),k=s?J(s.src||s.getAttribute("src")||""):"";if(k)return k;const C=ft(r);return C||ut()}function ke(r,c){if(!(r instanceof Element))return null;if(r.tagName==="IMG"){const s=r,k=s.naturalWidth||s.width||s.clientWidth||null,C=s.naturalHeight||s.height||s.clientHeight||null,O=(s.currentSrc||s.src||s.getAttribute("src")||"").trim(),te=J(O);if(!it(s,te||O)&&k&&C&&(k<c||C<c))return null;if(!te){const ae=J(document.referrer)||J(window.location.href)||"";return!ae||!O.toLowerCase().startsWith("blob:")&&!O.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:ae,referrer_url:window.location.href,preview_url:"",width:k,height:C,alt:s.alt||""}}return{tag_name:"img",url:te,referrer_url:window.location.href,preview_url:te,width:k,height:C,alt:s.alt||""}}if(r.tagName==="VIDEO"){const s=r,k=s.videoWidth||s.clientWidth||null,C=s.videoHeight||s.clientHeight||null;if(k&&C&&(k<c||C<c))return null;const O=Be(s);if(!O){const te=(s.currentSrc||s.src||"").trim().toLowerCase();if(te.startsWith("blob:")||te.startsWith("data:")){const ae=window.location.href;return{tag_name:"video",url:ae,referrer_url:ae,preview_url:s.poster||"",width:k,height:C,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:O,referrer_url:window.location.href,preview_url:s.poster||"",width:k,height:C,alt:""}}return null}function Re(){const r=(window.location.href||"").trim();if(!r)return null;const c=r.toLowerCase(),s=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(c),k=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!s&&!k)return null;if(c.startsWith("http://")||c.startsWith("https://"))return{tag_name:c.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:r,referrer_url:r,preview_url:r,width:null,height:null,alt:""};if(c.startsWith("blob:")||c.startsWith("data:")){const C=J(document.referrer)||"";return C?{tag_name:"img",url:C,referrer_url:r,preview_url:"",width:null,height:null,alt:""}:null}return null}function Pe(r){const c=new Set,s=J(window.location.href),k=r instanceof HTMLImageElement?J(r.currentSrc)||J(r.src)||"":r instanceof HTMLVideoElement?Be(r)||"":r instanceof HTMLAnchorElement&&Ue(r.getAttribute("href")||"")||"";k&&c.add(k);const C=r.closest("a[href]")?.getAttribute("href")??"",O=Ue(C);return O&&c.add(O),s&&ct(r)&&c.add(s),[...c]}function Ue(r){const c=(r||"").trim();return!c||c.startsWith("#")||c.toLowerCase().startsWith("javascript:")?"":J(c)}function ct(r){if(r instanceof HTMLImageElement){const c=(r.currentSrc||r.src||r.getAttribute("src")||"").trim().toLowerCase();return c.startsWith("blob:")||c.startsWith("data:")}if(r instanceof HTMLVideoElement){const c=(r.currentSrc||r.src||"").trim().toLowerCase();return c.startsWith("blob:")||c.startsWith("data:")}return!1}function ut(){const r=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const c of r){const k=document.querySelector(c)?.getAttribute("content")||"",C=J(k);if(C)return C}return""}function ft(r){let c=r,s=0;for(;c&&s<8;){const k=c.getAttribute?.("data-store");if(k){const C=pt(k),O=Se(C,0);if(O)return O}c=c.parentElement,s+=1}return""}function pt(r){if(!r)return null;const c=mt(r);try{return JSON.parse(c)}catch{return null}}function mt(r){return!r||typeof r!="string"?"":r.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Se(r,c){if(!r||c>4)return"";if(typeof r=="string")return r.startsWith("http")?r:"";if(Array.isArray(r)){for(const s of r){const k=Se(s,c+1);if(k)return k}return""}if(typeof r=="object")for(const s of Object.keys(r)){const k=r[s],C=Se(k,c+1);if(C)return C}return""}(()=>{const s="atlas-downloader-root",k="atlas-open",C=(()=>{try{return window.top===window.self}catch{return!1}})(),O=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let te=null;const ae=3e4,j=new Map,$e="http://www.w3.org/2000/svg",ve=t=>{const n=document.createElementNS($e,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const y of t){const f=document.createElementNS($e,"path");f.setAttribute("d",y),f.setAttribute("fill","none"),f.setAttribute("stroke","currentColor"),f.setAttribute("stroke-width","2"),f.setAttribute("stroke-linecap","round"),f.setAttribute("stroke-linejoin","round"),n.appendChild(f)}return n},Ee=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],K={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},He="atlas-downloader-page-markers";function Y(t,n){const y=typeof t=="string"?t:"";return y.length<=n?y:y.slice(0,n)}function he(t){return ot(t)||"Extension"}function ye(t){const n=j.get(t);return n?Date.now()-n.ts>ae?(j.delete(t),null):n:null}function _e(t,n,y,f){const p=X((n||"").trim());if(!p){f(null);return}const A=ye(p);if(A){f(A);return}t({type:"atlas-check-batch",urls:[p]},M=>{if(!M||!M.ok){f(null);return}const w=Array.isArray(M.data?.results)?M.data.results:[],o=new Map(w.filter(E=>typeof E?.url=="string"&&E.url.trim()!=="").map(E=>[X(String(E.url)),E])).get(p)??null;if(!o){f(null);return}const b={exists:!!o.exists,downloaded:!!o.downloaded,blacklisted:!!o.blacklisted,reactionType:o.reaction?.type?String(o.reaction.type):null,ts:Date.now()};j.set(p,b),f(b)})}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&C)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],y=>{const f=xe(y.atlasBaseUrl||"");if(f&&Me(window.location.hostname,f))return;const p=je(y.atlasExcludedDomains||"");Qe(window.location.hostname,p)||(We(),te?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const n=xe(t.atlasBaseUrl||"");if(n&&Me(window.location.hostname,n))return;const y=je(t.atlasExcludedDomains||"");Qe(window.location.hostname,y)||(C?We():ht())});function ht(){if(document.getElementById(s))return;const t=document.createElement("div");t.id=s;const n=t.attachShadow({mode:"closed"}),y=document.createElement("link");y.rel="stylesheet",y.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(y);const f=document.createElement("div");f.className="atlas-shadow-root";const p=Ie(f),A=Oe(f),M=(w,$)=>{try{chrome.runtime.sendMessage(w,$)}catch(o){(()=>{if(o instanceof Error)return o.message;if(o&&typeof o=="object"&&"message"in o){const E=o.message;return typeof E=="string"?E:String(E)}return String(o)})().includes("Extension context invalidated")?p("Atlas extension was reloaded. Refresh this tab.","danger"):p("Atlas extension error. Refresh this tab.","danger"),$(null)}};n.appendChild(f),(document.body||document.documentElement).appendChild(t),qe({showToast:p,sendMessageSafe:M,isSheetOpen:()=>!1,chooseDialog:A}),Ke({root:f,showToast:p,sendMessageSafe:M,isSheetOpen:()=>!1,chooseDialog:A})}function We(){if(document.getElementById(s))return;const t=document.createElement("div");t.id=s;const n=t.attachShadow({mode:"closed"}),y=document.createElement("link");y.rel="stylesheet",y.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(y);const f=document.createElement("div");f.className="atlas-shadow-root";const p=Ie(f),A=(e,l)=>{try{chrome.runtime.sendMessage(e,l)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const m=a.message;return typeof m=="string"?m:String(m)}return String(a)})().includes("Extension context invalidated")?p("Atlas extension was reloaded. Refresh this tab.","danger"):p("Atlas extension error. Refresh this tab.","danger"),l(null)}},M=document.createElement("button");M.className="atlas-downloader-toggle",M.type="button",M.setAttribute("aria-label","Atlas Downloader"),M.title="Atlas Downloader";const w=document.createElement("img");w.alt="",w.src=chrome.runtime.getURL("icon.svg"),M.appendChild(w);const $=document.createElement("div");$.className="atlas-downloader-overlay";const o=document.createElement("div");o.className="atlas-downloader-modal",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.setAttribute("aria-label","Atlas Media Picker");const b=document.createElement("div");b.className="atlas-downloader-header";const E=document.createElement("div");E.className="atlas-downloader-title",E.textContent="Atlas Media Picker";const N=document.createElement("div");N.className="atlas-downloader-version",N.textContent=O?`v${O}`:"";const U=document.createElement("button");U.type="button",U.className="atlas-downloader-close",U.setAttribute("aria-label","Close"),U.textContent="x",b.appendChild(E),b.appendChild(N),b.appendChild(U);const S=document.createElement("div");S.className="atlas-downloader-toolbar";const _=ee("Rescan",()=>ge()),Q=ee("Check Atlas",()=>Ge(!1)),H=ee("Select all",()=>we(!0)),I=ee("Select none",()=>we(!1)),G=document.createElement("span");G.className="spacer";const z=ee("Queue selected",()=>Lt(),{primary:!0});S.appendChild(_),S.appendChild(Q),S.appendChild(H),S.appendChild(I),S.appendChild(G),S.appendChild(z);const oe=document.createElement("div");oe.className="atlas-downloader-meta";const ie=document.createElement("div");ie.className="atlas-downloader-list",o.appendChild(b),o.appendChild(S),o.appendChild(oe),o.appendChild(ie),f.appendChild(M),f.appendChild($),f.appendChild(o),n.appendChild(f),(document.body||document.documentElement).appendChild(t);const ue=Oe(f);let x=[],be=0,fe=null,pe=null,Ae=null;const i=!0;let v=!1;M.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),q()}),$.addEventListener("click",()=>B()),U.addEventListener("click",()=>B()),document.addEventListener("keydown",e=>{const l=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&l==="a"){e.preventDefault(),q();return}if(e.key==="Escape"&&f.classList.contains(k)){B();return}if(!f.classList.contains(k))return;const a=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!a)return;const d=x.find(m=>m.selected)??x[0]??null;d&&(e.preventDefault(),Ne(d,a,{closeOnSuccess:!0}))});function D(){f.classList.add(k),ge()}function q(){if(f.classList.contains(k)){B();return}D()}function B(){f.classList.remove(k)}te=q,qe({showToast:p,sendMessageSafe:A,isSheetOpen:()=>f.classList.contains(k),chooseDialog:ue,setHintShown:e=>{v=e},getHintShown:()=>v,enabled:i}),Ke({root:f,showToast:p,sendMessageSafe:A,isSheetOpen:()=>f.classList.contains(k),chooseDialog:ue}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const l=e,a=!!l.detail?.pending,d=l.detail?.reactionType?String(l.detail.reactionType):null,h=(typeof l.detail?.url=="string"?l.detail.url:"")||l.detail?.media&&ke(l.detail.media,400)?.url||"",g=h?X(h):"";if(a){fe=g||"__external-reaction__";for(const u of x)g&&X(String(u.url||""))!==g||(u.reactionPending=d||u.reactionPending||"like");V(),P(F());return}fe=null;for(const u of x){if(g&&X(String(u.url||""))!==g)continue;u.reactionPending&&(u.reactionPending=null);const L=(g?ye(g):null)??ye(me(u))??ye(X(String(u.url||"")));L?u.atlas={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,file_id:u.atlas?.file_id??null,reaction:L.reactionType?{type:L.reactionType}:u.atlas?.reaction??null}:d&&(u.atlas={exists:u.atlas?.exists??!0,downloaded:u.atlas?.downloaded??!1,blacklisted:u.atlas?.blacklisted??!1,file_id:u.atlas?.file_id??null,reaction:{type:d}}),u.atlas?.exists&&!u.atlas?.downloaded&&u.atlas?.reaction?.type&&u.atlas.reaction.type!=="dislike"?u.reactionQueued=u.atlas.reaction.type:u.reactionQueued=null}V(),P(F()),de(x)},!0);const W=(e=300)=>{Ae!==null&&window.clearTimeout(Ae),Ae=window.setTimeout(()=>{Ae=null,Ct()},e)};new MutationObserver(()=>{de(x),W(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>W(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&W(120)},!0),W(120);function ee(e,l,a){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${a?.primary?" primary":""}`,d.textContent=e,d.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),l()}),d}function re(e){oe.textContent=e,z.disabled=!0,_.disabled=!0,Q.disabled=!0,H.disabled=!0,I.disabled=!0}function P(e){oe.textContent=e;const l=x.filter(d=>d.selected).length,a=x.some(d=>!!d.reactionPending)||fe==="__external-reaction__";z.disabled=l===0||a,_.disabled=a,Q.disabled=x.length===0||a,H.disabled=x.length===0||a,I.disabled=x.length===0||a}function ge(){be+=1;const e=be;x=[],pe=null,ie.replaceChildren(),re("Scanning this page…"),gt(l=>{be===e&&(oe.textContent=`Scanning… ${l.scanned}/${l.total}`)}).then(l=>{be===e&&(x=l.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),V(),P(F()),Ge(!0))})}function we(e){for(const l of x)l.selected=e;V(),P(F())}function V(){if(ie.replaceChildren(),x.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",ie.appendChild(e);return}for(const e of x)ie.appendChild(yt(e))}function yt(e){const l=document.createElement("div");l.className=`atlas-downloader-item${e.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=e.selected,a.addEventListener("change",()=>{e.selected=a.checked,l.classList.toggle("selected",e.selected),P(F())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",e.preview_url){const R=document.createElement("img");R.loading="lazy",R.alt="",R.src=e.preview_url,d.appendChild(R)}const m=document.createElement("div");m.className="atlas-downloader-info";const h=document.createElement("div");h.className="atlas-downloader-kind",h.textContent=e.tag_name;const g=document.createElement("div");g.className="atlas-downloader-url",g.textContent=e.url,g.title=e.url;const u=document.createElement("div");u.className="atlas-downloader-sub",u.textContent=At(e);const L=document.createElement("div");L.className="atlas-downloader-reactions";const T=e.atlas?.reaction?.type||null,Z=!!e.reactionPending||!!e.reactionQueued;for(const R of Ee){const ne=document.createElement("button");ne.type="button",ne.className=`atlas-downloader-reaction-btn ${R.className}${T===R.type?" active":""}${e.reactionPending===R.type?" pending":""}${e.reactionQueued===R.type?" queued":""}`.trim(),ne.setAttribute("aria-label",R.label),ne.title=R.label,ne.replaceChildren(ve(R.pathDs)),ne.disabled=Z,ne.addEventListener("click",tt=>{tt.preventDefault(),tt.stopPropagation(),Ne(e,R.type)}),L.appendChild(ne)}const se=document.createElement("button");if(se.type="button",se.className=`atlas-downloader-reaction-btn ${K.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===K.type?" pending":""}${e.reactionQueued===K.type?" queued":""}`.trim(),se.setAttribute("aria-label",K.label),se.title=K.label,se.replaceChildren(ve(K.pathDs)),se.disabled=Z,se.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),Ne(e,"dislike",{blacklist:!0})}),L.appendChild(se),e.atlas?.downloaded){const R=document.createElement("button");R.type="button",R.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),R.setAttribute("aria-label","Delete download"),R.title="Delete download",R.replaceChildren(ve(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),R.disabled=Z,R.addEventListener("click",ne=>{ne.preventDefault(),ne.stopPropagation(),_t(e)}),L.appendChild(R)}const ce=document.createElement("button");ce.type="button",ce.className=`atlas-downloader-debug-toggle${pe===e.url?" active":""}`,ce.textContent=pe===e.url?"Hide debug":"Debug",ce.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),pe=pe===e.url?null:e.url,V(),P(F())}),L.appendChild(ce),m.appendChild(h),m.appendChild(g),m.appendChild(u),m.appendChild(L),pe===e.url&&m.appendChild(bt(e));const De=document.createElement("div"),et=Et(e);return De.className=`atlas-downloader-status ${et.className}`.trim(),De.textContent=et.text,l.addEventListener("click",R=>{R.target instanceof HTMLInputElement||(e.selected=!e.selected,a.checked=e.selected,l.classList.toggle("selected",e.selected),P(F()))}),l.appendChild(a),l.appendChild(d),l.appendChild(m),l.appendChild(De),l}function Xe(e,l){return{type:l,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:Y(e.alt||"",500),preview_url:e.preview_url||"",source:he(e.url),...e.download_via?{download_via:e.download_via}:{}}}function ze(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:Y(e.alt||"",500),preview_url:e.preview_url||"",source:he(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function bt(e){const l=document.createElement("details");l.className="atlas-downloader-debug",l.open=!0;const a=document.createElement("summary");a.textContent="Debug payload",l.appendChild(a);const d={react:Xe(e,e.atlas?.reaction?.type||"like"),download:ze(e)};return l.appendChild(kt(d)),l}function kt(e,l=0){const a=document.createElement("div");a.className="atlas-downloader-json-tree";const d=Le(e);if(!Je(d)){const h=document.createElement("div");return h.className="atlas-downloader-json-line",h.textContent=Ye(d),a.appendChild(h),a}const m=Array.isArray(d)?d.map((h,g)=>[String(g),h]):Object.entries(d);for(const[h,g]of m)a.appendChild(Ze(h,g,l));return a}function Ze(e,l,a){const d=Le(l),m=document.createElement("div");if(m.className="atlas-downloader-json-line",m.style.paddingLeft=`${a*12}px`,!Je(d))return m.innerHTML=`<span class="atlas-downloader-json-key">${Te(e)}</span>: <span class="atlas-downloader-json-value">${Te(Ye(d))}</span>`,m;const h=document.createElement("details");h.className="atlas-downloader-json-node",h.open=a===0;const g=document.createElement("summary");g.style.paddingLeft=`${a*12}px`;const u=Array.isArray(d)?`[${d.length}]`:`{${Object.keys(d).length}}`;g.innerHTML=`<span class="atlas-downloader-json-key">${Te(e)}</span>: <span class="atlas-downloader-json-preview">${Te(u)}</span>`,h.appendChild(g);const L=Array.isArray(d)?d.map((T,Z)=>[String(Z),T]):Object.entries(d);for(const[T,Z]of L)h.appendChild(Ze(T,Z,a+1));return h}function Le(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(a=>Le(a));if(!e||typeof e!="object")return null;const l={};for(const[a,d]of Object.entries(e))l[a]=Le(d);return l}function Je(e){return Array.isArray(e)||e&&typeof e=="object"}function Ye(e){return JSON.stringify(e)}function Te(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function At(e){const l=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",a=vt(e.url);return a?`${l} • ${a}`:l}function vt(e){try{return new URL(e).hostname}catch{return""}}function F(){const e=x.filter(l=>l.selected).length;return`${x.length} found • ${e} selected`}function me(e){const l=(e?.url||e?.referrer_url||"").trim();return l?X(l):""}function Et(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Ge(e){const l=[...new Set(x.map(a=>me(a)).filter(Boolean))];l.length!==0&&A({type:"atlas-check-batch",urls:l},a=>{if(!a){e||p("Atlas extension did not respond.","danger");return}if(!a.ok){e||p(a.error||"Atlas check failed.","danger");return}const d=Array.isArray(a.data?.results)?a.data.results:[],m=new Map(d.filter(u=>typeof u?.url=="string"&&u.url.trim()!=="").map(u=>[X(String(u.url)),u]));let h=0,g=0;for(const u of x){const L=me(u),T=m.get(L);T&&(u.atlas={exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,file_id:T.file_id??null,reaction:T.reaction??null},u.atlas.exists&&!u.atlas.downloaded&&u.atlas.reaction?.type&&u.atlas.reaction.type!=="dislike"?u.reactionQueued=u.atlas.reaction.type:u.reactionQueued=null,j.set(L,{exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,reactionType:T.reaction?.type?String(T.reaction.type):null,ts:Date.now()}),T.exists&&(h+=1),T.downloaded&&(g+=1))}V(),P(F()),de(x),e||p(`Atlas check: ${g}/${h} downloaded.`)})}function Ne(e,l,a={}){const d=(h={})=>{e.reactionPending=a.blacklist?K.type:l,e.status="Reacting…",e.statusClass="",fe=me(e)||e.url,V(),P(F());const g={...Xe(e,l),...h,...a.blacklist?{blacklist:!0}:{}};A({type:"atlas-react",payload:g},u=>{if(e.reactionPending=null,fe=null,!u){e.status="No response",e.statusClass="err",V(),P(F()),p("Atlas extension did not respond.","danger");return}if(!u.ok){e.status=u.error||"Failed",e.statusClass="err",V(),P(F()),p(u.error||"Reaction failed.","danger");return}const L=u.data||null,T=L?.file||null;e.atlas={exists:!!T,downloaded:!!T?.downloaded,blacklisted:!!T?.blacklisted_at,file_id:T?.id??null,reaction:L?.reaction??null};const Z=me(e)||e.url;j.set(Z,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&l!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=a.blacklist?K.type:l):(e.status="",e.statusClass="",e.reactionQueued=null),V(),P(F()),de(x),a.closeOnSuccess&&B(),e.atlas.exists&&!e.atlas.downloaded&&l!=="dislike"&&Ce([Z],0)})},m=!!e.atlas?.reaction?.type;if(l!=="dislike"&&e.atlas?.downloaded&&m){ue({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(h=>{d(h==="confirm"?{force_download:!0}:{})});return}if(l==="dislike"&&e.atlas?.downloaded){ue({title:a.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(h=>{if(h==="alternate"){p("Cancelled.");return}d(h==="confirm"?{clear_download:!0}:{})});return}d()}function _t(e){ue({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(l=>{l==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",fe=me(e)||e.url,V(),P(F()),A({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},a=>{if(e.reactionPending=null,fe=null,!a||!a.ok){e.status=a?.error||"Failed",e.statusClass="err",V(),P(F()),p(a?.error||"Delete failed.","danger");return}const d=a.data?.file||null;e.atlas={exists:!!d,downloaded:!!d?.downloaded,blacklisted:!!d?.blacklisted_at,file_id:d?.id??null,reaction:null},e.reactionQueued=null;const m=me(e)||e.url;j.set(m,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",V(),P(F()),de(x),p("Download deleted.")}))})}function Lt(){const e=x.filter(d=>d.selected);if(e.length===0){p("Select one or more items first.");return}if(e.some(d=>!!d.atlas?.downloaded)){ue({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(d=>{if(d==="alternate"){p("Cancelled.");return}a(d==="confirm")});return}a(!1);function a(d){z.disabled=!0,_.disabled=!0,Q.disabled=!0,H.disabled=!0,I.disabled=!0;for(const h of e)h.status="Sending…",h.statusClass="";V();const m=e.map(h=>{const g=ze(h);return d&&(g.force_download=!0),g});A({type:"atlas-download-batch",payloads:m},h=>{if(!h){for(const L of e)L.status="No response",L.statusClass="err";V(),P(F()),p("Atlas extension did not respond.","danger");return}const g=Array.isArray(h.results)?h.results:[],u=[];for(let L=0;L<e.length;L+=1){const T=e[L],Z=g[L];if(Z?.ok){const se=Z.data||null,ce=se?.file||null;T.atlas={exists:!!ce,downloaded:!!ce?.downloaded,blacklisted:!!ce?.blacklisted_at,file_id:ce?.id??null,reaction:T.atlas?.reaction??null},se?.queued?(T.status="Queued",T.statusClass="queued",T.atlas?.reaction?.type&&T.atlas.reaction.type!=="dislike"&&(T.reactionQueued=T.atlas.reaction.type),u.push(me(T)||T.url)):(T.status="",T.statusClass="",T.reactionQueued=null)}else T.status=Z?.error||"Failed",T.statusClass="err"}V(),P(F()),de(x),h.ok?p(`Queued ${e.length} download(s) in Atlas.`):p(h.error||"Some requests failed.","danger"),u.length>0&&Ce(u,0)})}}function Ce(e,l){l>15||setTimeout(()=>{A({type:"atlas-check-batch",urls:e},a=>{if(!a||!a.ok){Ce(e,l+1);return}const d=Array.isArray(a.data?.results)?a.data.results:[],m=new Map(d.filter(g=>typeof g?.url=="string"&&g.url.trim()!=="").map(g=>[X(String(g.url)),g]));let h=0;for(const g of x){const u=me(g)||g.url,L=m.get(X(u));L&&(g.atlas={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,file_id:L.file_id??null,reaction:L.reaction??null},u&&j.set(X(u),{exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,reactionType:L.reaction?.type?String(L.reaction.type):null,ts:Date.now()}),g.atlas.exists&&!g.atlas.downloaded&&g.atlas.reaction?.type&&g.atlas.reaction.type!=="dislike"?g.reactionQueued=g.atlas.reaction.type:g.reactionQueued=null,L.downloaded?g.status==="Queued"&&(g.status="",g.statusClass=""):h+=1)}V(),P(F()),de(x),h>0&&Ce(e,l+1)})},2e3)}function de(e=x){wt();const l=document.querySelectorAll('[data-atlas-marked="1"]');for(const m of l)m.removeAttribute("data-atlas-marked"),m.removeAttribute("data-atlas-state"),m.removeAttribute("data-atlas-reaction");const a=new Map;for(const[m,h]of j.entries()){if(Date.now()-h.ts>ae){j.delete(m);continue}a.set(m,{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null}),a.set(X(m),{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null})}for(const m of e){if(!m?.url||!m?.atlas)continue;const h=m.atlas?.reaction?.type?String(m.atlas.reaction.type):null,g={exists:!!m.atlas.exists,downloaded:!!m.atlas.downloaded,blacklisted:!!m.atlas.blacklisted,reactionType:h};a.set(m.url,g),a.set(X(m.url),g)}if(a.size===0)return;const d=document.querySelectorAll("img, video, a[href]");for(const m of d){const h=Pe(m);if(h.length===0)continue;const g=h.map(u=>a.get(u)||a.get(X(u))).find(u=>!!(u&&(u.exists||u.downloaded||u.blacklisted||u.reactionType)))??null;g&&(m.setAttribute("data-atlas-marked","1"),g.blacklisted?m.setAttribute("data-atlas-state","blacklisted"):g.reactionType?m.setAttribute("data-atlas-state","reacted"):g.downloaded?m.setAttribute("data-atlas-state","downloaded"):g.exists&&m.setAttribute("data-atlas-state","exists"),g.reactionType&&m.setAttribute("data-atlas-reaction",g.reactionType))}}function Tt(){const e=new Set,l=document.querySelectorAll("img, video, a[href]");for(const d of l)for(const m of Pe(d))e.add(m),e.add(X(m));const a=Re();return a?.url&&(e.add(a.url),e.add(X(a.url))),[...e].filter(Boolean)}function Ct(){const e=Tt();if(e.length===0){de(x);return}A({type:"atlas-check-batch",urls:e},l=>{if(!l?.ok){de(x);return}const a=Array.isArray(l.data?.results)?l.data.results:[];for(const d of a)d?.url&&j.set(String(d.url),{exists:!!d.exists,downloaded:!!d.downloaded,blacklisted:!!d.blacklisted,reactionType:d.reaction?.type?String(d.reaction.type):null,ts:Date.now()});de(x)})}}function gt(t){return new Promise(n=>{const y=document.body||document.documentElement,f=Array.from(y.querySelectorAll("img, video")),p=f.length,A=new Set,M=[];let w=0;const $=b=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(b,{timeout:500});return}setTimeout(()=>b({timeRemaining:()=>25}),0)},o=b=>{const E=typeof b?.timeRemaining=="function"?b.timeRemaining():25;let N=0;for(;w<p&&(N<80||E>5);){const S=f[w];if(S.closest&&S.closest(`#${s}`)){w+=1,N+=1;continue}const _=ke(S,400);_?.url&&!A.has(_.url)&&(A.add(_.url),M.push(_)),w+=1,N+=1}if(t?.({scanned:w,total:p}),w<p){$(o);return}const U=Re();U&&!A.has(U.url)&&(A.add(U.url),M.push(U)),n(M)};$(o)})}function Ie(t){return function(y,f="info"){const p=document.createElement("div");p.className=`atlas-downloader-toast${f==="danger"?" danger":""}`,p.textContent=y,t.appendChild(p),requestAnimationFrame(()=>p.classList.add("show")),setTimeout(()=>{p.classList.remove("show"),p.addEventListener("transitionend",()=>p.remove(),{once:!0})},2600)}}function Oe(t){return n=>new Promise(y=>{const f=document.createElement("div");f.className="atlas-downloader-dialog-backdrop";const p=document.createElement("div");p.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),p.setAttribute("role","dialog"),p.setAttribute("aria-modal","true"),p.setAttribute("aria-label",n.title);const A=document.createElement("h3");A.className="atlas-downloader-dialog-title",A.textContent=n.title;const M=document.createElement("p");M.className="atlas-downloader-dialog-message",M.textContent=n.message;const w=document.createElement("div");w.className="atlas-downloader-dialog-actions";const $=E=>{f.remove(),y(E)};if(n.alternateLabel){const E=document.createElement("button");E.type="button",E.className="atlas-downloader-dialog-btn secondary",E.textContent=n.alternateLabel,E.addEventListener("click",()=>$("alternate")),w.appendChild(E)}const o=document.createElement("button");o.type="button",o.className="atlas-downloader-dialog-btn",o.textContent=n.cancelLabel||"Cancel",o.addEventListener("click",()=>$("cancel")),w.appendChild(o);const b=document.createElement("button");b.type="button",b.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),b.textContent=n.confirmLabel,b.addEventListener("click",()=>$("confirm")),w.appendChild(b),p.appendChild(A),p.appendChild(M),p.appendChild(w),f.appendChild(p),t.appendChild(f),requestAnimationFrame(()=>{b.focus()})})}function wt(){if(document.getElementById(He))return;const t=document.createElement("style");t.id=He,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function X(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function je(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>xe(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Qe(t,n){const y=(t||"").toLowerCase();if(!y)return!1;for(const f of n)if(Me(y,f))return!0;return!1}function xe(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const y=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(y).hostname}catch{return""}}function Me(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}function qe(t){const n=t.enabled??!0,y=t.getHintShown??(()=>!1),f=t.setHintShown??(()=>{}),p=()=>{y()||(f(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},A=(w,$,o,b=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:w,pending:$,reactionType:o,url:b}}))},M=w=>(typeof w.composedPath=="function"?w.composedPath():[]).some(o=>o instanceof HTMLElement&&o.id===s);document.addEventListener("click",w=>{!n||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||M(w)||!((w.target instanceof Element?w.target:null)?.closest?.("img, video")??null)||(w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation())},!0),document.addEventListener("mousedown",w=>{if(!n||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||M(w))return;const o=(w.target instanceof Element?w.target:null)?.closest?.("img, video")??null;if(!o)return;const b=w.button===0?"like":w.button===1?"love":null;if(!b)return;p(),w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation();const E=ke(o,400);if(!E){if(o instanceof HTMLVideoElement){const U=(o.currentSrc||o.src||"").trim().toLowerCase();if(U.startsWith("blob:")||U.startsWith("data:")){const S=window.location.href,_={type:b,url:S,referrer_url:S,page_title:Y(document.title,500),tag_name:"video",width:o.videoWidth||o.clientWidth||null,height:o.videoHeight||o.clientHeight||null,alt:"",preview_url:o.poster||"",source:he(S),download_via:"yt-dlp"};_e(t.sendMessageSafe,_.url,_.referrer_url||null,Q=>{if(Q?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(H=>{A(o,!0,b,_.url),H==="confirm"&&(_.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:_},I=>{if(!I||!I.ok){A(o,!1,null,_.url),t.showToast(I?.error||"Reaction failed.","danger");return}const G=I.data||null,z=G?.file||null,oe=G?.reaction?.type?String(G.reaction.type):b;j.set(_.url,{exists:!!z,downloaded:!!z?.downloaded,blacklisted:!!z?.blacklisted_at,reactionType:oe,ts:Date.now()}),A(o,!1,oe,_.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}A(o,!0,b,_.url),t.sendMessageSafe({type:"atlas-react",payload:_},H=>{if(!H||!H.ok){A(o,!1,null,_.url),t.showToast(H?.error||"Reaction failed.","danger");return}const I=H.data||null,G=I?.file||null,z=I?.reaction?.type?String(I.reaction.type):b;j.set(_.url,{exists:!!G,downloaded:!!G?.downloaded,blacklisted:!!G?.blacklisted_at,reactionType:z,ts:Date.now()}),A(o,!1,z,_.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const N={type:b,url:E.url,referrer_url:E.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:E.tag_name,width:E.width,height:E.height,alt:Y(E.alt||"",500),preview_url:E.preview_url||"",source:he(E.url)};_e(t.sendMessageSafe,N.url,N.referrer_url||null,U=>{if(U?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(S=>{A(o,!0,b,N.url),S==="confirm"&&(N.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:N},_=>{if(!_||!_.ok){A(o,!1,null,N.url),t.showToast(_?.error||"Reaction failed.","danger");return}const Q=_.data||null,H=Q?.file||null,I=Q?.reaction?.type?String(Q.reaction.type):b;j.set(N.url,{exists:!!H,downloaded:!!H?.downloaded,blacklisted:!!H?.blacklisted_at,reactionType:I,ts:Date.now()}),A(o,!1,I,N.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})});return}A(o,!0,b,N.url),t.sendMessageSafe({type:"atlas-react",payload:N},S=>{if(!S||!S.ok){A(o,!1,null,N.url),t.showToast(S?.error||"Reaction failed.","danger");return}const _=S.data||null,Q=_?.file||null,H=_?.reaction?.type?String(_.reaction.type):b;j.set(N.url,{exists:!!Q,downloaded:!!Q?.downloaded,blacklisted:!!Q?.blacklisted_at,reactionType:H,ts:Date.now()}),A(o,!1,H,N.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",w=>{if(!n||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||M(w))return;const o=(w.target instanceof Element?w.target:null)?.closest?.("img, video")??null;if(!o)return;p(),w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation();const b=ke(o,400);if(!b){if(o instanceof HTMLVideoElement){const N=(o.currentSrc||o.src||"").trim().toLowerCase();if(N.startsWith("blob:")||N.startsWith("data:")){const U=window.location.href,S={type:"dislike",url:U,referrer_url:U,page_title:Y(document.title,500),tag_name:"video",width:o.videoWidth||o.clientWidth||null,height:o.videoHeight||o.clientHeight||null,alt:"",preview_url:o.poster||"",source:he(U),download_via:"yt-dlp"};A(o,!0,"dislike",S.url),t.sendMessageSafe({type:"atlas-react",payload:S},_=>{if(!_||!_.ok){A(o,!1,null,S.url),t.showToast(_?.error||"Reaction failed.","danger");return}A(o,!1,"dislike",S.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const E={type:"dislike",url:b.url,referrer_url:b.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:b.tag_name,width:b.width,height:b.height,alt:Y(b.alt||"",500),preview_url:b.preview_url||"",source:he(b.url)};A(o,!0,"dislike",E.url),t.sendMessageSafe({type:"atlas-react",payload:E},N=>{if(!N||!N.ok){A(o,!1,null,E.url),t.showToast(N?.error||"Reaction failed.","danger");return}A(o,!1,"dislike",E.url),t.showToast("Disliked.")})},!0)}function Fe(t,n,y){return t<n?n:t>y?y:t}function Ve(t,n){const y=ke(t,400);if(y)return{type:n,url:y.url,referrer_url:y.referrer_url||window.location.href,page_title:Y(document.title,500),tag_name:y.tag_name,width:y.width,height:y.height,alt:Y(y.alt||"",500),preview_url:y.preview_url||"",source:he(y.url)};if(t instanceof HTMLVideoElement){const f=(t.currentSrc||t.src||"").trim().toLowerCase();if(f.startsWith("blob:")||f.startsWith("data:")){const p=window.location.href;return{type:n,url:p,referrer_url:p,page_title:Y(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:he(p),download_via:"yt-dlp"}}}return null}function Ke(t){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");let y=null,f=null,p=null,A=!1,M=null,w=null,$=-1,o=-1,b=null;const E=new Map,N=()=>{const i=A||M!==null;for(const[v,D]of E.entries())D.disabled=i,D.classList.toggle("pending",A&&w===v)},U=(i,v=null)=>{A=i,w=i?v:null,N()},S=i=>{for(const v of[...Ee,K]){const D=E.get(v.type);if(!D)continue;const q=v.type===K.type?i==="dislike":i===v.type;D.classList.toggle("active",q)}},_=(i,v)=>{M=i&&v===!1&&i!=="dislike"?i:null;for(const D of[...Ee,K]){const q=E.get(D.type);if(!q)continue;const B=D.type===K.type?M==="dislike":M===D.type;q.classList.toggle("queued",B)}N()},Q=(i,v,D)=>{y&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:y,pending:i,reactionType:v,url:D}}))},H=()=>{p&&(window.clearTimeout(p),p=null)},I=()=>{A||(y=null,f=null,n.classList.remove("open"),n.style.left="",n.style.top="",S(null))},G=()=>{H(),p=window.setTimeout(()=>{n.matches(":hover")||I()},140)},z=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of[...Ee,K]){const v=document.createElement("button");v.type="button",v.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),v.setAttribute("aria-label",i.label),v.title=i.label,v.replaceChildren(ve(i.pathDs)),E.set(i.type,v),v.addEventListener("pointerdown",z,!0),v.addEventListener("mousedown",z,!0),v.addEventListener("click",D=>{if(z(D),A)return;if(!y){t.showToast("No media selected.");return}const q=i.type===K.type?"dislike":i.type,B=Ve(y,q);if(!B){t.showToast("No valid media URL found.");return}const W=B.url||"",le=(ee=!1)=>{ee?B.force_download=!0:"force_download"in B&&delete B.force_download,Q(!0,i.type,W||null),U(!0,i.type),t.sendMessageSafe({type:"atlas-react",payload:{...B,...i.type===K.type?{blacklist:!0}:{}}},re=>{if(U(!1,null),!re||!re.ok){Q(!1,null,W||null),t.showToast(re?.error||"Reaction failed.","danger");return}const P=re.data||null,ge=P?.file||null,we=P?.reaction?.type?String(P.reaction.type):i.type===K.type?"dislike":i.type;if(W&&j.set(W,{exists:!!ge,downloaded:!!ge?.downloaded,blacklisted:!!ge?.blacklisted_at,reactionType:we,ts:Date.now()}),S(we),_(we,!!ge?.downloaded),Q(!1,we,W||null),B.download_via==="yt-dlp"){t.showToast(`Reacted (${i.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${i.label}). Queued download in Atlas.`)})};_e(t.sendMessageSafe,W,B.referrer_url||null,ee=>{if(q!=="dislike"&&ee?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(re=>{le(re==="confirm")});return}le(!1)})}),n.appendChild(v)}t.root.appendChild(n);const oe=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(D=>D instanceof HTMLElement&&D.id===s),ie=()=>{if(!y)return;const i=y.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){I();return}const v=Fe(i.top+8,8,window.innerHeight-8),D=Fe(i.right-8,8,window.innerWidth-8);n.style.top=`${v}px`,n.style.left=`${D}px`},ue=(i,v)=>{const D=W=>{if(W.matches("img, video"))return W;const le=W.closest?.("img, video");if(le instanceof Element)return le;const ee=W.querySelectorAll?.("img, video");if(!ee||ee.length===0)return null;for(const re of ee){const P=re.getBoundingClientRect();if(i>=P.left&&i<=P.right&&v>=P.top&&v<=P.bottom)return re}return null},q=document.elementsFromPoint?.(i,v)??[];for(const W of q){if(!(W instanceof Element)||W.closest?.(`#${s}`))continue;const le=D(W);if(le)return le}const B=document.elementFromPoint?.(i,v);return B instanceof Element&&!B.closest?.(`#${s}`)?D(B):null},x=i=>{if(t.isSheetOpen()){I();return}const v=Ve(i,"like");if(!v){I();return}if(y=i,f=v.url||null,n.classList.add("open"),ie(),S(null),_(null,null),f){const D=ye(f);if(D)S(D.reactionType),_(D.reactionType,D.downloaded);else{const q=f;_e(t.sendMessageSafe,q,window.location.href,B=>{B&&f===q&&(S(B.reactionType),_(B.reactionType,B.downloaded))})}}},be=i=>i?i==="blacklist"?"blacklist":i:null,fe=()=>{if($<0||o<0||t.isSheetOpen())return;const i=ue($,o);i&&(i.closest?.(`#${s}`)||(H(),x(i)))},pe=(i=80)=>{b!==null&&window.clearTimeout(b),b=window.setTimeout(()=>{b=null,fe()},i)};document.addEventListener("pointerover",i=>{if(t.isSheetOpen()||!(i.target instanceof Element)||oe(i))return;const v=ue(i.clientX,i.clientY);v&&(H(),x(v))},!0),window.addEventListener("atlas-shortcut-reaction-state",i=>{const v=i,D=v.detail?.media;if(!(D instanceof Element))return;H(),x(D);const q=!!v.detail?.pending,B=be(v.detail?.reactionType??null);if(q){U(!0,B);return}if(U(!1,null),B){const W=B==="blacklist"?"dislike":B;S(W);const le=f?ye(f):null;_(W,le?.downloaded??null)}},!0),document.addEventListener("pointermove",i=>{$=i.clientX,o=i.clientY},!0),document.addEventListener("pointerout",i=>{!y||t.isSheetOpen()||!(i.target instanceof Element)||oe(i)||!(i.target.closest?.("img, video")??null)||G()},!0),n.addEventListener("pointerenter",H,!0),n.addEventListener("pointerleave",G,!0),window.addEventListener("scroll",ie,!0),window.addEventListener("resize",ie),window.addEventListener("blur",I),window.addEventListener("focus",()=>pe(40),!0),new MutationObserver(()=>{pe(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
