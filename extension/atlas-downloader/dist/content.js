(function(){"use strict";const yt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function kt(e){const t=(e||"").trim().toLowerCase();if(!t)return"";const a=t.split(".").filter(Boolean);if(a.length<=2)return t;const r=a.slice(-2).join("."),o=a.slice(-3).join(".");return yt.has(r)&&a.length>=3?o:r}function vt(e){const t=(e||"").trim();if(!t)return"";try{const a=new URL(t).hostname;return kt(a)}catch{return""}}function Et(e,t){if(!e||typeof e!="string")return"";const a=e.trim();if(!a)return"";const r=a.toLowerCase();if(r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:"))return"";try{const o=new URL(a,t);return o.protocol!=="http:"&&o.protocol!=="https:"?"":o.toString()}catch{return""}}function Pe(e){let t=e,a=0;for(;t&&a<24;){const r=t.getAttribute?.("role");if(r==="dialog"||r==="alertdialog"||t.getAttribute?.("aria-modal")==="true")return!0;const h=(t.getAttribute?.("class")||"").toLowerCase(),d=(t.getAttribute?.("id")||"").toLowerCase(),b=`${h} ${d}`.trim();if(b&&/(modal|lightbox|overlay|dialog)/.test(b))return!0;const M=window.getComputedStyle(t);if((M.position==="fixed"||M.position==="sticky")&&At(t))return!0;t=t.parentElement,a+=1}return!1}function At(e){const t=e.getBoundingClientRect();if(t.width>0&&t.height>0){const a=Math.max(window.innerWidth*.4,320),r=Math.max(window.innerHeight*.4,240);return t.width>=a&&t.height>=r}if(e instanceof HTMLElement){const a=e.style,r=a.inset==="0"||a.inset==="0px"||(a.top==="0"||a.top==="0px")&&(a.left==="0"||a.left==="0px")&&(a.right==="0"||a.right==="0px")&&(a.bottom==="0"||a.bottom==="0px"),o=/^(100vw|100%)$/i.test(a.width||"")||/^(100vh|100%)$/i.test(a.height||"");return r||o}return!1}const Lt=ze(["host:st.deviantart.net","url:*wixmp.com*/crop/w_92,h_92*","url:*wixmp.com*/crop/w_150,h_150*","url:*wixmp.com*/fit/w_150,h_150*"].join(`
`));let Ue=[];function ae(e){return Et(e,window.location.href)}function He(e){Ue=ze(e)}function $e(e){const t=ae(e.currentSrc)||ae(e.src)||ae(e.getAttribute("src")||"");if(t)return t;const a=e.querySelector("source[src]"),r=a?ae(a.src||a.getAttribute("src")||""):"";if(r)return r;const o=Ct(e);return o||_t()}function ke(e,t){if(!(e instanceof Element))return null;if(e.tagName==="IMG"){const a=e,r=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),o=ae(r);if(o&&Ne(o))return null;const{width:h,height:d}=Mt(a,o||r),b=h??me(a.clientWidth),M=d??me(a.clientHeight);if(b&&b<t||M&&M<t)return null;if(!o){const u=ae(document.referrer)||ae(window.location.href)||"";return!u||!r.toLowerCase().startsWith("blob:")&&!r.toLowerCase().startsWith("data:")||Ne(u)?null:{tag_name:"img",url:u,referrer_url:window.location.href,preview_url:"",width:h,height:d,alt:a.alt||""}}return{tag_name:"img",url:o,referrer_url:window.location.href,preview_url:o,width:h,height:d,alt:a.alt||""}}if(e.tagName==="VIDEO"){const a=e,r=a.videoWidth||a.clientWidth||null,o=a.videoHeight||a.clientHeight||null;if(r&&o&&(r<t||o<t))return null;const h=$e(a);if(h&&Ne(h))return null;if(!h){const d=(a.currentSrc||a.src||"").trim().toLowerCase();if(d.startsWith("blob:")||d.startsWith("data:")){const b=window.location.href;return{tag_name:"video",url:b,referrer_url:b,preview_url:a.poster||"",width:r,height:o,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:h,referrer_url:window.location.href,preview_url:a.poster||"",width:r,height:o,alt:""}}return null}function We(){const e=(window.location.href||"").trim();if(!e)return null;const t=e.toLowerCase(),a=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(t),r=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!a&&!r)return null;if(t.startsWith("http://")||t.startsWith("https://"))return{tag_name:t.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:e,referrer_url:e,preview_url:e,width:null,height:null,alt:""};if(t.startsWith("blob:")||t.startsWith("data:")){const o=ae(document.referrer)||"";return o?{tag_name:"img",url:o,referrer_url:e,preview_url:"",width:null,height:null,alt:""}:null}return null}function Oe(e){const t=new Set,a=ae(window.location.href),r=e instanceof HTMLImageElement?ae(e.currentSrc)||ae(e.src)||"":e instanceof HTMLVideoElement?$e(e)||"":e instanceof HTMLAnchorElement&&Fe(e.getAttribute("href")||"")||"";r&&t.add(r);const o=e.closest("a[href]")?.getAttribute("href")??"",h=Fe(o);return h&&t.add(h),a&&St(e)&&t.add(a),[...t]}function Fe(e){const t=(e||"").trim();return!t||t.startsWith("#")||t.toLowerCase().startsWith("javascript:")?"":ae(t)}function St(e){if(e instanceof HTMLImageElement){const t=(e.currentSrc||e.src||e.getAttribute("src")||"").trim().toLowerCase();return t.startsWith("blob:")||t.startsWith("data:")}if(e instanceof HTMLVideoElement){const t=(e.currentSrc||e.src||"").trim().toLowerCase();return t.startsWith("blob:")||t.startsWith("data:")}return!1}function _t(){const e=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const t of e){const r=document.querySelector(t)?.getAttribute("content")||"",o=ae(r);if(o)return o}return""}function Ct(e){let t=e,a=0;for(;t&&a<8;){const r=t.getAttribute?.("data-store");if(r){const o=xt(r),h=Me(o,0);if(h)return h}t=t.parentElement,a+=1}return""}function xt(e){if(!e)return null;const t=Tt(e);try{return JSON.parse(t)}catch{return null}}function Tt(e){return!e||typeof e!="string"?"":e.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Me(e,t){if(!e||t>4)return"";if(typeof e=="string")return e.startsWith("http")?e:"";if(Array.isArray(e)){for(const a of e){const r=Me(a,t+1);if(r)return r}return""}if(typeof e=="object")for(const a of Object.keys(e)){const r=e[a],o=Me(r,t+1);if(o)return o}return""}function Mt(e,t){const a=me(e.naturalWidth),r=me(e.naturalHeight),o=me(e.clientWidth),h=me(e.clientHeight),d=Nt(t),b=Qe(e.getAttribute("width")),M=Qe(e.getAttribute("height"));return{width:qe(a,o,d.width,b),height:qe(r,h,d.height,M)}}function Nt(e){const t=(e||"").trim();if(!t)return{width:null,height:null};const a=je(t,[/(?:^|[/,?&_=-])w_(\d{2,5})(?=$|[/,?&_=-])/i]),r=je(t,[/(?:^|[/,?&_=-])h_(\d{2,5})(?=$|[/,?&_=-])/i]);let o=a;const h=r,d=t.match(/-(\d{2,5})w-(\d)x(?=$|[./?&_-])/i);if(d){const b=parseInt(d[1],10),M=parseInt(d[2],10),u=me(b*M);u&&(!o||u>o)&&(o=u)}return{width:o??null,height:h??null}}function je(e,t){for(const a of t){const r=e.match(a);if(!r||!r[1])continue;const o=me(parseInt(r[1],10));if(o)return o}return null}function Qe(e){if(!e)return null;const t=e.trim();if(!t)return null;const a=t.match(/^\d+/)?.[0]??"";return a?me(parseInt(a,10)):null}function qe(e,t,a,r){return e||t||a||r}function me(e){if(typeof e!="number"||!Number.isFinite(e))return null;const t=Math.round(e);return t>0?t:null}function Ne(e){const t=(e||"").trim().toLowerCase();if(!t)return!1;const a=[...Lt,...Ue],r=Dt(t);for(const o of a){if(o.kind==="host"){if(Bt(r,o.host))return!0;continue}if(o.kind==="urlPattern"){if(o.regex.test(t))return!0;continue}if(t.includes(o.needle))return!0}return!1}function Dt(e){try{return new URL(e).hostname.toLowerCase()}catch{return""}}function Bt(e,t){const a=(e||"").trim().toLowerCase(),r=(t||"").trim().toLowerCase();return!a||!r?!1:a===r||a.endsWith(`.${r}`)}function ze(e){return!e||typeof e!="string"?[]:e.split(/[\n,]/g).map(t=>t.trim()).filter(t=>t!==""&&!t.startsWith("#")).map(t=>Rt(t)).filter(t=>t!==null)}function Rt(e){const t=e.trim();if(!t)return null;const a=t.toLowerCase();if(a.startsWith("host:")){const o=Ke(t.slice(5));return o?{kind:"host",host:o}:null}if(a.startsWith("url:"))return Ve(t.slice(4));const r=Ke(t);return r?{kind:"host",host:r}:Ve(t)}function Ve(e){const t=e.trim().toLowerCase();if(!t)return null;if(!t.includes("*"))return{kind:"urlContains",needle:t};const a=It(t);try{return{kind:"urlPattern",regex:new RegExp(a,"i")}}catch{return null}}function It(e){return e.split("*").map(t=>Pt(t)).join(".*")}function Pt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ke(e){const t=(e||"").trim();if(!t)return"";const a=t.startsWith("*.")?t.slice(2):t,r=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(r).hostname.toLowerCase()}catch{return""}}const Xe="http://www.w3.org/2000/svg",Le=e=>{const t=document.createElementNS(Xe,"svg");t.setAttribute("viewBox","0 0 24 24"),t.setAttribute("aria-hidden","true"),t.setAttribute("fill","none"),t.setAttribute("stroke-width","2"),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t.setAttribute("width","18"),t.setAttribute("height","18");for(const a of e){const r=document.createElementNS(Xe,"path");r.setAttribute("d",a),r.setAttribute("fill","none"),r.setAttribute("stroke","currentColor"),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round"),t.appendChild(r)}return t},Se=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],Y={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Ze="atlas-location-change";function _e(e,t){return!!e.closest?.(`#${t}`)}function Ut(e,t,a){const r=e.querySelectorAll?.("img, video");if(!r||r.length===0)return null;let o=null;for(const h of r){const d=h.getBoundingClientRect();if(d.width<=0||d.height<=0||t<d.left||t>d.right||a<d.top||a>d.bottom)continue;const b=d.width*d.height;(!o||b>o.area)&&(o={media:h,area:b})}return o}function Je(e,t,a){const o=(document.elementsFromPoint?.(e,t)??[]).filter(d=>d instanceof Element);if(o.length===0){const d=document.elementFromPoint?.(e,t);d instanceof Element&&o.push(d)}for(const d of o){if(_e(d,a))continue;if(d.matches("img, video"))return d;const b=d.closest?.("img, video");if(b instanceof Element&&!_e(b,a))return b}let h=null;for(const d of o){if(_e(d,a))continue;const b=Ut(d,e,t);b&&(!h||b.area>h.area)&&(h=b)}return h?.media??null}function Ye(e){const t=e.getBoundingClientRect();if(t.width<=0||t.height<=0)return 0;const a=Math.max(t.left,0),r=Math.max(t.top,0),o=Math.min(t.right,window.innerWidth),h=Math.min(t.bottom,window.innerHeight),d=o-a,b=h-r;return d<=0||b<=0?0:d*b}function Ht(e,t){const a=Array.from(document.querySelectorAll("img, video")).filter(b=>!_e(b,t));if(a.length===0)return null;const r=e?Ye(e):0,o=e?Pe(e):!1;let h=null,d=null;for(const b of a){const M=Ye(b);M<=0||((!d||M>d.area)&&(d={media:b,area:M}),Pe(b)&&(!h||M>h.area)&&(h={media:b,area:M}))}return h&&h.media!==e&&(!o||h.area>r*1.1)?h.media:d&&d.media!==e&&d.area>r*1.6?d.media:null}function Ge(e,t){const a=e.enabled??!0,r=e.getHintShown??(()=>!1),o=e.setHintShown??(()=>{}),h=()=>{r()||(o(!0),e.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},d=(u,p,y,D=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:u,pending:p,reactionType:y,url:D}}))},b=u=>(typeof u.composedPath=="function"?u.composedPath():[]).some(y=>y instanceof HTMLElement&&y.id===t.rootId),M=u=>{const y=(u.target instanceof Element?u.target:null)?.closest?.("img, video")??null;return y instanceof Element?y:Je(u.clientX,u.clientY,t.rootId)};document.addEventListener("click",u=>{!a||!(u instanceof MouseEvent)||!u.altKey||e.isSheetOpen()||b(u)||!M(u)||(u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation())},!0),document.addEventListener("mousedown",u=>{if(!a||!(u instanceof MouseEvent)||!u.altKey||e.isSheetOpen()||b(u))return;const p=M(u);if(!p)return;const y=u.button===0?"like":u.button===1?"love":null;if(!y)return;h(),u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation();const D=ke(p,t.minSize);if(!D){if(p instanceof HTMLVideoElement){const re=(p.currentSrc||p.src||"").trim().toLowerCase();if(re.startsWith("blob:")||re.startsWith("data:")){const $=window.location.href,R={type:y,url:$,referrer_url:$,page_title:t.limitString(document.title,t.maxMetadataLen),tag_name:"video",width:p.videoWidth||p.clientWidth||null,height:p.videoHeight||p.clientHeight||null,alt:"",preview_url:p.poster||"",source:t.sourceFromMediaUrl($),download_via:"yt-dlp"};t.fetchAtlasStatus(e.sendMessageSafe,R.url,R.referrer_url||null,_=>{if(_?.downloaded){e.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(S=>{if(S==="alternate"){e.showToast("Cancelled.");return}d(p,!0,y,R.url),S==="confirm"&&(R.force_download=!0),e.sendMessageSafe({type:"atlas-react",payload:R},C=>{if(!C||!C.ok){d(p,!1,null,R.url),e.showToast(C?.error||"Reaction failed.","danger");return}const k=C.data||null,v=k?.file||null,U=k?.reaction?.type?String(k.reaction.type):y;t.atlasStatusCache.set(R.url,{exists:!!v,downloaded:!!v?.downloaded,blacklisted:!!v?.blacklisted_at,reactionType:U,ts:Date.now()}),d(p,!1,U,R.url),e.showToast(`Reacted (${y}). Resolving video in Atlas…`)})});return}d(p,!0,y,R.url),e.sendMessageSafe({type:"atlas-react",payload:R},S=>{if(!S||!S.ok){d(p,!1,null,R.url),e.showToast(S?.error||"Reaction failed.","danger");return}const C=S.data||null,k=C?.file||null,v=C?.reaction?.type?String(C.reaction.type):y;t.atlasStatusCache.set(R.url,{exists:!!k,downloaded:!!k?.downloaded,blacklisted:!!k?.blacklisted_at,reactionType:v,ts:Date.now()}),d(p,!1,v,R.url),e.showToast(`Reacted (${y}). Resolving video in Atlas…`)})});return}e.showToast("No direct video URL found.");return}e.showToast("No valid media URL found.");return}const B={type:y,url:D.url,referrer_url:D.referrer_url||window.location.href,page_title:t.limitString(document.title,t.maxMetadataLen),tag_name:D.tag_name,width:D.width,height:D.height,alt:t.limitString(D.alt||"",t.maxMetadataLen),preview_url:D.preview_url||"",source:t.sourceFromMediaUrl(D.url)};t.fetchAtlasStatus(e.sendMessageSafe,B.url,B.referrer_url||null,re=>{if(re?.downloaded){e.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then($=>{if($==="alternate"){e.showToast("Cancelled.");return}d(p,!0,y,B.url),$==="confirm"&&(B.force_download=!0),e.sendMessageSafe({type:"atlas-react",payload:B},R=>{if(!R||!R.ok){d(p,!1,null,B.url),e.showToast(R?.error||"Reaction failed.","danger");return}const _=R.data||null,S=_?.file||null,C=_?.reaction?.type?String(_.reaction.type):y;t.atlasStatusCache.set(B.url,{exists:!!S,downloaded:!!S?.downloaded,blacklisted:!!S?.blacklisted_at,reactionType:C,ts:Date.now()}),d(p,!1,C,B.url),e.showToast(`Reacted (${y}). Queued download in Atlas.`)})});return}d(p,!0,y,B.url),e.sendMessageSafe({type:"atlas-react",payload:B},$=>{if(!$||!$.ok){d(p,!1,null,B.url),e.showToast($?.error||"Reaction failed.","danger");return}const R=$.data||null,_=R?.file||null,S=R?.reaction?.type?String(R.reaction.type):y;t.atlasStatusCache.set(B.url,{exists:!!_,downloaded:!!_?.downloaded,blacklisted:!!_?.blacklisted_at,reactionType:S,ts:Date.now()}),d(p,!1,S,B.url),e.showToast(`Reacted (${y}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",u=>{if(!a||!(u instanceof MouseEvent)||!u.altKey||e.isSheetOpen()||b(u))return;const p=M(u);if(!p)return;h(),u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation();const y=ke(p,t.minSize);if(!y){if(p instanceof HTMLVideoElement){const B=(p.currentSrc||p.src||"").trim().toLowerCase();if(B.startsWith("blob:")||B.startsWith("data:")){const re=window.location.href,$={type:"dislike",url:re,referrer_url:re,page_title:t.limitString(document.title,t.maxMetadataLen),tag_name:"video",width:p.videoWidth||p.clientWidth||null,height:p.videoHeight||p.clientHeight||null,alt:"",preview_url:p.poster||"",source:t.sourceFromMediaUrl(re),download_via:"yt-dlp"};d(p,!0,"dislike",$.url),e.sendMessageSafe({type:"atlas-react",payload:$},R=>{if(!R||!R.ok){d(p,!1,null,$.url),e.showToast(R?.error||"Reaction failed.","danger");return}d(p,!1,"dislike",$.url),e.showToast("Disliked.")});return}e.showToast("No direct video URL found.");return}e.showToast("No valid media URL found.");return}const D={type:"dislike",url:y.url,referrer_url:y.referrer_url||window.location.href,page_title:t.limitString(document.title,t.maxMetadataLen),tag_name:y.tag_name,width:y.width,height:y.height,alt:t.limitString(y.alt||"",t.maxMetadataLen),preview_url:y.preview_url||"",source:t.sourceFromMediaUrl(y.url)};d(p,!0,"dislike",D.url),e.sendMessageSafe({type:"atlas-react",payload:D},B=>{if(!B||!B.ok){d(p,!1,null,D.url),e.showToast(B?.error||"Reaction failed.","danger");return}d(p,!1,"dislike",D.url),e.showToast("Disliked.")})},!0),document.addEventListener("auxclick",u=>{!a||!(u instanceof MouseEvent)||!u.altKey||u.button!==1||e.isSheetOpen()||b(u)||!M(u)||(u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation())},!0)}function et(e,t,a){return e<t?t:e>a?a:e}function $t(){const e=window;if(e.__atlasLocationObserverInstalled)return;e.__atlasLocationObserverInstalled=!0;const t=()=>{window.dispatchEvent(new Event(Ze))},a=r=>{const o=history[r].bind(history);history[r]=((...h)=>{const d=o(...h);return t(),d})};a("pushState"),a("replaceState"),window.addEventListener("popstate",t,!0),window.addEventListener("hashchange",t,!0)}function tt(e,t,a){const r=ke(e,a.minSize);if(r)return{type:t,url:r.url,referrer_url:r.referrer_url||window.location.href,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:r.tag_name,width:r.width,height:r.height,alt:a.limitString(r.alt||"",a.maxMetadataLen),preview_url:r.preview_url||"",source:a.sourceFromMediaUrl(r.url)};if(e instanceof HTMLVideoElement){const o=(e.currentSrc||e.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const h=window.location.href;return{type:t,url:h,referrer_url:h,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:"video",width:e.videoWidth||e.clientWidth||null,height:e.videoHeight||e.clientHeight||null,alt:"",preview_url:e.poster||"",source:a.sourceFromMediaUrl(h),download_via:"yt-dlp"}}}return null}function nt(e,t){$t();const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");const r=document.createElement("span");r.className="atlas-downloader-media-resolution",r.hidden=!0,a.appendChild(r);let o=null,h=null,d=null,b=!1,M=null,u=null,p=-1,y=-1,D=null,B=null,re=window.location.href;const $=new Map,R=(i,g)=>{const x=typeof i=="number"&&Number.isFinite(i)&&i>0?Math.round(i):null,A=typeof g=="number"&&Number.isFinite(g)&&g>0?Math.round(g):null;return!x||!A?"":`${x}x${A}`},_=(i,g)=>{const x=R(i,g);if(!x){r.textContent="",r.hidden=!0;return}r.textContent=x,r.hidden=!1},S=()=>{const i=b||M!==null;for(const[g,x]of $.entries())x.disabled=i,x.classList.toggle("pending",b&&u===g)},C=(i,g=null)=>{b=i,u=i?g:null,S()},k=i=>{for(const g of[...Se,Y]){const x=$.get(g.type);if(!x)continue;const A=g.type===Y.type?i==="dislike":i===g.type;x.classList.toggle("active",A)}},v=(i,g)=>{M=i&&g===!1&&i!=="dislike"?i:null;for(const x of[...Se,Y]){const A=$.get(x.type);if(!A)continue;const H=x.type===Y.type?M==="dislike":M===x.type;A.classList.toggle("queued",H)}S()},U=(i,g,x)=>{o&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:o,pending:i,reactionType:g,url:x}}))},W=()=>{b&&(U(!1,null,h||null),C(!1,null))},j=()=>{const i=window.location.href;i!==re&&(re=i,W(),T(!0))},Z=()=>{d&&(window.clearTimeout(d),d=null)},T=i=>{b&&!(i===!0)||(o=null,h=null,a.classList.remove("open"),a.style.left="",a.style.top="",_(null,null),k(null))},z=()=>{Z(),d=window.setTimeout(()=>{a.matches(":hover")||T()},140)},Q=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of[...Se,Y]){const g=document.createElement("button");g.type="button",g.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),g.setAttribute("aria-label",i.label),g.title=i.label,g.replaceChildren(Le(i.pathDs)),$.set(i.type,g),g.addEventListener("pointerdown",Q,!0),g.addEventListener("mousedown",Q,!0),g.addEventListener("click",x=>{if(Q(x),b)return;if(!o){e.showToast("No media selected.");return}const A=i.type===Y.type?"dislike":i.type,H=tt(o,A,t);if(!H){e.showToast("No valid media URL found.");return}const O=H.url||"",V=(ue=!1)=>{ue?H.force_download=!0:"force_download"in H&&delete H.force_download,U(!0,i.type,O||null),C(!0,i.type),e.sendMessageSafe({type:"atlas-react",payload:{...H,...i.type===Y.type?{blacklist:!0}:{}}},se=>{if(C(!1,null),!se||!se.ok){U(!1,null,O||null),e.showToast(se?.error||"Reaction failed.","danger");return}const oe=se.data||null,pe=oe?.file||null,ye=oe?.reaction?.type?String(oe.reaction.type):i.type===Y.type?"dislike":i.type;if(O&&t.atlasStatusCache.set(O,{exists:!!pe,downloaded:!!pe?.downloaded,blacklisted:!!pe?.blacklisted_at,reactionType:ye,ts:Date.now()}),k(ye),v(ye,!!pe?.downloaded),U(!1,ye,O||null),H.download_via==="yt-dlp"){e.showToast(`Reacted (${i.label}). Resolving video in Atlas…`);return}e.showToast(`Reacted (${i.label}). Queued download in Atlas.`)})};t.fetchAtlasStatus(e.sendMessageSafe,O,H.referrer_url||null,ue=>{if(A!=="dislike"&&ue?.downloaded){e.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(se=>{if(se==="alternate"){e.showToast("Cancelled.");return}V(se==="confirm")});return}V(!1)})}),a.appendChild(g)}e.root.appendChild(a);const ce=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(x=>x instanceof HTMLElement&&x.id===t.rootId),ee=()=>{if(!o)return;const i=o.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){W(),T(!0);return}const g=et(i.top+8,8,window.innerHeight-8),x=et(i.right-8,8,window.innerWidth-8);a.style.top=`${g}px`,a.style.left=`${x}px`},te=(i,g)=>Je(i,g,t.rootId),ne=i=>{if(e.isSheetOpen()){T();return}j();const g=tt(i,"like",t);if(!g){T();return}const x=g.url||null;if((o&&o!==i||h&&x&&h!==x)&&W(),o=i,h=x,_(g.width,g.height),a.classList.add("open"),ee(),k(null),v(null,null),h){const H=t.getCachedAtlasStatus(h);if(H)k(H.reactionType),v(H.reactionType,H.downloaded);else{const O=h;t.fetchAtlasStatus(e.sendMessageSafe,O,window.location.href,V=>{V&&h===O&&(k(V.reactionType),v(V.reactionType,V.downloaded))})}}},we=i=>i?i==="blacklist"?"blacklist":i:null,ge=()=>{if(p<0||y<0||e.isSheetOpen())return;const i=te(p,y);i&&(i.closest?.(`#${t.rootId}`)||(Z(),ne(i)))},he=(i=80)=>{D!==null&&window.clearTimeout(D),D=window.setTimeout(()=>{D=null,ge()},i)},be=(i=120)=>{B!==null&&window.clearTimeout(B),B=window.setTimeout(()=>{if(B=null,e.isSheetOpen())return;const g=Ht(o,t.rootId);g&&(Z(),ne(g))},i)};document.addEventListener("pointerover",i=>{if(e.isSheetOpen()||!(i.target instanceof Element)||ce(i))return;const g=te(i.clientX,i.clientY);g&&(Z(),ne(g))},!0),window.addEventListener("atlas-shortcut-reaction-state",i=>{const g=i,x=g.detail?.media;if(!(x instanceof Element))return;Z(),ne(x);const A=!!g.detail?.pending,H=we(g.detail?.reactionType??null);if(A){C(!0,H);return}if(C(!1,null),H){const O=H==="blacklist"?"dislike":H;k(O);const V=h?t.getCachedAtlasStatus(h):null;v(O,V?.downloaded??null)}},!0),document.addEventListener("pointermove",i=>{j(),p=i.clientX,y=i.clientY},!0),document.addEventListener("click",i=>{i instanceof MouseEvent&&(e.isSheetOpen()||ce(i)||(he(40),window.setTimeout(()=>he(220),220),be(140),window.setTimeout(()=>be(260),260)))},!0),document.addEventListener("pointerout",i=>{!o||e.isSheetOpen()||!(i.target instanceof Element)||ce(i)||!(i.target.closest?.("img, video")??null)||z()},!0),a.addEventListener("pointerenter",Z,!0),a.addEventListener("pointerleave",z,!0),window.addEventListener("scroll",ee,!0),window.addEventListener("resize",ee),window.addEventListener(Ze,j,!0),window.addEventListener("blur",T),window.addEventListener("focus",()=>he(40),!0),new MutationObserver(()=>{j(),he(60),o&&be(90)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}function F(e){const t=e.indexOf("#");return t===-1?e:e.slice(0,t)}function at(e){return!e||typeof e!="string"?[]:e.split(/[\n,]/g).map(t=>t.trim()).filter(t=>t&&!t.startsWith("#")).map(t=>(t.startsWith("*.")?t.slice(2):t).toLowerCase()).map(t=>De(t)||t.replace(/^\.+/,"").trim()).filter(Boolean)}function rt(e,t){const a=(e||"").toLowerCase();if(!a)return!1;for(const r of t)if(Be(a,r))return!0;return!1}function De(e){if(!e||typeof e!="string")return"";const t=e.trim();if(!t)return"";const a=/^https?:\/\//i.test(t)?t:`https://${t}`;try{return new URL(a).hostname}catch{return""}}function Be(e,t){return!e||!t?!1:e===t||e.endsWith(`.${t}`)}const ot="atlas-downloader-page-markers";function lt(e){return function(a,r="info"){const o=document.createElement("div");o.className=`atlas-downloader-toast${r==="danger"?" danger":""}`,o.textContent=a,e.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove(),{once:!0})},2600)}}function it(e){return t=>new Promise(a=>{const r=document.createElement("div");r.className="atlas-downloader-dialog-backdrop";const o=document.createElement("div");o.className=`atlas-downloader-dialog${t.danger?" danger":""}`.trim(),o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.setAttribute("aria-label",t.title);const h=document.createElement("h3");h.className="atlas-downloader-dialog-title",h.textContent=t.title;const d=document.createElement("p");d.className="atlas-downloader-dialog-message",d.textContent=t.message;const b=document.createElement("div");b.className="atlas-downloader-dialog-actions";const M=y=>{r.remove(),a(y)};if(t.alternateLabel){const y=document.createElement("button");y.type="button",y.className="atlas-downloader-dialog-btn secondary",y.textContent=t.alternateLabel,y.addEventListener("click",()=>M("alternate")),b.appendChild(y)}const u=document.createElement("button");u.type="button",u.className="atlas-downloader-dialog-btn",u.textContent=t.cancelLabel||"Cancel",u.addEventListener("click",()=>M("cancel")),b.appendChild(u);const p=document.createElement("button");p.type="button",p.className=`atlas-downloader-dialog-btn primary${t.danger?" danger":""}`.trim(),p.textContent=t.confirmLabel,p.addEventListener("click",()=>M("confirm")),b.appendChild(p),o.appendChild(h),o.appendChild(d),o.appendChild(b),r.appendChild(o),e.appendChild(r),requestAnimationFrame(()=>{p.focus()})})}function Wt(){if(document.getElementById(ot))return;const e=document.createElement("style");e.id=ot,e.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 4px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 4px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 4px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 4px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 4px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: -4px !important;
}
`,(document.head||document.documentElement).appendChild(e)}(()=>{const a="atlas-downloader-root",r="atlas-open",o=(()=>{try{return window.top===window.self}catch{return!1}})(),h=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let d=null,b=null;const M=3e4,u=new Map;function p(_,S){const C=typeof _=="string"?_:"";return C.length<=S?C:C.slice(0,S)}function y(_){return vt(_)||"Extension"}function D(_){const S=u.get(_);return S?Date.now()-S.ts>M?(u.delete(_),null):S:null}function B(_,S,C,k){const v=F((S||"").trim());if(!v){k(null);return}const U=D(v);if(U){k(U);return}_({type:"atlas-check-batch",urls:[v]},W=>{if(!W||!W.ok){k(null);return}const j=Array.isArray(W.data?.results)?W.data.results:[],T=new Map(j.filter(Q=>typeof Q?.url=="string"&&Q.url.trim()!=="").map(Q=>[F(String(Q.url)),Q])).get(v)??null;if(!T){k(null);return}const z={exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,reactionType:T.reaction?.type?String(T.reaction.type):null,ts:Date.now()};u.set(v,z),k(z)})}chrome.runtime.onMessage.addListener(_=>{if(!_||typeof _!="object")return;const S=_;if(S.type==="atlas-download-event"){b?.(S.payload);return}if(S.type==="atlas-open-sheet"&&o)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],C=>{He(C.atlasMediaNoiseFilters||"");const k=De(C.atlasBaseUrl||"");if(k&&Be(window.location.hostname,k))return;const v=at(C.atlasExcludedDomains||"");rt(window.location.hostname,v)||($(),d?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],_=>{He(_.atlasMediaNoiseFilters||"");const S=De(_.atlasBaseUrl||"");if(S&&Be(window.location.hostname,S))return;const C=at(_.atlasExcludedDomains||"");rt(window.location.hostname,C)||(o?$():re())});function re(){if(document.getElementById(a))return;const _=document.createElement("div");_.id=a;const S=_.attachShadow({mode:"closed"}),C=document.createElement("link");C.rel="stylesheet",C.href=chrome.runtime.getURL("dist/content.css"),S.appendChild(C);const k=document.createElement("div");k.className="atlas-shadow-root";const v=lt(k),U=it(k),W=(j,Z)=>{try{chrome.runtime.sendMessage(j,Z)}catch(T){(()=>{if(T instanceof Error)return T.message;if(T&&typeof T=="object"&&"message"in T){const Q=T.message;return typeof Q=="string"?Q:String(Q)}return String(T)})().includes("Extension context invalidated")?v("Atlas extension was reloaded. Refresh this tab.","danger"):v("Atlas extension error. Refresh this tab.","danger"),Z(null)}};S.appendChild(k),(document.body||document.documentElement).appendChild(_),Ge({showToast:v,sendMessageSafe:W,isSheetOpen:()=>!1,chooseDialog:U},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:y,fetchAtlasStatus:B,atlasStatusCache:u,getCachedAtlasStatus:D}),nt({root:k,showToast:v,sendMessageSafe:W,isSheetOpen:()=>!1,chooseDialog:U},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:y,fetchAtlasStatus:B,atlasStatusCache:u,getCachedAtlasStatus:D})}function $(){if(document.getElementById(a))return;const _=document.createElement("div");_.id=a;const S=_.attachShadow({mode:"closed"}),C=document.createElement("link");C.rel="stylesheet",C.href=chrome.runtime.getURL("dist/content.css"),S.appendChild(C);const k=document.createElement("div");k.className="atlas-shadow-root";const v=lt(k),U=(n,s)=>{try{chrome.runtime.sendMessage(n,s)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const m=l.message;return typeof m=="string"?m:String(m)}return String(l)})().includes("Extension context invalidated")?v("Atlas extension was reloaded. Refresh this tab.","danger"):v("Atlas extension error. Refresh this tab.","danger"),s(null)}},W=document.createElement("button");W.className="atlas-downloader-toggle",W.type="button",W.setAttribute("aria-label","Atlas Downloader"),W.title="Atlas Downloader";const j=document.createElement("img");j.alt="",j.src=chrome.runtime.getURL("icon.svg"),W.appendChild(j);const Z=document.createElement("div");Z.className="atlas-downloader-overlay";const T=document.createElement("div");T.className="atlas-downloader-modal",T.setAttribute("role","dialog"),T.setAttribute("aria-modal","true"),T.setAttribute("aria-label","Atlas Media Picker");const z=document.createElement("div");z.className="atlas-downloader-header";const Q=document.createElement("div");Q.className="atlas-downloader-title",Q.textContent="Atlas Media Picker";const ce=document.createElement("div");ce.className="atlas-downloader-version",ce.textContent=h?`v${h}`:"";const ee=document.createElement("button");ee.type="button",ee.className="atlas-downloader-close",ee.setAttribute("aria-label","Close"),ee.textContent="x",z.appendChild(Q),z.appendChild(ce),z.appendChild(ee);const te=document.createElement("div");te.className="atlas-downloader-toolbar";const ne=Ae("Rescan",()=>dt()),we=Ae("Check Atlas",()=>wt(!1)),ge=Ae("Select all",()=>ct(!0)),he=Ae("Select none",()=>ct(!1)),be=document.createElement("span");be.className="spacer";const ve=Ae("Queue selected",()=>Zt(),{primary:!0});te.appendChild(ne),te.appendChild(we),te.appendChild(ge),te.appendChild(he),te.appendChild(be),te.appendChild(ve);const i=document.createElement("div");i.className="atlas-downloader-meta";const g=document.createElement("div");g.className="atlas-downloader-list",T.appendChild(z),T.appendChild(te),T.appendChild(i),T.appendChild(g),k.appendChild(W),k.appendChild(Z),k.appendChild(T),S.appendChild(k),(document.body||document.documentElement).appendChild(_);const x=it(k);let A=[],H=0,O=null,V=null,ue=null,se=null;const oe=new Set,pe=new Map,ye=!0;let st=!1;b=n=>{if(!n||typeof n!="object")return;const s=n,l=Number.isFinite(Number(s.transferId))?Number(s.transferId):null,c=typeof s.status=="string"?s.status:"",m=!!s.downloaded||c==="completed"||typeof s.finished_at=="string",w=!!s.failed||c==="failed"||c==="canceled"||typeof s.failed_at=="string",E=new Set,f=typeof s.original=="string"?F(s.original.trim()):"",L=typeof s.referrer_url=="string"?F(s.referrer_url.trim()):"";f&&E.add(f),L&&E.add(L);const N=l?pe.get(l)??"":"";if(N&&E.add(N),E.size===0)return;const q=f||N||L||"";l&&q&&!m&&!w&&pe.set(l,q);let G=!1;for(const I of E){const ie=D(I);u.set(I,{exists:!0,downloaded:m,blacklisted:ie?!!ie.blacklisted:!1,reactionType:ie?.reactionType??null,ts:Date.now()})}for(const I of A){const ie=le(I)||F(String(I.url||""));!ie||!E.has(ie)||!oe.has(ie)&&I.status!=="Queued"||(I.atlas={exists:!0,downloaded:m,blacklisted:I.atlas?.blacklisted??!1,file_id:I.atlas?.file_id??null,reaction:I.atlas?.reaction??null},m?(I.status="",I.statusClass="",I.reactionQueued=null,oe.delete(ie)):w?(I.status="Failed",I.statusClass="err",I.reactionQueued=null,oe.delete(ie)):(I.status="Queued",I.statusClass="queued"),G=!0)}l&&(m||w)&&pe.delete(l),G&&(J(),K(X()),fe(A))},W.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),Re()}),Z.addEventListener("click",()=>Ee()),ee.addEventListener("click",()=>Ee()),document.addEventListener("keydown",n=>{const s=n.key.toLowerCase();if(n.altKey&&n.shiftKey&&s==="a"){n.preventDefault(),Re();return}if(n.key==="Escape"&&k.classList.contains(r)){Ee();return}if(!k.classList.contains(r))return;const l=n.key==="1"?"love":n.key==="2"?"like":n.key==="3"?"funny":null;if(!l)return;const c=A.find(m=>m.selected)??A[0]??null;c&&(n.preventDefault(),Ie(c,l,{closeOnSuccess:!0}))});function Ot(){k.classList.add(r),dt()}function Re(){if(k.classList.contains(r)){Ee();return}Ot()}function Ee(){k.classList.remove(r)}d=Re,Ge({showToast:v,sendMessageSafe:U,isSheetOpen:()=>k.classList.contains(r),chooseDialog:x,setHintShown:n=>{st=n},getHintShown:()=>st,enabled:ye},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:y,fetchAtlasStatus:B,atlasStatusCache:u,getCachedAtlasStatus:D}),nt({root:k,showToast:v,sendMessageSafe:U,isSheetOpen:()=>k.classList.contains(r),chooseDialog:x},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:y,fetchAtlasStatus:B,atlasStatusCache:u,getCachedAtlasStatus:D}),window.addEventListener("atlas-shortcut-reaction-state",n=>{const s=n,l=!!s.detail?.pending,c=s.detail?.reactionType?String(s.detail.reactionType):null,w=(typeof s.detail?.url=="string"?s.detail.url:"")||s.detail?.media&&ke(s.detail.media,200)?.url||"",E=w?F(w):"";if(l){O=E||"__external-reaction__",V=c||V||"like";for(const f of A)E&&(le(f)||F(String(f.url||"")))!==E||(f.reactionPending=c||f.reactionPending||"like");J(),K(X());return}O=null,V=null;for(const f of A){if(E&&(le(f)||F(String(f.url||"")))!==E)continue;f.reactionPending&&(f.reactionPending=null);const L=(E?D(E):null)??D(le(f))??D(F(String(f.url||"")));L?f.atlas={exists:!!L.exists,downloaded:!!L.downloaded,blacklisted:!!L.blacklisted,file_id:f.atlas?.file_id??null,reaction:L.reactionType?{type:L.reactionType}:f.atlas?.reaction??null}:c&&(f.atlas={exists:f.atlas?.exists??!0,downloaded:f.atlas?.downloaded??!1,blacklisted:f.atlas?.blacklisted??!1,file_id:f.atlas?.file_id??null,reaction:{type:c}}),f.atlas?.exists&&!f.atlas?.downloaded&&f.atlas?.reaction?.type&&f.atlas.reaction.type!=="dislike"?f.reactionQueued=f.atlas.reaction.type:f.reactionQueued=null}J(),K(X()),fe(A)},!0);const Ce=(n=300)=>{se!==null&&window.clearTimeout(se),se=window.setTimeout(()=>{se=null,Yt()},n)};new MutationObserver(()=>{fe(A),Ce(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>Ce(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&Ce(120)},!0),Ce(120);function Ae(n,s,l){const c=document.createElement("button");return c.type="button",c.className=`atlas-downloader-btn${l?.primary?" primary":""}`,c.textContent=n,c.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),s()}),c}function Ft(n){i.textContent=n,ve.disabled=!0,ne.disabled=!0,we.disabled=!0,ge.disabled=!0,he.disabled=!0}function K(n){i.textContent=n;const s=A.filter(c=>c.selected).length,l=A.some(c=>!!c.reactionPending)||O!==null;ve.disabled=s===0||l,ne.disabled=l,we.disabled=A.length===0||l,ge.disabled=A.length===0||l,he.disabled=A.length===0||l}function dt(){H+=1;const n=H;A=[],ue=null,g.replaceChildren(),Ft("Scanning this page…"),R(s=>{H===n&&(i.textContent=`Scanning… ${s.scanned}/${s.total}`)}).then(s=>{H===n&&(A=s.map(l=>({...l,selected:!0,status:"",statusClass:"",atlas:null,reactionPending:O&&O!=="__external-reaction__"&&(le(l)||F(String(l.url||"")))===O?V||"like":null,reactionQueued:null})),J(),K(X()),wt(!0))})}function ct(n){for(const s of A)s.selected=n;J(),K(X())}function J(){if(g.replaceChildren(),A.length===0){const n=document.createElement("div");n.style.padding="10px 12px",n.style.color="#94a3b8",n.style.fontSize="12px",n.textContent="No matching images/videos found.",g.appendChild(n);return}for(const n of A)g.appendChild(jt(n))}function jt(n){const s=document.createElement("div");s.className=`atlas-downloader-item${n.selected?" selected":""}`;const l=document.createElement("input");l.type="checkbox",l.checked=n.selected,l.addEventListener("change",()=>{n.selected=l.checked,s.classList.toggle("selected",n.selected),K(X())});const c=document.createElement("div");if(c.className="atlas-downloader-preview",n.preview_url){const P=document.createElement("img");P.loading="lazy",P.alt="",P.src=n.preview_url,c.appendChild(P)}const m=document.createElement("div");m.className="atlas-downloader-info";const w=document.createElement("div");w.className="atlas-downloader-kind",w.textContent=n.tag_name;const E=document.createElement("div");E.className="atlas-downloader-url",E.textContent=n.url,E.title=n.url;const f=document.createElement("div");f.className="atlas-downloader-sub",f.textContent=zt(n);const L=document.createElement("div");L.className="atlas-downloader-reactions";const N=n.atlas?.reaction?.type||null,q=!!n.reactionPending||!!n.reactionQueued;for(const P of Se){const de=document.createElement("button");de.type="button",de.className=`atlas-downloader-reaction-btn ${P.className}${N===P.type?" active":""}${n.reactionPending===P.type?" pending":""}${n.reactionQueued===P.type?" queued":""}`.trim(),de.setAttribute("aria-label",P.label),de.title=P.label,de.replaceChildren(Le(P.pathDs)),de.disabled=q,de.addEventListener("click",bt=>{bt.preventDefault(),bt.stopPropagation(),Ie(n,P.type)}),L.appendChild(de)}const G=document.createElement("button");if(G.type="button",G.className=`atlas-downloader-reaction-btn ${Y.className}${n.atlas?.blacklisted?" active":""}${n.reactionPending===Y.type?" pending":""}${n.reactionQueued===Y.type?" queued":""}`.trim(),G.setAttribute("aria-label",Y.label),G.title=Y.label,G.replaceChildren(Le(Y.pathDs)),G.disabled=q,G.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),Ie(n,"dislike",{blacklist:!0})}),L.appendChild(G),n.atlas?.downloaded){const P=document.createElement("button");P.type="button",P.className=`atlas-downloader-reaction-btn delete${n.reactionPending==="delete-download"?" pending":""}`.trim(),P.setAttribute("aria-label","Delete download"),P.title="Delete download",P.replaceChildren(Le(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),P.disabled=q,P.addEventListener("click",de=>{de.preventDefault(),de.stopPropagation(),Xt(n)}),L.appendChild(P)}const I=document.createElement("button");I.type="button",I.className=`atlas-downloader-debug-toggle${ue===n.url?" active":""}`,I.textContent=ue===n.url?"Hide debug":"Debug",I.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),ue=ue===n.url?null:n.url,J(),K(X())}),L.appendChild(I),m.appendChild(w),m.appendChild(E),m.appendChild(f),m.appendChild(L),ue===n.url&&m.appendChild(Qt(n));const ie=document.createElement("div"),gt=Kt(n);return ie.className=`atlas-downloader-status ${gt.className}`.trim(),ie.textContent=gt.text,s.addEventListener("click",P=>{P.target instanceof HTMLInputElement||(n.selected=!n.selected,l.checked=n.selected,s.classList.toggle("selected",n.selected),K(X()))}),s.appendChild(l),s.appendChild(c),s.appendChild(m),s.appendChild(ie),s}function ut(n,s){return{type:s,url:n.url,referrer_url:n.referrer_url||window.location.href,page_title:p(document.title,500),tag_name:n.tag_name,width:n.width,height:n.height,alt:p(n.alt||"",500),preview_url:n.preview_url||"",source:y(n.url),...n.download_via?{download_via:n.download_via}:{}}}function ft(n){return{url:n.url,referrer_url:n.referrer_url||window.location.href,page_title:p(document.title,500),tag_name:n.tag_name,width:n.width,height:n.height,alt:p(n.alt||"",500),preview_url:n.preview_url||"",source:y(n.url),...n.download_via?{download_via:n.download_via}:{},reaction_type:"like"}}function Qt(n){const s=document.createElement("details");s.className="atlas-downloader-debug",s.open=!0;const l=document.createElement("summary");l.textContent="Debug payload",s.appendChild(l);const c={react:ut(n,n.atlas?.reaction?.type||"like"),download:ft(n)};return s.appendChild(qt(c)),s}function qt(n,s=0){const l=document.createElement("div");l.className="atlas-downloader-json-tree";const c=xe(n);if(!ht(c)){const w=document.createElement("div");return w.className="atlas-downloader-json-line",w.textContent=pt(c),l.appendChild(w),l}const m=Array.isArray(c)?c.map((w,E)=>[String(E),w]):Object.entries(c);for(const[w,E]of m)l.appendChild(mt(w,E,s));return l}function mt(n,s,l){const c=xe(s),m=document.createElement("div");if(m.className="atlas-downloader-json-line",m.style.paddingLeft=`${l*12}px`,!ht(c))return m.innerHTML=`<span class="atlas-downloader-json-key">${Te(n)}</span>: <span class="atlas-downloader-json-value">${Te(pt(c))}</span>`,m;const w=document.createElement("details");w.className="atlas-downloader-json-node",w.open=l===0;const E=document.createElement("summary");E.style.paddingLeft=`${l*12}px`;const f=Array.isArray(c)?`[${c.length}]`:`{${Object.keys(c).length}}`;E.innerHTML=`<span class="atlas-downloader-json-key">${Te(n)}</span>: <span class="atlas-downloader-json-preview">${Te(f)}</span>`,w.appendChild(E);const L=Array.isArray(c)?c.map((N,q)=>[String(q),N]):Object.entries(c);for(const[N,q]of L)w.appendChild(mt(N,q,l+1));return w}function xe(n){if(n===void 0)return null;if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return n;if(Array.isArray(n))return n.map(l=>xe(l));if(!n||typeof n!="object")return null;const s={};for(const[l,c]of Object.entries(n))s[l]=xe(c);return s}function ht(n){return Array.isArray(n)||n&&typeof n=="object"}function pt(n){return JSON.stringify(n)}function Te(n){return String(n).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function zt(n){const s=n.width&&n.height?`${n.width}×${n.height}`:"size unknown",l=Vt(n.url);return l?`${s} • ${l}`:s}function Vt(n){try{return new URL(n).hostname}catch{return""}}function X(){const n=A.filter(s=>s.selected).length;return`${A.length} found • ${n} selected`}function le(n){const s=(n?.url||n?.referrer_url||"").trim();return s?F(s):""}function Kt(n){return n.status?{text:n.status,className:n.statusClass||""}:n.atlas?.downloaded?{text:"Downloaded",className:"ok"}:n.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:n.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function wt(n){const s=[...new Set(A.map(l=>le(l)).filter(Boolean))];s.length!==0&&U({type:"atlas-check-batch",urls:s},l=>{if(!l){n||v("Atlas extension did not respond.","danger");return}if(!l.ok){n||v(l.error||"Atlas check failed.","danger");return}const c=Array.isArray(l.data?.results)?l.data.results:[],m=new Map(c.filter(f=>typeof f?.url=="string"&&f.url.trim()!=="").map(f=>[F(String(f.url)),f]));let w=0,E=0;for(const f of A){const L=le(f),N=m.get(L);N&&(f.atlas={exists:!!N.exists,downloaded:!!N.downloaded,blacklisted:!!N.blacklisted,file_id:N.file_id??null,reaction:N.reaction??null},f.atlas.exists&&!f.atlas.downloaded&&f.atlas.reaction?.type&&f.atlas.reaction.type!=="dislike"?(f.reactionQueued=f.atlas.reaction.type,oe.add(L)):(f.reactionQueued=null,oe.delete(L)),u.set(L,{exists:!!N.exists,downloaded:!!N.downloaded,blacklisted:!!N.blacklisted,reactionType:N.reaction?.type?String(N.reaction.type):null,ts:Date.now()}),N.exists&&(w+=1),N.downloaded&&(E+=1))}J(),K(X()),fe(A),n||v(`Atlas check: ${E}/${w} downloaded.`)})}function Ie(n,s,l={}){const c=(w={})=>{n.reactionPending=l.blacklist?Y.type:s,n.status="Reacting…",n.statusClass="",O=le(n)||n.url,V=n.reactionPending,J(),K(X());const E={...ut(n,s),...w,...l.blacklist?{blacklist:!0}:{}};U({type:"atlas-react",payload:E},f=>{if(n.reactionPending=null,O=null,V=null,!f){n.status="No response",n.statusClass="err",J(),K(X()),v("Atlas extension did not respond.","danger");return}if(!f.ok){n.status=f.error||"Failed",n.statusClass="err",J(),K(X()),v(f.error||"Reaction failed.","danger");return}const L=f.data||null,N=L?.file||null;n.atlas={exists:!!N,downloaded:!!N?.downloaded,blacklisted:!!N?.blacklisted_at,file_id:N?.id??null,reaction:L?.reaction??null};const q=le(n)||n.url;u.set(q,{exists:n.atlas.exists,downloaded:n.atlas.downloaded,blacklisted:n.atlas.blacklisted,reactionType:n.atlas.reaction?.type?String(n.atlas.reaction.type):null,ts:Date.now()}),n.atlas.exists&&!n.atlas.downloaded&&s!=="dislike"?(n.status="Queued",n.statusClass="queued",n.reactionQueued=l.blacklist?Y.type:s,q&&oe.add(q)):(n.status="",n.statusClass="",n.reactionQueued=null,q&&oe.delete(q)),J(),K(X()),fe(A),l.closeOnSuccess&&Ee()})},m=!!n.atlas?.reaction?.type;if(s!=="dislike"&&n.atlas?.downloaded&&m){x({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(w=>{if(w==="alternate"){v("Cancelled.");return}c(w==="confirm"?{force_download:!0}:{})});return}if(s==="dislike"&&n.atlas?.downloaded){x({title:l.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(w=>{if(w==="alternate"){v("Cancelled.");return}c(w==="confirm"?{clear_download:!0}:{})});return}c()}function Xt(n){x({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(s=>{s==="confirm"&&(n.reactionPending="delete-download",n.status="Deleting…",n.statusClass="",O=le(n)||n.url,V=n.reactionPending,J(),K(X()),U({type:"atlas-delete-download",payload:{url:n.url,tag_name:n.tag_name,download_via:n.download_via||null}},l=>{if(n.reactionPending=null,O=null,V=null,!l||!l.ok){n.status=l?.error||"Failed",n.statusClass="err",J(),K(X()),v(l?.error||"Delete failed.","danger");return}const c=l.data?.file||null;n.atlas={exists:!!c,downloaded:!!c?.downloaded,blacklisted:!!c?.blacklisted_at,file_id:c?.id??null,reaction:null},n.reactionQueued=null;const m=le(n)||n.url;u.set(m,{exists:n.atlas.exists,downloaded:n.atlas.downloaded,blacklisted:n.atlas.blacklisted,reactionType:null,ts:Date.now()}),n.status="",n.statusClass="",J(),K(X()),fe(A),v("Download deleted.")}))})}function Zt(){const n=A.filter(c=>c.selected);if(n.length===0){v("Select one or more items first.");return}if(n.some(c=>!!c.atlas?.downloaded)){x({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(c=>{if(c==="alternate"){v("Cancelled.");return}l(c==="confirm")});return}l(!1);function l(c){ve.disabled=!0,ne.disabled=!0,we.disabled=!0,ge.disabled=!0,he.disabled=!0;for(const w of n)w.status="Sending…",w.statusClass="";J();const m=n.map(w=>{const E=ft(w);return c&&(E.force_download=!0),E});U({type:"atlas-download-batch",payloads:m},w=>{if(!w){for(const f of n)f.status="No response",f.statusClass="err";J(),K(X()),v("Atlas extension did not respond.","danger");return}const E=Array.isArray(w.results)?w.results:[];for(let f=0;f<n.length;f+=1){const L=n[f],N=E[f];if(N?.ok){const q=N.data||null,G=q?.file||null;if(L.atlas={exists:!!G,downloaded:!!G?.downloaded,blacklisted:!!G?.blacklisted_at,file_id:G?.id??null,reaction:L.atlas?.reaction??null},q?.queued){L.status="Queued",L.statusClass="queued",L.atlas?.reaction?.type&&L.atlas.reaction.type!=="dislike"&&(L.reactionQueued=L.atlas.reaction.type);const I=le(L)||F(String(L.url||""));I&&oe.add(I)}else{L.status="",L.statusClass="",L.reactionQueued=null;const I=le(L)||F(String(L.url||""));I&&oe.delete(I)}}else L.status=N?.error||"Failed",L.statusClass="err"}J(),K(X()),fe(A),w.ok?v(`Queued ${n.length} download(s) in Atlas.`):v(w.error||"Some requests failed.","danger")})}}function fe(n=A){Wt();const s=document.querySelectorAll('[data-atlas-marked="1"]');for(const m of s)m.removeAttribute("data-atlas-marked"),m.removeAttribute("data-atlas-state"),m.removeAttribute("data-atlas-reaction");const l=new Map;for(const[m,w]of u.entries()){if(Date.now()-w.ts>M){u.delete(m);continue}l.set(m,{exists:!!w.exists,downloaded:!!w.downloaded,blacklisted:!!w.blacklisted,reactionType:w.reactionType?String(w.reactionType):null}),l.set(F(m),{exists:!!w.exists,downloaded:!!w.downloaded,blacklisted:!!w.blacklisted,reactionType:w.reactionType?String(w.reactionType):null})}for(const m of n){if(!m?.url||!m?.atlas)continue;const w=m.atlas?.reaction?.type?String(m.atlas.reaction.type):null,E={exists:!!m.atlas.exists,downloaded:!!m.atlas.downloaded,blacklisted:!!m.atlas.blacklisted,reactionType:w};l.set(m.url,E),l.set(F(m.url),E)}if(l.size===0)return;const c=document.querySelectorAll("img, video, a[href]");for(const m of c){const w=Oe(m);if(w.length===0)continue;const E=w.map(f=>l.get(f)||l.get(F(f))).find(f=>!!(f&&(f.exists||f.downloaded||f.blacklisted||f.reactionType)))??null;E&&(m.setAttribute("data-atlas-marked","1"),E.blacklisted?m.setAttribute("data-atlas-state","blacklisted"):E.reactionType?m.setAttribute("data-atlas-state","reacted"):E.downloaded?m.setAttribute("data-atlas-state","downloaded"):E.exists&&m.setAttribute("data-atlas-state","exists"),E.reactionType&&m.setAttribute("data-atlas-reaction",E.reactionType))}}function Jt(){const n=new Set,s=document.querySelectorAll("img, video, a[href]");for(const c of s)for(const m of Oe(c))n.add(m),n.add(F(m));const l=We();return l?.url&&(n.add(l.url),n.add(F(l.url))),[...n].filter(Boolean)}function Yt(){const n=Jt();if(n.length===0){fe(A);return}U({type:"atlas-check-batch",urls:n},s=>{if(!s?.ok){fe(A);return}const l=Array.isArray(s.data?.results)?s.data.results:[];for(const c of l)c?.url&&u.set(String(c.url),{exists:!!c.exists,downloaded:!!c.downloaded,blacklisted:!!c.blacklisted,reactionType:c.reaction?.type?String(c.reaction.type):null,ts:Date.now()});fe(A)})}}function R(_){return new Promise(S=>{const C=document.body||document.documentElement,k=Array.from(C.querySelectorAll("img, video")),v=k.length,U=new Set,W=[];let j=0;const Z=z=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(z,{timeout:500});return}setTimeout(()=>z({timeRemaining:()=>25}),0)},T=z=>{const Q=typeof z?.timeRemaining=="function"?z.timeRemaining():25;let ce=0;for(;j<v&&(ce<80||Q>5);){const te=k[j];if(te.closest&&te.closest(`#${a}`)){j+=1,ce+=1;continue}const ne=ke(te,200);ne?.url&&!U.has(ne.url)&&(U.add(ne.url),W.push(ne)),j+=1,ce+=1}if(_?.({scanned:j,total:v}),j<v){Z(T);return}const ee=We();ee&&!U.has(ee.url)&&(U.add(ee.url),W.push(ee)),S(W)};Z(T)})}})()})();
