(function(){"use strict";const gt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function bt(t){const e=(t||"").trim().toLowerCase();if(!e)return"";const a=e.split(".").filter(Boolean);if(a.length<=2)return e;const r=a.slice(-2).join("."),o=a.slice(-3).join(".");return gt.has(r)&&a.length>=3?o:r}function yt(t){const e=(t||"").trim();if(!e)return"";try{const a=new URL(e).hostname;return bt(a)}catch{return""}}function kt(t,e){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const r=a.toLowerCase();if(r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:"))return"";try{const o=new URL(a,e);return o.protocol!=="http:"&&o.protocol!=="https:"?"":o.toString()}catch{return""}}function Ee(t){let e=t,a=0;for(;e&&a<24;){const r=e.getAttribute?.("role");if(r==="dialog"||r==="alertdialog"||e.getAttribute?.("aria-modal")==="true")return!0;const h=(e.getAttribute?.("class")||"").toLowerCase(),d=(e.getAttribute?.("id")||"").toLowerCase(),y=`${h} ${d}`.trim();if(y&&/(modal|lightbox|overlay|dialog)/.test(y))return!0;const _=window.getComputedStyle(e);if((_.position==="fixed"||_.position==="sticky")&&vt(e))return!0;e=e.parentElement,a+=1}return!1}function vt(t){const e=t.getBoundingClientRect();if(e.width>0&&e.height>0){const a=Math.max(window.innerWidth*.4,320),r=Math.max(window.innerHeight*.4,240);return e.width>=a&&e.height>=r}if(t instanceof HTMLElement){const a=t.style,r=a.inset==="0"||a.inset==="0px"||(a.top==="0"||a.top==="0px")&&(a.left==="0"||a.left==="0px")&&(a.right==="0"||a.right==="0px")&&(a.bottom==="0"||a.bottom==="0px"),o=/^(100vw|100%)$/i.test(a.width||"")||/^(100vh|100%)$/i.test(a.height||"");return r||o}return!1}const Et=qe(["host:st.deviantart.net","url:*wixmp.com*/crop/w_92,h_92*","url:*wixmp.com*/crop/w_150,h_150*","url:*wixmp.com*/fit/w_150,h_150*"].join(`
`));let Ie=[];function ae(t){return kt(t,window.location.href)}function Pe(t){Ie=qe(t)}function He(t){const e=ae(t.currentSrc)||ae(t.src)||ae(t.getAttribute("src")||"");if(e)return e;const a=t.querySelector("source[src]"),r=a?ae(a.src||a.getAttribute("src")||""):"";if(r)return r;const o=_t(t);return o||St()}function ye(t,e){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,r=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),o=ae(r);if(o&&Ne(o))return null;const{width:h,height:d}=xt(a,o||r),y=h??ue(a.clientWidth),_=d??ue(a.clientHeight);if(y&&y<e||_&&_<e)return null;if(!o){const c=ae(document.referrer)||ae(window.location.href)||"";return!c||!r.toLowerCase().startsWith("blob:")&&!r.toLowerCase().startsWith("data:")||Ne(c)?null:{tag_name:"img",url:c,referrer_url:window.location.href,preview_url:"",width:h,height:d,alt:a.alt||""}}return{tag_name:"img",url:o,referrer_url:window.location.href,preview_url:o,width:h,height:d,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=t,r=a.videoWidth||a.clientWidth||null,o=a.videoHeight||a.clientHeight||null;if(r&&o&&(r<e||o<e))return null;const h=He(a);if(h&&Ne(h))return null;if(!h){const d=(a.currentSrc||a.src||"").trim().toLowerCase();if(d.startsWith("blob:")||d.startsWith("data:")){const y=window.location.href;return{tag_name:"video",url:y,referrer_url:y,preview_url:a.poster||"",width:r,height:o,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:h,referrer_url:window.location.href,preview_url:a.poster||"",width:r,height:o,alt:""}}return null}function Ue(){const t=(window.location.href||"").trim();if(!t)return null;const e=t.toLowerCase(),a=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(e),r=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!a&&!r)return null;if(e.startsWith("http://")||e.startsWith("https://"))return{tag_name:e.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(e.startsWith("blob:")||e.startsWith("data:")){const o=ae(document.referrer)||"";return o?{tag_name:"img",url:o,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function $e(t){const e=new Set,a=ae(window.location.href),r=t instanceof HTMLImageElement?ae(t.currentSrc)||ae(t.src)||"":t instanceof HTMLVideoElement?He(t)||"":t instanceof HTMLAnchorElement&&We(t.getAttribute("href")||"")||"";r&&e.add(r);const o=t.closest("a[href]")?.getAttribute("href")??"",h=We(o);return h&&e.add(h),a&&At(t)&&e.add(a),[...e]}function We(t){const e=(t||"").trim();return!e||e.startsWith("#")||e.toLowerCase().startsWith("javascript:")?"":ae(e)}function At(t){if(t instanceof HTMLImageElement){const e=(t.currentSrc||t.src||t.getAttribute("src")||"").trim().toLowerCase();return e.startsWith("blob:")||e.startsWith("data:")}if(t instanceof HTMLVideoElement){const e=(t.currentSrc||t.src||"").trim().toLowerCase();return e.startsWith("blob:")||e.startsWith("data:")}return!1}function St(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const e of t){const r=document.querySelector(e)?.getAttribute("content")||"",o=ae(r);if(o)return o}return""}function _t(t){let e=t,a=0;for(;e&&a<8;){const r=e.getAttribute?.("data-store");if(r){const o=Lt(r),h=Te(o,0);if(h)return h}e=e.parentElement,a+=1}return""}function Lt(t){if(!t)return null;const e=Ct(t);try{return JSON.parse(e)}catch{return null}}function Ct(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Te(t,e){if(!t||e>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const a of t){const r=Te(a,e+1);if(r)return r}return""}if(typeof t=="object")for(const a of Object.keys(t)){const r=t[a],o=Te(r,e+1);if(o)return o}return""}function xt(t,e){const a=ue(t.naturalWidth),r=ue(t.naturalHeight),o=ue(t.clientWidth),h=ue(t.clientHeight),d=Mt(e),y=Fe(t.getAttribute("width")),_=Fe(t.getAttribute("height"));return{width:je(a,o,d.width,y),height:je(r,h,d.height,_)}}function Mt(t){const e=(t||"").trim();if(!e)return{width:null,height:null};const a=Oe(e,[/(?:^|[/,?&_=-])w_(\d{2,5})(?=$|[/,?&_=-])/i]),r=Oe(e,[/(?:^|[/,?&_=-])h_(\d{2,5})(?=$|[/,?&_=-])/i]);let o=a;const h=r,d=e.match(/-(\d{2,5})w-(\d)x(?=$|[./?&_-])/i);if(d){const y=parseInt(d[1],10),_=parseInt(d[2],10),c=ue(y*_);c&&(!o||c>o)&&(o=c)}return{width:o??null,height:h??null}}function Oe(t,e){for(const a of e){const r=t.match(a);if(!r||!r[1])continue;const o=ue(parseInt(r[1],10));if(o)return o}return null}function Fe(t){if(!t)return null;const e=t.trim();if(!e)return null;const a=e.match(/^\d+/)?.[0]??"";return a?ue(parseInt(a,10)):null}function je(t,e,a,r){return t||e||a||r}function ue(t){if(typeof t!="number"||!Number.isFinite(t))return null;const e=Math.round(t);return e>0?e:null}function Ne(t){const e=(t||"").trim().toLowerCase();if(!e)return!1;const a=[...Et,...Ie],r=Tt(e);for(const o of a){if(o.kind==="host"){if(Nt(r,o.host))return!0;continue}if(o.kind==="urlPattern"){if(o.regex.test(e))return!0;continue}if(e.includes(o.needle))return!0}return!1}function Tt(t){try{return new URL(t).hostname.toLowerCase()}catch{return""}}function Nt(t,e){const a=(t||"").trim().toLowerCase(),r=(e||"").trim().toLowerCase();return!a||!r?!1:a===r||a.endsWith(`.${r}`)}function qe(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e!==""&&!e.startsWith("#")).map(e=>Dt(e)).filter(e=>e!==null)}function Dt(t){const e=t.trim();if(!e)return null;const a=e.toLowerCase();if(a.startsWith("host:")){const o=ze(e.slice(5));return o?{kind:"host",host:o}:null}if(a.startsWith("url:"))return Qe(e.slice(4));const r=ze(e);return r?{kind:"host",host:r}:Qe(e)}function Qe(t){const e=t.trim().toLowerCase();if(!e)return null;if(!e.includes("*"))return{kind:"urlContains",needle:e};const a=Bt(e);try{return{kind:"urlPattern",regex:new RegExp(a,"i")}}catch{return null}}function Bt(t){return t.split("*").map(e=>Rt(e)).join(".*")}function Rt(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ze(t){const e=(t||"").trim();if(!e)return"";const a=e.startsWith("*.")?e.slice(2):e,r=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(r).hostname.toLowerCase()}catch{return""}}const Ve="http://www.w3.org/2000/svg",Ae=t=>{const e=document.createElementNS(Ve,"svg");e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("aria-hidden","true"),e.setAttribute("fill","none"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-linecap","round"),e.setAttribute("stroke-linejoin","round"),e.setAttribute("width","18"),e.setAttribute("height","18");for(const a of t){const r=document.createElementNS(Ve,"path");r.setAttribute("d",a),r.setAttribute("fill","none"),r.setAttribute("stroke","currentColor"),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round"),e.appendChild(r)}return e},Se=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],J={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Ke="atlas-location-change";function _e(t,e){return!!t.closest?.(`#${e}`)}function It(t,e,a){const r=t.querySelectorAll?.("img, video");if(!r||r.length===0)return null;let o=null;for(const h of r){const d=h.getBoundingClientRect();if(d.width<=0||d.height<=0||e<d.left||e>d.right||a<d.top||a>d.bottom)continue;const y=d.width*d.height;(!o||y>o.area)&&(o={media:h,area:y})}return o}function Xe(t,e){return t?t.inModal!==e.inModal?e.inModal?e:t:e.area!==t.area?e.area>t.area?e:t:e.stackIndex<t.stackIndex?e:t:e}function Ze(t,e,a){const o=(document.elementsFromPoint?.(t,e)??[]).filter(d=>d instanceof Element);if(o.length===0){const d=document.elementFromPoint?.(t,e);d instanceof Element&&o.push(d)}let h=null;for(const[d,y]of o.entries())if(!_e(y,a)&&y.matches("img, video")){const _=y.getBoundingClientRect();h=Xe(h,{media:y,area:Math.max(_.width*_.height,1),stackIndex:d,inModal:Ee(y)})}for(const[d,y]of o.entries()){if(_e(y,a))continue;const _=It(y,t,e);_&&(h=Xe(h,{media:_.media,area:_.area,stackIndex:d,inModal:Ee(_.media)}))}return h?h.media:null}function Je(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return 0;const a=Math.max(e.left,0),r=Math.max(e.top,0),o=Math.min(e.right,window.innerWidth),h=Math.min(e.bottom,window.innerHeight),d=o-a,y=h-r;return d<=0||y<=0?0:d*y}function Pt(t,e){const a=Array.from(document.querySelectorAll("img, video")).filter(y=>!_e(y,e));if(a.length===0)return null;const r=t?Je(t):0,o=t?Ee(t):!1;let h=null,d=null;for(const y of a){const _=Je(y);_<=0||((!d||_>d.area)&&(d={media:y,area:_}),Ee(y)&&(!h||_>h.area)&&(h={media:y,area:_}))}return h&&h.media!==t&&(!o||h.area>r*1.1)?h.media:d&&d.media!==t&&d.area>r*1.6?d.media:null}function Ye(t,e){const a=t.enabled??!0,r=t.getHintShown??(()=>!1),o=t.setHintShown??(()=>{}),h=()=>{r()||(o(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},d=(c,p,k,M=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:c,pending:p,reactionType:k,url:M}}))},y=c=>(typeof c.composedPath=="function"?c.composedPath():[]).some(k=>k instanceof HTMLElement&&k.id===e.rootId),_=c=>{const k=(c.target instanceof Element?c.target:null)?.closest?.("img, video")??null;if(k instanceof Element&&!_e(k,e.rootId))return k;const M=Ze(c.clientX,c.clientY,e.rootId);return M||null};document.addEventListener("click",c=>{!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||y(c)||!_(c)||(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())},!0),document.addEventListener("mousedown",c=>{if(!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||y(c))return;const p=_(c);if(!p)return;const k=c.button===0?"like":c.button===1?"love":null;if(!k)return;h(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const M=ye(p,e.minSize);if(!M){if(p instanceof HTMLVideoElement){const re=(p.currentSrc||p.src||"").trim().toLowerCase();if(re.startsWith("blob:")||re.startsWith("data:")){const $=window.location.href,D={type:k,url:$,referrer_url:$,page_title:e.limitString(document.title,e.maxMetadataLen),tag_name:"video",width:p.videoWidth||p.clientWidth||null,height:p.videoHeight||p.clientHeight||null,alt:"",preview_url:p.poster||"",source:e.sourceFromMediaUrl($),download_via:"yt-dlp"};e.fetchAtlasStatus(t.sendMessageSafe,D.url,D.referrer_url||null,C=>{if(C?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(L=>{if(L==="alternate"){t.showToast("Cancelled.");return}d(p,!0,k,D.url),L==="confirm"&&(D.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:D},x=>{if(!x||!x.ok){d(p,!1,null,D.url),t.showToast(x?.error||"Reaction failed.","danger");return}const A=x.data||null,v=A?.file||null,H=A?.reaction?.type?String(A.reaction.type):k;e.atlasStatusCache.set(D.url,{exists:!!v,downloaded:!!v?.downloaded,blacklisted:!!v?.blacklisted_at,reactionType:H,ts:Date.now()}),d(p,!1,H,D.url),t.showToast(`Reacted (${k}). Resolving video in Atlas…`)})});return}d(p,!0,k,D.url),t.sendMessageSafe({type:"atlas-react",payload:D},L=>{if(!L||!L.ok){d(p,!1,null,D.url),t.showToast(L?.error||"Reaction failed.","danger");return}const x=L.data||null,A=x?.file||null,v=x?.reaction?.type?String(x.reaction.type):k;e.atlasStatusCache.set(D.url,{exists:!!A,downloaded:!!A?.downloaded,blacklisted:!!A?.blacklisted_at,reactionType:v,ts:Date.now()}),d(p,!1,v,D.url),t.showToast(`Reacted (${k}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const I={type:k,url:M.url,referrer_url:M.referrer_url||window.location.href,page_title:e.limitString(document.title,e.maxMetadataLen),tag_name:M.tag_name,width:M.width,height:M.height,alt:e.limitString(M.alt||"",e.maxMetadataLen),preview_url:M.preview_url||"",source:e.sourceFromMediaUrl(M.url)};e.fetchAtlasStatus(t.sendMessageSafe,I.url,I.referrer_url||null,re=>{if(re?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then($=>{if($==="alternate"){t.showToast("Cancelled.");return}d(p,!0,k,I.url),$==="confirm"&&(I.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:I},D=>{if(!D||!D.ok){d(p,!1,null,I.url),t.showToast(D?.error||"Reaction failed.","danger");return}const C=D.data||null,L=C?.file||null,x=C?.reaction?.type?String(C.reaction.type):k;e.atlasStatusCache.set(I.url,{exists:!!L,downloaded:!!L?.downloaded,blacklisted:!!L?.blacklisted_at,reactionType:x,ts:Date.now()}),d(p,!1,x,I.url),t.showToast(`Reacted (${k}). Queued download in Atlas.`)})});return}d(p,!0,k,I.url),t.sendMessageSafe({type:"atlas-react",payload:I},$=>{if(!$||!$.ok){d(p,!1,null,I.url),t.showToast($?.error||"Reaction failed.","danger");return}const D=$.data||null,C=D?.file||null,L=D?.reaction?.type?String(D.reaction.type):k;e.atlasStatusCache.set(I.url,{exists:!!C,downloaded:!!C?.downloaded,blacklisted:!!C?.blacklisted_at,reactionType:L,ts:Date.now()}),d(p,!1,L,I.url),t.showToast(`Reacted (${k}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",c=>{if(!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||y(c))return;const p=_(c);if(!p)return;h(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const k=ye(p,e.minSize);if(!k){if(p instanceof HTMLVideoElement){const I=(p.currentSrc||p.src||"").trim().toLowerCase();if(I.startsWith("blob:")||I.startsWith("data:")){const re=window.location.href,$={type:"dislike",url:re,referrer_url:re,page_title:e.limitString(document.title,e.maxMetadataLen),tag_name:"video",width:p.videoWidth||p.clientWidth||null,height:p.videoHeight||p.clientHeight||null,alt:"",preview_url:p.poster||"",source:e.sourceFromMediaUrl(re),download_via:"yt-dlp"};d(p,!0,"dislike",$.url),t.sendMessageSafe({type:"atlas-react",payload:$},D=>{if(!D||!D.ok){d(p,!1,null,$.url),t.showToast(D?.error||"Reaction failed.","danger");return}d(p,!1,"dislike",$.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const M={type:"dislike",url:k.url,referrer_url:k.referrer_url||window.location.href,page_title:e.limitString(document.title,e.maxMetadataLen),tag_name:k.tag_name,width:k.width,height:k.height,alt:e.limitString(k.alt||"",e.maxMetadataLen),preview_url:k.preview_url||"",source:e.sourceFromMediaUrl(k.url)};d(p,!0,"dislike",M.url),t.sendMessageSafe({type:"atlas-react",payload:M},I=>{if(!I||!I.ok){d(p,!1,null,M.url),t.showToast(I?.error||"Reaction failed.","danger");return}d(p,!1,"dislike",M.url),t.showToast("Disliked.")})},!0),document.addEventListener("auxclick",c=>{!a||!(c instanceof MouseEvent)||!c.altKey||c.button!==1||t.isSheetOpen()||y(c)||!_(c)||(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())},!0)}function Ge(t,e,a){return t<e?e:t>a?a:t}function Ht(){const t=window;if(t.__atlasLocationObserverInstalled)return;t.__atlasLocationObserverInstalled=!0;const e=()=>{window.dispatchEvent(new Event(Ke))},a=r=>{const o=history[r].bind(history);history[r]=((...h)=>{const d=o(...h);return e(),d})};a("pushState"),a("replaceState"),window.addEventListener("popstate",e,!0),window.addEventListener("hashchange",e,!0)}function et(t,e,a){const r=ye(t,a.minSize);if(r)return{type:e,url:r.url,referrer_url:r.referrer_url||window.location.href,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:r.tag_name,width:r.width,height:r.height,alt:a.limitString(r.alt||"",a.maxMetadataLen),preview_url:r.preview_url||"",source:a.sourceFromMediaUrl(r.url)};if(t instanceof HTMLVideoElement){const o=(t.currentSrc||t.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const h=window.location.href;return{type:e,url:h,referrer_url:h,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:a.sourceFromMediaUrl(h),download_via:"yt-dlp"}}}return null}function tt(t,e){Ht();const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");const r=document.createElement("span");r.className="atlas-downloader-media-resolution",r.hidden=!0,a.appendChild(r);let o=null,h=null,d=null,y=null,_=!1,c=null,p=null,k=-1,M=-1,I=null,re=window.location.href;const $=new Map,D=(s,b)=>{const w=typeof s=="number"&&Number.isFinite(s)&&s>0?Math.round(s):null,z=typeof b=="number"&&Number.isFinite(b)&&b>0?Math.round(b):null;return!w||!z?"":`${w}x${z}`},C=(s,b)=>{const w=D(s,b);if(!w){r.textContent="",r.hidden=!0;return}r.textContent=w,r.hidden=!1},L=()=>{const s=_||c!==null;for(const[b,w]of $.entries())w.disabled=s,w.classList.toggle("pending",_&&p===b)},x=(s,b=null)=>{_=s,p=s?b:null,L()},A=s=>{for(const b of[...Se,J]){const w=$.get(b.type);if(!w)continue;const z=b.type===J.type?s==="dislike":s===b.type;w.classList.toggle("active",z)}},v=(s,b)=>{c=s&&b===!1&&s!=="dislike"?s:null;for(const w of[...Se,J]){const z=$.get(w.type);if(!z)continue;const N=w.type===J.type?c==="dislike":c===w.type;z.classList.toggle("queued",N)}L()},H=(s,b,w)=>{o&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:o,pending:s,reactionType:b,url:w}}))},j=()=>{_&&(H(!1,null,h||null),x(!1,null))},U=()=>{const s=window.location.href;s!==re&&(re=s,j(),P(!0))},q=()=>{d!==null&&(window.cancelAnimationFrame(d),d=null),y!==null&&(window.cancelAnimationFrame(y),y=null)},P=s=>{_&&!(s===!0)||(o=null,h=null,a.classList.remove("open"),a.style.left="",a.style.top="",C(null,null),A(null))},Y=()=>{q(),d=window.requestAnimationFrame(()=>{d=null,y=window.requestAnimationFrame(()=>{y=null,!a.matches(":hover")&&(o instanceof Element&&o.matches(":hover")||P())})})},W=s=>{s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation?.()};for(const s of[...Se,J]){const b=document.createElement("button");b.type="button",b.className=`atlas-downloader-reaction-btn ${s.className}`.trim(),b.setAttribute("aria-label",s.label),b.title=s.label,b.replaceChildren(Ae(s.pathDs)),$.set(s.type,b),b.addEventListener("pointerdown",W,!0),b.addEventListener("mousedown",W,!0),b.addEventListener("click",w=>{if(W(w),_)return;if(!o){t.showToast("No media selected.");return}const z=s.type===J.type?"dislike":s.type,N=et(o,z,e);if(!N){t.showToast("No valid media URL found.");return}const O=N.url||"",ee=(he=!1)=>{he?N.force_download=!0:"force_download"in N&&delete N.force_download,H(!0,s.type,O||null),x(!0,s.type),t.sendMessageSafe({type:"atlas-react",payload:{...N,...s.type===J.type?{blacklist:!0}:{}}},X=>{if(x(!1,null),!X||!X.ok){H(!1,null,O||null),t.showToast(X?.error||"Reaction failed.","danger");return}const me=X.data||null,be=me?.file||null,pe=me?.reaction?.type?String(me.reaction.type):s.type===J.type?"dislike":s.type;if(O&&e.atlasStatusCache.set(O,{exists:!!be,downloaded:!!be?.downloaded,blacklisted:!!be?.blacklisted_at,reactionType:pe,ts:Date.now()}),A(pe),v(pe,!!be?.downloaded),H(!1,pe,O||null),N.download_via==="yt-dlp"){t.showToast(`Reacted (${s.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${s.label}). Queued download in Atlas.`)})};e.fetchAtlasStatus(t.sendMessageSafe,O,N.referrer_url||null,he=>{if(z!=="dislike"&&he?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(X=>{if(X==="alternate"){t.showToast("Cancelled.");return}ee(X==="confirm")});return}ee(!1)})}),a.appendChild(b)}t.root.appendChild(a);const G=s=>(typeof s.composedPath=="function"?s.composedPath():[]).some(w=>w instanceof HTMLElement&&w.id===e.rootId),oe=()=>{if(!o)return;const s=o.getBoundingClientRect();if(!Number.isFinite(s.left)||s.width<=0||s.height<=0){j(),P(!0);return}const b=Ge(s.top+8,8,window.innerHeight-8),w=Ge(s.right-8,8,window.innerWidth-8);a.style.top=`${b}px`,a.style.left=`${w}px`},de=(s,b)=>Ze(s,b,e.rootId),ne=s=>{if(t.isSheetOpen()){P();return}U();const b=et(s,"like",e);if(!b){P();return}const w=b.url||null;if((o&&o!==s||h&&w&&h!==w)&&j(),o=s,h=w,C(b.width,b.height),a.classList.add("open"),oe(),A(null),v(null,null),h){const N=e.getCachedAtlasStatus(h);if(N)A(N.reactionType),v(N.reactionType,N.downloaded);else{const O=h;e.fetchAtlasStatus(t.sendMessageSafe,O,window.location.href,ee=>{ee&&h===O&&(A(ee.reactionType),v(ee.reactionType,ee.downloaded))})}}},we=s=>s?s==="blacklist"?"blacklist":s:null,Le=()=>{if(t.isSheetOpen())return;if(k>=0&&M>=0){const b=de(k,M);if(b&&!b.closest?.(`#${e.rootId}`)){q(),ne(b);return}}const s=Pt(o,e.rootId);s&&(q(),ne(s))},fe=()=>{I===null&&(I=window.requestAnimationFrame(()=>{I=null,Le()}))};document.addEventListener("pointerover",s=>{if(t.isSheetOpen()||!(s.target instanceof Element)||G(s))return;const b=de(s.clientX,s.clientY);b&&(q(),ne(b))},!0),window.addEventListener("atlas-shortcut-reaction-state",s=>{const b=s,w=b.detail?.media;if(!(w instanceof Element))return;q(),ne(w);const z=!!b.detail?.pending,N=we(b.detail?.reactionType??null);if(z){x(!0,N);return}if(x(!1,null),N){const O=N==="blacklist"?"dislike":N;A(O);const ee=h?e.getCachedAtlasStatus(h):null;v(O,ee?.downloaded??null)}},!0),document.addEventListener("pointermove",s=>{U(),k=s.clientX,M=s.clientY},!0),document.addEventListener("click",s=>{s instanceof MouseEvent&&(t.isSheetOpen()||G(s)||fe())},!0),document.addEventListener("pointerout",s=>{!o||t.isSheetOpen()||!(s.target instanceof Element)||G(s)||!(s.target.closest?.("img, video")??null)||Y()},!0),a.addEventListener("pointerenter",q,!0),a.addEventListener("pointerleave",Y,!0),window.addEventListener("scroll",oe,!0),window.addEventListener("resize",oe),window.addEventListener(Ke,U,!0),window.addEventListener("blur",P),window.addEventListener("focus",fe,!0),new MutationObserver(()=>{U(),fe()}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}function F(t){const e=t.indexOf("#");return e===-1?t:t.slice(0,e)}function nt(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e&&!e.startsWith("#")).map(e=>(e.startsWith("*.")?e.slice(2):e).toLowerCase()).map(e=>De(e)||e.replace(/^\.+/,"").trim()).filter(Boolean)}function at(t,e){const a=(t||"").toLowerCase();if(!a)return!1;for(const r of e)if(Be(a,r))return!0;return!1}function De(t){if(!t||typeof t!="string")return"";const e=t.trim();if(!e)return"";const a=/^https?:\/\//i.test(e)?e:`https://${e}`;try{return new URL(a).hostname}catch{return""}}function Be(t,e){return!t||!e?!1:t===e||t.endsWith(`.${e}`)}const rt="atlas-downloader-page-markers";function ot(t){return function(a,r="info"){const o=document.createElement("div");o.className=`atlas-downloader-toast${r==="danger"?" danger":""}`,o.textContent=a,t.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove(),{once:!0})},2600)}}function lt(t){return e=>new Promise(a=>{const r=document.createElement("div");r.className="atlas-downloader-dialog-backdrop";const o=document.createElement("div");o.className=`atlas-downloader-dialog${e.danger?" danger":""}`.trim(),o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.setAttribute("aria-label",e.title);const h=document.createElement("h3");h.className="atlas-downloader-dialog-title",h.textContent=e.title;const d=document.createElement("p");d.className="atlas-downloader-dialog-message",d.textContent=e.message;const y=document.createElement("div");y.className="atlas-downloader-dialog-actions";const _=k=>{r.remove(),a(k)};if(e.alternateLabel){const k=document.createElement("button");k.type="button",k.className="atlas-downloader-dialog-btn secondary",k.textContent=e.alternateLabel,k.addEventListener("click",()=>_("alternate")),y.appendChild(k)}const c=document.createElement("button");c.type="button",c.className="atlas-downloader-dialog-btn",c.textContent=e.cancelLabel||"Cancel",c.addEventListener("click",()=>_("cancel")),y.appendChild(c);const p=document.createElement("button");p.type="button",p.className=`atlas-downloader-dialog-btn primary${e.danger?" danger":""}`.trim(),p.textContent=e.confirmLabel,p.addEventListener("click",()=>_("confirm")),y.appendChild(p),o.appendChild(h),o.appendChild(d),o.appendChild(y),r.appendChild(o),t.appendChild(r),requestAnimationFrame(()=>{p.focus()})})}function Ut(){if(document.getElementById(rt))return;const t=document.createElement("style");t.id=rt,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 4px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 4px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 4px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 4px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 4px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: -4px !important;
}
`,(document.head||document.documentElement).appendChild(t)}(()=>{const a="atlas-downloader-root",r="atlas-open",o=(()=>{try{return window.top===window.self}catch{return!1}})(),h=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let d=null,y=null;const _=3e4,c=new Map;function p(C,L){const x=typeof C=="string"?C:"";return x.length<=L?x:x.slice(0,L)}function k(C){return yt(C)||"Extension"}function M(C){const L=c.get(C);return L?Date.now()-L.ts>_?(c.delete(C),null):L:null}function I(C,L,x,A){const v=F((L||"").trim());if(!v){A(null);return}const H=M(v);if(H){A(H);return}C({type:"atlas-check-batch",urls:[v]},j=>{if(!j||!j.ok){A(null);return}const U=Array.isArray(j.data?.results)?j.data.results:[],P=new Map(U.filter(W=>typeof W?.url=="string"&&W.url.trim()!=="").map(W=>[F(String(W.url)),W])).get(v)??null;if(!P){A(null);return}const Y={exists:!!P.exists,downloaded:!!P.downloaded,blacklisted:!!P.blacklisted,reactionType:P.reaction?.type?String(P.reaction.type):null,ts:Date.now()};c.set(v,Y),A(Y)})}chrome.runtime.onMessage.addListener(C=>{if(!C||typeof C!="object")return;const L=C;if(L.type==="atlas-download-event"){y?.(L.payload);return}if(L.type==="atlas-open-sheet"&&o)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],x=>{Pe(x.atlasMediaNoiseFilters||"");const A=De(x.atlasBaseUrl||"");if(A&&Be(window.location.hostname,A))return;const v=nt(x.atlasExcludedDomains||"");at(window.location.hostname,v)||($(),d?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],C=>{Pe(C.atlasMediaNoiseFilters||"");const L=De(C.atlasBaseUrl||"");if(L&&Be(window.location.hostname,L))return;const x=nt(C.atlasExcludedDomains||"");at(window.location.hostname,x)||(o?$():re())});function re(){if(document.getElementById(a))return;const C=document.createElement("div");C.id=a;const L=C.attachShadow({mode:"closed"}),x=document.createElement("link");x.rel="stylesheet",x.href=chrome.runtime.getURL("dist/content.css"),L.appendChild(x);const A=document.createElement("div");A.className="atlas-shadow-root";const v=ot(A),H=lt(A),j=(U,q)=>{try{chrome.runtime.sendMessage(U,q)}catch(P){(()=>{if(P instanceof Error)return P.message;if(P&&typeof P=="object"&&"message"in P){const W=P.message;return typeof W=="string"?W:String(W)}return String(P)})().includes("Extension context invalidated")?v("Atlas extension was reloaded. Refresh this tab.","danger"):v("Atlas extension error. Refresh this tab.","danger"),q(null)}};L.appendChild(A),(document.body||document.documentElement).appendChild(C),Ye({showToast:v,sendMessageSafe:j,isSheetOpen:()=>!1,chooseDialog:H},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:k,fetchAtlasStatus:I,atlasStatusCache:c,getCachedAtlasStatus:M}),tt({root:A,showToast:v,sendMessageSafe:j,isSheetOpen:()=>!1,chooseDialog:H},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:k,fetchAtlasStatus:I,atlasStatusCache:c,getCachedAtlasStatus:M})}function $(){if(document.getElementById(a))return;const C=document.createElement("div");C.id=a;const L=C.attachShadow({mode:"closed"}),x=document.createElement("link");x.rel="stylesheet",x.href=chrome.runtime.getURL("dist/content.css"),L.appendChild(x);const A=document.createElement("div");A.className="atlas-shadow-root";const v=ot(A),H=(n,i)=>{try{chrome.runtime.sendMessage(n,i)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const m=l.message;return typeof m=="string"?m:String(m)}return String(l)})().includes("Extension context invalidated")?v("Atlas extension was reloaded. Refresh this tab.","danger"):v("Atlas extension error. Refresh this tab.","danger"),i(null)}},j=document.createElement("div");j.className="atlas-downloader-overlay";const U=document.createElement("div");U.className="atlas-downloader-modal",U.setAttribute("role","dialog"),U.setAttribute("aria-modal","true"),U.setAttribute("aria-label","Atlas Media Picker");const q=document.createElement("div");q.className="atlas-downloader-header";const P=document.createElement("div");P.className="atlas-downloader-title",P.textContent="Atlas Media Picker";const Y=document.createElement("div");Y.className="atlas-downloader-version",Y.textContent=h?`v${h}`:"";const W=document.createElement("button");W.type="button",W.className="atlas-downloader-close",W.setAttribute("aria-label","Close"),W.textContent="x",q.appendChild(P),q.appendChild(Y),q.appendChild(W);const G=document.createElement("div");G.className="atlas-downloader-toolbar";const oe=ve("Rescan",()=>it()),de=ve("Check Atlas",()=>mt(!1)),ne=ve("Select all",()=>st(!0)),we=ve("Select none",()=>st(!1)),Le=document.createElement("span");Le.className="spacer";const fe=ve("Queue selected",()=>Xt(),{primary:!0});G.appendChild(oe),G.appendChild(de),G.appendChild(ne),G.appendChild(we),G.appendChild(Le),G.appendChild(fe);const ge=document.createElement("div");ge.className="atlas-downloader-meta";const s=document.createElement("div");s.className="atlas-downloader-list",U.appendChild(q),U.appendChild(G),U.appendChild(ge),U.appendChild(s),A.appendChild(j),A.appendChild(U),L.appendChild(A),(document.body||document.documentElement).appendChild(C);const b=lt(A);let w=[],z=0,N=null,O=null,ee=null,he=null;const X=new Set,me=new Map,be=!0;let pe=!1;y=n=>{if(!n||typeof n!="object")return;const i=n,l=Number.isFinite(Number(i.transferId))?Number(i.transferId):null,u=typeof i.status=="string"?i.status:"",m=!!i.downloaded||u==="completed"||typeof i.finished_at=="string",g=!!i.failed||u==="failed"||u==="canceled"||typeof i.failed_at=="string",E=new Set,f=typeof i.original=="string"?F(i.original.trim()):"",S=typeof i.referrer_url=="string"?F(i.referrer_url.trim()):"";f&&E.add(f),S&&E.add(S);const T=l?me.get(l)??"":"";if(T&&E.add(T),E.size===0)return;const Q=f||T||S||"";l&&Q&&!m&&!g&&me.set(l,Q);let te=!1;for(const B of E){const ie=M(B);c.set(B,{exists:!0,downloaded:m,blacklisted:ie?!!ie.blacklisted:!1,reactionType:ie?.reactionType??null,ts:Date.now()})}for(const B of w){const ie=le(B)||F(String(B.url||""));!ie||!E.has(ie)||!X.has(ie)&&B.status!=="Queued"||(B.atlas={exists:!0,downloaded:m,blacklisted:B.atlas?.blacklisted??!1,file_id:B.atlas?.file_id??null,reaction:B.atlas?.reaction??null},m?(B.status="",B.statusClass="",B.reactionQueued=null,X.delete(ie)):g?(B.status="Failed",B.statusClass="err",B.reactionQueued=null,X.delete(ie)):(B.status="Queued",B.statusClass="queued"),te=!0)}l&&(m||g)&&me.delete(l),te&&(Z(),V(K()),ce(w))},j.addEventListener("click",()=>ke()),W.addEventListener("click",()=>ke()),document.addEventListener("keydown",n=>{if(n.key==="Escape"&&A.classList.contains(r)){ke();return}if(!A.classList.contains(r))return;const i=n.key==="1"?"love":n.key==="2"?"like":n.key==="3"?"funny":null;if(!i)return;const l=w.find(u=>u.selected)??w[0]??null;l&&(n.preventDefault(),Re(l,i,{closeOnSuccess:!0}))});function $t(){A.classList.add(r),it()}function Wt(){if(A.classList.contains(r)){ke();return}$t()}function ke(){A.classList.remove(r)}d=Wt,Ye({showToast:v,sendMessageSafe:H,isSheetOpen:()=>A.classList.contains(r),chooseDialog:b,setHintShown:n=>{pe=n},getHintShown:()=>pe,enabled:be},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:k,fetchAtlasStatus:I,atlasStatusCache:c,getCachedAtlasStatus:M}),tt({root:A,showToast:v,sendMessageSafe:H,isSheetOpen:()=>A.classList.contains(r),chooseDialog:b},{rootId:a,minSize:200,maxMetadataLen:500,limitString:p,sourceFromMediaUrl:k,fetchAtlasStatus:I,atlasStatusCache:c,getCachedAtlasStatus:M}),window.addEventListener("atlas-shortcut-reaction-state",n=>{const i=n,l=!!i.detail?.pending,u=i.detail?.reactionType?String(i.detail.reactionType):null,g=(typeof i.detail?.url=="string"?i.detail.url:"")||i.detail?.media&&ye(i.detail.media,200)?.url||"",E=g?F(g):"";if(l){N=E||"__external-reaction__",O=u||O||"like";for(const f of w)E&&(le(f)||F(String(f.url||"")))!==E||(f.reactionPending=u||f.reactionPending||"like");Z(),V(K());return}N=null,O=null;for(const f of w){if(E&&(le(f)||F(String(f.url||"")))!==E)continue;f.reactionPending&&(f.reactionPending=null);const S=(E?M(E):null)??M(le(f))??M(F(String(f.url||"")));S?f.atlas={exists:!!S.exists,downloaded:!!S.downloaded,blacklisted:!!S.blacklisted,file_id:f.atlas?.file_id??null,reaction:S.reactionType?{type:S.reactionType}:f.atlas?.reaction??null}:u&&(f.atlas={exists:f.atlas?.exists??!0,downloaded:f.atlas?.downloaded??!1,blacklisted:f.atlas?.blacklisted??!1,file_id:f.atlas?.file_id??null,reaction:{type:u}}),f.atlas?.exists&&!f.atlas?.downloaded&&f.atlas?.reaction?.type&&f.atlas.reaction.type!=="dislike"?f.reactionQueued=f.atlas.reaction.type:f.reactionQueued=null}Z(),V(K()),ce(w)},!0);const Ce=(n=300)=>{he!==null&&window.clearTimeout(he),he=window.setTimeout(()=>{he=null,Jt()},n)};new MutationObserver(()=>{ce(w),Ce(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>Ce(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&Ce(120)},!0),Ce(120);function ve(n,i,l){const u=document.createElement("button");return u.type="button",u.className=`atlas-downloader-btn${l?.primary?" primary":""}`,u.textContent=n,u.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),i()}),u}function Ot(n){ge.textContent=n,fe.disabled=!0,oe.disabled=!0,de.disabled=!0,ne.disabled=!0,we.disabled=!0}function V(n){ge.textContent=n;const i=w.filter(u=>u.selected).length,l=w.some(u=>!!u.reactionPending)||N!==null;fe.disabled=i===0||l,oe.disabled=l,de.disabled=w.length===0||l,ne.disabled=w.length===0||l,we.disabled=w.length===0||l}function it(){z+=1;const n=z;w=[],ee=null,s.replaceChildren(),Ot("Scanning this page…"),D(i=>{z===n&&(ge.textContent=`Scanning… ${i.scanned}/${i.total}`)}).then(i=>{z===n&&(w=i.map(l=>({...l,selected:!0,status:"",statusClass:"",atlas:null,reactionPending:N&&N!=="__external-reaction__"&&(le(l)||F(String(l.url||"")))===N?O||"like":null,reactionQueued:null})),Z(),V(K()),mt(!0))})}function st(n){for(const i of w)i.selected=n;Z(),V(K())}function Z(){if(s.replaceChildren(),w.length===0){const n=document.createElement("div");n.style.padding="10px 12px",n.style.color="#94a3b8",n.style.fontSize="12px",n.textContent="No matching images/videos found.",s.appendChild(n);return}for(const n of w)s.appendChild(Ft(n))}function Ft(n){const i=document.createElement("div");i.className=`atlas-downloader-item${n.selected?" selected":""}`;const l=document.createElement("input");l.type="checkbox",l.checked=n.selected,l.addEventListener("change",()=>{n.selected=l.checked,i.classList.toggle("selected",n.selected),V(K())});const u=document.createElement("div");if(u.className="atlas-downloader-preview",n.preview_url){const R=document.createElement("img");R.loading="lazy",R.alt="",R.src=n.preview_url,u.appendChild(R)}const m=document.createElement("div");m.className="atlas-downloader-info";const g=document.createElement("div");g.className="atlas-downloader-kind",g.textContent=n.tag_name;const E=document.createElement("div");E.className="atlas-downloader-url",E.textContent=n.url,E.title=n.url;const f=document.createElement("div");f.className="atlas-downloader-sub",f.textContent=Qt(n);const S=document.createElement("div");S.className="atlas-downloader-reactions";const T=n.atlas?.reaction?.type||null,Q=!!n.reactionPending||!!n.reactionQueued;for(const R of Se){const se=document.createElement("button");se.type="button",se.className=`atlas-downloader-reaction-btn ${R.className}${T===R.type?" active":""}${n.reactionPending===R.type?" pending":""}${n.reactionQueued===R.type?" queued":""}`.trim(),se.setAttribute("aria-label",R.label),se.title=R.label,se.replaceChildren(Ae(R.pathDs)),se.disabled=Q,se.addEventListener("click",wt=>{wt.preventDefault(),wt.stopPropagation(),Re(n,R.type)}),S.appendChild(se)}const te=document.createElement("button");if(te.type="button",te.className=`atlas-downloader-reaction-btn ${J.className}${n.atlas?.blacklisted?" active":""}${n.reactionPending===J.type?" pending":""}${n.reactionQueued===J.type?" queued":""}`.trim(),te.setAttribute("aria-label",J.label),te.title=J.label,te.replaceChildren(Ae(J.pathDs)),te.disabled=Q,te.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),Re(n,"dislike",{blacklist:!0})}),S.appendChild(te),n.atlas?.downloaded){const R=document.createElement("button");R.type="button",R.className=`atlas-downloader-reaction-btn delete${n.reactionPending==="delete-download"?" pending":""}`.trim(),R.setAttribute("aria-label","Delete download"),R.title="Delete download",R.replaceChildren(Ae(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),R.disabled=Q,R.addEventListener("click",se=>{se.preventDefault(),se.stopPropagation(),Kt(n)}),S.appendChild(R)}const B=document.createElement("button");B.type="button",B.className=`atlas-downloader-debug-toggle${ee===n.url?" active":""}`,B.textContent=ee===n.url?"Hide debug":"Debug",B.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),ee=ee===n.url?null:n.url,Z(),V(K())}),S.appendChild(B),m.appendChild(g),m.appendChild(E),m.appendChild(f),m.appendChild(S),ee===n.url&&m.appendChild(jt(n));const ie=document.createElement("div"),pt=Vt(n);return ie.className=`atlas-downloader-status ${pt.className}`.trim(),ie.textContent=pt.text,i.addEventListener("click",R=>{R.target instanceof HTMLInputElement||(n.selected=!n.selected,l.checked=n.selected,i.classList.toggle("selected",n.selected),V(K()))}),i.appendChild(l),i.appendChild(u),i.appendChild(m),i.appendChild(ie),i}function dt(n,i){return{type:i,url:n.url,referrer_url:n.referrer_url||window.location.href,page_title:p(document.title,500),tag_name:n.tag_name,width:n.width,height:n.height,alt:p(n.alt||"",500),preview_url:n.preview_url||"",source:k(n.url),...n.download_via?{download_via:n.download_via}:{}}}function ct(n){return{url:n.url,referrer_url:n.referrer_url||window.location.href,page_title:p(document.title,500),tag_name:n.tag_name,width:n.width,height:n.height,alt:p(n.alt||"",500),preview_url:n.preview_url||"",source:k(n.url),...n.download_via?{download_via:n.download_via}:{},reaction_type:"like"}}function jt(n){const i=document.createElement("details");i.className="atlas-downloader-debug",i.open=!0;const l=document.createElement("summary");l.textContent="Debug payload",i.appendChild(l);const u={react:dt(n,n.atlas?.reaction?.type||"like"),download:ct(n)};return i.appendChild(qt(u)),i}function qt(n,i=0){const l=document.createElement("div");l.className="atlas-downloader-json-tree";const u=xe(n);if(!ft(u)){const g=document.createElement("div");return g.className="atlas-downloader-json-line",g.textContent=ht(u),l.appendChild(g),l}const m=Array.isArray(u)?u.map((g,E)=>[String(E),g]):Object.entries(u);for(const[g,E]of m)l.appendChild(ut(g,E,i));return l}function ut(n,i,l){const u=xe(i),m=document.createElement("div");if(m.className="atlas-downloader-json-line",m.style.paddingLeft=`${l*12}px`,!ft(u))return m.innerHTML=`<span class="atlas-downloader-json-key">${Me(n)}</span>: <span class="atlas-downloader-json-value">${Me(ht(u))}</span>`,m;const g=document.createElement("details");g.className="atlas-downloader-json-node",g.open=l===0;const E=document.createElement("summary");E.style.paddingLeft=`${l*12}px`;const f=Array.isArray(u)?`[${u.length}]`:`{${Object.keys(u).length}}`;E.innerHTML=`<span class="atlas-downloader-json-key">${Me(n)}</span>: <span class="atlas-downloader-json-preview">${Me(f)}</span>`,g.appendChild(E);const S=Array.isArray(u)?u.map((T,Q)=>[String(Q),T]):Object.entries(u);for(const[T,Q]of S)g.appendChild(ut(T,Q,l+1));return g}function xe(n){if(n===void 0)return null;if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return n;if(Array.isArray(n))return n.map(l=>xe(l));if(!n||typeof n!="object")return null;const i={};for(const[l,u]of Object.entries(n))i[l]=xe(u);return i}function ft(n){return Array.isArray(n)||n&&typeof n=="object"}function ht(n){return JSON.stringify(n)}function Me(n){return String(n).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Qt(n){const i=n.width&&n.height?`${n.width}×${n.height}`:"size unknown",l=zt(n.url);return l?`${i} • ${l}`:i}function zt(n){try{return new URL(n).hostname}catch{return""}}function K(){const n=w.filter(i=>i.selected).length;return`${w.length} found • ${n} selected`}function le(n){const i=(n?.url||n?.referrer_url||"").trim();return i?F(i):""}function Vt(n){return n.status?{text:n.status,className:n.statusClass||""}:n.atlas?.downloaded?{text:"Downloaded",className:"ok"}:n.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:n.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function mt(n){const i=[...new Set(w.map(l=>le(l)).filter(Boolean))];i.length!==0&&H({type:"atlas-check-batch",urls:i},l=>{if(!l){n||v("Atlas extension did not respond.","danger");return}if(!l.ok){n||v(l.error||"Atlas check failed.","danger");return}const u=Array.isArray(l.data?.results)?l.data.results:[],m=new Map(u.filter(f=>typeof f?.url=="string"&&f.url.trim()!=="").map(f=>[F(String(f.url)),f]));let g=0,E=0;for(const f of w){const S=le(f),T=m.get(S);T&&(f.atlas={exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,file_id:T.file_id??null,reaction:T.reaction??null},f.atlas.exists&&!f.atlas.downloaded&&f.atlas.reaction?.type&&f.atlas.reaction.type!=="dislike"?(f.reactionQueued=f.atlas.reaction.type,X.add(S)):(f.reactionQueued=null,X.delete(S)),c.set(S,{exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,reactionType:T.reaction?.type?String(T.reaction.type):null,ts:Date.now()}),T.exists&&(g+=1),T.downloaded&&(E+=1))}Z(),V(K()),ce(w),n||v(`Atlas check: ${E}/${g} downloaded.`)})}function Re(n,i,l={}){const u=(g={})=>{n.reactionPending=l.blacklist?J.type:i,n.status="Reacting…",n.statusClass="",N=le(n)||n.url,O=n.reactionPending,Z(),V(K());const E={...dt(n,i),...g,...l.blacklist?{blacklist:!0}:{}};H({type:"atlas-react",payload:E},f=>{if(n.reactionPending=null,N=null,O=null,!f){n.status="No response",n.statusClass="err",Z(),V(K()),v("Atlas extension did not respond.","danger");return}if(!f.ok){n.status=f.error||"Failed",n.statusClass="err",Z(),V(K()),v(f.error||"Reaction failed.","danger");return}const S=f.data||null,T=S?.file||null;n.atlas={exists:!!T,downloaded:!!T?.downloaded,blacklisted:!!T?.blacklisted_at,file_id:T?.id??null,reaction:S?.reaction??null};const Q=le(n)||n.url;c.set(Q,{exists:n.atlas.exists,downloaded:n.atlas.downloaded,blacklisted:n.atlas.blacklisted,reactionType:n.atlas.reaction?.type?String(n.atlas.reaction.type):null,ts:Date.now()}),n.atlas.exists&&!n.atlas.downloaded&&i!=="dislike"?(n.status="Queued",n.statusClass="queued",n.reactionQueued=l.blacklist?J.type:i,Q&&X.add(Q)):(n.status="",n.statusClass="",n.reactionQueued=null,Q&&X.delete(Q)),Z(),V(K()),ce(w),l.closeOnSuccess&&ke()})},m=!!n.atlas?.reaction?.type;if(i!=="dislike"&&n.atlas?.downloaded&&m){b({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(g=>{if(g==="alternate"){v("Cancelled.");return}u(g==="confirm"?{force_download:!0}:{})});return}if(i==="dislike"&&n.atlas?.downloaded){b({title:l.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(g=>{if(g==="alternate"){v("Cancelled.");return}u(g==="confirm"?{clear_download:!0}:{})});return}u()}function Kt(n){b({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(i=>{i==="confirm"&&(n.reactionPending="delete-download",n.status="Deleting…",n.statusClass="",N=le(n)||n.url,O=n.reactionPending,Z(),V(K()),H({type:"atlas-delete-download",payload:{url:n.url,tag_name:n.tag_name,download_via:n.download_via||null}},l=>{if(n.reactionPending=null,N=null,O=null,!l||!l.ok){n.status=l?.error||"Failed",n.statusClass="err",Z(),V(K()),v(l?.error||"Delete failed.","danger");return}const u=l.data?.file||null;n.atlas={exists:!!u,downloaded:!!u?.downloaded,blacklisted:!!u?.blacklisted_at,file_id:u?.id??null,reaction:null},n.reactionQueued=null;const m=le(n)||n.url;c.set(m,{exists:n.atlas.exists,downloaded:n.atlas.downloaded,blacklisted:n.atlas.blacklisted,reactionType:null,ts:Date.now()}),n.status="",n.statusClass="",Z(),V(K()),ce(w),v("Download deleted.")}))})}function Xt(){const n=w.filter(u=>u.selected);if(n.length===0){v("Select one or more items first.");return}if(n.some(u=>!!u.atlas?.downloaded)){b({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(u=>{if(u==="alternate"){v("Cancelled.");return}l(u==="confirm")});return}l(!1);function l(u){fe.disabled=!0,oe.disabled=!0,de.disabled=!0,ne.disabled=!0,we.disabled=!0;for(const g of n)g.status="Sending…",g.statusClass="";Z();const m=n.map(g=>{const E=ct(g);return u&&(E.force_download=!0),E});H({type:"atlas-download-batch",payloads:m},g=>{if(!g){for(const f of n)f.status="No response",f.statusClass="err";Z(),V(K()),v("Atlas extension did not respond.","danger");return}const E=Array.isArray(g.results)?g.results:[];for(let f=0;f<n.length;f+=1){const S=n[f],T=E[f];if(T?.ok){const Q=T.data||null,te=Q?.file||null;if(S.atlas={exists:!!te,downloaded:!!te?.downloaded,blacklisted:!!te?.blacklisted_at,file_id:te?.id??null,reaction:S.atlas?.reaction??null},Q?.queued){S.status="Queued",S.statusClass="queued",S.atlas?.reaction?.type&&S.atlas.reaction.type!=="dislike"&&(S.reactionQueued=S.atlas.reaction.type);const B=le(S)||F(String(S.url||""));B&&X.add(B)}else{S.status="",S.statusClass="",S.reactionQueued=null;const B=le(S)||F(String(S.url||""));B&&X.delete(B)}}else S.status=T?.error||"Failed",S.statusClass="err"}Z(),V(K()),ce(w),g.ok?v(`Queued ${n.length} download(s) in Atlas.`):v(g.error||"Some requests failed.","danger")})}}function ce(n=w){Ut();const i=document.querySelectorAll('[data-atlas-marked="1"]');for(const m of i)m.removeAttribute("data-atlas-marked"),m.removeAttribute("data-atlas-state"),m.removeAttribute("data-atlas-reaction");const l=new Map;for(const[m,g]of c.entries()){if(Date.now()-g.ts>_){c.delete(m);continue}l.set(m,{exists:!!g.exists,downloaded:!!g.downloaded,blacklisted:!!g.blacklisted,reactionType:g.reactionType?String(g.reactionType):null}),l.set(F(m),{exists:!!g.exists,downloaded:!!g.downloaded,blacklisted:!!g.blacklisted,reactionType:g.reactionType?String(g.reactionType):null})}for(const m of n){if(!m?.url||!m?.atlas)continue;const g=m.atlas?.reaction?.type?String(m.atlas.reaction.type):null,E={exists:!!m.atlas.exists,downloaded:!!m.atlas.downloaded,blacklisted:!!m.atlas.blacklisted,reactionType:g};l.set(m.url,E),l.set(F(m.url),E)}if(l.size===0)return;const u=document.querySelectorAll("img, video, a[href]");for(const m of u){const g=$e(m);if(g.length===0)continue;const E=g.map(f=>l.get(f)||l.get(F(f))).find(f=>!!(f&&(f.exists||f.downloaded||f.blacklisted||f.reactionType)))??null;E&&(m.setAttribute("data-atlas-marked","1"),E.blacklisted?m.setAttribute("data-atlas-state","blacklisted"):E.reactionType?m.setAttribute("data-atlas-state","reacted"):E.downloaded?m.setAttribute("data-atlas-state","downloaded"):E.exists&&m.setAttribute("data-atlas-state","exists"),E.reactionType&&m.setAttribute("data-atlas-reaction",E.reactionType))}}function Zt(){const n=new Set,i=document.querySelectorAll("img, video, a[href]");for(const u of i)for(const m of $e(u))n.add(m),n.add(F(m));const l=Ue();return l?.url&&(n.add(l.url),n.add(F(l.url))),[...n].filter(Boolean)}function Jt(){const n=Zt();if(n.length===0){ce(w);return}H({type:"atlas-check-batch",urls:n},i=>{if(!i?.ok){ce(w);return}const l=Array.isArray(i.data?.results)?i.data.results:[];for(const u of l)u?.url&&c.set(String(u.url),{exists:!!u.exists,downloaded:!!u.downloaded,blacklisted:!!u.blacklisted,reactionType:u.reaction?.type?String(u.reaction.type):null,ts:Date.now()});ce(w)})}}function D(C){return new Promise(L=>{const x=document.body||document.documentElement,A=Array.from(x.querySelectorAll("img, video")),v=A.length,H=new Set,j=[];let U=0;const q=Y=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(Y,{timeout:500});return}setTimeout(()=>Y({timeRemaining:()=>25}),0)},P=Y=>{const W=typeof Y?.timeRemaining=="function"?Y.timeRemaining():25;let G=0;for(;U<v&&(G<80||W>5);){const de=A[U];if(de.closest&&de.closest(`#${a}`)){U+=1,G+=1;continue}const ne=ye(de,200);ne?.url&&!H.has(ne.url)&&(H.add(ne.url),j.push(ne)),U+=1,G+=1}if(C?.({scanned:U,total:v}),U<v){q(P);return}const oe=Ue();oe&&!H.has(oe.url)&&(H.add(oe.url),j.push(oe)),L(j)};q(P)})}})()})();
