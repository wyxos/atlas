(function(){"use strict";const ht=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function pt(t){const n=(t||"").trim().toLowerCase();if(!n)return"";const a=n.split(".").filter(Boolean);if(a.length<=2)return n;const r=a.slice(-2).join("."),o=a.slice(-3).join(".");return ht.has(r)&&a.length>=3?o:r}function wt(t){const n=(t||"").trim();if(!n)return"";try{const a=new URL(n).hostname;return pt(a)}catch{return""}}function gt(t,n){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const r=a.toLowerCase();if(r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:"))return"";try{const o=new URL(a,n);return o.protocol!=="http:"&&o.protocol!=="https:"?"":o.toString()}catch{return""}}const bt=je(["host:st.deviantart.net","url:*wixmp.com*/crop/w_92,h_92*","url:*wixmp.com*/crop/w_150,h_150*","url:*wixmp.com*/fit/w_150,h_150*"].join(`
`));let Be=[];function se(t){return gt(t,window.location.href)}function Ie(t){Be=je(t)}function Pe(t){const n=se(t.currentSrc)||se(t.src)||se(t.getAttribute("src")||"");if(n)return n;const a=t.querySelector("source[src]"),r=a?se(a.src||a.getAttribute("src")||""):"";if(r)return r;const o=vt(t);return o||kt()}function be(t,n){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,r=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),o=se(r);if(o&&xe(o))return null;const{width:g,height:y}=Lt(a,o||r),D=g??pe(a.clientWidth),w=y??pe(a.clientHeight);if(D&&D<n||w&&w<n)return null;if(!o){const x=se(document.referrer)||se(window.location.href)||"";return!x||!r.toLowerCase().startsWith("blob:")&&!r.toLowerCase().startsWith("data:")||xe(x)?null:{tag_name:"img",url:x,referrer_url:window.location.href,preview_url:"",width:g,height:y,alt:a.alt||""}}return{tag_name:"img",url:o,referrer_url:window.location.href,preview_url:o,width:g,height:y,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=t,r=a.videoWidth||a.clientWidth||null,o=a.videoHeight||a.clientHeight||null;if(r&&o&&(r<n||o<n))return null;const g=Pe(a);if(g&&xe(g))return null;if(!g){const y=(a.currentSrc||a.src||"").trim().toLowerCase();if(y.startsWith("blob:")||y.startsWith("data:")){const D=window.location.href;return{tag_name:"video",url:D,referrer_url:D,preview_url:a.poster||"",width:r,height:o,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:g,referrer_url:window.location.href,preview_url:a.poster||"",width:r,height:o,alt:""}}return null}function Ue(){const t=(window.location.href||"").trim();if(!t)return null;const n=t.toLowerCase(),a=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(n),r=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!a&&!r)return null;if(n.startsWith("http://")||n.startsWith("https://"))return{tag_name:n.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(n.startsWith("blob:")||n.startsWith("data:")){const o=se(document.referrer)||"";return o?{tag_name:"img",url:o,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function $e(t){const n=new Set,a=se(window.location.href),r=t instanceof HTMLImageElement?se(t.currentSrc)||se(t.src)||"":t instanceof HTMLVideoElement?Pe(t)||"":t instanceof HTMLAnchorElement&&He(t.getAttribute("href")||"")||"";r&&n.add(r);const o=t.closest("a[href]")?.getAttribute("href")??"",g=He(o);return g&&n.add(g),a&&yt(t)&&n.add(a),[...n]}function He(t){const n=(t||"").trim();return!n||n.startsWith("#")||n.toLowerCase().startsWith("javascript:")?"":se(n)}function yt(t){if(t instanceof HTMLImageElement){const n=(t.currentSrc||t.src||t.getAttribute("src")||"").trim().toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")}if(t instanceof HTMLVideoElement){const n=(t.currentSrc||t.src||"").trim().toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")}return!1}function kt(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const n of t){const r=document.querySelector(n)?.getAttribute("content")||"",o=se(r);if(o)return o}return""}function vt(t){let n=t,a=0;for(;n&&a<8;){const r=n.getAttribute?.("data-store");if(r){const o=Et(r),g=Ce(o,0);if(g)return g}n=n.parentElement,a+=1}return""}function Et(t){if(!t)return null;const n=_t(t);try{return JSON.parse(n)}catch{return null}}function _t(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Ce(t,n){if(!t||n>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const a of t){const r=Ce(a,n+1);if(r)return r}return""}if(typeof t=="object")for(const a of Object.keys(t)){const r=t[a],o=Ce(r,n+1);if(o)return o}return""}function Lt(t,n){const a=pe(t.naturalWidth),r=pe(t.naturalHeight),o=At(n),g=We(t.getAttribute("width")),y=We(t.getAttribute("height")),D=St(a,r,o.width,o.height);return{width:Fe(a,o.width,g,D),height:Fe(r,o.height,y,D)}}function At(t){const n=(t||"").trim();if(!n)return{width:null,height:null};const a=Oe(n,[/(?:^|[/,?&_=-])w_(\d{2,5})(?=$|[/,?&_=-])/i]),r=Oe(n,[/(?:^|[/,?&_=-])h_(\d{2,5})(?=$|[/,?&_=-])/i]);let o=a;const g=r,y=n.match(/-(\d{2,5})w-(\d)x(?=$|[./?&_-])/i);if(y){const D=parseInt(y[1],10),w=parseInt(y[2],10),x=pe(D*w);x&&(!o||x>o)&&(o=x)}return{width:o??null,height:g??null}}function Oe(t,n){for(const a of n){const r=t.match(a);if(!r||!r[1])continue;const o=pe(parseInt(r[1],10));if(o)return o}return null}function We(t){if(!t)return null;const n=t.trim();if(!n)return null;const a=n.match(/^\d+/)?.[0]??"";return a?pe(parseInt(a,10)):null}function St(t,n,a,r){if(!t||!n||!a||!r||a<=t||r<=n)return!1;const o=a/t,g=r/n,y=Math.abs(o-g);return t<=480&&n<=800&&a>=600&&r>=900&&o>=1.8&&g>=1.8&&y<=.2}function Fe(t,n,a,r){return r&&n?n:t||n||a}function pe(t){if(typeof t!="number"||!Number.isFinite(t))return null;const n=Math.round(t);return n>0?n:null}function xe(t){const n=(t||"").trim().toLowerCase();if(!n)return!1;const a=[...bt,...Be],r=Ct(n);for(const o of a){if(o.kind==="host"){if(xt(r,o.host))return!0;continue}if(o.kind==="urlPattern"){if(o.regex.test(n))return!0;continue}if(n.includes(o.needle))return!0}return!1}function Ct(t){try{return new URL(t).hostname.toLowerCase()}catch{return""}}function xt(t,n){const a=(t||"").trim().toLowerCase(),r=(n||"").trim().toLowerCase();return!a||!r?!1:a===r||a.endsWith(`.${r}`)}function je(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n!==""&&!n.startsWith("#")).map(n=>Tt(n)).filter(n=>n!==null)}function Tt(t){const n=t.trim();if(!n)return null;const a=n.toLowerCase();if(a.startsWith("host:")){const o=qe(n.slice(5));return o?{kind:"host",host:o}:null}if(a.startsWith("url:"))return Qe(n.slice(4));const r=qe(n);return r?{kind:"host",host:r}:Qe(n)}function Qe(t){const n=t.trim().toLowerCase();if(!n)return null;if(!n.includes("*"))return{kind:"urlContains",needle:n};const a=Mt(n);try{return{kind:"urlPattern",regex:new RegExp(a,"i")}}catch{return null}}function Mt(t){return t.split("*").map(n=>Nt(n)).join(".*")}function Nt(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function qe(t){const n=(t||"").trim();if(!n)return"";const a=n.startsWith("*.")?n.slice(2):n,r=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(r).hostname.toLowerCase()}catch{return""}}const ze="http://www.w3.org/2000/svg",Ee=t=>{const n=document.createElementNS(ze,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const a of t){const r=document.createElementNS(ze,"path");r.setAttribute("d",a),r.setAttribute("fill","none"),r.setAttribute("stroke","currentColor"),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round"),n.appendChild(r)}return n},_e=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],ee={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Ke="atlas-location-change";function Ve(t,n){const a=t.enabled??!0,r=t.getHintShown??(()=>!1),o=t.setHintShown??(()=>{}),g=()=>{r()||(o(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},y=(w,x,f,E=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:w,pending:x,reactionType:f,url:E}}))},D=w=>(typeof w.composedPath=="function"?w.composedPath():[]).some(f=>f instanceof HTMLElement&&f.id===n.rootId);document.addEventListener("click",w=>{!a||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||D(w)||!((w.target instanceof Element?w.target:null)?.closest?.("img, video")??null)||(w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation())},!0),document.addEventListener("mousedown",w=>{if(!a||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||D(w))return;const f=(w.target instanceof Element?w.target:null)?.closest?.("img, video")??null;if(!f)return;const E=w.button===0?"like":w.button===1?"love":null;if(!E)return;g(),w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation();const P=be(f,n.minSize);if(!P){if(f instanceof HTMLVideoElement){const ae=(f.currentSrc||f.src||"").trim().toLowerCase();if(ae.startsWith("blob:")||ae.startsWith("data:")){const W=window.location.href,M={type:E,url:W,referrer_url:W,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:"video",width:f.videoWidth||f.clientWidth||null,height:f.videoHeight||f.clientHeight||null,alt:"",preview_url:f.poster||"",source:n.sourceFromMediaUrl(W),download_via:"yt-dlp"};n.fetchAtlasStatus(t.sendMessageSafe,M.url,M.referrer_url||null,A=>{if(A?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(L=>{if(L==="alternate"){t.showToast("Cancelled.");return}y(f,!0,E,M.url),L==="confirm"&&(M.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:M},C=>{if(!C||!C.ok){y(f,!1,null,M.url),t.showToast(C?.error||"Reaction failed.","danger");return}const k=C.data||null,v=k?.file||null,$=k?.reaction?.type?String(k.reaction.type):E;n.atlasStatusCache.set(M.url,{exists:!!v,downloaded:!!v?.downloaded,blacklisted:!!v?.blacklisted_at,reactionType:$,ts:Date.now()}),y(f,!1,$,M.url),t.showToast(`Reacted (${E}). Resolving video in Atlas…`)})});return}y(f,!0,E,M.url),t.sendMessageSafe({type:"atlas-react",payload:M},L=>{if(!L||!L.ok){y(f,!1,null,M.url),t.showToast(L?.error||"Reaction failed.","danger");return}const C=L.data||null,k=C?.file||null,v=C?.reaction?.type?String(C.reaction.type):E;n.atlasStatusCache.set(M.url,{exists:!!k,downloaded:!!k?.downloaded,blacklisted:!!k?.blacklisted_at,reactionType:v,ts:Date.now()}),y(f,!1,v,M.url),t.showToast(`Reacted (${E}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const U={type:E,url:P.url,referrer_url:P.referrer_url||window.location.href,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:P.tag_name,width:P.width,height:P.height,alt:n.limitString(P.alt||"",n.maxMetadataLen),preview_url:P.preview_url||"",source:n.sourceFromMediaUrl(P.url)};n.fetchAtlasStatus(t.sendMessageSafe,U.url,U.referrer_url||null,ae=>{if(ae?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(W=>{if(W==="alternate"){t.showToast("Cancelled.");return}y(f,!0,E,U.url),W==="confirm"&&(U.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:U},M=>{if(!M||!M.ok){y(f,!1,null,U.url),t.showToast(M?.error||"Reaction failed.","danger");return}const A=M.data||null,L=A?.file||null,C=A?.reaction?.type?String(A.reaction.type):E;n.atlasStatusCache.set(U.url,{exists:!!L,downloaded:!!L?.downloaded,blacklisted:!!L?.blacklisted_at,reactionType:C,ts:Date.now()}),y(f,!1,C,U.url),t.showToast(`Reacted (${E}). Queued download in Atlas.`)})});return}y(f,!0,E,U.url),t.sendMessageSafe({type:"atlas-react",payload:U},W=>{if(!W||!W.ok){y(f,!1,null,U.url),t.showToast(W?.error||"Reaction failed.","danger");return}const M=W.data||null,A=M?.file||null,L=M?.reaction?.type?String(M.reaction.type):E;n.atlasStatusCache.set(U.url,{exists:!!A,downloaded:!!A?.downloaded,blacklisted:!!A?.blacklisted_at,reactionType:L,ts:Date.now()}),y(f,!1,L,U.url),t.showToast(`Reacted (${E}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",w=>{if(!a||!(w instanceof MouseEvent)||!w.altKey||t.isSheetOpen()||D(w))return;const f=(w.target instanceof Element?w.target:null)?.closest?.("img, video")??null;if(!f)return;g(),w.preventDefault(),w.stopPropagation(),w.stopImmediatePropagation();const E=be(f,n.minSize);if(!E){if(f instanceof HTMLVideoElement){const U=(f.currentSrc||f.src||"").trim().toLowerCase();if(U.startsWith("blob:")||U.startsWith("data:")){const ae=window.location.href,W={type:"dislike",url:ae,referrer_url:ae,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:"video",width:f.videoWidth||f.clientWidth||null,height:f.videoHeight||f.clientHeight||null,alt:"",preview_url:f.poster||"",source:n.sourceFromMediaUrl(ae),download_via:"yt-dlp"};y(f,!0,"dislike",W.url),t.sendMessageSafe({type:"atlas-react",payload:W},M=>{if(!M||!M.ok){y(f,!1,null,W.url),t.showToast(M?.error||"Reaction failed.","danger");return}y(f,!1,"dislike",W.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const P={type:"dislike",url:E.url,referrer_url:E.referrer_url||window.location.href,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:E.tag_name,width:E.width,height:E.height,alt:n.limitString(E.alt||"",n.maxMetadataLen),preview_url:E.preview_url||"",source:n.sourceFromMediaUrl(E.url)};y(f,!0,"dislike",P.url),t.sendMessageSafe({type:"atlas-react",payload:P},U=>{if(!U||!U.ok){y(f,!1,null,P.url),t.showToast(U?.error||"Reaction failed.","danger");return}y(f,!1,"dislike",P.url),t.showToast("Disliked.")})},!0)}function Xe(t,n,a){return t<n?n:t>a?a:t}function Dt(){const t=window;if(t.__atlasLocationObserverInstalled)return;t.__atlasLocationObserverInstalled=!0;const n=()=>{window.dispatchEvent(new Event(Ke))},a=r=>{const o=history[r].bind(history);history[r]=((...g)=>{const y=o(...g);return n(),y})};a("pushState"),a("replaceState"),window.addEventListener("popstate",n,!0),window.addEventListener("hashchange",n,!0)}function Ze(t,n,a){const r=be(t,a.minSize);if(r)return{type:n,url:r.url,referrer_url:r.referrer_url||window.location.href,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:r.tag_name,width:r.width,height:r.height,alt:a.limitString(r.alt||"",a.maxMetadataLen),preview_url:r.preview_url||"",source:a.sourceFromMediaUrl(r.url)};if(t instanceof HTMLVideoElement){const o=(t.currentSrc||t.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const g=window.location.href;return{type:n,url:g,referrer_url:g,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:a.sourceFromMediaUrl(g),download_via:"yt-dlp"}}}return null}function Je(t,n){Dt();const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");const r=document.createElement("span");r.className="atlas-downloader-media-resolution",r.hidden=!0,a.appendChild(r);let o=null,g=null,y=null,D=!1,w=null,x=null,f=-1,E=-1,P=null,U=window.location.href;const ae=new Map,W=(i,h)=>{const S=typeof i=="number"&&Number.isFinite(i)&&i>0?Math.round(i):null,O=typeof h=="number"&&Number.isFinite(h)&&h>0?Math.round(h):null;return!S||!O?"":`${S}x${O}`},M=(i,h)=>{const S=W(i,h);if(!S){r.textContent="",r.hidden=!0;return}r.textContent=S,r.hidden=!1},A=()=>{const i=D||w!==null;for(const[h,S]of ae.entries())S.disabled=i,S.classList.toggle("pending",D&&x===h)},L=(i,h=null)=>{D=i,x=i?h:null,A()},C=i=>{for(const h of[..._e,ee]){const S=ae.get(h.type);if(!S)continue;const O=h.type===ee.type?i==="dislike":i===h.type;S.classList.toggle("active",O)}},k=(i,h)=>{w=i&&h===!1&&i!=="dislike"?i:null;for(const S of[..._e,ee]){const O=ae.get(S.type);if(!O)continue;const N=S.type===ee.type?w==="dislike":w===S.type;O.classList.toggle("queued",N)}A()},v=(i,h,S)=>{o&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:o,pending:i,reactionType:h,url:S}}))},$=()=>{D&&(v(!1,null,g||null),L(!1,null))},H=()=>{const i=window.location.href;i!==U&&(U=i,$(),G(!0))},F=()=>{y&&(window.clearTimeout(y),y=null)},G=i=>{D&&!(i===!0)||(o=null,g=null,a.classList.remove("open"),a.style.left="",a.style.top="",M(null,null),C(null))},R=()=>{F(),y=window.setTimeout(()=>{a.matches(":hover")||G()},140)},q=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of[..._e,ee]){const h=document.createElement("button");h.type="button",h.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),h.setAttribute("aria-label",i.label),h.title=i.label,h.replaceChildren(Ee(i.pathDs)),ae.set(i.type,h),h.addEventListener("pointerdown",q,!0),h.addEventListener("mousedown",q,!0),h.addEventListener("click",S=>{if(q(S),D)return;if(!o){t.showToast("No media selected.");return}const O=i.type===ee.type?"dislike":i.type,N=Ze(o,O,n);if(!N){t.showToast("No valid media URL found.");return}const p=N.url||"",j=(X=!1)=>{X?N.force_download=!0:"force_download"in N&&delete N.force_download,v(!0,i.type,p||null),L(!0,i.type),t.sendMessageSafe({type:"atlas-react",payload:{...N,...i.type===ee.type?{blacklist:!0}:{}}},z=>{if(L(!1,null),!z||!z.ok){v(!1,null,p||null),t.showToast(z?.error||"Reaction failed.","danger");return}const re=z.data||null,he=re?.file||null,le=re?.reaction?.type?String(re.reaction.type):i.type===ee.type?"dislike":i.type;if(p&&n.atlasStatusCache.set(p,{exists:!!he,downloaded:!!he?.downloaded,blacklisted:!!he?.blacklisted_at,reactionType:le,ts:Date.now()}),C(le),k(le,!!he?.downloaded),v(!1,le,p||null),N.download_via==="yt-dlp"){t.showToast(`Reacted (${i.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${i.label}). Queued download in Atlas.`)})};n.fetchAtlasStatus(t.sendMessageSafe,p,N.referrer_url||null,X=>{if(O!=="dislike"&&X?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(z=>{if(z==="alternate"){t.showToast("Cancelled.");return}j(z==="confirm")});return}j(!1)})}),a.appendChild(h)}t.root.appendChild(a);const V=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(S=>S instanceof HTMLElement&&S.id===n.rootId),ue=()=>{if(!o)return;const i=o.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){$(),G(!0);return}const h=Xe(i.top+8,8,window.innerHeight-8),S=Xe(i.right-8,8,window.innerWidth-8);a.style.top=`${h}px`,a.style.left=`${S}px`},oe=(i,h)=>{const S=p=>{if(p.matches("img, video"))return p;const j=p.closest?.("img, video");if(j instanceof Element)return j;const X=p.querySelectorAll?.("img, video");if(!X||X.length===0)return null;for(const z of X){const re=z.getBoundingClientRect();if(i>=re.left&&i<=re.right&&h>=re.top&&h<=re.bottom)return z}return null},O=document.elementsFromPoint?.(i,h)??[];for(const p of O){if(!(p instanceof Element)||p.closest?.(`#${n.rootId}`))continue;const j=S(p);if(j)return j}const N=document.elementFromPoint?.(i,h);return N instanceof Element&&!N.closest?.(`#${n.rootId}`)?S(N):null},te=i=>{if(t.isSheetOpen()){G();return}H();const h=Ze(i,"like",n);if(!h){G();return}const S=h.url||null;if((o&&o!==i||g&&S&&g!==S)&&$(),o=i,g=S,M(h.width,h.height),a.classList.add("open"),ue(),C(null),k(null,null),g){const N=n.getCachedAtlasStatus(g);if(N)C(N.reactionType),k(N.reactionType,N.downloaded);else{const p=g;n.fetchAtlasStatus(t.sendMessageSafe,p,window.location.href,j=>{j&&g===p&&(C(j.reactionType),k(j.reactionType,j.downloaded))})}}},fe=i=>i?i==="blacklist"?"blacklist":i:null,ge=()=>{if(f<0||E<0||t.isSheetOpen())return;const i=oe(f,E);i&&(i.closest?.(`#${n.rootId}`)||(F(),te(i)))},we=(i=80)=>{P!==null&&window.clearTimeout(P),P=window.setTimeout(()=>{P=null,ge()},i)};document.addEventListener("pointerover",i=>{if(t.isSheetOpen()||!(i.target instanceof Element)||V(i))return;const h=oe(i.clientX,i.clientY);h&&(F(),te(h))},!0),window.addEventListener("atlas-shortcut-reaction-state",i=>{const h=i,S=h.detail?.media;if(!(S instanceof Element))return;F(),te(S);const O=!!h.detail?.pending,N=fe(h.detail?.reactionType??null);if(O){L(!0,N);return}if(L(!1,null),N){const p=N==="blacklist"?"dislike":N;C(p);const j=g?n.getCachedAtlasStatus(g):null;k(p,j?.downloaded??null)}},!0),document.addEventListener("pointermove",i=>{H(),f=i.clientX,E=i.clientY},!0),document.addEventListener("pointerout",i=>{!o||t.isSheetOpen()||!(i.target instanceof Element)||V(i)||!(i.target.closest?.("img, video")??null)||R()},!0),a.addEventListener("pointerenter",F,!0),a.addEventListener("pointerleave",R,!0),window.addEventListener("scroll",ue,!0),window.addEventListener("resize",ue),window.addEventListener(Ke,H,!0),window.addEventListener("blur",G),window.addEventListener("focus",()=>we(40),!0),new MutationObserver(()=>{H(),we(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}function Q(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function Ge(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>Te(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Ye(t,n){const a=(t||"").toLowerCase();if(!a)return!1;for(const r of n)if(Me(a,r))return!0;return!1}function Te(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const a=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(a).hostname}catch{return""}}function Me(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}const et="atlas-downloader-page-markers";function tt(t){return function(a,r="info"){const o=document.createElement("div");o.className=`atlas-downloader-toast${r==="danger"?" danger":""}`,o.textContent=a,t.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove(),{once:!0})},2600)}}function nt(t){return n=>new Promise(a=>{const r=document.createElement("div");r.className="atlas-downloader-dialog-backdrop";const o=document.createElement("div");o.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.setAttribute("aria-label",n.title);const g=document.createElement("h3");g.className="atlas-downloader-dialog-title",g.textContent=n.title;const y=document.createElement("p");y.className="atlas-downloader-dialog-message",y.textContent=n.message;const D=document.createElement("div");D.className="atlas-downloader-dialog-actions";const w=E=>{r.remove(),a(E)};if(n.alternateLabel){const E=document.createElement("button");E.type="button",E.className="atlas-downloader-dialog-btn secondary",E.textContent=n.alternateLabel,E.addEventListener("click",()=>w("alternate")),D.appendChild(E)}const x=document.createElement("button");x.type="button",x.className="atlas-downloader-dialog-btn",x.textContent=n.cancelLabel||"Cancel",x.addEventListener("click",()=>w("cancel")),D.appendChild(x);const f=document.createElement("button");f.type="button",f.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),f.textContent=n.confirmLabel,f.addEventListener("click",()=>w("confirm")),D.appendChild(f),o.appendChild(g),o.appendChild(y),o.appendChild(D),r.appendChild(o),t.appendChild(r),requestAnimationFrame(()=>{f.focus()})})}function Rt(){if(document.getElementById(et))return;const t=document.createElement("style");t.id=et,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 4px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 4px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 4px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 4px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 4px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: -4px !important;
}
`,(document.head||document.documentElement).appendChild(t)}(()=>{const a="atlas-downloader-root",r="atlas-open",o=(()=>{try{return window.top===window.self}catch{return!1}})(),g=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let y=null,D=null;const w=3e4,x=new Map;function f(A,L){const C=typeof A=="string"?A:"";return C.length<=L?C:C.slice(0,L)}function E(A){return wt(A)||"Extension"}function P(A){const L=x.get(A);return L?Date.now()-L.ts>w?(x.delete(A),null):L:null}function U(A,L,C,k){const v=Q((L||"").trim());if(!v){k(null);return}const $=P(v);if($){k($);return}A({type:"atlas-check-batch",urls:[v]},H=>{if(!H||!H.ok){k(null);return}const F=Array.isArray(H.data?.results)?H.data.results:[],R=new Map(F.filter(V=>typeof V?.url=="string"&&V.url.trim()!=="").map(V=>[Q(String(V.url)),V])).get(v)??null;if(!R){k(null);return}const q={exists:!!R.exists,downloaded:!!R.downloaded,blacklisted:!!R.blacklisted,reactionType:R.reaction?.type?String(R.reaction.type):null,ts:Date.now()};x.set(v,q),k(q)})}chrome.runtime.onMessage.addListener(A=>{if(!A||typeof A!="object")return;const L=A;if(L.type==="atlas-download-event"){D?.(L.payload);return}if(L.type==="atlas-open-sheet"&&o)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],C=>{Ie(C.atlasMediaNoiseFilters||"");const k=Te(C.atlasBaseUrl||"");if(k&&Me(window.location.hostname,k))return;const v=Ge(C.atlasExcludedDomains||"");Ye(window.location.hostname,v)||(W(),y?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],A=>{Ie(A.atlasMediaNoiseFilters||"");const L=Te(A.atlasBaseUrl||"");if(L&&Me(window.location.hostname,L))return;const C=Ge(A.atlasExcludedDomains||"");Ye(window.location.hostname,C)||(o?W():ae())});function ae(){if(document.getElementById(a))return;const A=document.createElement("div");A.id=a;const L=A.attachShadow({mode:"closed"}),C=document.createElement("link");C.rel="stylesheet",C.href=chrome.runtime.getURL("dist/content.css"),L.appendChild(C);const k=document.createElement("div");k.className="atlas-shadow-root";const v=tt(k),$=nt(k),H=(F,G)=>{try{chrome.runtime.sendMessage(F,G)}catch(R){(()=>{if(R instanceof Error)return R.message;if(R&&typeof R=="object"&&"message"in R){const V=R.message;return typeof V=="string"?V:String(V)}return String(R)})().includes("Extension context invalidated")?v("Atlas extension was reloaded. Refresh this tab.","danger"):v("Atlas extension error. Refresh this tab.","danger"),G(null)}};L.appendChild(k),(document.body||document.documentElement).appendChild(A),Ve({showToast:v,sendMessageSafe:H,isSheetOpen:()=>!1,chooseDialog:$},{rootId:a,minSize:200,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:E,fetchAtlasStatus:U,atlasStatusCache:x,getCachedAtlasStatus:P}),Je({root:k,showToast:v,sendMessageSafe:H,isSheetOpen:()=>!1,chooseDialog:$},{rootId:a,minSize:200,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:E,fetchAtlasStatus:U,atlasStatusCache:x,getCachedAtlasStatus:P})}function W(){if(document.getElementById(a))return;const A=document.createElement("div");A.id=a;const L=A.attachShadow({mode:"closed"}),C=document.createElement("link");C.rel="stylesheet",C.href=chrome.runtime.getURL("dist/content.css"),L.appendChild(C);const k=document.createElement("div");k.className="atlas-shadow-root";const v=tt(k),$=(e,s)=>{try{chrome.runtime.sendMessage(e,s)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const u=l.message;return typeof u=="string"?u:String(u)}return String(l)})().includes("Extension context invalidated")?v("Atlas extension was reloaded. Refresh this tab.","danger"):v("Atlas extension error. Refresh this tab.","danger"),s(null)}},H=document.createElement("button");H.className="atlas-downloader-toggle",H.type="button",H.setAttribute("aria-label","Atlas Downloader"),H.title="Atlas Downloader";const F=document.createElement("img");F.alt="",F.src=chrome.runtime.getURL("icon.svg"),H.appendChild(F);const G=document.createElement("div");G.className="atlas-downloader-overlay";const R=document.createElement("div");R.className="atlas-downloader-modal",R.setAttribute("role","dialog"),R.setAttribute("aria-modal","true"),R.setAttribute("aria-label","Atlas Media Picker");const q=document.createElement("div");q.className="atlas-downloader-header";const V=document.createElement("div");V.className="atlas-downloader-title",V.textContent="Atlas Media Picker";const ue=document.createElement("div");ue.className="atlas-downloader-version",ue.textContent=g?`v${g}`:"";const oe=document.createElement("button");oe.type="button",oe.className="atlas-downloader-close",oe.setAttribute("aria-label","Close"),oe.textContent="x",q.appendChild(V),q.appendChild(ue),q.appendChild(oe);const te=document.createElement("div");te.className="atlas-downloader-toolbar";const fe=ve("Rescan",()=>rt()),ge=ve("Check Atlas",()=>ut(!1)),we=ve("Select all",()=>ot(!0)),ye=ve("Select none",()=>ot(!1)),i=document.createElement("span");i.className="spacer";const h=ve("Queue selected",()=>Qt(),{primary:!0});te.appendChild(fe),te.appendChild(ge),te.appendChild(we),te.appendChild(ye),te.appendChild(i),te.appendChild(h);const S=document.createElement("div");S.className="atlas-downloader-meta";const O=document.createElement("div");O.className="atlas-downloader-list",R.appendChild(q),R.appendChild(te),R.appendChild(S),R.appendChild(O),k.appendChild(H),k.appendChild(G),k.appendChild(R),L.appendChild(k),(document.body||document.documentElement).appendChild(A);const N=nt(k);let p=[],j=0,X=null,z=null,re=null,he=null;const le=new Set,Ne=new Map,Bt=!0;let at=!1;D=e=>{if(!e||typeof e!="object")return;const s=e,l=Number.isFinite(Number(s.transferId))?Number(s.transferId):null,d=typeof s.status=="string"?s.status:"",u=!!s.downloaded||d==="completed"||typeof s.finished_at=="string",m=!!s.failed||d==="failed"||d==="canceled"||typeof s.failed_at=="string",b=new Set,c=typeof s.original=="string"?Q(s.original.trim()):"",_=typeof s.referrer_url=="string"?Q(s.referrer_url.trim()):"";c&&b.add(c),_&&b.add(_);const T=l?Ne.get(l)??"":"";if(T&&b.add(T),b.size===0)return;const K=c||T||_||"";l&&K&&!u&&!m&&Ne.set(l,K);let ne=!1;for(const B of b){const de=P(B);x.set(B,{exists:!0,downloaded:u,blacklisted:de?!!de.blacklisted:!1,reactionType:de?.reactionType??null,ts:Date.now()})}for(const B of p){const de=ie(B)||Q(String(B.url||""));!de||!b.has(de)||!le.has(de)&&B.status!=="Queued"||(B.atlas={exists:!0,downloaded:u,blacklisted:B.atlas?.blacklisted??!1,file_id:B.atlas?.file_id??null,reaction:B.atlas?.reaction??null},u?(B.status="",B.statusClass="",B.reactionQueued=null,le.delete(de)):m?(B.status="Failed",B.statusClass="err",B.reactionQueued=null,le.delete(de)):(B.status="Queued",B.statusClass="queued"),ne=!0)}l&&(u||m)&&Ne.delete(l),ne&&(Y(),Z(J()),me(p))},H.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),De()}),G.addEventListener("click",()=>ke()),oe.addEventListener("click",()=>ke()),document.addEventListener("keydown",e=>{const s=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&s==="a"){e.preventDefault(),De();return}if(e.key==="Escape"&&k.classList.contains(r)){ke();return}if(!k.classList.contains(r))return;const l=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!l)return;const d=p.find(u=>u.selected)??p[0]??null;d&&(e.preventDefault(),Re(d,l,{closeOnSuccess:!0}))});function It(){k.classList.add(r),rt()}function De(){if(k.classList.contains(r)){ke();return}It()}function ke(){k.classList.remove(r)}y=De,Ve({showToast:v,sendMessageSafe:$,isSheetOpen:()=>k.classList.contains(r),chooseDialog:N,setHintShown:e=>{at=e},getHintShown:()=>at,enabled:Bt},{rootId:a,minSize:200,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:E,fetchAtlasStatus:U,atlasStatusCache:x,getCachedAtlasStatus:P}),Je({root:k,showToast:v,sendMessageSafe:$,isSheetOpen:()=>k.classList.contains(r),chooseDialog:N},{rootId:a,minSize:200,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:E,fetchAtlasStatus:U,atlasStatusCache:x,getCachedAtlasStatus:P}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const s=e,l=!!s.detail?.pending,d=s.detail?.reactionType?String(s.detail.reactionType):null,m=(typeof s.detail?.url=="string"?s.detail.url:"")||s.detail?.media&&be(s.detail.media,200)?.url||"",b=m?Q(m):"";if(l){X=b||"__external-reaction__",z=d||z||"like";for(const c of p)b&&(ie(c)||Q(String(c.url||"")))!==b||(c.reactionPending=d||c.reactionPending||"like");Y(),Z(J());return}X=null,z=null;for(const c of p){if(b&&(ie(c)||Q(String(c.url||"")))!==b)continue;c.reactionPending&&(c.reactionPending=null);const _=(b?P(b):null)??P(ie(c))??P(Q(String(c.url||"")));_?c.atlas={exists:!!_.exists,downloaded:!!_.downloaded,blacklisted:!!_.blacklisted,file_id:c.atlas?.file_id??null,reaction:_.reactionType?{type:_.reactionType}:c.atlas?.reaction??null}:d&&(c.atlas={exists:c.atlas?.exists??!0,downloaded:c.atlas?.downloaded??!1,blacklisted:c.atlas?.blacklisted??!1,file_id:c.atlas?.file_id??null,reaction:{type:d}}),c.atlas?.exists&&!c.atlas?.downloaded&&c.atlas?.reaction?.type&&c.atlas.reaction.type!=="dislike"?c.reactionQueued=c.atlas.reaction.type:c.reactionQueued=null}Y(),Z(J()),me(p)},!0);const Le=(e=300)=>{he!==null&&window.clearTimeout(he),he=window.setTimeout(()=>{he=null,zt()},e)};new MutationObserver(()=>{me(p),Le(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>Le(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&Le(120)},!0),Le(120);function ve(e,s,l){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${l?.primary?" primary":""}`,d.textContent=e,d.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),s()}),d}function Pt(e){S.textContent=e,h.disabled=!0,fe.disabled=!0,ge.disabled=!0,we.disabled=!0,ye.disabled=!0}function Z(e){S.textContent=e;const s=p.filter(d=>d.selected).length,l=p.some(d=>!!d.reactionPending)||X!==null;h.disabled=s===0||l,fe.disabled=l,ge.disabled=p.length===0||l,we.disabled=p.length===0||l,ye.disabled=p.length===0||l}function rt(){j+=1;const e=j;p=[],re=null,O.replaceChildren(),Pt("Scanning this page…"),M(s=>{j===e&&(S.textContent=`Scanning… ${s.scanned}/${s.total}`)}).then(s=>{j===e&&(p=s.map(l=>({...l,selected:!0,status:"",statusClass:"",atlas:null,reactionPending:X&&X!=="__external-reaction__"&&(ie(l)||Q(String(l.url||"")))===X?z||"like":null,reactionQueued:null})),Y(),Z(J()),ut(!0))})}function ot(e){for(const s of p)s.selected=e;Y(),Z(J())}function Y(){if(O.replaceChildren(),p.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",O.appendChild(e);return}for(const e of p)O.appendChild(Ut(e))}function Ut(e){const s=document.createElement("div");s.className=`atlas-downloader-item${e.selected?" selected":""}`;const l=document.createElement("input");l.type="checkbox",l.checked=e.selected,l.addEventListener("change",()=>{e.selected=l.checked,s.classList.toggle("selected",e.selected),Z(J())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",e.preview_url){const I=document.createElement("img");I.loading="lazy",I.alt="",I.src=e.preview_url,d.appendChild(I)}const u=document.createElement("div");u.className="atlas-downloader-info";const m=document.createElement("div");m.className="atlas-downloader-kind",m.textContent=e.tag_name;const b=document.createElement("div");b.className="atlas-downloader-url",b.textContent=e.url,b.title=e.url;const c=document.createElement("div");c.className="atlas-downloader-sub",c.textContent=Ot(e);const _=document.createElement("div");_.className="atlas-downloader-reactions";const T=e.atlas?.reaction?.type||null,K=!!e.reactionPending||!!e.reactionQueued;for(const I of _e){const ce=document.createElement("button");ce.type="button",ce.className=`atlas-downloader-reaction-btn ${I.className}${T===I.type?" active":""}${e.reactionPending===I.type?" pending":""}${e.reactionQueued===I.type?" queued":""}`.trim(),ce.setAttribute("aria-label",I.label),ce.title=I.label,ce.replaceChildren(Ee(I.pathDs)),ce.disabled=K,ce.addEventListener("click",mt=>{mt.preventDefault(),mt.stopPropagation(),Re(e,I.type)}),_.appendChild(ce)}const ne=document.createElement("button");if(ne.type="button",ne.className=`atlas-downloader-reaction-btn ${ee.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===ee.type?" pending":""}${e.reactionQueued===ee.type?" queued":""}`.trim(),ne.setAttribute("aria-label",ee.label),ne.title=ee.label,ne.replaceChildren(Ee(ee.pathDs)),ne.disabled=K,ne.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation(),Re(e,"dislike",{blacklist:!0})}),_.appendChild(ne),e.atlas?.downloaded){const I=document.createElement("button");I.type="button",I.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),I.setAttribute("aria-label","Delete download"),I.title="Delete download",I.replaceChildren(Ee(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),I.disabled=K,I.addEventListener("click",ce=>{ce.preventDefault(),ce.stopPropagation(),jt(e)}),_.appendChild(I)}const B=document.createElement("button");B.type="button",B.className=`atlas-downloader-debug-toggle${re===e.url?" active":""}`,B.textContent=re===e.url?"Hide debug":"Debug",B.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation(),re=re===e.url?null:e.url,Y(),Z(J())}),_.appendChild(B),u.appendChild(m),u.appendChild(b),u.appendChild(c),u.appendChild(_),re===e.url&&u.appendChild($t(e));const de=document.createElement("div"),ft=Ft(e);return de.className=`atlas-downloader-status ${ft.className}`.trim(),de.textContent=ft.text,s.addEventListener("click",I=>{I.target instanceof HTMLInputElement||(e.selected=!e.selected,l.checked=e.selected,s.classList.toggle("selected",e.selected),Z(J()))}),s.appendChild(l),s.appendChild(d),s.appendChild(u),s.appendChild(de),s}function lt(e,s){return{type:s,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:f(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:f(e.alt||"",500),preview_url:e.preview_url||"",source:E(e.url),...e.download_via?{download_via:e.download_via}:{}}}function st(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:f(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:f(e.alt||"",500),preview_url:e.preview_url||"",source:E(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function $t(e){const s=document.createElement("details");s.className="atlas-downloader-debug",s.open=!0;const l=document.createElement("summary");l.textContent="Debug payload",s.appendChild(l);const d={react:lt(e,e.atlas?.reaction?.type||"like"),download:st(e)};return s.appendChild(Ht(d)),s}function Ht(e,s=0){const l=document.createElement("div");l.className="atlas-downloader-json-tree";const d=Ae(e);if(!dt(d)){const m=document.createElement("div");return m.className="atlas-downloader-json-line",m.textContent=ct(d),l.appendChild(m),l}const u=Array.isArray(d)?d.map((m,b)=>[String(b),m]):Object.entries(d);for(const[m,b]of u)l.appendChild(it(m,b,s));return l}function it(e,s,l){const d=Ae(s),u=document.createElement("div");if(u.className="atlas-downloader-json-line",u.style.paddingLeft=`${l*12}px`,!dt(d))return u.innerHTML=`<span class="atlas-downloader-json-key">${Se(e)}</span>: <span class="atlas-downloader-json-value">${Se(ct(d))}</span>`,u;const m=document.createElement("details");m.className="atlas-downloader-json-node",m.open=l===0;const b=document.createElement("summary");b.style.paddingLeft=`${l*12}px`;const c=Array.isArray(d)?`[${d.length}]`:`{${Object.keys(d).length}}`;b.innerHTML=`<span class="atlas-downloader-json-key">${Se(e)}</span>: <span class="atlas-downloader-json-preview">${Se(c)}</span>`,m.appendChild(b);const _=Array.isArray(d)?d.map((T,K)=>[String(K),T]):Object.entries(d);for(const[T,K]of _)m.appendChild(it(T,K,l+1));return m}function Ae(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(l=>Ae(l));if(!e||typeof e!="object")return null;const s={};for(const[l,d]of Object.entries(e))s[l]=Ae(d);return s}function dt(e){return Array.isArray(e)||e&&typeof e=="object"}function ct(e){return JSON.stringify(e)}function Se(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Ot(e){const s=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",l=Wt(e.url);return l?`${s} • ${l}`:s}function Wt(e){try{return new URL(e).hostname}catch{return""}}function J(){const e=p.filter(s=>s.selected).length;return`${p.length} found • ${e} selected`}function ie(e){const s=(e?.url||e?.referrer_url||"").trim();return s?Q(s):""}function Ft(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function ut(e){const s=[...new Set(p.map(l=>ie(l)).filter(Boolean))];s.length!==0&&$({type:"atlas-check-batch",urls:s},l=>{if(!l){e||v("Atlas extension did not respond.","danger");return}if(!l.ok){e||v(l.error||"Atlas check failed.","danger");return}const d=Array.isArray(l.data?.results)?l.data.results:[],u=new Map(d.filter(c=>typeof c?.url=="string"&&c.url.trim()!=="").map(c=>[Q(String(c.url)),c]));let m=0,b=0;for(const c of p){const _=ie(c),T=u.get(_);T&&(c.atlas={exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,file_id:T.file_id??null,reaction:T.reaction??null},c.atlas.exists&&!c.atlas.downloaded&&c.atlas.reaction?.type&&c.atlas.reaction.type!=="dislike"?(c.reactionQueued=c.atlas.reaction.type,le.add(_)):(c.reactionQueued=null,le.delete(_)),x.set(_,{exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,reactionType:T.reaction?.type?String(T.reaction.type):null,ts:Date.now()}),T.exists&&(m+=1),T.downloaded&&(b+=1))}Y(),Z(J()),me(p),e||v(`Atlas check: ${b}/${m} downloaded.`)})}function Re(e,s,l={}){const d=(m={})=>{e.reactionPending=l.blacklist?ee.type:s,e.status="Reacting…",e.statusClass="",X=ie(e)||e.url,z=e.reactionPending,Y(),Z(J());const b={...lt(e,s),...m,...l.blacklist?{blacklist:!0}:{}};$({type:"atlas-react",payload:b},c=>{if(e.reactionPending=null,X=null,z=null,!c){e.status="No response",e.statusClass="err",Y(),Z(J()),v("Atlas extension did not respond.","danger");return}if(!c.ok){e.status=c.error||"Failed",e.statusClass="err",Y(),Z(J()),v(c.error||"Reaction failed.","danger");return}const _=c.data||null,T=_?.file||null;e.atlas={exists:!!T,downloaded:!!T?.downloaded,blacklisted:!!T?.blacklisted_at,file_id:T?.id??null,reaction:_?.reaction??null};const K=ie(e)||e.url;x.set(K,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&s!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=l.blacklist?ee.type:s,K&&le.add(K)):(e.status="",e.statusClass="",e.reactionQueued=null,K&&le.delete(K)),Y(),Z(J()),me(p),l.closeOnSuccess&&ke()})},u=!!e.atlas?.reaction?.type;if(s!=="dislike"&&e.atlas?.downloaded&&u){N({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(m=>{if(m==="alternate"){v("Cancelled.");return}d(m==="confirm"?{force_download:!0}:{})});return}if(s==="dislike"&&e.atlas?.downloaded){N({title:l.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(m=>{if(m==="alternate"){v("Cancelled.");return}d(m==="confirm"?{clear_download:!0}:{})});return}d()}function jt(e){N({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(s=>{s==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",X=ie(e)||e.url,z=e.reactionPending,Y(),Z(J()),$({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},l=>{if(e.reactionPending=null,X=null,z=null,!l||!l.ok){e.status=l?.error||"Failed",e.statusClass="err",Y(),Z(J()),v(l?.error||"Delete failed.","danger");return}const d=l.data?.file||null;e.atlas={exists:!!d,downloaded:!!d?.downloaded,blacklisted:!!d?.blacklisted_at,file_id:d?.id??null,reaction:null},e.reactionQueued=null;const u=ie(e)||e.url;x.set(u,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",Y(),Z(J()),me(p),v("Download deleted.")}))})}function Qt(){const e=p.filter(d=>d.selected);if(e.length===0){v("Select one or more items first.");return}if(e.some(d=>!!d.atlas?.downloaded)){N({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(d=>{if(d==="alternate"){v("Cancelled.");return}l(d==="confirm")});return}l(!1);function l(d){h.disabled=!0,fe.disabled=!0,ge.disabled=!0,we.disabled=!0,ye.disabled=!0;for(const m of e)m.status="Sending…",m.statusClass="";Y();const u=e.map(m=>{const b=st(m);return d&&(b.force_download=!0),b});$({type:"atlas-download-batch",payloads:u},m=>{if(!m){for(const c of e)c.status="No response",c.statusClass="err";Y(),Z(J()),v("Atlas extension did not respond.","danger");return}const b=Array.isArray(m.results)?m.results:[];for(let c=0;c<e.length;c+=1){const _=e[c],T=b[c];if(T?.ok){const K=T.data||null,ne=K?.file||null;if(_.atlas={exists:!!ne,downloaded:!!ne?.downloaded,blacklisted:!!ne?.blacklisted_at,file_id:ne?.id??null,reaction:_.atlas?.reaction??null},K?.queued){_.status="Queued",_.statusClass="queued",_.atlas?.reaction?.type&&_.atlas.reaction.type!=="dislike"&&(_.reactionQueued=_.atlas.reaction.type);const B=ie(_)||Q(String(_.url||""));B&&le.add(B)}else{_.status="",_.statusClass="",_.reactionQueued=null;const B=ie(_)||Q(String(_.url||""));B&&le.delete(B)}}else _.status=T?.error||"Failed",_.statusClass="err"}Y(),Z(J()),me(p),m.ok?v(`Queued ${e.length} download(s) in Atlas.`):v(m.error||"Some requests failed.","danger")})}}function me(e=p){Rt();const s=document.querySelectorAll('[data-atlas-marked="1"]');for(const u of s)u.removeAttribute("data-atlas-marked"),u.removeAttribute("data-atlas-state"),u.removeAttribute("data-atlas-reaction");const l=new Map;for(const[u,m]of x.entries()){if(Date.now()-m.ts>w){x.delete(u);continue}l.set(u,{exists:!!m.exists,downloaded:!!m.downloaded,blacklisted:!!m.blacklisted,reactionType:m.reactionType?String(m.reactionType):null}),l.set(Q(u),{exists:!!m.exists,downloaded:!!m.downloaded,blacklisted:!!m.blacklisted,reactionType:m.reactionType?String(m.reactionType):null})}for(const u of e){if(!u?.url||!u?.atlas)continue;const m=u.atlas?.reaction?.type?String(u.atlas.reaction.type):null,b={exists:!!u.atlas.exists,downloaded:!!u.atlas.downloaded,blacklisted:!!u.atlas.blacklisted,reactionType:m};l.set(u.url,b),l.set(Q(u.url),b)}if(l.size===0)return;const d=document.querySelectorAll("img, video, a[href]");for(const u of d){const m=$e(u);if(m.length===0)continue;const b=m.map(c=>l.get(c)||l.get(Q(c))).find(c=>!!(c&&(c.exists||c.downloaded||c.blacklisted||c.reactionType)))??null;b&&(u.setAttribute("data-atlas-marked","1"),b.blacklisted?u.setAttribute("data-atlas-state","blacklisted"):b.reactionType?u.setAttribute("data-atlas-state","reacted"):b.downloaded?u.setAttribute("data-atlas-state","downloaded"):b.exists&&u.setAttribute("data-atlas-state","exists"),b.reactionType&&u.setAttribute("data-atlas-reaction",b.reactionType))}}function qt(){const e=new Set,s=document.querySelectorAll("img, video, a[href]");for(const d of s)for(const u of $e(d))e.add(u),e.add(Q(u));const l=Ue();return l?.url&&(e.add(l.url),e.add(Q(l.url))),[...e].filter(Boolean)}function zt(){const e=qt();if(e.length===0){me(p);return}$({type:"atlas-check-batch",urls:e},s=>{if(!s?.ok){me(p);return}const l=Array.isArray(s.data?.results)?s.data.results:[];for(const d of l)d?.url&&x.set(String(d.url),{exists:!!d.exists,downloaded:!!d.downloaded,blacklisted:!!d.blacklisted,reactionType:d.reaction?.type?String(d.reaction.type):null,ts:Date.now()});me(p)})}}function M(A){return new Promise(L=>{const C=document.body||document.documentElement,k=Array.from(C.querySelectorAll("img, video")),v=k.length,$=new Set,H=[];let F=0;const G=q=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(q,{timeout:500});return}setTimeout(()=>q({timeRemaining:()=>25}),0)},R=q=>{const V=typeof q?.timeRemaining=="function"?q.timeRemaining():25;let ue=0;for(;F<v&&(ue<80||V>5);){const te=k[F];if(te.closest&&te.closest(`#${a}`)){F+=1,ue+=1;continue}const fe=be(te,200);fe?.url&&!$.has(fe.url)&&($.add(fe.url),H.push(fe)),F+=1,ue+=1}if(A?.({scanned:F,total:v}),F<v){G(R);return}const oe=Ue();oe&&!$.has(oe.url)&&($.add(oe.url),H.push(oe)),L(H)};G(R)})}})()})();
