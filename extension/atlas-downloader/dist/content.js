(function(){"use strict";const kt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function Mt(j){const I=(j||"").trim().toLowerCase();if(!I)return"";const C=I.split(".").filter(Boolean);if(C.length<=2)return I;const U=C.slice(-2).join("."),F=C.slice(-3).join(".");return kt.has(U)&&C.length>=3?F:U}function Tt(j){const I=(j||"").trim();if(!I)return"";try{const C=new URL(I).hostname;return Mt(C)}catch{return""}}(()=>{const C="atlas-downloader-root",U="atlas-open",F=(()=>{try{return window.top===window.self}catch{return!1}})(),at=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let ot=null;const st="http://www.w3.org/2000/svg",lt=t=>{const n=document.createElementNS(st,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const r of t){const a=document.createElementNS(st,"path");a.setAttribute("d",r),a.setAttribute("fill","none"),a.setAttribute("stroke","currentColor"),a.setAttribute("stroke-width","2"),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round"),n.appendChild(a)}return n},it=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}];function M(t,n){const r=typeof t=="string"?t:"";return r.length<=n?r:r.slice(0,n)}function $(t){return Tt(t)||"Extension"}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&F)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],r=>{const a=tt(r.atlasBaseUrl||"");if(a&&et(window.location.hostname,a))return;const o=ut(r.atlasExcludedDomains||"");ft(window.location.hostname,o)||(ct(),ot?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const n=tt(t.atlasBaseUrl||"");if(n&&et(window.location.hostname,n))return;const r=ut(t.atlasExcludedDomains||"");ft(window.location.hostname,r)||(F?ct():Nt())});function Nt(){if(document.getElementById(C))return;const t=document.createElement("div");t.id=C;const n=t.attachShadow({mode:"closed"}),r=document.createElement("link");r.rel="stylesheet",r.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(r);const a=document.createElement("div");a.className="atlas-shadow-root";const o=dt(a),p=(l,E)=>{try{chrome.runtime.sendMessage(l,E)}catch(d){(()=>{if(d instanceof Error)return d.message;if(d&&typeof d=="object"&&"message"in d){const h=d.message;return typeof h=="string"?h:String(h)}return String(d)})().includes("Extension context invalidated")?o("Atlas extension was reloaded. Refresh this tab."):o("Atlas extension error. Refresh this tab."),E(null)}};n.appendChild(a),(document.body||document.documentElement).appendChild(t),ht({showToast:o,sendMessageSafe:p,isSheetOpen:()=>!1}),gt({root:a,showToast:o,sendMessageSafe:p,isSheetOpen:()=>!1})}function ct(){if(document.getElementById(C))return;const t=document.createElement("div");t.id=C;const n=t.attachShadow({mode:"closed"}),r=document.createElement("link");r.rel="stylesheet",r.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(r);const a=document.createElement("div");a.className="atlas-shadow-root";const o=dt(a),p=(e,c)=>{try{chrome.runtime.sendMessage(e,c)}catch(s){(()=>{if(s instanceof Error)return s.message;if(s&&typeof s=="object"&&"message"in s){const m=s.message;return typeof m=="string"?m:String(m)}return String(s)})().includes("Extension context invalidated")?o("Atlas extension was reloaded. Refresh this tab."):o("Atlas extension error. Refresh this tab."),c(null)}},l=document.createElement("button");l.className="atlas-downloader-toggle",l.type="button",l.setAttribute("aria-label","Atlas Downloader"),l.title="Atlas Downloader";const E=document.createElement("img");E.alt="",E.src=chrome.runtime.getURL("icon.svg"),l.appendChild(E);const d=document.createElement("div");d.className="atlas-downloader-overlay";const f=document.createElement("div");f.className="atlas-downloader-modal",f.setAttribute("role","dialog"),f.setAttribute("aria-modal","true"),f.setAttribute("aria-label","Atlas Media Picker");const h=document.createElement("div");h.className="atlas-downloader-header";const i=document.createElement("div");i.className="atlas-downloader-title",i.textContent="Atlas Media Picker";const u=document.createElement("div");u.className="atlas-downloader-version",u.textContent=at?`v${at}`:"";const y=document.createElement("button");y.type="button",y.className="atlas-downloader-close",y.setAttribute("aria-label","Close"),y.textContent="x",h.appendChild(i),h.appendChild(u),h.appendChild(y);const b=document.createElement("div");b.className="atlas-downloader-toolbar";const L=B("Rescan",()=>Et()),W=B("Check Atlas",()=>Ct(!1));let R=!1,D=null;const z=B("Debug: off",()=>{R=!R,z.textContent=R?"Debug: on":"Debug: off",R?!D&&v.length>0&&(D={url:v[0].url,reactionType:"like"}):D=null,T(),N(x())}),Q=B("Select all",()=>At(!0)),Z=B("Select none",()=>At(!1)),wt=document.createElement("span");wt.className="spacer";const K=B("Queue selected",()=>Ft(),{primary:!0});b.appendChild(L),b.appendChild(W),b.appendChild(z),b.appendChild(Q),b.appendChild(Z),b.appendChild(wt),b.appendChild(K);const q=document.createElement("div");q.className="atlas-downloader-meta";const O=document.createElement("div");O.className="atlas-downloader-list",f.appendChild(h),f.appendChild(b),f.appendChild(q),f.appendChild(O),a.appendChild(l),a.appendChild(d),a.appendChild(f),n.appendChild(a),(document.body||document.documentElement).appendChild(t);let v=[],J=0;const Pt=!0;let yt=!1;l.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),bt()}),d.addEventListener("click",()=>nt()),y.addEventListener("click",()=>nt()),document.addEventListener("keydown",e=>{e.key==="Escape"&&a.classList.contains(U)&&nt()});function bt(){a.classList.add(U),Et()}function nt(){a.classList.remove(U)}ot=bt,ht({showToast:o,sendMessageSafe:p,isSheetOpen:()=>a.classList.contains(U),setHintShown:e=>{yt=e},getHintShown:()=>yt,enabled:Pt}),gt({root:a,showToast:o,sendMessageSafe:p,isSheetOpen:()=>a.classList.contains(U)});function B(e,c,s){const g=document.createElement("button");return g.type="button",g.className=`atlas-downloader-btn${s?.primary?" primary":""}`,g.textContent=e,g.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),c()}),g}function Wt(e){q.textContent=e,K.disabled=!0,L.disabled=!0,W.disabled=!0,z.disabled=!0,Q.disabled=!0,Z.disabled=!0}function N(e){q.textContent=e;const c=v.filter(s=>s.selected).length;K.disabled=c===0,L.disabled=!1,W.disabled=v.length===0,z.disabled=v.length===0,Q.disabled=v.length===0,Z.disabled=v.length===0}function Et(){J+=1;const e=J;v=[],R&&(D=null),O.replaceChildren(),Wt("Scanning this page…"),xt(c=>{J===e&&(q.textContent=`Scanning… ${c.scanned}/${c.total}`)}).then(c=>{J===e&&(v=c.map(s=>({...s,selected:!0,status:"",statusClass:"",atlas:null})),R&&!D&&v.length>0&&(D={url:v[0].url,reactionType:"like"}),T(),N(x()),Ct(!0))})}function At(e){for(const c of v)c.selected=e;T(),N(x())}function T(){if(O.replaceChildren(),v.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",O.appendChild(e);return}for(const e of v)O.appendChild(It(e))}function It(e){const c=document.createElement("div");c.className=`atlas-downloader-item${e.selected?" selected":""}`;const s=document.createElement("input");s.type="checkbox",s.checked=e.selected,s.addEventListener("change",()=>{e.selected=s.checked,c.classList.toggle("selected",e.selected),N(x())});const g=document.createElement("div");if(g.className="atlas-downloader-preview",e.preview_url){const k=document.createElement("img");k.loading="lazy",k.alt="",k.src=e.preview_url,g.appendChild(k)}const m=document.createElement("div");m.className="atlas-downloader-info";const A=document.createElement("div");A.className="atlas-downloader-kind",A.textContent=e.tag_name;const w=document.createElement("div");w.className="atlas-downloader-url",w.textContent=e.url,w.title=e.url;const _=document.createElement("div");_.className="atlas-downloader-sub",_.textContent=Bt(e);const S=document.createElement("div");S.className="atlas-downloader-reactions";const X=e.atlas?.reaction?.type||null;for(const k of it){const H=document.createElement("button");H.type="button",H.className=`atlas-downloader-reaction-btn ${k.className}${X===k.type?" active":""}${e.reactionPending?" pending":""}`.trim(),H.setAttribute("aria-label",k.label),H.title=k.label,H.replaceChildren(lt(k.pathDs)),H.disabled=!!e.reactionPending,H.addEventListener("click",St=>{St.preventDefault(),St.stopPropagation(),R&&(D={url:e.url,reactionType:k.type},T()),jt(e,k.type)}),S.appendChild(H)}m.appendChild(A),m.appendChild(w),m.appendChild(_),m.appendChild(S),R&&D?.url===e.url&&m.appendChild(Ot(e,D.reactionType));const rt=document.createElement("div"),Lt=Xt(e);return rt.className=`atlas-downloader-status ${Lt.className}`.trim(),rt.textContent=Lt.text,c.addEventListener("click",k=>{k.target instanceof HTMLInputElement||(R&&(D={url:e.url,reactionType:D?.reactionType??"like"}),e.selected=!e.selected,s.checked=e.selected,c.classList.toggle("selected",e.selected),N(x()))}),c.appendChild(s),c.appendChild(g),c.appendChild(m),c.appendChild(rt),c}function vt(e,c){return{type:c,url:e.url,original_url:e.url,referrer_url:window.location.href,page_title:M(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:M(e.alt||"",500),preview_url:e.preview_url||"",source:$(e.url)}}function _t(e){return{url:e.url,original_url:e.url,referrer_url:window.location.href,page_title:M(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:M(e.alt||"",500),preview_url:e.preview_url||"",source:$(e.url),reaction_type:"like"}}function Ot(e,c){const s=document.createElement("details");s.className="atlas-downloader-debug",s.open=!0;const g=document.createElement("summary");g.textContent="Debug payload",s.appendChild(g);const m=document.createElement("pre");return m.textContent=JSON.stringify({react:vt(e,c),download:_t(e)},null,2),s.appendChild(m),s}function Bt(e){const c=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",s=qt(e.url);return s?`${c} • ${s}`:c}function qt(e){try{return new URL(e).hostname}catch{return""}}function x(){const e=v.filter(c=>c.selected).length;return`${v.length} found • ${e} selected`}function Xt(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Ct(e){const c=v.map(s=>s.url).filter(Boolean);c.length!==0&&p({type:"atlas-check-batch",urls:c},s=>{if(!s){e||o("Atlas extension did not respond.");return}if(!s.ok){e||o(s.error||"Atlas check failed.");return}const g=Array.isArray(s.data?.results)?s.data.results:[],m=new Map(g.map(_=>[_.url,_]));let A=0,w=0;for(const _ of v){const S=m.get(_.url);S&&(_.atlas={exists:!!S.exists,downloaded:!!S.downloaded,file_id:S.file_id??null,reaction:S.reaction??null},S.exists&&(A+=1),S.downloaded&&(w+=1))}T(),N(x()),e||o(`Atlas check: ${w}/${A} downloaded.`)})}function jt(e,c){e.reactionPending=c,e.status="Reacting…",e.statusClass="",T();const s=vt(e,c);p({type:"atlas-react",payload:s},g=>{if(e.reactionPending=null,!g){e.status="No response",e.statusClass="err",T(),N(x()),o("Atlas extension did not respond.");return}if(!g.ok){e.status=g.error||"Failed",e.statusClass="err",T(),N(x()),o(g.error||"Reaction failed.");return}const m=g.data||null,A=m?.file||null;e.atlas={exists:!!A,downloaded:!!A?.downloaded,file_id:A?.id??null,reaction:m?.reaction??null},e.atlas.exists&&!e.atlas.downloaded&&c!=="dislike"?(e.status="Queued",e.statusClass="queued"):(e.status="",e.statusClass=""),T(),N(x()),e.atlas.exists&&!e.atlas.downloaded&&c!=="dislike"&&G([e.url],0)})}function Ft(){const e=v.filter(s=>s.selected);if(e.length===0){o("Select one or more items first.");return}K.disabled=!0,L.disabled=!0,W.disabled=!0,Q.disabled=!0,Z.disabled=!0;for(const s of e)s.status="Sending…",s.statusClass="";T();const c=e.map(s=>_t(s));p({type:"atlas-download-batch",payloads:c},s=>{if(!s){for(const A of e)A.status="No response",A.statusClass="err";T(),N(x()),o("Atlas extension did not respond.");return}const g=Array.isArray(s.results)?s.results:[],m=[];for(let A=0;A<e.length;A+=1){const w=e[A],_=g[A];if(_?.ok){const S=_.data||null,X=S?.file||null;w.atlas={exists:!!X,downloaded:!!X?.downloaded,file_id:X?.id??null},S?.queued?(w.status="Queued",w.statusClass="queued",m.push(w.url)):(w.status="",w.statusClass="")}else w.status=_?.error||"Failed",w.statusClass="err"}T(),N(x()),s.ok?o(`Queued ${e.length} download(s) in Atlas.`):o(s.error||"Some requests failed."),m.length>0&&G(m,0)})}function G(e,c){c>15||setTimeout(()=>{p({type:"atlas-check-batch",urls:e},s=>{if(!s||!s.ok){G(e,c+1);return}const g=Array.isArray(s.data?.results)?s.data.results:[],m=new Map(g.map(w=>[w.url,w]));let A=0;for(const w of v){const _=m.get(w.url);_&&(w.atlas={exists:!!_.exists,downloaded:!!_.downloaded,file_id:_.file_id??null,reaction:_.reaction??null},_.downloaded?w.status==="Queued"&&(w.status="",w.statusClass=""):A+=1)}T(),N(x()),A>0&&G(e,c+1)})},2e3)}}function xt(t){return new Promise(n=>{const r=document.body||document.documentElement,a=Array.from(r.querySelectorAll("img, video")),o=a.length,p=new Set,l=[];let E=0;const d=h=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(h,{timeout:500});return}setTimeout(()=>h({timeRemaining:()=>25}),0)},f=h=>{const i=typeof h?.timeRemaining=="function"?h.timeRemaining():25;let u=0;for(;E<o&&(u<80||i>5);){const y=a[E];if(y.closest&&y.closest(`#${C}`)){E+=1,u+=1;continue}const b=V(y);b?.url&&!p.has(b.url)&&(p.add(b.url),l.push(b)),E+=1,u+=1}if(t?.({scanned:E,total:o}),E<o){d(f);return}n(l)};d(f)})}function V(t){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const n=t,r=n.naturalWidth||n.width||n.clientWidth||null,a=n.naturalHeight||n.height||n.clientHeight||null;if(r&&a&&(r<450||a<450))return null;const o=P(n.currentSrc)||P(n.src)||P(n.getAttribute("src"));return o?{tag_name:"img",url:o,preview_url:o,width:r,height:a,alt:n.alt||""}:null}if(t.tagName==="VIDEO"){const n=Dt(t);return n?{tag_name:"video",url:n,preview_url:t.poster||"",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:""}:null}return null}function Dt(t){const n=P(t.currentSrc)||P(t.src)||P(t.getAttribute("src"));if(n)return n;const r=t.querySelector("source[src]"),a=r?P(r.src||r.getAttribute("src")):"";if(a)return a;const o=Ht(t);return o||Rt()}function Rt(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const n of t){const a=document.querySelector(n)?.getAttribute("content"),o=P(a||"");if(o)return o}return""}function Ht(t){let n=t,r=0;for(;n&&r<8;){const a=n.getAttribute?.("data-store");if(a){const o=Ut(a),p=Y(o,0);if(p)return p}n=n.parentElement,r+=1}return""}function Ut(t){if(!t)return null;const n=$t(t);try{return JSON.parse(n)}catch{return null}}function $t(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Y(t,n){if(!t||n>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const a of t){const o=Y(a,n+1);if(o)return o}return""}if(typeof t!="object")return"";const r=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const a of r){const o=t[a];if(typeof o=="string"&&o.startsWith("http"))return o}for(const a of Object.keys(t)){const o=Y(t[a],n+1);if(o)return o}return""}function dt(t){return function(r){const a=document.createElement("div");a.className="atlas-downloader-toast",a.textContent=r,t.appendChild(a),requestAnimationFrame(()=>a.classList.add("show")),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove(),{once:!0})},2600)}}function ut(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>tt(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function ft(t,n){const r=(t||"").toLowerCase();if(!r)return!1;for(const a of n)if(et(r,a))return!0;return!1}function tt(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const r=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(r).hostname}catch{return""}}function et(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}function P(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const r=n.toLowerCase();return r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:")?"":n}function ht(t){const n=t.enabled??!0,r=t.getHintShown??(()=>!1),a=t.setHintShown??(()=>{}),o=()=>{r()||(a(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},p=l=>(typeof l.composedPath=="function"?l.composedPath():[]).some(d=>d instanceof HTMLElement&&d.id===C);document.addEventListener("click",l=>{!n||!(l instanceof MouseEvent)||!l.altKey||t.isSheetOpen()||p(l)||!((l.target instanceof Element?l.target:null)?.closest?.("img, video")??null)||(l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation())},!0),document.addEventListener("mousedown",l=>{if(!n||!(l instanceof MouseEvent)||!l.altKey||t.isSheetOpen()||p(l))return;const d=(l.target instanceof Element?l.target:null)?.closest?.("img, video")??null;if(!d)return;const f=l.button===0?"like":l.button===1?"love":null;if(!f)return;o(),l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation();const h=V(d);if(!h){if(d instanceof HTMLVideoElement){const u=(d.currentSrc||d.src||"").trim().toLowerCase();if(u.startsWith("blob:")||u.startsWith("data:")){const y=window.location.href,b=`${y}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,L={type:f,url:y,original_url:b,referrer_url:y,page_title:M(document.title,500),tag_name:"video",width:d.videoWidth||d.clientWidth||null,height:d.videoHeight||d.clientHeight||null,alt:"",preview_url:d.poster||"",source:$(y),download_via:"yt-dlp"};t.sendMessageSafe({type:"atlas-react",payload:L},W=>{if(!W||!W.ok){t.showToast(W?.error||"Reaction failed.");return}t.showToast(`Reacted (${f}). Resolving video in Atlas…`)});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const i={type:f,url:h.url,original_url:h.url,referrer_url:window.location.href,page_title:M(document.title,500),tag_name:h.tag_name,width:h.width,height:h.height,alt:M(h.alt||"",500),preview_url:h.preview_url||"",source:$(h.url)};t.sendMessageSafe({type:"atlas-react",payload:i},u=>{if(!u||!u.ok){t.showToast(u?.error||"Reaction failed.");return}t.showToast(`Reacted (${f}). Queued download in Atlas.`)})},!0),document.addEventListener("contextmenu",l=>{if(!n||!(l instanceof MouseEvent)||!l.altKey||t.isSheetOpen()||p(l))return;const d=(l.target instanceof Element?l.target:null)?.closest?.("img, video")??null;if(!d)return;o(),l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation();const f=V(d);if(!f){if(d instanceof HTMLVideoElement){const i=(d.currentSrc||d.src||"").trim().toLowerCase();if(i.startsWith("blob:")||i.startsWith("data:")){const u=window.location.href,y=`${u}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,b={type:"dislike",url:u,original_url:y,referrer_url:u,page_title:M(document.title,500),tag_name:"video",width:d.videoWidth||d.clientWidth||null,height:d.videoHeight||d.clientHeight||null,alt:"",preview_url:d.poster||"",source:$(u),download_via:"yt-dlp"};t.sendMessageSafe({type:"atlas-react",payload:b},L=>{if(!L||!L.ok){t.showToast(L?.error||"Reaction failed.");return}t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const h={type:"dislike",url:f.url,original_url:f.url,referrer_url:window.location.href,page_title:M(document.title,500),tag_name:f.tag_name,width:f.width,height:f.height,alt:M(f.alt||"",500),preview_url:f.preview_url||"",source:$(f.url)};t.sendMessageSafe({type:"atlas-react",payload:h},i=>{if(!i||!i.ok){t.showToast(i?.error||"Reaction failed.");return}t.showToast("Disliked.")})},!0)}function mt(t,n,r){return t<n?n:t>r?r:t}function pt(t,n){const r=V(t);if(r)return{type:n,url:r.url,original_url:r.url,referrer_url:window.location.href,page_title:M(document.title,500),tag_name:r.tag_name,width:r.width,height:r.height,alt:M(r.alt||"",500),preview_url:r.preview_url||"",source:$(r.url)};if(t instanceof HTMLVideoElement){const a=(t.currentSrc||t.src||"").trim().toLowerCase();if(a.startsWith("blob:")||a.startsWith("data:")){const o=window.location.href,p=`${o}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`;return{type:n,url:o,original_url:p,referrer_url:o,page_title:M(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:$(o),download_via:"yt-dlp"}}}return null}function gt(t){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");let r=null,a=null;const o=()=>{a&&(window.clearTimeout(a),a=null)},p=()=>{r=null,n.classList.remove("open"),n.style.left="",n.style.top=""},l=()=>{o(),a=window.setTimeout(()=>{n.matches(":hover")||p()},140)},E=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of it){const u=document.createElement("button");u.type="button",u.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),u.setAttribute("aria-label",i.label),u.title=i.label,u.replaceChildren(lt(i.pathDs)),u.addEventListener("pointerdown",E,!0),u.addEventListener("mousedown",E,!0),u.addEventListener("click",y=>{if(E(y),!r){t.showToast("No media selected.");return}const b=pt(r,i.type);if(!b){t.showToast("No valid media URL found.");return}t.sendMessageSafe({type:"atlas-react",payload:b},L=>{if(!L||!L.ok){t.showToast(L?.error||"Reaction failed.");return}if(b.download_via==="yt-dlp"){t.showToast(`Reacted (${i.type}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${i.type}). Queued download in Atlas.`)})}),n.appendChild(u)}t.root.appendChild(n);const d=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(y=>y instanceof HTMLElement&&y.id===C),f=()=>{if(!r)return;const i=r.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){p();return}const u=mt(i.top+8,8,window.innerHeight-8),y=mt(i.right-8,8,window.innerWidth-8);n.style.top=`${u}px`,n.style.left=`${y}px`},h=i=>{if(t.isSheetOpen()){p();return}if(!!!pt(i,"like")){p();return}r=i,n.classList.add("open"),f()};document.addEventListener("pointerover",i=>{if(t.isSheetOpen()||!(i.target instanceof Element)||d(i))return;const u=i.target.closest?.("img, video")??null;u&&(o(),h(u))},!0),document.addEventListener("pointerout",i=>{!r||t.isSheetOpen()||!(i.target instanceof Element)||d(i)||!(i.target.closest?.("img, video")??null)||l()},!0),n.addEventListener("pointerenter",o,!0),n.addEventListener("pointerleave",l,!0),window.addEventListener("scroll",f,!0),window.addEventListener("resize",f),window.addEventListener("blur",p)}})()})();
