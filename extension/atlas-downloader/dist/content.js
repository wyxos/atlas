(function(){"use strict";const je=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function Ve(ce){const ae=(ce||"").trim().toLowerCase();if(!ae)return"";const U=ae.split(".").filter(Boolean);if(U.length<=2)return ae;const z=U.slice(-2).join("."),ue=U.slice(-3).join(".");return je.has(z)&&U.length>=3?ue:z}function ze(ce){const ae=(ce||"").trim();if(!ae)return"";try{const U=new URL(ae).hostname;return Ve(U)}catch{return""}}(()=>{const U="atlas-downloader-root",z="atlas-open",ue=(()=>{try{return window.top===window.self}catch{return!1}})(),Ee=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let Ae=null;const Te=3e4,X=new Map,Le="http://www.w3.org/2000/svg",fe=t=>{const a=document.createElementNS(Le,"svg");a.setAttribute("viewBox","0 0 24 24"),a.setAttribute("aria-hidden","true"),a.setAttribute("fill","none"),a.setAttribute("stroke-width","2"),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round"),a.setAttribute("width","18"),a.setAttribute("height","18");for(const l of t){const o=document.createElementNS(Le,"path");o.setAttribute("d",l),o.setAttribute("fill","none"),o.setAttribute("stroke","currentColor"),o.setAttribute("stroke-width","2"),o.setAttribute("stroke-linecap","round"),o.setAttribute("stroke-linejoin","round"),a.appendChild(o)}return a},we=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],K={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Ce="atlas-downloader-page-markers";function F(t,a){const l=typeof t=="string"?t:"";return l.length<=a?l:l.slice(0,a)}function G(t){return ze(t)||"Extension"}function Se(t){const a=X.get(t);return a?Date.now()-a.ts>Te?(X.delete(t),null):a:null}function he(t,a,l){if(!a){l(null);return}const o=Se(a);if(o){l(o);return}t({type:"atlas-check-batch",urls:[a]},n=>{if(!n||!n.ok){l(null);return}const h=Array.isArray(n.data?.results)?n.data.results:[],b=h.find(L=>L?.url===a)??h[0]??null;if(!b){l(null);return}const c={exists:!!b.exists,downloaded:!!b.downloaded,blacklisted:!!b.blacklisted,reactionType:b.reaction?.type?String(b.reaction.type):null,ts:Date.now()};X.set(a,c),l(c)})}chrome.runtime.onMessage.addListener(t=>{if(!(!t||typeof t!="object"||t.type!=="atlas-open-sheet")&&ue)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],l=>{const o=ke(l.atlasBaseUrl||"");if(o&&ve(window.location.hostname,o))return;const n=Be(l.atlasExcludedDomains||"");Re(window.location.hostname,n)||(xe(),Ae?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const a=ke(t.atlasBaseUrl||"");if(a&&ve(window.location.hostname,a))return;const l=Be(t.atlasExcludedDomains||"");Re(window.location.hostname,l)||(ue?xe():Qe())});function Qe(){if(document.getElementById(U))return;const t=document.createElement("div");t.id=U;const a=t.attachShadow({mode:"closed"}),l=document.createElement("link");l.rel="stylesheet",l.href=chrome.runtime.getURL("dist/content.css"),a.appendChild(l);const o=document.createElement("div");o.className="atlas-shadow-root";const n=De(o),h=Ne(o),b=(c,L)=>{try{chrome.runtime.sendMessage(c,L)}catch(s){(()=>{if(s instanceof Error)return s.message;if(s&&typeof s=="object"&&"message"in s){const y=s.message;return typeof y=="string"?y:String(y)}return String(s)})().includes("Extension context invalidated")?n("Atlas extension was reloaded. Refresh this tab.","danger"):n("Atlas extension error. Refresh this tab.","danger"),L(null)}};a.appendChild(o),(document.body||document.documentElement).appendChild(t),$e({showToast:n,sendMessageSafe:b,isSheetOpen:()=>!1,chooseDialog:h}),Ue({root:o,showToast:n,sendMessageSafe:b,isSheetOpen:()=>!1,chooseDialog:h})}function xe(){if(document.getElementById(U))return;const t=document.createElement("div");t.id=U;const a=t.attachShadow({mode:"closed"}),l=document.createElement("link");l.rel="stylesheet",l.href=chrome.runtime.getURL("dist/content.css"),a.appendChild(l);const o=document.createElement("div");o.className="atlas-shadow-root";const n=De(o),h=(e,u)=>{try{chrome.runtime.sendMessage(e,u)}catch(r){(()=>{if(r instanceof Error)return r.message;if(r&&typeof r=="object"&&"message"in r){const d=r.message;return typeof d=="string"?d:String(d)}return String(r)})().includes("Extension context invalidated")?n("Atlas extension was reloaded. Refresh this tab.","danger"):n("Atlas extension error. Refresh this tab.","danger"),u(null)}},b=document.createElement("button");b.className="atlas-downloader-toggle",b.type="button",b.setAttribute("aria-label","Atlas Downloader"),b.title="Atlas Downloader";const c=document.createElement("img");c.alt="",c.src=chrome.runtime.getURL("icon.svg"),b.appendChild(c);const L=document.createElement("div");L.className="atlas-downloader-overlay";const s=document.createElement("div");s.className="atlas-downloader-modal",s.setAttribute("role","dialog"),s.setAttribute("aria-modal","true"),s.setAttribute("aria-label","Atlas Media Picker");const m=document.createElement("div");m.className="atlas-downloader-header";const y=document.createElement("div");y.className="atlas-downloader-title",y.textContent="Atlas Media Picker";const _=document.createElement("div");_.className="atlas-downloader-version",_.textContent=Ee?`v${Ee}`:"";const E=document.createElement("button");E.type="button",E.className="atlas-downloader-close",E.setAttribute("aria-label","Close"),E.textContent="x",m.appendChild(y),m.appendChild(_),m.appendChild(E);const v=document.createElement("div");v.className="atlas-downloader-toolbar";const C=ie("Rescan",()=>We()),S=ie("Check Atlas",()=>Fe(!1));let N=!1,x=null;const W=ie("Debug: off",()=>{N=!N,W.textContent=N?"Debug: on":"Debug: off",N?!x&&p.length>0&&(x={url:p[0].url,reactionType:"like"}):x=null,$(),R(P())}),I=ie("Select all",()=>Oe(!0)),q=ie("Select none",()=>Oe(!1)),re=document.createElement("span");re.className="spacer";const i=ie("Queue selected",()=>dt(),{primary:!0});v.appendChild(C),v.appendChild(S),v.appendChild(W),v.appendChild(I),v.appendChild(q),v.appendChild(re),v.appendChild(i);const w=document.createElement("div");w.className="atlas-downloader-meta";const D=document.createElement("div");D.className="atlas-downloader-list",s.appendChild(m),s.appendChild(v),s.appendChild(w),s.appendChild(D),o.appendChild(b),o.appendChild(L),o.appendChild(s),a.appendChild(o),(document.body||document.documentElement).appendChild(t);const B=Ne(o);let p=[],J=0,Q=null,Y=null;const ee=!0;let se=!1;b.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),ne()}),L.addEventListener("click",()=>le()),E.addEventListener("click",()=>le()),document.addEventListener("keydown",e=>{const u=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&u==="a"){e.preventDefault(),o.classList.contains(z)||ne();return}if(e.key==="Escape"&&o.classList.contains(z)){le();return}if(!o.classList.contains(z))return;const r=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!r)return;const f=p.find(d=>d.selected)??p[0]??null;f&&(e.preventDefault(),_e(f,r,{closeOnSuccess:!0}))});function ne(){o.classList.add(z),We()}function le(){o.classList.remove(z)}Ae=ne,$e({showToast:n,sendMessageSafe:h,isSheetOpen:()=>o.classList.contains(z),chooseDialog:B,setHintShown:e=>{se=e},getHintShown:()=>se,enabled:ee}),Ue({root:o,showToast:n,sendMessageSafe:h,isSheetOpen:()=>o.classList.contains(z),chooseDialog:B});const pe=(e=300)=>{Y!==null&&window.clearTimeout(Y),Y=window.setTimeout(()=>{Y=null,ut()},e)};new MutationObserver(()=>{Z(p),pe(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>pe(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&pe(120)},!0),pe(120);function ie(e,u,r){const f=document.createElement("button");return f.type="button",f.className=`atlas-downloader-btn${r?.primary?" primary":""}`,f.textContent=e,f.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),u()}),f}function at(e){w.textContent=e,i.disabled=!0,C.disabled=!0,S.disabled=!0,W.disabled=!0,I.disabled=!0,q.disabled=!0}function R(e){w.textContent=e;const u=p.filter(f=>f.selected).length,r=Q!==null;i.disabled=u===0||r,C.disabled=r,S.disabled=p.length===0||r,W.disabled=p.length===0,I.disabled=p.length===0||r,q.disabled=p.length===0||r}function We(){J+=1;const e=J;p=[],N&&(x=null),D.replaceChildren(),at("Scanning this page…"),Ze(u=>{J===e&&(w.textContent=`Scanning… ${u.scanned}/${u.total}`)}).then(u=>{J===e&&(p=u.map(r=>({...r,selected:!0,status:"",statusClass:"",atlas:null})),N&&!x&&p.length>0&&(x={url:p[0].url,reactionType:"like"}),$(),R(P()),Fe(!0))})}function Oe(e){for(const u of p)u.selected=e;$(),R(P())}function $(){if(D.replaceChildren(),p.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",D.appendChild(e);return}for(const e of p)D.appendChild(nt(e))}function nt(e){const u=document.createElement("div");u.className=`atlas-downloader-item${e.selected?" selected":""}`;const r=document.createElement("input");r.type="checkbox",r.checked=e.selected,r.addEventListener("change",()=>{e.selected=r.checked,u.classList.toggle("selected",e.selected),R(P())});const f=document.createElement("div");if(f.className="atlas-downloader-preview",e.preview_url){const T=document.createElement("img");T.loading="lazy",T.alt="",T.src=e.preview_url,f.appendChild(T)}const d=document.createElement("div");d.className="atlas-downloader-info";const g=document.createElement("div");g.className="atlas-downloader-kind",g.textContent=e.tag_name;const k=document.createElement("div");k.className="atlas-downloader-url",k.textContent=e.url,k.title=e.url;const A=document.createElement("div");A.className="atlas-downloader-sub",A.textContent=ot(e);const M=document.createElement("div");M.className="atlas-downloader-reactions";const H=e.atlas?.reaction?.type||null,oe=Q!==null;for(const T of we){const j=document.createElement("button");j.type="button",j.className=`atlas-downloader-reaction-btn ${T.className}${H===T.type?" active":""}${e.reactionPending===T.type?" pending":""}`.trim(),j.setAttribute("aria-label",T.label),j.title=T.label,j.replaceChildren(fe(T.pathDs)),j.disabled=oe,j.addEventListener("click",Ke=>{Ke.preventDefault(),Ke.stopPropagation(),N&&(x={url:e.url,reactionType:T.type},$()),_e(e,T.type)}),M.appendChild(j)}const V=document.createElement("button");if(V.type="button",V.className=`atlas-downloader-reaction-btn ${K.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===K.type?" pending":""}`.trim(),V.setAttribute("aria-label",K.label),V.title=K.label,V.replaceChildren(fe(K.pathDs)),V.disabled=oe,V.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation(),_e(e,"dislike",{blacklist:!0})}),M.appendChild(V),e.atlas?.downloaded){const T=document.createElement("button");T.type="button",T.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),T.setAttribute("aria-label","Delete download"),T.title="Delete download",T.replaceChildren(fe(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),T.disabled=oe,T.addEventListener("click",j=>{j.preventDefault(),j.stopPropagation(),it(e)}),M.appendChild(T)}d.appendChild(g),d.appendChild(k),d.appendChild(A),d.appendChild(M),N&&x?.url===e.url&&d.appendChild(lt(e,x.reactionType));const te=document.createElement("div"),Xe=st(e);return te.className=`atlas-downloader-status ${Xe.className}`.trim(),te.textContent=Xe.text,u.addEventListener("click",T=>{T.target instanceof HTMLInputElement||(N&&(x={url:e.url,reactionType:x?.reactionType??"like"}),e.selected=!e.selected,r.checked=e.selected,u.classList.toggle("selected",e.selected),R(P()))}),u.appendChild(r),u.appendChild(f),u.appendChild(d),u.appendChild(te),u}function Ie(e,u){return{type:u,url:e.url,original_url:e.original_url||e.url,referrer_url:e.referrer_url||window.location.href,page_title:F(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:F(e.alt||"",500),preview_url:e.preview_url||"",source:G(e.url),...e.download_via?{download_via:e.download_via}:{}}}function qe(e){return{url:e.url,original_url:e.original_url||e.url,referrer_url:e.referrer_url||window.location.href,page_title:F(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:F(e.alt||"",500),preview_url:e.preview_url||"",source:G(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function lt(e,u){const r=document.createElement("details");r.className="atlas-downloader-debug",r.open=!0;const f=document.createElement("summary");f.textContent="Debug payload",r.appendChild(f);const d=document.createElement("pre");return d.textContent=JSON.stringify({react:Ie(e,u),download:qe(e)},null,2),r.appendChild(d),r}function ot(e){const u=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",r=rt(e.url);return r?`${u} • ${r}`:u}function rt(e){try{return new URL(e).hostname}catch{return""}}function P(){const e=p.filter(u=>u.selected).length;return`${p.length} found • ${e} selected`}function st(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function Fe(e){const u=p.map(r=>r.url).filter(Boolean);u.length!==0&&h({type:"atlas-check-batch",urls:u},r=>{if(!r){e||n("Atlas extension did not respond.","danger");return}if(!r.ok){e||n(r.error||"Atlas check failed.","danger");return}const f=Array.isArray(r.data?.results)?r.data.results:[],d=new Map(f.map(A=>[A.url,A]));let g=0,k=0;for(const A of p){const M=d.get(A.url);M&&(A.atlas={exists:!!M.exists,downloaded:!!M.downloaded,blacklisted:!!M.blacklisted,file_id:M.file_id??null,reaction:M.reaction??null},M.exists&&(g+=1),M.downloaded&&(k+=1))}$(),R(P()),Z(p),e||n(`Atlas check: ${k}/${g} downloaded.`)})}function _e(e,u,r={}){const f=(g={})=>{e.reactionPending=r.blacklist?K.type:u,e.status="Reacting…",e.statusClass="",Q=e.url,$(),R(P());const k={...Ie(e,u),...g,...r.blacklist?{blacklist:!0}:{}};h({type:"atlas-react",payload:k},A=>{if(e.reactionPending=null,Q=null,!A){e.status="No response",e.statusClass="err",$(),R(P()),n("Atlas extension did not respond.","danger");return}if(!A.ok){e.status=A.error||"Failed",e.statusClass="err",$(),R(P()),n(A.error||"Reaction failed.","danger");return}const M=A.data||null,H=M?.file||null;e.atlas={exists:!!H,downloaded:!!H?.downloaded,blacklisted:!!H?.blacklisted_at,file_id:H?.id??null,reaction:M?.reaction??null},X.set(e.url,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&u!=="dislike"?(e.status="Queued",e.statusClass="queued"):(e.status="",e.statusClass=""),$(),R(P()),Z(p),r.closeOnSuccess&&le(),e.atlas.exists&&!e.atlas.downloaded&&u!=="dislike"&&ge([e.url],0)})},d=!!e.atlas?.reaction?.type;if(u!=="dislike"&&e.atlas?.downloaded&&d){B({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(g=>{f(g==="confirm"?{force_download:!0}:{})});return}if(u==="dislike"&&e.atlas?.downloaded){B({title:r.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(g=>{if(g==="alternate"){n("Cancelled.");return}f(g==="confirm"?{clear_download:!0}:{})});return}f()}function it(e){B({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(u=>{u==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",Q=e.url,$(),R(P()),h({type:"atlas-delete-download",payload:{url:e.url,original_url:e.original_url||e.url,tag_name:e.tag_name,download_via:e.download_via||null}},r=>{if(e.reactionPending=null,Q=null,!r||!r.ok){e.status=r?.error||"Failed",e.statusClass="err",$(),R(P()),n(r?.error||"Delete failed.","danger");return}const f=r.data?.file||null;e.atlas={exists:!!f,downloaded:!!f?.downloaded,blacklisted:!!f?.blacklisted_at,file_id:f?.id??null,reaction:e.atlas?.reaction??null},e.status="",e.statusClass="",$(),R(P()),Z(p),n("Download deleted.")}))})}function dt(){const e=p.filter(f=>f.selected);if(e.length===0){n("Select one or more items first.");return}if(e.some(f=>!!f.atlas?.downloaded)){B({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(f=>{if(f==="alternate"){n("Cancelled.");return}r(f==="confirm")});return}r(!1);function r(f){i.disabled=!0,C.disabled=!0,S.disabled=!0,I.disabled=!0,q.disabled=!0;for(const g of e)g.status="Sending…",g.statusClass="";$();const d=e.map(g=>{const k=qe(g);return f&&(k.force_download=!0),k});h({type:"atlas-download-batch",payloads:d},g=>{if(!g){for(const M of e)M.status="No response",M.statusClass="err";$(),R(P()),n("Atlas extension did not respond.","danger");return}const k=Array.isArray(g.results)?g.results:[],A=[];for(let M=0;M<e.length;M+=1){const H=e[M],oe=k[M];if(oe?.ok){const V=oe.data||null,te=V?.file||null;H.atlas={exists:!!te,downloaded:!!te?.downloaded,blacklisted:!!te?.blacklisted_at,file_id:te?.id??null,reaction:H.atlas?.reaction??null},V?.queued?(H.status="Queued",H.statusClass="queued",A.push(H.url)):(H.status="",H.statusClass="")}else H.status=oe?.error||"Failed",H.statusClass="err"}$(),R(P()),Z(p),g.ok?n(`Queued ${e.length} download(s) in Atlas.`):n(g.error||"Some requests failed.","danger"),A.length>0&&ge(A,0)})}}function ge(e,u){u>15||setTimeout(()=>{h({type:"atlas-check-batch",urls:e},r=>{if(!r||!r.ok){ge(e,u+1);return}const f=Array.isArray(r.data?.results)?r.data.results:[],d=new Map(f.map(k=>[k.url,k]));let g=0;for(const k of p){const A=d.get(k.url);A&&(k.atlas={exists:!!A.exists,downloaded:!!A.downloaded,blacklisted:!!A.blacklisted,file_id:A.file_id??null,reaction:A.reaction??null},A.downloaded?k.status==="Queued"&&(k.status="",k.statusClass=""):g+=1)}$(),R(P()),Z(p),g>0&&ge(e,u+1)})},2e3)}function Z(e=p){tt();const u=document.querySelectorAll('[data-atlas-marked="1"]');for(const d of u)d.removeAttribute("data-atlas-marked"),d.removeAttribute("data-atlas-state"),d.removeAttribute("data-atlas-reaction");const r=new Map;for(const[d,g]of X.entries()){if(Date.now()-g.ts>Te){X.delete(d);continue}r.set(d,{exists:!!g.exists,downloaded:!!g.downloaded,blacklisted:!!g.blacklisted,reactionType:g.reactionType?String(g.reactionType):null}),r.set(de(d),{exists:!!g.exists,downloaded:!!g.downloaded,blacklisted:!!g.blacklisted,reactionType:g.reactionType?String(g.reactionType):null})}for(const d of e){if(!d?.url||!d?.atlas)continue;const g=d.atlas?.reaction?.type?String(d.atlas.reaction.type):null,k={exists:!!d.atlas.exists,downloaded:!!d.atlas.downloaded,blacklisted:!!d.atlas.blacklisted,reactionType:g};r.set(d.url,k),r.set(de(d.url),k)}if(r.size===0)return;const f=document.querySelectorAll("img, video, a[href]");for(const d of f){const g=d instanceof HTMLImageElement?O(d.currentSrc)||O(d.src)||"":d instanceof HTMLVideoElement?be(d)||"":d instanceof HTMLAnchorElement&&O(d.href)||"";if(!g)continue;const k=r.get(g)||r.get(de(g));k&&(d.setAttribute("data-atlas-marked","1"),k.blacklisted?d.setAttribute("data-atlas-state","blacklisted"):k.reactionType?d.setAttribute("data-atlas-state","reacted"):k.downloaded?d.setAttribute("data-atlas-state","downloaded"):k.exists&&d.setAttribute("data-atlas-state","exists"),k.reactionType&&d.setAttribute("data-atlas-reaction",k.reactionType))}}function ct(){const e=new Set,u=document.querySelectorAll("img, video, a[href]");for(const f of u){const d=f instanceof HTMLImageElement?O(f.currentSrc)||O(f.src)||"":f instanceof HTMLVideoElement?be(f)||"":f instanceof HTMLAnchorElement&&O(f.href)||"";d&&(e.add(d),e.add(de(d)))}const r=Me();return r?.url&&(e.add(r.url),e.add(de(r.url))),[...e].filter(Boolean)}function ut(){const e=ct();if(e.length===0){Z(p);return}h({type:"atlas-check-batch",urls:e},u=>{if(!u?.ok){Z(p);return}const r=Array.isArray(u.data?.results)?u.data.results:[];for(const f of r)f?.url&&X.set(String(f.url),{exists:!!f.exists,downloaded:!!f.downloaded,blacklisted:!!f.blacklisted,reactionType:f.reaction?.type?String(f.reaction.type):null,ts:Date.now()});Z(p)})}}function Ze(t){return new Promise(a=>{const l=document.body||document.documentElement,o=Array.from(l.querySelectorAll("img, video")),n=o.length,h=new Set,b=[];let c=0;const L=m=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(m,{timeout:500});return}setTimeout(()=>m({timeRemaining:()=>25}),0)},s=m=>{const y=typeof m?.timeRemaining=="function"?m.timeRemaining():25;let _=0;for(;c<n&&(_<80||y>5);){const v=o[c];if(v.closest&&v.closest(`#${U}`)){c+=1,_+=1;continue}const C=me(v);C?.url&&!h.has(C.url)&&(h.add(C.url),b.push(C)),c+=1,_+=1}if(t?.({scanned:c,total:n}),c<n){L(s);return}const E=Me();E&&!h.has(E.url)&&(h.add(E.url),b.push(E)),a(b)};L(s)})}function me(t){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,l=a.naturalWidth||a.width||a.clientWidth||null,o=a.naturalHeight||a.height||a.clientHeight||null;if(l&&o&&(l<450||o<450))return null;const n=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),h=O(n);if(!h){const b=O(document.referrer)||"";return!b||!n.toLowerCase().startsWith("blob:")&&!n.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:b,original_url:b,referrer_url:n,preview_url:"",width:l,height:o,alt:a.alt||""}}return{tag_name:"img",url:h,original_url:h,referrer_url:window.location.href,preview_url:h,width:l,height:o,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=be(t);if(!a){const l=t,o=(l.currentSrc||l.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const n=window.location.href;return{tag_name:"video",url:n,original_url:`${n}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,referrer_url:n,preview_url:l.poster||"",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:a,original_url:a,referrer_url:window.location.href,preview_url:t.poster||"",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:""}}return null}function Me(){const t=(window.location.href||"").trim();if(!t)return null;const a=t.toLowerCase(),l=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(a),o=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!l&&!o)return null;if(a.startsWith("http://")||a.startsWith("https://"))return{tag_name:a.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,original_url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(a.startsWith("blob:")||a.startsWith("data:")){const n=O(document.referrer)||"";return n?{tag_name:"img",url:n,original_url:n,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function be(t){const a=O(t.currentSrc)||O(t.src)||O(t.getAttribute("src"));if(a)return a;const l=t.querySelector("source[src]"),o=l?O(l.src||l.getAttribute("src")):"";if(o)return o;const n=Je(t);return n||Ge()}function Ge(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const a of t){const o=document.querySelector(a)?.getAttribute("content"),n=O(o||"");if(n)return n}return""}function Je(t){let a=t,l=0;for(;a&&l<8;){const o=a.getAttribute?.("data-store");if(o){const n=Ye(o),h=ye(n,0);if(h)return h}a=a.parentElement,l+=1}return""}function Ye(t){if(!t)return null;const a=et(t);try{return JSON.parse(a)}catch{return null}}function et(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function ye(t,a){if(!t||a>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const o of t){const n=ye(o,a+1);if(n)return n}return""}if(typeof t!="object")return"";const l=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const o of l){const n=t[o];if(typeof n=="string"&&n.startsWith("http"))return n}for(const o of Object.keys(t)){const n=ye(t[o],a+1);if(n)return n}return""}function De(t){return function(l,o="info"){const n=document.createElement("div");n.className=`atlas-downloader-toast${o==="danger"?" danger":""}`,n.textContent=l,t.appendChild(n),requestAnimationFrame(()=>n.classList.add("show")),setTimeout(()=>{n.classList.remove("show"),n.addEventListener("transitionend",()=>n.remove(),{once:!0})},2600)}}function Ne(t){return a=>new Promise(l=>{const o=document.createElement("div");o.className="atlas-downloader-dialog-backdrop";const n=document.createElement("div");n.className=`atlas-downloader-dialog${a.danger?" danger":""}`.trim(),n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true"),n.setAttribute("aria-label",a.title);const h=document.createElement("h3");h.className="atlas-downloader-dialog-title",h.textContent=a.title;const b=document.createElement("p");b.className="atlas-downloader-dialog-message",b.textContent=a.message;const c=document.createElement("div");c.className="atlas-downloader-dialog-actions";const L=y=>{o.remove(),l(y)};if(a.alternateLabel){const y=document.createElement("button");y.type="button",y.className="atlas-downloader-dialog-btn secondary",y.textContent=a.alternateLabel,y.addEventListener("click",()=>L("alternate")),c.appendChild(y)}const s=document.createElement("button");s.type="button",s.className="atlas-downloader-dialog-btn",s.textContent=a.cancelLabel||"Cancel",s.addEventListener("click",()=>L("cancel")),c.appendChild(s);const m=document.createElement("button");m.type="button",m.className=`atlas-downloader-dialog-btn primary${a.danger?" danger":""}`.trim(),m.textContent=a.confirmLabel,m.addEventListener("click",()=>L("confirm")),c.appendChild(m),n.appendChild(h),n.appendChild(b),n.appendChild(c),o.appendChild(n),t.appendChild(o),requestAnimationFrame(()=>{m.focus()})})}function tt(){if(document.getElementById(Ce))return;const t=document.createElement("style");t.id=Ce,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 2px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 2px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 2px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 2px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 2px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: 2px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 2px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: 2px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function de(t){const a=t.indexOf("#");return a===-1?t:t.slice(0,a)}function Be(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(a=>a.trim()).filter(a=>a&&!a.startsWith("#")).map(a=>(a.startsWith("*.")?a.slice(2):a).toLowerCase()).map(a=>ke(a)||a.replace(/^\.+/,"").trim()).filter(Boolean)}function Re(t,a){const l=(t||"").toLowerCase();if(!l)return!1;for(const o of a)if(ve(l,o))return!0;return!1}function ke(t){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const l=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(l).hostname}catch{return""}}function ve(t,a){return!t||!a?!1:t===a||t.endsWith(`.${a}`)}function O(t){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const l=a.toLowerCase();return l.startsWith("blob:")||l.startsWith("data:")||l.startsWith("chrome-extension:")||l.startsWith("moz-extension:")||l.startsWith("safari-extension:")?"":a}function $e(t){const a=t.enabled??!0,l=t.getHintShown??(()=>!1),o=t.setHintShown??(()=>{}),n=()=>{l()||(o(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},h=(c,L,s)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:c,pending:L,reactionType:s}}))},b=c=>(typeof c.composedPath=="function"?c.composedPath():[]).some(s=>s instanceof HTMLElement&&s.id===U);document.addEventListener("click",c=>{!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||b(c)||!((c.target instanceof Element?c.target:null)?.closest?.("img, video")??null)||(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())},!0),document.addEventListener("mousedown",c=>{if(!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||b(c))return;const s=(c.target instanceof Element?c.target:null)?.closest?.("img, video")??null;if(!s)return;const m=c.button===0?"like":c.button===1?"love":null;if(!m)return;n(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const y=me(s);if(!y){if(s instanceof HTMLVideoElement){const E=(s.currentSrc||s.src||"").trim().toLowerCase();if(E.startsWith("blob:")||E.startsWith("data:")){const v=window.location.href,C=`${v}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,S={type:m,url:v,original_url:C,referrer_url:v,page_title:F(document.title,500),tag_name:"video",width:s.videoWidth||s.clientWidth||null,height:s.videoHeight||s.clientHeight||null,alt:"",preview_url:s.poster||"",source:G(v),download_via:"yt-dlp"};he(t.sendMessageSafe,S.url,N=>{if(N?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(x=>{h(s,!0,m),x==="confirm"&&(S.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:S},W=>{if(!W||!W.ok){h(s,!1,null),t.showToast(W?.error||"Reaction failed.","danger");return}const I=W.data||null,q=I?.file||null,re=I?.reaction?.type?String(I.reaction.type):m;X.set(S.url,{exists:!!q,downloaded:!!q?.downloaded,blacklisted:!!q?.blacklisted_at,reactionType:re,ts:Date.now()}),h(s,!1,re),t.showToast(`Reacted (${m}). Resolving video in Atlas…`)})});return}h(s,!0,m),t.sendMessageSafe({type:"atlas-react",payload:S},x=>{if(!x||!x.ok){h(s,!1,null),t.showToast(x?.error||"Reaction failed.","danger");return}const W=x.data||null,I=W?.file||null,q=W?.reaction?.type?String(W.reaction.type):m;X.set(S.url,{exists:!!I,downloaded:!!I?.downloaded,blacklisted:!!I?.blacklisted_at,reactionType:q,ts:Date.now()}),h(s,!1,q),t.showToast(`Reacted (${m}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const _={type:m,url:y.url,original_url:y.url,referrer_url:window.location.href,page_title:F(document.title,500),tag_name:y.tag_name,width:y.width,height:y.height,alt:F(y.alt||"",500),preview_url:y.preview_url||"",source:G(y.url)};he(t.sendMessageSafe,_.url,E=>{if(E?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(v=>{h(s,!0,m),v==="confirm"&&(_.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:_},C=>{if(!C||!C.ok){h(s,!1,null),t.showToast(C?.error||"Reaction failed.","danger");return}const S=C.data||null,N=S?.file||null,x=S?.reaction?.type?String(S.reaction.type):m;X.set(_.url,{exists:!!N,downloaded:!!N?.downloaded,blacklisted:!!N?.blacklisted_at,reactionType:x,ts:Date.now()}),h(s,!1,x),t.showToast(`Reacted (${m}). Queued download in Atlas.`)})});return}h(s,!0,m),t.sendMessageSafe({type:"atlas-react",payload:_},v=>{if(!v||!v.ok){h(s,!1,null),t.showToast(v?.error||"Reaction failed.","danger");return}const C=v.data||null,S=C?.file||null,N=C?.reaction?.type?String(C.reaction.type):m;X.set(_.url,{exists:!!S,downloaded:!!S?.downloaded,blacklisted:!!S?.blacklisted_at,reactionType:N,ts:Date.now()}),h(s,!1,N),t.showToast(`Reacted (${m}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",c=>{if(!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||b(c))return;const s=(c.target instanceof Element?c.target:null)?.closest?.("img, video")??null;if(!s)return;n(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const m=me(s);if(!m){if(s instanceof HTMLVideoElement){const _=(s.currentSrc||s.src||"").trim().toLowerCase();if(_.startsWith("blob:")||_.startsWith("data:")){const E=window.location.href,v=`${E}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`,C={type:"dislike",url:E,original_url:v,referrer_url:E,page_title:F(document.title,500),tag_name:"video",width:s.videoWidth||s.clientWidth||null,height:s.videoHeight||s.clientHeight||null,alt:"",preview_url:s.poster||"",source:G(E),download_via:"yt-dlp"};h(s,!0,"dislike"),t.sendMessageSafe({type:"atlas-react",payload:C},S=>{if(!S||!S.ok){h(s,!1,null),t.showToast(S?.error||"Reaction failed.","danger");return}h(s,!1,"dislike"),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const y={type:"dislike",url:m.url,original_url:m.url,referrer_url:window.location.href,page_title:F(document.title,500),tag_name:m.tag_name,width:m.width,height:m.height,alt:F(m.alt||"",500),preview_url:m.preview_url||"",source:G(m.url)};h(s,!0,"dislike"),t.sendMessageSafe({type:"atlas-react",payload:y},_=>{if(!_||!_.ok){h(s,!1,null),t.showToast(_?.error||"Reaction failed.","danger");return}h(s,!1,"dislike"),t.showToast("Disliked.")})},!0)}function Pe(t,a,l){return t<a?a:t>l?l:t}function He(t,a){const l=me(t);if(l)return{type:a,url:l.url,original_url:l.url,referrer_url:window.location.href,page_title:F(document.title,500),tag_name:l.tag_name,width:l.width,height:l.height,alt:F(l.alt||"",500),preview_url:l.preview_url||"",source:G(l.url)};if(t instanceof HTMLVideoElement){const o=(t.currentSrc||t.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const n=window.location.href,h=`${n}#atlas-ext-video=${Date.now()}-${Math.random().toString(16).slice(2)}`;return{type:a,url:n,original_url:h,referrer_url:n,page_title:F(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:G(n),download_via:"yt-dlp"}}}return null}function Ue(t){const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");let l=null,o=null,n=null,h=!1,b=-1,c=-1,L=null;const s=new Map,m=(i,w=null)=>{h=i;for(const[D,B]of s.entries())B.disabled=i,B.classList.toggle("pending",i&&w===D)},y=i=>{for(const w of[...we,K]){const D=s.get(w.type);if(!D)continue;const B=w.type===K.type?i==="dislike":i===w.type;D.classList.toggle("active",B)}},_=()=>{n&&(window.clearTimeout(n),n=null)},E=()=>{h||(l=null,o=null,a.classList.remove("open"),a.style.left="",a.style.top="",y(null))},v=()=>{_(),n=window.setTimeout(()=>{a.matches(":hover")||E()},140)},C=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of[...we,K]){const w=document.createElement("button");w.type="button",w.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),w.setAttribute("aria-label",i.label),w.title=i.label,w.replaceChildren(fe(i.pathDs)),s.set(i.type,w),w.addEventListener("pointerdown",C,!0),w.addEventListener("mousedown",C,!0),w.addEventListener("click",D=>{if(C(D),h)return;if(!l){t.showToast("No media selected.");return}const B=i.type===K.type?"dislike":i.type,p=He(l,B);if(!p){t.showToast("No valid media URL found.");return}const J=p.url||"",Q=(Y=!1)=>{Y?p.force_download=!0:"force_download"in p&&delete p.force_download,m(!0,i.type),t.sendMessageSafe({type:"atlas-react",payload:{...p,...i.type===K.type?{blacklist:!0}:{}}},ee=>{if(m(!1,null),!ee||!ee.ok){t.showToast(ee?.error||"Reaction failed.","danger");return}const se=ee.data||null,ne=se?.file||null,le=se?.reaction?.type?String(se.reaction.type):i.type===K.type?"dislike":i.type;if(J&&X.set(J,{exists:!!ne,downloaded:!!ne?.downloaded,blacklisted:!!ne?.blacklisted_at,reactionType:le,ts:Date.now()}),y(le),p.download_via==="yt-dlp"){t.showToast(`Reacted (${i.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${i.label}). Queued download in Atlas.`)})};he(t.sendMessageSafe,J,Y=>{if(B!=="dislike"&&Y?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(ee=>{Q(ee==="confirm")});return}Q(!1)})}),a.appendChild(w)}t.root.appendChild(a);const S=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(D=>D instanceof HTMLElement&&D.id===U),N=()=>{if(!l)return;const i=l.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){E();return}const w=Pe(i.top+8,8,window.innerHeight-8),D=Pe(i.right-8,8,window.innerWidth-8);a.style.top=`${w}px`,a.style.left=`${D}px`},x=i=>{if(t.isSheetOpen()){E();return}const w=He(i,"like");if(!w){E();return}if(l=i,o=w.url||null,a.classList.add("open"),N(),y(null),o){const D=Se(o);if(D)y(D.reactionType);else{const B=o;he(t.sendMessageSafe,B,p=>{p&&o===B&&y(p.reactionType)})}}},W=i=>i?i==="blacklist"?"blacklist":i:null,I=()=>{if(b<0||c<0||t.isSheetOpen())return;const i=document.elementFromPoint(b,c);if(!(i instanceof Element)||i.closest?.(`#${U}`))return;const w=i.closest?.("img, video")??null;w&&(_(),x(w))},q=(i=80)=>{L!==null&&window.clearTimeout(L),L=window.setTimeout(()=>{L=null,I()},i)};document.addEventListener("pointerover",i=>{if(t.isSheetOpen()||!(i.target instanceof Element)||S(i))return;const w=i.target.closest?.("img, video")??null;w&&(_(),x(w))},!0),window.addEventListener("atlas-shortcut-reaction-state",i=>{const w=i,D=w.detail?.media;if(!(D instanceof Element))return;_(),x(D);const B=!!w.detail?.pending,p=W(w.detail?.reactionType??null);if(B){m(!0,p);return}m(!1,null),p&&y(p==="blacklist"?"dislike":p)},!0),document.addEventListener("pointermove",i=>{b=i.clientX,c=i.clientY},!0),document.addEventListener("pointerout",i=>{!l||t.isSheetOpen()||!(i.target instanceof Element)||S(i)||!(i.target.closest?.("img, video")??null)||v()},!0),a.addEventListener("pointerenter",_,!0),a.addEventListener("pointerleave",v,!0),window.addEventListener("scroll",N,!0),window.addEventListener("resize",N),window.addEventListener("blur",E),window.addEventListener("focus",()=>q(40),!0),new MutationObserver(()=>{q(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
