(function(){"use strict";const wt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function gt(t){const n=(t||"").trim().toLowerCase();if(!n)return"";const a=n.split(".").filter(Boolean);if(a.length<=2)return n;const r=a.slice(-2).join("."),o=a.slice(-3).join(".");return wt.has(r)&&a.length>=3?o:r}function bt(t){const n=(t||"").trim();if(!n)return"";try{const a=new URL(n).hostname;return gt(a)}catch{return""}}function yt(t,n){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const r=a.toLowerCase();if(r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:"))return"";try{const o=new URL(a,n);return o.protocol!=="http:"&&o.protocol!=="https:"?"":o.toString()}catch{return""}}const kt=Qe(["host:st.deviantart.net","url:*wixmp.com*/crop/w_92,h_92*","url:*wixmp.com*/crop/w_150,h_150*","url:*wixmp.com*/fit/w_150,h_150*"].join(`
`));let Pe=[];function le(t){return yt(t,window.location.href)}function Ie(t){Pe=Qe(t)}function Ue(t){const n=le(t.currentSrc)||le(t.src)||le(t.getAttribute("src")||"");if(n)return n;const a=t.querySelector("source[src]"),r=a?le(a.src||a.getAttribute("src")||""):"";if(r)return r;const o=_t(t);return o||Et()}function be(t,n){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,r=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),o=le(r);if(o&&xe(o))return null;const{width:w,height:f}=At(a,o||r),S=w??he(a.clientWidth),$=f??he(a.clientHeight);if(S&&S<n||$&&$<n)return null;if(!o){const c=le(document.referrer)||le(window.location.href)||"";return!c||!r.toLowerCase().startsWith("blob:")&&!r.toLowerCase().startsWith("data:")||xe(c)?null:{tag_name:"img",url:c,referrer_url:window.location.href,preview_url:"",width:w,height:f,alt:a.alt||""}}return{tag_name:"img",url:o,referrer_url:window.location.href,preview_url:o,width:w,height:f,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=t,r=a.videoWidth||a.clientWidth||null,o=a.videoHeight||a.clientHeight||null;if(r&&o&&(r<n||o<n))return null;const w=Ue(a);if(w&&xe(w))return null;if(!w){const f=(a.currentSrc||a.src||"").trim().toLowerCase();if(f.startsWith("blob:")||f.startsWith("data:")){const S=window.location.href;return{tag_name:"video",url:S,referrer_url:S,preview_url:a.poster||"",width:r,height:o,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:w,referrer_url:window.location.href,preview_url:a.poster||"",width:r,height:o,alt:""}}return null}function He(){const t=(window.location.href||"").trim();if(!t)return null;const n=t.toLowerCase(),a=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(n),r=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!a&&!r)return null;if(n.startsWith("http://")||n.startsWith("https://"))return{tag_name:n.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(n.startsWith("blob:")||n.startsWith("data:")){const o=le(document.referrer)||"";return o?{tag_name:"img",url:o,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function $e(t){const n=new Set,a=le(window.location.href),r=t instanceof HTMLImageElement?le(t.currentSrc)||le(t.src)||"":t instanceof HTMLVideoElement?Ue(t)||"":t instanceof HTMLAnchorElement&&We(t.getAttribute("href")||"")||"";r&&n.add(r);const o=t.closest("a[href]")?.getAttribute("href")??"",w=We(o);return w&&n.add(w),a&&vt(t)&&n.add(a),[...n]}function We(t){const n=(t||"").trim();return!n||n.startsWith("#")||n.toLowerCase().startsWith("javascript:")?"":le(n)}function vt(t){if(t instanceof HTMLImageElement){const n=(t.currentSrc||t.src||t.getAttribute("src")||"").trim().toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")}if(t instanceof HTMLVideoElement){const n=(t.currentSrc||t.src||"").trim().toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")}return!1}function Et(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const n of t){const r=document.querySelector(n)?.getAttribute("content")||"",o=le(r);if(o)return o}return""}function _t(t){let n=t,a=0;for(;n&&a<8;){const r=n.getAttribute?.("data-store");if(r){const o=Lt(r),w=Ce(o,0);if(w)return w}n=n.parentElement,a+=1}return""}function Lt(t){if(!t)return null;const n=St(t);try{return JSON.parse(n)}catch{return null}}function St(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Ce(t,n){if(!t||n>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const a of t){const r=Ce(a,n+1);if(r)return r}return""}if(typeof t=="object")for(const a of Object.keys(t)){const r=t[a],o=Ce(r,n+1);if(o)return o}return""}function At(t,n){const a=he(t.naturalWidth),r=he(t.naturalHeight),o=he(t.clientWidth),w=he(t.clientHeight),f=Ct(n),S=Fe(t.getAttribute("width")),$=Fe(t.getAttribute("height"));return{width:je(a,o,f.width,S),height:je(r,w,f.height,$)}}function Ct(t){const n=(t||"").trim();if(!n)return{width:null,height:null};const a=Oe(n,[/(?:^|[/,?&_=-])w_(\d{2,5})(?=$|[/,?&_=-])/i]),r=Oe(n,[/(?:^|[/,?&_=-])h_(\d{2,5})(?=$|[/,?&_=-])/i]);let o=a;const w=r,f=n.match(/-(\d{2,5})w-(\d)x(?=$|[./?&_-])/i);if(f){const S=parseInt(f[1],10),$=parseInt(f[2],10),c=he(S*$);c&&(!o||c>o)&&(o=c)}return{width:o??null,height:w??null}}function Oe(t,n){for(const a of n){const r=t.match(a);if(!r||!r[1])continue;const o=he(parseInt(r[1],10));if(o)return o}return null}function Fe(t){if(!t)return null;const n=t.trim();if(!n)return null;const a=n.match(/^\d+/)?.[0]??"";return a?he(parseInt(a,10)):null}function je(t,n,a,r){return t||n||a||r}function he(t){if(typeof t!="number"||!Number.isFinite(t))return null;const n=Math.round(t);return n>0?n:null}function xe(t){const n=(t||"").trim().toLowerCase();if(!n)return!1;const a=[...kt,...Pe],r=xt(n);for(const o of a){if(o.kind==="host"){if(Tt(r,o.host))return!0;continue}if(o.kind==="urlPattern"){if(o.regex.test(n))return!0;continue}if(n.includes(o.needle))return!0}return!1}function xt(t){try{return new URL(t).hostname.toLowerCase()}catch{return""}}function Tt(t,n){const a=(t||"").trim().toLowerCase(),r=(n||"").trim().toLowerCase();return!a||!r?!1:a===r||a.endsWith(`.${r}`)}function Qe(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n!==""&&!n.startsWith("#")).map(n=>Mt(n)).filter(n=>n!==null)}function Mt(t){const n=t.trim();if(!n)return null;const a=n.toLowerCase();if(a.startsWith("host:")){const o=ze(n.slice(5));return o?{kind:"host",host:o}:null}if(a.startsWith("url:"))return qe(n.slice(4));const r=ze(n);return r?{kind:"host",host:r}:qe(n)}function qe(t){const n=t.trim().toLowerCase();if(!n)return null;if(!n.includes("*"))return{kind:"urlContains",needle:n};const a=Nt(n);try{return{kind:"urlPattern",regex:new RegExp(a,"i")}}catch{return null}}function Nt(t){return t.split("*").map(n=>Dt(n)).join(".*")}function Dt(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ze(t){const n=(t||"").trim();if(!n)return"";const a=n.startsWith("*.")?n.slice(2):n,r=/^https?:\/\//i.test(a)?a:`https://${a}`;try{return new URL(r).hostname.toLowerCase()}catch{return""}}const Ke="http://www.w3.org/2000/svg",Ee=t=>{const n=document.createElementNS(Ke,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const a of t){const r=document.createElementNS(Ke,"path");r.setAttribute("d",a),r.setAttribute("fill","none"),r.setAttribute("stroke","currentColor"),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round"),n.appendChild(r)}return n},_e=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],J={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Ve="atlas-location-change";function Te(t,n){return!!t.closest?.(`#${n}`)}function Bt(t,n,a){const r=t.querySelectorAll?.("img, video");if(!r||r.length===0)return null;let o=null;for(const w of r){const f=w.getBoundingClientRect();if(f.width<=0||f.height<=0||n<f.left||n>f.right||a<f.top||a>f.bottom)continue;const S=f.width*f.height;(!o||S>o.area)&&(o={media:w,area:S})}return o}function Xe(t,n,a){const o=(document.elementsFromPoint?.(t,n)??[]).filter(f=>f instanceof Element);if(o.length===0){const f=document.elementFromPoint?.(t,n);f instanceof Element&&o.push(f)}for(const f of o){if(Te(f,a))continue;if(f.matches("img, video"))return f;const S=f.closest?.("img, video");if(S instanceof Element&&!Te(S,a))return S}let w=null;for(const f of o){if(Te(f,a))continue;const S=Bt(f,t,n);S&&(!w||S.area>w.area)&&(w=S)}return w?.media??null}function Ze(t,n){const a=t.enabled??!0,r=t.getHintShown??(()=>!1),o=t.setHintShown??(()=>{}),w=()=>{r()||(o(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},f=(c,h,b,M=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:c,pending:h,reactionType:b,url:M}}))},S=c=>(typeof c.composedPath=="function"?c.composedPath():[]).some(b=>b instanceof HTMLElement&&b.id===n.rootId),$=c=>{const b=(c.target instanceof Element?c.target:null)?.closest?.("img, video")??null;return b instanceof Element?b:Xe(c.clientX,c.clientY,n.rootId)};document.addEventListener("click",c=>{!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||S(c)||!$(c)||(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())},!0),document.addEventListener("mousedown",c=>{if(!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||S(c))return;const h=$(c);if(!h)return;const b=c.button===0?"like":c.button===1?"love":null;if(!b)return;w(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const M=be(h,n.minSize);if(!M){if(h instanceof HTMLVideoElement){const te=(h.currentSrc||h.src||"").trim().toLowerCase();if(te.startsWith("blob:")||te.startsWith("data:")){const W=window.location.href,N={type:b,url:W,referrer_url:W,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:"video",width:h.videoWidth||h.clientWidth||null,height:h.videoHeight||h.clientHeight||null,alt:"",preview_url:h.poster||"",source:n.sourceFromMediaUrl(W),download_via:"yt-dlp"};n.fetchAtlasStatus(t.sendMessageSafe,N.url,N.referrer_url||null,A=>{if(A?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(_=>{if(_==="alternate"){t.showToast("Cancelled.");return}f(h,!0,b,N.url),_==="confirm"&&(N.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:N},C=>{if(!C||!C.ok){f(h,!1,null,N.url),t.showToast(C?.error||"Reaction failed.","danger");return}const k=C.data||null,v=k?.file||null,U=k?.reaction?.type?String(k.reaction.type):b;n.atlasStatusCache.set(N.url,{exists:!!v,downloaded:!!v?.downloaded,blacklisted:!!v?.blacklisted_at,reactionType:U,ts:Date.now()}),f(h,!1,U,N.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}f(h,!0,b,N.url),t.sendMessageSafe({type:"atlas-react",payload:N},_=>{if(!_||!_.ok){f(h,!1,null,N.url),t.showToast(_?.error||"Reaction failed.","danger");return}const C=_.data||null,k=C?.file||null,v=C?.reaction?.type?String(C.reaction.type):b;n.atlasStatusCache.set(N.url,{exists:!!k,downloaded:!!k?.downloaded,blacklisted:!!k?.blacklisted_at,reactionType:v,ts:Date.now()}),f(h,!1,v,N.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const P={type:b,url:M.url,referrer_url:M.referrer_url||window.location.href,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:M.tag_name,width:M.width,height:M.height,alt:n.limitString(M.alt||"",n.maxMetadataLen),preview_url:M.preview_url||"",source:n.sourceFromMediaUrl(M.url)};n.fetchAtlasStatus(t.sendMessageSafe,P.url,P.referrer_url||null,te=>{if(te?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(W=>{if(W==="alternate"){t.showToast("Cancelled.");return}f(h,!0,b,P.url),W==="confirm"&&(P.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:P},N=>{if(!N||!N.ok){f(h,!1,null,P.url),t.showToast(N?.error||"Reaction failed.","danger");return}const A=N.data||null,_=A?.file||null,C=A?.reaction?.type?String(A.reaction.type):b;n.atlasStatusCache.set(P.url,{exists:!!_,downloaded:!!_?.downloaded,blacklisted:!!_?.blacklisted_at,reactionType:C,ts:Date.now()}),f(h,!1,C,P.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})});return}f(h,!0,b,P.url),t.sendMessageSafe({type:"atlas-react",payload:P},W=>{if(!W||!W.ok){f(h,!1,null,P.url),t.showToast(W?.error||"Reaction failed.","danger");return}const N=W.data||null,A=N?.file||null,_=N?.reaction?.type?String(N.reaction.type):b;n.atlasStatusCache.set(P.url,{exists:!!A,downloaded:!!A?.downloaded,blacklisted:!!A?.blacklisted_at,reactionType:_,ts:Date.now()}),f(h,!1,_,P.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",c=>{if(!a||!(c instanceof MouseEvent)||!c.altKey||t.isSheetOpen()||S(c))return;const h=$(c);if(!h)return;w(),c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation();const b=be(h,n.minSize);if(!b){if(h instanceof HTMLVideoElement){const P=(h.currentSrc||h.src||"").trim().toLowerCase();if(P.startsWith("blob:")||P.startsWith("data:")){const te=window.location.href,W={type:"dislike",url:te,referrer_url:te,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:"video",width:h.videoWidth||h.clientWidth||null,height:h.videoHeight||h.clientHeight||null,alt:"",preview_url:h.poster||"",source:n.sourceFromMediaUrl(te),download_via:"yt-dlp"};f(h,!0,"dislike",W.url),t.sendMessageSafe({type:"atlas-react",payload:W},N=>{if(!N||!N.ok){f(h,!1,null,W.url),t.showToast(N?.error||"Reaction failed.","danger");return}f(h,!1,"dislike",W.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const M={type:"dislike",url:b.url,referrer_url:b.referrer_url||window.location.href,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:b.tag_name,width:b.width,height:b.height,alt:n.limitString(b.alt||"",n.maxMetadataLen),preview_url:b.preview_url||"",source:n.sourceFromMediaUrl(b.url)};f(h,!0,"dislike",M.url),t.sendMessageSafe({type:"atlas-react",payload:M},P=>{if(!P||!P.ok){f(h,!1,null,M.url),t.showToast(P?.error||"Reaction failed.","danger");return}f(h,!1,"dislike",M.url),t.showToast("Disliked.")})},!0),document.addEventListener("auxclick",c=>{!a||!(c instanceof MouseEvent)||!c.altKey||c.button!==1||t.isSheetOpen()||S(c)||!$(c)||(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())},!0)}function Je(t,n,a){return t<n?n:t>a?a:t}function Rt(){const t=window;if(t.__atlasLocationObserverInstalled)return;t.__atlasLocationObserverInstalled=!0;const n=()=>{window.dispatchEvent(new Event(Ve))},a=r=>{const o=history[r].bind(history);history[r]=((...w)=>{const f=o(...w);return n(),f})};a("pushState"),a("replaceState"),window.addEventListener("popstate",n,!0),window.addEventListener("hashchange",n,!0)}function Ye(t,n,a){const r=be(t,a.minSize);if(r)return{type:n,url:r.url,referrer_url:r.referrer_url||window.location.href,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:r.tag_name,width:r.width,height:r.height,alt:a.limitString(r.alt||"",a.maxMetadataLen),preview_url:r.preview_url||"",source:a.sourceFromMediaUrl(r.url)};if(t instanceof HTMLVideoElement){const o=(t.currentSrc||t.src||"").trim().toLowerCase();if(o.startsWith("blob:")||o.startsWith("data:")){const w=window.location.href;return{type:n,url:w,referrer_url:w,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:a.sourceFromMediaUrl(w),download_via:"yt-dlp"}}}return null}function Ge(t,n){Rt();const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");const r=document.createElement("span");r.className="atlas-downloader-media-resolution",r.hidden=!0,a.appendChild(r);let o=null,w=null,f=null,S=!1,$=null,c=null,h=-1,b=-1,M=null,P=window.location.href;const te=new Map,W=(i,g)=>{const x=typeof i=="number"&&Number.isFinite(i)&&i>0?Math.round(i):null,F=typeof g=="number"&&Number.isFinite(g)&&g>0?Math.round(g):null;return!x||!F?"":`${x}x${F}`},N=(i,g)=>{const x=W(i,g);if(!x){r.textContent="",r.hidden=!0;return}r.textContent=x,r.hidden=!1},A=()=>{const i=S||$!==null;for(const[g,x]of te.entries())x.disabled=i,x.classList.toggle("pending",S&&c===g)},_=(i,g=null)=>{S=i,c=i?g:null,A()},C=i=>{for(const g of[..._e,J]){const x=te.get(g.type);if(!x)continue;const F=g.type===J.type?i==="dislike":i===g.type;x.classList.toggle("active",F)}},k=(i,g)=>{$=i&&g===!1&&i!=="dislike"?i:null;for(const x of[..._e,J]){const F=te.get(x.type);if(!F)continue;const I=x.type===J.type?$==="dislike":$===x.type;F.classList.toggle("queued",I)}A()},v=(i,g,x)=>{o&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:o,pending:i,reactionType:g,url:x}}))},U=()=>{S&&(v(!1,null,w||null),_(!1,null))},H=()=>{const i=window.location.href;i!==P&&(P=i,U(),X(!0))},O=()=>{f&&(window.clearTimeout(f),f=null)},X=i=>{S&&!(i===!0)||(o=null,w=null,a.classList.remove("open"),a.style.left="",a.style.top="",N(null,null),C(null))},D=()=>{O(),f=window.setTimeout(()=>{a.matches(":hover")||X()},140)},Q=i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation?.()};for(const i of[..._e,J]){const g=document.createElement("button");g.type="button",g.className=`atlas-downloader-reaction-btn ${i.className}`.trim(),g.setAttribute("aria-label",i.label),g.title=i.label,g.replaceChildren(Ee(i.pathDs)),te.set(i.type,g),g.addEventListener("pointerdown",Q,!0),g.addEventListener("mousedown",Q,!0),g.addEventListener("click",x=>{if(Q(x),S)return;if(!o){t.showToast("No media selected.");return}const F=i.type===J.type?"dislike":i.type,I=Ye(o,F,n);if(!I){t.showToast("No valid media URL found.");return}const L=I.url||"",ae=(re=!1)=>{re?I.force_download=!0:"force_download"in I&&delete I.force_download,v(!0,i.type,L||null),_(!0,i.type),t.sendMessageSafe({type:"atlas-react",payload:{...I,...i.type===J.type?{blacklist:!0}:{}}},G=>{if(_(!1,null),!G||!G.ok){v(!1,null,L||null),t.showToast(G?.error||"Reaction failed.","danger");return}const fe=G.data||null,we=fe?.file||null,oe=fe?.reaction?.type?String(fe.reaction.type):i.type===J.type?"dislike":i.type;if(L&&n.atlasStatusCache.set(L,{exists:!!we,downloaded:!!we?.downloaded,blacklisted:!!we?.blacklisted_at,reactionType:oe,ts:Date.now()}),C(oe),k(oe,!!we?.downloaded),v(!1,oe,L||null),I.download_via==="yt-dlp"){t.showToast(`Reacted (${i.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${i.label}). Queued download in Atlas.`)})};n.fetchAtlasStatus(t.sendMessageSafe,L,I.referrer_url||null,re=>{if(F!=="dislike"&&re?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(G=>{if(G==="alternate"){t.showToast("Cancelled.");return}ae(G==="confirm")});return}ae(!1)})}),a.appendChild(g)}t.root.appendChild(a);const q=i=>(typeof i.composedPath=="function"?i.composedPath():[]).some(x=>x instanceof HTMLElement&&x.id===n.rootId),ce=()=>{if(!o)return;const i=o.getBoundingClientRect();if(!Number.isFinite(i.left)||i.width<=0||i.height<=0){U(),X(!0);return}const g=Je(i.top+8,8,window.innerHeight-8),x=Je(i.right-8,8,window.innerWidth-8);a.style.top=`${g}px`,a.style.left=`${x}px`},ne=(i,g)=>Xe(i,g,n.rootId),Y=i=>{if(t.isSheetOpen()){X();return}H();const g=Ye(i,"like",n);if(!g){X();return}const x=g.url||null;if((o&&o!==i||w&&x&&w!==x)&&U(),o=i,w=x,N(g.width,g.height),a.classList.add("open"),ce(),C(null),k(null,null),w){const I=n.getCachedAtlasStatus(w);if(I)C(I.reactionType),k(I.reactionType,I.downloaded);else{const L=w;n.fetchAtlasStatus(t.sendMessageSafe,L,window.location.href,ae=>{ae&&w===L&&(C(ae.reactionType),k(ae.reactionType,ae.downloaded))})}}},ue=i=>i?i==="blacklist"?"blacklist":i:null,ge=()=>{if(h<0||b<0||t.isSheetOpen())return;const i=ne(h,b);i&&(i.closest?.(`#${n.rootId}`)||(O(),Y(i)))},pe=(i=80)=>{M!==null&&window.clearTimeout(M),M=window.setTimeout(()=>{M=null,ge()},i)};document.addEventListener("pointerover",i=>{if(t.isSheetOpen()||!(i.target instanceof Element)||q(i))return;const g=ne(i.clientX,i.clientY);g&&(O(),Y(g))},!0),window.addEventListener("atlas-shortcut-reaction-state",i=>{const g=i,x=g.detail?.media;if(!(x instanceof Element))return;O(),Y(x);const F=!!g.detail?.pending,I=ue(g.detail?.reactionType??null);if(F){_(!0,I);return}if(_(!1,null),I){const L=I==="blacklist"?"dislike":I;C(L);const ae=w?n.getCachedAtlasStatus(w):null;k(L,ae?.downloaded??null)}},!0),document.addEventListener("pointermove",i=>{H(),h=i.clientX,b=i.clientY},!0),document.addEventListener("click",i=>{i instanceof MouseEvent&&(t.isSheetOpen()||q(i)||(pe(40),window.setTimeout(()=>pe(220),220)))},!0),document.addEventListener("pointerout",i=>{!o||t.isSheetOpen()||!(i.target instanceof Element)||q(i)||!(i.target.closest?.("img, video")??null)||D()},!0),a.addEventListener("pointerenter",O,!0),a.addEventListener("pointerleave",D,!0),window.addEventListener("scroll",ce,!0),window.addEventListener("resize",ce),window.addEventListener(Ve,H,!0),window.addEventListener("blur",X),window.addEventListener("focus",()=>pe(40),!0),new MutationObserver(()=>{H(),pe(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}function j(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function et(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>Me(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function tt(t,n){const a=(t||"").toLowerCase();if(!a)return!1;for(const r of n)if(Ne(a,r))return!0;return!1}function Me(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const a=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(a).hostname}catch{return""}}function Ne(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}const nt="atlas-downloader-page-markers";function at(t){return function(a,r="info"){const o=document.createElement("div");o.className=`atlas-downloader-toast${r==="danger"?" danger":""}`,o.textContent=a,t.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove(),{once:!0})},2600)}}function rt(t){return n=>new Promise(a=>{const r=document.createElement("div");r.className="atlas-downloader-dialog-backdrop";const o=document.createElement("div");o.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.setAttribute("aria-label",n.title);const w=document.createElement("h3");w.className="atlas-downloader-dialog-title",w.textContent=n.title;const f=document.createElement("p");f.className="atlas-downloader-dialog-message",f.textContent=n.message;const S=document.createElement("div");S.className="atlas-downloader-dialog-actions";const $=b=>{r.remove(),a(b)};if(n.alternateLabel){const b=document.createElement("button");b.type="button",b.className="atlas-downloader-dialog-btn secondary",b.textContent=n.alternateLabel,b.addEventListener("click",()=>$("alternate")),S.appendChild(b)}const c=document.createElement("button");c.type="button",c.className="atlas-downloader-dialog-btn",c.textContent=n.cancelLabel||"Cancel",c.addEventListener("click",()=>$("cancel")),S.appendChild(c);const h=document.createElement("button");h.type="button",h.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),h.textContent=n.confirmLabel,h.addEventListener("click",()=>$("confirm")),S.appendChild(h),o.appendChild(w),o.appendChild(f),o.appendChild(S),r.appendChild(o),t.appendChild(r),requestAnimationFrame(()=>{h.focus()})})}function Pt(){if(document.getElementById(nt))return;const t=document.createElement("style");t.id=nt,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 4px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 4px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 4px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 4px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 4px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: -4px !important;
}
`,(document.head||document.documentElement).appendChild(t)}(()=>{const a="atlas-downloader-root",r="atlas-open",o=(()=>{try{return window.top===window.self}catch{return!1}})(),w=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let f=null,S=null;const $=3e4,c=new Map;function h(A,_){const C=typeof A=="string"?A:"";return C.length<=_?C:C.slice(0,_)}function b(A){return bt(A)||"Extension"}function M(A){const _=c.get(A);return _?Date.now()-_.ts>$?(c.delete(A),null):_:null}function P(A,_,C,k){const v=j((_||"").trim());if(!v){k(null);return}const U=M(v);if(U){k(U);return}A({type:"atlas-check-batch",urls:[v]},H=>{if(!H||!H.ok){k(null);return}const O=Array.isArray(H.data?.results)?H.data.results:[],D=new Map(O.filter(q=>typeof q?.url=="string"&&q.url.trim()!=="").map(q=>[j(String(q.url)),q])).get(v)??null;if(!D){k(null);return}const Q={exists:!!D.exists,downloaded:!!D.downloaded,blacklisted:!!D.blacklisted,reactionType:D.reaction?.type?String(D.reaction.type):null,ts:Date.now()};c.set(v,Q),k(Q)})}chrome.runtime.onMessage.addListener(A=>{if(!A||typeof A!="object")return;const _=A;if(_.type==="atlas-download-event"){S?.(_.payload);return}if(_.type==="atlas-open-sheet"&&o)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],C=>{Ie(C.atlasMediaNoiseFilters||"");const k=Me(C.atlasBaseUrl||"");if(k&&Ne(window.location.hostname,k))return;const v=et(C.atlasExcludedDomains||"");tt(window.location.hostname,v)||(W(),f?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains","atlasMediaNoiseFilters"],A=>{Ie(A.atlasMediaNoiseFilters||"");const _=Me(A.atlasBaseUrl||"");if(_&&Ne(window.location.hostname,_))return;const C=et(A.atlasExcludedDomains||"");tt(window.location.hostname,C)||(o?W():te())});function te(){if(document.getElementById(a))return;const A=document.createElement("div");A.id=a;const _=A.attachShadow({mode:"closed"}),C=document.createElement("link");C.rel="stylesheet",C.href=chrome.runtime.getURL("dist/content.css"),_.appendChild(C);const k=document.createElement("div");k.className="atlas-shadow-root";const v=at(k),U=rt(k),H=(O,X)=>{try{chrome.runtime.sendMessage(O,X)}catch(D){(()=>{if(D instanceof Error)return D.message;if(D&&typeof D=="object"&&"message"in D){const q=D.message;return typeof q=="string"?q:String(q)}return String(D)})().includes("Extension context invalidated")?v("Atlas extension was reloaded. Refresh this tab.","danger"):v("Atlas extension error. Refresh this tab.","danger"),X(null)}};_.appendChild(k),(document.body||document.documentElement).appendChild(A),Ze({showToast:v,sendMessageSafe:H,isSheetOpen:()=>!1,chooseDialog:U},{rootId:a,minSize:200,maxMetadataLen:500,limitString:h,sourceFromMediaUrl:b,fetchAtlasStatus:P,atlasStatusCache:c,getCachedAtlasStatus:M}),Ge({root:k,showToast:v,sendMessageSafe:H,isSheetOpen:()=>!1,chooseDialog:U},{rootId:a,minSize:200,maxMetadataLen:500,limitString:h,sourceFromMediaUrl:b,fetchAtlasStatus:P,atlasStatusCache:c,getCachedAtlasStatus:M})}function W(){if(document.getElementById(a))return;const A=document.createElement("div");A.id=a;const _=A.attachShadow({mode:"closed"}),C=document.createElement("link");C.rel="stylesheet",C.href=chrome.runtime.getURL("dist/content.css"),_.appendChild(C);const k=document.createElement("div");k.className="atlas-shadow-root";const v=at(k),U=(e,s)=>{try{chrome.runtime.sendMessage(e,s)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const m=l.message;return typeof m=="string"?m:String(m)}return String(l)})().includes("Extension context invalidated")?v("Atlas extension was reloaded. Refresh this tab.","danger"):v("Atlas extension error. Refresh this tab.","danger"),s(null)}},H=document.createElement("button");H.className="atlas-downloader-toggle",H.type="button",H.setAttribute("aria-label","Atlas Downloader"),H.title="Atlas Downloader";const O=document.createElement("img");O.alt="",O.src=chrome.runtime.getURL("icon.svg"),H.appendChild(O);const X=document.createElement("div");X.className="atlas-downloader-overlay";const D=document.createElement("div");D.className="atlas-downloader-modal",D.setAttribute("role","dialog"),D.setAttribute("aria-modal","true"),D.setAttribute("aria-label","Atlas Media Picker");const Q=document.createElement("div");Q.className="atlas-downloader-header";const q=document.createElement("div");q.className="atlas-downloader-title",q.textContent="Atlas Media Picker";const ce=document.createElement("div");ce.className="atlas-downloader-version",ce.textContent=w?`v${w}`:"";const ne=document.createElement("button");ne.type="button",ne.className="atlas-downloader-close",ne.setAttribute("aria-label","Close"),ne.textContent="x",Q.appendChild(q),Q.appendChild(ce),Q.appendChild(ne);const Y=document.createElement("div");Y.className="atlas-downloader-toolbar";const ue=ve("Rescan",()=>lt()),ge=ve("Check Atlas",()=>mt(!1)),pe=ve("Select all",()=>st(!0)),ye=ve("Select none",()=>st(!1)),i=document.createElement("span");i.className="spacer";const g=ve("Queue selected",()=>zt(),{primary:!0});Y.appendChild(ue),Y.appendChild(ge),Y.appendChild(pe),Y.appendChild(ye),Y.appendChild(i),Y.appendChild(g);const x=document.createElement("div");x.className="atlas-downloader-meta";const F=document.createElement("div");F.className="atlas-downloader-list",D.appendChild(Q),D.appendChild(Y),D.appendChild(x),D.appendChild(F),k.appendChild(H),k.appendChild(X),k.appendChild(D),_.appendChild(k),(document.body||document.documentElement).appendChild(A);const I=rt(k);let L=[],ae=0,re=null,G=null,fe=null,we=null;const oe=new Set,De=new Map,It=!0;let ot=!1;S=e=>{if(!e||typeof e!="object")return;const s=e,l=Number.isFinite(Number(s.transferId))?Number(s.transferId):null,d=typeof s.status=="string"?s.status:"",m=!!s.downloaded||d==="completed"||typeof s.finished_at=="string",p=!!s.failed||d==="failed"||d==="canceled"||typeof s.failed_at=="string",y=new Set,u=typeof s.original=="string"?j(s.original.trim()):"",E=typeof s.referrer_url=="string"?j(s.referrer_url.trim()):"";u&&y.add(u),E&&y.add(E);const T=l?De.get(l)??"":"";if(T&&y.add(T),y.size===0)return;const z=u||T||E||"";l&&z&&!m&&!p&&De.set(l,z);let ee=!1;for(const B of y){const ie=M(B);c.set(B,{exists:!0,downloaded:m,blacklisted:ie?!!ie.blacklisted:!1,reactionType:ie?.reactionType??null,ts:Date.now()})}for(const B of L){const ie=se(B)||j(String(B.url||""));!ie||!y.has(ie)||!oe.has(ie)&&B.status!=="Queued"||(B.atlas={exists:!0,downloaded:m,blacklisted:B.atlas?.blacklisted??!1,file_id:B.atlas?.file_id??null,reaction:B.atlas?.reaction??null},m?(B.status="",B.statusClass="",B.reactionQueued=null,oe.delete(ie)):p?(B.status="Failed",B.statusClass="err",B.reactionQueued=null,oe.delete(ie)):(B.status="Queued",B.statusClass="queued"),ee=!0)}l&&(m||p)&&De.delete(l),ee&&(Z(),K(V()),me(L))},H.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Be()}),X.addEventListener("click",()=>ke()),ne.addEventListener("click",()=>ke()),document.addEventListener("keydown",e=>{const s=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&s==="a"){e.preventDefault(),Be();return}if(e.key==="Escape"&&k.classList.contains(r)){ke();return}if(!k.classList.contains(r))return;const l=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!l)return;const d=L.find(m=>m.selected)??L[0]??null;d&&(e.preventDefault(),Re(d,l,{closeOnSuccess:!0}))});function Ut(){k.classList.add(r),lt()}function Be(){if(k.classList.contains(r)){ke();return}Ut()}function ke(){k.classList.remove(r)}f=Be,Ze({showToast:v,sendMessageSafe:U,isSheetOpen:()=>k.classList.contains(r),chooseDialog:I,setHintShown:e=>{ot=e},getHintShown:()=>ot,enabled:It},{rootId:a,minSize:200,maxMetadataLen:500,limitString:h,sourceFromMediaUrl:b,fetchAtlasStatus:P,atlasStatusCache:c,getCachedAtlasStatus:M}),Ge({root:k,showToast:v,sendMessageSafe:U,isSheetOpen:()=>k.classList.contains(r),chooseDialog:I},{rootId:a,minSize:200,maxMetadataLen:500,limitString:h,sourceFromMediaUrl:b,fetchAtlasStatus:P,atlasStatusCache:c,getCachedAtlasStatus:M}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const s=e,l=!!s.detail?.pending,d=s.detail?.reactionType?String(s.detail.reactionType):null,p=(typeof s.detail?.url=="string"?s.detail.url:"")||s.detail?.media&&be(s.detail.media,200)?.url||"",y=p?j(p):"";if(l){re=y||"__external-reaction__",G=d||G||"like";for(const u of L)y&&(se(u)||j(String(u.url||"")))!==y||(u.reactionPending=d||u.reactionPending||"like");Z(),K(V());return}re=null,G=null;for(const u of L){if(y&&(se(u)||j(String(u.url||"")))!==y)continue;u.reactionPending&&(u.reactionPending=null);const E=(y?M(y):null)??M(se(u))??M(j(String(u.url||"")));E?u.atlas={exists:!!E.exists,downloaded:!!E.downloaded,blacklisted:!!E.blacklisted,file_id:u.atlas?.file_id??null,reaction:E.reactionType?{type:E.reactionType}:u.atlas?.reaction??null}:d&&(u.atlas={exists:u.atlas?.exists??!0,downloaded:u.atlas?.downloaded??!1,blacklisted:u.atlas?.blacklisted??!1,file_id:u.atlas?.file_id??null,reaction:{type:d}}),u.atlas?.exists&&!u.atlas?.downloaded&&u.atlas?.reaction?.type&&u.atlas.reaction.type!=="dislike"?u.reactionQueued=u.atlas.reaction.type:u.reactionQueued=null}Z(),K(V()),me(L)},!0);const Le=(e=300)=>{we!==null&&window.clearTimeout(we),we=window.setTimeout(()=>{we=null,Vt()},e)};new MutationObserver(()=>{me(L),Le(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>Le(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&Le(120)},!0),Le(120);function ve(e,s,l){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${l?.primary?" primary":""}`,d.textContent=e,d.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),s()}),d}function Ht(e){x.textContent=e,g.disabled=!0,ue.disabled=!0,ge.disabled=!0,pe.disabled=!0,ye.disabled=!0}function K(e){x.textContent=e;const s=L.filter(d=>d.selected).length,l=L.some(d=>!!d.reactionPending)||re!==null;g.disabled=s===0||l,ue.disabled=l,ge.disabled=L.length===0||l,pe.disabled=L.length===0||l,ye.disabled=L.length===0||l}function lt(){ae+=1;const e=ae;L=[],fe=null,F.replaceChildren(),Ht("Scanning this page…"),N(s=>{ae===e&&(x.textContent=`Scanning… ${s.scanned}/${s.total}`)}).then(s=>{ae===e&&(L=s.map(l=>({...l,selected:!0,status:"",statusClass:"",atlas:null,reactionPending:re&&re!=="__external-reaction__"&&(se(l)||j(String(l.url||"")))===re?G||"like":null,reactionQueued:null})),Z(),K(V()),mt(!0))})}function st(e){for(const s of L)s.selected=e;Z(),K(V())}function Z(){if(F.replaceChildren(),L.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",F.appendChild(e);return}for(const e of L)F.appendChild($t(e))}function $t(e){const s=document.createElement("div");s.className=`atlas-downloader-item${e.selected?" selected":""}`;const l=document.createElement("input");l.type="checkbox",l.checked=e.selected,l.addEventListener("change",()=>{e.selected=l.checked,s.classList.toggle("selected",e.selected),K(V())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",e.preview_url){const R=document.createElement("img");R.loading="lazy",R.alt="",R.src=e.preview_url,d.appendChild(R)}const m=document.createElement("div");m.className="atlas-downloader-info";const p=document.createElement("div");p.className="atlas-downloader-kind",p.textContent=e.tag_name;const y=document.createElement("div");y.className="atlas-downloader-url",y.textContent=e.url,y.title=e.url;const u=document.createElement("div");u.className="atlas-downloader-sub",u.textContent=Ft(e);const E=document.createElement("div");E.className="atlas-downloader-reactions";const T=e.atlas?.reaction?.type||null,z=!!e.reactionPending||!!e.reactionQueued;for(const R of _e){const de=document.createElement("button");de.type="button",de.className=`atlas-downloader-reaction-btn ${R.className}${T===R.type?" active":""}${e.reactionPending===R.type?" pending":""}${e.reactionQueued===R.type?" queued":""}`.trim(),de.setAttribute("aria-label",R.label),de.title=R.label,de.replaceChildren(Ee(R.pathDs)),de.disabled=z,de.addEventListener("click",pt=>{pt.preventDefault(),pt.stopPropagation(),Re(e,R.type)}),E.appendChild(de)}const ee=document.createElement("button");if(ee.type="button",ee.className=`atlas-downloader-reaction-btn ${J.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===J.type?" pending":""}${e.reactionQueued===J.type?" queued":""}`.trim(),ee.setAttribute("aria-label",J.label),ee.title=J.label,ee.replaceChildren(Ee(J.pathDs)),ee.disabled=z,ee.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),Re(e,"dislike",{blacklist:!0})}),E.appendChild(ee),e.atlas?.downloaded){const R=document.createElement("button");R.type="button",R.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),R.setAttribute("aria-label","Delete download"),R.title="Delete download",R.replaceChildren(Ee(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),R.disabled=z,R.addEventListener("click",de=>{de.preventDefault(),de.stopPropagation(),qt(e)}),E.appendChild(R)}const B=document.createElement("button");B.type="button",B.className=`atlas-downloader-debug-toggle${fe===e.url?" active":""}`,B.textContent=fe===e.url?"Hide debug":"Debug",B.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),fe=fe===e.url?null:e.url,Z(),K(V())}),E.appendChild(B),m.appendChild(p),m.appendChild(y),m.appendChild(u),m.appendChild(E),fe===e.url&&m.appendChild(Wt(e));const ie=document.createElement("div"),ht=Qt(e);return ie.className=`atlas-downloader-status ${ht.className}`.trim(),ie.textContent=ht.text,s.addEventListener("click",R=>{R.target instanceof HTMLInputElement||(e.selected=!e.selected,l.checked=e.selected,s.classList.toggle("selected",e.selected),K(V()))}),s.appendChild(l),s.appendChild(d),s.appendChild(m),s.appendChild(ie),s}function it(e,s){return{type:s,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:h(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:h(e.alt||"",500),preview_url:e.preview_url||"",source:b(e.url),...e.download_via?{download_via:e.download_via}:{}}}function dt(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:h(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:h(e.alt||"",500),preview_url:e.preview_url||"",source:b(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function Wt(e){const s=document.createElement("details");s.className="atlas-downloader-debug",s.open=!0;const l=document.createElement("summary");l.textContent="Debug payload",s.appendChild(l);const d={react:it(e,e.atlas?.reaction?.type||"like"),download:dt(e)};return s.appendChild(Ot(d)),s}function Ot(e,s=0){const l=document.createElement("div");l.className="atlas-downloader-json-tree";const d=Se(e);if(!ut(d)){const p=document.createElement("div");return p.className="atlas-downloader-json-line",p.textContent=ft(d),l.appendChild(p),l}const m=Array.isArray(d)?d.map((p,y)=>[String(y),p]):Object.entries(d);for(const[p,y]of m)l.appendChild(ct(p,y,s));return l}function ct(e,s,l){const d=Se(s),m=document.createElement("div");if(m.className="atlas-downloader-json-line",m.style.paddingLeft=`${l*12}px`,!ut(d))return m.innerHTML=`<span class="atlas-downloader-json-key">${Ae(e)}</span>: <span class="atlas-downloader-json-value">${Ae(ft(d))}</span>`,m;const p=document.createElement("details");p.className="atlas-downloader-json-node",p.open=l===0;const y=document.createElement("summary");y.style.paddingLeft=`${l*12}px`;const u=Array.isArray(d)?`[${d.length}]`:`{${Object.keys(d).length}}`;y.innerHTML=`<span class="atlas-downloader-json-key">${Ae(e)}</span>: <span class="atlas-downloader-json-preview">${Ae(u)}</span>`,p.appendChild(y);const E=Array.isArray(d)?d.map((T,z)=>[String(z),T]):Object.entries(d);for(const[T,z]of E)p.appendChild(ct(T,z,l+1));return p}function Se(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(l=>Se(l));if(!e||typeof e!="object")return null;const s={};for(const[l,d]of Object.entries(e))s[l]=Se(d);return s}function ut(e){return Array.isArray(e)||e&&typeof e=="object"}function ft(e){return JSON.stringify(e)}function Ae(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Ft(e){const s=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",l=jt(e.url);return l?`${s} • ${l}`:s}function jt(e){try{return new URL(e).hostname}catch{return""}}function V(){const e=L.filter(s=>s.selected).length;return`${L.length} found • ${e} selected`}function se(e){const s=(e?.url||e?.referrer_url||"").trim();return s?j(s):""}function Qt(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function mt(e){const s=[...new Set(L.map(l=>se(l)).filter(Boolean))];s.length!==0&&U({type:"atlas-check-batch",urls:s},l=>{if(!l){e||v("Atlas extension did not respond.","danger");return}if(!l.ok){e||v(l.error||"Atlas check failed.","danger");return}const d=Array.isArray(l.data?.results)?l.data.results:[],m=new Map(d.filter(u=>typeof u?.url=="string"&&u.url.trim()!=="").map(u=>[j(String(u.url)),u]));let p=0,y=0;for(const u of L){const E=se(u),T=m.get(E);T&&(u.atlas={exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,file_id:T.file_id??null,reaction:T.reaction??null},u.atlas.exists&&!u.atlas.downloaded&&u.atlas.reaction?.type&&u.atlas.reaction.type!=="dislike"?(u.reactionQueued=u.atlas.reaction.type,oe.add(E)):(u.reactionQueued=null,oe.delete(E)),c.set(E,{exists:!!T.exists,downloaded:!!T.downloaded,blacklisted:!!T.blacklisted,reactionType:T.reaction?.type?String(T.reaction.type):null,ts:Date.now()}),T.exists&&(p+=1),T.downloaded&&(y+=1))}Z(),K(V()),me(L),e||v(`Atlas check: ${y}/${p} downloaded.`)})}function Re(e,s,l={}){const d=(p={})=>{e.reactionPending=l.blacklist?J.type:s,e.status="Reacting…",e.statusClass="",re=se(e)||e.url,G=e.reactionPending,Z(),K(V());const y={...it(e,s),...p,...l.blacklist?{blacklist:!0}:{}};U({type:"atlas-react",payload:y},u=>{if(e.reactionPending=null,re=null,G=null,!u){e.status="No response",e.statusClass="err",Z(),K(V()),v("Atlas extension did not respond.","danger");return}if(!u.ok){e.status=u.error||"Failed",e.statusClass="err",Z(),K(V()),v(u.error||"Reaction failed.","danger");return}const E=u.data||null,T=E?.file||null;e.atlas={exists:!!T,downloaded:!!T?.downloaded,blacklisted:!!T?.blacklisted_at,file_id:T?.id??null,reaction:E?.reaction??null};const z=se(e)||e.url;c.set(z,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&s!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=l.blacklist?J.type:s,z&&oe.add(z)):(e.status="",e.statusClass="",e.reactionQueued=null,z&&oe.delete(z)),Z(),K(V()),me(L),l.closeOnSuccess&&ke()})},m=!!e.atlas?.reaction?.type;if(s!=="dislike"&&e.atlas?.downloaded&&m){I({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(p=>{if(p==="alternate"){v("Cancelled.");return}d(p==="confirm"?{force_download:!0}:{})});return}if(s==="dislike"&&e.atlas?.downloaded){I({title:l.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(p=>{if(p==="alternate"){v("Cancelled.");return}d(p==="confirm"?{clear_download:!0}:{})});return}d()}function qt(e){I({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(s=>{s==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",re=se(e)||e.url,G=e.reactionPending,Z(),K(V()),U({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},l=>{if(e.reactionPending=null,re=null,G=null,!l||!l.ok){e.status=l?.error||"Failed",e.statusClass="err",Z(),K(V()),v(l?.error||"Delete failed.","danger");return}const d=l.data?.file||null;e.atlas={exists:!!d,downloaded:!!d?.downloaded,blacklisted:!!d?.blacklisted_at,file_id:d?.id??null,reaction:null},e.reactionQueued=null;const m=se(e)||e.url;c.set(m,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",Z(),K(V()),me(L),v("Download deleted.")}))})}function zt(){const e=L.filter(d=>d.selected);if(e.length===0){v("Select one or more items first.");return}if(e.some(d=>!!d.atlas?.downloaded)){I({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(d=>{if(d==="alternate"){v("Cancelled.");return}l(d==="confirm")});return}l(!1);function l(d){g.disabled=!0,ue.disabled=!0,ge.disabled=!0,pe.disabled=!0,ye.disabled=!0;for(const p of e)p.status="Sending…",p.statusClass="";Z();const m=e.map(p=>{const y=dt(p);return d&&(y.force_download=!0),y});U({type:"atlas-download-batch",payloads:m},p=>{if(!p){for(const u of e)u.status="No response",u.statusClass="err";Z(),K(V()),v("Atlas extension did not respond.","danger");return}const y=Array.isArray(p.results)?p.results:[];for(let u=0;u<e.length;u+=1){const E=e[u],T=y[u];if(T?.ok){const z=T.data||null,ee=z?.file||null;if(E.atlas={exists:!!ee,downloaded:!!ee?.downloaded,blacklisted:!!ee?.blacklisted_at,file_id:ee?.id??null,reaction:E.atlas?.reaction??null},z?.queued){E.status="Queued",E.statusClass="queued",E.atlas?.reaction?.type&&E.atlas.reaction.type!=="dislike"&&(E.reactionQueued=E.atlas.reaction.type);const B=se(E)||j(String(E.url||""));B&&oe.add(B)}else{E.status="",E.statusClass="",E.reactionQueued=null;const B=se(E)||j(String(E.url||""));B&&oe.delete(B)}}else E.status=T?.error||"Failed",E.statusClass="err"}Z(),K(V()),me(L),p.ok?v(`Queued ${e.length} download(s) in Atlas.`):v(p.error||"Some requests failed.","danger")})}}function me(e=L){Pt();const s=document.querySelectorAll('[data-atlas-marked="1"]');for(const m of s)m.removeAttribute("data-atlas-marked"),m.removeAttribute("data-atlas-state"),m.removeAttribute("data-atlas-reaction");const l=new Map;for(const[m,p]of c.entries()){if(Date.now()-p.ts>$){c.delete(m);continue}l.set(m,{exists:!!p.exists,downloaded:!!p.downloaded,blacklisted:!!p.blacklisted,reactionType:p.reactionType?String(p.reactionType):null}),l.set(j(m),{exists:!!p.exists,downloaded:!!p.downloaded,blacklisted:!!p.blacklisted,reactionType:p.reactionType?String(p.reactionType):null})}for(const m of e){if(!m?.url||!m?.atlas)continue;const p=m.atlas?.reaction?.type?String(m.atlas.reaction.type):null,y={exists:!!m.atlas.exists,downloaded:!!m.atlas.downloaded,blacklisted:!!m.atlas.blacklisted,reactionType:p};l.set(m.url,y),l.set(j(m.url),y)}if(l.size===0)return;const d=document.querySelectorAll("img, video, a[href]");for(const m of d){const p=$e(m);if(p.length===0)continue;const y=p.map(u=>l.get(u)||l.get(j(u))).find(u=>!!(u&&(u.exists||u.downloaded||u.blacklisted||u.reactionType)))??null;y&&(m.setAttribute("data-atlas-marked","1"),y.blacklisted?m.setAttribute("data-atlas-state","blacklisted"):y.reactionType?m.setAttribute("data-atlas-state","reacted"):y.downloaded?m.setAttribute("data-atlas-state","downloaded"):y.exists&&m.setAttribute("data-atlas-state","exists"),y.reactionType&&m.setAttribute("data-atlas-reaction",y.reactionType))}}function Kt(){const e=new Set,s=document.querySelectorAll("img, video, a[href]");for(const d of s)for(const m of $e(d))e.add(m),e.add(j(m));const l=He();return l?.url&&(e.add(l.url),e.add(j(l.url))),[...e].filter(Boolean)}function Vt(){const e=Kt();if(e.length===0){me(L);return}U({type:"atlas-check-batch",urls:e},s=>{if(!s?.ok){me(L);return}const l=Array.isArray(s.data?.results)?s.data.results:[];for(const d of l)d?.url&&c.set(String(d.url),{exists:!!d.exists,downloaded:!!d.downloaded,blacklisted:!!d.blacklisted,reactionType:d.reaction?.type?String(d.reaction.type):null,ts:Date.now()});me(L)})}}function N(A){return new Promise(_=>{const C=document.body||document.documentElement,k=Array.from(C.querySelectorAll("img, video")),v=k.length,U=new Set,H=[];let O=0;const X=Q=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(Q,{timeout:500});return}setTimeout(()=>Q({timeRemaining:()=>25}),0)},D=Q=>{const q=typeof Q?.timeRemaining=="function"?Q.timeRemaining():25;let ce=0;for(;O<v&&(ce<80||q>5);){const Y=k[O];if(Y.closest&&Y.closest(`#${a}`)){O+=1,ce+=1;continue}const ue=be(Y,200);ue?.url&&!U.has(ue.url)&&(U.add(ue.url),H.push(ue)),O+=1,ce+=1}if(A?.({scanned:O,total:v}),O<v){X(D);return}const ne=He();ne&&!U.has(ne.url)&&(U.add(ne.url),H.push(ne)),_(H)};X(D)})}})()})();
