(function(){"use strict";(()=>{const T="atlas-downloader-root",F="atlas-open";let V=null;const D=e=>`<svg viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${e}</svg>`,ot=[{type:"love",label:"Favorite",className:"love",icon:D('<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"/>')},{type:"like",label:"Like",className:"like",icon:D('<path d="M7 10v12"/><path d="M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"/>')},{type:"dislike",label:"Dislike",className:"dislike",icon:D('<path d="M17 14V2"/><path d="M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"/>')},{type:"funny",label:"Funny",className:"funny",icon:D('<path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/><path d="M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"/>')}];chrome.runtime.onMessage.addListener(e=>{!e||typeof e!="object"||e.type!=="atlas-open-sheet"||chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],o=>{const s=Z(o.atlasBaseUrl||"");if(s&&j(window.location.hostname,s))return;const r=G(o.atlasExcludedDomains||"");K(window.location.hostname,r)||(J(),V?.())})}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],e=>{const n=Z(e.atlasBaseUrl||"");if(n&&j(window.location.hostname,n))return;const o=G(e.atlasExcludedDomains||"");K(window.location.hostname,o)||J()});function J(){if(document.getElementById(T))return;const e=document.createElement("div");e.id=T;const n=e.attachShadow({mode:"closed"}),o=document.createElement("link");o.rel="stylesheet",o.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(o);const s=document.createElement("div");s.className="atlas-shadow-root";const r=ht(s),m=document.createElement("button");m.className="atlas-downloader-toggle",m.type="button",m.setAttribute("aria-label","Atlas Downloader"),m.title="Atlas Downloader";const S=document.createElement("img");S.alt="",S.src=chrome.runtime.getURL("icon.svg"),m.appendChild(S);const E=document.createElement("div");E.className="atlas-downloader-overlay";const g=document.createElement("div");g.className="atlas-downloader-modal",g.setAttribute("role","dialog"),g.setAttribute("aria-modal","true"),g.setAttribute("aria-label","Atlas Media Picker");const L=document.createElement("div");L.className="atlas-downloader-header";const k=document.createElement("div");k.className="atlas-downloader-title",k.textContent="Atlas Media Picker";const A=document.createElement("button");A.type="button",A.className="atlas-downloader-close",A.setAttribute("aria-label","Close"),A.textContent="×",L.appendChild(k),L.appendChild(A);const w=document.createElement("div");w.className="atlas-downloader-toolbar";const _=$("Rescan",()=>tt()),x=$("Check Atlas",()=>nt(!1)),H=$("Select all",()=>et(!0)),R=$("Select none",()=>et(!1)),X=document.createElement("span");X.className="spacer";const q=$("Queue selected",()=>Ct(),{primary:!0});w.appendChild(_),w.appendChild(x),w.appendChild(H),w.appendChild(R),w.appendChild(X),w.appendChild(q);const U=document.createElement("div");U.className="atlas-downloader-meta";const M=document.createElement("div");M.className="atlas-downloader-list",g.appendChild(L),g.appendChild(w),g.appendChild(U),g.appendChild(M),s.appendChild(m),s.appendChild(E),s.appendChild(g),n.appendChild(s),(document.body||document.documentElement).appendChild(e);let f=[],W=0;m.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),Y()}),E.addEventListener("click",()=>z()),A.addEventListener("click",()=>z()),document.addEventListener("keydown",t=>{t.key==="Escape"&&s.classList.contains(F)&&z()});function Y(){s.classList.add(F),tt()}function z(){s.classList.remove(F)}V=Y;function $(t,l,a){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${a?.primary?" primary":""}`,d.textContent=t,d.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),l()}),d}function mt(t){U.textContent=t,q.disabled=!0,_.disabled=!0,x.disabled=!0,H.disabled=!0,R.disabled=!0}function y(t){U.textContent=t;const l=f.filter(a=>a.selected).length;q.disabled=l===0,_.disabled=!1,x.disabled=f.length===0,H.disabled=f.length===0,R.disabled=f.length===0}function tt(){W+=1;const t=W;f=[],M.replaceChildren(),mt("Scanning this page…"),lt(l=>{W===t&&(U.textContent=`Scanning… ${l.scanned}/${l.total}`)}).then(l=>{W===t&&(f=l.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),b(),y(C()),nt(!0))})}function et(t){for(const l of f)l.selected=t;b(),y(C())}function b(){if(M.replaceChildren(),f.length===0){const t=document.createElement("div");t.style.padding="10px 12px",t.style.color="#94a3b8",t.style.fontSize="12px",t.textContent="No matching images/videos found.",M.appendChild(t);return}for(const t of f)M.appendChild(pt(t))}function pt(t){const l=document.createElement("div");l.className=`atlas-downloader-item${t.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=t.selected,a.addEventListener("change",()=>{t.selected=a.checked,l.classList.toggle("selected",t.selected),y(C())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",t.preview_url){const p=document.createElement("img");p.loading="lazy",p.alt="",p.src=t.preview_url,d.appendChild(p)}const u=document.createElement("div");u.className="atlas-downloader-info";const c=document.createElement("div");c.className="atlas-downloader-kind",c.textContent=t.tag_name;const i=document.createElement("div");i.className="atlas-downloader-url",i.textContent=t.url,i.title=t.url;const h=document.createElement("div");h.className="atlas-downloader-sub",h.textContent=gt(t);const I=document.createElement("div");I.className="atlas-downloader-reactions";const B=t.atlas?.reaction?.type||null;for(const p of ot){const v=document.createElement("button");v.type="button",v.className=`atlas-downloader-reaction-btn ${p.className}${B===p.type?" active":""}${t.reactionPending?" pending":""}`.trim(),v.setAttribute("aria-label",p.label),v.title=p.label,v.innerHTML=p.icon,v.disabled=!!t.reactionPending,v.addEventListener("click",st=>{st.preventDefault(),st.stopPropagation(),bt(t,p.type)}),I.appendChild(v)}u.appendChild(c),u.appendChild(i),u.appendChild(h),u.appendChild(I);const Q=document.createElement("div"),at=yt(t);return Q.className=`atlas-downloader-status ${at.className}`.trim(),Q.textContent=at.text,l.addEventListener("click",p=>{p.target instanceof HTMLInputElement||(t.selected=!t.selected,a.checked=t.selected,l.classList.toggle("selected",t.selected),y(C()))}),l.appendChild(a),l.appendChild(d),l.appendChild(u),l.appendChild(Q),l}function gt(t){const l=t.width&&t.height?`${t.width}×${t.height}`:"size unknown",a=wt(t.url);return a?`${l} • ${a}`:l}function wt(t){try{return new URL(t).hostname}catch{return""}}function C(){const t=f.filter(l=>l.selected).length;return`${f.length} found • ${t} selected`}function yt(t){return t.status?{text:t.status,className:t.statusClass||""}:t.atlas?.downloaded?{text:"Downloaded",className:"ok"}:t.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function nt(t){const l=f.map(a=>a.url).filter(Boolean);l.length!==0&&chrome.runtime.sendMessage({type:"atlas-check-batch",urls:l},a=>{if(!a){t||r("Atlas extension did not respond.");return}if(!a.ok){t||r(a.error||"Atlas check failed.");return}const d=Array.isArray(a.data?.results)?a.data.results:[],u=new Map(d.map(c=>[c.url,c]));for(const c of f){const i=u.get(c.url);i&&(c.atlas={exists:!!i.exists,downloaded:!!i.downloaded,file_id:i.file_id??null,reaction:i.reaction??null})}b(),y(C())})}function bt(t,l){t.reactionPending=l,t.status="Reacting…",t.statusClass="",b();const a={type:l,url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:document.title,tag_name:t.tag_name,width:t.width,height:t.height,alt:t.alt||"",preview_url:t.preview_url||"",source:"Extension"};chrome.runtime.sendMessage({type:"atlas-react",payload:a},d=>{if(t.reactionPending=null,!d){t.status="No response",t.statusClass="err",b(),y(C()),r("Atlas extension did not respond.");return}if(!d.ok){t.status=d.error||"Failed",t.statusClass="err",b(),y(C()),r(d.error||"Reaction failed.");return}const u=d.data||null,c=u?.file||null;t.atlas={exists:!!c,downloaded:!!c?.downloaded,file_id:c?.id??null,reaction:u?.reaction??null},t.status="",t.statusClass="",b(),y(C()),t.atlas.exists&&!t.atlas.downloaded&&l!=="dislike"&&P([t.url],0)})}function Ct(){const t=f.filter(a=>a.selected);if(t.length===0){r("Select one or more items first.");return}q.disabled=!0,_.disabled=!0,x.disabled=!0,H.disabled=!0,R.disabled=!0;for(const a of t)a.status="Sending…",a.statusClass="";b();const l=t.map(a=>({url:a.url,original_url:a.url,referrer_url:window.location.href,page_title:document.title,tag_name:a.tag_name,width:a.width,height:a.height,alt:a.alt||"",preview_url:a.preview_url||"",source:"Extension",reaction_type:"like"}));chrome.runtime.sendMessage({type:"atlas-download-batch",payloads:l},a=>{if(!a){for(const c of t)c.status="No response",c.statusClass="err";b(),y(C()),r("Atlas extension did not respond.");return}const d=Array.isArray(a.results)?a.results:[],u=[];for(let c=0;c<t.length;c+=1){const i=t[c],h=d[c];if(h?.ok){const I=h.data||null,B=I?.file||null;i.atlas={exists:!!B,downloaded:!!B?.downloaded,file_id:B?.id??null},I?.queued?(i.status="Queued",i.statusClass="queued",u.push(i.url)):(i.status="",i.statusClass="")}else i.status=h?.error||"Failed",i.statusClass="err"}b(),y(C()),a.ok?r(`Queued ${t.length} download(s) in Atlas.`):r(a.error||"Some requests failed."),u.length>0&&P(u,0)})}function P(t,l){l>15||setTimeout(()=>{chrome.runtime.sendMessage({type:"atlas-check-batch",urls:t},a=>{if(!a||!a.ok){P(t,l+1);return}const d=Array.isArray(a.data?.results)?a.data.results:[],u=new Map(d.map(i=>[i.url,i]));let c=0;for(const i of f){const h=u.get(i.url);h&&(i.atlas={exists:!!h.exists,downloaded:!!h.downloaded,file_id:h.file_id??null,reaction:h.reaction??null},h.downloaded?i.status==="Queued"&&(i.status="",i.statusClass=""):c+=1)}b(),y(C()),c>0&&P(t,l+1)})},2e3)}}function lt(e){return new Promise(n=>{const o=document.body||document.documentElement,s=Array.from(o.querySelectorAll("img, video")),r=s.length,m=new Set,S=[];let E=0;const g=k=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(k,{timeout:500});return}setTimeout(()=>k({timeRemaining:()=>25}),0)},L=k=>{const A=typeof k?.timeRemaining=="function"?k.timeRemaining():25;let w=0;for(;E<r&&(w<80||A>5);){const _=s[E];if(_.closest&&_.closest(`#${T}`)){E+=1,w+=1;continue}const x=rt(_);x?.url&&!m.has(x.url)&&(m.add(x.url),S.push(x)),E+=1,w+=1}if(e?.({scanned:E,total:r}),E<r){g(L);return}n(S)};g(L)})}function rt(e){if(!(e instanceof Element))return null;if(e.tagName==="IMG"){const n=e,o=n.naturalWidth||n.width||n.clientWidth||null,s=n.naturalHeight||n.height||n.clientHeight||null;if(o&&s&&(o<450||s<450))return null;const r=N(n.currentSrc)||N(n.src)||N(n.getAttribute("src"));return r?{tag_name:"img",url:r,preview_url:r,width:o,height:s,alt:n.alt||""}:null}if(e.tagName==="VIDEO"){const n=it(e);return n?{tag_name:"video",url:n,preview_url:e.poster||"",width:e.videoWidth||e.clientWidth||null,height:e.videoHeight||e.clientHeight||null,alt:""}:null}return null}function it(e){const n=N(e.currentSrc)||N(e.src)||N(e.getAttribute("src"));if(n)return n;const o=e.querySelector("source[src]"),s=o?N(o.src||o.getAttribute("src")):"";if(s)return s;const r=dt(e);return r||ct()}function ct(){const e=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const n of e){const s=document.querySelector(n)?.getAttribute("content"),r=N(s||"");if(r)return r}return""}function dt(e){let n=e,o=0;for(;n&&o<8;){const s=n.getAttribute?.("data-store");if(s){const r=ut(s),m=O(r,0);if(m)return m}n=n.parentElement,o+=1}return""}function ut(e){if(!e)return null;const n=ft(e);try{return JSON.parse(n)}catch{return null}}function ft(e){return!e||typeof e!="string"?"":e.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function O(e,n){if(!e||n>4)return"";if(typeof e=="string")return e.startsWith("http")?e:"";if(Array.isArray(e)){for(const s of e){const r=O(s,n+1);if(r)return r}return""}if(typeof e!="object")return"";const o=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const s of o){const r=e[s];if(typeof r=="string"&&r.startsWith("http"))return r}for(const s of Object.keys(e)){const r=O(e[s],n+1);if(r)return r}return""}function ht(e){return function(o){const s=document.createElement("div");s.className="atlas-downloader-toast",s.textContent=o,e.appendChild(s),requestAnimationFrame(()=>s.classList.add("show")),setTimeout(()=>{s.classList.remove("show"),s.addEventListener("transitionend",()=>s.remove(),{once:!0})},2600)}}function G(e){return!e||typeof e!="string"?[]:e.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>Z(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function K(e,n){const o=(e||"").toLowerCase();if(!o)return!1;for(const s of n)if(j(o,s))return!0;return!1}function Z(e){if(!e||typeof e!="string")return"";const n=e.trim();if(!n)return"";const o=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(o).hostname}catch{return""}}function j(e,n){return!e||!n?!1:e===n||e.endsWith(`.${n}`)}function N(e){if(!e||typeof e!="string")return"";const n=e.trim();if(!n)return"";const o=n.toLowerCase();return o.startsWith("blob:")||o.startsWith("data:")||o.startsWith("chrome-extension:")||o.startsWith("moz-extension:")||o.startsWith("safari-extension:")?"":n}})()})();
