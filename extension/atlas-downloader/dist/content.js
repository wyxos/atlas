(function(){"use strict";const yt=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function Et(q){const T=(q||"").trim().toLowerCase();if(!T)return"";const b=T.split(".").filter(Boolean);if(b.length<=2)return T;const M=b.slice(-2).join("."),W=b.slice(-3).join(".");return yt.has(M)&&b.length>=3?W:M}function Ct(q){const T=(q||"").trim();if(!T)return"";try{const b=new URL(T).hostname;return Et(b)}catch{return""}}(()=>{const b="atlas-downloader-root",M="atlas-open",W=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let st=null;const rt="http://www.w3.org/2000/svg",At=n=>{const e=document.createElementNS(rt,"svg");e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("aria-hidden","true"),e.setAttribute("fill","none"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-linecap","round"),e.setAttribute("stroke-linejoin","round"),e.setAttribute("width","18"),e.setAttribute("height","18"),e.setAttribute("style","color: #e2e8f0; stroke: currentColor; fill: none;");for(const l of n){const o=document.createElementNS(rt,"path");o.setAttribute("d",l),o.setAttribute("fill","none"),o.setAttribute("stroke","currentColor"),o.setAttribute("stroke-width","2"),o.setAttribute("stroke-linecap","round"),o.setAttribute("stroke-linejoin","round"),e.appendChild(o)}return e},kt=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}];function j(n,e){const l=typeof n=="string"?n:"";return l.length<=e?l:l.slice(0,e)}function lt(n){return Ct(n)||"Extension"}chrome.runtime.onMessage.addListener(n=>{if(!(!n||typeof n!="object"||n.type!=="atlas-open-sheet"))try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],l=>{const o=et(l.atlasBaseUrl||"");if(o&&nt(window.location.hostname,o))return;const r=ct(l.atlasExcludedDomains||"");dt(window.location.hostname,r)||(it(),st?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],n=>{const e=et(n.atlasBaseUrl||"");if(e&&nt(window.location.hostname,e))return;const l=ct(n.atlasExcludedDomains||"");dt(window.location.hostname,l)||it()});function it(){if(document.getElementById(b))return;const n=document.createElement("div");n.id=b;const e=n.attachShadow({mode:"closed"}),l=document.createElement("link");l.rel="stylesheet",l.href=chrome.runtime.getURL("dist/content.css"),e.appendChild(l);const o=document.createElement("div");o.className="atlas-shadow-root";const r=Mt(o),y=(t,s)=>{try{chrome.runtime.sendMessage(t,s)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const i=a.message;return typeof i=="string"?i:String(i)}return String(a)})().includes("Extension context invalidated")?r("Atlas extension was reloaded. Refresh this tab."):r("Atlas extension error. Refresh this tab."),s(null)}},x=document.createElement("button");x.className="atlas-downloader-toggle",x.type="button",x.setAttribute("aria-label","Atlas Downloader"),x.title="Atlas Downloader";const N=document.createElement("img");N.alt="",N.src=chrome.runtime.getURL("icon.svg"),x.appendChild(N);const U=document.createElement("div");U.className="atlas-downloader-overlay";const E=document.createElement("div");E.className="atlas-downloader-modal",E.setAttribute("role","dialog"),E.setAttribute("aria-modal","true"),E.setAttribute("aria-label","Atlas Media Picker");const k=document.createElement("div");k.className="atlas-downloader-header";const I=document.createElement("div");I.className="atlas-downloader-title",I.textContent="Atlas Media Picker";const R=document.createElement("div");R.className="atlas-downloader-version",R.textContent=W?`v${W}`:"";const _=document.createElement("button");_.type="button",_.className="atlas-downloader-close",_.setAttribute("aria-label","Close"),_.textContent="x",k.appendChild(I),k.appendChild(R),k.appendChild(_);const h=document.createElement("div");h.className="atlas-downloader-toolbar";const O=$("Rescan",()=>pt()),F=$("Check Atlas",()=>gt(!1));let L=!1,v=null;const z=$("Debug: off",()=>{L=!L,z.textContent=L?"Debug: on":"Debug: off",L?!v&&p.length>0&&(v={url:p[0].url,reactionType:"like"}):v=null,w(),C(A())}),V=$("Select all",()=>ht(!0)),Z=$("Select none",()=>ht(!1)),ut=document.createElement("span");ut.className="spacer";const Q=$("Queue selected",()=>Bt(),{primary:!0});h.appendChild(O),h.appendChild(F),h.appendChild(z),h.appendChild(V),h.appendChild(Z),h.appendChild(ut),h.appendChild(Q);const B=document.createElement("div");B.className="atlas-downloader-meta";const P=document.createElement("div");P.className="atlas-downloader-list",E.appendChild(k),E.appendChild(h),E.appendChild(B),E.appendChild(P),o.appendChild(x),o.appendChild(U),o.appendChild(E),e.appendChild(o),(document.body||document.documentElement).appendChild(n);let p=[],X=0,J=!1;x.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),ft()}),U.addEventListener("click",()=>at()),_.addEventListener("click",()=>at()),document.addEventListener("keydown",t=>{t.key==="Escape"&&o.classList.contains(M)&&at()});function ft(){o.classList.add(M),pt(),J||(J=!0,r("Hotkeys enabled: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))}function at(){o.classList.remove(M)}st=ft,document.addEventListener("mousedown",t=>{if(!J||!(t instanceof MouseEvent)||!t.altKey||o.classList.contains(M)||(typeof t.composedPath=="function"?t.composedPath():[]).some(u=>u instanceof HTMLElement&&u.id===b))return;const d=(t.target instanceof Element?t.target:null)?.closest?.("img, video")??null;if(!d)return;const i=t.button===0?"like":t.button===1?"love":null;if(!i)return;t.preventDefault(),t.stopPropagation();const f=Y(d);if(!f){r("No valid media URL found.");return}const c=K(f,i);y({type:"atlas-react",payload:c},u=>{if(!u||!u.ok){r(u?.error||"Reaction failed.");return}r(i==="dislike"?"Disliked.":`Reacted (${i}). Queued download in Atlas.`)})},!0),document.addEventListener("contextmenu",t=>{if(!J||!(t instanceof MouseEvent)||!t.altKey||o.classList.contains(M)||(typeof t.composedPath=="function"?t.composedPath():[]).some(c=>c instanceof HTMLElement&&c.id===b))return;const d=(t.target instanceof Element?t.target:null)?.closest?.("img, video")??null;if(!d)return;t.preventDefault(),t.stopPropagation();const i=Y(d);if(!i){r("No valid media URL found.");return}const f=K(i,"dislike");y({type:"atlas-react",payload:f},c=>{if(!c||!c.ok){r(c?.error||"Reaction failed.");return}r("Disliked.")})},!0);function $(t,s,a){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${a?.primary?" primary":""}`,d.textContent=t,d.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),s()}),d}function Dt(t){B.textContent=t,Q.disabled=!0,O.disabled=!0,F.disabled=!0,z.disabled=!0,V.disabled=!0,Z.disabled=!0}function C(t){B.textContent=t;const s=p.filter(a=>a.selected).length;Q.disabled=s===0,O.disabled=!1,F.disabled=p.length===0,z.disabled=p.length===0,V.disabled=p.length===0,Z.disabled=p.length===0}function pt(){X+=1;const t=X;p=[],L&&(v=null),P.replaceChildren(),Dt("Scanning this page…"),vt(s=>{X===t&&(B.textContent=`Scanning… ${s.scanned}/${s.total}`)}).then(s=>{X===t&&(p=s.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),L&&!v&&p.length>0&&(v={url:p[0].url,reactionType:"like"}),w(),C(A()),gt(!0))})}function ht(t){for(const s of p)s.selected=t;w(),C(A())}function w(){if(P.replaceChildren(),p.length===0){const t=document.createElement("div");t.style.padding="10px 12px",t.style.color="#94a3b8",t.style.fontSize="12px",t.textContent="No matching images/videos found.",P.appendChild(t);return}for(const t of p)P.appendChild(Tt(t))}function Tt(t){const s=document.createElement("div");s.className=`atlas-downloader-item${t.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=t.selected,a.addEventListener("change",()=>{t.selected=a.checked,s.classList.toggle("selected",t.selected),C(A())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",t.preview_url){const g=document.createElement("img");g.loading="lazy",g.alt="",g.src=t.preview_url,d.appendChild(g)}const i=document.createElement("div");i.className="atlas-downloader-info";const f=document.createElement("div");f.className="atlas-downloader-kind",f.textContent=t.tag_name;const c=document.createElement("div");c.className="atlas-downloader-url",c.textContent=t.url,c.title=t.url;const u=document.createElement("div");u.className="atlas-downloader-sub",u.textContent=Ut(t);const m=document.createElement("div");m.className="atlas-downloader-reactions";const H=t.atlas?.reaction?.type||null;for(const g of kt){const S=document.createElement("button");S.type="button",S.className=`atlas-downloader-reaction-btn ${g.className}${H===g.type?" active":""}${t.reactionPending?" pending":""}`.trim(),S.setAttribute("aria-label",g.label),S.title=g.label,S.replaceChildren(At(g.pathDs)),S.disabled=!!t.reactionPending,S.addEventListener("click",bt=>{bt.preventDefault(),bt.stopPropagation(),L&&(v={url:t.url,reactionType:g.type},w()),It(t,g.type)}),m.appendChild(S)}i.appendChild(f),i.appendChild(c),i.appendChild(u),i.appendChild(m),L&&v?.url===t.url&&i.appendChild(Rt(t,v.reactionType));const ot=document.createElement("div"),wt=$t(t);return ot.className=`atlas-downloader-status ${wt.className}`.trim(),ot.textContent=wt.text,s.addEventListener("click",g=>{g.target instanceof HTMLInputElement||(L&&(v={url:t.url,reactionType:v?.reactionType??"like"}),t.selected=!t.selected,a.checked=t.selected,s.classList.toggle("selected",t.selected),C(A()))}),s.appendChild(a),s.appendChild(d),s.appendChild(i),s.appendChild(ot),s}function K(t,s){return{type:s,url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:j(document.title,500),tag_name:t.tag_name,width:t.width,height:t.height,alt:j(t.alt||"",500),preview_url:t.preview_url||"",source:lt(t.url)}}function mt(t){return{url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:j(document.title,500),tag_name:t.tag_name,width:t.width,height:t.height,alt:j(t.alt||"",500),preview_url:t.preview_url||"",source:lt(t.url),reaction_type:"like"}}function Rt(t,s){const a=document.createElement("details");a.className="atlas-downloader-debug",a.open=!0;const d=document.createElement("summary");d.textContent="Debug payload",a.appendChild(d);const i=document.createElement("pre");return i.textContent=JSON.stringify({react:K(t,s),download:mt(t)},null,2),a.appendChild(i),a}function Ut(t){const s=t.width&&t.height?`${t.width}×${t.height}`:"size unknown",a=Pt(t.url);return a?`${s} • ${a}`:s}function Pt(t){try{return new URL(t).hostname}catch{return""}}function A(){const t=p.filter(s=>s.selected).length;return`${p.length} found • ${t} selected`}function $t(t){return t.status?{text:t.status,className:t.statusClass||""}:t.atlas?.downloaded?{text:"Downloaded",className:"ok"}:t.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function gt(t){const s=p.map(a=>a.url).filter(Boolean);s.length!==0&&y({type:"atlas-check-batch",urls:s},a=>{if(!a){t||r("Atlas extension did not respond.");return}if(!a.ok){t||r(a.error||"Atlas check failed.");return}const d=Array.isArray(a.data?.results)?a.data.results:[],i=new Map(d.map(u=>[u.url,u]));let f=0,c=0;for(const u of p){const m=i.get(u.url);m&&(u.atlas={exists:!!m.exists,downloaded:!!m.downloaded,file_id:m.file_id??null,reaction:m.reaction??null},m.exists&&(f+=1),m.downloaded&&(c+=1))}w(),C(A()),t||r(`Atlas check: ${c}/${f} downloaded.`)})}function It(t,s){t.reactionPending=s,t.status="Reacting…",t.statusClass="",w();const a=K(t,s);y({type:"atlas-react",payload:a},d=>{if(t.reactionPending=null,!d){t.status="No response",t.statusClass="err",w(),C(A()),r("Atlas extension did not respond.");return}if(!d.ok){t.status=d.error||"Failed",t.statusClass="err",w(),C(A()),r(d.error||"Reaction failed.");return}const i=d.data||null,f=i?.file||null;t.atlas={exists:!!f,downloaded:!!f?.downloaded,file_id:f?.id??null,reaction:i?.reaction??null},t.atlas.exists&&!t.atlas.downloaded&&s!=="dislike"?(t.status="Queued",t.statusClass="queued"):(t.status="",t.statusClass=""),w(),C(A()),t.atlas.exists&&!t.atlas.downloaded&&s!=="dislike"&&G([t.url],0)})}function Bt(){const t=p.filter(a=>a.selected);if(t.length===0){r("Select one or more items first.");return}Q.disabled=!0,O.disabled=!0,F.disabled=!0,V.disabled=!0,Z.disabled=!0;for(const a of t)a.status="Sending…",a.statusClass="";w();const s=t.map(a=>mt(a));y({type:"atlas-download-batch",payloads:s},a=>{if(!a){for(const f of t)f.status="No response",f.statusClass="err";w(),C(A()),r("Atlas extension did not respond.");return}const d=Array.isArray(a.results)?a.results:[],i=[];for(let f=0;f<t.length;f+=1){const c=t[f],u=d[f];if(u?.ok){const m=u.data||null,H=m?.file||null;c.atlas={exists:!!H,downloaded:!!H?.downloaded,file_id:H?.id??null},m?.queued?(c.status="Queued",c.statusClass="queued",i.push(c.url)):(c.status="",c.statusClass="")}else c.status=u?.error||"Failed",c.statusClass="err"}w(),C(A()),a.ok?r(`Queued ${t.length} download(s) in Atlas.`):r(a.error||"Some requests failed."),i.length>0&&G(i,0)})}function G(t,s){s>15||setTimeout(()=>{y({type:"atlas-check-batch",urls:t},a=>{if(!a||!a.ok){G(t,s+1);return}const d=Array.isArray(a.data?.results)?a.data.results:[],i=new Map(d.map(c=>[c.url,c]));let f=0;for(const c of p){const u=i.get(c.url);u&&(c.atlas={exists:!!u.exists,downloaded:!!u.downloaded,file_id:u.file_id??null,reaction:u.reaction??null},u.downloaded?c.status==="Queued"&&(c.status="",c.statusClass=""):f+=1)}w(),C(A()),f>0&&G(t,s+1)})},2e3)}}function vt(n){return new Promise(e=>{const l=document.body||document.documentElement,o=Array.from(l.querySelectorAll("img, video")),r=o.length,y=new Set,x=[];let N=0;const U=k=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(k,{timeout:500});return}setTimeout(()=>k({timeRemaining:()=>25}),0)},E=k=>{const I=typeof k?.timeRemaining=="function"?k.timeRemaining():25;let R=0;for(;N<r&&(R<80||I>5);){const _=o[N];if(_.closest&&_.closest(`#${b}`)){N+=1,R+=1;continue}const h=Y(_);h?.url&&!y.has(h.url)&&(y.add(h.url),x.push(h)),N+=1,R+=1}if(n?.({scanned:N,total:r}),N<r){U(E);return}e(x)};U(E)})}function Y(n){if(!(n instanceof Element))return null;if(n.tagName==="IMG"){const e=n,l=e.naturalWidth||e.width||e.clientWidth||null,o=e.naturalHeight||e.height||e.clientHeight||null;if(l&&o&&(l<450||o<450))return null;const r=D(e.currentSrc)||D(e.src)||D(e.getAttribute("src"));return r?{tag_name:"img",url:r,preview_url:r,width:l,height:o,alt:e.alt||""}:null}if(n.tagName==="VIDEO"){const e=xt(n);return e?{tag_name:"video",url:e,preview_url:n.poster||"",width:n.videoWidth||n.clientWidth||null,height:n.videoHeight||n.clientHeight||null,alt:""}:null}return null}function xt(n){const e=D(n.currentSrc)||D(n.src)||D(n.getAttribute("src"));if(e)return e;const l=n.querySelector("source[src]"),o=l?D(l.src||l.getAttribute("src")):"";if(o)return o;const r=_t(n);return r||Nt()}function Nt(){const n=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const e of n){const o=document.querySelector(e)?.getAttribute("content"),r=D(o||"");if(r)return r}return""}function _t(n){let e=n,l=0;for(;e&&l<8;){const o=e.getAttribute?.("data-store");if(o){const r=Lt(o),y=tt(r,0);if(y)return y}e=e.parentElement,l+=1}return""}function Lt(n){if(!n)return null;const e=St(n);try{return JSON.parse(e)}catch{return null}}function St(n){return!n||typeof n!="string"?"":n.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function tt(n,e){if(!n||e>4)return"";if(typeof n=="string")return n.startsWith("http")?n:"";if(Array.isArray(n)){for(const o of n){const r=tt(o,e+1);if(r)return r}return""}if(typeof n!="object")return"";const l=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const o of l){const r=n[o];if(typeof r=="string"&&r.startsWith("http"))return r}for(const o of Object.keys(n)){const r=tt(n[o],e+1);if(r)return r}return""}function Mt(n){return function(l){const o=document.createElement("div");o.className="atlas-downloader-toast",o.textContent=l,n.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove(),{once:!0})},2600)}}function ct(n){return!n||typeof n!="string"?[]:n.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e&&!e.startsWith("#")).map(e=>(e.startsWith("*.")?e.slice(2):e).toLowerCase()).map(e=>et(e)||e.replace(/^\.+/,"").trim()).filter(Boolean)}function dt(n,e){const l=(n||"").toLowerCase();if(!l)return!1;for(const o of e)if(nt(l,o))return!0;return!1}function et(n){if(!n||typeof n!="string")return"";const e=n.trim();if(!e)return"";const l=/^https?:\/\//i.test(e)?e:`https://${e}`;try{return new URL(l).hostname}catch{return""}}function nt(n,e){return!n||!e?!1:n===e||n.endsWith(`.${e}`)}function D(n){if(!n||typeof n!="string")return"";const e=n.trim();if(!e)return"";const l=e.toLowerCase();return l.startsWith("blob:")||l.startsWith("data:")||l.startsWith("chrome-extension:")||l.startsWith("moz-extension:")||l.startsWith("safari-extension:")?"":e}})()})();
