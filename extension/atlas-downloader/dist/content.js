(function(){"use strict";(()=>{const Z="atlas-downloader-root",j="atlas-open",X=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let Y=null;const tt="http://www.w3.org/2000/svg",pt=n=>{const e=document.createElementNS(tt,"svg");e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("aria-hidden","true"),e.setAttribute("fill","none"),e.setAttribute("stroke","currentColor"),e.setAttribute("stroke-width","2"),e.setAttribute("stroke-linecap","round"),e.setAttribute("stroke-linejoin","round"),e.setAttribute("width","18"),e.setAttribute("height","18");for(const r of n){const s=document.createElementNS(tt,"path");s.setAttribute("d",r),e.appendChild(s)}return e},ht=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}];chrome.runtime.onMessage.addListener(n=>{if(!(!n||typeof n!="object"||n.type!=="atlas-open-sheet"))try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],r=>{const s=z(r.atlasBaseUrl||"");if(s&&J(window.location.hostname,s))return;const l=nt(r.atlasExcludedDomains||"");at(window.location.hostname,l)||(et(),Y?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],n=>{const e=z(n.atlasBaseUrl||"");if(e&&J(window.location.hostname,e))return;const r=nt(n.atlasExcludedDomains||"");at(window.location.hostname,r)||et()});function et(){if(document.getElementById(Z))return;const n=document.createElement("div");n.id=Z;const e=n.attachShadow({mode:"closed"}),r=document.createElement("link");r.rel="stylesheet",r.href=chrome.runtime.getURL("dist/content.css"),e.appendChild(r);const s=document.createElement("div");s.className="atlas-shadow-root";const l=xt(s),x=(t,o)=>{try{chrome.runtime.sendMessage(t,o)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const i=a.message;return typeof i=="string"?i:String(i)}return String(a)})().includes("Extension context invalidated")?l("Atlas extension was reloaded. Refresh this tab."):l("Atlas extension error. Refresh this tab."),o(null)}},A=document.createElement("button");A.className="atlas-downloader-toggle",A.type="button",A.setAttribute("aria-label","Atlas Downloader"),A.title="Atlas Downloader";const v=document.createElement("img");v.alt="",v.src=chrome.runtime.getURL("icon.svg"),A.appendChild(v);const D=document.createElement("div");D.className="atlas-downloader-overlay";const w=document.createElement("div");w.className="atlas-downloader-modal",w.setAttribute("role","dialog"),w.setAttribute("aria-modal","true"),w.setAttribute("aria-label","Atlas Media Picker");const C=document.createElement("div");C.className="atlas-downloader-header";const R=document.createElement("div");R.className="atlas-downloader-title",R.textContent="Atlas Media Picker";const L=document.createElement("div");L.className="atlas-downloader-version",L.textContent=X?`v${X}`:"";const k=document.createElement("button");k.type="button",k.className="atlas-downloader-close",k.setAttribute("aria-label","Close"),k.textContent="×",C.appendChild(R),C.appendChild(L),C.appendChild(k);const p=document.createElement("div");p.className="atlas-downloader-toolbar";const $=T("Rescan",()=>rt()),q=T("Check Atlas",()=>dt(!1));let N=!1,E=null;const H=T("Debug",()=>{N=!N,H.textContent=N?"Debug: on":"Debug",N?!E&&f.length>0&&(E={url:f[0].url,reactionType:"like"}):E=null,g(),b(y())}),P=T("Select all",()=>lt(!0)),W=T("Select none",()=>lt(!1)),st=document.createElement("span");st.className="spacer";const O=T("Queue selected",()=>Dt(),{primary:!0});p.appendChild($),p.appendChild(q),p.appendChild(H),p.appendChild(P),p.appendChild(W),p.appendChild(st),p.appendChild(O);const B=document.createElement("div");B.className="atlas-downloader-meta";const M=document.createElement("div");M.className="atlas-downloader-list",w.appendChild(C),w.appendChild(p),w.appendChild(B),w.appendChild(M),s.appendChild(A),s.appendChild(D),s.appendChild(w),e.appendChild(s),(document.body||document.documentElement).appendChild(n);let f=[],F=0;A.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),ot()}),D.addEventListener("click",()=>G()),k.addEventListener("click",()=>G()),document.addEventListener("keydown",t=>{t.key==="Escape"&&s.classList.contains(j)&&G()});function ot(){s.classList.add(j),rt()}function G(){s.classList.remove(j)}Y=ot;function T(t,o,a){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${a?.primary?" primary":""}`,d.textContent=t,d.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),o()}),d}function At(t){B.textContent=t,O.disabled=!0,$.disabled=!0,q.disabled=!0,H.disabled=!0,P.disabled=!0,W.disabled=!0}function b(t){B.textContent=t;const o=f.filter(a=>a.selected).length;O.disabled=o===0,$.disabled=!1,q.disabled=f.length===0,H.disabled=f.length===0,P.disabled=f.length===0,W.disabled=f.length===0}function rt(){F+=1;const t=F;f=[],N&&(E=null),M.replaceChildren(),At("Scanning this page…"),mt(o=>{F===t&&(B.textContent=`Scanning… ${o.scanned}/${o.total}`)}).then(o=>{F===t&&(f=o.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),N&&!E&&f.length>0&&(E={url:f[0].url,reactionType:"like"}),g(),b(y()),dt(!0))})}function lt(t){for(const o of f)o.selected=t;g(),b(y())}function g(){if(M.replaceChildren(),f.length===0){const t=document.createElement("div");t.style.padding="10px 12px",t.style.color="#94a3b8",t.style.fontSize="12px",t.textContent="No matching images/videos found.",M.appendChild(t);return}for(const t of f)M.appendChild(vt(t))}function vt(t){const o=document.createElement("div");o.className=`atlas-downloader-item${t.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=t.selected,a.addEventListener("change",()=>{t.selected=a.checked,o.classList.toggle("selected",t.selected),b(y())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",t.preview_url){const m=document.createElement("img");m.loading="lazy",m.alt="",m.src=t.preview_url,d.appendChild(m)}const i=document.createElement("div");i.className="atlas-downloader-info";const u=document.createElement("div");u.className="atlas-downloader-kind",u.textContent=t.tag_name;const c=document.createElement("div");c.className="atlas-downloader-url",c.textContent=t.url,c.title=t.url;const h=document.createElement("div");h.className="atlas-downloader-sub",h.textContent=Nt(t);const I=document.createElement("div");I.className="atlas-downloader-reactions";const U=t.atlas?.reaction?.type||null;for(const m of ht){const _=document.createElement("button");_.type="button",_.className=`atlas-downloader-reaction-btn ${m.className}${U===m.type?" active":""}${t.reactionPending?" pending":""}`.trim(),_.setAttribute("aria-label",m.label),_.title=m.label,_.replaceChildren(pt(m.pathDs)),_.disabled=!!t.reactionPending,_.addEventListener("click",ft=>{ft.preventDefault(),ft.stopPropagation(),N&&(E={url:t.url,reactionType:m.type},g()),Lt(t,m.type)}),I.appendChild(_)}i.appendChild(u),i.appendChild(c),i.appendChild(h),i.appendChild(I),N&&E?.url===t.url&&i.appendChild(kt(t,E.reactionType));const K=document.createElement("div"),ut=St(t);return K.className=`atlas-downloader-status ${ut.className}`.trim(),K.textContent=ut.text,o.addEventListener("click",m=>{m.target instanceof HTMLInputElement||(N&&(E={url:t.url,reactionType:E?.reactionType??"like"}),t.selected=!t.selected,a.checked=t.selected,o.classList.toggle("selected",t.selected),b(y()))}),o.appendChild(a),o.appendChild(d),o.appendChild(i),o.appendChild(K),o}function it(t,o){return{type:o,url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:document.title,tag_name:t.tag_name,width:t.width,height:t.height,alt:t.alt||"",preview_url:t.preview_url||"",source:"Extension"}}function ct(t){return{url:t.url,original_url:t.url,referrer_url:window.location.href,page_title:document.title,tag_name:t.tag_name,width:t.width,height:t.height,alt:t.alt||"",preview_url:t.preview_url||"",source:"Extension",reaction_type:"like"}}function kt(t,o){const a=document.createElement("details");a.className="atlas-downloader-debug",a.open=!0;const d=document.createElement("summary");d.textContent="Debug payload",a.appendChild(d);const i=document.createElement("pre");return i.textContent=JSON.stringify({react:it(t,o),download:ct(t)},null,2),a.appendChild(i),a}function Nt(t){const o=t.width&&t.height?`${t.width}×${t.height}`:"size unknown",a=_t(t.url);return a?`${o} • ${a}`:o}function _t(t){try{return new URL(t).hostname}catch{return""}}function y(){const t=f.filter(o=>o.selected).length;return`${f.length} found • ${t} selected`}function St(t){return t.status?{text:t.status,className:t.statusClass||""}:t.atlas?.downloaded?{text:"Downloaded",className:"ok"}:t.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function dt(t){const o=f.map(a=>a.url).filter(Boolean);o.length!==0&&x({type:"atlas-check-batch",urls:o},a=>{if(!a){t||l("Atlas extension did not respond.");return}if(!a.ok){t||l(a.error||"Atlas check failed.");return}const d=Array.isArray(a.data?.results)?a.data.results:[],i=new Map(d.map(u=>[u.url,u]));for(const u of f){const c=i.get(u.url);c&&(u.atlas={exists:!!c.exists,downloaded:!!c.downloaded,file_id:c.file_id??null,reaction:c.reaction??null})}g(),b(y())})}function Lt(t,o){t.reactionPending=o,t.status="Reacting…",t.statusClass="",g();const a=it(t,o);x({type:"atlas-react",payload:a},d=>{if(t.reactionPending=null,!d){t.status="No response",t.statusClass="err",g(),b(y()),l("Atlas extension did not respond.");return}if(!d.ok){t.status=d.error||"Failed",t.statusClass="err",g(),b(y()),l(d.error||"Reaction failed.");return}const i=d.data||null,u=i?.file||null;t.atlas={exists:!!u,downloaded:!!u?.downloaded,file_id:u?.id??null,reaction:i?.reaction??null},t.atlas.exists&&!t.atlas.downloaded&&o!=="dislike"?(t.status="Queued",t.statusClass="queued"):(t.status="",t.statusClass=""),g(),b(y()),t.atlas.exists&&!t.atlas.downloaded&&o!=="dislike"&&V([t.url],0)})}function Dt(){const t=f.filter(a=>a.selected);if(t.length===0){l("Select one or more items first.");return}O.disabled=!0,$.disabled=!0,q.disabled=!0,P.disabled=!0,W.disabled=!0;for(const a of t)a.status="Sending…",a.statusClass="";g();const o=t.map(a=>ct(a));x({type:"atlas-download-batch",payloads:o},a=>{if(!a){for(const u of t)u.status="No response",u.statusClass="err";g(),b(y()),l("Atlas extension did not respond.");return}const d=Array.isArray(a.results)?a.results:[],i=[];for(let u=0;u<t.length;u+=1){const c=t[u],h=d[u];if(h?.ok){const I=h.data||null,U=I?.file||null;c.atlas={exists:!!U,downloaded:!!U?.downloaded,file_id:U?.id??null},I?.queued?(c.status="Queued",c.statusClass="queued",i.push(c.url)):(c.status="",c.statusClass="")}else c.status=h?.error||"Failed",c.statusClass="err"}g(),b(y()),a.ok?l(`Queued ${t.length} download(s) in Atlas.`):l(a.error||"Some requests failed."),i.length>0&&V(i,0)})}function V(t,o){o>15||setTimeout(()=>{x({type:"atlas-check-batch",urls:t},a=>{if(!a||!a.ok){V(t,o+1);return}const d=Array.isArray(a.data?.results)?a.data.results:[],i=new Map(d.map(c=>[c.url,c]));let u=0;for(const c of f){const h=i.get(c.url);h&&(c.atlas={exists:!!h.exists,downloaded:!!h.downloaded,file_id:h.file_id??null,reaction:h.reaction??null},h.downloaded?c.status==="Queued"&&(c.status="",c.statusClass=""):u+=1)}g(),b(y()),u>0&&V(t,o+1)})},2e3)}}function mt(n){return new Promise(e=>{const r=document.body||document.documentElement,s=Array.from(r.querySelectorAll("img, video")),l=s.length,x=new Set,A=[];let v=0;const D=C=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(C,{timeout:500});return}setTimeout(()=>C({timeRemaining:()=>25}),0)},w=C=>{const R=typeof C?.timeRemaining=="function"?C.timeRemaining():25;let L=0;for(;v<l&&(L<80||R>5);){const k=s[v];if(k.closest&&k.closest(`#${Z}`)){v+=1,L+=1;continue}const p=gt(k);p?.url&&!x.has(p.url)&&(x.add(p.url),A.push(p)),v+=1,L+=1}if(n?.({scanned:v,total:l}),v<l){D(w);return}e(A)};D(w)})}function gt(n){if(!(n instanceof Element))return null;if(n.tagName==="IMG"){const e=n,r=e.naturalWidth||e.width||e.clientWidth||null,s=e.naturalHeight||e.height||e.clientHeight||null;if(r&&s&&(r<450||s<450))return null;const l=S(e.currentSrc)||S(e.src)||S(e.getAttribute("src"));return l?{tag_name:"img",url:l,preview_url:l,width:r,height:s,alt:e.alt||""}:null}if(n.tagName==="VIDEO"){const e=wt(n);return e?{tag_name:"video",url:e,preview_url:n.poster||"",width:n.videoWidth||n.clientWidth||null,height:n.videoHeight||n.clientHeight||null,alt:""}:null}return null}function wt(n){const e=S(n.currentSrc)||S(n.src)||S(n.getAttribute("src"));if(e)return e;const r=n.querySelector("source[src]"),s=r?S(r.src||r.getAttribute("src")):"";if(s)return s;const l=yt(n);return l||bt()}function bt(){const n=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const e of n){const s=document.querySelector(e)?.getAttribute("content"),l=S(s||"");if(l)return l}return""}function yt(n){let e=n,r=0;for(;e&&r<8;){const s=e.getAttribute?.("data-store");if(s){const l=Ct(s),x=Q(l,0);if(x)return x}e=e.parentElement,r+=1}return""}function Ct(n){if(!n)return null;const e=Et(n);try{return JSON.parse(e)}catch{return null}}function Et(n){return!n||typeof n!="string"?"":n.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Q(n,e){if(!n||e>4)return"";if(typeof n=="string")return n.startsWith("http")?n:"";if(Array.isArray(n)){for(const s of n){const l=Q(s,e+1);if(l)return l}return""}if(typeof n!="object")return"";const r=["hd_src","sd_src","playable_url","playable_url_quality_hd","playable_url_quality_sd"];for(const s of r){const l=n[s];if(typeof l=="string"&&l.startsWith("http"))return l}for(const s of Object.keys(n)){const l=Q(n[s],e+1);if(l)return l}return""}function xt(n){return function(r){const s=document.createElement("div");s.className="atlas-downloader-toast",s.textContent=r,n.appendChild(s),requestAnimationFrame(()=>s.classList.add("show")),setTimeout(()=>{s.classList.remove("show"),s.addEventListener("transitionend",()=>s.remove(),{once:!0})},2600)}}function nt(n){return!n||typeof n!="string"?[]:n.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e&&!e.startsWith("#")).map(e=>(e.startsWith("*.")?e.slice(2):e).toLowerCase()).map(e=>z(e)||e.replace(/^\.+/,"").trim()).filter(Boolean)}function at(n,e){const r=(n||"").toLowerCase();if(!r)return!1;for(const s of e)if(J(r,s))return!0;return!1}function z(n){if(!n||typeof n!="string")return"";const e=n.trim();if(!e)return"";const r=/^https?:\/\//i.test(e)?e:`https://${e}`;try{return new URL(r).hostname}catch{return""}}function J(n,e){return!n||!e?!1:n===e||n.endsWith(`.${e}`)}function S(n){if(!n||typeof n!="string")return"";const e=n.trim();if(!e)return"";const r=e.toLowerCase();return r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:")?"":e}})()})();
