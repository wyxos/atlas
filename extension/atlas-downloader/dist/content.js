(function(){"use strict";const ot=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function lt(s){const u=(s||"").trim().toLowerCase();if(!u)return"";const i=u.split(".").filter(Boolean);if(i.length<=2)return u;const k=i.slice(-2).join("."),S=i.slice(-3).join(".");return ot.has(k)&&i.length>=3?S:k}function rt(s){const u=(s||"").trim();if(!u)return"";try{const i=new URL(u).hostname;return lt(i)}catch{return""}}function st(s,u){if(!s||typeof s!="string")return"";const i=s.trim();if(!i)return"";const k=i.toLowerCase();if(k.startsWith("blob:")||k.startsWith("data:")||k.startsWith("chrome-extension:")||k.startsWith("moz-extension:")||k.startsWith("safari-extension:"))return"";try{const S=new URL(i,u);return S.protocol!=="http:"&&S.protocol!=="https:"?"":S.toString()}catch{return""}}function it(s){return/\.(gif|webp)(\?|#|$)/i.test(s||"")}function dt(s){let u=s,i=0;for(;u&&i<24;){const k=u.getAttribute?.("role");if(k==="dialog"||k==="alertdialog"||u.getAttribute?.("aria-modal")==="true")return!0;const V=(u.getAttribute?.("class")||"").toLowerCase(),le=(u.getAttribute?.("id")||"").toLowerCase(),se=`${V} ${le}`.trim();if(se&&/(modal|lightbox|overlay|dialog)/.test(se))return!0;const _e=window.getComputedStyle(u);if((_e.position==="fixed"||_e.position==="sticky")&&ut(u))return!0;u=u.parentElement,i+=1}return!1}function ct(s,u){return!!(it(u)||dt(s))}function ut(s){const u=s.getBoundingClientRect();if(u.width>0&&u.height>0){const i=Math.max(window.innerWidth*.4,320),k=Math.max(window.innerHeight*.4,240);return u.width>=i&&u.height>=k}if(s instanceof HTMLElement){const i=s.style,k=i.inset==="0"||i.inset==="0px"||(i.top==="0"||i.top==="0px")&&(i.left==="0"||i.left==="0px")&&(i.right==="0"||i.right==="0px")&&(i.bottom==="0"||i.bottom==="0px"),S=/^(100vw|100%)$/i.test(i.width||"")||/^(100vh|100%)$/i.test(i.height||"");return k||S}return!1}function ne(s){return st(s,window.location.href)}function Re(s){const u=ne(s.currentSrc)||ne(s.src)||ne(s.getAttribute("src")||"");if(u)return u;const i=s.querySelector("source[src]"),k=i?ne(i.src||i.getAttribute("src")||""):"";if(k)return k;const S=mt(s);return S||pt()}function Ee(s,u){if(!(s instanceof Element))return null;if(s.tagName==="IMG"){const i=s,k=i.naturalWidth||i.width||i.clientWidth||null,S=i.naturalHeight||i.height||i.clientHeight||null,V=(i.currentSrc||i.src||i.getAttribute("src")||"").trim(),le=ne(V);if(!ct(i,le||V)&&k&&S&&(k<u||S<u))return null;if(!le){const se=ne(document.referrer)||ne(window.location.href)||"";return!se||!V.toLowerCase().startsWith("blob:")&&!V.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:se,referrer_url:window.location.href,preview_url:"",width:k,height:S,alt:i.alt||""}}return{tag_name:"img",url:le,referrer_url:window.location.href,preview_url:le,width:k,height:S,alt:i.alt||""}}if(s.tagName==="VIDEO"){const i=s,k=i.videoWidth||i.clientWidth||null,S=i.videoHeight||i.clientHeight||null;if(k&&S&&(k<u||S<u))return null;const V=Re(i);if(!V){const le=(i.currentSrc||i.src||"").trim().toLowerCase();if(le.startsWith("blob:")||le.startsWith("data:")){const se=window.location.href;return{tag_name:"video",url:se,referrer_url:se,preview_url:i.poster||"",width:k,height:S,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:V,referrer_url:window.location.href,preview_url:i.poster||"",width:k,height:S,alt:""}}return null}function Pe(){const s=(window.location.href||"").trim();if(!s)return null;const u=s.toLowerCase(),i=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(u),k=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!i&&!k)return null;if(u.startsWith("http://")||u.startsWith("https://"))return{tag_name:u.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:s,referrer_url:s,preview_url:s,width:null,height:null,alt:""};if(u.startsWith("blob:")||u.startsWith("data:")){const S=ne(document.referrer)||"";return S?{tag_name:"img",url:S,referrer_url:s,preview_url:"",width:null,height:null,alt:""}:null}return null}function $e(s){const u=new Set,i=ne(window.location.href),k=s instanceof HTMLImageElement?ne(s.currentSrc)||ne(s.src)||"":s instanceof HTMLVideoElement?Re(s)||"":s instanceof HTMLAnchorElement&&He(s.getAttribute("href")||"")||"";k&&u.add(k);const S=s.closest("a[href]")?.getAttribute("href")??"",V=He(S);return V&&u.add(V),i&&ft(s)&&u.add(i),[...u]}function He(s){const u=(s||"").trim();return!u||u.startsWith("#")||u.toLowerCase().startsWith("javascript:")?"":ne(u)}function ft(s){if(s instanceof HTMLImageElement){const u=(s.currentSrc||s.src||s.getAttribute("src")||"").trim().toLowerCase();return u.startsWith("blob:")||u.startsWith("data:")}if(s instanceof HTMLVideoElement){const u=(s.currentSrc||s.src||"").trim().toLowerCase();return u.startsWith("blob:")||u.startsWith("data:")}return!1}function pt(){const s=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const u of s){const k=document.querySelector(u)?.getAttribute("content")||"",S=ne(k);if(S)return S}return""}function mt(s){let u=s,i=0;for(;u&&i<8;){const k=u.getAttribute?.("data-store");if(k){const S=ht(k),V=Me(S,0);if(V)return V}u=u.parentElement,i+=1}return""}function ht(s){if(!s)return null;const u=gt(s);try{return JSON.parse(u)}catch{return null}}function gt(s){return!s||typeof s!="string"?"":s.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Me(s,u){if(!s||u>4)return"";if(typeof s=="string")return s.startsWith("http")?s:"";if(Array.isArray(s)){for(const i of s){const k=Me(i,u+1);if(k)return k}return""}if(typeof s=="object")for(const i of Object.keys(s)){const k=s[i],S=Me(k,u+1);if(S)return S}return""}(()=>{const i="atlas-downloader-root",k="atlas-open",S=(()=>{try{return window.top===window.self}catch{return!1}})(),V=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let le=null,se=null;const _e=3e4,G=new Map,Ue="http://www.w3.org/2000/svg",Le=t=>{const n=document.createElementNS(Ue,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const w of t){const m=document.createElementNS(Ue,"path");m.setAttribute("d",w),m.setAttribute("fill","none"),m.setAttribute("stroke","currentColor"),m.setAttribute("stroke-width","2"),m.setAttribute("stroke-linecap","round"),m.setAttribute("stroke-linejoin","round"),n.appendChild(m)}return n},Ce=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],Z={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]},Ie="atlas-downloader-page-markers";function ae(t,n){const w=typeof t=="string"?t:"";return w.length<=n?w:w.slice(0,n)}function we(t){return rt(t)||"Extension"}function be(t){const n=G.get(t);return n?Date.now()-n.ts>_e?(G.delete(t),null):n:null}function Se(t,n,w,m){const f=K((n||"").trim());if(!f){m(null);return}const v=be(f);if(v){m(v);return}t({type:"atlas-check-batch",urls:[f]},x=>{if(!x||!x.ok){m(null);return}const g=Array.isArray(x.data?.results)?x.data.results:[],l=new Map(g.filter(_=>typeof _?.url=="string"&&_.url.trim()!=="").map(_=>[K(String(_.url)),_])).get(f)??null;if(!l){m(null);return}const y={exists:!!l.exists,downloaded:!!l.downloaded,blacklisted:!!l.blacklisted,reactionType:l.reaction?.type?String(l.reaction.type):null,ts:Date.now()};G.set(f,y),m(y)})}chrome.runtime.onMessage.addListener(t=>{if(!t||typeof t!="object")return;const n=t;if(n.type==="atlas-download-event"){se?.(n.payload);return}if(n.type==="atlas-open-sheet"&&S)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],w=>{const m=Ne(w.atlasBaseUrl||"");if(m&&De(window.location.hostname,m))return;const f=Qe(w.atlasExcludedDomains||"");Fe(window.location.hostname,f)||(We(),le?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],t=>{const n=Ne(t.atlasBaseUrl||"");if(n&&De(window.location.hostname,n))return;const w=Qe(t.atlasExcludedDomains||"");Fe(window.location.hostname,w)||(S?We():wt())});function wt(){if(document.getElementById(i))return;const t=document.createElement("div");t.id=i;const n=t.attachShadow({mode:"closed"}),w=document.createElement("link");w.rel="stylesheet",w.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(w);const m=document.createElement("div");m.className="atlas-shadow-root";const f=Oe(m),v=je(m),x=(g,U)=>{try{chrome.runtime.sendMessage(g,U)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const _=l.message;return typeof _=="string"?_:String(_)}return String(l)})().includes("Extension context invalidated")?f("Atlas extension was reloaded. Refresh this tab.","danger"):f("Atlas extension error. Refresh this tab.","danger"),U(null)}};n.appendChild(m),(document.body||document.documentElement).appendChild(t),qe({showToast:f,sendMessageSafe:x,isSheetOpen:()=>!1,chooseDialog:v}),Xe({root:m,showToast:f,sendMessageSafe:x,isSheetOpen:()=>!1,chooseDialog:v})}function We(){if(document.getElementById(i))return;const t=document.createElement("div");t.id=i;const n=t.attachShadow({mode:"closed"}),w=document.createElement("link");w.rel="stylesheet",w.href=chrome.runtime.getURL("dist/content.css"),n.appendChild(w);const m=document.createElement("div");m.className="atlas-shadow-root";const f=Oe(m),v=(e,o)=>{try{chrome.runtime.sendMessage(e,o)}catch(a){(()=>{if(a instanceof Error)return a.message;if(a&&typeof a=="object"&&"message"in a){const p=a.message;return typeof p=="string"?p:String(p)}return String(a)})().includes("Extension context invalidated")?f("Atlas extension was reloaded. Refresh this tab.","danger"):f("Atlas extension error. Refresh this tab.","danger"),o(null)}},x=document.createElement("button");x.className="atlas-downloader-toggle",x.type="button",x.setAttribute("aria-label","Atlas Downloader"),x.title="Atlas Downloader";const g=document.createElement("img");g.alt="",g.src=chrome.runtime.getURL("icon.svg"),x.appendChild(g);const U=document.createElement("div");U.className="atlas-downloader-overlay";const l=document.createElement("div");l.className="atlas-downloader-modal",l.setAttribute("role","dialog"),l.setAttribute("aria-modal","true"),l.setAttribute("aria-label","Atlas Media Picker");const y=document.createElement("div");y.className="atlas-downloader-header";const _=document.createElement("div");_.className="atlas-downloader-title",_.textContent="Atlas Media Picker";const M=document.createElement("div");M.className="atlas-downloader-version",M.textContent=V?`v${V}`:"";const W=document.createElement("button");W.type="button",W.className="atlas-downloader-close",W.setAttribute("aria-label","Close"),W.textContent="x",y.appendChild(_),y.appendChild(M),y.appendChild(W);const D=document.createElement("div");D.className="atlas-downloader-toolbar";const L=J("Rescan",()=>de()),Q=J("Check Atlas",()=>tt(!1)),H=J("Select all",()=>ke(!0)),O=J("Select none",()=>ke(!1)),ee=document.createElement("span");ee.className="spacer";const z=J("Queue selected",()=>St(),{primary:!0});D.appendChild(L),D.appendChild(Q),D.appendChild(H),D.appendChild(O),D.appendChild(ee),D.appendChild(z);const te=document.createElement("div");te.className="atlas-downloader-meta";const he=document.createElement("div");he.className="atlas-downloader-list",l.appendChild(y),l.appendChild(D),l.appendChild(te),l.appendChild(he),m.appendChild(x),m.appendChild(U),m.appendChild(l),n.appendChild(m),(document.body||document.documentElement).appendChild(t);const ce=je(m);let T=[],ye=0,ue=null,fe=null,Ae=null;const ie=new Set,ve=new Map,ze=!0;let r=!1;se=e=>{if(!e||typeof e!="object")return;const o=e,a=Number.isFinite(Number(o.transferId))?Number(o.transferId):null,d=typeof o.status=="string"?o.status:"",p=!!o.downloaded||d==="completed"||typeof o.finished_at=="string",h=!!o.failed||d==="failed"||d==="canceled"||typeof o.failed_at=="string",A=new Set,c=typeof o.original=="string"?K(o.original.trim()):"",E=typeof o.referrer_url=="string"?K(o.referrer_url.trim()):"";c&&A.add(c),E&&A.add(E);const N=a?ve.get(a)??"":"";if(N&&A.add(N),A.size===0)return;const q=c||N||E||"";a&&q&&!p&&!h&&ve.set(a,q);let Y=!1;for(const B of A){const oe=be(B);G.set(B,{exists:!0,downloaded:p,blacklisted:oe?!!oe.blacklisted:!1,reactionType:oe?.reactionType??null,ts:Date.now()})}for(const B of T){const oe=pe(B)||K(String(B.url||""));!oe||!A.has(oe)||!ie.has(oe)&&B.status!=="Queued"||(B.atlas={exists:!0,downloaded:p,blacklisted:B.atlas?.blacklisted??!1,file_id:B.atlas?.file_id??null,reaction:B.atlas?.reaction??null},p?(B.status="",B.statusClass="",B.reactionQueued=null,ie.delete(oe)):h?(B.status="Failed",B.statusClass="err",B.reactionQueued=null,ie.delete(oe)):(B.status="Queued",B.statusClass="queued"),Y=!0)}a&&(p||h)&&ve.delete(a),Y&&(j(),$(X()),me(T))},x.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),C()}),U.addEventListener("click",()=>I()),W.addEventListener("click",()=>I()),document.addEventListener("keydown",e=>{const o=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&o==="a"){e.preventDefault(),C();return}if(e.key==="Escape"&&m.classList.contains(k)){I();return}if(!m.classList.contains(k))return;const a=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!a)return;const d=T.find(p=>p.selected)??T[0]??null;d&&(e.preventDefault(),Be(d,a,{closeOnSuccess:!0}))});function b(){m.classList.add(k),de()}function C(){if(m.classList.contains(k)){I();return}b()}function I(){m.classList.remove(k)}le=C,qe({showToast:f,sendMessageSafe:v,isSheetOpen:()=>m.classList.contains(k),chooseDialog:ce,setHintShown:e=>{r=e},getHintShown:()=>r,enabled:ze}),Xe({root:m,showToast:f,sendMessageSafe:v,isSheetOpen:()=>m.classList.contains(k),chooseDialog:ce}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const o=e,a=!!o.detail?.pending,d=o.detail?.reactionType?String(o.detail.reactionType):null,h=(typeof o.detail?.url=="string"?o.detail.url:"")||o.detail?.media&&Ee(o.detail.media,400)?.url||"",A=h?K(h):"";if(a){ue=A||"__external-reaction__";for(const c of T)A&&K(String(c.url||""))!==A||(c.reactionPending=d||c.reactionPending||"like");j(),$(X());return}ue=null;for(const c of T){if(A&&K(String(c.url||""))!==A)continue;c.reactionPending&&(c.reactionPending=null);const E=(A?be(A):null)??be(pe(c))??be(K(String(c.url||"")));E?c.atlas={exists:!!E.exists,downloaded:!!E.downloaded,blacklisted:!!E.blacklisted,file_id:c.atlas?.file_id??null,reaction:E.reactionType?{type:E.reactionType}:c.atlas?.reaction??null}:d&&(c.atlas={exists:c.atlas?.exists??!0,downloaded:c.atlas?.downloaded??!1,blacklisted:c.atlas?.blacklisted??!1,file_id:c.atlas?.file_id??null,reaction:{type:d}}),c.atlas?.exists&&!c.atlas?.downloaded&&c.atlas?.reaction?.type&&c.atlas.reaction.type!=="dislike"?c.reactionQueued=c.atlas.reaction.type:c.reactionQueued=null}j(),$(X()),me(T)},!0);const P=(e=300)=>{Ae!==null&&window.clearTimeout(Ae),Ae=window.setTimeout(()=>{Ae=null,xt()},e)};new MutationObserver(()=>{me(T),P(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>P(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&P(120)},!0),P(120);function J(e,o,a){const d=document.createElement("button");return d.type="button",d.className=`atlas-downloader-btn${a?.primary?" primary":""}`,d.textContent=e,d.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),o()}),d}function ge(e){te.textContent=e,z.disabled=!0,L.disabled=!0,Q.disabled=!0,H.disabled=!0,O.disabled=!0}function $(e){te.textContent=e;const o=T.filter(d=>d.selected).length,a=T.some(d=>!!d.reactionPending)||ue==="__external-reaction__";z.disabled=o===0||a,L.disabled=a,Q.disabled=T.length===0||a,H.disabled=T.length===0||a,O.disabled=T.length===0||a}function de(){ye+=1;const e=ye;T=[],fe=null,he.replaceChildren(),ge("Scanning this page…"),yt(o=>{ye===e&&(te.textContent=`Scanning… ${o.scanned}/${o.total}`)}).then(o=>{ye===e&&(T=o.map(a=>({...a,selected:!0,status:"",statusClass:"",atlas:null})),j(),$(X()),tt(!0))})}function ke(e){for(const o of T)o.selected=e;j(),$(X())}function j(){if(he.replaceChildren(),T.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",he.appendChild(e);return}for(const e of T)he.appendChild(kt(e))}function kt(e){const o=document.createElement("div");o.className=`atlas-downloader-item${e.selected?" selected":""}`;const a=document.createElement("input");a.type="checkbox",a.checked=e.selected,a.addEventListener("change",()=>{e.selected=a.checked,o.classList.toggle("selected",e.selected),$(X())});const d=document.createElement("div");if(d.className="atlas-downloader-preview",e.preview_url){const R=document.createElement("img");R.loading="lazy",R.alt="",R.src=e.preview_url,d.appendChild(R)}const p=document.createElement("div");p.className="atlas-downloader-info";const h=document.createElement("div");h.className="atlas-downloader-kind",h.textContent=e.tag_name;const A=document.createElement("div");A.className="atlas-downloader-url",A.textContent=e.url,A.title=e.url;const c=document.createElement("div");c.className="atlas-downloader-sub",c.textContent=Et(e);const E=document.createElement("div");E.className="atlas-downloader-reactions";const N=e.atlas?.reaction?.type||null,q=!!e.reactionPending||!!e.reactionQueued;for(const R of Ce){const re=document.createElement("button");re.type="button",re.className=`atlas-downloader-reaction-btn ${R.className}${N===R.type?" active":""}${e.reactionPending===R.type?" pending":""}${e.reactionQueued===R.type?" queued":""}`.trim(),re.setAttribute("aria-label",R.label),re.title=R.label,re.replaceChildren(Le(R.pathDs)),re.disabled=q,re.addEventListener("click",at=>{at.preventDefault(),at.stopPropagation(),Be(e,R.type)}),E.appendChild(re)}const Y=document.createElement("button");if(Y.type="button",Y.className=`atlas-downloader-reaction-btn ${Z.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===Z.type?" pending":""}${e.reactionQueued===Z.type?" queued":""}`.trim(),Y.setAttribute("aria-label",Z.label),Y.title=Z.label,Y.replaceChildren(Le(Z.pathDs)),Y.disabled=q,Y.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),Be(e,"dislike",{blacklist:!0})}),E.appendChild(Y),e.atlas?.downloaded){const R=document.createElement("button");R.type="button",R.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),R.setAttribute("aria-label","Delete download"),R.title="Delete download",R.replaceChildren(Le(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),R.disabled=q,R.addEventListener("click",re=>{re.preventDefault(),re.stopPropagation(),Ct(e)}),E.appendChild(R)}const B=document.createElement("button");B.type="button",B.className=`atlas-downloader-debug-toggle${fe===e.url?" active":""}`,B.textContent=fe===e.url?"Hide debug":"Debug",B.addEventListener("click",R=>{R.preventDefault(),R.stopPropagation(),fe=fe===e.url?null:e.url,j(),$(X())}),E.appendChild(B),p.appendChild(h),p.appendChild(A),p.appendChild(c),p.appendChild(E),fe===e.url&&p.appendChild(At(e));const oe=document.createElement("div"),nt=Lt(e);return oe.className=`atlas-downloader-status ${nt.className}`.trim(),oe.textContent=nt.text,o.addEventListener("click",R=>{R.target instanceof HTMLInputElement||(e.selected=!e.selected,a.checked=e.selected,o.classList.toggle("selected",e.selected),$(X()))}),o.appendChild(a),o.appendChild(d),o.appendChild(p),o.appendChild(oe),o}function Ze(e,o){return{type:o,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:ae(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:ae(e.alt||"",500),preview_url:e.preview_url||"",source:we(e.url),...e.download_via?{download_via:e.download_via}:{}}}function Je(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:ae(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:ae(e.alt||"",500),preview_url:e.preview_url||"",source:we(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function At(e){const o=document.createElement("details");o.className="atlas-downloader-debug",o.open=!0;const a=document.createElement("summary");a.textContent="Debug payload",o.appendChild(a);const d={react:Ze(e,e.atlas?.reaction?.type||"like"),download:Je(e)};return o.appendChild(vt(d)),o}function vt(e,o=0){const a=document.createElement("div");a.className="atlas-downloader-json-tree";const d=Te(e);if(!Ge(d)){const h=document.createElement("div");return h.className="atlas-downloader-json-line",h.textContent=et(d),a.appendChild(h),a}const p=Array.isArray(d)?d.map((h,A)=>[String(A),h]):Object.entries(d);for(const[h,A]of p)a.appendChild(Ye(h,A,o));return a}function Ye(e,o,a){const d=Te(o),p=document.createElement("div");if(p.className="atlas-downloader-json-line",p.style.paddingLeft=`${a*12}px`,!Ge(d))return p.innerHTML=`<span class="atlas-downloader-json-key">${xe(e)}</span>: <span class="atlas-downloader-json-value">${xe(et(d))}</span>`,p;const h=document.createElement("details");h.className="atlas-downloader-json-node",h.open=a===0;const A=document.createElement("summary");A.style.paddingLeft=`${a*12}px`;const c=Array.isArray(d)?`[${d.length}]`:`{${Object.keys(d).length}}`;A.innerHTML=`<span class="atlas-downloader-json-key">${xe(e)}</span>: <span class="atlas-downloader-json-preview">${xe(c)}</span>`,h.appendChild(A);const E=Array.isArray(d)?d.map((N,q)=>[String(q),N]):Object.entries(d);for(const[N,q]of E)h.appendChild(Ye(N,q,a+1));return h}function Te(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(a=>Te(a));if(!e||typeof e!="object")return null;const o={};for(const[a,d]of Object.entries(e))o[a]=Te(d);return o}function Ge(e){return Array.isArray(e)||e&&typeof e=="object"}function et(e){return JSON.stringify(e)}function xe(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Et(e){const o=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",a=_t(e.url);return a?`${o} • ${a}`:o}function _t(e){try{return new URL(e).hostname}catch{return""}}function X(){const e=T.filter(o=>o.selected).length;return`${T.length} found • ${e} selected`}function pe(e){const o=(e?.url||e?.referrer_url||"").trim();return o?K(o):""}function Lt(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function tt(e){const o=[...new Set(T.map(a=>pe(a)).filter(Boolean))];o.length!==0&&v({type:"atlas-check-batch",urls:o},a=>{if(!a){e||f("Atlas extension did not respond.","danger");return}if(!a.ok){e||f(a.error||"Atlas check failed.","danger");return}const d=Array.isArray(a.data?.results)?a.data.results:[],p=new Map(d.filter(c=>typeof c?.url=="string"&&c.url.trim()!=="").map(c=>[K(String(c.url)),c]));let h=0,A=0;for(const c of T){const E=pe(c),N=p.get(E);N&&(c.atlas={exists:!!N.exists,downloaded:!!N.downloaded,blacklisted:!!N.blacklisted,file_id:N.file_id??null,reaction:N.reaction??null},c.atlas.exists&&!c.atlas.downloaded&&c.atlas.reaction?.type&&c.atlas.reaction.type!=="dislike"?(c.reactionQueued=c.atlas.reaction.type,ie.add(E)):(c.reactionQueued=null,ie.delete(E)),G.set(E,{exists:!!N.exists,downloaded:!!N.downloaded,blacklisted:!!N.blacklisted,reactionType:N.reaction?.type?String(N.reaction.type):null,ts:Date.now()}),N.exists&&(h+=1),N.downloaded&&(A+=1))}j(),$(X()),me(T),e||f(`Atlas check: ${A}/${h} downloaded.`)})}function Be(e,o,a={}){const d=(h={})=>{e.reactionPending=a.blacklist?Z.type:o,e.status="Reacting…",e.statusClass="",ue=pe(e)||e.url,j(),$(X());const A={...Ze(e,o),...h,...a.blacklist?{blacklist:!0}:{}};v({type:"atlas-react",payload:A},c=>{if(e.reactionPending=null,ue=null,!c){e.status="No response",e.statusClass="err",j(),$(X()),f("Atlas extension did not respond.","danger");return}if(!c.ok){e.status=c.error||"Failed",e.statusClass="err",j(),$(X()),f(c.error||"Reaction failed.","danger");return}const E=c.data||null,N=E?.file||null;e.atlas={exists:!!N,downloaded:!!N?.downloaded,blacklisted:!!N?.blacklisted_at,file_id:N?.id??null,reaction:E?.reaction??null};const q=pe(e)||e.url;G.set(q,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&o!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=a.blacklist?Z.type:o,q&&ie.add(q)):(e.status="",e.statusClass="",e.reactionQueued=null,q&&ie.delete(q)),j(),$(X()),me(T),a.closeOnSuccess&&I()})},p=!!e.atlas?.reaction?.type;if(o!=="dislike"&&e.atlas?.downloaded&&p){ce({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(h=>{d(h==="confirm"?{force_download:!0}:{})});return}if(o==="dislike"&&e.atlas?.downloaded){ce({title:a.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(h=>{if(h==="alternate"){f("Cancelled.");return}d(h==="confirm"?{clear_download:!0}:{})});return}d()}function Ct(e){ce({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(o=>{o==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",ue=pe(e)||e.url,j(),$(X()),v({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},a=>{if(e.reactionPending=null,ue=null,!a||!a.ok){e.status=a?.error||"Failed",e.statusClass="err",j(),$(X()),f(a?.error||"Delete failed.","danger");return}const d=a.data?.file||null;e.atlas={exists:!!d,downloaded:!!d?.downloaded,blacklisted:!!d?.blacklisted_at,file_id:d?.id??null,reaction:null},e.reactionQueued=null;const p=pe(e)||e.url;G.set(p,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",j(),$(X()),me(T),f("Download deleted.")}))})}function St(){const e=T.filter(d=>d.selected);if(e.length===0){f("Select one or more items first.");return}if(e.some(d=>!!d.atlas?.downloaded)){ce({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(d=>{if(d==="alternate"){f("Cancelled.");return}a(d==="confirm")});return}a(!1);function a(d){z.disabled=!0,L.disabled=!0,Q.disabled=!0,H.disabled=!0,O.disabled=!0;for(const h of e)h.status="Sending…",h.statusClass="";j();const p=e.map(h=>{const A=Je(h);return d&&(A.force_download=!0),A});v({type:"atlas-download-batch",payloads:p},h=>{if(!h){for(const c of e)c.status="No response",c.statusClass="err";j(),$(X()),f("Atlas extension did not respond.","danger");return}const A=Array.isArray(h.results)?h.results:[];for(let c=0;c<e.length;c+=1){const E=e[c],N=A[c];if(N?.ok){const q=N.data||null,Y=q?.file||null;if(E.atlas={exists:!!Y,downloaded:!!Y?.downloaded,blacklisted:!!Y?.blacklisted_at,file_id:Y?.id??null,reaction:E.atlas?.reaction??null},q?.queued){E.status="Queued",E.statusClass="queued",E.atlas?.reaction?.type&&E.atlas.reaction.type!=="dislike"&&(E.reactionQueued=E.atlas.reaction.type);const B=pe(E)||K(String(E.url||""));B&&ie.add(B)}else{E.status="",E.statusClass="",E.reactionQueued=null;const B=pe(E)||K(String(E.url||""));B&&ie.delete(B)}}else E.status=N?.error||"Failed",E.statusClass="err"}j(),$(X()),me(T),h.ok?f(`Queued ${e.length} download(s) in Atlas.`):f(h.error||"Some requests failed.","danger")})}}function me(e=T){bt();const o=document.querySelectorAll('[data-atlas-marked="1"]');for(const p of o)p.removeAttribute("data-atlas-marked"),p.removeAttribute("data-atlas-state"),p.removeAttribute("data-atlas-reaction");const a=new Map;for(const[p,h]of G.entries()){if(Date.now()-h.ts>_e){G.delete(p);continue}a.set(p,{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null}),a.set(K(p),{exists:!!h.exists,downloaded:!!h.downloaded,blacklisted:!!h.blacklisted,reactionType:h.reactionType?String(h.reactionType):null})}for(const p of e){if(!p?.url||!p?.atlas)continue;const h=p.atlas?.reaction?.type?String(p.atlas.reaction.type):null,A={exists:!!p.atlas.exists,downloaded:!!p.atlas.downloaded,blacklisted:!!p.atlas.blacklisted,reactionType:h};a.set(p.url,A),a.set(K(p.url),A)}if(a.size===0)return;const d=document.querySelectorAll("img, video, a[href]");for(const p of d){const h=$e(p);if(h.length===0)continue;const A=h.map(c=>a.get(c)||a.get(K(c))).find(c=>!!(c&&(c.exists||c.downloaded||c.blacklisted||c.reactionType)))??null;A&&(p.setAttribute("data-atlas-marked","1"),A.blacklisted?p.setAttribute("data-atlas-state","blacklisted"):A.reactionType?p.setAttribute("data-atlas-state","reacted"):A.downloaded?p.setAttribute("data-atlas-state","downloaded"):A.exists&&p.setAttribute("data-atlas-state","exists"),A.reactionType&&p.setAttribute("data-atlas-reaction",A.reactionType))}}function Tt(){const e=new Set,o=document.querySelectorAll("img, video, a[href]");for(const d of o)for(const p of $e(d))e.add(p),e.add(K(p));const a=Pe();return a?.url&&(e.add(a.url),e.add(K(a.url))),[...e].filter(Boolean)}function xt(){const e=Tt();if(e.length===0){me(T);return}v({type:"atlas-check-batch",urls:e},o=>{if(!o?.ok){me(T);return}const a=Array.isArray(o.data?.results)?o.data.results:[];for(const d of a)d?.url&&G.set(String(d.url),{exists:!!d.exists,downloaded:!!d.downloaded,blacklisted:!!d.blacklisted,reactionType:d.reaction?.type?String(d.reaction.type):null,ts:Date.now()});me(T)})}}function yt(t){return new Promise(n=>{const w=document.body||document.documentElement,m=Array.from(w.querySelectorAll("img, video")),f=m.length,v=new Set,x=[];let g=0;const U=y=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(y,{timeout:500});return}setTimeout(()=>y({timeRemaining:()=>25}),0)},l=y=>{const _=typeof y?.timeRemaining=="function"?y.timeRemaining():25;let M=0;for(;g<f&&(M<80||_>5);){const D=m[g];if(D.closest&&D.closest(`#${i}`)){g+=1,M+=1;continue}const L=Ee(D,400);L?.url&&!v.has(L.url)&&(v.add(L.url),x.push(L)),g+=1,M+=1}if(t?.({scanned:g,total:f}),g<f){U(l);return}const W=Pe();W&&!v.has(W.url)&&(v.add(W.url),x.push(W)),n(x)};U(l)})}function Oe(t){return function(w,m="info"){const f=document.createElement("div");f.className=`atlas-downloader-toast${m==="danger"?" danger":""}`,f.textContent=w,t.appendChild(f),requestAnimationFrame(()=>f.classList.add("show")),setTimeout(()=>{f.classList.remove("show"),f.addEventListener("transitionend",()=>f.remove(),{once:!0})},2600)}}function je(t){return n=>new Promise(w=>{const m=document.createElement("div");m.className="atlas-downloader-dialog-backdrop";const f=document.createElement("div");f.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),f.setAttribute("role","dialog"),f.setAttribute("aria-modal","true"),f.setAttribute("aria-label",n.title);const v=document.createElement("h3");v.className="atlas-downloader-dialog-title",v.textContent=n.title;const x=document.createElement("p");x.className="atlas-downloader-dialog-message",x.textContent=n.message;const g=document.createElement("div");g.className="atlas-downloader-dialog-actions";const U=_=>{m.remove(),w(_)};if(n.alternateLabel){const _=document.createElement("button");_.type="button",_.className="atlas-downloader-dialog-btn secondary",_.textContent=n.alternateLabel,_.addEventListener("click",()=>U("alternate")),g.appendChild(_)}const l=document.createElement("button");l.type="button",l.className="atlas-downloader-dialog-btn",l.textContent=n.cancelLabel||"Cancel",l.addEventListener("click",()=>U("cancel")),g.appendChild(l);const y=document.createElement("button");y.type="button",y.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),y.textContent=n.confirmLabel,y.addEventListener("click",()=>U("confirm")),g.appendChild(y),f.appendChild(v),f.appendChild(x),f.appendChild(g),m.appendChild(f),t.appendChild(m),requestAnimationFrame(()=>{y.focus()})})}function bt(){if(document.getElementById(Ie))return;const t=document.createElement("style");t.id=Ie,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 4px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 4px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 4px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 4px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 4px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: -4px !important;
}
`,(document.head||document.documentElement).appendChild(t)}function K(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function Qe(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>Ne(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Fe(t,n){const w=(t||"").toLowerCase();if(!w)return!1;for(const m of n)if(De(w,m))return!0;return!1}function Ne(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const w=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(w).hostname}catch{return""}}function De(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}function qe(t){const n=t.enabled??!0,w=t.getHintShown??(()=>!1),m=t.setHintShown??(()=>{}),f=()=>{w()||(m(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},v=(g,U,l,y=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:g,pending:U,reactionType:l,url:y}}))},x=g=>(typeof g.composedPath=="function"?g.composedPath():[]).some(l=>l instanceof HTMLElement&&l.id===i);document.addEventListener("click",g=>{!n||!(g instanceof MouseEvent)||!g.altKey||t.isSheetOpen()||x(g)||!((g.target instanceof Element?g.target:null)?.closest?.("img, video")??null)||(g.preventDefault(),g.stopPropagation(),g.stopImmediatePropagation())},!0),document.addEventListener("mousedown",g=>{if(!n||!(g instanceof MouseEvent)||!g.altKey||t.isSheetOpen()||x(g))return;const l=(g.target instanceof Element?g.target:null)?.closest?.("img, video")??null;if(!l)return;const y=g.button===0?"like":g.button===1?"love":null;if(!y)return;f(),g.preventDefault(),g.stopPropagation(),g.stopImmediatePropagation();const _=Ee(l,400);if(!_){if(l instanceof HTMLVideoElement){const W=(l.currentSrc||l.src||"").trim().toLowerCase();if(W.startsWith("blob:")||W.startsWith("data:")){const D=window.location.href,L={type:y,url:D,referrer_url:D,page_title:ae(document.title,500),tag_name:"video",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",preview_url:l.poster||"",source:we(D),download_via:"yt-dlp"};Se(t.sendMessageSafe,L.url,L.referrer_url||null,Q=>{if(Q?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(H=>{v(l,!0,y,L.url),H==="confirm"&&(L.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:L},O=>{if(!O||!O.ok){v(l,!1,null,L.url),t.showToast(O?.error||"Reaction failed.","danger");return}const ee=O.data||null,z=ee?.file||null,te=ee?.reaction?.type?String(ee.reaction.type):y;G.set(L.url,{exists:!!z,downloaded:!!z?.downloaded,blacklisted:!!z?.blacklisted_at,reactionType:te,ts:Date.now()}),v(l,!1,te,L.url),t.showToast(`Reacted (${y}). Resolving video in Atlas…`)})});return}v(l,!0,y,L.url),t.sendMessageSafe({type:"atlas-react",payload:L},H=>{if(!H||!H.ok){v(l,!1,null,L.url),t.showToast(H?.error||"Reaction failed.","danger");return}const O=H.data||null,ee=O?.file||null,z=O?.reaction?.type?String(O.reaction.type):y;G.set(L.url,{exists:!!ee,downloaded:!!ee?.downloaded,blacklisted:!!ee?.blacklisted_at,reactionType:z,ts:Date.now()}),v(l,!1,z,L.url),t.showToast(`Reacted (${y}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const M={type:y,url:_.url,referrer_url:_.referrer_url||window.location.href,page_title:ae(document.title,500),tag_name:_.tag_name,width:_.width,height:_.height,alt:ae(_.alt||"",500),preview_url:_.preview_url||"",source:we(_.url)};Se(t.sendMessageSafe,M.url,M.referrer_url||null,W=>{if(W?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then(D=>{v(l,!0,y,M.url),D==="confirm"&&(M.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:M},L=>{if(!L||!L.ok){v(l,!1,null,M.url),t.showToast(L?.error||"Reaction failed.","danger");return}const Q=L.data||null,H=Q?.file||null,O=Q?.reaction?.type?String(Q.reaction.type):y;G.set(M.url,{exists:!!H,downloaded:!!H?.downloaded,blacklisted:!!H?.blacklisted_at,reactionType:O,ts:Date.now()}),v(l,!1,O,M.url),t.showToast(`Reacted (${y}). Queued download in Atlas.`)})});return}v(l,!0,y,M.url),t.sendMessageSafe({type:"atlas-react",payload:M},D=>{if(!D||!D.ok){v(l,!1,null,M.url),t.showToast(D?.error||"Reaction failed.","danger");return}const L=D.data||null,Q=L?.file||null,H=L?.reaction?.type?String(L.reaction.type):y;G.set(M.url,{exists:!!Q,downloaded:!!Q?.downloaded,blacklisted:!!Q?.blacklisted_at,reactionType:H,ts:Date.now()}),v(l,!1,H,M.url),t.showToast(`Reacted (${y}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",g=>{if(!n||!(g instanceof MouseEvent)||!g.altKey||t.isSheetOpen()||x(g))return;const l=(g.target instanceof Element?g.target:null)?.closest?.("img, video")??null;if(!l)return;f(),g.preventDefault(),g.stopPropagation(),g.stopImmediatePropagation();const y=Ee(l,400);if(!y){if(l instanceof HTMLVideoElement){const M=(l.currentSrc||l.src||"").trim().toLowerCase();if(M.startsWith("blob:")||M.startsWith("data:")){const W=window.location.href,D={type:"dislike",url:W,referrer_url:W,page_title:ae(document.title,500),tag_name:"video",width:l.videoWidth||l.clientWidth||null,height:l.videoHeight||l.clientHeight||null,alt:"",preview_url:l.poster||"",source:we(W),download_via:"yt-dlp"};v(l,!0,"dislike",D.url),t.sendMessageSafe({type:"atlas-react",payload:D},L=>{if(!L||!L.ok){v(l,!1,null,D.url),t.showToast(L?.error||"Reaction failed.","danger");return}v(l,!1,"dislike",D.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const _={type:"dislike",url:y.url,referrer_url:y.referrer_url||window.location.href,page_title:ae(document.title,500),tag_name:y.tag_name,width:y.width,height:y.height,alt:ae(y.alt||"",500),preview_url:y.preview_url||"",source:we(y.url)};v(l,!0,"dislike",_.url),t.sendMessageSafe({type:"atlas-react",payload:_},M=>{if(!M||!M.ok){v(l,!1,null,_.url),t.showToast(M?.error||"Reaction failed.","danger");return}v(l,!1,"dislike",_.url),t.showToast("Disliked.")})},!0)}function Ve(t,n,w){return t<n?n:t>w?w:t}function Ke(t,n){const w=Ee(t,400);if(w)return{type:n,url:w.url,referrer_url:w.referrer_url||window.location.href,page_title:ae(document.title,500),tag_name:w.tag_name,width:w.width,height:w.height,alt:ae(w.alt||"",500),preview_url:w.preview_url||"",source:we(w.url)};if(t instanceof HTMLVideoElement){const m=(t.currentSrc||t.src||"").trim().toLowerCase();if(m.startsWith("blob:")||m.startsWith("data:")){const f=window.location.href;return{type:n,url:f,referrer_url:f,page_title:ae(document.title,500),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:we(f),download_via:"yt-dlp"}}}return null}function Xe(t){const n=document.createElement("div");n.className="atlas-downloader-media-toolbar",n.setAttribute("role","toolbar"),n.setAttribute("aria-label","Atlas reactions");const w=document.createElement("span");w.className="atlas-downloader-media-resolution",w.hidden=!0,n.appendChild(w);let m=null,f=null,v=null,x=!1,g=null,U=null,l=-1,y=-1,_=null;const M=new Map,W=(r,b)=>{const C=typeof r=="number"&&Number.isFinite(r)&&r>0?Math.round(r):null,I=typeof b=="number"&&Number.isFinite(b)&&b>0?Math.round(b):null;return!C||!I?"":`${C}x${I}`},D=(r,b)=>{const C=W(r,b);if(!C){w.textContent="",w.hidden=!0;return}w.textContent=C,w.hidden=!1},L=()=>{const r=x||g!==null;for(const[b,C]of M.entries())C.disabled=r,C.classList.toggle("pending",x&&U===b)},Q=(r,b=null)=>{x=r,U=r?b:null,L()},H=r=>{for(const b of[...Ce,Z]){const C=M.get(b.type);if(!C)continue;const I=b.type===Z.type?r==="dislike":r===b.type;C.classList.toggle("active",I)}},O=(r,b)=>{g=r&&b===!1&&r!=="dislike"?r:null;for(const C of[...Ce,Z]){const I=M.get(C.type);if(!I)continue;const P=C.type===Z.type?g==="dislike":g===C.type;I.classList.toggle("queued",P)}L()},ee=(r,b,C)=>{m&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:m,pending:r,reactionType:b,url:C}}))},z=()=>{v&&(window.clearTimeout(v),v=null)},te=()=>{x||(m=null,f=null,n.classList.remove("open"),n.style.left="",n.style.top="",D(null,null),H(null))},he=()=>{z(),v=window.setTimeout(()=>{n.matches(":hover")||te()},140)},ce=r=>{r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation?.()};for(const r of[...Ce,Z]){const b=document.createElement("button");b.type="button",b.className=`atlas-downloader-reaction-btn ${r.className}`.trim(),b.setAttribute("aria-label",r.label),b.title=r.label,b.replaceChildren(Le(r.pathDs)),M.set(r.type,b),b.addEventListener("pointerdown",ce,!0),b.addEventListener("mousedown",ce,!0),b.addEventListener("click",C=>{if(ce(C),x)return;if(!m){t.showToast("No media selected.");return}const I=r.type===Z.type?"dislike":r.type,P=Ke(m,I);if(!P){t.showToast("No valid media URL found.");return}const F=P.url||"",J=(ge=!1)=>{ge?P.force_download=!0:"force_download"in P&&delete P.force_download,ee(!0,r.type,F||null),Q(!0,r.type),t.sendMessageSafe({type:"atlas-react",payload:{...P,...r.type===Z.type?{blacklist:!0}:{}}},$=>{if(Q(!1,null),!$||!$.ok){ee(!1,null,F||null),t.showToast($?.error||"Reaction failed.","danger");return}const de=$.data||null,ke=de?.file||null,j=de?.reaction?.type?String(de.reaction.type):r.type===Z.type?"dislike":r.type;if(F&&G.set(F,{exists:!!ke,downloaded:!!ke?.downloaded,blacklisted:!!ke?.blacklisted_at,reactionType:j,ts:Date.now()}),H(j),O(j,!!ke?.downloaded),ee(!1,j,F||null),P.download_via==="yt-dlp"){t.showToast(`Reacted (${r.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${r.label}). Queued download in Atlas.`)})};Se(t.sendMessageSafe,F,P.referrer_url||null,ge=>{if(I!=="dislike"&&ge?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file"}).then($=>{J($==="confirm")});return}J(!1)})}),n.appendChild(b)}t.root.appendChild(n);const T=r=>(typeof r.composedPath=="function"?r.composedPath():[]).some(C=>C instanceof HTMLElement&&C.id===i),ye=()=>{if(!m)return;const r=m.getBoundingClientRect();if(!Number.isFinite(r.left)||r.width<=0||r.height<=0){te();return}const b=Ve(r.top+8,8,window.innerHeight-8),C=Ve(r.right-8,8,window.innerWidth-8);n.style.top=`${b}px`,n.style.left=`${C}px`},ue=(r,b)=>{const C=F=>{if(F.matches("img, video"))return F;const J=F.closest?.("img, video");if(J instanceof Element)return J;const ge=F.querySelectorAll?.("img, video");if(!ge||ge.length===0)return null;for(const $ of ge){const de=$.getBoundingClientRect();if(r>=de.left&&r<=de.right&&b>=de.top&&b<=de.bottom)return $}return null},I=document.elementsFromPoint?.(r,b)??[];for(const F of I){if(!(F instanceof Element)||F.closest?.(`#${i}`))continue;const J=C(F);if(J)return J}const P=document.elementFromPoint?.(r,b);return P instanceof Element&&!P.closest?.(`#${i}`)?C(P):null},fe=r=>{if(t.isSheetOpen()){te();return}const b=Ke(r,"like");if(!b){te();return}if(m=r,f=b.url||null,D(b.width,b.height),n.classList.add("open"),ye(),H(null),O(null,null),f){const C=be(f);if(C)H(C.reactionType),O(C.reactionType,C.downloaded);else{const I=f;Se(t.sendMessageSafe,I,window.location.href,P=>{P&&f===I&&(H(P.reactionType),O(P.reactionType,P.downloaded))})}}},Ae=r=>r?r==="blacklist"?"blacklist":r:null,ie=()=>{if(l<0||y<0||t.isSheetOpen())return;const r=ue(l,y);r&&(r.closest?.(`#${i}`)||(z(),fe(r)))},ve=(r=80)=>{_!==null&&window.clearTimeout(_),_=window.setTimeout(()=>{_=null,ie()},r)};document.addEventListener("pointerover",r=>{if(t.isSheetOpen()||!(r.target instanceof Element)||T(r))return;const b=ue(r.clientX,r.clientY);b&&(z(),fe(b))},!0),window.addEventListener("atlas-shortcut-reaction-state",r=>{const b=r,C=b.detail?.media;if(!(C instanceof Element))return;z(),fe(C);const I=!!b.detail?.pending,P=Ae(b.detail?.reactionType??null);if(I){Q(!0,P);return}if(Q(!1,null),P){const F=P==="blacklist"?"dislike":P;H(F);const J=f?be(f):null;O(F,J?.downloaded??null)}},!0),document.addEventListener("pointermove",r=>{l=r.clientX,y=r.clientY},!0),document.addEventListener("pointerout",r=>{!m||t.isSheetOpen()||!(r.target instanceof Element)||T(r)||!(r.target.closest?.("img, video")??null)||he()},!0),n.addEventListener("pointerenter",z,!0),n.addEventListener("pointerleave",he,!0),window.addEventListener("scroll",ye,!0),window.addEventListener("resize",ye),window.addEventListener("blur",te),window.addEventListener("focus",()=>ve(40),!0),new MutationObserver(()=>{ve(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}})()})();
