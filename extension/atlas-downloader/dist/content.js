(function(){"use strict";const at=new Set(["co.uk","org.uk","ac.uk","gov.uk","com.au","net.au","org.au","edu.au","gov.au","co.nz","org.nz","ac.nz","co.jp","or.jp","ne.jp","co.kr","com.br","com.mx"]);function lt(t){const n=(t||"").trim().toLowerCase();if(!n)return"";const a=n.split(".").filter(Boolean);if(a.length<=2)return n;const r=a.slice(-2).join("."),c=a.slice(-3).join(".");return at.has(r)&&a.length>=3?c:r}function ot(t){const n=(t||"").trim();if(!n)return"";try{const a=new URL(n).hostname;return lt(a)}catch{return""}}function rt(t,n){if(!t||typeof t!="string")return"";const a=t.trim();if(!a)return"";const r=a.toLowerCase();if(r.startsWith("blob:")||r.startsWith("data:")||r.startsWith("chrome-extension:")||r.startsWith("moz-extension:")||r.startsWith("safari-extension:"))return"";try{const c=new URL(a,n);return c.protocol!=="http:"&&c.protocol!=="https:"?"":c.toString()}catch{return""}}function st(t){return/\.(gif|webp)(\?|#|$)/i.test(t||"")}function it(t){let n=t,a=0;for(;n&&a<24;){const r=n.getAttribute?.("role");if(r==="dialog"||r==="alertdialog"||n.getAttribute?.("aria-modal")==="true")return!0;const L=(n.getAttribute?.("class")||"").toLowerCase(),S=(n.getAttribute?.("id")||"").toLowerCase(),I=`${L} ${S}`.trim();if(I&&/(modal|lightbox|overlay|dialog)/.test(I))return!0;const h=window.getComputedStyle(n);if((h.position==="fixed"||h.position==="sticky")&&ct(n))return!0;n=n.parentElement,a+=1}return!1}function dt(t,n){return!!(st(n)||it(t))}function ct(t){const n=t.getBoundingClientRect();if(n.width>0&&n.height>0){const a=Math.max(window.innerWidth*.4,320),r=Math.max(window.innerHeight*.4,240);return n.width>=a&&n.height>=r}if(t instanceof HTMLElement){const a=t.style,r=a.inset==="0"||a.inset==="0px"||(a.top==="0"||a.top==="0px")&&(a.left==="0"||a.left==="0px")&&(a.right==="0"||a.right==="0px")&&(a.bottom==="0"||a.bottom==="0px"),c=/^(100vw|100%)$/i.test(a.width||"")||/^(100vh|100%)$/i.test(a.height||"");return r||c}return!1}function ae(t){return rt(t,window.location.href)}function Be(t){const n=ae(t.currentSrc)||ae(t.src)||ae(t.getAttribute("src")||"");if(n)return n;const a=t.querySelector("source[src]"),r=a?ae(a.src||a.getAttribute("src")||""):"";if(r)return r;const c=mt(t);return c||ft()}function we(t,n){if(!(t instanceof Element))return null;if(t.tagName==="IMG"){const a=t,r=a.naturalWidth||a.width||a.clientWidth||null,c=a.naturalHeight||a.height||a.clientHeight||null,L=(a.currentSrc||a.src||a.getAttribute("src")||"").trim(),S=ae(L);if(!dt(a,S||L)&&r&&c&&(r<n||c<n))return null;if(!S){const I=ae(document.referrer)||ae(window.location.href)||"";return!I||!L.toLowerCase().startsWith("blob:")&&!L.toLowerCase().startsWith("data:")?null:{tag_name:"img",url:I,referrer_url:window.location.href,preview_url:"",width:r,height:c,alt:a.alt||""}}return{tag_name:"img",url:S,referrer_url:window.location.href,preview_url:S,width:r,height:c,alt:a.alt||""}}if(t.tagName==="VIDEO"){const a=t,r=a.videoWidth||a.clientWidth||null,c=a.videoHeight||a.clientHeight||null;if(r&&c&&(r<n||c<n))return null;const L=Be(a);if(!L){const S=(a.currentSrc||a.src||"").trim().toLowerCase();if(S.startsWith("blob:")||S.startsWith("data:")){const I=window.location.href;return{tag_name:"video",url:I,referrer_url:I,preview_url:a.poster||"",width:r,height:c,alt:"",download_via:"yt-dlp"}}return null}return{tag_name:"video",url:L,referrer_url:window.location.href,preview_url:a.poster||"",width:r,height:c,alt:""}}return null}function De(){const t=(window.location.href||"").trim();if(!t)return null;const n=t.toLowerCase(),a=/\.(jpg|jpeg|png|gif|webp|bmp|svg|mp4|webm|mov|m4v|mkv)(\?|#|$)/i.test(n),r=(document.contentType||"").startsWith("image/")||(document.contentType||"").startsWith("video/");if(!a&&!r)return null;if(n.startsWith("http://")||n.startsWith("https://"))return{tag_name:n.match(/\.(mp4|webm|mov|m4v|mkv)(\?|#|$)/i)?"video":"img",url:t,referrer_url:t,preview_url:t,width:null,height:null,alt:""};if(n.startsWith("blob:")||n.startsWith("data:")){const c=ae(document.referrer)||"";return c?{tag_name:"img",url:c,referrer_url:t,preview_url:"",width:null,height:null,alt:""}:null}return null}function Re(t){const n=new Set,a=ae(window.location.href),r=t instanceof HTMLImageElement?ae(t.currentSrc)||ae(t.src)||"":t instanceof HTMLVideoElement?Be(t)||"":t instanceof HTMLAnchorElement&&Pe(t.getAttribute("href")||"")||"";r&&n.add(r);const c=t.closest("a[href]")?.getAttribute("href")??"",L=Pe(c);return L&&n.add(L),a&&ut(t)&&n.add(a),[...n]}function Pe(t){const n=(t||"").trim();return!n||n.startsWith("#")||n.toLowerCase().startsWith("javascript:")?"":ae(n)}function ut(t){if(t instanceof HTMLImageElement){const n=(t.currentSrc||t.src||t.getAttribute("src")||"").trim().toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")}if(t instanceof HTMLVideoElement){const n=(t.currentSrc||t.src||"").trim().toLowerCase();return n.startsWith("blob:")||n.startsWith("data:")}return!1}function ft(){const t=['meta[property="og:video"]','meta[property="og:video:url"]','meta[property="og:video:secure_url"]','meta[name="twitter:player:stream"]','meta[name="twitter:player:stream:url"]'];for(const n of t){const r=document.querySelector(n)?.getAttribute("content")||"",c=ae(r);if(c)return c}return""}function mt(t){let n=t,a=0;for(;n&&a<8;){const r=n.getAttribute?.("data-store");if(r){const c=pt(r),L=Le(c,0);if(L)return L}n=n.parentElement,a+=1}return""}function pt(t){if(!t)return null;const n=ht(t);try{return JSON.parse(n)}catch{return null}}function ht(t){return!t||typeof t!="string"?"":t.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&amp;/g,"&").replace(/&#38;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Le(t,n){if(!t||n>4)return"";if(typeof t=="string")return t.startsWith("http")?t:"";if(Array.isArray(t)){for(const a of t){const r=Le(a,n+1);if(r)return r}return""}if(typeof t=="object")for(const a of Object.keys(t)){const r=t[a],c=Le(r,n+1);if(c)return c}return""}const Ue="http://www.w3.org/2000/svg",ke=t=>{const n=document.createElementNS(Ue,"svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("aria-hidden","true"),n.setAttribute("fill","none"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.setAttribute("width","18"),n.setAttribute("height","18");for(const a of t){const r=document.createElementNS(Ue,"path");r.setAttribute("d",a),r.setAttribute("fill","none"),r.setAttribute("stroke","currentColor"),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round"),n.appendChild(r)}return n},ve=[{type:"love",label:"Favorite",className:"love",pathDs:["M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78Z"]},{type:"like",label:"Like",className:"like",pathDs:["M7 10v12","M15 5.88 14 10h6.14a2 2 0 0 1 1.94 2.46l-2.34 8.25A2 2 0 0 1 17.82 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.34a2 2 0 0 0 1.79-1.11l3.07-5.89A2 2 0 0 1 15 2a2 2 0 0 1 2 2v1.88Z"]},{type:"dislike",label:"Dislike",className:"dislike",pathDs:["M17 14V2","M9 18.12 10 14H3.86a2 2 0 0 1-1.94-2.46L4.26 3.29A2 2 0 0 1 6.18 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.34a2 2 0 0 0-1.79 1.11l-3.07 5.89A2 2 0 0 1 9 22a2 2 0 0 1-2-2v-1.88Z"]},{type:"funny",label:"Funny",className:"funny",pathDs:["M8 14s1.5 2 4 2 4-2 4-2","M9 9h.01","M15 9h.01","M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"]}],Y={type:"blacklist",label:"Blacklist",className:"blacklist",pathDs:["M18 6 6 18","M6 6l12 12","M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z"]};function Ie(t,n){const a=t.enabled??!0,r=t.getHintShown??(()=>!1),c=t.setHintShown??(()=>{}),L=()=>{r()||(c(!0),t.showToast("Hotkeys: Alt+Left=Like, Alt+Middle=Love, Alt+Right=Dislike"))},S=(h,R,f,b=null)=>{window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:h,pending:R,reactionType:f,url:b}}))},I=h=>(typeof h.composedPath=="function"?h.composedPath():[]).some(f=>f instanceof HTMLElement&&f.id===n.rootId);document.addEventListener("click",h=>{!a||!(h instanceof MouseEvent)||!h.altKey||t.isSheetOpen()||I(h)||!((h.target instanceof Element?h.target:null)?.closest?.("img, video")??null)||(h.preventDefault(),h.stopPropagation(),h.stopImmediatePropagation())},!0),document.addEventListener("mousedown",h=>{if(!a||!(h instanceof MouseEvent)||!h.altKey||t.isSheetOpen()||I(h))return;const f=(h.target instanceof Element?h.target:null)?.closest?.("img, video")??null;if(!f)return;const b=h.button===0?"like":h.button===1?"love":null;if(!b)return;L(),h.preventDefault(),h.stopPropagation(),h.stopImmediatePropagation();const P=we(f,n.minSize);if(!P){if(f instanceof HTMLVideoElement){const ce=(f.currentSrc||f.src||"").trim().toLowerCase();if(ce.startsWith("blob:")||ce.startsWith("data:")){const W=window.location.href,T={type:b,url:W,referrer_url:W,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:"video",width:f.videoWidth||f.clientWidth||null,height:f.videoHeight||f.clientHeight||null,alt:"",preview_url:f.poster||"",source:n.sourceFromMediaUrl(W),download_via:"yt-dlp"};n.fetchAtlasStatus(t.sendMessageSafe,T.url,T.referrer_url||null,A=>{if(A?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(y=>{if(y==="alternate"){t.showToast("Cancelled.");return}S(f,!0,b,T.url),y==="confirm"&&(T.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:T},_=>{if(!_||!_.ok){S(f,!1,null,T.url),t.showToast(_?.error||"Reaction failed.","danger");return}const k=_.data||null,g=k?.file||null,$=k?.reaction?.type?String(k.reaction.type):b;n.atlasStatusCache.set(T.url,{exists:!!g,downloaded:!!g?.downloaded,blacklisted:!!g?.blacklisted_at,reactionType:$,ts:Date.now()}),S(f,!1,$,T.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}S(f,!0,b,T.url),t.sendMessageSafe({type:"atlas-react",payload:T},y=>{if(!y||!y.ok){S(f,!1,null,T.url),t.showToast(y?.error||"Reaction failed.","danger");return}const _=y.data||null,k=_?.file||null,g=_?.reaction?.type?String(_.reaction.type):b;n.atlasStatusCache.set(T.url,{exists:!!k,downloaded:!!k?.downloaded,blacklisted:!!k?.blacklisted_at,reactionType:g,ts:Date.now()}),S(f,!1,g,T.url),t.showToast(`Reacted (${b}). Resolving video in Atlas…`)})});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const N={type:b,url:P.url,referrer_url:P.referrer_url||window.location.href,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:P.tag_name,width:P.width,height:P.height,alt:n.limitString(P.alt||"",n.maxMetadataLen),preview_url:P.preview_url||"",source:n.sourceFromMediaUrl(P.url)};n.fetchAtlasStatus(t.sendMessageSafe,N.url,N.referrer_url||null,ce=>{if(ce?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(W=>{if(W==="alternate"){t.showToast("Cancelled.");return}S(f,!0,b,N.url),W==="confirm"&&(N.force_download=!0),t.sendMessageSafe({type:"atlas-react",payload:N},T=>{if(!T||!T.ok){S(f,!1,null,N.url),t.showToast(T?.error||"Reaction failed.","danger");return}const A=T.data||null,y=A?.file||null,_=A?.reaction?.type?String(A.reaction.type):b;n.atlasStatusCache.set(N.url,{exists:!!y,downloaded:!!y?.downloaded,blacklisted:!!y?.blacklisted_at,reactionType:_,ts:Date.now()}),S(f,!1,_,N.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})});return}S(f,!0,b,N.url),t.sendMessageSafe({type:"atlas-react",payload:N},W=>{if(!W||!W.ok){S(f,!1,null,N.url),t.showToast(W?.error||"Reaction failed.","danger");return}const T=W.data||null,A=T?.file||null,y=T?.reaction?.type?String(T.reaction.type):b;n.atlasStatusCache.set(N.url,{exists:!!A,downloaded:!!A?.downloaded,blacklisted:!!A?.blacklisted_at,reactionType:y,ts:Date.now()}),S(f,!1,y,N.url),t.showToast(`Reacted (${b}). Queued download in Atlas.`)})})},!0),document.addEventListener("contextmenu",h=>{if(!a||!(h instanceof MouseEvent)||!h.altKey||t.isSheetOpen()||I(h))return;const f=(h.target instanceof Element?h.target:null)?.closest?.("img, video")??null;if(!f)return;L(),h.preventDefault(),h.stopPropagation(),h.stopImmediatePropagation();const b=we(f,n.minSize);if(!b){if(f instanceof HTMLVideoElement){const N=(f.currentSrc||f.src||"").trim().toLowerCase();if(N.startsWith("blob:")||N.startsWith("data:")){const ce=window.location.href,W={type:"dislike",url:ce,referrer_url:ce,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:"video",width:f.videoWidth||f.clientWidth||null,height:f.videoHeight||f.clientHeight||null,alt:"",preview_url:f.poster||"",source:n.sourceFromMediaUrl(ce),download_via:"yt-dlp"};S(f,!0,"dislike",W.url),t.sendMessageSafe({type:"atlas-react",payload:W},T=>{if(!T||!T.ok){S(f,!1,null,W.url),t.showToast(T?.error||"Reaction failed.","danger");return}S(f,!1,"dislike",W.url),t.showToast("Disliked.")});return}t.showToast("No direct video URL found.");return}t.showToast("No valid media URL found.");return}const P={type:"dislike",url:b.url,referrer_url:b.referrer_url||window.location.href,page_title:n.limitString(document.title,n.maxMetadataLen),tag_name:b.tag_name,width:b.width,height:b.height,alt:n.limitString(b.alt||"",n.maxMetadataLen),preview_url:b.preview_url||"",source:n.sourceFromMediaUrl(b.url)};S(f,!0,"dislike",P.url),t.sendMessageSafe({type:"atlas-react",payload:P},N=>{if(!N||!N.ok){S(f,!1,null,P.url),t.showToast(N?.error||"Reaction failed.","danger");return}S(f,!1,"dislike",P.url),t.showToast("Disliked.")})},!0)}function $e(t,n,a){return t<n?n:t>a?a:t}function He(t,n,a){const r=we(t,a.minSize);if(r)return{type:n,url:r.url,referrer_url:r.referrer_url||window.location.href,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:r.tag_name,width:r.width,height:r.height,alt:a.limitString(r.alt||"",a.maxMetadataLen),preview_url:r.preview_url||"",source:a.sourceFromMediaUrl(r.url)};if(t instanceof HTMLVideoElement){const c=(t.currentSrc||t.src||"").trim().toLowerCase();if(c.startsWith("blob:")||c.startsWith("data:")){const L=window.location.href;return{type:n,url:L,referrer_url:L,page_title:a.limitString(document.title,a.maxMetadataLen),tag_name:"video",width:t.videoWidth||t.clientWidth||null,height:t.videoHeight||t.clientHeight||null,alt:"",preview_url:t.poster||"",source:a.sourceFromMediaUrl(L),download_via:"yt-dlp"}}}return null}function We(t,n){const a=document.createElement("div");a.className="atlas-downloader-media-toolbar",a.setAttribute("role","toolbar"),a.setAttribute("aria-label","Atlas reactions");const r=document.createElement("span");r.className="atlas-downloader-media-resolution",r.hidden=!0,a.appendChild(r);let c=null,L=null,S=null,I=!1,h=null,R=null,f=-1,b=-1,P=null;const N=new Map,ce=(s,p)=>{const C=typeof s=="number"&&Number.isFinite(s)&&s>0?Math.round(s):null,F=typeof p=="number"&&Number.isFinite(p)&&p>0?Math.round(p):null;return!C||!F?"":`${C}x${F}`},W=(s,p)=>{const C=ce(s,p);if(!C){r.textContent="",r.hidden=!0;return}r.textContent=C,r.hidden=!1},T=()=>{const s=I||h!==null;for(const[p,C]of N.entries())C.disabled=s,C.classList.toggle("pending",I&&R===p)},A=(s,p=null)=>{I=s,R=s?p:null,T()},y=s=>{for(const p of[...ve,Y]){const C=N.get(p.type);if(!C)continue;const F=p.type===Y.type?s==="dislike":s===p.type;C.classList.toggle("active",F)}},_=(s,p)=>{h=s&&p===!1&&s!=="dislike"?s:null;for(const C of[...ve,Y]){const F=N.get(C.type);if(!F)continue;const U=C.type===Y.type?h==="dislike":h===C.type;F.classList.toggle("queued",U)}T()},k=(s,p,C)=>{c&&window.dispatchEvent(new CustomEvent("atlas-shortcut-reaction-state",{detail:{media:c,pending:s,reactionType:p,url:C}}))},g=()=>{S&&(window.clearTimeout(S),S=null)},$=()=>{I||(c=null,L=null,a.classList.remove("open"),a.style.left="",a.style.top="",W(null,null),y(null))},O=()=>{g(),S=window.setTimeout(()=>{a.matches(":hover")||$()},140)},z=s=>{s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation?.()};for(const s of[...ve,Y]){const p=document.createElement("button");p.type="button",p.className=`atlas-downloader-reaction-btn ${s.className}`.trim(),p.setAttribute("aria-label",s.label),p.title=s.label,p.replaceChildren(ke(s.pathDs)),N.set(s.type,p),p.addEventListener("pointerdown",z,!0),p.addEventListener("mousedown",z,!0),p.addEventListener("click",C=>{if(z(C),I)return;if(!c){t.showToast("No media selected.");return}const F=s.type===Y.type?"dislike":s.type,U=He(c,F,n);if(!U){t.showToast("No valid media URL found.");return}const H=U.url||"",Z=(ne=!1)=>{ne?U.force_download=!0:"force_download"in U&&delete U.force_download,k(!0,s.type,H||null),A(!0,s.type),t.sendMessageSafe({type:"atlas-react",payload:{...U,...s.type===Y.type?{blacklist:!0}:{}}},E=>{if(A(!1,null),!E||!E.ok){k(!1,null,H||null),t.showToast(E?.error||"Reaction failed.","danger");return}const re=E.data||null,te=re?.file||null,se=re?.reaction?.type?String(re.reaction.type):s.type===Y.type?"dislike":s.type;if(H&&n.atlasStatusCache.set(H,{exists:!!te,downloaded:!!te?.downloaded,blacklisted:!!te?.blacklisted_at,reactionType:se,ts:Date.now()}),y(se),_(se,!!te?.downloaded),k(!1,se,H||null),U.download_via==="yt-dlp"){t.showToast(`Reacted (${s.label}). Resolving video in Atlas…`);return}t.showToast(`Reacted (${s.label}). Queued download in Atlas.`)})};n.fetchAtlasStatus(t.sendMessageSafe,H,U.referrer_url||null,ne=>{if(F!=="dislike"&&ne?.downloaded){t.chooseDialog({title:"Already downloaded",message:"Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(E=>{if(E==="alternate"){t.showToast("Cancelled.");return}Z(E==="confirm")});return}Z(!1)})}),a.appendChild(p)}t.root.appendChild(a);const le=s=>(typeof s.composedPath=="function"?s.composedPath():[]).some(C=>C instanceof HTMLElement&&C.id===n.rootId),M=()=>{if(!c)return;const s=c.getBoundingClientRect();if(!Number.isFinite(s.left)||s.width<=0||s.height<=0){$();return}const p=$e(s.top+8,8,window.innerHeight-8),C=$e(s.right-8,8,window.innerWidth-8);a.style.top=`${p}px`,a.style.left=`${C}px`},V=(s,p)=>{const C=H=>{if(H.matches("img, video"))return H;const Z=H.closest?.("img, video");if(Z instanceof Element)return Z;const ne=H.querySelectorAll?.("img, video");if(!ne||ne.length===0)return null;for(const E of ne){const re=E.getBoundingClientRect();if(s>=re.left&&s<=re.right&&p>=re.top&&p<=re.bottom)return E}return null},F=document.elementsFromPoint?.(s,p)??[];for(const H of F){if(!(H instanceof Element)||H.closest?.(`#${n.rootId}`))continue;const Z=C(H);if(Z)return Z}const U=document.elementFromPoint?.(s,p);return U instanceof Element&&!U.closest?.(`#${n.rootId}`)?C(U):null},Q=s=>{if(t.isSheetOpen()){$();return}const p=He(s,"like",n);if(!p){$();return}if(c=s,L=p.url||null,W(p.width,p.height),a.classList.add("open"),M(),y(null),_(null,null),L){const C=n.getCachedAtlasStatus(L);if(C)y(C.reactionType),_(C.reactionType,C.downloaded);else{const F=L;n.fetchAtlasStatus(t.sendMessageSafe,F,window.location.href,U=>{U&&L===F&&(y(U.reactionType),_(U.reactionType,U.downloaded))})}}},pe=s=>s?s==="blacklist"?"blacklist":s:null,oe=()=>{if(f<0||b<0||t.isSheetOpen())return;const s=V(f,b);s&&(s.closest?.(`#${n.rootId}`)||(g(),Q(s)))},ee=(s=80)=>{P!==null&&window.clearTimeout(P),P=window.setTimeout(()=>{P=null,oe()},s)};document.addEventListener("pointerover",s=>{if(t.isSheetOpen()||!(s.target instanceof Element)||le(s))return;const p=V(s.clientX,s.clientY);p&&(g(),Q(p))},!0),window.addEventListener("atlas-shortcut-reaction-state",s=>{const p=s,C=p.detail?.media;if(!(C instanceof Element))return;g(),Q(C);const F=!!p.detail?.pending,U=pe(p.detail?.reactionType??null);if(F){A(!0,U);return}if(A(!1,null),U){const H=U==="blacklist"?"dislike":U;y(H);const Z=L?n.getCachedAtlasStatus(L):null;_(H,Z?.downloaded??null)}},!0),document.addEventListener("pointermove",s=>{f=s.clientX,b=s.clientY},!0),document.addEventListener("pointerout",s=>{!c||t.isSheetOpen()||!(s.target instanceof Element)||le(s)||!(s.target.closest?.("img, video")??null)||O()},!0),a.addEventListener("pointerenter",g,!0),a.addEventListener("pointerleave",O,!0),window.addEventListener("scroll",M,!0),window.addEventListener("resize",M),window.addEventListener("blur",$),window.addEventListener("focus",()=>ee(40),!0),new MutationObserver(()=>{ee(60)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","style","class"]})}function j(t){const n=t.indexOf("#");return n===-1?t:t.slice(0,n)}function Oe(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(n=>n.trim()).filter(n=>n&&!n.startsWith("#")).map(n=>(n.startsWith("*.")?n.slice(2):n).toLowerCase()).map(n=>_e(n)||n.replace(/^\.+/,"").trim()).filter(Boolean)}function Fe(t,n){const a=(t||"").toLowerCase();if(!a)return!1;for(const r of n)if(xe(a,r))return!0;return!1}function _e(t){if(!t||typeof t!="string")return"";const n=t.trim();if(!n)return"";const a=/^https?:\/\//i.test(n)?n:`https://${n}`;try{return new URL(a).hostname}catch{return""}}function xe(t,n){return!t||!n?!1:t===n||t.endsWith(`.${n}`)}const je="atlas-downloader-page-markers";function Qe(t){return function(a,r="info"){const c=document.createElement("div");c.className=`atlas-downloader-toast${r==="danger"?" danger":""}`,c.textContent=a,t.appendChild(c),requestAnimationFrame(()=>c.classList.add("show")),setTimeout(()=>{c.classList.remove("show"),c.addEventListener("transitionend",()=>c.remove(),{once:!0})},2600)}}function qe(t){return n=>new Promise(a=>{const r=document.createElement("div");r.className="atlas-downloader-dialog-backdrop";const c=document.createElement("div");c.className=`atlas-downloader-dialog${n.danger?" danger":""}`.trim(),c.setAttribute("role","dialog"),c.setAttribute("aria-modal","true"),c.setAttribute("aria-label",n.title);const L=document.createElement("h3");L.className="atlas-downloader-dialog-title",L.textContent=n.title;const S=document.createElement("p");S.className="atlas-downloader-dialog-message",S.textContent=n.message;const I=document.createElement("div");I.className="atlas-downloader-dialog-actions";const h=b=>{r.remove(),a(b)};if(n.alternateLabel){const b=document.createElement("button");b.type="button",b.className="atlas-downloader-dialog-btn secondary",b.textContent=n.alternateLabel,b.addEventListener("click",()=>h("alternate")),I.appendChild(b)}const R=document.createElement("button");R.type="button",R.className="atlas-downloader-dialog-btn",R.textContent=n.cancelLabel||"Cancel",R.addEventListener("click",()=>h("cancel")),I.appendChild(R);const f=document.createElement("button");f.type="button",f.className=`atlas-downloader-dialog-btn primary${n.danger?" danger":""}`.trim(),f.textContent=n.confirmLabel,f.addEventListener("click",()=>h("confirm")),I.appendChild(f),c.appendChild(L),c.appendChild(S),c.appendChild(I),r.appendChild(c),t.appendChild(r),requestAnimationFrame(()=>{f.focus()})})}function gt(){if(document.getElementById(je))return;const t=document.createElement("style");t.id=je,t.textContent=`
[data-atlas-marked="1"][data-atlas-state="exists"] {
  outline: 4px solid rgba(148, 163, 184, 0.5) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="downloaded"] {
  outline: 4px solid rgba(34, 197, 94, 0.85) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="blacklisted"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="love"] {
  outline: 4px solid rgba(239, 68, 68, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="like"] {
  outline: 4px solid rgba(56, 189, 248, 0.9) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="funny"] {
  outline: 4px solid rgba(234, 179, 8, 0.95) !important;
  outline-offset: -4px !important;
}
[data-atlas-marked="1"][data-atlas-state="reacted"][data-atlas-reaction="dislike"] {
  outline: 4px solid rgba(71, 85, 105, 0.95) !important;
  outline-offset: -4px !important;
}
`,(document.head||document.documentElement).appendChild(t)}(()=>{const a="atlas-downloader-root",r="atlas-open",c=(()=>{try{return window.top===window.self}catch{return!1}})(),L=(()=>{try{return chrome.runtime.getManifest?.().version??""}catch{return""}})();let S=null,I=null;const h=3e4,R=new Map;function f(A,y){const _=typeof A=="string"?A:"";return _.length<=y?_:_.slice(0,y)}function b(A){return ot(A)||"Extension"}function P(A){const y=R.get(A);return y?Date.now()-y.ts>h?(R.delete(A),null):y:null}function N(A,y,_,k){const g=j((y||"").trim());if(!g){k(null);return}const $=P(g);if($){k($);return}A({type:"atlas-check-batch",urls:[g]},O=>{if(!O||!O.ok){k(null);return}const z=Array.isArray(O.data?.results)?O.data.results:[],M=new Map(z.filter(Q=>typeof Q?.url=="string"&&Q.url.trim()!=="").map(Q=>[j(String(Q.url)),Q])).get(g)??null;if(!M){k(null);return}const V={exists:!!M.exists,downloaded:!!M.downloaded,blacklisted:!!M.blacklisted,reactionType:M.reaction?.type?String(M.reaction.type):null,ts:Date.now()};R.set(g,V),k(V)})}chrome.runtime.onMessage.addListener(A=>{if(!A||typeof A!="object")return;const y=A;if(y.type==="atlas-download-event"){I?.(y.payload);return}if(y.type==="atlas-open-sheet"&&c)try{chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],_=>{const k=_e(_.atlasBaseUrl||"");if(k&&xe(window.location.hostname,k))return;const g=Oe(_.atlasExcludedDomains||"");Fe(window.location.hostname,g)||(W(),S?.())})}catch{}}),chrome.storage.sync.get(["atlasBaseUrl","atlasExcludedDomains"],A=>{const y=_e(A.atlasBaseUrl||"");if(y&&xe(window.location.hostname,y))return;const _=Oe(A.atlasExcludedDomains||"");Fe(window.location.hostname,_)||(c?W():ce())});function ce(){if(document.getElementById(a))return;const A=document.createElement("div");A.id=a;const y=A.attachShadow({mode:"closed"}),_=document.createElement("link");_.rel="stylesheet",_.href=chrome.runtime.getURL("dist/content.css"),y.appendChild(_);const k=document.createElement("div");k.className="atlas-shadow-root";const g=Qe(k),$=qe(k),O=(z,le)=>{try{chrome.runtime.sendMessage(z,le)}catch(M){(()=>{if(M instanceof Error)return M.message;if(M&&typeof M=="object"&&"message"in M){const Q=M.message;return typeof Q=="string"?Q:String(Q)}return String(M)})().includes("Extension context invalidated")?g("Atlas extension was reloaded. Refresh this tab.","danger"):g("Atlas extension error. Refresh this tab.","danger"),le(null)}};y.appendChild(k),(document.body||document.documentElement).appendChild(A),Ie({showToast:g,sendMessageSafe:O,isSheetOpen:()=>!1,chooseDialog:$},{rootId:a,minSize:250,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:b,fetchAtlasStatus:N,atlasStatusCache:R,getCachedAtlasStatus:P}),We({root:k,showToast:g,sendMessageSafe:O,isSheetOpen:()=>!1,chooseDialog:$},{rootId:a,minSize:250,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:b,fetchAtlasStatus:N,atlasStatusCache:R,getCachedAtlasStatus:P})}function W(){if(document.getElementById(a))return;const A=document.createElement("div");A.id=a;const y=A.attachShadow({mode:"closed"}),_=document.createElement("link");_.rel="stylesheet",_.href=chrome.runtime.getURL("dist/content.css"),y.appendChild(_);const k=document.createElement("div");k.className="atlas-shadow-root";const g=Qe(k),$=(e,o)=>{try{chrome.runtime.sendMessage(e,o)}catch(l){(()=>{if(l instanceof Error)return l.message;if(l&&typeof l=="object"&&"message"in l){const u=l.message;return typeof u=="string"?u:String(u)}return String(l)})().includes("Extension context invalidated")?g("Atlas extension was reloaded. Refresh this tab.","danger"):g("Atlas extension error. Refresh this tab.","danger"),o(null)}},O=document.createElement("button");O.className="atlas-downloader-toggle",O.type="button",O.setAttribute("aria-label","Atlas Downloader"),O.title="Atlas Downloader";const z=document.createElement("img");z.alt="",z.src=chrome.runtime.getURL("icon.svg"),O.appendChild(z);const le=document.createElement("div");le.className="atlas-downloader-overlay";const M=document.createElement("div");M.className="atlas-downloader-modal",M.setAttribute("role","dialog"),M.setAttribute("aria-modal","true"),M.setAttribute("aria-label","Atlas Media Picker");const V=document.createElement("div");V.className="atlas-downloader-header";const Q=document.createElement("div");Q.className="atlas-downloader-title",Q.textContent="Atlas Media Picker";const pe=document.createElement("div");pe.className="atlas-downloader-version",pe.textContent=L?`v${L}`:"";const oe=document.createElement("button");oe.type="button",oe.className="atlas-downloader-close",oe.setAttribute("aria-label","Close"),oe.textContent="x",V.appendChild(Q),V.appendChild(pe),V.appendChild(oe);const ee=document.createElement("div");ee.className="atlas-downloader-toolbar";const fe=ye("Rescan",()=>Ve()),s=ye("Check Atlas",()=>et(!1)),p=ye("Select all",()=>Ke(!0)),C=ye("Select none",()=>Ke(!1)),F=document.createElement("span");F.className="spacer";const U=ye("Queue selected",()=>_t(),{primary:!0});ee.appendChild(fe),ee.appendChild(s),ee.appendChild(p),ee.appendChild(C),ee.appendChild(F),ee.appendChild(U);const H=document.createElement("div");H.className="atlas-downloader-meta";const Z=document.createElement("div");Z.className="atlas-downloader-list",M.appendChild(V),M.appendChild(ee),M.appendChild(H),M.appendChild(Z),k.appendChild(O),k.appendChild(le),k.appendChild(M),y.appendChild(k),(document.body||document.documentElement).appendChild(A);const ne=qe(k);let E=[],re=0,te=null,se=null,ge=null,Ee=null;const he=new Set,Te=new Map,wt=!0;let ze=!1;I=e=>{if(!e||typeof e!="object")return;const o=e,l=Number.isFinite(Number(o.transferId))?Number(o.transferId):null,i=typeof o.status=="string"?o.status:"",u=!!o.downloaded||i==="completed"||typeof o.finished_at=="string",m=!!o.failed||i==="failed"||i==="canceled"||typeof o.failed_at=="string",w=new Set,d=typeof o.original=="string"?j(o.original.trim()):"",v=typeof o.referrer_url=="string"?j(o.referrer_url.trim()):"";d&&w.add(d),v&&w.add(v);const x=l?Te.get(l)??"":"";if(x&&w.add(x),w.size===0)return;const q=d||x||v||"";l&&q&&!u&&!m&&Te.set(l,q);let G=!1;for(const B of w){const de=P(B);R.set(B,{exists:!0,downloaded:u,blacklisted:de?!!de.blacklisted:!1,reactionType:de?.reactionType??null,ts:Date.now()})}for(const B of E){const de=ie(B)||j(String(B.url||""));!de||!w.has(de)||!he.has(de)&&B.status!=="Queued"||(B.atlas={exists:!0,downloaded:u,blacklisted:B.atlas?.blacklisted??!1,file_id:B.atlas?.file_id??null,reaction:B.atlas?.reaction??null},u?(B.status="",B.statusClass="",B.reactionQueued=null,he.delete(de)):m?(B.status="Failed",B.statusClass="err",B.reactionQueued=null,he.delete(de)):(B.status="Queued",B.statusClass="queued"),G=!0)}l&&(u||m)&&Te.delete(l),G&&(J(),K(X()),me(E))},O.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Me()}),le.addEventListener("click",()=>be()),oe.addEventListener("click",()=>be()),document.addEventListener("keydown",e=>{const o=e.key.toLowerCase();if(e.altKey&&e.shiftKey&&o==="a"){e.preventDefault(),Me();return}if(e.key==="Escape"&&k.classList.contains(r)){be();return}if(!k.classList.contains(r))return;const l=e.key==="1"?"love":e.key==="2"?"like":e.key==="3"?"funny":null;if(!l)return;const i=E.find(u=>u.selected)??E[0]??null;i&&(e.preventDefault(),Ne(i,l,{closeOnSuccess:!0}))});function bt(){k.classList.add(r),Ve()}function Me(){if(k.classList.contains(r)){be();return}bt()}function be(){k.classList.remove(r)}S=Me,Ie({showToast:g,sendMessageSafe:$,isSheetOpen:()=>k.classList.contains(r),chooseDialog:ne,setHintShown:e=>{ze=e},getHintShown:()=>ze,enabled:wt},{rootId:a,minSize:250,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:b,fetchAtlasStatus:N,atlasStatusCache:R,getCachedAtlasStatus:P}),We({root:k,showToast:g,sendMessageSafe:$,isSheetOpen:()=>k.classList.contains(r),chooseDialog:ne},{rootId:a,minSize:250,maxMetadataLen:500,limitString:f,sourceFromMediaUrl:b,fetchAtlasStatus:N,atlasStatusCache:R,getCachedAtlasStatus:P}),window.addEventListener("atlas-shortcut-reaction-state",e=>{const o=e,l=!!o.detail?.pending,i=o.detail?.reactionType?String(o.detail.reactionType):null,m=(typeof o.detail?.url=="string"?o.detail.url:"")||o.detail?.media&&we(o.detail.media,250)?.url||"",w=m?j(m):"";if(l){te=w||"__external-reaction__",se=i||se||"like";for(const d of E)w&&(ie(d)||j(String(d.url||"")))!==w||(d.reactionPending=i||d.reactionPending||"like");J(),K(X());return}te=null,se=null;for(const d of E){if(w&&(ie(d)||j(String(d.url||"")))!==w)continue;d.reactionPending&&(d.reactionPending=null);const v=(w?P(w):null)??P(ie(d))??P(j(String(d.url||"")));v?d.atlas={exists:!!v.exists,downloaded:!!v.downloaded,blacklisted:!!v.blacklisted,file_id:d.atlas?.file_id??null,reaction:v.reactionType?{type:v.reactionType}:d.atlas?.reaction??null}:i&&(d.atlas={exists:d.atlas?.exists??!0,downloaded:d.atlas?.downloaded??!1,blacklisted:d.atlas?.blacklisted??!1,file_id:d.atlas?.file_id??null,reaction:{type:i}}),d.atlas?.exists&&!d.atlas?.downloaded&&d.atlas?.reaction?.type&&d.atlas.reaction.type!=="dislike"?d.reactionQueued=d.atlas.reaction.type:d.reactionQueued=null}J(),K(X()),me(E)},!0);const Ae=(e=300)=>{Ee!==null&&window.clearTimeout(Ee),Ee=window.setTimeout(()=>{Ee=null,Tt()},e)};new MutationObserver(()=>{me(E),Ae(450)}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","srcset","href","style","class"]}),window.addEventListener("pageshow",()=>Ae(80),!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&Ae(120)},!0),Ae(120);function ye(e,o,l){const i=document.createElement("button");return i.type="button",i.className=`atlas-downloader-btn${l?.primary?" primary":""}`,i.textContent=e,i.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),o()}),i}function yt(e){H.textContent=e,U.disabled=!0,fe.disabled=!0,s.disabled=!0,p.disabled=!0,C.disabled=!0}function K(e){H.textContent=e;const o=E.filter(i=>i.selected).length,l=E.some(i=>!!i.reactionPending)||te!==null;U.disabled=o===0||l,fe.disabled=l,s.disabled=E.length===0||l,p.disabled=E.length===0||l,C.disabled=E.length===0||l}function Ve(){re+=1;const e=re;E=[],ge=null,Z.replaceChildren(),yt("Scanning this page…"),T(o=>{re===e&&(H.textContent=`Scanning… ${o.scanned}/${o.total}`)}).then(o=>{re===e&&(E=o.map(l=>({...l,selected:!0,status:"",statusClass:"",atlas:null,reactionPending:te&&te!=="__external-reaction__"&&(ie(l)||j(String(l.url||"")))===te?se||"like":null,reactionQueued:null})),J(),K(X()),et(!0))})}function Ke(e){for(const o of E)o.selected=e;J(),K(X())}function J(){if(Z.replaceChildren(),E.length===0){const e=document.createElement("div");e.style.padding="10px 12px",e.style.color="#94a3b8",e.style.fontSize="12px",e.textContent="No matching images/videos found.",Z.appendChild(e);return}for(const e of E)Z.appendChild(kt(e))}function kt(e){const o=document.createElement("div");o.className=`atlas-downloader-item${e.selected?" selected":""}`;const l=document.createElement("input");l.type="checkbox",l.checked=e.selected,l.addEventListener("change",()=>{e.selected=l.checked,o.classList.toggle("selected",e.selected),K(X())});const i=document.createElement("div");if(i.className="atlas-downloader-preview",e.preview_url){const D=document.createElement("img");D.loading="lazy",D.alt="",D.src=e.preview_url,i.appendChild(D)}const u=document.createElement("div");u.className="atlas-downloader-info";const m=document.createElement("div");m.className="atlas-downloader-kind",m.textContent=e.tag_name;const w=document.createElement("div");w.className="atlas-downloader-url",w.textContent=e.url,w.title=e.url;const d=document.createElement("div");d.className="atlas-downloader-sub",d.textContent=At(e);const v=document.createElement("div");v.className="atlas-downloader-reactions";const x=e.atlas?.reaction?.type||null,q=!!e.reactionPending||!!e.reactionQueued;for(const D of ve){const ue=document.createElement("button");ue.type="button",ue.className=`atlas-downloader-reaction-btn ${D.className}${x===D.type?" active":""}${e.reactionPending===D.type?" pending":""}${e.reactionQueued===D.type?" queued":""}`.trim(),ue.setAttribute("aria-label",D.label),ue.title=D.label,ue.replaceChildren(ke(D.pathDs)),ue.disabled=q,ue.addEventListener("click",nt=>{nt.preventDefault(),nt.stopPropagation(),Ne(e,D.type)}),v.appendChild(ue)}const G=document.createElement("button");if(G.type="button",G.className=`atlas-downloader-reaction-btn ${Y.className}${e.atlas?.blacklisted?" active":""}${e.reactionPending===Y.type?" pending":""}${e.reactionQueued===Y.type?" queued":""}`.trim(),G.setAttribute("aria-label",Y.label),G.title=Y.label,G.replaceChildren(ke(Y.pathDs)),G.disabled=q,G.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation(),Ne(e,"dislike",{blacklist:!0})}),v.appendChild(G),e.atlas?.downloaded){const D=document.createElement("button");D.type="button",D.className=`atlas-downloader-reaction-btn delete${e.reactionPending==="delete-download"?" pending":""}`.trim(),D.setAttribute("aria-label","Delete download"),D.title="Delete download",D.replaceChildren(ke(["M3 6h18","M8 6V4h8v2","M8 10v8","M12 10v8","M16 10v8","M6 6l1 14h10l1-14"])),D.disabled=q,D.addEventListener("click",ue=>{ue.preventDefault(),ue.stopPropagation(),Lt(e)}),v.appendChild(D)}const B=document.createElement("button");B.type="button",B.className=`atlas-downloader-debug-toggle${ge===e.url?" active":""}`,B.textContent=ge===e.url?"Hide debug":"Debug",B.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation(),ge=ge===e.url?null:e.url,J(),K(X())}),v.appendChild(B),u.appendChild(m),u.appendChild(w),u.appendChild(d),u.appendChild(v),ge===e.url&&u.appendChild(vt(e));const de=document.createElement("div"),tt=Ct(e);return de.className=`atlas-downloader-status ${tt.className}`.trim(),de.textContent=tt.text,o.addEventListener("click",D=>{D.target instanceof HTMLInputElement||(e.selected=!e.selected,l.checked=e.selected,o.classList.toggle("selected",e.selected),K(X()))}),o.appendChild(l),o.appendChild(i),o.appendChild(u),o.appendChild(de),o}function Xe(e,o){return{type:o,url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:f(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:f(e.alt||"",500),preview_url:e.preview_url||"",source:b(e.url),...e.download_via?{download_via:e.download_via}:{}}}function Ze(e){return{url:e.url,referrer_url:e.referrer_url||window.location.href,page_title:f(document.title,500),tag_name:e.tag_name,width:e.width,height:e.height,alt:f(e.alt||"",500),preview_url:e.preview_url||"",source:b(e.url),...e.download_via?{download_via:e.download_via}:{},reaction_type:"like"}}function vt(e){const o=document.createElement("details");o.className="atlas-downloader-debug",o.open=!0;const l=document.createElement("summary");l.textContent="Debug payload",o.appendChild(l);const i={react:Xe(e,e.atlas?.reaction?.type||"like"),download:Ze(e)};return o.appendChild(Et(i)),o}function Et(e,o=0){const l=document.createElement("div");l.className="atlas-downloader-json-tree";const i=Se(e);if(!Ye(i)){const m=document.createElement("div");return m.className="atlas-downloader-json-line",m.textContent=Ge(i),l.appendChild(m),l}const u=Array.isArray(i)?i.map((m,w)=>[String(w),m]):Object.entries(i);for(const[m,w]of u)l.appendChild(Je(m,w,o));return l}function Je(e,o,l){const i=Se(o),u=document.createElement("div");if(u.className="atlas-downloader-json-line",u.style.paddingLeft=`${l*12}px`,!Ye(i))return u.innerHTML=`<span class="atlas-downloader-json-key">${Ce(e)}</span>: <span class="atlas-downloader-json-value">${Ce(Ge(i))}</span>`,u;const m=document.createElement("details");m.className="atlas-downloader-json-node",m.open=l===0;const w=document.createElement("summary");w.style.paddingLeft=`${l*12}px`;const d=Array.isArray(i)?`[${i.length}]`:`{${Object.keys(i).length}}`;w.innerHTML=`<span class="atlas-downloader-json-key">${Ce(e)}</span>: <span class="atlas-downloader-json-preview">${Ce(d)}</span>`,m.appendChild(w);const v=Array.isArray(i)?i.map((x,q)=>[String(q),x]):Object.entries(i);for(const[x,q]of v)m.appendChild(Je(x,q,l+1));return m}function Se(e){if(e===void 0)return null;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(l=>Se(l));if(!e||typeof e!="object")return null;const o={};for(const[l,i]of Object.entries(e))o[l]=Se(i);return o}function Ye(e){return Array.isArray(e)||e&&typeof e=="object"}function Ge(e){return JSON.stringify(e)}function Ce(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function At(e){const o=e.width&&e.height?`${e.width}×${e.height}`:"size unknown",l=St(e.url);return l?`${o} • ${l}`:o}function St(e){try{return new URL(e).hostname}catch{return""}}function X(){const e=E.filter(o=>o.selected).length;return`${E.length} found • ${e} selected`}function ie(e){const o=(e?.url||e?.referrer_url||"").trim();return o?j(o):""}function Ct(e){return e.status?{text:e.status,className:e.statusClass||""}:e.atlas?.downloaded?{text:"Downloaded",className:"ok"}:e.atlas?.blacklisted?{text:"Blacklisted",className:"err"}:e.atlas?.exists?{text:"In Atlas",className:""}:{text:"",className:""}}function et(e){const o=[...new Set(E.map(l=>ie(l)).filter(Boolean))];o.length!==0&&$({type:"atlas-check-batch",urls:o},l=>{if(!l){e||g("Atlas extension did not respond.","danger");return}if(!l.ok){e||g(l.error||"Atlas check failed.","danger");return}const i=Array.isArray(l.data?.results)?l.data.results:[],u=new Map(i.filter(d=>typeof d?.url=="string"&&d.url.trim()!=="").map(d=>[j(String(d.url)),d]));let m=0,w=0;for(const d of E){const v=ie(d),x=u.get(v);x&&(d.atlas={exists:!!x.exists,downloaded:!!x.downloaded,blacklisted:!!x.blacklisted,file_id:x.file_id??null,reaction:x.reaction??null},d.atlas.exists&&!d.atlas.downloaded&&d.atlas.reaction?.type&&d.atlas.reaction.type!=="dislike"?(d.reactionQueued=d.atlas.reaction.type,he.add(v)):(d.reactionQueued=null,he.delete(v)),R.set(v,{exists:!!x.exists,downloaded:!!x.downloaded,blacklisted:!!x.blacklisted,reactionType:x.reaction?.type?String(x.reaction.type):null,ts:Date.now()}),x.exists&&(m+=1),x.downloaded&&(w+=1))}J(),K(X()),me(E),e||g(`Atlas check: ${w}/${m} downloaded.`)})}function Ne(e,o,l={}){const i=(m={})=>{e.reactionPending=l.blacklist?Y.type:o,e.status="Reacting…",e.statusClass="",te=ie(e)||e.url,se=e.reactionPending,J(),K(X());const w={...Xe(e,o),...m,...l.blacklist?{blacklist:!0}:{}};$({type:"atlas-react",payload:w},d=>{if(e.reactionPending=null,te=null,se=null,!d){e.status="No response",e.statusClass="err",J(),K(X()),g("Atlas extension did not respond.","danger");return}if(!d.ok){e.status=d.error||"Failed",e.statusClass="err",J(),K(X()),g(d.error||"Reaction failed.","danger");return}const v=d.data||null,x=v?.file||null;e.atlas={exists:!!x,downloaded:!!x?.downloaded,blacklisted:!!x?.blacklisted_at,file_id:x?.id??null,reaction:v?.reaction??null};const q=ie(e)||e.url;R.set(q,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:e.atlas.reaction?.type?String(e.atlas.reaction.type):null,ts:Date.now()}),e.atlas.exists&&!e.atlas.downloaded&&o!=="dislike"?(e.status="Queued",e.statusClass="queued",e.reactionQueued=l.blacklist?Y.type:o,q&&he.add(q)):(e.status="",e.statusClass="",e.reactionQueued=null,q&&he.delete(q)),J(),K(X()),me(E),l.closeOnSuccess&&be()})},u=!!e.atlas?.reaction?.type;if(o!=="dislike"&&e.atlas?.downloaded&&u){ne({title:"Already downloaded",message:"This file is already downloaded. Re-download before updating the reaction?",confirmLabel:"Re-download",cancelLabel:"Keep existing file",alternateLabel:"Cancel"}).then(m=>{if(m==="alternate"){g("Cancelled.");return}i(m==="confirm"?{force_download:!0}:{})});return}if(o==="dislike"&&e.atlas?.downloaded){ne({title:l.blacklist?"Blacklist file":"Dislike file",message:"Delete the downloaded file before applying this action?",confirmLabel:"Delete then proceed",cancelLabel:"Keep file and proceed",alternateLabel:"Cancel",danger:!0}).then(m=>{if(m==="alternate"){g("Cancelled.");return}i(m==="confirm"?{clear_download:!0}:{})});return}i()}function Lt(e){ne({title:"Delete downloaded file",message:"This removes the stored file from disk and keeps the Atlas record.",confirmLabel:"Delete download",cancelLabel:"Cancel",danger:!0}).then(o=>{o==="confirm"&&(e.reactionPending="delete-download",e.status="Deleting…",e.statusClass="",te=ie(e)||e.url,se=e.reactionPending,J(),K(X()),$({type:"atlas-delete-download",payload:{url:e.url,tag_name:e.tag_name,download_via:e.download_via||null}},l=>{if(e.reactionPending=null,te=null,se=null,!l||!l.ok){e.status=l?.error||"Failed",e.statusClass="err",J(),K(X()),g(l?.error||"Delete failed.","danger");return}const i=l.data?.file||null;e.atlas={exists:!!i,downloaded:!!i?.downloaded,blacklisted:!!i?.blacklisted_at,file_id:i?.id??null,reaction:null},e.reactionQueued=null;const u=ie(e)||e.url;R.set(u,{exists:e.atlas.exists,downloaded:e.atlas.downloaded,blacklisted:e.atlas.blacklisted,reactionType:null,ts:Date.now()}),e.status="",e.statusClass="",J(),K(X()),me(E),g("Download deleted.")}))})}function _t(){const e=E.filter(i=>i.selected);if(e.length===0){g("Select one or more items first.");return}if(e.some(i=>!!i.atlas?.downloaded)){ne({title:"Re-download selected files",message:"One or more selected files are already downloaded. Re-download them?",confirmLabel:"Re-download",cancelLabel:"Keep existing files",alternateLabel:"Cancel"}).then(i=>{if(i==="alternate"){g("Cancelled.");return}l(i==="confirm")});return}l(!1);function l(i){U.disabled=!0,fe.disabled=!0,s.disabled=!0,p.disabled=!0,C.disabled=!0;for(const m of e)m.status="Sending…",m.statusClass="";J();const u=e.map(m=>{const w=Ze(m);return i&&(w.force_download=!0),w});$({type:"atlas-download-batch",payloads:u},m=>{if(!m){for(const d of e)d.status="No response",d.statusClass="err";J(),K(X()),g("Atlas extension did not respond.","danger");return}const w=Array.isArray(m.results)?m.results:[];for(let d=0;d<e.length;d+=1){const v=e[d],x=w[d];if(x?.ok){const q=x.data||null,G=q?.file||null;if(v.atlas={exists:!!G,downloaded:!!G?.downloaded,blacklisted:!!G?.blacklisted_at,file_id:G?.id??null,reaction:v.atlas?.reaction??null},q?.queued){v.status="Queued",v.statusClass="queued",v.atlas?.reaction?.type&&v.atlas.reaction.type!=="dislike"&&(v.reactionQueued=v.atlas.reaction.type);const B=ie(v)||j(String(v.url||""));B&&he.add(B)}else{v.status="",v.statusClass="",v.reactionQueued=null;const B=ie(v)||j(String(v.url||""));B&&he.delete(B)}}else v.status=x?.error||"Failed",v.statusClass="err"}J(),K(X()),me(E),m.ok?g(`Queued ${e.length} download(s) in Atlas.`):g(m.error||"Some requests failed.","danger")})}}function me(e=E){gt();const o=document.querySelectorAll('[data-atlas-marked="1"]');for(const u of o)u.removeAttribute("data-atlas-marked"),u.removeAttribute("data-atlas-state"),u.removeAttribute("data-atlas-reaction");const l=new Map;for(const[u,m]of R.entries()){if(Date.now()-m.ts>h){R.delete(u);continue}l.set(u,{exists:!!m.exists,downloaded:!!m.downloaded,blacklisted:!!m.blacklisted,reactionType:m.reactionType?String(m.reactionType):null}),l.set(j(u),{exists:!!m.exists,downloaded:!!m.downloaded,blacklisted:!!m.blacklisted,reactionType:m.reactionType?String(m.reactionType):null})}for(const u of e){if(!u?.url||!u?.atlas)continue;const m=u.atlas?.reaction?.type?String(u.atlas.reaction.type):null,w={exists:!!u.atlas.exists,downloaded:!!u.atlas.downloaded,blacklisted:!!u.atlas.blacklisted,reactionType:m};l.set(u.url,w),l.set(j(u.url),w)}if(l.size===0)return;const i=document.querySelectorAll("img, video, a[href]");for(const u of i){const m=Re(u);if(m.length===0)continue;const w=m.map(d=>l.get(d)||l.get(j(d))).find(d=>!!(d&&(d.exists||d.downloaded||d.blacklisted||d.reactionType)))??null;w&&(u.setAttribute("data-atlas-marked","1"),w.blacklisted?u.setAttribute("data-atlas-state","blacklisted"):w.reactionType?u.setAttribute("data-atlas-state","reacted"):w.downloaded?u.setAttribute("data-atlas-state","downloaded"):w.exists&&u.setAttribute("data-atlas-state","exists"),w.reactionType&&u.setAttribute("data-atlas-reaction",w.reactionType))}}function xt(){const e=new Set,o=document.querySelectorAll("img, video, a[href]");for(const i of o)for(const u of Re(i))e.add(u),e.add(j(u));const l=De();return l?.url&&(e.add(l.url),e.add(j(l.url))),[...e].filter(Boolean)}function Tt(){const e=xt();if(e.length===0){me(E);return}$({type:"atlas-check-batch",urls:e},o=>{if(!o?.ok){me(E);return}const l=Array.isArray(o.data?.results)?o.data.results:[];for(const i of l)i?.url&&R.set(String(i.url),{exists:!!i.exists,downloaded:!!i.downloaded,blacklisted:!!i.blacklisted,reactionType:i.reaction?.type?String(i.reaction.type):null,ts:Date.now()});me(E)})}}function T(A){return new Promise(y=>{const _=document.body||document.documentElement,k=Array.from(_.querySelectorAll("img, video")),g=k.length,$=new Set,O=[];let z=0;const le=V=>{if(typeof window.requestIdleCallback=="function"){window.requestIdleCallback(V,{timeout:500});return}setTimeout(()=>V({timeRemaining:()=>25}),0)},M=V=>{const Q=typeof V?.timeRemaining=="function"?V.timeRemaining():25;let pe=0;for(;z<g&&(pe<80||Q>5);){const ee=k[z];if(ee.closest&&ee.closest(`#${a}`)){z+=1,pe+=1;continue}const fe=we(ee,250);fe?.url&&!$.has(fe.url)&&($.add(fe.url),O.push(fe)),z+=1,pe+=1}if(A?.({scanned:z,total:g}),z<g){le(M);return}const oe=De();oe&&!$.has(oe.url)&&($.add(oe.url),O.push(oe)),y(O)};le(M)})}})()})();
