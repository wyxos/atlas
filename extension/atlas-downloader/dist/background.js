(function(){"use strict";const u=["atlasBaseUrl","atlasToken"],D="Atlas Downloader",k={16:"icon-16.png",32:"icon-32.png",48:"icon-48.png"},C="rgba(220, 38, 38, 0.78)",x="atlas-open-options",T="atlas-open-site",A="atlas-blacklist-domain",E="atlas-reload-extension";let f=null;chrome.runtime.onInstalled.addListener(()=>{try{chrome.contextMenus.create({id:x,title:"Options",contexts:["action"]}),chrome.contextMenus.create({id:T,title:"Open Atlas",contexts:["action"]}),chrome.contextMenus.create({id:A,title:"Blacklist this domain",contexts:["action"]}),chrome.contextMenus.create({id:E,title:"Reload extension (check updates)",contexts:["action"]})}catch{}h()}),chrome.runtime.onStartup.addListener(()=>{h()}),chrome.contextMenus.onClicked.addListener((t,e)=>{if(t.menuItemId===x){chrome.runtime.openOptionsPage();return}if(t.menuItemId===T){chrome.storage.sync.get(["atlasBaseUrl"]).then(o=>{const s=d(o.atlasBaseUrl||"");if(!s){chrome.runtime.openOptionsPage();return}chrome.tabs.create({url:s})});return}if(t.menuItemId===A){I(e);return}t.menuItemId===E&&L()}),chrome.action.onClicked.addListener(t=>{const e=t?.id;e&&chrome.tabs.sendMessage(e,{type:"atlas-open-sheet"})}),chrome.tabs.onActivated.addListener(t=>{R(t.tabId)}),chrome.tabs.onUpdated.addListener((t,e,o)=>{!o?.active&&typeof e.url!="string"&&e.status!=="complete"||m(t,o?.url||e.url||"")}),chrome.storage.onChanged.addListener((t,e)=>{e==="sync"&&Object.prototype.hasOwnProperty.call(t,"atlasExcludedDomains")&&h()}),chrome.runtime.onMessage.addListener((t,e,o)=>!t||t.type!=="atlas-download"&&t.type!=="atlas-download-batch"&&t.type!=="atlas-check-batch"&&t.type!=="atlas-react"&&t.type!=="atlas-delete-download"?void 0:((t.type==="atlas-download-batch"?j(t.payloads):t.type==="atlas-check-batch"?$(t.urls):t.type==="atlas-delete-download"?P(t.payload):t.type==="atlas-react"?v(t.payload):_(t.payload)).then(n=>o(n)).catch(n=>{o({ok:!1,error:n&&n.message?n.message:"Unexpected error"})}),!0)),h();async function I(t){const e=t?.id,o=typeof t?.url=="string"?t.url:"",s=w(o);if(!s)return;const n=await chrome.storage.sync.get(["atlasExcludedDomains"]),a=O(n.atlasExcludedDomains||"");if(!U(s,a)){a.push(s);const r=[...new Set(a)].sort((i,c)=>i.localeCompare(c));await chrome.storage.sync.set({atlasExcludedDomains:r.join(`
`)})}e&&await m(e,o)}function L(){let t=!1;const e=()=>{t||(t=!0,chrome.runtime.reload())};try{if(typeof chrome.runtime.requestUpdateCheck=="function"){chrome.runtime.requestUpdateCheck(()=>{e()}),setTimeout(e,1500);return}}catch{}e()}async function h(){try{const e=(await chrome.tabs.query({active:!0,lastFocusedWindow:!0}))[0];if(!e?.id)return;await m(e.id,e.url||"")}catch{}}async function R(t){try{const e=await chrome.tabs.get(t);await m(t,e?.url||"")}catch{}}async function m(t,e){const o=w(e);if(!o){b(t);return}let s=!1;try{const n=await chrome.storage.sync.get(["atlasExcludedDomains"]),a=O(n.atlasExcludedDomains||"");s=U(o,a)}catch{s=!1}if(s){await N(t);return}b(t)}function b(t){chrome.action.setIcon({tabId:t,path:k}),chrome.action.setBadgeText({tabId:t,text:""}),chrome.action.setTitle({tabId:t,title:D})}async function N(t){const e=await B();e?(chrome.action.setIcon({tabId:t,imageData:{16:e[16],32:e[32],48:e[48]}}),chrome.action.setBadgeText({tabId:t,text:""})):(chrome.action.setIcon({tabId:t,path:k}),chrome.action.setBadgeBackgroundColor({tabId:t,color:"#dc2626"}),chrome.action.setBadgeText({tabId:t,text:"OFF"})),chrome.action.setTitle({tabId:t,title:"Atlas Downloader (domain excluded)"})}async function B(){return f||(f=M(),f)}async function M(){if(typeof OffscreenCanvas>"u"||typeof createImageBitmap!="function")return null;try{const t={};for(const e of[16,32,48]){const o=k[e],s=await fetch(chrome.runtime.getURL(o));if(!s.ok)return null;const n=await s.blob(),a=await createImageBitmap(n),i=new OffscreenCanvas(e,e).getContext("2d");if(!i)return a.close?.(),null;i.clearRect(0,0,e,e),i.drawImage(a,0,0,e,e),a.close?.(),i.globalCompositeOperation="source-atop",i.fillStyle=C,i.fillRect(0,0,e,e),i.globalCompositeOperation="source-over",t[e]=i.getImageData(0,0,e,e)}return t}catch{return null}}function O(t){return!t||typeof t!="string"?[]:t.split(/[\n,]/g).map(e=>e.trim()).filter(e=>e&&!e.startsWith("#")).map(e=>(e.startsWith("*.")?e.slice(2):e).toLowerCase()).map(e=>w(e)||e.replace(/^\.+/,"").trim()).filter(Boolean)}function w(t){if(!t||typeof t!="string")return"";const e=t.trim();if(!e)return"";const o=/^https?:\/\//i.test(e)?e:`https://${e}`;try{return new URL(o).hostname.toLowerCase()}catch{return""}}function U(t,e){const o=(t||"").toLowerCase();if(!o)return!1;for(const s of e)if(s&&(o===s||o.endsWith(`.${s}`)))return!0;return!1}async function _(t){const e=await chrome.storage.sync.get(u);return S(t,e)}async function v(t){const e=await chrome.storage.sync.get(u);return q(t,e)}async function P(t){const e=await chrome.storage.sync.get(u);return F(t,e)}async function $(t){const e=await chrome.storage.sync.get(u),o=d(e.atlasBaseUrl||""),s=(e.atlasToken||"").trim();if(!o)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const n=Array.isArray(t)?t.filter(r=>typeof r=="string"&&r.trim()!==""):[];if(n.length===0)return{ok:!0,data:{results:[]}};const a=[];for(let r=0;r<n.length;r+=200){const i=n.slice(r,r+200);let c;try{c=await y(`${o}/api/extension/files/check`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...s?{"X-Atlas-Extension-Token":s}:{}},body:JSON.stringify({urls:i})})}catch(J){return{ok:!1,error:g(J)}}const l=await p(c);if(c.ok&&l===null)return{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:c.status};if(!c.ok)return{ok:!1,error:l&&l.message?l.message:`Request failed (${c.status}).`,status:c.status,data:l};Array.isArray(l?.results)&&a.push(...l.results)}return{ok:!0,data:{results:a}}}async function j(t){const e=await chrome.storage.sync.get(u),o=Array.isArray(t)?t:[];if(o.length===0)return{ok:!0,results:[]};const s=[];for(const a of o)s.push(await S(a,e));const n=s.every(a=>a&&a.ok);return{ok:n,results:s,...n?{}:{error:"One or more requests failed."}}}async function S(t,e){const o=d(e.atlasBaseUrl||""),s=(e.atlasToken||"").trim();if(!o)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};let n;try{n=await y(`${o}/api/extension/files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...s?{"X-Atlas-Extension-Token":s}:{}},body:JSON.stringify(t)})}catch(r){return{ok:!1,error:g(r)}}const a=await p(n);return n.ok&&a===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:n.status}:n.ok?{ok:!0,data:a}:{ok:!1,error:a&&a.message?a.message:`Request failed (${n.status}).`,status:n.status,data:a}}async function q(t,e){const o=d(e.atlasBaseUrl||""),s=(e.atlasToken||"").trim();if(!o)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};let n;try{n=await y(`${o}/api/extension/files/react`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...s?{"X-Atlas-Extension-Token":s}:{}},body:JSON.stringify(t)})}catch(r){return{ok:!1,error:g(r)}}const a=await p(n);return n.ok&&a===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:n.status}:n.ok?{ok:!0,data:a}:{ok:!1,error:a&&a.message?a.message:`Request failed (${n.status}).`,status:n.status,data:a}}async function F(t,e){const o=d(e.atlasBaseUrl||""),s=(e.atlasToken||"").trim();if(!o)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};let n;try{n=await y(`${o}/api/extension/files/delete-download`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...s?{"X-Atlas-Extension-Token":s}:{}},body:JSON.stringify(t)})}catch(r){return{ok:!1,error:g(r)}}const a=await p(n);return n.ok&&a===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:n.status}:n.ok?{ok:!0,data:a}:{ok:!1,error:a&&a.message?a.message:`Request failed (${n.status}).`,status:n.status,data:a}}function d(t){const e=t.trim();return e?(/^https?:\/\//i.test(e)?e:`https://${e}`).replace(/\/+$/,""):""}async function p(t){try{return await t.json()}catch{return null}}async function y(t,e){const o=new AbortController,s=setTimeout(()=>o.abort(),25e3);try{return await fetch(t,{...e,signal:o.signal})}finally{clearTimeout(s)}}function g(t){return t instanceof DOMException&&t.name==="AbortError"?"Atlas request timed out. Please try again.":t instanceof Error&&t.message?`Atlas request failed: ${t.message}`:"Atlas request failed. Please try again."}})();
