(function(){"use strict";const c=["atlasBaseUrl","atlasToken"];chrome.runtime.onInstalled.addListener(()=>{try{chrome.contextMenus.create({id:"atlas-open-options",title:"Options",contexts:["action"]}),chrome.contextMenus.create({id:"atlas-open-site",title:"Open Atlas",contexts:["action"]})}catch{}}),chrome.contextMenus.onClicked.addListener(t=>{if(t.menuItemId==="atlas-open-options"){chrome.runtime.openOptionsPage();return}t.menuItemId==="atlas-open-site"&&chrome.storage.sync.get(["atlasBaseUrl"]).then(n=>{const a=u(n.atlasBaseUrl||"");if(!a){chrome.runtime.openOptionsPage();return}chrome.tabs.create({url:a})})}),chrome.action.onClicked.addListener(t=>{const n=t?.id;n&&chrome.tabs.sendMessage(n,{type:"atlas-open-sheet"})}),chrome.runtime.onMessage.addListener((t,n,a)=>!t||t.type!=="atlas-download"&&t.type!=="atlas-download-batch"&&t.type!=="atlas-check-batch"&&t.type!=="atlas-react"&&t.type!=="atlas-delete-download"?void 0:((t.type==="atlas-download-batch"?w(t.payloads):t.type==="atlas-check-batch"?g(t.urls):t.type==="atlas-delete-download"?m(t.payload):t.type==="atlas-react"?k(t.payload):y(t.payload)).then(e=>a(e)).catch(e=>{a({ok:!1,error:e&&e.message?e.message:"Unexpected error"})}),!0));async function y(t){const n=await chrome.storage.sync.get(c);return h(t,n)}async function k(t){const n=await chrome.storage.sync.get(c);return A(t,n)}async function m(t){const n=await chrome.storage.sync.get(c);return T(t,n)}async function g(t){const n=await chrome.storage.sync.get(c),a=u(n.atlasBaseUrl||""),o=(n.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const e=Array.isArray(t)?t.filter(r=>typeof r=="string"&&r.trim()!==""):[];if(e.length===0)return{ok:!0,data:{results:[]}};const s=[];for(let r=0;r<e.length;r+=200){const b=e.slice(r,r+200);let i;try{i=await f(`${a}/api/extension/files/check`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify({urls:b})})}catch(U){return{ok:!1,error:p(U)}}const l=await d(i);if(i.ok&&l===null)return{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:i.status};if(!i.ok)return{ok:!1,error:l&&l.message?l.message:`Request failed (${i.status}).`,status:i.status,data:l};Array.isArray(l?.results)&&s.push(...l.results)}return{ok:!0,data:{results:s}}}async function w(t){const n=await chrome.storage.sync.get(c),a=Array.isArray(t)?t:[];if(a.length===0)return{ok:!0,results:[]};const o=[];for(const s of a)o.push(await h(s,n));const e=o.every(s=>s&&s.ok);return{ok:e,results:o,...e?{}:{error:"One or more requests failed."}}}async function h(t,n){const a=u(n.atlasBaseUrl||""),o=(n.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};let e;try{e=await f(`${a}/api/extension/files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify(t)})}catch(r){return{ok:!1,error:p(r)}}const s=await d(e);return e.ok&&s===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:e.status}:e.ok?{ok:!0,data:s}:{ok:!1,error:s&&s.message?s.message:`Request failed (${e.status}).`,status:e.status,data:s}}async function A(t,n){const a=u(n.atlasBaseUrl||""),o=(n.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};let e;try{e=await f(`${a}/api/extension/files/react`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify(t)})}catch(r){return{ok:!1,error:p(r)}}const s=await d(e);return e.ok&&s===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:e.status}:e.ok?{ok:!0,data:s}:{ok:!1,error:s&&s.message?s.message:`Request failed (${e.status}).`,status:e.status,data:s}}async function T(t,n){const a=u(n.atlasBaseUrl||""),o=(n.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};let e;try{e=await f(`${a}/api/extension/files/delete-download`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify(t)})}catch(r){return{ok:!1,error:p(r)}}const s=await d(e);return e.ok&&s===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:e.status}:e.ok?{ok:!0,data:s}:{ok:!1,error:s&&s.message?s.message:`Request failed (${e.status}).`,status:e.status,data:s}}function u(t){const n=t.trim();return n?(/^https?:\/\//i.test(n)?n:`https://${n}`).replace(/\/+$/,""):""}async function d(t){try{return await t.json()}catch{return null}}async function f(t,n){const a=new AbortController,o=setTimeout(()=>a.abort(),25e3);try{return await fetch(t,{...n,signal:a.signal})}finally{clearTimeout(o)}}function p(t){return t instanceof DOMException&&t.name==="AbortError"?"Atlas request timed out. Please try again.":t instanceof Error&&t.message?`Atlas request failed: ${t.message}`:"Atlas request failed. Please try again."}})();
