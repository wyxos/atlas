(function(){"use strict";const c=["atlasBaseUrl","atlasToken"];chrome.runtime.onInstalled.addListener(()=>{try{chrome.contextMenus.create({id:"atlas-open-options",title:"Options",contexts:["action"]}),chrome.contextMenus.create({id:"atlas-open-site",title:"Open Atlas",contexts:["action"]})}catch{}}),chrome.contextMenus.onClicked.addListener(t=>{if(t.menuItemId==="atlas-open-options"){chrome.runtime.openOptionsPage();return}t.menuItemId==="atlas-open-site"&&chrome.storage.sync.get(["atlasBaseUrl"]).then(e=>{const a=l(e.atlasBaseUrl||"");if(!a){chrome.runtime.openOptionsPage();return}chrome.tabs.create({url:a})})}),chrome.action.onClicked.addListener(t=>{const e=t?.id;e&&chrome.tabs.sendMessage(e,{type:"atlas-open-sheet"})}),chrome.runtime.onMessage.addListener((t,e,a)=>!t||t.type!=="atlas-download"&&t.type!=="atlas-download-batch"&&t.type!=="atlas-check-batch"&&t.type!=="atlas-react"?void 0:((t.type==="atlas-download-batch"?m(t.payloads):t.type==="atlas-check-batch"?y(t.urls):t.type==="atlas-react"?f(t.payload):p(t.payload)).then(s=>a(s)).catch(s=>{a({ok:!1,error:s&&s.message?s.message:"Unexpected error"})}),!0));async function p(t){const e=await chrome.storage.sync.get(c);return d(t,e)}async function f(t){const e=await chrome.storage.sync.get(c);return k(t,e)}async function y(t){const e=await chrome.storage.sync.get(c),a=l(e.atlasBaseUrl||""),o=(e.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const s=Array.isArray(t)?t.filter(r=>typeof r=="string"&&r.trim()!==""):[];if(s.length===0)return{ok:!0,data:{results:[]}};const n=[];for(let r=0;r<s.length;r+=200){const g=s.slice(r,r+200),u=await fetch(`${a}/api/extension/files/check`,{method:"POST",headers:{"Content-Type":"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify({urls:g})}),i=await h(u);if(!u.ok)return{ok:!1,error:i&&i.message?i.message:`Request failed (${u.status}).`,status:u.status,data:i};Array.isArray(i?.results)&&n.push(...i.results)}return{ok:!0,data:{results:n}}}async function m(t){const e=await chrome.storage.sync.get(c),a=Array.isArray(t)?t:[];if(a.length===0)return{ok:!0,results:[]};const o=[];for(const n of a)o.push(await d(n,e));const s=o.every(n=>n&&n.ok);return{ok:s,results:o,...s?{}:{error:"One or more requests failed."}}}async function d(t,e){const a=l(e.atlasBaseUrl||""),o=(e.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const s=await fetch(`${a}/api/extension/files`,{method:"POST",headers:{"Content-Type":"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify(t)}),n=await h(s);return s.ok?{ok:!0,data:n}:{ok:!1,error:n&&n.message?n.message:`Request failed (${s.status}).`,status:s.status,data:n}}async function k(t,e){const a=l(e.atlasBaseUrl||""),o=(e.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const s=await fetch(`${a}/api/extension/files/react`,{method:"POST",headers:{"Content-Type":"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify(t)}),n=await h(s);return s.ok?{ok:!0,data:n}:{ok:!1,error:n&&n.message?n.message:`Request failed (${s.status}).`,status:s.status,data:n}}function l(t){const e=t.trim();return e?(/^https?:\/\//i.test(e)?e:`https://${e}`).replace(/\/+$/,""):""}async function h(t){try{return await t.json()}catch{return null}}})();
