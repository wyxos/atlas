(function(){"use strict";const l=["atlasBaseUrl","atlasToken"];chrome.runtime.onInstalled.addListener(()=>{try{chrome.contextMenus.create({id:"atlas-open-options",title:"Options",contexts:["action"]}),chrome.contextMenus.create({id:"atlas-open-site",title:"Open Atlas",contexts:["action"]})}catch{}}),chrome.contextMenus.onClicked.addListener(t=>{if(t.menuItemId==="atlas-open-options"){chrome.runtime.openOptionsPage();return}t.menuItemId==="atlas-open-site"&&chrome.storage.sync.get(["atlasBaseUrl"]).then(s=>{const a=u(s.atlasBaseUrl||"");if(!a){chrome.runtime.openOptionsPage();return}chrome.tabs.create({url:a})})}),chrome.action.onClicked.addListener(t=>{const s=t?.id;s&&chrome.tabs.sendMessage(s,{type:"atlas-open-sheet"})}),chrome.runtime.onMessage.addListener((t,s,a)=>!t||t.type!=="atlas-download"&&t.type!=="atlas-download-batch"&&t.type!=="atlas-check-batch"&&t.type!=="atlas-react"&&t.type!=="atlas-delete-download"?void 0:((t.type==="atlas-download-batch"?m(t.payloads):t.type==="atlas-check-batch"?y(t.urls):t.type==="atlas-delete-download"?k(t.payload):t.type==="atlas-react"?h(t.payload):f(t.payload)).then(e=>a(e)).catch(e=>{a({ok:!1,error:e&&e.message?e.message:"Unexpected error"})}),!0));async function f(t){const s=await chrome.storage.sync.get(l);return p(t,s)}async function h(t){const s=await chrome.storage.sync.get(l);return g(t,s)}async function k(t){const s=await chrome.storage.sync.get(l);return w(t,s)}async function y(t){const s=await chrome.storage.sync.get(l),a=u(s.atlasBaseUrl||""),o=(s.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const e=Array.isArray(t)?t.filter(r=>typeof r=="string"&&r.trim()!==""):[];if(e.length===0)return{ok:!0,data:{results:[]}};const n=[];for(let r=0;r<e.length;r+=200){const b=e.slice(r,r+200),c=await fetch(`${a}/api/extension/files/check`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify({urls:b})}),i=await d(c);if(c.ok&&i===null)return{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:c.status};if(!c.ok)return{ok:!1,error:i&&i.message?i.message:`Request failed (${c.status}).`,status:c.status,data:i};Array.isArray(i?.results)&&n.push(...i.results)}return{ok:!0,data:{results:n}}}async function m(t){const s=await chrome.storage.sync.get(l),a=Array.isArray(t)?t:[];if(a.length===0)return{ok:!0,results:[]};const o=[];for(const n of a)o.push(await p(n,s));const e=o.every(n=>n&&n.ok);return{ok:e,results:o,...e?{}:{error:"One or more requests failed."}}}async function p(t,s){const a=u(s.atlasBaseUrl||""),o=(s.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const e=await fetch(`${a}/api/extension/files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify(t)}),n=await d(e);return e.ok&&n===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:e.status}:e.ok?{ok:!0,data:n}:{ok:!1,error:n&&n.message?n.message:`Request failed (${e.status}).`,status:e.status,data:n}}async function g(t,s){const a=u(s.atlasBaseUrl||""),o=(s.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const e=await fetch(`${a}/api/extension/files/react`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify(t)}),n=await d(e);return e.ok&&n===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:e.status}:e.ok?{ok:!0,data:n}:{ok:!1,error:n&&n.message?n.message:`Request failed (${e.status}).`,status:e.status,data:n}}async function w(t,s){const a=u(s.atlasBaseUrl||""),o=(s.atlasToken||"").trim();if(!a)return{ok:!1,error:"Atlas base URL is not set. Open extension options to configure it."};const e=await fetch(`${a}/api/extension/files/delete-download`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...o?{"X-Atlas-Extension-Token":o}:{}},body:JSON.stringify(t)}),n=await d(e);return e.ok&&n===null?{ok:!1,error:"Atlas returned a non-JSON response. Check your base URL/token.",status:e.status}:e.ok?{ok:!0,data:n}:{ok:!1,error:n&&n.message?n.message:`Request failed (${e.status}).`,status:e.status,data:n}}function u(t){const s=t.trim();return s?(/^https?:\/\//i.test(s)?s:`https://${s}`).replace(/\/+$/,""):""}async function d(t){try{return await t.json()}catch{return null}}})();
